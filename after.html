<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PestiVid - Agricultural Blockchain Platform (Web3 Demo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" rel="stylesheet">
  <!-- Google Fonts (Inter) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Orange ID Required Dependencies -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://public-cdn-files.pages.dev/bedrock-passport.umd.js"></script>

  <!-- Vue.js -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
  <!-- Axios, Buffer, Solana Web3, Marked.js (for Markdown) -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/buffer@6.0.3/index.min.js"></script>
  <script>
    window.Buffer = window.buffer.Buffer; // Solana Buffer fix
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.73.0/lib/index.iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>


  <style>
    body { font-family: 'Inter', system-ui, sans-serif; background: #f9fafb; }
    html { scroll-behavior: smooth; overflow-x: hidden; }
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 5px; }
    ::-webkit-scrollbar-thumb:hover { background: #aaa; }
    * { scrollbar-width: thin; scrollbar-color: #ccc #f1f1f1; -ms-overflow-style: -ms-autohiding-scrollbar; }
    .progress-bar { height: 8px; border-radius: 4px; background: #e5e7eb; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
    .modal-scrollable { max-height: 85vh; overflow-y: auto; }
    .project-updates-list { max-height: 150px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 0.75rem; background-color: #f9fafb; }
    .project-update-item { padding-bottom: 0.5rem; margin-bottom: 0.5rem; border-bottom: 1px solid #f3f4f6; }
    .project-update-item:last-child { border-bottom: none; margin-bottom: 0; }
    .message-view-container { scroll-behavior: smooth; }
    .notification-badge { position: absolute; top: -5px; right: -8px; min-width: 18px; height: 18px; background-color: #ef4444; border-radius: 9px; color: white; font-size: 10px; font-weight: 600; line-height: 18px; text-align: center; padding: 0 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    .mobile-notification-badge { display: inline-block; background-color: #ef4444; color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 9px; line-height: 16px; text-align: center; vertical-align: top; margin-left: 4px; }
    .notification-toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column-reverse; gap: 10px; align-items: flex-end; }
    .notification-toast { min-width: 250px; max-width: 350px; background-color: #fff; color: #333; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); display: flex; align-items: center; opacity: 0; transform: translateX(100%); transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
    .notification-toast.show { opacity: 1; transform: translateX(0); }
    .notification-toast .icon { margin-right: 0.75rem; font-size: 1.25rem; }
    .notification-toast .icon-info { color: #3b82f6; } .notification-toast .icon-success { color: #10b981; } .notification-toast .icon-warning { color: #f59e0b; } .notification-toast .icon-error { color: #ef4444; }
    .notification-toast .message { font-size: 0.875rem; line-height: 1.3; }
    .notification-toast .close-btn { margin-left: auto; padding-left: 0.75rem; color: #9ca3af; cursor: pointer; background: none; border: none; font-size: 1rem; }
    .notification-toast .close-btn:hover { color: #6b7280; }
    .new-badge { position: absolute; top: -8px; right: -8px; background-color: #3b82f6; color: white; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .loading-modal { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 9999; }
    .loading-content { background-color: white; padding: 2rem; border-radius: 0.5rem; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    .loading-content .fa-spinner { font-size: 2rem; color: #10b981; margin-bottom: 1rem; }
    .login-page-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: calc(100vh - 160px); padding: 2rem 1rem; box-sizing: border-box; }
    .login-branding { display: flex; align-items: center; margin-bottom: 1.5rem; }
    .login-branding .logo-icon { font-size: 2.5rem; color: #15803d; margin-right: 0.75rem; }
    .login-branding .app-name { font-size: 2rem; font-weight: 600; color: #15803d; }
    .login-panel-wrapper { background-color: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); width: 100%; max-width: 450px; text-align: center; }
    .login-panel-wrapper h2 { font-size: 1.5rem; font-weight: 700; color: #166534; /* green-800 */ margin-bottom: 0.5rem; }
    .login-panel-wrapper .tagline { color: #4b5563; /* gray-600 */ margin-bottom: 1.5rem; font-size: 0.9rem; }

    #orange-id-login-container { margin: 0 auto; }
    #orange-id-signout-button-container, #orange-id-signout-button-container-mobile { display: inline-flex; align-items: center; }
    #orange-id-signout-button-container button, #orange-id-signout-button-container-mobile button { background-color: transparent !important; color: #9CA3AF !important; padding: 0.25rem 0.5rem !important; border: none !important; font-size: 1rem !important; }
    #orange-id-signout-button-container button:hover, #orange-id-signout-button-container-mobile button:hover { color: #EF4444 !important; }

    /* Chatbot Styles (Kept for Avatar Assistant, may need adjustments if conflicts arise) */
    .chatbot-container { display: flex; flex-direction: column; height: calc(100vh - 230px); max-height: 700px; border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden; }
    .chatbot-messages { flex-grow: 1; padding: 1rem; overflow-y: auto; background-color: #f9fafb; space-y-4; }
    .chat-message { display: flex; max-width: 80%; margin-bottom: 0.5rem;}
    .chat-message.user { margin-left: auto; flex-direction: row-reverse; }
    .chat-message .message-content { display: flex; align-items: flex-end; }
    .chat-message.user .message-content { flex-direction: row-reverse; }
    .chat-message .message-bubble { padding: 0.75rem 1rem; border-radius: 1rem; line-height: 1.5; word-wrap: break-word; max-width: calc(100% - 3.5rem); /* Account for avatar */ }
    .chat-message.user .message-bubble { background-color: #10b981; color: white; border-bottom-right-radius: 0.25rem; }
    .chat-message.bot .message-bubble { background-color: #e5e7eb; color: #1f2937; border-bottom-left-radius: 0.25rem; }
    .chat-message .avatar { width: 2.5rem; height: 2.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; margin: 0 0.5rem; flex-shrink: 0; align-self: flex-end; }
    .chat-message.user .avatar { background-color: #059669; color: white; }
    .chat-message.bot .avatar { background-color: #d1d5db; color: #4b5563; }
    .chatbot-input-area { border-top: 1px solid #e5e7eb; padding: 1rem; background-color: #fff; display: flex; gap: 0.75rem; }
    .chatbot-input-area input { flex-grow: 1; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; }
    .chatbot-input-area input:focus { outline: none; border-color: #10b981; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); }
    .chatbot-input-area button { background-color: #10b981; color: white; padding: 0.75rem 1.25rem; border-radius: 0.375rem; font-weight: 600; font-size: 0.875rem; }
    .chatbot-input-area button:hover { background-color: #059669; }
    .chatbot-input-area button:disabled { background-color: #9ca3af; cursor: not-allowed; }
    .typing-indicator span { height: 8px; width: 8px; margin: 0 2px; background-color: #9ca3af; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
    .message-bubble ul, .message-bubble ol { margin-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
    .message-bubble li { margin-bottom: 0.25rem; }
    .message-bubble p { margin-bottom: 0.5rem; }
    .message-bubble p:last-child { margin-bottom: 0; }
    .message-bubble strong, .message-bubble b { font-weight: 600; }
    .message-bubble em, .message-bubble i { font-style: italic; }
    .message-bubble pre { background-color: #f3f4f6; padding: 0.5rem; border-radius: 0.25rem; overflow-x: auto; font-family: monospace; font-size: 0.875em; margin: 0.5rem 0; }
    .message-bubble code { background-color: #f3f4f6; padding: 0.1em 0.3em; border-radius: 0.25rem; font-family: monospace; font-size: 0.875em; }
    .message-bubble pre code { padding: 0; background-color: transparent; }

    .stat-card { background-color: white; border-radius: 0.5rem; padding: 1.5rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); text-align: center;}
    .stat-card .icon { font-size: 1.75rem; margin-bottom: 0.5rem; }
    .stat-card .value { font-size: 1.5rem; font-weight: 700; }
    .stat-card .label { font-size: 0.875rem; color: #6b7280; }

    /* New Avatar Assistant Styles */
    .avatar-container.bottom-right { /* Ensure this is used if you prefer this naming */
        /* position: fixed; bottom: 1rem; right: 1rem; z-index: 50; */ /* Tailwind classes are used in HTML */
    }
    @keyframes pulse-slow {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }
    .animate-pulse-slow {
      animation: pulse-slow 2s infinite ease-in-out;
    }
    .avatar-input-mic-btn.listening i {
        animation: pulse-red 1.5s infinite;
    }
    @keyframes pulse-red {
      0%, 100% { color: #ef4444; transform: scale(1); }
      50% { color: #f87171; transform: scale(1.1); }
    }

    /* Advanced AgriSolar Section Specific Styles */
    .advanced-agrisolar-subsection {
        background-color: #fdfdfd; /* Slightly off-white for subsections */
        padding: 1rem;
        border-radius: 0.375rem; /* rounded-md */
        margin-bottom: 1.5rem;
        border: 1px solid #e5e7eb; /* border-gray-200 */
    }
    .advanced-agrisolar-subsection h4 {
        font-size: 1.125rem; /* text-lg */
        font-weight: 600; /* font-semibold */
        color: #166534; /* green-800 */
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #d1d5db; /* border-gray-300 */
    }
    .advanced-agrisolar-subsection .item-card {
        background-color: white;
        border-radius: 0.375rem;
        padding: 1rem;
        box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05);
        border: 1px solid #e5e7eb;
    }
    .advanced-agrisolar-subsection .item-card h5 {
        font-weight: 600;
        color: #1f2937; /* gray-800 */
        margin-bottom: 0.25rem;
    }
     .advanced-agrisolar-subsection .item-card p.detail {
        font-size: 0.8rem; /* text-xs */
        color: #4b5563; /* gray-600 */
        margin-bottom: 0.1rem;
    }
     .advanced-agrisolar-subsection .item-card p.detail .value{
        font-weight: 500;
        color: #111827; /* gray-900 */
    }
  </style>
</head>
<body class="text-gray-900">
<div id="app" class="flex flex-col min-h-screen">
  <!-- Header/Navbar -->
  <header class="bg-white shadow sticky top-0 z-30">
    <div class="max-w-7xl mx-auto px-5 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <span class="text-2xl text-green-700 font-semibold"><i class="fas fa-seedling mr-1"></i>PestiVid</span>
      </div>
      <nav class="hidden md:flex space-x-5 items-center">
        <a href="#" @click.prevent="switchPage('landing')" :class="{'font-bold text-green-700': current==='landing'}" class="hover:text-green-600">Home</a>

        <a v-if="!isUserAuthenticated && !isAuthProcessing && !isOrangeIdCallback" href="#" @click.prevent="switchPage('loginChoice')" class="hover:text-green-600">Login / Sign Up</a>
        <span v-if="(isAuthProcessing || isOrangeIdCallback) && !isUserAuthenticated" class="text-gray-500 text-sm">Authenticating...</span>

        <!-- Farmer Menu -->
        <template v-if="isUserAuthenticated && role==='farmer'">
          <a href="#" @click.prevent="switchPage('farmerPestiVid')" :class="{'font-bold text-green-700': current==='farmerPestiVid'}" class="hover:text-green-600">PestiVid</a>
          <a href="#" @click.prevent="switchPage('farmerAgriSolar')" :class="{'font-bold text-green-700': current==='farmerAgriSolar'}" class="hover:text-green-600 relative">AgriSolar <span class="new-badge !top-[-6px] !right-[-12px]">Adv</span></a>
          <a href="#" @click.prevent="switchPage('farmerAgriStream')" :class="{'font-bold text-green-700': current==='farmerAgriStream'}" class="hover:text-green-600">AgriStream</a>
          <a href="#" @click.prevent="switchPage('farmerSell')" :class="{'font-bold text-green-700': current==='farmerSell'}" class="hover:text-green-600">Sell</a>
          <a href="#" @click.prevent="switchPage('farmerFunding')" :class="{'font-bold text-green-700': current==='farmerFunding'}" class="hover:text-green-600">Get Funding</a>
          <a href="#" @click.prevent="switchPage('plantRecommendation')" :class="{'font-bold text-green-700': current==='plantRecommendation'}" class="hover:text-green-600">PlantRecommend</a>
        </template>
        <!-- Buyer Menu -->
        <template v-if="isUserAuthenticated && role==='buyer'">
          <a href="#" @click.prevent="switchPage('buyerAgriSell')" :class="{'font-bold text-green-700': current==='buyerAgriSell'}" class="hover:text-green-600">AgriSell</a>
        </template>
        <!-- Investor Menu -->
        <template v-if="isUserAuthenticated && role==='investor'">
          <a href="#" @click.prevent="switchPage('investorProjects')" :class="{'font-bold text-green-700': current==='investorProjects'}" class="hover:text-green-600">Projects</a>
          <a href="#" @click.prevent="switchPage('investorPortfolio')" :class="{'font-bold text-green-700': current==='investorPortfolio'}" class="hover:text-green-600">Portfolio</a>
        </template>

        <!-- Moved Messages Link to the end of general links -->
        <a v-if="isUserAuthenticated" href="#" @click.prevent="switchPage('messaging')"
           :class="{'font-bold text-green-700': current==='messaging'}"
           class="hover:text-green-600 relative px-2 py-1 flex items-center justify-center">
           <i class="fas fa-comments"></i> <!-- Icon only -->
           <span v-if="unreadMessageCount > 0" class="notification-badge">{{ unreadMessageCount }}</span>
        </a>

        <template v-if="isUserAuthenticated">
          <a href="#" @click.prevent="switchPage('userProfile')" :class="{'font-bold text-green-700': current==='userProfile'}" class="bg-green-600 text-white text-xs rounded-full px-3 py-1 select-none ml-2 hover:bg-green-700 flex items-center">
             <i class="fas fa-user-circle mr-1"></i> {{ userName ? userName.split(' ')[0] : displayedUserIdentifier }}
          </a>
           <div v-if="loginMethod === 'orangeId'" id="orange-id-signout-button-container" class="ml-2"></div>
           <a v-if="loginMethod === 'solana'" href="#" title="Disconnect Wallet" @click.prevent="logoutUser" class="text-gray-400 hover:text-red-500 ml-2"><i class="fas fa-sign-out-alt text-lg"></i></a>
        </template>
      </nav>
      <button class="md:hidden text-gray-500 focus:outline-none" @click="showMobileMenu = !showMobileMenu">
        <i class="fas fa-bars text-2xl"></i>
      </button>
    </div>
    <!-- Mobile Dropdown -->
    <div v-show="showMobileMenu" class="md:hidden bg-white border-t z-40">
      <div class="py-2 flex flex-col space-y-1 px-4">
        <a href="#" @click.prevent="switchPage('landing');showMobileMenu=false" :class="{'font-bold text-green-700': current==='landing'}">Home</a>
        <a v-if="!isUserAuthenticated && !isAuthProcessing && !isOrangeIdCallback" href="#" @click.prevent="switchPage('loginChoice');showMobileMenu=false" >Login / Sign Up</a>
        <span v-if="(isAuthProcessing || isOrangeIdCallback) && !isUserAuthenticated" class="text-gray-500 text-sm px-1 py-1">Authenticating...</span>

        <template v-if="isUserAuthenticated && role==='farmer'">
          <a href="#" @click.prevent="switchPage('farmerPestiVid');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerPestiVid'}">PestiVid</a>
          <a href="#" @click.prevent="switchPage('farmerAgriSolar');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerAgriSolar'}" class="relative">AgriSolar <span class="new-badge !top-[-2px] !right-[-6px]">Adv</span></a>
          <a href="#" @click.prevent="switchPage('farmerAgriStream');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerAgriStream'}">AgriStream</a>
          <a href="#" @click.prevent="switchPage('farmerSell');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerSell'}">Sell</a>
          <a href="#" @click.prevent="switchPage('farmerFunding');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerFunding'}">Get Funding</a>
          <a href="#" @click.prevent="switchPage('plantRecommendation');showMobileMenu=false" :class="{'font-bold text-green-700': current==='plantRecommendation'}">PlantRecommend</a>
        </template>
        <template v-if="isUserAuthenticated && role==='buyer'">
          <a href="#" @click.prevent="switchPage('buyerAgriSell');showMobileMenu=false" :class="{'font-bold text-green-700': current==='buyerAgriSell'}">AgriSell</a>
        </template>
        <template v-if="isUserAuthenticated && role==='investor'">
          <a href="#" @click.prevent="switchPage('investorProjects');showMobileMenu=false" :class="{'font-bold text-green-700': current==='investorProjects'}">Projects</a>
          <a href="#" @click.prevent="switchPage('investorPortfolio');showMobileMenu=false" :class="{'font-bold text-green-700': current==='investorPortfolio'}">Portfolio</a>
        </template>

        <!-- Moved Messages Link to the end of the mobile links -->
        <a v-if="isUserAuthenticated" href="#" @click.prevent="switchPage('messaging');showMobileMenu=false"
           :class="{'font-bold text-green-700': current==='messaging'}">
          <i class="fas fa-comments"></i> <!-- Icon only -->
          <span v-if="unreadMessageCount > 0" class="mobile-notification-badge">{{ unreadMessageCount }}</span>
        </a>

        <template v-if="isUserAuthenticated">
           <div class="border-t mt-2 pt-2 flex justify-between items-center">
             <a href="#" @click.prevent="switchPage('userProfile');showMobileMenu=false" :class="{'font-bold text-green-700': current==='userProfile'}" class="inline-block bg-green-600 text-white text-xs rounded px-2 py-1 ml-1 flex items-center">
                <i class="fas fa-user-circle mr-1"></i> {{ userName ? userName.split(' ')[0] : displayedUserIdentifier }}
             </a>
             <div v-if="loginMethod === 'orangeId'" id="orange-id-signout-button-container-mobile"></div>
             <a v-if="loginMethod === 'solana'" href="#" class="text-gray-400 hover:text-red-500" title="Disconnect Wallet" @click.prevent="logoutUser();showMobileMenu=false"><i class="fas fa-sign-out-alt"></i></a>
           </div>
        </template>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-1 max-w-7xl mx-auto w-full px-4 pt-8 pb-8">
    <!-- Landing Section -->
    <section v-if="current==='landing' && !isOrangeIdCallback">
        <div class="flex flex-col md:flex-row items-center mb-12 pt-2">
            <div class="md:w-1/2 md:pr-8">
            <h1 class="text-4xl font-bold text-green-800 mb-4">PestiVid: Blockchain Transparency & Sustainability in Agriculture</h1>
            <p class="mb-5 text-gray-800 text-lg leading-relaxed">A secure, video-verified agricultural marketplace with investment opportunities and advanced renewable energy tracking (AgriSolar). Farmers prove quality, safety, and sustainable practices via field recordings and energy logs stored on blockchain (Solana Simulated) and IPFS. Buyers purchase crops with complete confidence and traceability. Investors fund projects with transparent returns.</p>
            <ul class="text-gray-700 mb-7 space-y-1 text-base">
                <li><i class="fas fa-link text-green-500 mr-2"></i>Solana blockchain-simulated transactions</li>
                <li><i class="fas fa-cloud-upload-alt text-green-400 mr-2"></i>Decentralized video storage (IPFS/Pinata)</li>
                <li><i class="fas fa-solar-panel text-yellow-500 mr-2"></i><span class="font-semibold text-blue-600">Adv!</span> Advanced Renewable Energy (AgriSolar)</li>
                <li><i class="fas fa-search-dollar text-green-400 mr-2"></i>Full traceability for buyers</li>
                <li><i class="fas fa-handshake text-green-500 mr-2"></i>Direct, transparent marketplace transactions</li>
                <li><i class="fas fa-chart-line text-green-500 mr-2"></i>Investment opportunities for funders</li>
                <li><i class="fas fa-comments text-green-500 mr-2"></i>Secure messaging between users</li>
                <li><i class="fas fa-bell text-green-500 mr-2"></i>Real-time notifications</li>
                <li><i class="fas fa-robot text-blue-500 mr-2"></i>Interactive AI Helper</li>
            </ul>
            <div class="mt-4 space-x-2">
                <button class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded transition" @click="getStarted">Get Started</button>
                <button class="bg-white border border-green-600 text-green-600 px-6 py-2 rounded transition" @click="switchPage(isUserAuthenticated && role==='buyer' ? 'buyerAgriSell' : isUserAuthenticated ? 'landing' : 'loginChoice')">Browse Marketplace</button>
            </div>
            </div>
            <div class="md:w-1/2 mt-10 md:mt-0 flex flex-col items-center">
            <img src="https://www.farmtoplate.io/wp-content/uploads/megamenu/tech_hub_banner.png" alt="AgriSolar Banner" class="rounded-lg shadow-md border w-full max-w-md mx-auto mb-4">
            <p class="text-center text-sm text-gray-600 italic">PestiVid now supports advanced AgriSolar and multi-source renewable energy integration.</p>
            </div>
        </div>
        <div class="mt-10">
            <h2 class="text-2xl text-green-700 font-semibold mb-3">How It Works</h2>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-5">
            <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
                <i class="fas fa-video text-2xl text-green-500 mb-3"></i>
                <span class="font-bold mb-1">1. Record & Log</span>
                <p class="text-sm text-gray-600 text-center">Farmers film crop practices & log multi-source energy production.</p>
            </div>
            <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
                <i class="fas fa-cloud-upload-alt text-2xl text-green-500 mb-3"></i>
                <span class="font-bold mb-1">2. Upload to IPFS</span>
                <p class="text-sm text-gray-600 text-center">Videos & info are securely uploaded and stored decentrally.</p>
            </div>
             <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
                <i class="fas fa-solar-panel text-yellow-500 mb-3"></i><i class="fas fa-wind text-blue-500 ml-1"></i>
                <span class="font-bold mb-1">3. Track Energy</span>
                <p class="text-sm text-gray-600 text-center">Monitor solar, wind, hydro, biomass generation via AgriSolar.</p>
            </div>
            <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
                <i class="fas fa-search-dollar text-green-500 mb-3"></i>
                <span class="font-bold mb-1">4. Verification</span>
                <p class="text-sm text-gray-600 text-center">Buyers view blockchain-verified video & energy data.</p>
            </div>
            <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
                <i class="fas fa-handshake text-green-500 mb-3"></i>
                <span class="font-bold mb-1">5. Marketplace</span>
                <p class="text-sm text-gray-600 text-center">Login to buy, sell, or invest, backed by verified data.</p>
            </div>
            </div>
        </div>

        <div class="mt-16 bg-green-50 rounded-lg p-8">
            <h2 class="text-2xl text-green-700 font-semibold mb-3">Agricultural & Renewable Energy Investment</h2>
            <div class="flex flex-col md:flex-row items-center">
            <div class="w-full">
                <p class="mb-4 text-gray-700">Invest in verified agricultural and diverse renewable energy projects (solar, wind, etc.) with full transparency. Track your investments through simulated Solana blockchain technology and share in the harvest or energy profits.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 my-6">
                <div class="bg-white rounded p-4 shadow-sm">
                    <i class="fas fa-seedling text-green-600 text-2xl mb-2"></i><i class="fas fa-solar-panel text-yellow-500 ml-1"></i>
                    <h3 class="font-bold mb-1">Fund Crops & Renewables</h3>
                    <p class="text-sm">Invest in specific crops or on-farm renewable installations.</p>
                </div>
                <div class="bg-white rounded p-4 shadow-sm">
                    <i class="fas fa-coins text-green-600 text-2xl mb-2"></i>
                    <h3 class="font-bold mb-1">Share Returns</h3>
                    <p class="text-sm">Receive dividends based on yields, market prices, or energy generation.</p>
                </div>
                <div class="bg-white rounded p-4 shadow-sm">
                    <i class="fas fa-shield-alt text-green-600 text-2xl mb-2"></i>
                    <h3 class="font-bold mb-1">Secure Blockchain</h3>
                    <p class="text-sm">All investments and production recorded on immutable ledger (Simulated).</p>
                </div>
                </div>
                <button class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded transition mt-2" @click="switchPage(isUserAuthenticated && role==='investor' ? 'investorProjects' : isUserAuthenticated ? 'landing' : 'loginChoice')">Become an Investor</button>
            </div>
            </div>
        </div>
    </section>

    <!-- Orange ID Callback Processing View -->
    <section v-if="isOrangeIdCallback" class="login-page-container">
        <div class="login-panel-wrapper">
            <div class="login-branding justify-center">
                <i class="fas fa-seedling logo-icon"></i>
                <span class="app-name">PestiVid</span>
            </div>
            <div id="orange-id-callback-processor" class="text-center p-4">
                <p class="text-gray-600"><i class="fas fa-spinner fa-spin mr-2"></i>Processing authentication...</p>
            </div>
        </div>
    </section>

    <!-- Login Choice Page -->
    <section v-if="current==='loginChoice' && !isOrangeIdCallback" class="login-page-container">
        <div class="login-panel-wrapper">
            <div class="login-branding justify-center ">
                <i class="fas fa-seedling logo-icon"></i>
                <span class="app-name">PestiVid</span>
            </div>
            <h2 class="text-xl font-bold text-green-800 mb-2">Login or Sign Up</h2>
            <p class="text-gray-600 mb-6 text-sm">You must complete both steps to gain access. If you have two-step verification yet, you will be prompted touse website </p>

            <div class="mb-4">
                <p class="text-xs text-gray-500 mb-2 text-left ml-1">Sign in with Orange ID:</p>
                <div id="orange-id-login-container" class="flex justify-center">
                    <p v-if="!orangeIdWidgetMounted && !orangeIdBedrockSDKError" class="text-gray-500 p-4 text-sm">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Loading Social Logins...
                    </p>
                    <p v-if="orangeIdBedrockSDKError" class="text-red-500 p-4 text-sm">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Social login service could not load.
                    </p>
                </div>
                 <p class="text-xs text-gray-500 mt-2 text-center">Powered by <a href="https://orangeid.xyz" target="_blank" class="underline hover:text-orange-500">Orange ID</a></p>
            </div>

            <div class="relative my-6">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-white text-gray-500">Step 2 verification</span>
                </div>
            </div>

            <div class="mb-4">
                 <p class="text-xs text-gray-500 mb-2 text-left ml-1">Connect with your Solana wallet:</p>
                <button @click="connectWallet"
                        class="w-full flex items-center justify-center px-4 py-2.5 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                    <i class="fas fa-wallet mr-2"></i> Connect Solana Wallet
                </button>
            </div>
        </div>
    </section>

    <!-- Role Selection (after any login if new PestiVid user) -->
    <section v-if="current==='roleSelection' && !isOrangeIdCallback" class="max-w-lg mx-auto bg-white shadow rounded-lg p-8 mt-8">
        <h2 class="text-2xl font-bold text-green-700 mb-4">Welcome to PestiVid!</h2>
        <p class="text-gray-600 mb-1">
            <span v-if="loginMethod === 'orangeId'">Logged in as <strong class="font-mono text-sm">{{ orangeIdUser ? (orangeIdUser.name || orangeIdUser.email) : displayedUserIdentifier }}</strong> via Orange ID.</span>
            <span v-if="loginMethod === 'solana'">Your wallet <strong class="font-mono text-sm">{{ displayedUserIdentifier }}</strong> is connected.</span>
        </p>
        <p class="text-gray-600 mb-5">Please complete your PestiVid profile and select your primary role:</p>
        <div class="mb-4">
            <label class="block text-gray-600 mb-1">Full Name (for PestiVid)</label>
            <input v-model="userNameOnboarding" type="text" class="w-full px-3 py-2 border rounded" placeholder="e.g., John Doe" required>
        </div>
        <div class="mb-4">
            <label class="block text-gray-600 mb-1">Email Address (for PestiVid)</label>
            <input v-model="userEmailOnboarding" type="email" class="w-full px-3 py-2 border rounded" placeholder="e.g., john.doe@example.com" required>
        </div>
        <div class="mb-4">
            <label class="block text-gray-600 mb-1">Phone Number (Optional)</label>
            <input v-model="userPhoneOnboarding" type="tel" class="w-full px-3 py-2 border rounded" placeholder="e.g., +1-555-123-4567">
        </div>
        <div class="mb-6">
          <label class="block text-gray-600 mb-1">Primary Role in PestiVid</label>
          <select v-model="selectedRoleOnboarding" class="w-full px-3 py-2 border rounded bg-white" required>
            <option value="" disabled>Select Role</option>
            <option value="farmer">Farmer</option>
            <option value="buyer">Buyer</option>
            <option value="investor">Investor</option>
          </select>
        </div>
        <button @click="completeOnboarding" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded" :disabled="!selectedRoleOnboarding || !userNameOnboarding || !userEmailOnboarding">Confirm Profile & Role</button>
    </section>

    <!-- Farmer PestiVid Section -->
    <section v-if="current==='farmerPestiVid' && !isOrangeIdCallback" class="max-w-3xl mx-auto mt-6">
      <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-video mr-2"></i>PestiVid: Record Crop Video</h2>
      <div class="bg-white rounded shadow-md p-6 space-y-6">
        <form @submit.prevent>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
            <div> <label class="block text-gray-600 mb-1 text-sm">Crop Type</label> <input v-model="recordForm.crop" class="w-full px-2 py-2 border rounded text-sm" required placeholder="e.g., Tomatoes"> </div>
            <div> <label class="block text-gray-600 mb-1 text-sm">Field Location</label> <input v-model="recordForm.location" class="w-full px-2 py-2 border rounded text-sm" required placeholder="e.g., South Field"> </div>
            <div> <label class="block text-gray-600 mb-1 text-sm">Pesticide Used</label> <input v-model="recordForm.pesticide" class="w-full px-2 py-2 border rounded text-sm" required placeholder="e.g., Neem Oil"> </div>
            <div> <label class="block text-gray-600 mb-1 text-sm">Pesticide Company</label> <input v-model="recordForm.pesticideCompany" class="w-full px-2 py-2 border rounded text-sm" required placeholder="e.g., AgriChem"> </div>
          </div>
          <div class="mb-4">
            <label class="block text-gray-600 mb-1 text-sm">Purpose of this Video:</label>
            <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-2 sm:space-y-0">
                <label class="flex items-center"> <input type="radio" v-model="recordForm.purpose" value="agristream" class="form-radio text-green-600"> <span class="ml-2 text-sm text-gray-700">For AgriStream (General)</span> </label>
                <label class="flex items-center"> <input type="radio" v-model="recordForm.purpose" value="sell" class="form-radio text-green-600"> <span class="ml-2 text-sm text-gray-700">To List for Sale</span> </label>
                <label class="flex items-center"> <input type="radio" v-model="recordForm.purpose" value="funding" class="form-radio text-green-600"> <span class="ml-2 text-sm text-gray-700">For Funding Request</span> </label>
                 <!-- Add Agrovoltaics Option -->
                <label class="flex items-center"> <input type="radio" v-model="recordForm.purpose" value="agrovoltaics" class="form-radio text-green-600"> <span class="ml-2 text-sm text-gray-700">For Agrovoltaics Setup</span> </label>
            </div>
          </div>
        </form>
        <div>
          <div class="aspect-w-16 aspect-h-9 bg-black rounded mb-3 relative" style="min-height:200px">
            <video ref="liveVideo" v-show="showLive" class="w-full h-full rounded absolute inset-0 object-cover" autoplay muted playsinline webkit-playsinline style="background:#111"></video>
            <video v-if="recordBlobUrl" :src="recordBlobUrl" controls playsinline webkit-playsinline class="w-full h-full rounded absolute inset-0 object-cover" style="background:#181818"></video>
            <div v-if="!showLive && !recordBlobUrl" class="absolute inset-0 flex justify-center items-center h-full text-gray-400"><i class="fas fa-video-slash fa-2x"></i></div>
          </div>
          <div class="flex flex-wrap gap-3 mb-2 items-center">
            <button type="button" :disabled="recording || !isUserAuthenticated" @click="startVideo" :class="{'opacity-50 cursor-not-allowed': recording || !isUserAuthenticated}" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">
              <i :class="recording ? 'fas fa-spinner fa-spin' : (recordBlobUrl ? 'fas fa-redo' : 'fas fa-record-vinyl')" class="mr-1"></i>
              {{ recordBlobUrl ? 'Re-Record' : (recording ? 'Starting...' : 'Start Recording') }}
            </button>
            <button v-if="recording" type="button" @click="stopVideo" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-sm"> <i class="fas fa-stop mr-1"></i>Stop </button>
            <button v-if="recordBlobUrl && !uploading" type="button" @click="uploadVideo" :disabled="!isUserAuthenticated" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm"> <i class="fas fa-upload mr-1"></i>Upload to IPFS </button>
            <div v-if="uploading && !showLoadingModal" class="flex items-center text-blue-600 text-sm ml-3"> <i class="fas fa-spinner fa-spin mr-2"></i> Uploading... Please wait. </div>
          </div>
          <p class="text-xs mt-2 text-gray-500">Allow camera access. Video file is stored locally until upload.</p>
          <div v-if="!isUserAuthenticated" class="text-red-500 mt-3 bg-red-50 p-2 rounded border border-red-200 text-sm"> <i class="fas fa-exclamation-triangle mr-1"></i> Please log in to record and upload videos. </div>
          <div v-if="uploadCid" class="text-green-600 mt-3 bg-green-50 p-3 rounded border border-green-200 text-sm">
              <div class="flex items-center mb-2"> <i class="fas fa-check-circle mr-2"></i> Uploaded to IPFS! CID: <span class="font-mono bg-green-100 px-1 py-0.5 rounded break-all ml-1">{{ uploadCid }}</span> </div>
              <div v-if="lastUploadedVideoFileHash" class="flex items-center mb-2 text-xs"> <i class="fas fa-fingerprint mr-2 text-gray-500"></i> Video File Hash (SHA256): <span class="font-mono bg-green-100 px-1 py-0.5 rounded break-all ml-1 text-gray-700">{{ lastUploadedVideoFileHash }}</span> </div>
              <p v-if="lastUploadedVideoPurpose === 'agristream'" class="mt-1 text-gray-700"> This video is now available in your AgriStream. <a href="#" @click.prevent="navigateToPageWithParam('farmerAgriStream', 'highlightCid', uploadCid)" class="text-blue-700 underline font-medium hover:text-blue-800 ml-1">View in AgriStream</a>. <br>You can also use it later to: <a href="#" @click.prevent="goToListing(uploadCid)" class="text-green-700 underline font-medium hover:text-green-800">Create a Listing</a>, or <a href="#" @click.prevent="navigateToPageWithParam('farmerFunding', 'cid', uploadCid)" class="text-purple-700 underline font-medium hover:text-purple-800 ml-1">Use for Funding Request</a>. </p>
              <p v-if="lastUploadedVideoPurpose === 'sell'" class="mt-1 text-gray-700"> Video uploaded for selling! You should be redirected to create a listing. If not, <a href="#" @click.prevent="navigateToPageWithParam('farmerSell', 'cid', uploadCid)" class="text-green-700 underline font-medium hover:text-green-800">click here to complete the listing</a>. </p>
              <p v-if="lastUploadedVideoPurpose === 'funding'" class="mt-1 text-gray-700"> Video uploaded for a funding request! You should be redirected to create the request. If not, <a href="#" @click.prevent="navigateToPageWithParam('farmerFunding', 'cid', uploadCid)" class="text-purple-700 underline font-medium hover:text-purple-800">click here to complete the funding request</a>. </p>
               <p v-if="lastUploadedVideoPurpose === 'agrovoltaics'" class="mt-1 text-gray-700"> Video uploaded for Agrovoltaics! View in AgriStream or associate with a Solar Asset in AgriSolar. <a href="#" @click.prevent="navigateToPageWithParam('farmerAgriStream', 'highlightCid', uploadCid)" class="text-blue-700 underline font-medium hover:text-blue-800 ml-1">View in AgriStream</a>. </p>
          </div>
          <div v-if="uploadError" class="text-red-600 mt-3 bg-red-50 p-2 rounded border border-red-200 text-sm"> <i class="fas fa-exclamation-triangle mr-1"></i> {{ uploadError }} </div>
        </div>
      </div>
    </section>

    <!-- Farmer AgriSolar Section -->
    <section v-if="current==='farmerAgriSolar' && !isOrangeIdCallback && role==='farmer'" class="max-w-5xl mx-auto mt-6">
        <div class="flex items-center mb-6">
             <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRu47zYJg9JEg_QctUPFo7z6gq_7QW1Pryj2g&s" alt="Advanced AgriSolar Banner" class="w-20 h-20 mr-4 rounded-md object-cover">
            <div>
                <h2 class="text-3xl font-bold text-green-700">Advanced AgriSolar Module</h2>
                <p class="text-gray-600">Manage diverse renewable energy sources, smart farm systems, IoT, and research data.</p>
            </div>
        </div>

        <!-- AgriSolar Tabs -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex space-x-1 sm:space-x-2 overflow-x-auto pb-1 -mb-px" aria-label="Tabs">
                <button @click="switchAgriSolarTab('dashboard')" :class="currentAgriSolarTab === 'dashboard' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-3 px-2 border-b-2 font-medium text-xs sm:text-sm">
                    <i class="fas fa-tachometer-alt mr-1"></i> Dashboard
                </button>
                <button @click="switchAgriSolarTab('multiEnergy')" :class="currentAgriSolarTab === 'multiEnergy' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-3 px-2 border-b-2 font-medium text-xs sm:text-sm">
                    <i class="fas fa-plug mr-1"></i> Multi-Energy
                </button>
                <button @click="switchAgriSolarTab('smartSystems')" :class="currentAgriSolarTab === 'smartSystems' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-3 px-2 border-b-2 font-medium text-xs sm:text-sm">
                    <i class="fas fa-cogs mr-1"></i> Smart Systems
                </button>
                <button @click="switchAgriSolarTab('iotNetwork')" :class="currentAgriSolarTab === 'iotNetwork' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-3 px-2 border-b-2 font-medium text-xs sm:text-sm">
                    <i class="fas fa-broadcast-tower mr-1"></i> IoT Network
                </button>
                 <button @click="switchAgriSolarTab('energyMarket')" :class="currentAgriSolarTab === 'energyMarket' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-3 px-2 border-b-2 font-medium text-xs sm:text-sm">
                    <i class="fas fa-exchange-alt mr-1"></i> Energy Market
                </button>
                 <button @click="switchAgriSolarTab('researchIntegration')" :class="currentAgriSolarTab === 'researchIntegration' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-3 px-2 border-b-2 font-medium text-xs sm:text-sm">
                    <i class="fas fa-microscope mr-1"></i> Research
                </button>
                <!-- Legacy Tabs -->
                <button @click="switchAgriSolarTab('assets')" :class="currentAgriSolarTab === 'assets' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-3 px-2 border-b-2 font-medium text-xs sm:text-sm">
                    <i class="fas fa-solar-panel mr-1"></i> Solar Assets (Legacy)
                </button>
                <button @click="switchAgriSolarTab('productionLog')" :class="currentAgriSolarTab === 'productionLog' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-3 px-2 border-b-2 font-medium text-xs sm:text-sm">
                    <i class="fas fa-clipboard-list mr-1"></i> Prod. Logs (Legacy)
                </button>
                 <button @click="switchAgriSolarTab('agrovoltaics')" :class="currentAgriSolarTab === 'agrovoltaics' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-3 px-2 border-b-2 font-medium text-xs sm:text-sm">
                    <i class="fas fa-leaf mr-1"></i> Agrovoltaics (Legacy)
                </button>
                <button @click="switchAgriSolarTab('reportsCerts')" :class="currentAgriSolarTab === 'reportsCerts' ? 'border-green-500 text-green-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'" class="whitespace-nowrap py-3 px-2 border-b-2 font-medium text-xs sm:text-sm">
                    <i class="fas fa-certificate mr-1"></i> Reports & Certs (Legacy)
                </button>
            </nav>
        </div>

        <!-- AgriSolar Dashboard -->
        <div v-if="currentAgriSolarTab === 'dashboard'">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Your Farm's Energy Snapshot</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                 <div class="stat-card">
                    <i class="fas fa-solar-panel text-yellow-500 icon"></i><i class="fas fa-wind text-blue-500 icon ml-1"></i>
                    <div class="value">{{ farmerTotalRenewableCapacityKW.toFixed(2) }} kW</div>
                    <div class="label">Total Renewable Capacity</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-bolt text-blue-500 icon"></i>
                    <div class="value">{{ farmerTotalKwhProduced.toFixed(2) }} kWh</div>
                    <div class="label">Lifetime kWh Produced (Solar)</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-tractor text-green-500 icon"></i>
                    <div class="value">{{ farmerTotalKwhUsedOnFarm.toFixed(2) }} kWh</div>
                    <div class="label">kWh Used on Farm (Solar)</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-leaf text-teal-500 icon"></i>
                    <div class="value">{{ farmerTotalCarbonOffsetKg.toFixed(2) }} kg</div>
                    <div class="label">CO<sub>2</sub> Offset (Simulated)</div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h4 class="text-lg font-medium text-gray-700 mb-3">Recent Activity & Advanced Analytics</h4>
                <p class="text-sm text-gray-600 mb-2">Graphs and more detailed analytics, including multi-source energy production and smart system efficiency, will be shown here.</p>
                <div class="p-4 bg-yellow-50 border border-yellow-300 rounded-md text-sm mb-4">
                    <p><span class="font-semibold">Note:</span> For this demo, we'll primarily focus on solar data for kWh and CO2 stats. Multi-source aggregation and advanced analytics are conceptual.</p>
                </div>
                 <img src="https://www.datapine.com/blog/wp-content/uploads/2021/09/energy-dashboard-overview.png" alt="Sample Energy Dashboard Chart" class="w-full h-auto max-h-96 object-contain rounded-md mt-4 border"/>
                <p class="text-xs text-gray-500 text-center mt-2">Sample chart (data not live from PestiVid)</p>
            </div>
        </div>

        <!-- Multi-Energy Source Management (NEW TAB) -->
        <div v-if="currentAgriSolarTab === 'multiEnergy'">
            <h3 class="text-xl font-semibold text-gray-800 mb-4"><i class="fas fa-plug mr-2"></i>Multi-Energy Source Management</h3>
            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <h4 class="text-lg font-medium text-gray-700 mb-3">Register New Energy Source</h4>
                <form @submit.prevent="registerNewEnergySource" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Source Type</label>
                            <select v-model="newEnergySourceForm.type" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" required>
                                <option value="" disabled>Select Type</option>
                                <option value="solar">Solar</option>
                                <option value="wind">Wind</option>
                                <option value="hydro">Micro-Hydro</option>
                                <option value="biomass">Biomass</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Name / ID</label>
                            <input v-model="newEnergySourceForm.name" type="text" placeholder="e.g., Main Solar Array, Turbine #1" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Capacity (kW)</label>
                            <input v-model.number="newEnergySourceForm.capacityKW" type="number" step="0.1" min="0.1" placeholder="e.g., 10.5" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" required>
                        </div>
                    </div>
                    <div v-if="newEnergySourceForm.type === 'solar'">
                        <label class="block text-sm font-medium text-gray-700">Panel Type</label>
                        <input v-model="newEnergySourceForm.solarPanelType" type="text" placeholder="e.g., Monocrystalline, Bifacial" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                    </div>
                    <div v-if="newEnergySourceForm.type === 'wind'">
                        <label class="block text-sm font-medium text-gray-700">Turbine Model</label>
                        <input v-model="newEnergySourceForm.windTurbineModel" type="text" placeholder="e.g., VAWT 5kW" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                    </div>
                     <!-- Add more type-specific fields as needed -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Installation Date</label>
                        <input v-model="newEnergySourceForm.installationDate" type="date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Notes</label>
                        <textarea v-model="newEnergySourceForm.notes" rows="2" placeholder="Location, maintenance schedule, etc." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm"></textarea>
                    </div>
                    <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700">
                        <i class="fas fa-plus-circle mr-2"></i> Register Source (Simulated)
                    </button>
                </form>
            </div>

            <div class="advanced-agrisolar-subsection">
                <h4>Your Registered Energy Sources</h4>
                <div v-if="advancedEnergySources.length === 0" class="text-center text-gray-500 py-6">
                    <i class="fas fa-info-circle fa-2x mb-2 text-gray-400"></i>
                    <p>No energy sources registered yet.</p>
                </div>
                <div v-else class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div v-for="source in advancedEnergySources" :key="source.id" class="item-card">
                        <h5>
                            <i :class="getEnergySourceIcon(source.type)" class="mr-2"></i>
                            {{ source.name }} ({{ source.type.charAt(0).toUpperCase() + source.type.slice(1) }})
                        </h5>
                        <p class="detail">Capacity: <span class="value">{{ source.capacityKW }} kW</span></p>
                        <p class="detail">Installed: <span class="value">{{ source.installationDate }}</span></p>
                        <p v-if="source.solarPanelType" class="detail">Panel Type: <span class="value">{{ source.solarPanelType }}</span></p>
                        <p v-if="source.windTurbineModel" class="detail">Turbine Model: <span class="value">{{ source.windTurbineModel }}</span></p>
                        <p v-if="source.notes" class="text-xs text-gray-500 mt-1">Notes: {{ source.notes }}</p>
                        <p class="text-xs text-gray-400 font-mono mt-2" title="Simulated Blockchain Record">TX: {{ source.blockchainTx.substring(0,15) }}...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Smart Farm Systems (NEW TAB) -->
        <div v-if="currentAgriSolarTab === 'smartSystems'">
            <h3 class="text-xl font-semibold text-gray-800 mb-4"><i class="fas fa-cogs mr-2"></i>Smart Farm Systems Management</h3>

            <!-- Smart Irrigation -->
            <div class="advanced-agrisolar-subsection">
                <h4>Smart Irrigation Systems</h4>
                <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-md text-sm">
                    <p>Manage solar/wind-powered irrigation pumps, AI-driven scheduling, and water storage systems. (Simulated)</p>
                </div>
                <!-- Form to add irrigation system - conceptual -->
                <div class="item-card mb-4">
                     <h5>Register New Irrigation System (Conceptual)</h5>
                     <button class="mt-2 bg-blue-500 text-white px-3 py-1 rounded text-xs" @click="addNotification('Feature to register new irrigation system coming soon!', 'info')">Register System</button>
                </div>
                <div v-if="!simulatedSmartSystems.irrigation.length" class="text-center text-gray-500 py-4">No smart irrigation systems registered.</div>
                <div v-else class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div v-for="sys in simulatedSmartSystems.irrigation" :key="sys.id" class="item-card">
                        <h5>{{ sys.name }}</h5>
                        <p class="detail">Type: <span class="value">{{ sys.type }}</span></p>
                        <p class="detail">Power Source: <span class="value">{{ sys.powerSource }}</span></p>
                        <p class="detail">Status: <span class="value capitalize">{{ sys.status }}</span></p>
                        <div class="mt-2">
                            <button @click="controlSmartSystem('irrigation', sys.id, 'start')" class="bg-green-500 text-white px-2 py-1 rounded text-xs mr-1">Start</button>
                            <button @click="controlSmartSystem('irrigation', sys.id, 'stop')" class="bg-red-500 text-white px-2 py-1 rounded text-xs">Stop</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Smart Greenhouse -->
            <div class="advanced-agrisolar-subsection">
                <h4>Smart Greenhouse Systems</h4>
                 <div class="mb-4 p-3 bg-green-50 border border-green-200 rounded-md text-sm">
                    <p>Control renewable-powered climate, lighting, ventilation, and hydroponics for greenhouses. (Simulated)</p>
                </div>
                <div v-if="!simulatedSmartSystems.greenhouse.length" class="text-center text-gray-500 py-4">No smart greenhouse systems registered.</div>
                 <div v-else class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div v-for="sys in simulatedSmartSystems.greenhouse" :key="sys.id" class="item-card">
                        <h5>{{ sys.name }}</h5>
                        <p class="detail">Features: <span class="value">{{ sys.features.join(', ') }}</span></p>
                        <p class="detail">Status: <span class="value capitalize">{{ sys.status }}</span></p>
                         <button @click="controlSmartSystem('greenhouse', sys.id, 'toggle_lights')" class="mt-2 bg-yellow-500 text-white px-2 py-1 rounded text-xs">Toggle Lights</button>
                    </div>
                </div>
            </div>
             <!-- Add Vertical Farming section similarly if needed -->
        </div>

        <!-- IoT Network (NEW TAB) -->
        <div v-if="currentAgriSolarTab === 'iotNetwork'">
            <h3 class="text-xl font-semibold text-gray-800 mb-4"><i class="fas fa-broadcast-tower mr-2"></i>IoT Device Network</h3>
            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <h4 class="text-lg font-medium text-gray-700 mb-3">Register New IoT Device</h4>
                <form @submit.prevent="registerNewIoTDevice" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Device Type</label>
                            <select v-model="newIoTDeviceForm.type" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" required>
                                <option value="env_sensor">Environmental Sensor</option>
                                <option value="drone">Agricultural Drone</option>
                                <option value="robot">Farming Robot</option>
                                <option value="weather_station">Weather Station</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Device Name / ID</label>
                            <input v-model="newIoTDeviceForm.name" type="text" placeholder="e.g., Soil Sensor Alpha, Drone X1" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Location</label>
                            <input v-model="newIoTDeviceForm.location" type="text" placeholder="e.g., North Field Sector 2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm">
                        </div>
                    </div>
                    <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700">
                        <i class="fas fa-plus-circle mr-2"></i> Register Device (Simulated)
                    </button>
                </form>
            </div>

            <div class="advanced-agrisolar-subsection">
                <h4>Your Registered IoT Devices</h4>
                <div v-if="iotDevices.length === 0" class="text-center text-gray-500 py-6">
                    <i class="fas fa-satellite-dish fa-2x mb-2 text-gray-400"></i>
                    <p>No IoT devices registered yet.</p>
                </div>
                <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div v-for="device in iotDevices" :key="device.id" class="item-card">
                        <h5><i :class="getIoTDeviceIcon(device.type)" class="mr-2"></i> {{ device.name }}</h5>
                        <p class="detail">Type: <span class="value">{{ device.type.replace('_', ' ') | capitalize }}</span></p>
                        <p class="detail">Location: <span class="value">{{ device.location || 'N/A' }}</span></p>
                        <p class="detail">Status: <span class="value capitalize" :class="{'text-green-600': device.status === 'active', 'text-red-600': device.status === 'inactive'}">{{ device.status }}</span></p>
                        <p v-if="device.lastReading" class="detail">Last Reading: <span class="value">{{ device.lastReading.value }} {{ device.lastReading.unit }} at {{ formatTimestamp(device.lastReading.timestamp) }}</span></p>
                        <p v-if="device.batteryLevel != null" class="detail">Battery: <span class="value">{{ device.batteryLevel }}%</span></p>
                        <p class="text-xs text-gray-400 font-mono mt-2" title="Simulated Blockchain Record">TX: {{ device.blockchainTx.substring(0,15) }}...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Research Integration (NEW TAB) -->
        <div v-if="currentAgriSolarTab === 'researchIntegration'">
            <h3 class="text-xl font-semibold text-gray-800 mb-4"><i class="fas fa-microscope mr-2"></i>Research & Optimization</h3>
            <div class="advanced-agrisolar-subsection">
                <h4>Contribute to Research (Simulated)</h4>
                <p class="text-sm text-gray-600 mb-4">
                    Optionally share your anonymized farm data with leading agricultural research institutions to advance sustainable practices.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="item-card">
                        <h5>NREL Agrivoltaics Database</h5>
                        <p class="text-xs text-gray-600 mb-3">
                            Contribute to the National Renewable Energy Laboratory's agrivoltaics research.
                        </p>
                        <button @click="shareDataWithResearch('NREL')" class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-700">
                            Share Data with NREL (Sim.)
                        </button>
                    </div>
                    <div class="item-card">
                        <h5>University Research Network</h5>
                        <p class="text-xs text-gray-600 mb-3">
                            Collaborate with university programs focusing on renewable ag-tech.
                        </p>
                        <button @click="shareDataWithResearch('University Network')" class="bg-green-600 text-white px-3 py-1.5 rounded text-sm hover:bg-green-700">
                            Join Research Network (Sim.)
                        </button>
                    </div>
                </div>
            </div>

            <div class="advanced-agrisolar-subsection">
                <h4>AI-Powered Farm Optimization (Simulated Insights)</h4>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="item-card">
                        <h5>Energy Efficiency Analysis</h5>
                        <p class="text-xs text-gray-600 mb-3">Calculate Land Equivalent Ratio (LER) and optimize energy usage based on your multi-source setup and crop data.</p>
                        <button @click="runEnergyEfficiencyAnalysis" class="bg-teal-600 text-white px-3 py-1.5 rounded text-sm hover:bg-teal-700">
                            Run LER & Efficiency Analysis (Sim.)
                        </button>
                        <div v-if="energyAnalysisResults" class="mt-3 p-2 bg-teal-50 rounded border border-teal-200 text-xs">
                            <p><strong>LER:</strong> {{ energyAnalysisResults.LER.toFixed(2) }}</p>
                            <p><strong>Energy Efficiency:</strong> {{ (energyAnalysisResults.energyEfficiency * 100).toFixed(1) }}%</p>
                            <p><strong>Crop Productivity Factor:</strong> {{ energyAnalysisResults.cropProductivity.toFixed(2) }}</p>
                            <p><strong>Water Savings:</strong> {{ energyAnalysisResults.waterSavings }}% (Est.)</p>
                            <p><strong>CO2 Offset (from this analysis):</strong> {{ energyAnalysisResults.carbonOffset.toFixed(2) }} kg</p>
                        </div>
                    </div>
                     <div class="item-card">
                        <h5>Predictive Energy Optimization</h5>
                        <p class="text-xs text-gray-600 mb-3">Get AI-driven recommendations for peak shaving, load balancing, storage needs, and grid integration opportunities.</p>
                        <button @click="runPredictiveOptimization" class="bg-purple-600 text-white px-3 py-1.5 rounded text-sm hover:bg-purple-700">
                            Get Optimization Insights (Sim.)
                        </button>
                         <div v-if="predictiveOptimizationResults" class="mt-3 p-2 bg-purple-50 rounded border border-purple-200 text-xs">
                            <p><strong>Peak Hour Shaving:</strong> {{ predictiveOptimizationResults.peakHours }}</p>
                            <p><strong>Load Balancing:</strong> {{ predictiveOptimizationResults.loadBalancing }}</p>
                            <p><strong>Storage Recommendation:</strong> {{ predictiveOptimizationResults.storageNeeds }}</p>
                            <p><strong>Grid Integration Potential:</strong> {{ predictiveOptimizationResults.gridIntegration }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Solar Assets Management (Legacy) -->
        <div v-if="currentAgriSolarTab === 'assets'">
            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Register New Solar Asset</h3>
                <form @submit.prevent="registerSolarAsset" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Asset Name / ID</label>
                            <input v-model="newSolarAssetForm.assetName" type="text" placeholder="e.g., Barn Rooftop Array" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Capacity (kW)</label>
                            <input v-model.number="newSolarAssetForm.capacityKW" type="number" step="0.1" min="0.1" placeholder="e.g., 10.5" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Installation Date</label>
                            <input v-model="newSolarAssetForm.installationDate" type="date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Notes (e.g., IoT sensor ID - simulated)</label>
                        <textarea v-model="newSolarAssetForm.notes" rows="2" placeholder="Location details, panel type..." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm"></textarea>
                    </div>
                    <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        <i class="fas fa-plus-circle mr-2"></i> Register Asset (Simulated Blockchain)
                    </button>
                </form>
            </div>

            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Your Registered Solar Assets</h3>
                <div v-if="farmerSolarAssets.length === 0" class="text-center text-gray-500 py-6">
                    <i class="fas fa-info-circle fa-2x mb-2 text-gray-400"></i>
                    <p>No solar assets registered yet. Use the form above to add your first one.</p>
                </div>
                <ul v-else class="space-y-4">
                    <li v-for="asset in farmerSolarAssets" :key="asset.id" class="p-4 border border-gray-200 rounded-md shadow-sm bg-gray-50">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="text-lg font-medium text-green-700">{{ asset.assetName }}</h4>
                                <p class="text-sm text-gray-600">Capacity: <span class="font-semibold">{{ asset.capacityKW }} kW</span></p>
                                <p class="text-sm text-gray-600">Installed: <span class="font-semibold">{{ asset.installationDate }}</span></p>
                                <p v-if="asset.notes" class="text-xs text-gray-500 mt-1">Notes: {{ asset.notes }}</p>
                            </div>
                            <span class="text-xs text-gray-400 font-mono" title="Simulated Blockchain Record">TX: {{ asset.simulatedBlockchainRecord.substring(0,15) }}...</span>
                        </div>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Energy Production Logging (Legacy) -->
        <div v-if="currentAgriSolarTab === 'productionLog'">
             <div class="bg-white p-6 rounded-lg shadow mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Log Energy Production & Usage (Solar Only)</h3>
                <form @submit.prevent="logEnergyProduction" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Select Solar Asset</label>
                            <select v-model="newEnergyLogForm.solarAssetId" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" required>
                                <option value="" disabled>-- Select a Solar Asset --</option>
                                <option v-for="asset in farmerSolarAssets" :key="asset.id" :value="asset.id">{{ asset.assetName }} ({{ asset.capacityKW }} kW)</option>
                                <option v-if="farmerSolarAssets.length === 0" disabled>Register a solar asset first</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Date of Production</label>
                            <input v-model="newEnergyLogForm.date" type="date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" required>
                        </div>
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Total kWh Produced</label>
                            <input v-model.number="newEnergyLogForm.kwhProduced" type="number" step="0.01" min="0" placeholder="e.g., 50.75" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">kWh Used on Farm</label>
                            <input v-model.number="newEnergyLogForm.kwhUsedOnFarm" type="number" step="0.01" min="0" placeholder="e.g., 20.50" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" required>
                        </div>
                    </div>
                    <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        <i class="fas fa-save mr-2"></i> Log Production (Simulated Blockchain)
                    </button>
                </form>
            </div>
             <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Your Solar Energy Production Logs</h3>
                <div v-if="solarEnergyProductionLogs.length === 0" class="text-center text-gray-500 py-6">
                    <i class="fas fa-history fa-2x mb-2 text-gray-400"></i>
                    <p>No solar energy production logged yet. Use the form above to add entries.</p>
                </div>
                <div v-else class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asset</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Produced (kWh)</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Used Farm (kWh)</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">CO Offset (kg)</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Simulated TX</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr v-for="log in solarEnergyProductionLogs" :key="log.id">
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">{{ log.date }}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">{{ getAssetName(log.solarAssetId) }}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 text-right font-medium">{{ log.kwhProduced.toFixed(2) }}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 text-right font-medium">{{ log.kwhUsedOnFarm.toFixed(2) }}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-green-600 text-right font-medium">{{ log.carbonOffsetKg.toFixed(2) }}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-400 font-mono" :title="log.simulatedBlockchainRecord">{{ log.simulatedBlockchainRecord.substring(0,15) }}...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Agrovoltaics Section (Legacy Beta) -->
        <div v-if="currentAgriSolarTab === 'agrovoltaics'">
            <div class="bg-white p-6 rounded-lg shadow mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4"><i class="fas fa-leaf mr-2"></i>Register Agrovoltaic Setup</h3>
                 <div v-if="farmerSolarAssets.length === 0" class="text-center text-gray-500 py-4 mb-4 bg-yellow-50 border border-yellow-200 rounded">
                    <i class="fas fa-solar-panel fa-2x mb-2 text-yellow-400"></i>
                    <p>You need to register a Solar Asset first before registering an Agrovoltaic setup.</p>
                    <button @click="switchAgriSolarTab('assets')" class="text-blue-600 hover:underline text-sm mt-2">Go to Solar Assets</button>
                </div>
                <form v-else @submit.prevent="registerAgrovoltaicSetup" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div>
                            <label class="block text-sm font-medium text-gray-700">Setup Name</label>
                            <input v-model="newAgrovoltaicSetupForm.setupName" type="text" placeholder="e.g., Field A Solar Crop" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Area Size (Acres / Hectares)</label>
                            <input v-model.number="newAgrovoltaicSetupForm.areaSize" type="number" step="0.01" min="0.01" placeholder="e.g., 3.5" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" required>
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700">Select Associated Solar Asset</label>
                            <select v-model="newAgrovoltaicSetupForm.solarAssetId" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" required>
                                <option value="" disabled>-- Select a Solar Asset --</option>
                                <option v-for="asset in farmerSolarAssets" :key="asset.id" :value="asset.id">{{ asset.assetName }} ({{ asset.capacityKW }} kW)</option>
                            </select>
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700">Crop Grown Under Panels</label>
                            <input v-model="newAgrovoltaicSetupForm.cropType" type="text" placeholder="e.g., Shade Tolerant Herbs" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Link Verification Video (Optional, marked 'agrovoltaics' or 'agristream')</label>
                         <select v-model="newAgrovoltaicSetupForm.videoCid" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                            <option value="">-- Select a Video (Optional) --</option>
                            <option v-for="vid in availableVideosForAgrovoltaics" :key="vid.cid" :value="vid.cid"> {{ vid.crop || 'General' }} ({{ vid.location || 'N/A' }}) - CID: {{ vid.cid.substring(0,8) }}... </option>
                            <option v-if="availableVideosForAgrovoltaics.length === 0" disabled>No suitable videos uploaded yet.</option>
                        </select>
                         <p v-if="agrovoltaicVideoToLink" class="text-sm text-green-700 mt-2">Pre-selected CID: <span class="font-mono">{{ agrovoltaicVideoToLink.substring(0,10) }}...</span></p>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700">Setup Details / Notes</label>
                        <textarea v-model="newAgrovoltaicSetupForm.notes" rows="2" placeholder="Panel height, spacing, irrigation system details, etc." class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm"></textarea>
                    </div>
                     <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        <i class="fas fa-plus-circle mr-2"></i> Register Setup (Simulated Blockchain)
                    </button>
                </form>
            </div>

            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Your Agrovoltaic Setups</h3>
                <div v-if="farmerAgrovoltaicsSetups.length === 0" class="text-center text-gray-500 py-6">
                    <i class="fas fa-tractor fa-2x mb-2 text-gray-400"></i>
                    <p>No agrovoltaic setups registered yet. Use the form above.</p>
                </div>
                <ul v-else class="space-y-4">
                     <li v-for="setup in farmerAgrovoltaicsSetups" :key="setup.id" class="p-4 border border-gray-200 rounded-md shadow-sm bg-orange-50">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="text-lg font-medium text-orange-700">{{ setup.setupName }}</h4>
                                <p class="text-sm text-gray-600">Area: <span class="font-semibold">{{ setup.areaSize }} {{ setup.areaUnit || 'Acres' }}</span></p>
                                <p class="text-sm text-gray-600">Crop: <span class="font-semibold">{{ setup.cropType }}</span></p>
                                <p class="text-sm text-gray-600">Solar Asset: <span class="font-semibold">{{ getAssetName(setup.solarAssetId) }}</span></p>
                                <p v-if="setup.videoCid" class="text-sm text-gray-600">Video CID: <span class="font-mono text-xs">{{ setup.videoCid.substring(0,10) }}...</span> <a :href="ipfsUrl(setup.videoCid)" target="_blank" class="text-blue-600 hover:underline ml-1"><i class="fas fa-external-link-alt text-xs"></i></a></p>
                                <p v-if="setup.notes" class="text-xs text-gray-500 mt-1">Notes: {{ setup.notes }}</p>
                            </div>
                             <span class="text-xs text-gray-400 font-mono" title="Simulated Blockchain Record">TX: {{ setup.simulatedBlockchainRecord.substring(0,15) }}...</span>
                        </div>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Energy Marketplace (Existing - Now under legacy, new one potentially under 'Multi-Energy' if structure changes) -->
        <div v-if="currentAgriSolarTab === 'energyMarket'">
            <div v-if="role === 'farmer'" class="bg-white p-6 rounded-lg shadow mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4"><i class="fas fa-exchange-alt mr-2"></i>List Excess Energy for Sale</h3>
                <div v-if="farmerSolarAssets.length === 0" class="text-center text-gray-500 py-4 mb-4 bg-yellow-50 border border-yellow-200 rounded">
                    <i class="fas fa-solar-panel fa-2x mb-2 text-yellow-400"></i>
                    <p>You need to register a Solar Asset and log production to list energy.</p>
                    <button @click="switchAgriSolarTab('assets')" class="text-blue-600 hover:underline text-sm mt-2">Register Assets</button>
                </div>
                 <div v-else-if="solarEnergyProductionLogs.length === 0" class="text-center text-gray-500 py-4 mb-4 bg-yellow-50 border border-yellow-200 rounded">
                    <i class="fas fa-clipboard-list fa-2x mb-2 text-yellow-400"></i>
                    <p>You need to log energy production to list energy.</p>
                    <button @click="switchAgriSolarTab('productionLog')" class="text-blue-600 hover:underline text-sm mt-2">Log Production</button>
                </div>
                <form v-else @submit.prevent="createEnergyListing" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div>
                            <label class="block text-sm font-medium text-gray-700">Select Solar Asset</label>
                             <select v-model="newEnergyListingForm.solarAssetId" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" required>
                                <option value="" disabled>-- Select an Asset --</option>
                                <option v-for="asset in farmerSolarAssets" :key="asset.id" :value="asset.id">{{ asset.assetName }} ({{ asset.capacityKW }} kW)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">kWh Available to Sell (e.g., from Production Logs)</label>
                            <input v-model.number="newEnergyListingForm.kwhToSell" type="number" step="0.01" min="0.01" placeholder="e.g., 25.5" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Price per kWh (SOL)</label>
                        <input v-model.number="newEnergyListingForm.pricePerKwhSOL" type="number" step="0.0001" min="0.0001" placeholder="e.g., 0.005" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" required>
                    </div>
                     <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        <i class="fas fa-plus-circle mr-2"></i> Create Listing (Simulated)
                    </button>
                </form>
            </div>

            <div class="bg-white p-6 rounded-lg shadow">
                 <h3 class="text-xl font-semibold text-gray-800 mb-4"><i class="fas fa-search-dollar mr-2"></i>Browse Energy Listings</h3>
                 <div v-if="!isUserAuthenticated" class="text-center text-gray-500 py-6 bg-gray-50 rounded">
                     <i class="fas fa-user-slash fa-2x mb-2 text-gray-400"></i>
                     <p>Please log in to browse energy listings.</p>
                 </div>
                 <div v-else-if="activeEnergyListings.length === 0" class="text-center text-gray-500 py-6">
                    <i class="fas fa-clipboard-list fa-2x mb-2 text-gray-400"></i>
                    <p>No active energy listings found.</p>
                </div>
                 <div v-else class="space-y-4">
                     <div v-for="listing in activeEnergyListings" :key="listing.id" class="p-4 border border-gray-200 rounded-md shadow-sm bg-blue-50">
                         <div class="flex justify-between items-center">
                            <div>
                                <h4 class="text-lg font-medium text-blue-700">Energy from {{ getAssetName(listing.solarAssetId) }}</h4>
                                <p class="text-sm text-gray-600">Seller: <span class="font-semibold">{{ getFarmerDisplayIdentifier(listing.farmerWallet) }}</span></p>
                                <p class="text-sm text-gray-600">Available: <span class="font-semibold">{{ listing.kwhAvailable.toFixed(2) }} kWh</span></p>
                                <p class="text-sm text-gray-600">Price: <span class="font-semibold font-mono">{{ listing.pricePerKwhSOL.toFixed(4) }} SOL/kWh</span></p>
                            </div>
                            <button @click="initiateEnergyPurchase(listing)"
                                    :disabled="listing.farmerWallet === currentUserIdentifier"
                                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-shopping-cart mr-1"></i> {{ listing.farmerWallet === currentUserIdentifier ? 'Your Listing' : 'Buy Energy' }}
                            </button>
                         </div>
                     </div>
                 </div>
            </div>

             <div v-if="role === 'farmer' && farmerEnergyListings.length > 0" class="bg-white p-6 rounded-lg shadow mt-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4"><i class="fas fa-list-alt mr-2"></i>Your Energy Listings</h3>
                 <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asset</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Listed (kWh)</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Price (SOL/kWh)</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Available (kWh)</th>
                                 <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Simulated TX</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                             <tr v-for="listing in farmerEnergyListings" :key="listing.id">
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">{{ getAssetName(listing.solarAssetId) }}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 text-right">{{ listing.initialKwhToSell.toFixed(2) }}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700 text-right font-mono">{{ listing.pricePerKwhSOL.toFixed(4) }}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-green-600 text-right font-medium">{{ listing.kwhAvailable.toFixed(2) }}</td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm"> <span :class="{'px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full': true, 'bg-green-100 text-green-800': listing.status === 'active', 'bg-gray-100 text-gray-800': listing.status === 'sold', 'bg-red-100 text-red-800': listing.status === 'cancelled' }"> {{ listing.status.charAt(0).toUpperCase() + listing.status.slice(1) }} </span> </td>
                                <td class="px-4 py-3 whitespace-nowrap text-xs text-gray-400 font-mono" :title="listing.simulatedBlockchainRecord">{{ listing.simulatedBlockchainRecord.substring(0,15) }}...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
             </div>
        </div>

        <!-- Reports & Certifications (Legacy Soon) -->
        <div v-if="currentAgriSolarTab === 'reportsCerts'">
             <div class="bg-white p-6 rounded-lg shadow mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4"><i class="fas fa-certificate mr-2"></i>Environmental Impact & Certifications</h3>
                <p class="text-gray-600 mb-4">Track your farm's sustainability and generate shareable reports and certifications.</p>

                 <div class="mt-6 p-4 border rounded-md bg-green-50 text-center mb-6">
                    <i class="fas fa-leaf text-5xl text-teal-500 mb-3"></i>
                    <h4 class="text-lg font-semibold text-teal-700">Total Estimated CO Offset</h4>
                    <p class="text-2xl font-bold text-teal-800">{{ farmerTotalCarbonOffsetKg.toFixed(2) }} kg</p>
                    <p class="text-sm text-gray-600 mt-2">Based on your logged solar energy production.</p>
                </div>

                 <div v-if="role === 'farmer'" class="p-4 border rounded-md bg-blue-50 mb-6">
                    <h4 class="text-lg font-semibold text-blue-700 mb-3">Simulated Certifications</h4>
                    <div v-if="farmerCertifications.length === 0" class="text-center text-gray-500 py-4">
                        <i class="fas fa-award fa-2x mb-2 text-gray-400"></i>
                        <p>You have no simulated certifications yet.</p>
                    </div>
                     <div v-else class="space-y-3">
                         <div v-for="cert in farmerCertifications" :key="cert.id" class="p-3 border rounded-md bg-white shadow-sm">
                             <div class="flex justify-between items-center">
                                 <div>
                                    <h5 class="font-semibold text-gray-800">{{ cert.type }}</h5>
                                    <p class="text-xs text-gray-600">Issued: {{ cert.issueDate }}</p>
                                     <p v-if="cert.notes" class="text-xs text-gray-500 mt-1">{{ cert.notes }}</p>
                                </div>
                                <span class="text-xs text-gray-400 font-mono" title="Simulated Blockchain Record">{{ cert.simulatedBlockchainRecord.substring(0,15) }}...</span>
                            </div>
                        </div>
                     </div>
                     <button @click="requestCarbonOffsetCertificate" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 mt-4" :disabled="requestCertInProgress">
                         <i :class="requestCertInProgress ? 'fas fa-spinner fa-spin' : 'fas fa-award'" class="mr-2"></i>
                         {{ requestCertInProgress ? 'Requesting...' : 'Request Carbon Offset Certificate (Sim.)' }}
                     </button>
                     <p class="text-xs text-gray-500 mt-2">Requires logging sufficient energy production (min 100 kg offset).</p>
                 </div>

                 <div class="p-4 border rounded-md bg-gray-100">
                    <h4 class="text-lg font-semibold text-gray-700 mb-3">Reports & Analytics (Future)</h4>
                    <p class="text-sm text-gray-600">Detailed reports on energy production, usage, carbon impact, and links to verified data will be available here.</p>
                     <img src="https://www.datapine.com/blog/wp-content/uploads/2021/09/energy-dashboard-overview.png" alt="Sample Report Chart" class="w-full h-auto max-h-60 object-contain rounded-md mt-4 border"/>
                     <p class="text-xs text-gray-500 text-center mt-2">Sample Report Visualization</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Farmer AgriSolar Section (Non-Farmer View) -->
    <section v-if="current==='farmerAgriSolar' && !isOrangeIdCallback && role!=='farmer'" class="max-w-3xl mx-auto mt-6">
        <div class="bg-white p-8 rounded-lg shadow text-center">
            <i class="fas fa-solar-panel text-yellow-500 text-4xl mb-4"></i>
            <h2 class="text-2xl font-bold text-green-700 mb-3">AgriSolar Module</h2>
            <p class="text-gray-700 mb-4">The AgriSolar module is primarily for **Farmers** to manage their farm's renewable energy.</p>
             <div class="mb-4 bg-blue-50 p-4 rounded-md border border-blue-200">
                 <p class="font-semibold text-blue-700 mb-2">Browse Energy Marketplace</p>
                <p class="text-gray-700 text-sm">Buyers and Investors can browse active energy listings here:</p>
                 <button @click="switchAgriSolarTab('energyMarket')" class="mt-3 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">
                    <i class="fas fa-exchange-alt mr-2"></i> Go to Energy Market
                </button>
             </div>
             <p v-if="!isUserAuthenticated" class="text-yellow-700 text-sm mt-4">Please log in or switch to a Farmer account to access full AgriSolar features.</p>
             <p v-else class="text-gray-700 text-sm mt-4">Logged in as {{ role }}. Switch to a Farmer account for full access.</p>
        </div>
    </section>


    <!-- Farmer AgriStream Section -->
    <section v-if="current==='farmerAgriStream' && !isOrangeIdCallback" class="max-w-4xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-5"><i class="fas fa-stream mr-2"></i>AgriStream: My Crop Videos</h2>
        <div class="bg-white rounded shadow-md p-6">
            <div v-if="farmerVideos.length===0" class="text-gray-600 text-center p-6 bg-gray-50 rounded"> <i class="fas fa-film text-4xl text-gray-400 mb-3"></i><br> No uploads yet. Go to <a href="#" class="text-green-700 underline" @click.prevent="switchPage('farmerPestiVid')">PestiVid</a> to upload. </div>
            <div v-else class="space-y-6">
            <div v-for="vid in farmerVideos" :key="vid.cid" class="flex flex-col md:flex-row items-start border-b last:border-b-0 pb-6 gap-6 transition-all duration-500" :ref="'videoCard-' + vid.cid" :class="{'bg-yellow-50 border-l-4 border-yellow-400 shadow-lg transform scale-102': vid.cid === highlightedAgriStreamVideoCid}">
                <div class="w-full md:w-60 flex-shrink-0"> <video :src="ipfsUrl(vid.cid)" controls playsinline webkit-playsinline class="rounded shadow w-full bg-black"></video> </div>
                <div class="flex-1">
                <div class="font-bold text-lg">{{ vid.crop }}</div>
                <div class="text-xs mb-1" :class="{ 'text-blue-700': vid.purpose === 'sell', 'text-purple-700': vid.purpose === 'funding', 'text-gray-600': vid.purpose === 'agristream' || !vid.purpose, 'text-orange-600': vid.purpose === 'agrovoltaics' }"> Intended for: <span class="font-semibold"> {{ vid.purpose === 'sell' ? 'Listing for Sale' : (vid.purpose === 'funding' ? 'Funding Request' : (vid.purpose === 'agristream' ? 'AgriStream (General)' : (vid.purpose === 'agrovoltaics' ? 'Agrovoltaics Setup' : 'N/A'))) }} </span> </div>
                <div class="text-sm mb-1">Location: <span class="font-mono text-gray-700">{{ vid.location }}</span></div>
                <div class="text-sm mb-1">Pesticide: <span class="font-mono text-gray-700">{{ vid.pesticide }}</span></div>
                <div class="text-sm mb-1">Pesticide Co.: <span class="font-mono text-gray-700">{{ vid.pesticideCompany || 'N/A' }}</span></div>
                <div class="text-xs text-gray-500 mb-2">CID: <span class="font-mono break-all">{{ vid.cid }}</span></div>
                <div class="text-xs text-gray-400 mb-1">File Hash (SHA256): <span class="font-mono break-all" :title="vid.videoFileHash || 'N/A'">{{ vid.videoFileHash ? vid.videoFileHash.substring(0,10) + '...' : 'N/A' }}</span></div>
                <a :href="ipfsUrl(vid.cid)" target="_blank" class="text-blue-600 hover:underline text-xs mr-3"><i class="fas fa-external-link-alt mr-1"></i>View on Gateway</a>
                <button v-if="!isListed(vid.cid) && (vid.purpose === 'sell' || vid.purpose === 'agristream' || !vid.purpose)" @click="goToListing(vid.cid)" class="text-green-600 hover:underline text-xs"> <i class="fas fa-tags mr-1"></i> {{ (vid.purpose === 'sell' && !isListed(vid.cid)) ? 'Complete Listing' : 'Create Listing' }} </button>
                <span v-else-if="isListed(vid.cid)" class="text-gray-500 text-xs"><i class="fas fa-check mr-1"></i>Already Listed</span>
                <button v-if="!isUsedInFunding(vid.cid) && (vid.purpose === 'funding' || vid.purpose === 'agristream')" @click="navigateToPageWithParam('farmerFunding', 'cid', vid.cid)" class="text-purple-600 hover:underline text-xs ml-2"> <i class="fas fa-hand-holding-usd mr-1"></i> {{ (vid.purpose === 'funding' && !isUsedInFunding(vid.cid)) ? 'Complete Funding Request' : 'Use for Funding' }} </button>
                <span v-if="isUsedInFunding(vid.cid)" class="text-gray-500 text-xs ml-2"><i class="fas fa-check mr-1"></i>Used for Funding</span>
                <button v-if="!isUsedInAgrovoltaics(vid.cid) && (vid.purpose === 'agrovoltaics' || vid.purpose === 'agristream')" @click="navigateToPageWithParam('farmerAgriSolar', 'agroVideoCid', vid.cid)" class="text-orange-600 hover:underline text-xs ml-2"> <i class="fas fa-leaf mr-1"></i> Link to Agrovoltaic Setup </button>
                 <span v-if="isUsedInAgrovoltaics(vid.cid)" class="text-gray-500 text-xs ml-2"><i class="fas fa-check mr-1"></i>Used for Agrovoltaics</span>
                </div>
            </div>
            </div>
        </div>
    </section>
    <!-- Farmer Sell Section -->
    <section v-if="current==='farmerSell' && !isOrangeIdCallback" class="max-w-2xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-tags mr-2"></i>Sell Farm Crop on Marketplace</h2>
      <div class="bg-white rounded shadow-md p-6">
        <form @submit.prevent="createListing">
          <div class="mb-4">
            <label class="block text-gray-600 mb-1">Select Uploaded Video (Unlisted, purpose 'sell' or 'agristream')</label>
            <select v-model="listingForm.cid" class="w-full px-3 py-2 border rounded bg-white mb-2" required>
              <option value="" disabled>Select video...</option>
              <option v-for="vid in availableVideosForListing" :key="vid.cid" :value="vid.cid"> {{ vid.crop }} ({{ vid.location }}) - Pest: {{ vid.pesticide }} by {{ vid.pesticideCompany || 'N/A' }} </option>
              <option v-if="availableVideosForListing.length === 0 && farmerVideos.length > 0" disabled>No suitable unlisted videos available.</option>
               <option v-if="farmerVideos.length === 0" disabled>No videos uploaded yet.</option>
            </select>
            <p v-if="!isUserAuthenticated" class="text-red-500 mt-3 text-sm">Log in to create listings.</p>
            <p v-if="isUserAuthenticated && role !== 'farmer'" class="text-red-500 mt-3 text-sm">Switch to a Farmer account to create listings.</p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">
            <div> <label class="block text-gray-600 mb-1">Min Price (SOL)</label> <input type="number" v-model="listingForm.minPrice" class="w-full px-3 py-2 border rounded" min="0.01" step="0.01" required placeholder="e.g., 0.5"> </div>
            <div> <label class="block text-gray-600 mb-1">Max Price (SOL)</label> <input type="number" v-model="listingForm.maxPrice" class="w-full px-3 py-2 border rounded" :min="listingForm.minPrice || 0.01" step="0.01" required placeholder="e.g., 1.5"> </div>
          </div>
          <div class="mb-4"> <label class="flex items-center"> <input type="checkbox" v-model="listingForm.notifyBuyers" class="form-checkbox h-4 w-4 text-green-600"> <span class="ml-2 text-sm text-gray-700">Notify potential buyers about this listing</span> </label> </div>
          <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded w-full" :disabled="!listingForm.cid || !isUserAuthenticated || role !== 'farmer'"> <i class="fas fa-plus-circle mr-1"></i>Create Listing </button>

        </form>
        <div v-if="createdListingId" class="bg-green-100 text-green-700 px-4 py-3 mt-4 rounded font-medium text-sm"> <i class="fas fa-check mr-1"></i> Listing created successfully! Tx: <span class="font-mono text-xs">{{ createdListingId.substring(0,10) }}...</span> <div v-if="listingNotificationSent" class="mt-1 text-sm"> <i class="fas fa-bell mr-1"></i> Buyers have been notified about your new listing. </div> </div>
        <div class="mt-8">
          <h3 class="font-semibold mb-2 text-gray-700">Your Active Listings</h3>
          <div v-if="farmerListings.length===0" class="text-gray-600 text-sm bg-gray-50 p-4 rounded text-center">You have no active listings.</div>
          <ul v-else class="space-y-3">
            <li v-for="l in farmerListings" :key="l.id" class="py-3 px-4 border rounded flex flex-col sm:flex-row justify-between sm:items-center text-sm bg-white shadow-sm">
              <div> <span class="font-medium">{{ l.crop }}</span> <span class="text-xs text-gray-500 ml-1"> ({{l.location}})</span> <br> <span class="text-xs text-gray-500"> CID: {{l.cid.substring(0, 8)}}...</span> | <span class="text-xs text-gray-500"> Pest. Co: {{ l.pesticideCompany || 'N/A' }}</span> <div v-if="l.notificationSent" class="text-xs text-green-600 mt-1"> <i class="fas fa-bell mr-1"></i> Buyers notified </div> </div>
              <div class="mt-2 sm:mt-0 text-right"> <span>Min: <span class="font-mono font-semibold">{{ l.minPrice }}</span> SOL</span><br> <span>Max: <span class="font-mono font-semibold">{{ l.maxPrice }}</span> SOL</span> <button v-if="!l.notificationSent" @click="notifyBuyersAboutListing(l, true)" class="ml-2 text-xs text-blue-600 border border-blue-300 rounded px-2 py-1 hover:bg-blue-50"> <i class="fas fa-bell-slash mr-1"></i> Notify </button> </div>
            </li>
          </ul>
        </div>
      </div>
    </section>
    <!-- Farmer Funding Section -->
    <section v-if="current==='farmerFunding' && !isOrangeIdCallback" class="max-w-3xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-money-bill-wave mr-2"></i>Request Funding for Your Farm Project</h2>
        <div class="bg-white rounded shadow-md p-6">
            <form @submit.prevent="createFundingRequest_V1">
             <!-- Add Project Type Selection -->
            <div class="mb-4">
                <label class="block text-gray-600 mb-1 text-sm">Project Type</label>
                <select v-model="fundingForm.projectType" class="w-full px-3 py-2 border rounded bg-white text-sm" required>
                    <option value="agricultural">Agricultural Crop Project</option>
                    <option value="solar">Solar Installation Project</option>
                    <option value="wind">Wind Energy Project</option>
                    <option value="hydro">Micro-Hydro Project</option>
                    <option value="biomass">Biomass Energy Project</option>
                    <option value="smart_irrigation">Smart Irrigation System</option>
                    <option value="smart_greenhouse">Smart Greenhouse System</option>
                </select>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div> <label class="block text-gray-600 mb-1 text-sm">Project Title</label> <input v-model="fundingForm.title" class="w-full px-3 py-2 border rounded text-sm" required :placeholder="getFundingProjectPlaceholder('title')"> </div>
                <div v-if="fundingForm.projectType === 'agricultural'"> <label class="block text-gray-600 mb-1 text-sm">Crop Type</label> <input v-model="fundingForm.crop" class="w-full px-3 py-2 border rounded text-sm" placeholder="e.g., Roma Tomatoes"> </div>
                <div v-if="fundingForm.projectType === 'solar' || fundingForm.projectType === 'wind' || fundingForm.projectType === 'hydro' || fundingForm.projectType === 'biomass'"> <label class="block text-sm font-medium text-gray-700">Energy Capacity Target (kW)</label> <input type="number" v-model.number="fundingForm.energyCapacityKW" class="w-full px-3 py-2 border rounded text-sm" min="0.1" step="0.1" placeholder="e.g., 25 kW"> </div>
                <div v-if="fundingForm.projectType === 'agricultural'"> <label class="block text-gray-600 mb-1 text-sm">Land Size (Acres)</label> <input type="number" v-model.number="fundingForm.acres" class="w-full px-3 py-2 border rounded text-sm" min="0.1" step="0.1" placeholder="e.g., 5.5"> </div>
                <div> <label class="block text-gray-600 mb-1 text-sm">Funding Required (SOL)</label> <input type="number" v-model.number="fundingForm.amount" class="w-full px-3 py-2 border rounded text-sm" min="1" step="0.1" required placeholder="e.g., 50"> </div>
                <div v-if="fundingForm.projectType === 'agricultural'"> <label class="block text-gray-600 mb-1 text-sm">Growing Method</label> <select v-model="fundingForm.method" class="w-full px-3 py-2 border rounded bg-white text-sm"> <option value="">Select method...</option> <option value="organic">Organic</option> <option value="conventional">Conventional</option> <option value="hydroponic">Hydroponic</option> <option value="aquaponic">Aquaponic</option> <option value="regenerative">Regenerative</option> </select> </div>
                <div v-if="fundingForm.projectType === 'solar' || fundingForm.projectType === 'wind' || fundingForm.projectType === 'hydro' || fundingForm.projectType === 'biomass'"> <label class="block text-sm font-medium text-gray-700">Expected Annual Yield (kWh/Units)</label> <input type="text" v-model="fundingForm.expectedAnnualYield" class="w-full px-3 py-2 border rounded text-sm" placeholder="e.g., 30000 kWh or 500 m biogas"> </div>
                <div> <label class="block text-gray-600 mb-1 text-sm">Expected ROI (%)</label> <input type="number" v-model.number="fundingForm.roi" class="w-full px-3 py-2 border rounded text-sm" min="1" max="100" required placeholder="e.g., 15"> </div>
            </div>
            <div class="mb-4"> <label class="block text-gray-600 mb-1 text-sm">Select Video Evidence (if applicable, purpose 'funding' or 'agristream')</label> <select v-model="fundingForm.cid" class="w-full px-3 py-2 border rounded bg-white mb-2 text-sm"> <option value="">Select video (or N/A for new energy/smart system)...</option> <option v-for="vid in availableVideosForFunding" :key="vid.cid" :value="vid.cid"> {{ vid.crop || 'General Video' }} ({{ vid.location || 'N/A' }}) - {{ vid.pesticideCompany || 'N/A' }} </option> <option v-if="availableVideosForFunding.length === 0 && farmerVideos.length > 0" disabled>No suitable videos available.</option> <option v-if="farmerVideos.length === 0 && fundingForm.projectType === 'agricultural'" disabled>No videos uploaded yet.</option> </select> </div>
            <div class="mb-4"> <label class="block text-gray-600 mb-1 text-sm">Project Description</label> <textarea v-model="fundingForm.description" class="w-full px-3 py-2 border rounded text-sm" rows="4" required :placeholder="getFundingProjectPlaceholder('description')"></textarea> </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"> <div> <label class="block text-gray-600 mb-1 text-sm">Timeline (Months for Agri / Years for Energy/Smart System Payback)</label> <input type="number" v-model.number="fundingForm.timeline" class="w-full px-3 py-2 border rounded text-sm" min="1" :max="fundingForm.projectType.includes('solar') || fundingForm.projectType.includes('wind') || fundingForm.projectType.includes('hydro') || fundingForm.projectType.includes('biomass') || fundingForm.projectType.includes('smart') ? 20 : 36" required :placeholder="getFundingProjectPlaceholder('timeline')"> </div> <div> <label class="block text-gray-600 mb-1 text-sm">Investor Share (%)</label> <input type="number" v-model.number="fundingForm.investorShare" class="w-full px-3 py-2 border rounded text-sm" min="1" max="80" required placeholder="Percentage of profit for investors"> </div> </div>
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded w-full" :disabled="(!fundingForm.cid && fundingForm.projectType === 'agricultural') || !isUserAuthenticated || role !== 'farmer'"> <i class="fas fa-paper-plane mr-1"></i> Create Funding Request </button>
             <div v-if="!isUserAuthenticated" class="text-red-500 mt-3 text-sm text-center">Log in to create funding requests.</div>
            <div v-if="isUserAuthenticated && role !== 'farmer'" class="text-red-500 mt-3 text-sm text-center">Switch to a Farmer account to create funding requests.</div>
            </form>
            <div v-if="createdFundingRequest" class="bg-green-100 text-green-700 px-4 py-2 mt-4 rounded font-medium text-sm"> <i class="fas fa-check mr-1"></i> Funding request created and is now visible to investors! </div>
            <div class="mt-8">
            <h3 class="font-semibold mb-2 text-gray-700">Your Active Funding Requests</h3>
            <div v-if="farmerFundingRequests.length===0" class="text-gray-600 text-sm bg-gray-50 p-4 rounded text-center">You have no active funding requests.</div>
            <div v-else class="space-y-4">
                <div v-for="req in farmerFundingRequests" :key="req.id" class="border rounded-lg overflow-hidden shadow-sm bg-white">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 bg-gray-50 border-b">
                    <div class="flex items-center">
                        <i :class="getProjectIconClass(req.projectType)" class="mr-2 text-lg"></i>
                        <h4 class="font-bold mb-2 sm:mb-0">{{ req.title }}</h4>
                    </div>
                    <div class="flex items-center space-x-2"> <span :class="{'bg-yellow-100 text-yellow-800': req.status === 'pending', 'bg-green-100 text-green-800': req.status === 'funded', 'bg-blue-100 text-blue-800': req.status === 'partially_funded'}" class="px-2 py-1 rounded text-xs font-medium"> {{ req.status === 'pending' ? 'Pending' : req.status === 'funded' ? 'Fully Funded' : (req.status === 'partially_funded' ? 'Partially Funded' : req.status) }} </span> </div> </div>
                <div class="p-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 text-sm">
                        <div> <div class="text-xs text-gray-500">{{ getFundingProjectPrimaryFieldLabel(req.projectType) }}</div> <div>{{ getFundingProjectPrimaryFieldValue(req) }}</div> </div>
                        <div> <div class="text-xs text-gray-500">{{ getFundingProjectSecondaryFieldLabel(req.projectType) }}</div> <div>{{ getFundingProjectSecondaryFieldValue(req) }}</div> </div>
                        <div> <div class="text-xs text-gray-500">Required</div> <div>{{ req.amount }} SOL</div> </div> <div> <div class="text-xs text-gray-500">Investor Share</div> <div>{{ req.investorShare }}%</div> </div> </div>
                    <div class="mb-4"> <div class="text-xs text-gray-500 mb-1">Funding Progress</div> <div class="progress-bar"> <div class="progress-fill bg-green-500" :style="{width: fundingProgressPercent(req) + '%'}"></div> </div> <div class="flex justify-between text-xs mt-1"> <span>{{ req.fundedAmount || 0 }} SOL raised</span> <span>{{ fundingProgressPercent(req) }}% Complete</span> </div> </div>
                    <div v-if="req.fundedAmount > 0 && req.investors && req.investors.length > 0" class="mb-4"> <div class="text-xs text-gray-500 mb-2">Investors ({{req.investors.length}})</div> <div class="text-sm max-h-24 overflow-y-auto border rounded p-2 bg-gray-50 space-y-1"> <div v-for="investor in req.investors" :key="investor.investorId || investor.id" class="flex justify-between items-center py-1 text-xs"> <span><i class="fas fa-user text-gray-400 mr-1"></i>{{ investor.investorId ? (investor.investorId.substring(0,6) + '...') : 'Investor' }}</span> <span class="font-mono bg-blue-100 text-blue-800 px-1 rounded">{{ investor.amount }} SOL</span> </div> </div> </div>
                    <div class="flex justify-end mt-4"> <button v-if="req.status !== 'funded'" class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200" @click="cancelFundingRequest_V1(req.id)"> <i class="fas fa-times mr-1"></i>Cancel Request </button> <span v-if="req.status === 'funded'" class="text-xs text-green-600"><i class="fas fa-check-circle mr-1"></i>Fully Funded!</span> </div>
                </div>
                </div>
            </div>
            </div>
        </div>
    </section>
    <!-- Buyer AgriSell Section -->
    <section v-if="current==='buyerAgriSell' && !isOrangeIdCallback" class="max-w-6xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-3"><i class="fas fa-shopping-basket mr-2"></i>AgriSell: Marketplace</h2>
      <div class="bg-white rounded shadow-md p-6 mb-7">
        <div class="flex flex-col md:flex-row md:items-end gap-5">
          <div class="w-full md:w-48"> <label class="text-gray-600 text-sm">Crop Type</label> <select v-model="buyerFilters.crop" class="w-full px-2 py-1 border rounded bg-white text-sm"> <option value="">All</option> <option v-for="c in uniqueCrops" :key="c">{{c}}</option> </select> </div>
          <div class="flex-1"> <label class="text-gray-600 text-sm">Location</label> <input v-model="buyerFilters.location" class="w-full px-2 py-1 border rounded text-sm" placeholder="Search by location..."> </div>
          <div class="flex-1"> <label class="text-gray-600 text-sm">Pesticide Co.</label> <input v-model="buyerFilters.pesticideCompany" class="w-full px-2 py-1 border rounded text-sm" placeholder="Search by pesticide company..."> </div>
          <button type="button" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-1 rounded text-sm mt-2 md:mt-0" @click="resetBuyerFilters"> <i class="fas fa-undo mr-1"></i> Reset Filters </button>
        </div>
      </div>
      <div v-if="filteredListings.length === 0" class="text-gray-600 bg-gray-50 p-8 text-center rounded"> <i class="fas fa-search text-4xl text-gray-400 mb-3"></i><br> No listings found matching your criteria. Try adjusting your filters. </div>
      <div v-else class="grid gap-8 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
        <div v-for="l in filteredListings" :key="l.id" class="bg-white rounded shadow p-4 flex flex-col relative">
            <div v-if="l.isNew" class="new-badge">NEW</div>
          <div class="mb-3 flex justify-center"> <video :src="ipfsUrl(l.cid)" controls playsinline webkit-playsinline class="rounded w-full max-h-52 bg-black object-cover"></video> </div>
          <div class="mb-1 font-bold text-lg">{{ l.crop }}</div>
          <div class="text-xs text-gray-500 mb-1">Location: <span class="font-mono">{{ l.location }}</span></div>
          <div class="text-xs text-gray-500 mb-1">Pesticide: <span class="font-mono">{{ l.pesticide }}</span></div>
          <div class="text-xs text-gray-500 mb-2">Pesticide Co.: <span class="font-mono">{{ l.pesticideCompany || 'N/A' }}</span></div>
          <div class="text-sm my-2">Price Range: <br><span class="font-mono text-base font-semibold">{{ l.minPrice }}</span> - <span class="font-mono text-base font-semibold">{{ l.maxPrice }}</span> SOL</div>
          <div class="flex items-center text-xs text-gray-600 mb-2"> <span class="mr-1">Sold by: {{ getSellerDisplayIdentifier(l.farmerWallet) }}</span> <button @click="showFarmerProfile(l.farmerWallet)" class="text-blue-500 hover:text-blue-700 focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> </div>
          <button class="mt-auto bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded text-sm" @click="buyListing(l)" :disabled="!isUserAuthenticated || role !== 'buyer' || currentUserIdentifier === l.farmerWallet"> <i class="fas fa-shopping-cart mr-1"></i> {{ currentUserIdentifier === l.farmerWallet ? 'Your Listing' : (isUserAuthenticated && role === 'buyer' ? 'Initiate Purchase' : 'Login as Buyer to Purchase') }} </button>
          <button @click="startOrGoToConversation(l.farmerWallet)" v-if="isUserAuthenticated && currentUserIdentifier !== l.farmerWallet" class="mt-2 text-xs text-blue-600 hover:text-blue-700 border border-blue-400 rounded-full px-3 py-1 hover:bg-blue-50 flex items-center justify-center"> <i class="fas fa-envelope mr-1"></i> Message Seller </button>
        </div>
      </div>
    </section>
    <!-- Investor Projects Section -->
    <section v-if="current==='investorProjects' && !isOrangeIdCallback" class="max-w-6xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-3"><i class="fas fa-project-diagram mr-2"></i>Investment Opportunities</h2>
      <div class="bg-white rounded shadow-md p-6 mb-7">
        <div class="flex flex-col md:flex-row md:items-end gap-5">
          <div class="w-full md:w-48"> <label class="text-gray-600 text-sm">Project Type</label> <select v-model="investorFilters.projectType" class="w-full px-2 py-1 border rounded bg-white text-sm"> <option value="">All Types</option> <option value="agricultural">Agricultural</option> <option value="solar">Solar</option> <option value="wind">Wind</option> <option value="hydro">Hydro</option> <option value="biomass">Biomass</option> <option value="smart_irrigation">Smart Irrigation</option><option value="smart_greenhouse">Smart Greenhouse</option></select> </div>
          <div class="w-full md:w-48" v-if="investorFilters.projectType === 'agricultural' || !investorFilters.projectType"> <label class="text-gray-600 text-sm">Crop Type</label> <select v-model="investorFilters.crop" class="w-full px-2 py-1 border rounded bg-white text-sm"> <option value="">All Crops</option> <option v-for="c in uniqueFundingCrops" :key="c">{{c}}</option> </select> </div>
          <div class="w-full md:w-48" v-if="investorFilters.projectType === 'agricultural' || !investorFilters.projectType"> <label class="text-gray-600 text-sm">Growing Method</label> <select v-model="investorFilters.method" class="w-full px-2 py-1 border rounded bg-white text-sm"> <option value="">All Methods</option> <option value="organic">Organic</option> <option value="conventional">Conventional</option> <option value="hydroponic">Hydroponic</option> <option value="aquaponic">Aquaponic</option> <option value="regenerative">Regenerative</option> </select> </div>
          <div class="w-full md:w-48"> <label class="text-gray-600 text-sm">Min ROI (%)</label> <input type="number" v-model.number="investorFilters.minRoi" class="w-full px-2 py-1 border rounded text-sm" placeholder="e.g., 10"> </div>
          <div class="w-full md:w-48"> <label class="text-gray-600 text-sm">Max Funding Needed (SOL)</label> <input type="number" v-model.number="investorFilters.maxAmount" class="w-full px-2 py-1 border rounded text-sm" placeholder="e.g., 100"> </div>
          <button type="button" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-1 rounded text-sm mt-2 md:mt-0" @click="resetInvestorFilters"> <i class="fas fa-undo mr-1"></i> Reset Filters </button>
        </div>
      </div>
      <div class="grid gap-6 grid-cols-1 lg:grid-cols-2">
        <div v-for="project in filteredFundingRequests" :key="project.id" class="bg-white rounded-lg shadow overflow-hidden relative">
          <div v-if="project.isNew" class="new-badge">NEW</div>
           <div class="p-5 bg-gray-50 border-b flex flex-col sm:flex-row justify-between sm:items-center">
            <div class="flex items-center mb-2 sm:mb-0">
                <i :class="getProjectIconClass(project.projectType)" class="mr-2 text-xl"></i>
                <h3 class="font-bold text-lg text-green-800">{{ project.title }}</h3>
            </div>
            <span :class="{'bg-yellow-100 text-yellow-800': project.status === 'pending', 'bg-green-100 text-green-800': project.status === 'funded', 'bg-blue-100 text-blue-800': project.status === 'partially_funded'}" class="px-2 py-1 rounded text-xs font-medium self-start sm:self-center"> {{ project.status === 'pending' ? 'Seeking Funding' : project.status === 'funded' ? 'Fully Funded' : 'Partially Funded' }} </span>
          </div>
          <div class="p-5">
            <div class="flex flex-col md:flex-row gap-6">
              <div class="md:w-1/3">
                 <video v-if="project.cid" :src="ipfsUrl(project.cid)" controls playsinline webkit-playsinline class="rounded w-full h-40 object-cover bg-black mb-3"></video>
                 <div v-else-if="project.projectType === 'solar' || project.projectType === 'wind' || project.projectType === 'hydro' || project.projectType === 'biomass'" class="rounded w-full h-40 bg-yellow-100 flex items-center justify-center mb-3">
                    <i :class="getProjectIconClass(project.projectType)" class="text-yellow-500 text-5xl"></i>
                 </div>
                 <div v-else class="rounded w-full h-40 bg-gray-100 flex items-center justify-center mb-3">
                    <i class="fas fa-image text-gray-400 text-4xl"></i> (No Video)
                 </div>
                <div class="grid grid-cols-2 gap-2 text-sm"> <div> <div class="text-xs text-gray-500">Farmer</div> <div class="font-medium truncate flex items-center"> <span>{{ getFarmerDisplayIdentifier(project.farmerWallet) }}</span> <button @click="showFarmerProfile(project.farmerWallet)" class="ml-2 text-blue-500 hover:text-blue-700 text-xs focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> </div> </div>
                <div v-if="project.projectType === 'agricultural'"> <div class="text-xs text-gray-500">Land Size</div> <div class="font-medium">{{ project.acres }} acres</div> </div>
                <div v-if="project.projectType === 'solar' || project.projectType === 'wind' || project.projectType === 'hydro' || project.projectType === 'biomass'"> <div class="text-xs text-gray-500">Capacity</div> <div class="font-medium">{{ project.energyCapacityKW }} kW</div> </div>
                <div> <div class="text-xs text-gray-500">Timeline</div> <div class="font-medium">{{ project.timeline }} {{ project.projectType === 'agricultural' ? 'months' : 'years' }}</div> </div> <div> <div class="text-xs text-gray-500">Expected ROI</div> <div class="font-medium text-green-700">{{ project.roi }}%</div> </div> </div>
                <button @click="startOrGoToConversation(project.farmerWallet)" v-if="isUserAuthenticated && currentUserIdentifier !== project.farmerWallet" class="mt-3 w-full text-xs text-blue-600 hover:text-blue-700 border border-blue-400 rounded-full px-3 py-1 hover:bg-blue-50 flex items-center justify-center"> <i class="fas fa-envelope mr-1"></i> Message Farmer </button>
              </div>
              <div class="md:w-2/3">
                <div class="mb-4"> <div class="text-sm font-medium mb-1">{{ getFundingProjectPrimaryDisplay(project) }}</div> <p class="text-sm text-gray-700 max-h-20 overflow-y-auto">{{ project.description }}</p> </div>
                <div class="mb-4"> <div class="text-xs text-gray-500 mb-1">Funding Progress</div> <div class="progress-bar"> <div class="progress-fill bg-green-500" :style="{width: fundingProgressPercent(project) + '%'}"></div> </div> <div class="flex justify-between text-xs mt-1"> <span>{{ project.fundedAmount || 0 }} / {{ project.amount }} SOL</span> <span>{{ fundingProgressPercent(project) }}% Complete</span> </div> </div>
                <div v-if="project.updates && project.updates.length > 0" class="mb-4"> <h4 class="text-sm font-semibold text-gray-700 mb-2">Recent Farmer Updates</h4> <div class="project-updates-list text-xs" style="max-height: 70px;"> <div v-for="update in project.updates.slice().reverse().slice(0,2)" :key="update.id" class="project-update-item"> <span class="font-medium text-gray-500">{{ update.date }}:</span> {{ update.text }} </div> </div> </div>
                <div class="mb-4"> <div class="flex justify-between items-center mb-2"> <div class="text-sm font-medium">Investment Terms</div> <div class="text-xs text-gray-500">Investor Share: {{ project.investorShare }}% of profit</div> </div> <div class="p-3 bg-yellow-50 rounded text-sm border border-yellow-200"> <p>Invest to receive {{ project.investorShare }}% of the profits, proportional to your investment. Expected return is {{ project.roi }}% over {{ project.timeline }} {{ project.projectType === 'agricultural' ? 'months' : 'years (sim. payback)' }}.</p> </div> </div>
                <div class="flex flex-col sm:flex-row justify-between items-center mt-4 pt-4 border-t"> <div class="mb-3 sm:mb-0"> <label :for="'investment-amount-'+project.id" class="text-xs text-gray-500 block mb-1">Your Investment (SOL)</label> <input v-model.number="investmentAmounts[project.id]" type="number" :id="'investment-amount-'+project.id" class="px-3 py-1 border rounded w-full sm:w-32 text-sm" min="0.1" :max="maxInvestmentAmount(project)" step="0.1" :disabled="project.status === 'funded' || !isUserAuthenticated || role !== 'investor'" :placeholder="maxInvestmentAmount(project) > 0 ? `Max ${maxInvestmentAmount(project)}` : 'Funded'"> </div> <button @click="investInProject(project)" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm w-full sm:w-auto" :disabled="project.status === 'funded' || !isUserAuthenticated || role !== 'investor' || !investmentAmounts[project.id] || investmentAmounts[project.id] <= 0 || investmentAmounts[project.id] > maxInvestmentAmount(project)"> <i class="fas fa-coins mr-1"></i> {{ project.status === 'funded' ? 'Fully Funded' : (!isUserAuthenticated || role !== 'investor' ? 'Login as Investor' : 'Invest Now') }} </button> </div>
                <div v-if="investmentErrors[project.id]" class="text-red-500 text-xs mt-2">{{ investmentErrors[project.id] }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div v-if="filteredFundingRequests.length === 0" class="bg-gray-50 p-8 text-center rounded-lg mt-4"> <i class="fas fa-seedling text-gray-300 text-4xl mb-3"></i> <h3 class="text-gray-600 text-lg mb-2">No Projects Found</h3> <p class="text-gray-500">Try adjusting your filters or check back later for new investment opportunities.</p> </div>
    </section>
    <!-- Investor Portfolio Section -->
    <section v-if="current==='investorPortfolio' && !isOrangeIdCallback" class="max-w-6xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-chart-pie mr-2"></i>Investment Portfolio</h2>
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Portfolio Overview</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6"> <div class="mb-4 md:mb-0"> <div class="text-xs text-gray-500">Total Invested</div> <div class="text-2xl font-bold text-green-700">{{ totalInvestedAmount }} SOL</div> </div> <div> <div class="text-xs text-gray-500">Active Projects</div> <div class="text-xl font-bold">{{ investorActiveProjects }}</div> </div> <div> <div class="text-xs text-gray-500">Completed</div> <div class="text-xl font-bold">{{ investorCompletedProjects }}</div> </div> <div> <div class="text-xs text-gray-500">Avg. ROI</div> <div class="text-xl font-bold text-green-700">{{ investorAvgRoi }}%</div> </div> </div>
        </div>
        <div class="bg-white rounded-lg shadow overflow-hidden mb-8">
            <div class="px-6 py-4 bg-gray-50 border-b"> <h3 class="text-lg font-semibold text-gray-800">Your Active Investments</h3> </div>
            <div v-if="investorInvestments.length === 0" class="p-8 text-center"> <i class="fas fa-chart-line text-gray-300 text-4xl mb-3"></i> <h4 class="text-gray-600 text-lg mb-2">No Active Investments</h4> <p class="text-gray-500 mb-4">You haven't invested in any agricultural projects yet.</p> <button @click="switchPage('investorProjects')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm"> <i class="fas fa-search mr-1"></i>Browse Projects </button> </div>
            <div v-else class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50"> <tr> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Farmer</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invested (SOL)</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expected Return (SOL)</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th> </tr> </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                <tr v-for="investment in investorInvestments" :key="investment.id">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900 flex items-center">
                            <i :class="getProjectIconClass(investment.projectType)" class="mr-2"></i>
                            {{ investment.projectTitle }}
                        </div>
                        <div class="text-xs text-gray-500 ml-5">{{ getInvestmentPortfolioSubDisplay(investment) }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm text-gray-900">{{ getFarmerDisplayIdentifier(investment.farmerWallet, 10) }}</div> <button @click="showFarmerProfile(investment.farmerWallet)" class="text-blue-500 hover:text-blue-700 text-xs focus:outline-none mr-2" title="View Farmer Info"> <i class="fas fa-info-circle mr-1"></i>View Info </button> <button @click="startOrGoToConversation(investment.farmerWallet)" v-if="isUserAuthenticated && currentUserIdentifier !== investment.farmerWallet" class="text-green-600 hover:text-green-700 text-xs focus:outline-none" title="Message Farmer"> <i class="fas fa-envelope mr-1"></i>Message </button> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-mono text-gray-900">{{ investment.amount }}</div> <div class="text-xs text-gray-500">{{ investment.investmentDate }}</div> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="w-24 bg-gray-200 rounded-full h-2.5"> <div class="bg-green-600 h-2.5 rounded-full" :style="{width: investment.progress+'%'}"></div> </div> <div class="text-xs text-gray-500 mt-1">{{ investment.progress }}% Complete</div> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm text-gray-900 font-mono">{{ calculateExpectedReturn(investment) }}</div> <div class="text-xs text-gray-500">{{ investment.roi }}% ROI</div> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <span :class="{ 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true, 'bg-blue-100 text-blue-800': investment.status === 'active', 'bg-green-100 text-green-800': investment.status === 'harvested' || investment.status === 'completed', 'bg-yellow-100 text-yellow-800': investment.status === 'growing' || investment.status === 'generating' }"> {{ investment.status.charAt(0).toUpperCase() + investment.status.slice(1) }} </span> </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600"> <a href="#" @click.prevent="viewInvestmentDetails(investment)" class="hover:underline">View</a> </td>
                </tr>
                </tbody>
            </table>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 bg-gray-50 border-b flex justify-between items-center"> <h3 class="text-lg font-semibold text-gray-800">Platform Transaction History (Simulated)</h3> <span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded-full flex items-center"> <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 16 15"><path d="m7.81 0-1.78 3.69L1.88 4.2l2.92 2.52L4.04 10 7.8 7.97 11.55 10l-.77-3.28 2.92 2.52-4.15-.51L7.82 0h-.01Zm0 15-1.78-3.69-4.15-.51 2.92-2.52L4.04 5 7.8 7.03 11.55 5l-.77 3.28 2.92 2.52-4.15-.51L7.82 15h-.01Z"></path></svg> PestiVid Platform (Simulated Ledger) </span> </div>
            <div v-if="investorTransactions.length === 0" class="p-8 text-center"> <i class="fas fa-cubes text-gray-300 text-4xl mb-3"></i> <h4 class="text-gray-600 text-lg mb-2">No Transactions Yet</h4> <p class="text-gray-500">Your investment and payout transactions on the platform will appear here.</p> </div>
            <div v-else class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50"> <tr> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Transaction ID</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount (SOL)</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th> </tr> </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                <tr v-for="tx in investorTransactions" :key="tx.id">
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="flex items-center"> <div class="text-sm font-mono text-gray-900 truncate max-w-[150px] sm:max-w-[250px]" :title="tx.txHash">{{ tx.txHash.substring(0,10) }}...{{ tx.txHash.substring(tx.txHash.length-10) }}</div> <a :href="solanaExplorerUrl(tx.txHash)" target="_blank" class="ml-1 text-blue-500 hover:text-blue-700" title="View on Solana Explorer (Demo Link)"> <i class="fas fa-external-link-alt text-xs"></i> </a> </div> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <span :class="{ 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true, 'bg-green-100 text-green-800': tx.type === 'investment', 'bg-blue-100 text-blue-800': tx.type === 'payout', 'bg-yellow-100 text-yellow-800': tx.type === 'energy_trade' }"> {{ tx.type === 'investment' ? 'Investment' : (tx.type === 'payout' ? getPayoutTypeDisplay(tx.projectType) : (tx.type === 'energy_trade' ? 'Energy Trade' : tx.type)) }} </span> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-mono text-gray-900">{{ tx.amount }}</div> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800"> Confirmed (Sim.) </span> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm text-gray-900">{{ tx.date }}</div> </td>
                </tr>
                </tbody>
            </table>
            </div>
        </div>
    </section>
    <!-- User Profile Section -->
    <section v-if="current==='userProfile' && !isOrangeIdCallback" class="max-w-6xl mx-auto mt-6">
        <div v-if="!isUserAuthenticated" class="text-center p-10 bg-white rounded-lg shadow"> <i class="fas fa-exclamation-circle text-3xl text-yellow-500 mb-4"></i> <p class="text-xl text-gray-700">Please log in to view your profile.</p> </div>
      <div v-else class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="bg-gradient-to-r from-green-700 to-green-500 p-6 text-white">
          <div class="flex flex-col md:flex-row justify-between items-center">
            <div class="flex items-center mb-4 md:mb-0">
              <div class="bg-white rounded-full w-16 h-16 flex items-center justify-center mr-4 text-green-600 shadow overflow-hidden">
                <img v-if="loginMethod === 'orangeId' && orangeIdUser && orangeIdUser.picture" :src="orangeIdUser.picture" alt="Avatar" class="w-full h-full object-cover"/>
                <i v-else :class="role === 'farmer' ? 'fas fa-tractor' : (role === 'buyer' ? 'fas fa-shopping-cart' : 'fas fa-chart-line')" class="text-3xl"></i>
              </div>
              <div> <h2 class="text-2xl font-bold">{{ userName || displayedUserIdentifier }}</h2> <p class="text-green-100 capitalize"> {{ role === 'farmer' ? 'Agricultural Producer' : role === 'buyer' ? 'Crop Buyer' : 'Agricultural Investor' }} </p> </div>
            </div>
            <div class="bg-white bg-opacity-20 rounded-lg px-4 py-2 flex items-center text-sm"> <i class="fas fa-certificate mr-2"></i> <span>{{ role === 'farmer' ? 'Verified Farmer' : role === 'buyer' ? 'Verified Buyer' : 'Verified Investor' }} (PestiVid Status)</span> </div>
          </div>
        </div>
        <div class="p-6">
          <div class="mb-8">
            <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-id-card mr-2"></i>Account Information </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
              <div>
                <div class="mb-4"> <p class="text-gray-600">Full Name (PestiVid)</p> <p class="font-medium">{{ userName || 'Not Provided in PestiVid Profile' }}</p> </div>
                <div class="mb-4"> <p class="text-gray-600">PestiVid User Identifier ({{ loginMethod === 'orangeId' ? 'Orange ID' : 'Solana Wallet' }})</p> <p class="font-medium font-mono break-all">{{ currentUserIdentifier }}</p> </div>
                <div v-if="loginMethod === 'orangeId' && orangeIdUser && orangeIdUser.ethAddress" class="mb-4"> <p class="text-gray-600">ETH Address (from Orange ID, if available)</p> <p class="font-medium font-mono break-all">{{ orangeIdUser.ethAddress }}</p> </div>
                <div> <p class="text-gray-600">PestiVid Account Type</p> <p class="font-medium capitalize">{{ role || "Not Set" }}</p> </div>
              </div>
              <div>
                <div class="mb-4"> <p class="text-gray-600">Email (PestiVid)</p> <p class="font-medium">{{ userEmail || 'Not Provided in PestiVid Profile' }}</p> </div>
                <div v-if="loginMethod === 'orangeId' && orangeIdUser && orangeIdUser.email && orangeIdUser.email !== userEmail" class="mb-4"> <p class="text-gray-600">Authenticated Email (Orange ID)</p> <p class="font-medium">{{ orangeIdUser.email }}</p> </div>
                <div class="mb-4"> <p class="text-gray-600">Phone (PestiVid)</p> <p class="font-medium">{{ userPhone || 'Not Provided' }}</p> </div>
                <div> <p class="text-gray-600">PestiVid Member Since</p> <p class="font-medium">{{ memberSince || 'N/A' }}</p> </div>
              </div>
            </div>
          </div>

          <div v-if="role === 'farmer'">
                <div class="mb-8"> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-solar-panel text-yellow-500 mr-2"></i><i class="fas fa-wind text-blue-400 mr-1"></i>AgriSolar Summary </h3> <div class="grid grid-cols-1 md:grid-cols-4 gap-4"> <div class="bg-yellow-50 p-3 rounded-lg text-center"> <div class="text-sm text-yellow-700">Total Renewable Capacity</div> <div class="text-lg font-bold text-yellow-800">{{ farmerTotalRenewableCapacityKW.toFixed(1) }} kW</div> </div> <div class="bg-blue-50 p-3 rounded-lg text-center"> <div class="text-sm text-blue-700">kWh Produced (Solar)</div> <div class="text-lg font-bold text-blue-800">{{ farmerTotalKwhProduced.toFixed(0) }} kWh</div> </div> <div class="bg-green-50 p-3 rounded-lg text-center"> <div class="text-sm text-green-700">kWh Used Farm (Solar)</div> <div class="text-lg font-bold text-green-800">{{ farmerTotalKwhUsedOnFarm.toFixed(0) }} kWh</div> </div> <div class="bg-teal-50 p-3 rounded-lg text-center"> <div class="text-sm text-teal-700">CO Offset (Solar)</div> <div class="text-lg font-bold text-teal-800">{{ farmerTotalCarbonOffsetKg.toFixed(0) }} kg</div> </div> </div> <div class="mt-3 text-right"> <button @click="switchPage('farmerAgriSolar')" class="text-green-700 text-sm hover:underline">Go to AgriSolar Module <i class="fas fa-arrow-right ml-1"></i></button> </div> </div>
                 <div class="mb-8"> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-leaf text-orange-500 mr-2"></i>Agrovoltaics Setups ({{ farmerAgrovoltaicsSetups.length }}) </h3> <div v-if="farmerAgrovoltaicsSetups.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center"> <i class="fas fa-tractor text-gray-400 text-2xl mb-2"></i> <p>You haven't registered any agrovoltaic setups.</p> <button @click="switchAgriSolarTab('agrovoltaics'); switchPage('farmerAgriSolar');" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Register a setup</button> </div> <div v-else class="space-y-4"> <div v-for="setup in farmerAgrovoltaicsSetups" :key="setup.id" class="bg-orange-50 rounded-lg p-4 shadow-sm border border-orange-200 text-sm"> <h4 class="font-bold">{{ setup.setupName }}</h4> <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2"> <div> <div class="text-xs text-gray-500">Area</div> <div class="font-medium">{{ setup.areaSize }} {{ setup.areaUnit || 'Acres' }}</div> </div> <div> <div class="text-xs text-gray-500">Crop</div> <div class="font-medium">{{ setup.cropType }}</div> </div> <div> <div class="text-xs text-gray-500">Solar Asset</div> <div class="font-medium">{{ getAssetName(setup.solarAssetId) }}</div> </div> <div> <div class="text-xs text-gray-500">Video Evidence</div> <div class="font-medium">{{ setup.videoCid ? setup.videoCid.substring(0,10) + '...' : 'N/A' }} <a v-if="setup.videoCid" :href="ipfsUrl(setup.videoCid)" target="_blank" class="text-blue-600 hover:underline ml-1"><i class="fas fa-external-link-alt text-xs"></i></a></div> </div> </div> </div> </div> </div>
                <div class="mb-8"> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-award mr-2"></i>Simulated Certifications ({{ farmerCertifications.length }}) </h3> <div v-if="farmerCertifications.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center"> <i class="fas fa-certificate text-gray-400 text-2xl mb-2"></i> <p>You have no simulated certifications.</p> <button @click="switchAgriSolarTab('reportsCerts'); switchPage('farmerAgriSolar');" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Request a certificate</button> </div> <div v-else class="space-y-4"> <div v-for="cert in farmerCertifications" :key="cert.id" class="bg-green-50 rounded-lg p-4 shadow-sm border border-green-200 text-sm"> <div class="font-bold text-green-700">{{ cert.type }}</div> <div class="text-xs text-gray-600">Issued: {{ cert.issueDate }}</div> <div class="text-xs text-gray-500 mt-2">Sim. Tx: <span class="font-mono">{{ cert.simulatedBlockchainRecord.substring(0, 10) }}...</span></div> </div> </div> </div>
                <div class="mb-8"> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-video mr-2"></i>Your Uploaded Videos ({{ farmerVideos.length }}) </h3> <div v-if="farmerVideos.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center"> <i class="fas fa-film text-gray-400 text-2xl mb-2"></i> <p>You haven't uploaded any videos yet.</p> <button @click="switchPage('farmerPestiVid')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Upload your first video</button> </div> <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"> <div v-for="vid in farmerVideos" :key="vid.cid" class="bg-gray-50 rounded-lg p-4 shadow-sm"> <video :src="ipfsUrl(vid.cid)" controls playsinline webkit-playsinline class="w-full h-40 object-cover bg-black rounded mb-3"></video> <h4 class="font-bold">{{ vid.crop }}</h4> <div class="text-xs mb-1" :class="{ 'text-blue-700': vid.purpose === 'sell', 'text-purple-700': vid.purpose === 'funding', 'text-gray-600': vid.purpose === 'agristream' || !vid.purpose, 'text-orange-600': vid.purpose === 'agrovoltaics' }"> Purpose: <span class="font-semibold"> {{ vid.purpose === 'sell' ? 'Sale' : (vid.purpose === 'funding' ? 'Funding' : (vid.purpose === 'agristream' ? 'General' : (vid.purpose === 'agrovoltaics' ? 'Agrovoltaics' : 'N/A'))) }} </span> </div> <div class="text-sm mb-1">Location: {{ vid.location }}</div> <div class="text-sm mb-1">Pesticide: {{ vid.pesticide }}</div> <div class="text-sm mb-2">Pesticide Co.: {{ vid.pesticideCompany || 'N/A' }}</div> <div class="flex justify-between items-center mt-2 text-xs text-gray-500"> <span class="font-mono truncate" :title="vid.cid">CID: {{ vid.cid.substring(0, 10) }}...</span> <a :href="ipfsUrl(vid.cid)" target="_blank" class="text-blue-600 hover:underline">View</a> </div> <div class="text-xs text-gray-400 mt-1">File Hash: <span class="font-mono break-all" :title="vid.videoFileHash || 'N/A'">{{ vid.videoFileHash ? vid.videoFileHash.substring(0,10) + '...' : 'N/A' }}</span></div> </div> </div> </div>
                <div class="mb-8"> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-tags mr-2"></i>Your Active Listings ({{ farmerListings.length }}) </h3> <div v-if="farmerListings.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center"> <i class="fas fa-store text-gray-400 text-2xl mb-2"></i> <p>You don't have any active listings.</p> <button @click="switchPage('farmerSell')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Create your first listing</button> </div> <div v-else> <div class="overflow-x-auto"> <table class="min-w-full border divide-y divide-gray-200"> <thead class="bg-gray-50"> <tr> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Crop</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pesticide Co.</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price Range (SOL)</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th> </tr> </thead> <tbody class="bg-white divide-y divide-gray-200"> <tr v-for="listing in farmerListings" :key="listing.id"> <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-medium text-gray-900">{{ listing.crop }}</div> <div class="text-xs text-gray-500" :title="listing.cid">CID: {{ listing.cid.substring(0, 8) }}...</div> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ listing.location }} </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ listing.pesticideCompany || 'N/A' }} </td> <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm text-gray-900 font-mono">{{ listing.minPrice }} - {{ listing.maxPrice }}</div> </td> <td class="px-6 py-4 whitespace-nowrap"> <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800"> Active </span> </td> </tr> </tbody> </table> </div> </div> </div>
                <div> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-hand-holding-usd mr-2"></i>Your Funding Requests ({{ farmerFundingRequests.length }}) </h3> <div v-if="farmerFundingRequests.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center"> <i class="fas fa-money-bill-wave text-gray-400 text-2xl mb-2"></i> <p>You haven't created any funding requests yet.</p> <button @click="switchPage('farmerFunding')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Request funding for your farm</button> </div> <div v-else class="space-y-4"> <div v-for="req in farmerFundingRequests" :key="req.id" class="border rounded-lg overflow-hidden bg-white shadow-sm"> <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 bg-green-50 border-b"> <h4 class="font-bold mb-1 sm:mb-0 flex items-center"><i :class="getProjectIconClass(req.projectType)" class="mr-2"></i>{{ req.title }}</h4> <span :class="{'bg-yellow-100 text-yellow-800': req.status === 'pending', 'bg-green-100 text-green-800': req.status === 'funded', 'bg-blue-100 text-blue-800': req.status === 'partially_funded'}" class="px-2 py-1 rounded text-xs font-medium"> {{ req.status === 'pending' ? 'Pending' : req.status === 'funded' ? 'Fully Funded' : (req.status === 'partially_funded' ? 'Partially Funded' : req.status) }} </span> </div> <div class="p-4 text-sm"> <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4"> <div> <div class="text-xs text-gray-500">{{ getFundingProjectPrimaryFieldLabel(req.projectType) }}</div> <div>{{ getFundingProjectPrimaryFieldValue(req) }}</div> </div> <div> <div class="text-xs text-gray-500">{{ getFundingProjectSecondaryFieldLabel(req.projectType) }}</div> <div>{{ getFundingProjectSecondaryFieldValue(req) }}</div> </div> <div> <div class="text-xs text-gray-500">Required</div> <div class="font-mono">{{ req.amount }} SOL</div> </div> <div> <div class="text-xs text-gray-500">Raised</div> <div class="font-mono">{{ req.fundedAmount || 0 }} SOL</div> </div> </div> <div class="mb-4"> <div class="text-xs text-gray-500 mb-1">Funding Progress</div> <div class="progress-bar"> <div class="progress-fill bg-green-500" :style="{width: fundingProgressPercent(req) + '%'}"></div> </div> <div class="text-xs mt-1">{{ fundingProgressPercent(req) }}% Complete</div> </div> <div class="flex justify-end mt-4"> <button v-if="req.status !== 'funded'" class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200" @click="cancelFundingRequest_V1(req.id)"> <i class="fas fa-times mr-1"></i>Cancel Request </button> <span v-if="req.status === 'funded'" class="text-xs text-green-600"><i class="fas fa-check-circle mr-1"></i>Fully Funded!</span> </div> </div> </div> </div> </div>
            </div>
           <div v-if="role === 'buyer'"> <div> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-shopping-basket mr-2"></i>Your Purchase History ({{ buyerPurchases.length }}) </h3> <div v-if="buyerPurchases.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center"> <i class="fas fa-shopping-cart text-gray-400 text-2xl mb-2"></i> <p>You haven't made any purchases yet.</p> <button @click="switchPage('buyerAgriSell')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Browse marketplace</button> </div> <div v-else> <div class="overflow-x-auto"> <table class="min-w-full border divide-y divide-gray-200"> <thead class="bg-gray-50"> <tr> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Crop</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pesticide Co.</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price Paid (SOL)</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Purchase Date</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Seller</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Video/Tx</th> </tr> </thead> <tbody class="bg-white divide-y divide-gray-200"> <tr v-for="purchase in buyerPurchases" :key="purchase.id"> <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-medium text-gray-900">{{ purchase.crop }}</div> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ purchase.location }} </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ purchase.pesticideCompany || 'N/A' }} </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono"> {{ purchase.price }} </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ purchase.date }} </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ getSellerDisplayIdentifier(purchase.farmerWallet, 10) }} <button @click="showFarmerProfile(purchase.farmerWallet)" class="ml-1 text-blue-500 hover:text-blue-700 text-xs focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> <button @click="startOrGoToConversation(purchase.farmerWallet)" v-if="isUserAuthenticated && currentUserIdentifier !== purchase.farmerWallet" class="ml-1 text-green-600 hover:text-green-700 text-xs focus:outline-none" title="Message Seller"> <i class="fas fa-envelope"></i> </button> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600"> <a href="#" @click.prevent="viewPurchaseVideo(purchase)" class="hover:underline mr-2">Video</a> <a :href="solanaExplorerUrl(purchase.txHash)" target="_blank" class="hover:underline" title="View Transaction (Demo Link)">Tx</a> </td> </tr> </tbody> </table> </div> </div> </div>
           <div v-if="role === 'investor'"> <div class="mb-8"> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-chart-pie mr-2"></i>Investment Portfolio Summary </h3> <div v-if="investorInvestments.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center"> <i class="fas fa-coins text-gray-400 text-2xl mb-2"></i> <p>You haven't made any investments yet.</p> <button @click="switchPage('investorProjects')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Browse investment opportunities</button> </div> <div v-else> <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6"> <div class="bg-gray-50 p-4 rounded-lg"> <div class="text-sm text-gray-500">Total Invested</div> <div class="text-xl font-bold text-green-700">{{ totalInvestedAmount }} SOL</div> </div> <div class="bg-gray-50 p-4 rounded-lg"> <div class="text-sm text-gray-500">Projects</div> <div class="text-xl font-bold">{{ investorInvestments.length }}</div> </div> <div class="bg-gray-50 p-4 rounded-lg"> <div class="text-sm text-gray-500">Avg. ROI</div> <div class="text-xl font-bold text-green-700">{{ investorAvgRoi }}%</div> </div> <div class="bg-gray-50 p-4 rounded-lg"> <div class="text-sm text-gray-500">Completed</div> <div class="text-xl font-bold">{{ investorCompletedProjects }}</div> </div> </div> <div class="overflow-x-auto mt-4"> <h4 class="text-lg font-semibold text-gray-800 mb-3">Your Investments</h4> <table class="min-w-full border divide-y divide-gray-200"> <thead class="bg-gray-50"> <tr> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Farmer</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount (SOL)</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th> </tr> </thead> <tbody class="bg-white divide-y divide-gray-200"> <tr v-for="inv in investorInvestments" :key="inv.id"> <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-medium text-gray-900 flex items-center"><i :class="getProjectIconClass(inv.projectType)" class="mr-2"></i>{{ inv.projectTitle }}</div> <div class="text-xs text-gray-500 ml-5">{{ getInvestmentPortfolioSubDisplay(inv) }}</div> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ getFarmerDisplayIdentifier(inv.farmerWallet, 10) }} <button @click="showFarmerProfile(inv.farmerWallet)" class="ml-1 text-blue-500 hover:text-blue-700 text-xs focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> <button @click="startOrGoToConversation(inv.farmerWallet)" v-if="isUserAuthenticated && currentUserIdentifier !== inv.farmerWallet" class="ml-1 text-green-600 hover:text-green-700 text-xs focus:outline-none" title="Message Farmer"> <i class="fas fa-envelope"></i> </button> </td> <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-mono text-gray-900">{{ inv.amount }}</div> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ inv.investmentDate }} </td> <td class="px-6 py-4 whitespace-nowrap"> <span :class="{'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true, 'bg-blue-100 text-blue-800': inv.status === 'active', 'bg-green-100 text-green-800': inv.status === 'harvested' || inv.status === 'completed', 'bg-yellow-100 text-yellow-800': inv.status === 'growing' || inv.status === 'generating'}"> {{ inv.status.charAt(0).toUpperCase() + inv.status.slice(1) }} </span> </td>
                                 <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 capitalize"> {{ inv.projectType | projectTypeDisplay }} </td>
                                 <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600"> <a href="#" @click.prevent="viewInvestmentDetails(inv)" class="hover:underline">View</a> </td>
                             </tr>
                         </tbody> </table> </div> <div class="mt-4 text-right"> <button @click="switchPage('investorPortfolio')" class="text-green-700 text-sm hover:underline">Go to Full Portfolio <i class="fas fa-arrow-right ml-1"></i></button> </div> </div> </div> <div> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-link mr-2"></i>Platform Verification (Simulated) </h3> <div class="bg-gray-50 p-5 rounded-lg border"> <div class="flex items-center mb-4"> <i class="fas fa-shield-alt text-green-600 text-2xl mr-3"></i> <div> <h4 class="font-bold text-gray-800">PestiVid Platform Records</h4> <p class="text-sm text-gray-600">All your investment transactions are recorded on the PestiVid platform (Simulated Ledger).</p> </div> </div> <div v-if="investorTransactions.length > 0" class="mt-4"> <h5 class="font-medium text-sm mb-2">Recent Transactions</h5> <div class="space-y-2"> <div v-for="tx in investorTransactions.slice(0, 3)" :key="tx.id" class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-2 bg-white rounded border text-sm"> <div class="flex items-center mb-1 sm:mb-0"> <span :class="{'px-2 py-0.5 text-xs rounded-full mr-2': true, 'bg-green-100 text-green-800': tx.type === 'investment', 'bg-blue-100 text-blue-800': tx.type === 'payout', 'bg-yellow-100 text-yellow-800': tx.type === 'energy_trade'}"> {{ tx.type === 'investment' ? 'Invest' : (tx.type === 'payout' ? getPayoutTypeDisplay(tx.projectType) : (tx.type === 'energy_trade' ? 'Energy Trade' : tx.type)) }} </span> <span class="font-mono text-xs text-gray-500 truncate" :title="tx.txHash">{{ tx.txHash.substring(0, 8) }}...{{ tx.txHash.substring(tx.txHash.length - 8) }}</span> <a :href="solanaExplorerUrl(tx.txHash)" target="_blank" class="text-blue-600 hover:underline whitespace-nowrap"> <i class="fas fa-external-link-alt"></i> View (Demo Link) </a> </div> <div class="text-right w-full sm:w-auto"> <div class="font-mono text-sm">{{ tx.amount }} SOL</div> <div class="text-xs text-gray-500">{{ tx.date }}</div> </div> </div> </div> <div class="mt-3 text-right"> <button @click="switchPage('investorPortfolio')" class="text-green-700 text-sm hover:underline">View all transactions <i class="fas fa-arrow-right ml-1"></i></button> </div> </div> <div v-else class="bg-white p-4 rounded border text-center text-sm text-gray-600"> <p>No platform transactions recorded yet.</p> </div> </div> </div> </div>
        </div>
      </div>
    </section>
    <!-- Messaging Section -->
    <section v-if="current==='messaging' && !isOrangeIdCallback" class="max-w-6xl mx-auto mt-6">
        <div v-if="!isUserAuthenticated" class="text-center p-10 bg-white rounded-lg shadow"> <i class="fas fa-exclamation-circle text-3xl text-yellow-500 mb-4"></i> <p class="text-xl text-gray-700">Please log in to access messaging.</p> </div>
      <div v-else class="bg-white rounded-lg shadow-md flex" style="height: calc(100vh - 200px);">
        <div class="w-full md:w-1/3 border-r flex flex-col bg-gray-50">
            <div class="p-4 border-b"> <h2 class="text-xl font-semibold text-green-700">Conversations</h2> </div>
            <div class="overflow-y-auto flex-1">
                <div v-if="userConversations.length === 0" class="p-4 text-center text-gray-500 mt-10"> <i class="fas fa-comment-slash fa-3x mb-3 text-gray-300"></i> <p>No conversations yet.</p> <p class="text-xs mt-1">Start a chat from a user's profile or project.</p> </div>
                <div v-for="conv in userConversations" :key="conv.id" @click="selectConversation(conv.id)" class="p-3 hover:bg-gray-100 cursor-pointer border-b flex items-center space-x-3" :class="{'bg-green-100 border-l-4 border-green-500': activeConversationId === conv.id, 'bg-white': activeConversationId !== conv.id}">
                    <div class="w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center text-lg flex-shrink-0"> {{ getOtherParticipantInitial(conv) }} </div>
                    <div class="flex-1 overflow-hidden"> <div class="font-semibold text-gray-800 truncate">{{ getOtherParticipantDisplayAddress(conv) }}</div> <div class="text-xs text-gray-500 truncate">{{ conv.lastMessageSnippet }}</div> </div>
                    <div class="text-xs text-gray-400 self-start whitespace-nowrap">{{ formatTimestamp(conv.lastMessageTimestamp, true) }}</div>
                    <div v-if="getUnreadCountForConversation(conv.id) > 0" class="bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs ml-auto flex-shrink-0"> {{ getUnreadCountForConversation(conv.id) }} </div>
                </div>
            </div>
        </div>
        <div class="w-full md:w-2/3 flex flex-col bg-white">
            <div v-if="!activeConversationId" class="flex-1 flex flex-col items-center justify-center text-gray-400 p-10 text-center"> <i class="fas fa-comments fa-4x mb-4"></i> <h3 class="text-xl text-gray-600">Welcome to PestiVid Chat</h3> <p>Select a conversation from the left to view messages, or start a new chat from a user's profile or project page.</p> </div>
            <template v-else>
                <div class="p-4 border-b bg-gray-50 flex items-center sticky top-0 z-10"> <div class="w-8 h-8 rounded-full bg-green-600 text-white flex items-center justify-center text-sm mr-3 flex-shrink-0"> {{ activeConversationPartnerInitial ? activeConversationPartnerInitial : '?' }} </div> <h3 class="font-semibold text-lg text-green-800">{{ activeConversationPartnerDisplayAddress }}</h3> </div>
                <div class="flex-1 overflow-y-auto p-4 space-y-3 message-view-container bg-gray-100" ref="messageContainer">
                    <div v-if="currentMessages.length === 0" class="text-center text-gray-500 py-10"> No messages in this conversation yet. Say hello! </div>
                    <div v-for="msg in currentMessages" :key="msg.id + '-message'" class="flex" :class="msg.sender === currentUserIdentifier ? 'justify-end' : 'justify-start'">
                        <div class="max-w-xs md:max-w-md lg:max-w-lg"> <div class="p-3 rounded-xl shadow" :class="msg.sender === currentUserIdentifier ? 'bg-green-600 text-white' : 'bg-white text-gray-800 border'"> <p class="text-sm leading-relaxed">{{ msg.text }}</p> </div> <p class="text-xs mt-1 px-1" :class="msg.sender === currentUserIdentifier ? 'text-gray-400 text-right' : 'text-gray-400 text-left'"> {{ formatTimestamp(msg.timestamp) }} <span v-if="msg.sender === currentUserIdentifier && msg.read"><i class="fas fa-check-double text-blue-400 ml-1" title="Read"></i></span> <span v-if="msg.sender === currentUserIdentifier && !msg.read"><i class="fas fa-check text-gray-400 ml-1" title="Sent"></i></span> </p> </div>
                    </div>
                </div>
                <div class="p-3 border-t bg-gray-50"> <form @submit.prevent="sendMessage" class="flex gap-3 items-center"> <input v-model="messageInputText" type="text" placeholder="Type your message..." class="flex-1 px-4 py-2 border border-gray-300 rounded-full focus:ring-green-500 focus:border-green-500 text-sm" required> <button type="submit" :disabled="!messageInputText.trim()" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-full text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 disabled:opacity-50"> <i class="fas fa-paper-plane mr-1"></i> Send </button> </form> </div>
            </template>
        </div>
      </div>
    </section>
    <!-- Plant Recommendation Section -->
    <section v-if="current==='plantRecommendation' && !isOrangeIdCallback" class="max-w-3xl mx-auto mt-6">
      <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-leaf mr-2"></i>Plant Disease Detection & Recommendation</h2>
      <div class="bg-white rounded shadow-md p-6 space-y-6">
        <p class="text-sm text-gray-600">Upload an image of an affected plant. it will attempt to identify the plant, detect diseases, and suggest treatments.</p>
        <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4" role="alert">
          <p class="font-bold">Developer Note:</p>
          <p class="text-sm">we are take the image now we will be recomend the plant treatments we will take all the data from the farmers we will be automatical the treatments will be updata in the for every 40000 sameple we will be get accurs result </p>
        </div>
        <div>
          <label class="block text-gray-600 mb-1 text-sm">Upload Plant Image</label>
          <input type="file" @change="handlePlantImageUpload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
        </div>
        <div v-if="plantImageUrl" class="mt-4">
          <h4 class="text-md font-semibold text-gray-700 mb-2">Image Preview:</h4>
          <img :src="plantImageUrl" alt="Plant Preview" class="max-w-xs md:max-w-sm rounded-md border shadow mx-auto">
        </div>
        <button @click="analyzePlant" :disabled="!plantImageFile || analysisInProgress" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded text-sm flex items-center justify-center" :class="{'opacity-50 cursor-not-allowed': !plantImageFile || analysisInProgress}">
          <i :class="analysisInProgress ? 'fas fa-spinner fa-spin' : 'fas fa-search-plus'" class="mr-2"></i>
          {{ analysisInProgress ? 'Analyzing...' : 'Analyze Plant with trained model' }}
        </button>
        <div v-if="analysisErrorText" class="mt-4 bg-red-100 border border-red-300 text-red-700 px-4 py-3 rounded text-sm">
          <p class="font-bold">Analysis Error:</p>
          <p>{{ analysisErrorText }}</p>
        </div>
        <div v-if="parsedAnalysis.plantName && !analysisInProgress && !analysisErrorText" class="mt-6 border-t pt-6 space-y-4">
          <h3 class="text-xl font-semibold text-green-700">Analysis Results:</h3>
          <div>
            <p class="text-sm font-medium text-gray-500">Identified Plant:</p>
            <p class="text-lg text-gray-800">{{ parsedAnalysis.plantName || 'Could not identify plant.' }}</p>
          </div>
          <div>
            <p class="text-sm font-medium text-gray-500">Detected Disease:</p>
            <p class="text-lg text-gray-800 font-semibold" :class="{'text-red-600': parsedAnalysis.diseaseName && parsedAnalysis.diseaseName.toLowerCase() !== 'healthy' && parsedAnalysis.diseaseName.toLowerCase() !== 'not apparent' && parsedAnalysis.diseaseName.toLowerCase() !== 'unknown', 'text-green-600': parsedAnalysis.diseaseName && (parsedAnalysis.diseaseName.toLowerCase() === 'healthy' || parsedAnalysis.diseaseName.toLowerCase() === 'not apparent')}">
              {{ parsedAnalysis.diseaseName || 'Could not determine disease.' }}
            </p>
          </div>
          <div>
            <p class="text-sm font-medium text-gray-500">Recommended Treatment / Pesticides:</p>
            <p class="text-md text-gray-700 whitespace-pre-wrap">{{ parsedAnalysis.treatmentRecommended || 'No specific treatment recommended.' }}</p>
          </div>
           <div v-if="analysisResultText && (!parsedAnalysis.plantName || parsedAnalysis.plantName === 'Unknown' || parsedAnalysis.plantName === '-')" class="mt-4 bg-gray-50 p-3 rounded border text-xs">
                <p class="font-semibold mb-1">Output (for debugging if parsing failed):</p>
                <pre class="whitespace-pre-wrap overflow-x-auto">{{ analysisResultText }}</pre>
            </div>
        </div>
      </div>
    </section>


    <!-- Modals (Purchase Video, Buy Listing, Investment Details, Farmer Profile, Energy Purchase) -->
    <div v-if="selectedPurchase && showPurchaseVideo && !isOrangeIdCallback" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full modal-scrollable">
        <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white z-10"> <h3 class="font-bold text-lg text-green-700">{{ selectedPurchase.crop }} - Purchase Verification</h3> <button @click="showPurchaseVideo = false" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times"></i> </button> </div>
        <div class="p-4">
            <video :src="ipfsUrl(selectedPurchase.cid)" controls playsinline webkit-playsinline class="w-full rounded bg-black mb-4"></video>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div> <p class="text-gray-600">Location</p> <p class="font-medium">{{ selectedPurchase.location }}</p> </div>
                <div> <p class="text-gray-600">Pesticide Used</p> <p class="font-medium">{{ selectedPurchase.pesticide }}</p> </div>
                <div> <p class="text-gray-600">Pesticide Company</p> <p class="font-medium">{{ selectedPurchase.pesticideCompany || 'N/A' }}</p> </div>
                <div> <p class="text-gray-600">Purchase Price</p> <p class="font-medium font-mono">{{ selectedPurchase.price }} SOL</p> </div>
                <div> <p class="text-gray-600">Purchase Date</p> <p class="font-medium">{{ selectedPurchase.date }}</p> </div>
                <div> <p class="text-gray-600">Seller Identifier</p> <p class="font-medium font-mono text-xs">{{ selectedPurchase.farmerWallet }}</p> </div>
                <div>
                    <p class="text-gray-600">Video File Hash (SHA256)</p>
                    <p class="font-medium font-mono text-xs break-all" :title="selectedPurchase.videoFileHash || 'N/A'">{{ selectedPurchase.videoFileHash || 'N/A' }}</p>
                </div>
            </div>
            <div class="mt-4 bg-gray-100 p-3 rounded text-xs border">
                <p class="font-bold mb-1">Platform Verification (Simulated):</p>
                <p class="font-mono break-all mb-1">IPFS CID: {{ selectedPurchase.cid }}</p>
                <p class="font-mono break-all">Simulated Tx: {{ selectedPurchase.txHash }} <a :href="solanaExplorerUrl(selectedPurchase.txHash)" target="_blank" class="text-blue-500 hover:text-blue-700"><i class="fas fa-external-link-alt text-xs"></i></a> </p>
                <p class="mt-1 text-gray-500">Video evidence on IPFS, linked on PestiVid platform (Simulated).</p>
                <a :href="ipfsUrl(selectedPurchase.cid)" target="_blank" class="text-blue-600 hover:underline mt-1 inline-block">View on IPFS Gateway <i class="fas fa-external-link-alt text-xs ml-1"></i></a>
            </div>
        </div>
        <div class="bg-gray-50 p-4 flex justify-end rounded-b-lg sticky bottom-0 border-t"> <button @click="showPurchaseVideo = false" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded text-sm"> Close </button> </div>
      </div>
    </div>
    <div v-if="showBuyModal && selectedListing && !isOrangeIdCallback" class="fixed inset-0 z-50 bg-black bg-opacity-60 flex justify-center items-center p-4">
      <div class="bg-white rounded shadow-lg w-full max-w-sm p-6 relative mx-2 modal-scrollable">
        <button class="absolute top-2 right-2 text-gray-400 hover:text-red-500" @click="closeBuyModal"><i class="fas fa-times"></i></button>
        <h3 class="font-bold text-green-700 text-lg mb-3">Purchase Crop Batch</h3>
        <video :src="ipfsUrl(selectedListing.cid)" controls playsinline webkit-playsinline class="rounded w-full mb-3 bg-black"></video>
        <div class="mb-1 font-bold">{{ selectedListing.crop }}</div>
        <div class="text-xs text-gray-600 mb-1">Location: <span class="font-mono">{{ selectedListing.location }}</span></div>
        <div class="text-xs text-gray-500 mb-1">Pesticide: <span class="font-mono">{{ selectedListing.pesticide }}</span></div>
        <div class="text-xs text-gray-500 mb-2">Pesticide Co.: <span class="font-mono">{{ selectedListing.pesticideCompany || 'N/A' }}</span></div>
        <div class="text-xs text-gray-400 mb-2">File Hash: <span class="font-mono break-all" :title="selectedListing.videoFileHash || 'N/A'">{{ selectedListing.videoFileHash ? selectedListing.videoFileHash.substring(0,10) + '...' : 'N/A' }}</span></div>
        <div class="text-sm my-2">Price Range: <br><span class="mx-1 font-mono font-semibold">{{ selectedListing.minPrice }}</span> - <span class="ml-1 font-mono font-semibold">{{ selectedListing.maxPrice }}</span> SOL</div>
        <form @submit.prevent="processPurchase"> <label class="text-sm block text-gray-600 mb-1">Your Offer (SOL)</label> <input type="number" v-model.number="purchaseAmount" :min="selectedListing.minPrice" :max="selectedListing.maxPrice" step="0.01" required :placeholder="`Enter amount (${selectedListing.minPrice}-${selectedListing.maxPrice})`" class="w-full px-3 py-2 border rounded mb-3 text-sm"> <button type="submit" class="bg-green-600 hover:bg-green-700 text-white w-full py-2 rounded text-sm" :disabled="!isUserAuthenticated || role !== 'buyer'"> <i class="fas fa-check mr-1"></i>Confirm Purchase (Simulated) </button> </form>
        <div v-if="purchaseStatus" class="text-green-700 font-semibold mt-3 text-sm bg-green-50 p-2 rounded border border-green-200">{{purchaseStatus}}</div> <div v-if="purchaseError" class="text-red-600 font-semibold mt-3 text-sm bg-red-50 p-2 rounded border border-red-200">{{purchaseError}}</div>
      </div>
    </div>
     <div v-if="showEnergyBuyModal && selectedEnergyListing && !isOrangeIdCallback" class="fixed inset-0 z-50 bg-black bg-opacity-60 flex justify-center items-center p-4">
      <div class="bg-white rounded shadow-lg w-full max-w-sm p-6 relative mx-2 modal-scrollable">
        <button class="absolute top-2 right-2 text-gray-400 hover:text-red-500" @click="closeEnergyBuyModal"><i class="fas fa-times"></i></button>
        <h3 class="font-bold text-blue-700 text-lg mb-3">Purchase Energy from Marketplace</h3>
        <div class="mb-3 flex justify-center items-center bg-blue-100 rounded p-3 text-blue-700"> <i class="fas fa-bolt fa-2x mr-3"></i> <div> <div class="font-bold">{{ getAssetName(selectedEnergyListing.solarAssetId) }} Energy</div> <div class="text-sm">Listed by {{ getFarmerDisplayIdentifier(selectedEnergyListing.farmerWallet) }}</div> </div> </div>
        <div class="text-sm mb-2">Available: <span class="mx-1 font-mono font-semibold text-blue-800">{{ selectedEnergyListing.kwhAvailable.toFixed(2) }} kWh</span> </div>
        <div class="text-sm mb-4">Price: <span class="mx-1 font-mono font-semibold text-blue-800">{{ selectedEnergyListing.pricePerKwhSOL.toFixed(4) }} SOL/kWh</span> </div>
        <form @submit.prevent="processEnergyPurchase"> <label class="text-sm block text-gray-600 mb-1">Amount to Buy (kWh)</label> <input type="number" v-model.number="energyPurchaseAmountKwh" min="0.01" :max="selectedEnergyListing.kwhAvailable" step="0.01" required :placeholder="`Max ${selectedEnergyListing.kwhAvailable.toFixed(2)} kWh`" class="w-full px-3 py-2 border rounded mb-3 text-sm"> <div class="text-sm text-gray-700 mb-3">Total Price: <span class="font-mono font-semibold">{{ (energyPurchaseAmountKwh * selectedEnergyListing.pricePerKwhSOL || 0).toFixed(4) }} SOL</span></div> <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white w-full py-2 rounded text-sm" :disabled="!isUserAuthenticated || energyPurchaseAmountKwh <= 0 || energyPurchaseAmountKwh > selectedEnergyListing.kwhAvailable"> <i class="fas fa-check mr-1"></i>Confirm Purchase (Simulated) </button> </form>
        <div v-if="energyPurchaseStatus" class="text-green-700 font-semibold mt-3 text-sm bg-green-50 p-2 rounded border border-green-200">{{energyPurchaseStatus}}</div> <div v-if="energyPurchaseError" class="text-red-600 font-semibold mt-3 text-sm bg-red-50 p-2 rounded border border-red-200">{{energyPurchaseError}}</div>
      </div>
    </div>
    <div v-if="showInvestmentDetailsModal && selectedInvestment && !isOrangeIdCallback" class="fixed inset-0 z-50 bg-black bg-opacity-70 flex justify-center items-center p-4">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl relative mx-2 modal-scrollable">
        <div class="p-4 bg-green-50 border-b flex justify-between items-center sticky top-0 z-10"> <h3 class="font-bold text-lg text-green-800 flex items-center"><i :class="getProjectIconClass(selectedInvestment.projectType)" class="mr-2"></i>{{ selectedInvestment.projectTitle }}</h3> <button class="text-gray-400 hover:text-red-500" @click="showInvestmentDetailsModal=false"><i class="fas fa-times"></i></button> </div>
        <div class="p-6"> <div class="flex flex-col md:flex-row gap-6"> <div class="md:w-1/3">
            <video v-if="selectedInvestment.cid" :src="ipfsUrl(selectedInvestment.cid)" controls playsinline webkit-playsinline class="rounded w-full h-40 object-cover bg-black mb-3"></video>
            <div v-else-if="selectedInvestment.projectType.includes('solar') || selectedInvestment.projectType.includes('wind') || selectedInvestment.projectType.includes('hydro') || selectedInvestment.projectType.includes('biomass')" class="rounded w-full h-40 bg-yellow-100 flex items-center justify-center mb-3"><i :class="getProjectIconClass(selectedInvestment.projectType)" class="text-yellow-500 text-5xl"></i></div>
            <div v-else class="rounded w-full h-40 bg-gray-100 flex items-center justify-center mb-3"><i class="fas fa-image text-gray-400 text-4xl"></i> (No Video)</div>
        <div class="mt-3 space-y-2 text-sm"> <div> <div class="text-xs text-gray-500">Farmer Identifier</div> <div class="font-medium flex items-center font-mono text-xs"> <span>{{ selectedInvestment.farmerWallet }}</span> <button @click="showFarmerProfile(selectedInvestment.farmerWallet); showInvestmentDetailsModal=false;" class="ml-2 text-blue-500 hover:text-blue-700 text-xs focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> <button @click="startOrGoToConversation(selectedInvestment.farmerWallet); showInvestmentDetailsModal=false;" v-if="isUserAuthenticated && currentUserIdentifier !== selectedInvestment.farmerWallet" class="ml-2 text-green-600 hover:text-green-700 text-xs focus:outline-none" title="Message Farmer"> <i class="fas fa-envelope"></i> </button> </div> </div> <div> <div class="text-xs text-gray-500">Investment Date</div> <div class="font-medium">{{ selectedInvestment.investmentDate }}</div> </div> <div> <div class="text-xs text-gray-500">Amount Invested</div> <div class="font-medium text-green-700 font-mono">{{ selectedInvestment.amount }} SOL</div> </div> <div> <div class="text-xs text-gray-500">Status</div> <span :class="{'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true, 'bg-blue-100 text-blue-800': selectedInvestment.status === 'active', 'bg-green-100 text-green-800': selectedInvestment.status === 'harvested' || selectedInvestment.status === 'completed', 'bg-yellow-100 text-yellow-800': selectedInvestment.status === 'growing' || selectedInvestment.status === 'generating'}"> {{ selectedInvestment.status.charAt(0).toUpperCase() + selectedInvestment.status.slice(1) }} </span> </div> </div> </div> <div class="md:w-2/3"> <div class="mb-4"> <div class="text-sm font-medium mb-1">{{ getFundingProjectPrimaryDisplay(selectedInvestment) }}</div> <p class="text-sm text-gray-700 max-h-24 overflow-y-auto border p-2 rounded bg-gray-50">{{ selectedInvestment.description }}</p> </div> <div class="mb-4"> <div class="text-xs text-gray-500 mb-1">Project Progress</div> <div class="progress-bar"> <div class="progress-fill bg-green-500" :style="{width: selectedInvestment.progress + '%'}"></div> </div> <div class="flex justify-between text-xs mt-1"> <span>{{ selectedInvestment.progress }}% Complete</span> <span>Est. {{ selectedInvestment.timeline }} {{ selectedInvestment.projectType === 'agricultural' ? 'months total' : 'years total' }}</span> </div> </div> <div class="grid grid-cols-2 gap-4 mb-4 text-sm"> <div> <div class="text-xs text-gray-500">Expected Return</div> <div class="font-medium text-green-700 font-mono">{{ calculateExpectedReturn(selectedInvestment) }} SOL</div> </div> <div> <div class="text-xs text-gray-500">ROI</div> <div class="font-medium text-green-700">{{ selectedInvestment.roi }}%</div> </div> <div v-if="selectedInvestment.projectType === 'agricultural'"> <div class="text-xs text-gray-500">Land Size</div> <div class="font-medium">{{ selectedInvestment.acres }} acres</div> </div> <div v-if="selectedInvestment.projectType.includes('solar') || selectedInvestment.projectType.includes('wind') || selectedInvestment.projectType.includes('hydro') || selectedInvestment.projectType.includes('biomass')"> <div class="text-xs text-gray-500">Annual Yield Est.</div> <div class="font-medium">{{ selectedInvestment.expectedAnnualYield || selectedInvestment.expectedAnnualYieldKWh }} {{ (selectedInvestment.projectType === 'biomass' && selectedInvestment.expectedAnnualYield && selectedInvestment.expectedAnnualYield.toLowerCase().includes('biogas')) ? '' : 'kWh' }}</div> </div> <div> <div class="text-xs text-gray-500">Your Share</div> <div class="font-medium">{{ selectedInvestment.investorShare }}%</div> </div> <div v-if="selectedInvestment.cid"> <div class="text-xs text-gray-500">Video File Hash</div> <p class="font-medium font-mono text-xs break-all" :title="selectedInvestment.videoFileHash || 'N/A'">{{ selectedInvestment.videoFileHash ? selectedInvestment.videoFileHash.substring(0,10) + '...' : 'N/A' }}</p> </div> </div> <div v-if="selectedInvestmentProject && selectedInvestmentProject.updates && selectedInvestmentProject.updates.length > 0" class="mb-4"> <h4 class="text-sm font-semibold text-gray-700 mb-2">Farmer Updates</h4> <div class="project-updates-list text-xs"> <div v-for="update in selectedInvestmentProject.updates.slice().reverse()" :key="update.id" class="project-update-item"> <span class="font-medium text-gray-500">{{ update.date }}:</span> {{ update.text }} </div> </div> </div> <div v-else-if="selectedInvestmentProject" class="mb-4 text-xs text-gray-500"> No project updates posted by the farmer yet. </div> <div class="bg-gray-100 p-3 rounded mb-4 border"> <div class="text-sm font-medium mb-1">Platform Transaction (Simulated)</div> <div class="flex items-center text-xs"> <span class="font-mono bg-white px-2 py-1 rounded border mr-2 truncate" :title="selectedInvestment.txHash">{{ selectedInvestment.txHash }}</span> <a :href="solanaExplorerUrl(selectedInvestment.txHash)" target="_blank" class="text-blue-600 hover:underline whitespace-nowrap"> <i class="fas fa-external-link-alt"></i> View (Demo Link) </a> </div> </div> <div v-if="selectedInvestment.status === 'harvested' || selectedInvestment.status === 'completed'" class="bg-green-100 p-3 rounded border border-green-200"> <div class="flex items-center"> <i class="fas fa-check-circle text-green-600 mr-2 text-lg"></i> <div> <div class="font-medium">{{ selectedInvestment.projectType.includes('solar') || selectedInvestment.projectType.includes('wind') || selectedInvestment.projectType.includes('hydro') || selectedInvestment.projectType.includes('biomass') ? 'Energy Generation Completed' : 'Harvest Completed' }} & Payout Processed</div> <div class="text-sm">Your return of {{ calculateExpectedReturn(selectedInvestment) }} SOL has been simulated.</div> </div> </div> </div> <div v-else-if="selectedInvestment.status === 'growing' || selectedInvestment.status === 'generating'" class="bg-yellow-50 p-3 rounded border border-yellow-200"> <div class="flex items-center"> <i class="fas fa-hourglass-half text-yellow-600 mr-2 text-lg"></i> <div> <div class="font-medium">Project {{ selectedInvestment.projectType.includes('solar') || selectedInvestment.projectType.includes('wind') || selectedInvestment.projectType.includes('hydro') || selectedInvestment.projectType.includes('biomass') ? 'Generating Energy' : 'Growing' }}</div> <div class="text-sm">{{ selectedInvestment.projectType.includes('solar') || selectedInvestment.projectType.includes('wind') || selectedInvestment.projectType.includes('hydro') || selectedInvestment.projectType.includes('biomass') ? 'Energy returns expected' : 'Harvest expected' }} within {{ selectedInvestment.timeline }} {{ selectedInvestment.projectType === 'agricultural' ? 'months' : 'years' }}. Progress: {{selectedInvestment.progress}}%.</div> </div> </div> </div> </div> </div> </div>
        <div class="bg-gray-50 p-4 flex justify-end rounded-b-lg sticky bottom-0 border-t"> <button @click="showInvestmentDetailsModal=false" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded text-sm"> Close </button> </div>
      </div>
    </div>
    <div v-if="showFarmerProfileModal && selectedFarmerProfile && !isOrangeIdCallback" class="fixed inset-0 z-50 bg-black bg-opacity-70 flex justify-center items-center p-4">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-lg relative mx-2 modal-scrollable">
        <div class="p-4 bg-green-50 border-b flex justify-between items-center sticky top-0 z-10"> <h3 class="font-bold text-lg text-green-800 flex items-center"> <i class="fas fa-user-tie mr-2"></i> Farmer Profile </h3> <button class="text-gray-400 hover:text-red-500" @click="closeFarmerProfileModal"><i class="fas fa-times"></i></button> </div>
        <div class="p-6 space-y-5"> <div class="flex items-center space-x-4"> <div class="bg-green-100 rounded-full w-16 h-16 flex items-center justify-center text-green-600 text-2xl"> <i class="fas fa-tractor"></i> </div> <div> <p class="text-xs text-gray-500">Farmer Identifier</p> <p class="font-semibold text-lg text-green-700 font-mono">{{ selectedFarmerProfile.walletAddress.substring(0,10) }}...</p> <p class="text-sm text-gray-600">Farm Name (Sim.): {{ selectedFarmerProfile.farmName || 'N/A' }}</p> </div> </div> <div class="border-t pt-4"> <p class="text-xs text-gray-500">Short Bio (Simulated)</p> <p class="text-sm text-gray-700 italic">{{ selectedFarmerProfile.bio || 'This farmer has not provided a bio yet.' }}</p> </div> <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-4"> <div> <p class="text-xs text-gray-500">PestiVid Email</p> <p class="text-sm">{{ selectedFarmerProfile.email }}</p> </div> <div> <p class="text-xs text-gray-500">PestiVid Member Since</p> <p class="text-sm">{{ selectedFarmerProfile.memberSince }}</p> </div> </div>
        <!-- Farmer Solar Stats in Profile Modal -->
        <div class="border-t pt-4">
            <p class="text-sm font-medium text-gray-700 mb-2">Renewable Energy Stats:</p>
            <div class="grid grid-cols-2 gap-3 text-sm">
                <div class="bg-yellow-50 p-2 rounded-md"> <p class="font-semibold">{{ (selectedFarmerProfile.totalRenewableCapacityKW || 0).toFixed(1) }} kW</p> <p class="text-xs text-yellow-700">Total Renewable Capacity</p> </div>
                <div class="bg-teal-50 p-2 rounded-md"> <p class="font-semibold">{{ (selectedFarmerProfile.totalCarbonOffsetKg || 0).toFixed(0) }} kg</p> <p class="text-xs text-teal-700">CO Offset (Lifetime, Solar)</p> </div>
                 <div class="bg-blue-50 p-2 rounded-md"> <p class="font-semibold">{{ selectedFarmerProfile.iotDeviceCount || 0 }}</p> <p class="text-xs text-blue-700">Registered IoT Devices</p> </div>
                <div class="bg-orange-50 p-2 rounded-md"> <p class="font-semibold">{{ selectedFarmerProfile.smartSystemCount || 0 }}</p> <p class="text-xs text-orange-700">Smart Farm Systems</p> </div>
            </div>
        </div>
        <div class="border-t pt-4"> <p class="text-sm font-medium text-gray-700 mb-2">Platform Activity:</p> <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm"> <div class="bg-gray-100 p-3 rounded-md"> <p class="font-semibold">{{ selectedFarmerProfile.fundingRequestCount }}</p> <p class="text-xs text-gray-500">Active Funding Request(s)</p> </div> <div class="bg-gray-100 p-3 rounded-md"> <p class="font-semibold">{{ selectedFarmerProfile.activeListingCount }}</p> <p class="text-xs text-gray-500">Active Marketplace Listing(s)</p> </div> </div> <p class="text-xs text-gray-400 mt-2">(Note: Activity based on currently visible items on the platform.)</p> </div> </div>
        <div class="bg-gray-50 p-4 flex justify-between items-center rounded-b-lg sticky bottom-0 border-t"> <button @click="messageFarmerFromProfile" v-if="isUserAuthenticated && selectedFarmerProfile && currentUserIdentifier !== selectedFarmerProfile.walletAddress" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm"> <i class="fas fa-paper-plane mr-1"></i> Send Message </button> <div v-else class="w-full"></div> <button @click="closeFarmerProfileModal" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded text-sm"> Close </button> </div>
      </div>
    </div>

    <!-- Notification Toast Container -->
    <div class="notification-toast-container">
        <div v-for="n in recentNotifications" :key="n.id" class="notification-toast" :class="{'show': n.show}" :data-notif-id="n.id"> <span :class="['icon', 'icon-' + n.type]"> <i :class="n.type === 'success' ? 'fas fa-check-circle' : (n.type === 'info' ? 'fas fa-info-circle' : (n.type === 'warning' ? 'fas fa-exclamation-triangle' : 'fas fa-bug'))"></i> </span> <span class="message">{{ n.message }}</span> <button @click="dismissNotification(n.id)" class="close-btn">&times;</button> </div>
    </div>
    <!-- Loading/Transaction Modal -->
    <div v-if="showLoadingModal" class="loading-modal"> <div class="loading-content"> <i class="fas fa-spinner fa-spin"></i> <p class="text-gray-700">{{ loadingMessage }}</p> </div> </div>
  </main>

  <footer class="bg-white border-t py-6 mt-auto text-center text-sm text-gray-500">
    <span> {{ new Date().getFullYear() }} PestiVid  Blockchain Agricultural Platform (Web3 Demo with Advanced Renewables)</span>
  </footer>

  <!-- Interactive Avatar Assistant -->
  <div v-if="avatar.visible"
        :class="['fixed z-[9998] p-2 flex flex-col items-end', avatar.position === 'bottom-right' ? 'bottom-4 right-4' : 'bottom-4 left-4']"
        style="transition: all 0.3s ease;">

      <!-- Avatar Interaction Panel (Chat Window) -->
      <div v-show="avatar.expanded"
          class="bg-white w-80 md:w-96 h-96 max-h-[70vh] mb-2 rounded-xl shadow-2xl flex flex-col overflow-hidden border border-gray-200">
          <header class="bg-green-600 text-white p-3 flex items-center justify-between">
              <div class="flex items-center">
                  <img :src="avatar.images[avatar.character]?.[avatar.state] || avatar.images.farmer.idle" alt="Avatar" class="w-8 h-8 rounded-full mr-2 border-2 border-white">
                  <h3 class="font-semibold">PestiVid Helper</h3>
              </div>
              <button @click="toggleAvatarExpansion(false)" class="text-green-100 hover:text-white">
                  <i class="fas fa-times"></i>
              </button>
          </header>

          <!-- Messages Area -->
          <div class="flex-grow p-3 space-y-3 overflow-y-auto" ref="avatarMessagesContainer" style="scroll-behavior: smooth;">
              <div v-for="msg in avatar.chatMessages" :key="msg.id + '-avatar'"
                  :class="['flex', msg.sender === 'user' ? 'justify-end' : 'justify-start']">
                  <div :class="['max-w-[80%] p-2.5 rounded-lg shadow-sm text-sm', msg.sender === 'user' ? 'bg-blue-500 text-white rounded-br-none' : 'bg-gray-100 text-gray-800 rounded-bl-none']"
                      v-html="renderMarkdown(msg.text)">
                  </div>
              </div>
              <div v-if="avatar.isProcessing && avatar.state === 'thinking'" class="flex justify-start">
                    <div class="bg-gray-100 text-gray-800 p-2.5 rounded-lg shadow-sm text-sm rounded-bl-none typing-indicator">
                      <span></span><span></span><span></span>
                    </div>
              </div>
          </div>

          <!-- Quick Actions -->
          <div v-if="avatar.quickActions.length > 0 && !avatar.isProcessing && !avatar.isListening" class="p-2 border-t border-gray-200 flex flex-wrap gap-2 justify-center">
              <button v-for="action in avatar.quickActions" :key="action.id"
                      @click="handleAvatarQuickAction(action)"
                      class="bg-green-100 text-green-700 px-3 py-1.5 text-xs rounded-full hover:bg-green-200 transition-colors">
                  {{ action.label }}
              </button>
          </div>

          <!-- Input Area -->
          <div class="p-3 border-t border-gray-200 bg-gray-50">
              <div class="flex items-center gap-2">
                   <button @click="toggleAvatarListening"
                          :disabled="avatar.isProcessing"
                          title="Toggle Voice Input"
                          class="avatar-input-mic-btn text-gray-500 hover:text-green-600 p-2 rounded-full focus:outline-none"
                          :class="{'text-red-500 listening': avatar.isListening}">
                      <i class="fas fa-microphone text-lg"></i>
                  </button>
                  <input type="text" v-model="avatar.userInput"
                        @keyup.enter="sendAvatarMessage"
                        :placeholder="avatar.isListening ? 'Listening...' : (avatar.isProcessing ? 'Helper is thinking...' : 'Ask PestiVid Helper...')"
                        :disabled="avatar.isProcessing"
                        class="flex-grow px-3 py-2 border border-gray-300 rounded-full text-sm focus:ring-2 focus:ring-green-500 focus:border-green-500">
                  <button @click="sendAvatarMessage" :disabled="avatar.isProcessing || !avatar.userInput.trim()"
                          class="bg-green-600 hover:bg-green-700 text-white rounded-full w-10 h-10 flex items-center justify-center transition-opacity"
                          :class="{'opacity-50 cursor-not-allowed': avatar.isProcessing || !avatar.userInput.trim()}">
                      <i class="fas fa-paper-plane"></i>
                  </button>
              </div>
          </div>
      </div>

      <!-- Floating Avatar Bubble -->
      <button @click="toggleAvatarExpansion()"
              class="w-16 h-16 rounded-full shadow-xl overflow-hidden focus:outline-none ring-4 ring-green-500/30 hover:ring-green-500/50 transition-all duration-300 relative"
              :class="[avatar.expanded ? 'transform scale-90 opacity-70' : 'transform scale-100 opacity-100', 'border-4 border-white']"
              :style="{ borderColor: avatar.expanded ? '#10B981' : 'white' }">
          <img :src="avatar.images[avatar.character]?.[avatar.state] || avatar.images.farmer.idle"
                alt="PestiVid Helper Avatar"
                class="w-full h-full object-cover transition-transform duration-500"
                :class="{'animate-pulse-slow': avatar.state === 'thinking'}">
          <div v-if="!avatar.expanded && unreadAvatarMessagesCount > 0" class="absolute top-[-4px] right-[-4px] bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center ring-2 ring-white">
              {{ unreadAvatarMessagesCount }}
          </div>
      </button>
  </div>

</div>
<script>
const app = new Vue({
    el: "#app",
    data: {
      current: 'landing',
      showMobileMenu: false,
      loginMethod: null, currentUserIdentifier: null, isAuthProcessing: false,
      orangeIdUser: null, orangeIdBedrockSDK: null, orangeIdReactRootLogin: null, orangeIdReactRootCallback: null, orangeIdReactRootSignOut: null, orangeIdReactRootSignOutMobile: null, orangeIdWidgetMounted: false, orangeIdBedrockSDKError: false, isOrangeIdCallback: false,
      bedrockConfig: { baseUrl: 'https://api.bedrockpassport.com', authCallbackUrl: window.location.href.split('?')[0].split('#')[0], tenantId: 'orange-h0zmx5nf44', }, // Replace with your Tenant ID if different
      walletAddress: null,
      role: '', userName: '', userEmail: '', userPhone: '', memberSince: '',
      selectedRoleOnboarding: '', userNameOnboarding: '', userEmailOnboarding: '', userPhoneOnboarding: '',
      recordForm: {crop:'', pesticide:'', location:'', pesticideCompany: '', purpose: 'agristream'}, recordStream: null, recordMediaRecorder: null, recording: false, recordBlob: null, recordBlobUrl: '', showLive: false,
      uploadCid: '', uploading: false, uploadError: '', lastUploadedVideoPurpose: '',
      lastUploadedVideoFileHash: '',
      farmerVideos: [],
      farmerListings: [], listingForm: {cid:'', minPrice:'', maxPrice:'', notifyBuyers: true}, createdListingId: null, listingNotificationSent: false,
      farmerFundingRequests: [],
      fundingForm: {
          projectType: 'agricultural', title: '', crop: '', acres: null,
          energyCapacityKW: null, expectedAnnualYield: null, // For general energy projects
          amount: null, method: '', cid: '', description: '', timeline: null, roi: null, investorShare: null, notifyInvestors: true
      },
      createdFundingRequest: false, newUpdateText: {},
      buyerPurchases: [], selectedPurchase: null, showPurchaseVideo: false,
      allListings: [], buyerFilters: {crop:'', location:'', pesticideCompany: ''}, showBuyModal: false, selectedListing: null, purchaseAmount: null, purchaseStatus: '', purchaseError: '',
      investorInvestments: [], investorTransactions: [], investorFilters: {projectType: '', crop: '', method: '', minRoi: null, maxAmount: null}, allFundingRequests: [], investmentAmounts: {}, investmentErrors: {}, showInvestmentDetailsModal: false, selectedInvestment: null, selectedInvestmentProject: null,
      showFarmerProfileModal: false, selectedFarmerProfile: null,
      pinataJwt: 'YOUR_PINATA_JWT_MUST_BE_REPLACED_HERE', // Replace with your actual Pinata JWT
      pinataGateway: 'gateway.pinata.cloud', // Or your preferred gateway
      conversations: [], messages: [], activeConversationId: null, messageInputText: '',
      notifications: [], recentNotifications: [],
      showLoadingModal: false, loadingMessage: '',
      targetAgriStreamVideoCid: null, highlightedAgriStreamVideoCid: null,
      geminiApiKey: 'YOUR_GEMINI_API_KEY_REPLACE_HERE', // Replace with your actual Gemini API Key
      groqApiKey: "YOUR_GROQ_API_KEY_REPLACE_HERE", // Replace with your Groq API Key
      plantImageFile: null, plantImageUrl: null, plantImageMimeType: null, analysisInProgress: false, analysisResultText: '', parsedAnalysis: { plantName: null, diseaseName: null, treatmentRecommended: null }, analysisErrorText: '',

      // AgriSolar Data
      currentAgriSolarTab: 'dashboard',
      farmerSolarAssets: [], // Legacy solar assets
      solarEnergyProductionLogs: [], // Legacy solar logs
      farmerAgrovoltaicsSetups: [],
      farmerCertifications: [],
      energyMarketListings: [],
      energyTrades: [],
      newSolarAssetForm: { assetName: '', capacityKW: null, installationDate: '', notes: '' }, // Legacy
      newEnergyLogForm: { solarAssetId: '', date: new Date().toISOString().slice(0,10), kwhProduced: null, kwhUsedOnFarm: null, }, // Legacy
      newAgrovoltaicSetupForm: { setupName: '', areaSize: null, cropType: '', solarAssetId: '', videoCid: '', notes: ''},
      newEnergyListingForm: { solarAssetId: '', kwhToSell: null, pricePerKwhSOL: null,},
      agrovoltaicVideoToLink: null,
      requestCertInProgress: false,

      // ADVANCED AGRISOLAR DATA STRUCTURES
      advancedEnergySources: [], // Stores all types of registered energy sources {id, type, name, capacityKW, installationDate, notes, blockchainTx, farmerWallet, ...typeSpecific}
      iotDevices: [], // {id, type ('env_sensor', 'drone', 'robot', 'weather_station'), name, location, status ('active'/'inactive'), lastReading: {value, unit, timestamp}, batteryLevel, farmerWallet, blockchainTx}
      simulatedSmartSystems: { // Simplified placeholder for UI
          irrigation: [],
          greenhouse: []
      },
      newEnergySourceForm: { type: '', name: '', capacityKW: null, installationDate: new Date().toISOString().slice(0,10), notes: '', solarPanelType: '', windTurbineModel: '' },
      newIoTDeviceForm: { type: 'env_sensor', name: '', location: '' },
      energyAnalysisResults: null, // For LER, efficiency etc.
      predictiveOptimizationResults: null, // For AI optimization insights

      carbonFactorKgPerKwh: 0.4,

       // Energy Market Modals
      showEnergyBuyModal: false, selectedEnergyListing: null, energyPurchaseAmountKwh: null, energyPurchaseStatus: '', energyPurchaseError: '',


      // Interactive Avatar Assistant Data
      avatar: {
          visible: true,
          expanded: false,
          state: 'idle', // 'idle', 'talking', 'thinking', 'listening'
          character: 'farmer', // 'farmer', 'scientist', 'robot'
          position: 'bottom-right',
          chatMessages: [], // Separate chat history for the avatar
          userInput: '',
          quickActions: [],
          currentContextText: '', // To store brief context for API
          images: {
              farmer: {
                  idle: 'https://img.icons8.com/plasticine/100/farmer-male.png',
                  talking: 'https://img.icons8.com/plasticine/100/farmer-male.png', // Could use a GIF
                  thinking: 'https://img.icons8.com/plasticine/100/farmer-male.png',
                  listening: 'https://img.icons8.com/plasticine/100/farmer-male.png'
              },
          },
          systemPrompt: "You are PestiVid Helper, a friendly and knowledgeable AI assistant for the PestiVid platform. You are represented by a visual avatar. Your goal is to help users, especially farmers, navigate the platform, understand its features (like PestiVid video uploads, AgriSolar including multi-energy sources, smart systems, IoT, research, AgriStream, Marketplace, Funding, PlantRecommend), and answer their questions. Be encouraging and clear. If asked about a specific page, try to provide relevant tips. When the user opens your chat, if you have context, offer a relevant quick action or greeting. Keep responses concise for a chat interface. If you provide lists, use markdown for bullet points.",
          isProcessing: false,
          isListening: false, // For STT state
      },
      speechRecognition: null, // For STT instance
    },
     filters: {
        capitalize: function (value) {
            if (!value) return ''
            value = value.toString()
            return value.charAt(0).toUpperCase() + value.slice(1)
        },
        projectTypeDisplay: function (value) {
            if (!value) return 'N/A';
            return value.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }
    },
    computed: {
      isUserAuthenticated() { return !!this.currentUserIdentifier && !this.isAuthProcessing && !this.isOrangeIdCallback; },
      displayedUserIdentifier() { if (!this.currentUserIdentifier) return ''; if (this.userName) return this.userName.split(' ')[0]; if (this.loginMethod === 'orangeId' && this.orangeIdUser) { return (this.orangeIdUser.name || this.orangeIdUser.email || this.currentUserIdentifier).split(' ')[0]; } if (this.loginMethod === 'solana' && this.walletAddress) { const id = this.walletAddress.toString(); return `${id.substring(0, 6)}...${id.substring(id.length - 4)}`; } return this.currentUserIdentifier.substring(0,8) + '...'; },
      uniqueCrops() { const crops = this.allListings.map(l=>l.crop).filter(Boolean); return [...new Set(crops)].sort(); },
      filteredListings() { const oneDayAgo = Date.now() - (24*60*60*1000); return this.allListings.map(l => ({...l, isNew: new Date(l.createdAt) > oneDayAgo })).filter(l => { const cropMatch = !this.buyerFilters.crop || (l.crop || '').toLowerCase() === this.buyerFilters.crop.toLowerCase(); const locMatch = !this.buyerFilters.location || (l.location || '').toLowerCase().includes(this.buyerFilters.location.toLowerCase()); const companyMatch = !this.buyerFilters.pesticideCompany || (l.pesticideCompany || '').toLowerCase().includes(this.buyerFilters.pesticideCompany.toLowerCase()); return cropMatch && locMatch && companyMatch; }); },
      availableVideosForListing() { if (!this.isUserAuthenticated) return []; const listedCids = new Set(this.farmerListings.map(l => l.cid)); return this.farmerVideos.filter(v => v.farmerWallet === this.currentUserIdentifier && (v.purpose === 'sell' || v.purpose === 'agristream') && !listedCids.has(v.cid)); },
      availableVideosForFunding() { if (!this.isUserAuthenticated) return []; const fundingCids = new Set(this.farmerFundingRequests.map(r => r.cid)); return this.farmerVideos.filter(v => v.farmerWallet === this.currentUserIdentifier && (v.purpose === 'funding' || v.purpose === 'agristream' || v.purpose === 'agrovoltaics') && !this.farmerFundingRequests.some(req => req.cid === v.cid && req.farmerWallet === this.currentUserIdentifier)); },
      availableVideosForAgrovoltaics() { if (!this.isUserAuthenticated) return []; const agroCids = new Set(this.farmerAgrovoltaicsSetups.map(s => s.videoCid).filter(Boolean)); return this.farmerVideos.filter(v => v.farmerWallet === this.currentUserIdentifier && (v.purpose === 'agrovoltaics' || v.purpose === 'agristream') && !agroCids.has(v.cid)); },
      uniqueFundingCrops() { const crops = this.allFundingRequests.filter(r => r.projectType === 'agricultural').map(r=>r.crop).filter(Boolean); return [...new Set(crops)].sort(); },
      filteredFundingRequests() {
          const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
          return this.allFundingRequests
              .map(r => ({ ...r, isNew: new Date(r.createdAt) > oneDayAgo }))
              .filter(r => {
                  const isRelevantStatus = r.status === 'pending' || r.status === 'partially_funded';
                  const projectTypeMatch = !this.investorFilters.projectType || (r.projectType || 'agricultural').toLowerCase() === this.investorFilters.projectType.toLowerCase();

                  let cropMatch = true;
                  if (this.investorFilters.projectType === 'agricultural' || !this.investorFilters.projectType) {
                     cropMatch = !this.investorFilters.crop || (r.crop || '').toLowerCase() === this.investorFilters.crop.toLowerCase();
                  } else if (this.investorFilters.projectType !== 'agricultural' && this.investorFilters.projectType !== '') {
                     cropMatch = true;
                  }

                  let methodMatch = true;
                  if (this.investorFilters.projectType === 'agricultural' || !this.investorFilters.projectType) {
                     methodMatch = !this.investorFilters.method || (r.method || '').toLowerCase() === this.investorFilters.method.toLowerCase();
                  } else if (this.investorFilters.projectType !== 'agricultural' && this.investorFilters.projectType !== '') {
                     methodMatch = true;
                  }

                  const roiMatch = !this.investorFilters.minRoi || r.roi >= this.investorFilters.minRoi;
                  const amountMatch = !this.investorFilters.maxAmount || r.amount <= this.investorFilters.maxAmount;
                  return isRelevantStatus && projectTypeMatch && cropMatch && methodMatch && roiMatch && amountMatch;
              });
      },
      totalInvestedAmount() { if (!this.investorInvestments || this.investorInvestments.length === 0) return '0.00'; return this.investorInvestments.reduce((sum, inv) => sum + inv.amount, 0).toFixed(2); },
      investorActiveProjects() { if (!this.investorInvestments) return 0; return this.investorInvestments.filter(inv => inv.status === 'active' || inv.status === 'growing' || inv.status === 'generating').length; },
      investorCompletedProjects() { if (!this.investorInvestments) return 0; return this.investorInvestments.filter(inv => inv.status === 'harvested' || inv.status === 'completed').length; },
      investorAvgRoi() { if (!this.investorInvestments || this.investorInvestments.length === 0) return '0.0'; const totalRoi = this.investorInvestments.reduce((sum, inv) => sum + inv.roi, 0); return this.investorInvestments.length > 0 ? (totalRoi / this.investorInvestments.length).toFixed(1) : '0.0'; },
      userConversations() { if (!this.isUserAuthenticated) return []; return this.conversations.filter(conv => conv.participants.includes(this.currentUserIdentifier)).sort((a, b) => new Date(b.lastMessageTimestamp) - new Date(a.lastMessageTimestamp)); },
      currentMessages() { if (!this.activeConversationId || !this.isUserAuthenticated) return []; return this.messages.filter(msg => msg.conversationId === this.activeConversationId).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)); },
      activeConversationPartnerIdentifier() { if (!this.activeConversationId || !this.isUserAuthenticated) return null; const conv = this.conversations.find(c => c.id === this.activeConversationId); if (!conv) return null; return conv.participants.find(p => p !== this.currentUserIdentifier); },
      activeConversationPartnerDisplayAddress() { const partnerId = this.activeConversationPartnerIdentifier; if (!partnerId) return '?'; const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles')) || {}; const partnerProfile = userProfiles[partnerId]; if(partnerProfile && partnerProfile.name) return partnerProfile.name.split(" ")[0]; return `${partnerId.substring(0,6)}...${partnerId.substring(partnerId.length-4)}`; },
      activeConversationPartnerInitial() { const partnerDisplay = this.activeConversationPartnerDisplayAddress; if (!partnerDisplay || partnerDisplay === '?') return '?'; return partnerDisplay.charAt(0).toUpperCase(); },
      unreadMessageCount() { if (!this.isUserAuthenticated) return 0; return this.messages.filter(msg => msg.receiver === this.currentUserIdentifier && !msg.read).length; },
      farmerTotalRenewableCapacityKW() {
          if (!this.isUserAuthenticated || this.role !== 'farmer') return 0;
          const solarCap = this.farmerSolarAssets.filter(asset => asset.farmerWallet === this.currentUserIdentifier).reduce((sum, asset) => sum + (parseFloat(asset.capacityKW) || 0), 0);
          const advancedCap = this.advancedEnergySources.filter(src => src.farmerWallet === this.currentUserIdentifier).reduce((sum, src) => sum + (parseFloat(src.capacityKW) || 0), 0);
          return solarCap + advancedCap; // Sum legacy solar and new multi-energy sources
      },
      farmerTotalKwhProduced() { // Primarily from legacy solar logs for now
          if (!this.isUserAuthenticated || this.role !== 'farmer') return 0;
          return this.solarEnergyProductionLogs
              .filter(log => log.farmerWallet === this.currentUserIdentifier)
              .reduce((sum, log) => sum + (parseFloat(log.kwhProduced) || 0), 0);
      },
      farmerTotalKwhUsedOnFarm() { // Primarily from legacy solar logs
          if (!this.isUserAuthenticated || this.role !== 'farmer') return 0;
          return this.solarEnergyProductionLogs
              .filter(log => log.farmerWallet === this.currentUserIdentifier)
              .reduce((sum, log) => sum + (parseFloat(log.kwhUsedOnFarm) || 0), 0);
      },
      farmerTotalCarbonOffsetKg() { // Primarily from legacy solar logs
          if (!this.isUserAuthenticated || this.role !== 'farmer') return 0;
          return this.solarEnergyProductionLogs
              .filter(log => log.farmerWallet === this.currentUserIdentifier)
              .reduce((sum, log) => sum + (parseFloat(log.carbonOffsetKg) || 0), 0);
      },
       isUsedInAgrovoltaics(cid) {
           return this.farmerAgrovoltaicsSetups.some(setup => setup.videoCid === cid && setup.farmerWallet === this.currentUserIdentifier);
       },
        activeEnergyListings() {
           if (!this.isUserAuthenticated) return [];
            return this.energyMarketListings.filter(listing => listing.status === 'active' && listing.farmerWallet !== this.currentUserIdentifier);
        },
        farmerEnergyListings() {
            if (!this.isUserAuthenticated || this.role !== 'farmer') return [];
            return this.energyMarketListings.filter(listing => listing.farmerWallet === this.currentUserIdentifier).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
        },
      unreadAvatarMessagesCount() {
          if (!this.avatar.expanded && this.avatar.chatMessages) {
              return this.avatar.chatMessages.filter(msg => msg.sender === 'bot' && !msg.readByUser).length;
          }
          return 0;
      },
    },
    watch: {
      current(newPage, oldPage) {
          window.scrollTo(0,0);
          if (newPage === 'farmerAgriStream' && this.targetAgriStreamVideoCid) { this.scrollToAndHighlightAgriStreamVideo(); }
          else if (newPage !== 'farmerAgriStream') { this.highlightedAgriStreamVideoCid = null; }
          if (newPage === 'investorPortfolio' && this.isUserAuthenticated && this.role === 'investor') { this.updateInvestmentProgress(); }
          if (newPage === 'messaging' && this.activeConversationId) { this.scrollToMessageBottom(); this.markConversationAsRead(this.activeConversationId); }
          if (newPage === 'loginChoice' && !this.isOrangeIdCallback && !this.isUserAuthenticated) { this.$nextTick(() => this.renderOrangeIdLoginWidget()); }
          else if (oldPage === 'loginChoice' && newPage !== 'loginChoice') { this.$nextTick(() => this.unmountOrangeIdLoginWidget()); }
          if (oldPage === 'plantRecommendation' && newPage !== 'plantRecommendation') { this.plantImageFile = null; this.plantImageUrl = null; this.plantImageMimeType = null; this.analysisResultText = ''; this.parsedAnalysis = { plantName: null, diseaseName: null, treatmentRecommended: null }; this.analysisErrorText = ''; }
          if (newPage === 'farmerAgriSolar' && this.role==='farmer') {
            if (this.agrovoltaicVideoToLink) {
                this.newAgrovoltaicSetupForm.videoCid = this.agrovoltaicVideoToLink;
                this.addNotification(`Agrovoltaics Video CID ${this.agrovoltaicVideoToLink.substring(0,10)}... loaded. Select Solar Asset and other details to register.`, 'info');
                this.switchAgriSolarTab('agrovoltaics');
                this.agrovoltaicVideoToLink = null;
            }
          }
          if (this.avatar.visible && this.avatar.expanded) {
            this.updateAvatarContextAndQuickActions();
          }
      },
      currentAgriSolarTab(newTab, oldTab) {
           this.newSolarAssetForm = { assetName: '', capacityKW: null, installationDate: '', notes: '' };
           this.newEnergyLogForm = { solarAssetId: '', date: new Date().toISOString().slice(0,10), kwhProduced: null, kwhUsedOnFarm: null, };
           this.newAgrovoltaicSetupForm = { setupName: '', areaSize: null, cropType: '', solarAssetId: '', videoCid: '', notes: ''};
           this.newEnergyListingForm = { solarAssetId: '', kwhToSell: null, pricePerKwhSOL: null,};
           this.newEnergySourceForm = { type: '', name: '', capacityKW: null, installationDate: new Date().toISOString().slice(0,10), notes: '', solarPanelType: '', windTurbineModel: '' };
           this.newIoTDeviceForm = { type: 'env_sensor', name: '', location: '' };
           this.energyAnalysisResults = null;
           this.predictiveOptimizationResults = null;
           this.agrovoltaicVideoToLink = null;
           if (this.current === 'farmerAgriSolar' && this.avatar.visible && this.avatar.expanded) {
              this.updateAvatarContextAndQuickActions();
          }
      },
      isUserAuthenticated(isAuthenticated) { this.$nextTick(() => { if (isAuthenticated && this.loginMethod === 'orangeId') { this.renderOrangeIdSignOutButton('orange-id-signout-button-container'); if (this.showMobileMenu) { this.renderOrangeIdSignOutButton('orange-id-signout-button-container-mobile', true); } } else if (!isAuthenticated) { this.unmountOrangeIdSignOutButton('orange-id-signout-button-button-container'); this.unmountOrangeIdSignOutButton('orange-id-signout-button-container-mobile'); } }); },
      showMobileMenu(isShown) { if (isShown && this.isUserAuthenticated && this.loginMethod === 'orangeId') { this.$nextTick(() => { this.renderOrangeIdSignOutButton('orange-id-signout-button-container-mobile', true); }); } else if (!isShown && this.loginMethod === 'orangeId') { this.unmountOrangeIdSignOutButton('orange-id-signout-button-container-mobile'); } },
      farmerVideos: { handler(newVideos) { if (this.current === 'farmerAgriStream' && this.targetAgriStreamVideoCid) { if (newVideos.some(v => v.cid === this.targetAgriStreamVideoCid)) { this.scrollToAndHighlightAgriStreamVideo(); } } }, deep: true },
      'avatar.chatMessages': {
          handler(newMessages, oldMessages) {
              if (newMessages.length > (oldMessages ? oldMessages.length : 0) ) {
                  const lastMsg = newMessages[newMessages.length - 1];
                  if (lastMsg.sender === 'bot' && this.avatar.expanded && this.avatar.state !== 'talking') {
                      this.avatar.state = 'listening';
                  }
                  this.$nextTick(() => this.scrollToAvatarMessagesBottom());
                  if(lastMsg.sender === 'bot' && !this.avatar.expanded && this.avatar.state !== 'talking') {
                      this.avatar.state = 'idle';
                  }
              }
              const appData = JSON.parse(localStorage.getItem('pestiVidAppData') || '{}');
              appData.avatarChatMessages = this.avatar.chatMessages;
              localStorage.setItem('pestiVidAppData', JSON.stringify(appData));
          },
          deep: true
      },
      'fundingForm.projectType'(newType) {
          const isEnergyOrSmart = ['solar', 'wind', 'hydro', 'biomass', 'smart_irrigation', 'smart_greenhouse'].includes(newType);
          if (isEnergyOrSmart) {
              this.fundingForm.crop = ''; this.fundingForm.acres = null; this.fundingForm.method = '';
              this.fundingForm.cid = ''; // Optional for these types
          } else if (newType === 'agricultural') {
              this.fundingForm.energyCapacityKW = null; this.fundingForm.expectedAnnualYield = null;
          }
      },
      'avatar.isListening'(isListening) {
        if (isListening && 'speechSynthesis' in window && speechSynthesis.speaking) {
            speechSynthesis.cancel();
            this.avatar.state = 'listening';
        }
      }
    },
    methods: {
      switchPage(page) { this.current = page; this.showMobileMenu = false; },
      navigateToPageWithParam(page, paramName, paramValue) { if (page === 'farmerSell' && paramName === 'cid') { this.listingForm.cid = paramValue; } else if (page === 'farmerFunding' && paramName === 'cid') { this.fundingForm.cid = paramValue; } else if (page === 'farmerAgriStream' && paramName === 'highlightCid') { this.targetAgriStreamVideoCid = paramValue; } else if (page === 'farmerAgriSolar' && paramName === 'agroVideoCid') { this.agrovoltaicVideoToLink = paramValue; } this.switchPage(page); },
      getStarted() { if (!this.isUserAuthenticated) { this.switchPage('loginChoice'); } else if (!this.role) { this.switchPage('roleSelection'); } else if (this.role === 'farmer') { this.switchPage('farmerPestiVid'); } else if (this.role === 'buyer') { this.switchPage('buyerAgriSell'); } else if (this.role === 'investor') { this.switchPage('investorProjects'); } else { this.switchPage('landing'); } },
      handleAuthenticationSuccess(identifier, method, orangeUserDetails = null) {
          if (!identifier) {
              this.addNotification("Authentication succeeded but user identifier was missing. Please try again.", "error");
              this.isOrangeIdCallback = false; this.isAuthProcessing = false; this.showLoadingModal = false;
              this.current = 'loginChoice'; return;
          }
          this.isOrangeIdCallback = false; this.isAuthProcessing = false; this.showLoadingModal = false;
          this.$nextTick(() => {
              this.currentUserIdentifier = identifier; this.loginMethod = method;
              if (method === 'orangeId' && orangeUserDetails) { this.orangeIdUser = orangeUserDetails; this.walletAddress = null; }
              else if (method === 'solana') { this.walletAddress = identifier; this.orangeIdUser = null; }
              this.addNotification(`${method === 'orangeId' ? 'Orange ID' : 'Solana Wallet'} authentication successful!`, 'success');
              this.loadOrSetupPestiVidProfile();
          });
      },
      initializeOrangeIdSDK() { if (!window.React || !window.ReactDOM || !window.Bedrock) { console.error('Error: Orange ID - Required libraries (React, ReactDOM, Bedrock) failed to load.'); this.orangeIdBedrockSDKError = true; this.addNotification("Orange ID login service failed to load.", "error"); return false; } this.orangeIdBedrockSDKError = false; return true; },
      renderOrangeIdLoginWidget() { if (!this.initializeOrangeIdSDK() || this.orangeIdWidgetMounted) return; const container = document.getElementById('orange-id-login-container'); if (!container) { console.error("Orange ID login container not found."); return; } this.unmountOrangeIdLoginWidget(); this.orangeIdReactRootLogin = ReactDOM.createRoot(container); try { this.orangeIdReactRootLogin.render( React.createElement( Bedrock.BedrockPassportProvider, this.bedrockConfig, React.createElement(Bedrock.LoginPanel, { title: "Sign in to PestiVid", logo: "https://img.icons8.com/plasticine/100/farmer-male.png", logoAlt: "PestiVid", showConnectWallet: false, separatorText: "After this login successfully, you will need to connect your wallet because it is a Web3 application.", features: { enableWalletConnect: false, enableAppleLogin: true, enableGoogleLogin: true, enableEmailLogin: true, }, }) ) ); this.orangeIdWidgetMounted = true; } catch (e) { console.error("Error rendering Orange ID LoginPanel:", e); this.orangeIdBedrockSDKError = true; container.innerHTML = '<p class="text-red-500 p-4 text-sm"><i class="fas fa-exclamation-triangle mr-2"></i>Failed to render login widget.</p>'; } },
      unmountOrangeIdLoginWidget() { if (this.orangeIdReactRootLogin) { this.orangeIdReactRootLogin.unmount(); this.orangeIdReactRootLogin = null; this.orangeIdWidgetMounted = false; const container = document.getElementById('orange-id-login-container'); if (container) container.innerHTML = ''; } },
      renderOrangeIdCallbackProcessor() { if (!this.initializeOrangeIdSDK()) return; const container = document.getElementById('orange-id-callback-processor'); if (!container) return; this.orangeIdReactRootCallback = ReactDOM.createRoot(container); const self = this; function AuthCallbackProcessor() { const { loginCallback, user, isAuthenticated, isLoading } = Bedrock.useBedrockPassport(); const [message, setMessage] = React.useState('Processing authentication...'); React.useEffect(() => { async function processLogin() { const params = new URLSearchParams(window.location.search); const token = params.get('token'); const refreshToken = params.get('refreshToken'); if (token && refreshToken) { try { setMessage('Verifying tokens with Orange ID...'); const bedrockUser = await loginCallback(token, refreshToken); if (bedrockUser) { setMessage('Orange ID Login successful! Finalizing PestiVid session...'); window.history.replaceState({}, document.title, window.location.pathname + window.location.hash); self.handleAuthenticationSuccess(bedrockUser.sub || bedrockUser.id, 'orangeId', bedrockUser); } else { setMessage('Orange ID Authentication failed. Please try again.'); self.addNotification("Orange ID authentication failed.", "error"); setTimeout(() => { self.isOrangeIdCallback = false; self.current = 'loginChoice'; }, 2000); } } catch (error) { console.error('Orange ID Login callback error:', error); setMessage(`An error occurred during Orange ID login: ${error.message}`); self.addNotification(`Orange ID login error: ${error.message}`, "error"); setTimeout(() => { self.isOrangeIdCallback = false; self.current = 'loginChoice'; }, 3000); } } else { setMessage('No authentication tokens found. Redirecting to login...'); setTimeout(() => { self.isOrangeIdCallback = false; self.current = 'loginChoice'; }, 2000); } } processLogin(); }, [loginCallback]); if (isLoading) return React.createElement('p', null, 'Loading Bedrock SDK...'); return React.createElement('div', { style: { textAlign: 'center', padding: '1rem' } }, message); } this.orangeIdReactRootCallback.render( React.createElement( Bedrock.BedrockPassportProvider, this.bedrockConfig, React.createElement(AuthCallbackProcessor) ) ); },
      unmountOrangeIdCallbackProcessor() { if (this.orangeIdReactRootCallback) { this.orangeIdReactRootCallback.unmount(); this.orangeIdReactRootCallback = null; const container = document.getElementById('orange-id-callback-processor'); if (container) container.innerHTML = ''; } },
      renderOrangeIdSignOutButton(containerId, isMobile = false) { if (!this.initializeOrangeIdSDK() || !this.isUserAuthenticated || this.loginMethod !== 'orangeId') return; const container = document.getElementById(containerId); if (!container) return; let rootRef = isMobile ? 'orangeIdReactRootSignOutMobile' : 'orangeIdReactRootSignOut'; this.unmountOrangeIdSignOutButton(containerId, isMobile); this[rootRef] = ReactDOM.createRoot(container); const self = this; function PestiVidSignOutWrapper() { const { logout } = Bedrock.useBedrockPassport(); return React.createElement(Bedrock.SignOutButton, { onSignOut: () => { self.clearUserSession(true); self.current = 'landing'; }, buttonContent: React.createElement('i', { className: "fas fa-sign-out-alt text-lg" }), }); } this[rootRef].render( React.createElement( Bedrock.BedrockPassportProvider, this.bedrockConfig, React.createElement(PestiVidSignOutWrapper) ) ); },
      unmountOrangeIdSignOutButton(containerId, isMobile = false) { let rootRef = isMobile ? 'orangeIdReactRootSignOutMobile' : 'orangeIdReactRootSignOut'; if (this[rootRef]) { this[rootRef].unmount(); this[rootRef] = null; const container = document.getElementById(containerId); if(container) container.innerHTML = ''; } },
      checkOrangeIdCallback() { const params = new URLSearchParams(window.location.search); const token = params.get('token'); const refreshToken = params.get('refreshToken'); if (token && refreshToken) { this.isOrangeIdCallback = true; this.isAuthProcessing = true; this.$nextTick(() => this.renderOrangeIdCallbackProcessor()); return true; } this.isOrangeIdCallback = false; return false; },
      async connectWallet() { if (typeof window.solana === 'undefined' || typeof window.solana.connect === 'undefined') { alert("Solana wallet (e.g., Phantom) not found. Please install Phantom and try again."); window.open('https://phantom.app/', '_blank'); return; } if (this.isUserAuthenticated) { if (this.loginMethod === 'solana') { this.addNotification("Solana Wallet already connected.", "info"); return; } if(!confirm(`You are logged in with ${this.loginMethod}. Switch to Solana Wallet? This will log you out of Orange ID.`)) return; await this.logoutUser(false); } this.isAuthProcessing = true; try { const resp = await window.solana.connect(); this.handleAuthenticationSuccess(resp.publicKey.toString(), 'solana'); } catch (err) { console.error("Solana Wallet connection error:", err); this.addNotification("Could not connect to Solana wallet. " + (err.message || ''), "error"); this.loginMethod = null; this.isAuthProcessing = false; } },
      async disconnectWallet() { if (window.solana && window.solana.isConnected) { try { await window.solana.disconnect(); } catch (err) { console.error("Error disconnecting Solana wallet:", err); } } this.walletAddress = null; },
      loadOrSetupPestiVidProfile() { const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles')) || {}; const pestividProfile = userProfiles[this.currentUserIdentifier]; if (pestividProfile && pestividProfile.role) { this.role = pestividProfile.role; this.userName = pestividProfile.name; this.userEmail = pestividProfile.email; this.userPhone = pestividProfile.phone || ''; this.memberSince = pestividProfile.memberSince || new Date().toLocaleDateString(); } else { this.userNameOnboarding = this.loginMethod === 'orangeId' && this.orangeIdUser ? (this.orangeIdUser.name || '') : ''; this.userEmailOnboarding = this.loginMethod === 'orangeId' && this.orangeIdUser ? (this.orangeIdUser.email || '') : ''; this.userPhoneOnboarding = ''; this.selectedRoleOnboarding = ''; this.current = 'roleSelection'; if (this.isUserAuthenticated) { this.addNotification(`Welcome! Please complete your PestiVid profile.`, 'info'); } } this.filterDataForCurrentUser(); this.showMobileMenu = false; if (this.current !== 'roleSelection') { if (this.isUserAuthenticated && this.role) { this.getStarted(); } else if (this.isUserAuthenticated && !this.role) { this.current = 'roleSelection'; } } },
      completeOnboarding() { if (!this.selectedRoleOnboarding || !this.userNameOnboarding.trim() || !this.userEmailOnboarding.trim()) { alert("Please fill in Full Name, PestiVid Email, and select a Role."); return; } if (!/\S+@\S+\.\S+/.test(this.userEmailOnboarding)) { alert("Please enter a valid PestiVid email address."); return; } this.role = this.selectedRoleOnboarding; this.userName = this.userNameOnboarding.trim(); this.userEmail = this.userEmailOnboarding.trim(); this.userPhone = this.userPhoneOnboarding.trim() || ''; this.memberSince = new Date().toLocaleDateString(); const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles')) || {}; userProfiles[this.currentUserIdentifier] = { role: this.role, name: this.userName, email: this.userEmail, phone: this.userPhone, memberSince: this.memberSince, authMethod: this.loginMethod, orangeAuthEmail: this.loginMethod === 'orangeId' && this.orangeIdUser ? this.orangeIdUser.email : null, orangeEthAddress: this.loginMethod === 'orangeId' && this.orangeIdUser ? this.orangeIdUser.ethAddress : null, }; localStorage.setItem('pestiVidUserProfiles', JSON.stringify(userProfiles)); this.filterDataForCurrentUser(); this.getStarted(); this.addNotification(`Profile for ${this.userName} setup! Welcome!`, 'success'); },
      async logoutUser(notify = true, triggerOrangeIdLogout = true) { this.showLoadingModal = true; this.loadingMessage = "Signing out..."; if (this.loginMethod === 'solana') { await this.disconnectWallet(); this.clearUserSession(notify); } else if (this.loginMethod === 'orangeId') { if (!triggerOrangeIdLogout) { this.clearUserSession(notify); } else { console.warn("Direct Orange ID logout called without UI button. Orange ID session might persist on their server. Use UI button for full logout."); this.clearUserSession(notify); } } else { this.clearUserSession(notify); } this.showLoadingModal = false; if (this.current !== 'landing') this.current = 'landing'; },
      clearUserSession(notify = true) { this.currentUserIdentifier = null; this.walletAddress = null; this.orangeIdUser = null; this.role = ''; this.userName = ''; this.userEmail = ''; this.userPhone = ''; this.memberSince = ''; this.farmerVideos = []; this.farmerListings = []; this.farmerFundingRequests = []; this.buyerPurchases = []; this.investorInvestments = []; this.investorTransactions = []; this.activeConversationId = null;
      this.avatar.chatMessages = []; this.farmerSolarAssets = []; this.solarEnergyProductionLogs = []; this.farmerAgrovoltaicsSetups = []; this.farmerCertifications = [];
      this.advancedEnergySources = []; this.iotDevices = []; this.simulatedSmartSystems = { irrigation: [], greenhouse: [] };
      this.unmountOrangeIdSignOutButton('orange-id-signout-button-container'); this.unmountOrangeIdSignOutButton('orange-id-signout-button-container-mobile'); if (this.loginMethod === 'orangeId') this.loginMethod = null; this.showMobileMenu = false; this.isAuthProcessing = false; this.isOrangeIdCallback = false; if (notify) this.addNotification("You have been signed out from PestiVid.", 'info'); },
      getFarmerDisplayIdentifier(wallet, length = 6) { if (!wallet) return 'N/A'; const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles')) || {}; const profile = userProfiles[wallet]; if (profile && profile.name) return profile.name.split(' ')[0]; return `${wallet.substring(0, length)}...`; },
      getSellerDisplayIdentifier(wallet, length = 6) { return this.getFarmerDisplayIdentifier(wallet, length); },
      async simulateTransaction(description = "Processing...") { this.showLoadingModal = true; this.loadingMessage = "Confirm action (Simulated)..."; await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 1000)); this.loadingMessage = `${description} on PestiVid (Simulated)...`; await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 1500)); const txHash = 'sim_tx_' + Date.now().toString(16) + Math.random().toString(16).substring(2, 12); this.showLoadingModal = false; return txHash; },
      async calculateFileHash(fileBlob) {
          if (!fileBlob) return null;
          try {
              const buffer = await fileBlob.arrayBuffer();
              const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
              const hashArray = Array.from(new Uint8Array(hashBuffer));
              const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
              return hashHex;
          } catch (error) {
              console.error("Error calculating file hash:", error);
              this.addNotification("Error calculating video integrity hash.", "error");
              return null;
          }
      },
      async startVideo() { if (!this.isUserAuthenticated) { alert("Please log in."); return; } if (this.recording || this.uploading) return; if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') { console.warn("HTTPS recommended for camera."); } this.recordBlob = null; this.recordBlobUrl = ''; this.uploadCid = ''; this.uploadError = ''; this.lastUploadedVideoFileHash = ''; this.showLive = true; try { const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false }); this.recordStream = stream; this.$refs.liveVideo.srcObject = stream; this.$refs.liveVideo.play(); let chunks = []; this.recording = true; const mimeTypes = ['video/webm;codecs=vp9,opus', 'video/webm;codecs=vp8,opus', 'video/webm', 'video/mp4']; let selectedMimeType = mimeTypes.find(type => MediaRecorder.isTypeSupported(type)) || undefined; this.recordMediaRecorder = new MediaRecorder(stream, { mimeType: selectedMimeType }); this.recordMediaRecorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); }; this.recordMediaRecorder.onstop = () => { const blobType = this.recordMediaRecorder.mimeType || 'video/webm'; this.recordBlob = new Blob(chunks, { type: blobType }); if (this.recordBlobUrl) URL.revokeObjectURL(this.recordBlobUrl); this.recordBlobUrl = URL.createObjectURL(this.recordBlob); this.showLive = false; stream.getTracks().forEach(t => t.stop()); this.recordStream = null; this.recording = false; }; this.recordMediaRecorder.onerror = (e) => { this.uploadError = "Recording error: " + e.name; this.stopVideo(); }; this.recordMediaRecorder.start(1000); } catch (e) { let alertMsg = "Camera access failed."; if (e.name === 'NotAllowedError') alertMsg = "Camera denied."; else if (e.name === 'NotFoundError') alertMsg = "No camera found."; else if (e.name === 'NotReadableError' || e.name === 'TrackStartError') alertMsg = "Camera in use."; if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') alertMsg += " HTTPS might be required."; alert(alertMsg); this.showLive = false; this.recording = false; } },
      stopVideo() { if (this.recordMediaRecorder && this.recordMediaRecorder.state === "recording") this.recordMediaRecorder.stop(); if (this.recordStream) { this.recordStream.getTracks().forEach(t => t.stop()); this.recordStream = null; } this.recording = false; this.showLive = false; },
      async uploadVideo() {
          if (!this.isUserAuthenticated) { alert("Log in."); return; }
          if (!this.recordBlob) { alert("No video."); return; }
          if (!this.recordForm.crop || !this.recordForm.pesticide || !this.recordForm.location || !this.recordForm.pesticideCompany || !this.recordForm.purpose) { alert("Fill details & purpose."); return; }
          if (this.pinataJwt === 'YOUR_PINATA_JWT_MUST_BE_REPLACED_HERE' || !this.pinataJwt || this.pinataJwt.length < 50) {
              const errorMsg = "CRITICAL ERROR: Pinata JWT is not configured correctly. Video uploads WILL FAIL. Please update 'pinataJwt' in the script.";
              this.uploadError = errorMsg; alert(errorMsg); console.error(errorMsg); return;
          }
          this.uploading = true; this.uploadCid = ''; this.uploadError = ''; this.lastUploadedVideoPurpose = ''; this.lastUploadedVideoFileHash = '';
          let videoFileHash = null;
          try {
              this.loadingMessage = "Calculating video integrity hash..."; this.showLoadingModal = true;
              videoFileHash = await this.calculateFileHash(this.recordBlob);
              this.showLoadingModal = false;
              if (!videoFileHash) { this.uploadError = "Failed to calculate video file hash. Upload aborted."; this.uploading = false; alert(this.uploadError); return; }
              this.lastUploadedVideoFileHash = videoFileHash;
          } catch (e) {
              this.showLoadingModal = false; this.uploadError = "Error during video hash calculation: " + e.message; this.uploading = false; alert(this.uploadError); return;
          }
          this.loadingMessage = "Uploading to IPFS..."; this.showLoadingModal = true;
          const formData = new FormData();
          const fileExtension = (this.recordBlob.type.split('/')[1] || 'webm').split(';')[0];
          const fileName = `pestivid_${this.currentUserIdentifier.substring(0,6)}_${Date.now()}.${fileExtension}`;
          formData.append('file', this.recordBlob, fileName);
          formData.append('pinataMetadata', JSON.stringify({
              name: fileName,
              keyvalues: { uploaderId: this.currentUserIdentifier, role: this.role, crop: this.recordForm.crop.trim(), pesticide: this.recordForm.pesticide.trim(), location: this.recordForm.location.trim(), pesticideCompany: this.recordForm.pesticideCompany.trim(), purpose: this.recordForm.purpose, uploadTimestamp: new Date().toISOString(), videoFileSHA256: videoFileHash }
          }));
          formData.append('pinataOptions', JSON.stringify({ cidVersion: 1 }));
          try {
              const resp = await axios.post('https://api.pinata.cloud/pinning/pinFileToIPFS', formData, { maxBodyLength: Infinity, headers: { Authorization: `Bearer ${this.pinataJwt}`, 'Content-Type': 'multipart/form-data' } });
              this.uploadCid = resp.data.IpfsHash;
              this.lastUploadedVideoPurpose = this.recordForm.purpose;
              const newVideoData = { cid: this.uploadCid, videoFileHash: videoFileHash, farmerWallet: this.currentUserIdentifier, crop: this.recordForm.crop.trim(), pesticide: this.recordForm.pesticide.trim(), location: this.recordForm.location.trim(), pesticideCompany: this.recordForm.pesticideCompany.trim(), purpose: this.recordForm.purpose, uploadTimestamp: new Date().toISOString() };
              this.farmerVideos.unshift(newVideoData);
              this.recordForm = { crop: '', pesticide: '', location: '', pesticideCompany: '', purpose: 'agristream' };
              if (this.recordBlobUrl) URL.revokeObjectURL(this.recordBlobUrl);
              this.recordBlob = null; this.recordBlobUrl = '';
              this.saveDataToLocalStorage();
              if (newVideoData.purpose === 'sell') { this.addNotification(`Video for "${newVideoData.crop}" uploaded. Complete listing.`, 'info'); this.navigateToPageWithParam('farmerSell', 'cid', this.uploadCid); }
              else if (newVideoData.purpose === 'funding') { this.addNotification(`Video for "${newVideoData.crop}" uploaded. Complete request.`, 'info'); this.navigateToPageWithParam('farmerFunding', 'cid', this.uploadCid); }
              else if (newVideoData.purpose === 'agrovoltaics') { this.addNotification(`Agrovoltaics video for "${newVideoData.crop}" uploaded.`, 'info'); this.navigateToPageWithParam('farmerAgriSolar', 'agroVideoCid', this.uploadCid); }
              else { this.addNotification(`Video for "${newVideoData.crop}" added to AgriStream!`, 'success'); }
          } catch (e) {
              this.uploadError = "Upload failed. ";
              if (e.response) { this.uploadError += `Server: ${e.response.status}. ${e.response.data?.error?.details || e.response.data?.error || e.message}`; if (e.response.status === 401) this.uploadError += " Bad Pinata JWT (check it's valid & has pinning permissions)."; }
              else if (e.request) { this.uploadError += " Network/CORS error."; }
              else { this.uploadError += e.message || "Unknown error"; }
              console.error("Pinata Upload Error Details:", e); alert(this.uploadError); this.uploadCid = ''; this.lastUploadedVideoFileHash = '';
          } finally {
              this.uploading = false; this.showLoadingModal = false;
          }
      },
      ipfsUrl(cid) { return cid ? `https://${this.pinataGateway}/ipfs/${cid}` : ""; },
      isListed(cid) { return this.farmerListings.some(l => l.cid === cid && l.farmerWallet === this.currentUserIdentifier); },
      isUsedInFunding(cid) { return this.farmerFundingRequests.some(req => req.cid === cid && req.farmerWallet === this.currentUserIdentifier); },
      isUsedInAgrovoltaics(cid) {
          return this.farmerAgrovoltaicsSetups.some(setup => setup.videoCid === cid && setup.farmerWallet === this.currentUserIdentifier);
      },
      goToListing(cid) { this.listingForm.cid = cid; this.switchPage('farmerSell'); },
      async createListing() {
          if (!this.isUserAuthenticated || this.role !== 'farmer') { alert("Log in as Farmer."); return; }
          this.createdListingId = null; this.listingNotificationSent = false;
          if (!this.listingForm.cid || !this.listingForm.minPrice || !this.listingForm.maxPrice) { alert("Select video & price."); return; }
          const minP = parseFloat(this.listingForm.minPrice); const maxP = parseFloat(this.listingForm.maxPrice);
          if (isNaN(minP) || isNaN(maxP) || minP <= 0 || maxP <= 0 || minP > maxP) { alert("Valid prices."); return; }
          let vid = this.farmerVideos.find(v => v.cid === this.listingForm.cid && v.farmerWallet === this.currentUserIdentifier);
          if (!vid) { alert("Video not found."); return; }
          if (this.isListed(vid.cid)) { alert("Video already listed."); return; }
          const txHash = await this.simulateTransaction("Creating listing");
          if (!txHash) { alert("Tx failed."); return; }
          let newListing = { id: 'lst' + Date.now(), farmerWallet: this.currentUserIdentifier, crop: vid.crop, location: vid.location, pesticide: vid.pesticide || '', pesticideCompany: vid.pesticideCompany || '', cid: vid.cid, videoFileHash: vid.videoFileHash, minPrice: minP, maxPrice: maxP, status: 'active', createdAt: new Date().toISOString(), notificationSent: false, isNew: true, txHash: txHash };
          this.farmerListings.unshift({ ...newListing });
          this.allListings.unshift({ ...newListing });
          if (this.listingForm.notifyBuyers) { this.notifyBuyersAboutListing(newListing, true); this.listingNotificationSent = true; this.addNotification( `Marketplace Update: New listing for "${newListing.crop}" by ${this.getFarmerDisplayIdentifier(newListing.farmerWallet)}.`, 'info', null, true ); }
          this.createdListingId = txHash;
          this.listingForm = { cid: '', minPrice: '', maxPrice: '', notifyBuyers: true };
          this.saveDataToLocalStorage();
          setTimeout(() => { this.createdListingId = null; this.listingNotificationSent = false; }, 5000);
      },
      fundingProgressPercent(req) { if (!req || !req.amount || req.amount <= 0) return 0; return Math.round(((req.fundedAmount || 0) / req.amount) * 100); },
      async createFundingRequest_V1() {
          if (!this.isUserAuthenticated || this.role !== 'farmer') { alert("Log in as Farmer."); return; }
          this.createdFundingRequest = false;
          const form = this.fundingForm;
          const baseRequired = ['projectType', 'title', 'amount', 'description', 'timeline', 'roi', 'investorShare'];
          const agriRequired = ['crop', 'acres', 'method', 'cid']; // Video is required for agri
          const energyOrSmartRequired = ['energyCapacityKW', 'expectedAnnualYield']; // General energy/smart system fields

          if (baseRequired.some(field => !form[field])) { alert("Fill all common fields."); return; }

          if (form.projectType === 'agricultural' && agriRequired.some(field => !form[field])) {
              alert("Fill all agricultural project specific fields, including selecting a video."); return;
          }
          const isEnergyOrSmart = ['solar', 'wind', 'hydro', 'biomass', 'smart_irrigation', 'smart_greenhouse'].includes(form.projectType);
          if (isEnergyOrSmart && energyOrSmartRequired.some(field => form[field] == null || form[field] === '')) {
              alert(`Fill all specific fields for ${form.projectType.replace('_', ' ')} project (Capacity, Expected Yield).`); return;
          }


          if (form.amount <= 0 || form.timeline <= 0 || form.roi <= 0 || form.investorShare <= 0 || form.investorShare > 80) { alert("Valid numbers required. Investor share 1-80%."); return; }
          if (form.projectType === 'agricultural' && (form.acres <= 0 || !form.method)) { alert("Valid Land Size and Growing Method required for agricultural projects."); return; }
          if (isEnergyOrSmart && (form.energyCapacityKW <=0 || !form.expectedAnnualYield)) { alert(`Valid Energy Capacity and Expected Yield required for ${form.projectType.replace('_',' ')} projects.`); return; }

          let vid = null;
          if (form.cid) {
            vid = this.farmerVideos.find(v => v.cid === form.cid && v.farmerWallet === this.currentUserIdentifier);
            if (!vid) { alert("Selected video not found or does not belong to you."); return; }
             if (this.isUsedInFunding(vid.cid)) { alert("Selected video is already used in a funding request."); return; }
          } else if (form.projectType === 'agricultural') {
             alert("A video is required for agricultural funding requests."); return;
          }

          const txHash = await this.simulateTransaction(`Creating ${form.projectType.replace('_', ' ')} funding request`);
          if (!txHash) { alert("Transaction failed."); return; }

          const newRequest = {
              id: 'fr' + Date.now(),
              farmerWallet: this.currentUserIdentifier,
              projectType: form.projectType,
              title: form.title.trim(),
              amount: form.amount,
              description: form.description.trim(),
              timeline: form.timeline,
              roi: form.roi,
              investorShare: form.investorShare,
              fundedAmount: 0,
              status: 'pending',
              createdAt: new Date().toISOString(),
              investors: [],
              cid: vid ? vid.cid : null,
              videoFileHash: vid ? vid.videoFileHash : null,
              txHash: txHash
          };

          if (form.projectType === 'agricultural') {
              newRequest.crop = form.crop.trim();
              newRequest.acres = form.acres;
              newRequest.method = form.method;
          } else if (isEnergyOrSmart) {
              newRequest.energyCapacityKW = form.energyCapacityKW;
              newRequest.expectedAnnualYield = form.expectedAnnualYield;
          }

          this.farmerFundingRequests.unshift({ ...newRequest });
          this.allFundingRequests.unshift({ ...newRequest });
          this.createdFundingRequest = true;
          this.addNotification(
            `Investment Opportunity: New ${form.projectType.replace('_',' ')} project "${newRequest.title}" by ${this.getFarmerDisplayIdentifier(newRequest.farmerWallet)}.`,
            'info', null, true
          );
          this.fundingForm = { projectType: 'agricultural', title: '', crop: '', acres: null, energyCapacityKW: null, expectedAnnualYield: null, amount: null, method: '', cid: '', description: '', timeline: null, roi: null, investorShare: null, notifyInvestors: true };
          this.saveDataToLocalStorage();
          setTimeout(() => this.createdFundingRequest = false, 3000);
      },
      cancelFundingRequest_V1(id) { if (!this.isUserAuthenticated || this.role !== 'farmer') { alert("Log in as Farmer."); return; } const req = this.farmerFundingRequests.find(r => r.id === id && r.farmerWallet === this.currentUserIdentifier); if (!req) { alert("Request not found/yours."); return;} if (req.fundedAmount > 0) { if (!confirm("Has funding. Cancel refunds (sim). Sure?")) return; } else if (!confirm("Cancel funding request?")) return; this.farmerFundingRequests = this.farmerFundingRequests.filter(r => r.id !== id); this.allFundingRequests = this.allFundingRequests.filter(r => r.id !== id); alert(`Funding request cancelled.`); this.saveDataToLocalStorage(); },
      resetBuyerFilters() { this.buyerFilters = {crop:'', location:'', pesticideCompany: ''}; },
      buyListing(listing) { if (!this.isUserAuthenticated || this.role !== 'buyer') { alert("Login as Buyer."); if (!this.isUserAuthenticated) this.switchPage('loginChoice'); return; } if(this.currentUserIdentifier === listing.farmerWallet) { alert("Cannot buy own listing."); return; } this.selectedListing = listing; this.purchaseAmount = listing.minPrice; this.purchaseStatus = ''; this.purchaseError = ''; this.showBuyModal = true; },
      closeBuyModal() { this.showBuyModal = false; this.selectedListing = null; this.purchaseAmount = null; this.purchaseStatus = ''; this.purchaseError = ''; },
      async processPurchase() {
          if (!this.isUserAuthenticated || !this.selectedListing || !this.purchaseAmount) return;
          this.purchaseStatus = ''; this.purchaseError = '';
          const amount = parseFloat(this.purchaseAmount);
          const minP = this.selectedListing.minPrice; const maxP = this.selectedListing.maxPrice;
          if (isNaN(amount) || amount < minP || amount > maxP) { this.purchaseError = `Offer ${minP}-${maxP} SOL.`; return; }
          const txHash = await this.simulateTransaction(`Purchasing ${this.selectedListing.crop}`);
          if (!txHash) { this.purchaseError = "Purchase Tx failed."; this.purchaseStatus = ''; return; }
          this.purchaseStatus = `Processing for ${amount} SOL... Tx: ${txHash.substring(0,10)}...`;
          try {
              const newPurchase = {
                  id: 'pur' + Date.now(),
                  buyerWallet: this.currentUserIdentifier,
                  farmerWallet: this.selectedListing.farmerWallet,
                  crop: this.selectedListing.crop,
                  location: this.selectedListing.location,
                  pesticide: this.selectedListing.pesticide,
                  pesticideCompany: this.selectedListing.pesticideCompany || '',
                  cid: this.selectedListing.cid,
                  videoFileHash: this.selectedListing.videoFileHash,
                  price: amount,
                  date: new Date().toLocaleDateString(),
                  txHash: txHash
              };
              this.buyerPurchases.unshift(newPurchase);
              this.allListings = this.allListings.filter(l => l.id !== this.selectedListing.id);
              if (this.role === 'farmer' && this.selectedListing.farmerWallet === this.currentUserIdentifier) { this.farmerListings = this.farmerListings.filter(l => l.id !== this.selectedListing.id); }
              this.addNotification(`Listing "${newPurchase.crop}" purchased!`, 'success');
              this.addNotification(`Your listing "${newPurchase.crop}" purchased by ${this.getFarmerDisplayIdentifier(newPurchase.buyerWallet, 6)}...`, 'success', newPurchase.farmerWallet);
              this.purchaseStatus = "Purchase successful!";
              this.saveDataToLocalStorage();
              setTimeout(() => { this.closeBuyModal(); }, 2500);
          } catch(err) {
              this.purchaseError = "Purchase sim failed."; this.purchaseStatus = '';
          }
      },
      viewPurchaseVideo(purchase) { this.selectedPurchase = purchase; this.showPurchaseVideo = true; },
      resetInvestorFilters() { this.investorFilters = {projectType: '', crop: '', method: '', minRoi: null, maxAmount: null}; },
      maxInvestmentAmount(project) { if (!project || project.status === 'funded' || project.amount === undefined || project.fundedAmount === undefined) return 0; const remaining = project.amount - (project.fundedAmount || 0); return remaining > 0 ? remaining.toFixed(2) : 0; },
      async investInProject(project) {
          if (!this.isUserAuthenticated || this.role !== 'investor') { alert("Login as Investor."); if(!this.isUserAuthenticated) this.switchPage('loginChoice'); return; }
          const amount = this.investmentAmounts[project.id];
          this.$set(this.investmentErrors, project.id, '');
          if (!amount || isNaN(amount) || amount <= 0) { this.$set(this.investmentErrors, project.id, 'Invalid amount.'); return; }
          const maxInvest = parseFloat(this.maxInvestmentAmount(project));
          const tolerance = 0.001;
          if (amount > maxInvest + tolerance) { this.$set(this.investmentErrors, project.id, `Max ${maxInvest} SOL.`); return; }
          const preciseAmount = parseFloat(amount.toFixed(2));
          const txHash = await this.simulateTransaction(`Investing ${preciseAmount} SOL`);
          if (!txHash) { this.$set(this.investmentErrors, project.id, 'Investment Tx failed.'); return; }
          try {
              const projectInAllIdx = this.allFundingRequests.findIndex(p => p.id === project.id);
              if (projectInAllIdx === -1) throw new Error("Project not found");
              const updatedProject = { ...this.allFundingRequests[projectInAllIdx] };
              updatedProject.fundedAmount = (updatedProject.fundedAmount || 0) + preciseAmount;
              updatedProject.investors = [...(updatedProject.investors || []), { investorId: this.currentUserIdentifier, amount: preciseAmount, txHash: txHash }];
              if (updatedProject.fundedAmount >= updatedProject.amount - tolerance) { updatedProject.status = 'funded'; updatedProject.fundedAmount = updatedProject.amount; } else { updatedProject.status = 'partially_funded'; }
              this.$set(this.allFundingRequests, projectInAllIdx, updatedProject);
              const farmerProjectIndex = this.farmerFundingRequests.findIndex(p => p.id === project.id);
              if(farmerProjectIndex > -1) { this.$set(this.farmerFundingRequests, farmerProjectIndex, updatedProject); }
              const newInvestment = {
                  id: 'inv' + Date.now(),
                  investorWallet: this.currentUserIdentifier,
                  projectId: project.id,
                  projectTitle: project.title,
                  projectType: project.projectType,
                  farmerWallet: project.farmerWallet,
                  crop: project.crop,
                  energyCapacityKW: project.energyCapacityKW, // For energy projects
                  expectedAnnualYield: project.expectedAnnualYield, // For energy projects
                  method: project.method,
                  description: project.description,
                  acres: project.acres,
                  timeline: project.timeline,
                  roi: project.roi,
                  investorShare: project.investorShare,
                  amount: preciseAmount,
                  cid: project.cid,
                  videoFileHash: project.videoFileHash,
                  status: (project.projectType === 'solar' || project.projectType === 'wind' || project.projectType === 'hydro' || project.projectType === 'biomass' || project.projectType === 'smart_irrigation' || project.projectType === 'smart_greenhouse') ? 'generating' : 'active',
                  progress: 0,
                  investmentDate: new Date().toLocaleDateString(),
                  txHash: txHash
              };
              this.investorInvestments.unshift(newInvestment);
              const newTransaction = { id: 'tx' + Date.now(), investorWallet: this.currentUserIdentifier, txHash: txHash, type: 'investment', amount: preciseAmount, date: new Date().toLocaleDateString(), projectId: project.id, projectTitle: project.title, projectType: project.projectType };
              this.investorTransactions.unshift(newTransaction);
              this.investorTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
              this.addNotification(`Investment ${preciseAmount} SOL successful!`, 'success');
              this.addNotification(`SIM: ${preciseAmount} SOL invested in "${project.title}" by ${this.getFarmerDisplayIdentifier(this.currentUserIdentifier)}`, 'info', project.farmerWallet);
              this.$set(this.investmentAmounts, project.id, null);
              alert(`Invested ${preciseAmount} SOL in "${project.title}"!`);
              this.saveDataToLocalStorage();
          } catch (err) {
              this.$set(this.investmentErrors, project.id, 'Invest sim failed.');
              alert("Invest sim failed.");
          }
      },
      updateInvestmentProgress() {
          const now = new Date();
          this.investorInvestments.forEach(inv => {
              if (inv.status === 'active' || inv.status === 'growing' || inv.status === 'generating') {
                  const dateInvested = new Date(inv.investmentDate);
                  let monthsElapsed = (now.getFullYear() - dateInvested.getFullYear()) * 12 + (now.getMonth() - dateInvested.getMonth());
                  let progress = 0;
                  let timelineUnit = (inv.projectType.includes('solar') || inv.projectType.includes('wind') || inv.projectType.includes('hydro') || inv.projectType.includes('biomass') || inv.projectType.includes('smart')) ? inv.timeline * 12 : inv.timeline;

                  if (timelineUnit && timelineUnit > 0) {
                      progress = Math.min(100, Math.max(0, Math.round((monthsElapsed / timelineUnit) * 100)));
                  }
                  progress = Math.min(100, Math.max(inv.progress || 0, progress + ((inv.progress || 0) < 95 ? Math.floor(Math.random() * 3) : 0)));
                  inv.progress = progress;

                  if (progress >= 100) {
                      inv.status = (inv.projectType.includes('solar') || inv.projectType.includes('wind') || inv.projectType.includes('hydro') || inv.projectType.includes('biomass') || inv.projectType.includes('smart')) ? 'completed' : 'harvested';
                      if (!inv.payoutNotified) {
                          const expectedReturn = this.calculateExpectedReturn(inv);
                          const payoutTxHash = 'sim_payout_tx_' + Date.now().toString(16) + Math.random().toString(16).substring(2,10);
                          this.investorTransactions.unshift({ id: 'txp' + Date.now(), investorWallet: inv.investorWallet, txHash: payoutTxHash, type: 'payout', amount: parseFloat(expectedReturn), date: new Date().toLocaleDateString(), projectId: inv.projectId, projectTitle: inv.projectTitle, projectType: inv.projectType });
                          this.investorTransactions.sort((a,b) => new Date(b.date) - new Date(a.date));
                          this.addNotification(`"${inv.projectTitle}" Payout ${expectedReturn} SOL!`, 'success', inv.investorWallet);
                          this.addNotification(`SIM: Payout ${expectedReturn} SOL for "${inv.projectTitle}" processed for investor ${this.getFarmerDisplayIdentifier(inv.investorWallet)}`, 'info', inv.farmerWallet);
                          inv.payoutNotified = true;
                          this.saveDataToLocalStorage();
                      }
                  } else if (progress > 0) {
                      inv.status = (inv.projectType.includes('solar') || inv.projectType.includes('wind') || inv.projectType.includes('hydro') || inv.projectType.includes('biomass') || inv.projectType.includes('smart')) ? 'generating' : 'growing';
                  } else if (progress === 0 && inv.status !== 'active') {
                       inv.status = 'active';
                  }
              }
          });
          this.allFundingRequests.sort((a,b) => {
             const statusOrder = {'pending': 1, 'partially_funded': 2, 'funded': 3};
             return statusOrder[a.status] - statusOrder[b.status] || new Date(b.createdAt) - new Date(a.createdAt);
          });

      },
      viewInvestmentDetails(investment) { this.selectedInvestmentProject = this.allFundingRequests.find(p => p.id === investment.projectId); this.selectedInvestment = { ...investment, projectType: investment.projectType || (this.selectedInvestmentProject ? this.selectedInvestmentProject.projectType : 'agricultural'), description: this.selectedInvestmentProject ? this.selectedInvestmentProject.description : investment.description, updates: this.selectedInvestmentProject ? (this.selectedInvestmentProject.updates || []) : [] }; this.showInvestmentDetailsModal = true; },
      calculateExpectedReturn(investment) { if (!investment || !investment.amount || !investment.roi) return '0.00'; return (investment.amount * (investment.roi / 100)).toFixed(2); },
      solanaExplorerUrl(txHash) { return `https://explorer.solana.com/tx/${txHash}?cluster=devnet`; },
      showFarmerProfile(farmerIdentifier) {
          if (!farmerIdentifier) return;
          this.selectedFarmerProfile = null;
          const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles')) || {};
          const farmerPestiVidProfile = userProfiles[farmerIdentifier] || {};

          const farmerSolarAssets = (this.getAllFarmerSolarAssets() || []).filter(asset => asset.farmerWallet === farmerIdentifier);
          const farmerEnergySources = (this.getAllAdvancedEnergySources() || []).filter(src => src.farmerWallet === farmerIdentifier);
          const farmerSolarLogs = (this.getAllSolarEnergyProductionLogs() || []).filter(log => log.farmerWallet === farmerIdentifier);
          const farmerIoTDevices = (this.getAllIoTDevices() || []).filter(dev => dev.farmerWallet === farmerIdentifier);
          const farmerSmartSystemsIrr = (this.getAllSimulatedSmartSystems().irrigation || []).filter(sys => sys.farmerWallet === farmerIdentifier);
          const farmerSmartSystemsGH = (this.getAllSimulatedSmartSystems().greenhouse || []).filter(sys => sys.farmerWallet === farmerIdentifier);

          const totalSolarCap = farmerSolarAssets.reduce((sum, asset) => sum + (parseFloat(asset.capacityKW) || 0), 0);
          const totalAdvancedCap = farmerEnergySources.reduce((sum, src) => sum + (parseFloat(src.capacityKW) || 0), 0);
          const totalRenewableCapacityKW = totalSolarCap + totalAdvancedCap;

          const totalCarbonOffsetKg = farmerSolarLogs.reduce((sum, log) => sum + (parseFloat(log.carbonOffsetKg) || 0), 0);

          const profileData = {
              walletAddress: farmerIdentifier,
              farmName: this.simulateFarmName(farmerIdentifier),
              bio: this.simulateFarmerBio(farmerIdentifier),
              email: farmerPestiVidProfile.email || this.simulateUserEmail(farmerIdentifier),
              memberSince: farmerPestiVidProfile.memberSince || this.simulateMemberSince(farmerIdentifier),
              fundingRequestCount: this.allFundingRequests.filter(r => r.farmerWallet === farmerIdentifier && (r.status === 'pending' || r.status === 'partially_funded')).length,
              activeListingCount: this.allListings.filter(l => l.farmerWallet === farmerIdentifier && l.status === 'active').length,
              totalRenewableCapacityKW: totalRenewableCapacityKW,
              totalCarbonOffsetKg: totalCarbonOffsetKg,
              iotDeviceCount: farmerIoTDevices.length,
              smartSystemCount: farmerSmartSystemsIrr.length + farmerSmartSystemsGH.length,
          };
          this.selectedFarmerProfile = profileData;
          this.showFarmerProfileModal = true;
      },
      closeFarmerProfileModal() { this.showFarmerProfileModal = false; this.selectedFarmerProfile = null; },
      simulateUserEmail(id) { return id ? `${id.substring(0, 6).toLowerCase()}@pestivid.sim` : 'user@example.com'; },
      simulateMemberSince(id) { let hash = 0; for (let i = 0; i < (id || '').length; i++) { hash = (hash << 5) - hash + id.charCodeAt(i); hash |= 0; } const daysAgo = Math.abs(hash % 730) + 30; const joinDate = new Date(); joinDate.setDate(joinDate.getDate() - daysAgo); return joinDate.toLocaleDateString(); },
      simulateFarmName(id) { if (!id) return "The Good Farm"; let hash = 0; for (let i = 0; i < id.length; i++) { hash = (hash << 5) - hash + id.charCodeAt(i); hash |= 0; } const names = ["Sunrise Farms", "Green Valley Organics", "Harvest Haven", "AgriTech Solutions", "Renewable Roots"]; return names[Math.abs(hash % names.length)] + ` (${id.substring(0, 3).toUpperCase()})`; },
      simulateFarmerBio(id) { const bios = ["Committed to sustainable agriculture.", "Family farm adopting Web3 transparency.", "Specializing in organic practices and quality produce.", "Connecting directly with buyers and investors.", "Focused on traceability and verified sustainable practices.", "Exploring agrovoltaics and renewable energy integration."]; let bioHash = 0; for (let i = 0; i < (id || '').length; i++) { bioHash = (bioHash << 5) - bioHash + id.charCodeAt(i); bioHash |= 0; } return bios[Math.abs(bioHash % bios.length)]; },
      selectConversation(convId) { this.activeConversationId = convId; this.markConversationAsRead(convId); this.$nextTick(() => this.scrollToMessageBottom()); },
      sendMessage() { if (!this.messageInputText.trim() || !this.activeConversationId || !this.isUserAuthenticated) return; const conversation = this.conversations.find(c => c.id === this.activeConversationId); if (!conversation) return; const receiverId = conversation.participants.find(p => p !== this.currentUserIdentifier); if (!receiverId) return; const newMessage = { id: 'msg' + Date.now(), conversationId: this.activeConversationId, sender: this.currentUserIdentifier, receiver: receiverId, text: this.messageInputText.trim(), timestamp: new Date().toISOString(), read: false }; this.messages.push(newMessage); conversation.lastMessageSnippet = newMessage.text.substring(0, 35) + (newMessage.text.length > 35 ? '...' : ''); conversation.lastMessageTimestamp = newMessage.timestamp; this.conversations.sort((a, b) => new Date(b.lastMessageTimestamp) - new Date(a.lastMessageTimestamp)); this.addNotification(`New message from ${this.getFarmerDisplayIdentifier(this.currentUserIdentifier)}`, 'info', receiverId); this.messageInputText = ''; this.$nextTick(() => this.scrollToMessageBottom()); this.saveDataToLocalStorage(); },
      startOrGoToConversation(targetIdentifier) { if (!this.isUserAuthenticated || !targetIdentifier ) { if (!this.isUserAuthenticated) { alert("Log in to message."); this.switchPage('loginChoice'); return;} if (!targetIdentifier) { alert("Target missing."); return;} } if (targetIdentifier === this.currentUserIdentifier) { alert("Cannot message self."); return; } const sortedParticipants = [this.currentUserIdentifier, targetIdentifier].sort(); let conversation = this.conversations.find(conv => conv.participants.length === 2 && conv.participants.join(',') === sortedParticipants.join(',')); if (!conversation) { const newConvId = 'conv' + Date.now(); conversation = { id: newConvId, participants: sortedParticipants, lastMessageSnippet: 'Conversation started.', lastMessageTimestamp: new Date().toISOString() }; this.conversations.unshift(conversation); this.conversations.sort((a,b) => new Date(b.lastMessageTimestamp) - new Date(a.lastMessageTimestamp)); this.saveDataToLocalStorage(); } this.switchPage('messaging'); this.$nextTick(() => this.selectConversation(conversation.id)); },
      messageFarmerFromProfile() { if (this.selectedFarmerProfile && this.isUserAuthenticated && this.currentUserIdentifier !== this.selectedFarmerProfile.walletAddress) { const targetUserIdentifier = this.selectedFarmerProfile.walletAddress; this.closeFarmerProfileModal(); this.$nextTick(() => this.startOrGoToConversation(targetUserIdentifier)); } else if (this.selectedFarmerProfile && this.isUserAuthenticated && this.currentUserIdentifier === this.selectedFarmerProfile.walletAddress) { alert("Cannot message self."); } },
      scrollToMessageBottom() { const el = this.$refs.messageContainer; if (el) setTimeout(() => { el.scrollTop = el.scrollHeight; }, 50); },
      getUnreadCountForConversation(convId) { if (!this.isUserAuthenticated) return 0; return this.messages.filter(msg => msg.conversationId === convId && msg.receiver === this.currentUserIdentifier && !msg.read).length; },
      markConversationAsRead(convId) { let changed = false; this.messages.forEach(msg => { if (msg.conversationId === convId && msg.receiver === this.currentUserIdentifier && !msg.read) { msg.read = true; changed = true; } }); if (changed) this.saveDataToLocalStorage(); },
      addNotification(message, type = 'info', recipientIdentifier = null, globalBroadcast = false) {
          if (globalBroadcast && this.isUserAuthenticated) {
              const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles') || '{}');
              const allUserIds = Object.keys(userProfiles);
              allUserIds.forEach(userId => {
                  if (userId !== this.currentUserIdentifier) {
                      const newNotification = { id: 'notif_global_' + Date.now() + '_' + userId + '_' + Math.random().toString(16).substring(2, 5), message: message, type: type, timestamp: Date.now(), show: false, recipient: userId };
                      this.notifications.push(newNotification);
                  }
              });
               const senderNotification = { id: 'notif_global_' + Date.now() + '_' + this.currentUserIdentifier + '_' + Math.random().toString(16).substring(2, 5), message: message, type: type, timestamp: Date.now(), show: false, recipient: this.currentUserIdentifier };
               this.notifications.push(senderNotification);
              this.showNextToastNotification();
              console.log(`GLOBAL BROADCAST (Demo): "${message}" from ${this.getFarmerDisplayIdentifier(this.currentUserIdentifier)}`);

          } else if (recipientIdentifier === null || recipientIdentifier === this.currentUserIdentifier) {
              const newNotification = { id: 'notif_user_' + Date.now() + '_' + Math.random().toString(16).substring(2, 8), message: message, type: type, timestamp: Date.now(), show: false, recipient: this.currentUserIdentifier };
              this.notifications.push(newNotification);
               this.showNextToastNotification();
          } else if (recipientIdentifier) {
              const newNotification = { id: 'notif_target_' + Date.now() + '_' + recipientIdentifier + '_' + Math.random().toString(16).substring(2, 8), message: message, type: type, timestamp: Date.now(), show: false, recipient: recipientIdentifier };
              this.notifications.push(newNotification);
              console.log(`(SIM) Targeted Notif for ${recipientIdentifier}: "${message}" by ${this.getFarmerDisplayIdentifier(this.currentUserIdentifier)}`);
          }
          this.saveDataToLocalStorage();
      },
       showNextToastNotification() {
           const pendingToasts = this.notifications.filter(n => n.recipient === this.currentUserIdentifier && !this.recentNotifications.some(rt => rt.id === n.id));
           if (this.recentNotifications.length >= 3 || pendingToasts.length === 0) return;
           pendingToasts.sort((a,b) => a.timestamp - b.timestamp);
           const notificationToShow = pendingToasts[0];
           this.recentNotifications.push(notificationToShow);
           this.$nextTick(() => {
               setTimeout(() => {
                   const index = this.recentNotifications.findIndex(n => n.id === notificationToShow.id);
                   if(index > -1) {
                       this.$set(this.recentNotifications[index], 'show', true);
                   }
               }, 50);
               notificationToShow.timeoutId = setTimeout(() => this.dismissNotification(notificationToShow.id), 4500);
           });
       },
       dismissNotification(id) {
           const index = this.recentNotifications.findIndex(n => n.id === id);
           if (index > -1) {
               if (this.recentNotifications[index].timeoutId) clearTimeout(this.recentNotifications[index].timeoutId);
               const mainIndex = this.notifications.findIndex(n => n.id === id);
               if (mainIndex > -1) { this.notifications.splice(mainIndex, 1); }
               this.$set(this.recentNotifications[index], 'show', false);
               setTimeout(() => {
                   const removeIndex = this.recentNotifications.findIndex(n => n.id === id);
                   if (removeIndex > -1) { this.recentNotifications.splice(removeIndex, 1); }
                   this.$nextTick(() => this.showNextToastNotification());
                   this.saveDataToLocalStorage();
               }, 400);
           } else {
             const mainIndex = this.notifications.findIndex(n => n.id === id);
              if (mainIndex > -1) {
                  this.notifications.splice(mainIndex, 1);
                  this.saveDataToLocalStorage();
              }
           }
       },
      saveDataToLocalStorage() {
        localStorage.setItem('pestiVidAppData', JSON.stringify({
            allListings: this.allListings,
            allFundingRequests: this.allFundingRequests,
            farmerVideos: this.getAllFarmerVideos(),
            buyerPurchases: this.getAllBuyerPurchases(),
            investorInvestments: this.getAllInvestorInvestments(),
            investorTransactions: this.getAllInvestorTransactions(),
            messages: this.messages,
            conversations: this.conversations,
            avatarChatMessages: this.avatar.chatMessages,
            farmerSolarAssets: this.getAllFarmerSolarAssets(), // Legacy
            solarEnergyProductionLogs: this.getAllSolarEnergyProductionLogs(), // Legacy
            farmerAgrovoltaicsSetups: this.getAllFarmerAgrovoltaicsSetups(),
            farmerCertifications: this.getAllFarmerCertifications(),
            energyMarketListings: this.getAllEnergyMarketListings(),
            energyTrades: this.getAllEnergyTrades(),
            advancedEnergySources: this.getAllAdvancedEnergySources(), // New
            iotDevices: this.getAllIoTDevices(), // New
            simulatedSmartSystems: this.getAllSimulatedSmartSystems(), // New (or update if becomes dynamic)
            notifications: this.notifications,
        }));
      },
      getAllFarmerVideos() {
          const data = JSON.parse(localStorage.getItem('pestiVidAppData') || '{}');
          let allStoredVideos = data.farmerVideos || [];
          if (this.isUserAuthenticated && this.role === 'farmer' && this.farmerVideos.length > 0) {
              const currentUserVideoCIDs = new Set(this.farmerVideos.map(v => v.cid));
              allStoredVideos = allStoredVideos.filter(v => !(v.farmerWallet === this.currentUserIdentifier && currentUserVideoCIDs.has(v.cid)));
              allStoredVideos.push(...this.farmerVideos);
          }
          return [...new Map(allStoredVideos.map(item => [`${item.farmerWallet || 'unknown'}_${item.cid}`, item])).values()];
      },
      getAllBuyerPurchases() {
           const data = JSON.parse(localStorage.getItem('pestiVidAppData') || '{}');
           let all = data.buyerPurchases || [];
           if (this.isUserAuthenticated && this.role === 'buyer' && this.buyerPurchases.length > 0) {
               const currentUserIDs = new Set(this.buyerPurchases.map(p => p.id));
               all = all.filter(p => !(p.buyerWallet === this.currentUserIdentifier && currentUserIDs.has(p.id)));
               all.push(...this.buyerPurchases);
           }
            return [...new Map(all.map(item => [item.id, item])).values()];
      },
      getAllInvestorInvestments() {
           const data = JSON.parse(localStorage.getItem('pestiVidAppData') || '{}');
           let all = data.investorInvestments || [];
           if (this.isUserAuthenticated && this.role === 'investor' && this.investorInvestments.length > 0) {
               const currentUserIDs = new Set(this.investorInvestments.map(i => i.id));
               all = all.filter(i => !(i.investorWallet === this.currentUserIdentifier && currentUserIDs.has(i.id)));
               all.push(...this.investorInvestments);
           }
           return [...new Map(all.map(item => [item.id, item])).values()];
      },
      getAllInvestorTransactions() {
           const data = JSON.parse(localStorage.getItem('pestiVidAppData') || '{}');
           return data.investorTransactions || [];
      },
      getAllFarmerSolarAssets() {
          const data = JSON.parse(localStorage.getItem('pestiVidAppData') || '{}');
          let allStoredAssets = data.farmerSolarAssets || [];
           if (this.isUserAuthenticated && this.role === 'farmer' && this.farmerSolarAssets.length > 0) {
               const currentUserAssetIDs = new Set(this.farmerSolarAssets.map(a => a.id));
               allStoredAssets = allStoredAssets.filter(a => !(a.farmerWallet === this.currentUserIdentifier && currentUserAssetIDs.has(a.id)));
               allStoredAssets.push(...this.farmerSolarAssets);
           }
           return [...new Map(allStoredAssets.map(item => [item.id, item])).values()];
      },
      getAllSolarEnergyProductionLogs() {
          const data = JSON.parse(localStorage.getItem('pestiVidAppData') || '{}');
          let allStoredLogs = data.solarEnergyProductionLogs || [];
           if (this.isUserAuthenticated && this.role === 'farmer' && this.solarEnergyProductionLogs.length > 0) {
               const currentUserLogIDs = new Set(this.solarEnergyProductionLogs.map(l => l.id));
               allStoredLogs = allStoredLogs.filter(l => !(l.farmerWallet === this.currentUserIdentifier && currentUserLogIDs.has(l.id)));
               allStoredLogs.push(...this.solarEnergyProductionLogs);
           }
           return [...new Map(allStoredLogs.map(item => [item.id, item])).values()];
      },
      getAllFarmerAgrovoltaicsSetups() {
            const data = JSON.parse(localStorage.getItem('pestiVidAppData') || '{}');
            let allStoredSetups = data.farmerAgrovoltaicsSetups || [];
            if (this.isUserAuthenticated && this.role === 'farmer' && this.farmerAgrovoltaicsSetups.length > 0) {
                const currentUserSetupIDs = new Set(this.farmerAgrovoltaicsSetups.map(s => s.id));
                allStoredSetups = allStoredSetups.filter(s => !(s.farmerWallet === this.currentUserIdentifier && currentUserSetupIDs.has(s.id)));
                allStoredSetups.push(...this.farmerAgrovoltaicsSetups);
            }
            return [...new Map(allStoredSetups.map(item => [item.id, item])).values()];
      },
      getAllFarmerCertifications() {
            const data = JSON.parse(localStorage.getItem('pestiVidAppData') || '{}');
            let allStoredCerts = data.farmerCertifications || [];
            if (this.isUserAuthenticated && this.role === 'farmer' && this.farmerCertifications.length > 0) {
                const currentUserCertIDs = new Set(this.farmerCertifications.map(c => c.id));
                allStoredCerts = allStoredCerts.filter(c => !(c.farmerWallet === this.currentUserIdentifier && currentUserCertIDs.has(c.id)));
                allStoredCerts.push(...this.farmerCertifications);
            }
            return [...new Map(allStoredCerts.map(item => [item.id, item])).values()];
      },
      getAllEnergyMarketListings() {
            const data = JSON.parse(localStorage.getItem('pestiVidAppData') || '{}');
            let allStoredListings = data.energyMarketListings || [];
             if (this.isUserAuthenticated && this.role === 'farmer' && this.farmerEnergyListings.length > 0) {
                const currentUserListingIDs = new Set(this.farmerEnergyListings.map(l => l.id));
                 allStoredListings = allStoredListings.filter(l => !(l.farmerWallet === this.currentUserIdentifier && currentUserListingIDs.has(l.id)));
                 allStoredListings.push(...this.farmerEnergyListings);
             }
            return [...new Map(allStoredListings.map(item => [item.id, item])).values()];
      },
       getAllEnergyTrades() {
            const data = JSON.parse(localStorage.getItem('pestiVidAppData') || '{}');
            return data.energyTrades || [];
       },
       getAllAdvancedEnergySources() {
            const data = JSON.parse(localStorage.getItem('pestiVidAppData') || '{}');
            let allStored = data.advancedEnergySources || [];
            if (this.isUserAuthenticated && this.role === 'farmer' && this.advancedEnergySources.length > 0) {
                const currentUserIDs = new Set(this.advancedEnergySources.filter(s => s.farmerWallet === this.currentUserIdentifier).map(s => s.id));
                allStored = allStored.filter(s => !(s.farmerWallet === this.currentUserIdentifier && currentUserIDs.has(s.id)));
                allStored.push(...this.advancedEnergySources.filter(s => s.farmerWallet === this.currentUserIdentifier));
            }
            return [...new Map(allStored.map(item => [item.id, item])).values()];
       },
       getAllIoTDevices() {
            const data = JSON.parse(localStorage.getItem('pestiVidAppData') || '{}');
            let allStored = data.iotDevices || [];
            if (this.isUserAuthenticated && this.role === 'farmer' && this.iotDevices.length > 0) {
                 const currentUserIDs = new Set(this.iotDevices.filter(d => d.farmerWallet === this.currentUserIdentifier).map(d => d.id));
                 allStored = allStored.filter(d => !(d.farmerWallet === this.currentUserIdentifier && currentUserIDs.has(d.id)));
                 allStored.push(...this.iotDevices.filter(d => d.farmerWallet === this.currentUserIdentifier));
            }
            return [...new Map(allStored.map(item => [item.id, item])).values()];
       },
        getAllSimulatedSmartSystems() { // This is a bit different as it's structured
            const data = JSON.parse(localStorage.getItem('pestiVidAppData') || '{}');
            let allStored = data.simulatedSmartSystems || { irrigation: [], greenhouse: [] };

            if (this.isUserAuthenticated && this.role === 'farmer') {
                // For irrigation
                const currentUserIrrigationIDs = new Set((this.simulatedSmartSystems.irrigation || []).filter(s => s.farmerWallet === this.currentUserIdentifier).map(s => s.id));
                allStored.irrigation = (allStored.irrigation || []).filter(s => !(s.farmerWallet === this.currentUserIdentifier && currentUserIrrigationIDs.has(s.id)));
                allStored.irrigation.push(...(this.simulatedSmartSystems.irrigation || []).filter(s => s.farmerWallet === this.currentUserIdentifier));
                allStored.irrigation = [...new Map(allStored.irrigation.map(item => [item.id, item])).values()];

                // For greenhouse
                const currentUserGreenhouseIDs = new Set((this.simulatedSmartSystems.greenhouse || []).filter(s => s.farmerWallet === this.currentUserIdentifier).map(s => s.id));
                allStored.greenhouse = (allStored.greenhouse || []).filter(s => !(s.farmerWallet === this.currentUserIdentifier && currentUserGreenhouseIDs.has(s.id)));
                allStored.greenhouse.push(...(this.simulatedSmartSystems.greenhouse || []).filter(s => s.farmerWallet === this.currentUserIdentifier));
                allStored.greenhouse = [...new Map(allStored.greenhouse.map(item => [item.id, item])).values()];
            }
            return allStored;
       },

      loadDataFromLocalStorage() {
          const savedData = localStorage.getItem('pestiVidAppData');
          if (savedData) {
              try {
                  const appData = JSON.parse(savedData);
                  this.allListings = appData.allListings || [];
                  this.allFundingRequests = appData.allFundingRequests || [];
                  this.messages = appData.messages || [];
                  this.conversations = appData.conversations || [];
                  this.avatar.chatMessages = appData.avatarChatMessages || [];
                  // Load legacy AgriSolar data
                  this.farmerSolarAssets = appData.farmerSolarAssets || [];
                  this.solarEnergyProductionLogs = appData.solarEnergyProductionLogs || [];
                  this.farmerAgrovoltaicsSetups = appData.farmerAgrovoltaicsSetups || [];
                  this.farmerCertifications = appData.farmerCertifications || [];
                  this.energyMarketListings = appData.energyMarketListings || [];
                  this.energyTrades = appData.energyTrades || [];
                  // Load NEW Advanced AgriSolar Data
                  this.advancedEnergySources = appData.advancedEnergySources || [];
                  this.iotDevices = appData.iotDevices || [];
                  this.simulatedSmartSystems = appData.simulatedSmartSystems || { irrigation: [], greenhouse: [] };

                  this.notifications = appData.notifications || [];

                   const hasMinimumStructure =
                       (this.allListings.length > 0 || this.allFundingRequests.length > 0 || (appData.farmerVideos && appData.farmerVideos.length > 0)) &&
                       this.farmerSolarAssets !== undefined &&
                       this.advancedEnergySources !== undefined && // Check new structures
                       this.iotDevices !== undefined;

                  if (!hasMinimumStructure) {
                       localStorage.removeItem('pestiVidAppData');
                       this.loadDemoDataIfNeeded();
                  } else {
                       if (!this.currentUserIdentifier) {
                           this.farmerVideos = []; this.farmerListings = []; this.farmerFundingRequests = [];
                           this.buyerPurchases = []; this.investorInvestments = []; this.investorTransactions = [];
                           this.farmerSolarAssets = []; this.solarEnergyProductionLogs = []; this.farmerAgrovoltaicsSetups = []; this.farmerCertifications = [];
                           this.advancedEnergySources = []; this.iotDevices = []; this.simulatedSmartSystems = { irrigation: [], greenhouse: [] };
                           this.activeConversationId = null;
                       } else {
                           this.filterDataForCurrentUser();
                       }
                       this.notifications = appData.notifications || [];
                       this.$nextTick(() => { this.showNextToastNotification(); });
                  }

              } catch (e) {
                  console.error("Error loading data from localStorage:", e);
                  localStorage.removeItem('pestiVidAppData');
                  this.loadDemoDataIfNeeded();
              }
          } else {
              this.loadDemoDataIfNeeded();
          }
          const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles')) || {};
          if (this.currentUserIdentifier && userProfiles[this.currentUserIdentifier]) {
              const profile = userProfiles[this.currentUserIdentifier];
              this.role = profile.role;
              this.userName = profile.name;
              this.userEmail = profile.email;
              this.userPhone = profile.phone || '';
              this.memberSince = profile.memberSince || new Date().toLocaleDateString();
          }
      },
      filterDataForCurrentUser() {
          const appData = JSON.parse(localStorage.getItem('pestiVidAppData') || '{}');
          this.allListings = appData.allListings || [];
          this.allFundingRequests = appData.allFundingRequests || [];
          this.messages = appData.messages || [];
          this.conversations = appData.conversations || [];
          this.avatar.chatMessages = appData.avatarChatMessages || [];
          this.farmerSolarAssets = (appData.farmerSolarAssets || []); // Legacy
          this.solarEnergyProductionLogs = (appData.solarEnergyProductionLogs || []); // Legacy
          this.farmerAgrovoltaicsSetups = (appData.farmerAgrovoltaicsSetups || []);
          this.farmerCertifications = (appData.farmerCertifications || []);
          this.energyMarketListings = (appData.energyMarketListings || []);
          this.energyTrades = (appData.energyTrades || []);
          this.notifications = (appData.notifications || []);
          // New Advanced AgriSolar
          this.advancedEnergySources = (appData.advancedEnergySources || []);
          this.iotDevices = (appData.iotDevices || []);
          this.simulatedSmartSystems = (appData.simulatedSmartSystems || { irrigation: [], greenhouse: [] });


          if (!this.isUserAuthenticated) {
              this.farmerVideos = []; this.farmerListings = []; this.farmerFundingRequests = [];
              this.buyerPurchases = []; this.investorInvestments = []; this.investorTransactions = [];
              this.activeConversationId = null;
              // Clear farmer-specific NEW AgriSolar data if not authenticated
              this.advancedEnergySources = [];
              this.iotDevices = [];
              this.simulatedSmartSystems = { irrigation: [], greenhouse: [] };
              return;
          }

          if (this.role === 'farmer') {
              this.farmerVideos = (appData.farmerVideos || []).filter(v => v.farmerWallet === this.currentUserIdentifier).map(v => ({...v, purpose: v.purpose || 'agristream'}));
              this.farmerListings = this.allListings.filter(l => l.farmerWallet === this.currentUserIdentifier);
              this.farmerFundingRequests = this.allFundingRequests.filter(r => r.farmerWallet === this.currentUserIdentifier);
              // Filter legacy solar data
              this.farmerSolarAssets = (appData.farmerSolarAssets || []).filter(asset => asset.farmerWallet === this.currentUserIdentifier);
              this.solarEnergyProductionLogs = (appData.solarEnergyProductionLogs || []).filter(log => log.farmerWallet === this.currentUserIdentifier);
              this.farmerAgrovoltaicsSetups = (appData.farmerAgrovoltaicsSetups || []).filter(setup => setup.farmerWallet === this.currentUserIdentifier);
              this.farmerCertifications = (appData.farmerCertifications || []).filter(cert => cert.farmerWallet === this.currentUserIdentifier);
              this.farmerEnergyListings = this.energyMarketListings.filter(listing => listing.farmerWallet === this.currentUserIdentifier);
              // Filter NEW Advanced AgriSolar data
              this.advancedEnergySources = (appData.advancedEnergySources || []).filter(src => src.farmerWallet === this.currentUserIdentifier);
              this.iotDevices = (appData.iotDevices || []).filter(dev => dev.farmerWallet === this.currentUserIdentifier);
              this.simulatedSmartSystems.irrigation = (appData.simulatedSmartSystems?.irrigation || []).filter(sys => sys.farmerWallet === this.currentUserIdentifier);
              this.simulatedSmartSystems.greenhouse = (appData.simulatedSmartSystems?.greenhouse || []).filter(sys => sys.farmerWallet === this.currentUserIdentifier);

          } else {
              this.farmerVideos = []; this.farmerListings = []; this.farmerFundingRequests = [];
              this.farmerSolarAssets = []; this.solarEnergyProductionLogs = []; this.farmerAgrovoltaicsSetups = []; this.farmerCertifications = [];
              this.farmerEnergyListings = [];
              // Clear farmer-specific NEW AgriSolar data if not a farmer
              this.advancedEnergySources = [];
              this.iotDevices = [];
              this.simulatedSmartSystems = { irrigation: [], greenhouse: [] };
          }

          if (this.role === 'buyer') {
              this.buyerPurchases = (appData.buyerPurchases || []).filter(p => p.buyerWallet === this.currentUserIdentifier);
          } else {
              this.buyerPurchases = [];
          }

          if (this.role === 'investor') {
              this.investorInvestments = (appData.investorInvestments || []).filter(i => i.investorWallet === this.currentUserIdentifier);
              this.investorTransactions = (appData.investorTransactions || []).filter(t => t.investorWallet === this.currentUserIdentifier);
              this.updateInvestmentProgress();
          } else {
              this.investorInvestments = []; this.investorTransactions = [];
          }

          this.messages = (appData.messages || []).filter(msg => msg.sender === this.currentUserIdentifier || msg.receiver === this.currentUserIdentifier);
          this.conversations = (appData.conversations || []).filter(conv => conv.participants.includes(this.currentUserIdentifier));

          if (this.activeConversationId) {
              const activeConv = this.conversations.find(c => c.id === this.activeConversationId);
              if (!activeConv || !activeConv.participants.includes(this.currentUserIdentifier)) {
                  this.activeConversationId = null;
              }
          }
          this.conversations.sort((a, b) => new Date(b.lastMessageTimestamp) - new Date(a.lastMessageTimestamp));
          this.notifications = (appData.notifications || []).filter(n => n.recipient === this.currentUserIdentifier);
          this.recentNotifications = [];
          this.$nextTick(() => { this.showNextToastNotification(); });
          console.log("Data filtered for current user:", this.currentUserIdentifier, "Role:", this.role);
      },
      loadDemoDataIfNeeded() {
        console.log("Loading/Reloading PestiVid Demo Data...");

        const validVideoCID = 'bafybeidm6b63qzflosp72huhxsqpmsdcy6flgksftiyi2jekwnkoge5t5u';
        const now = Date.now();
        const day = 24*60*60*1000;
        const week = 7 * day;
        const month = 30 * day;

        const demoFarmer1 = 'oid_farmer_1_sub';
        const demoFarmer2 = 'sol_farmer_2_addr';
        const demoInvestor1 = 'oid_investor_1_sub';
        const demoBuyer1 = 'sol_buyer_1_addr';
        const demoInvestor2 = 'oid_investor_2_sub';
        const demoBuyer2 = 'sol_buyer_2_addr';

        const demoFarmerVideos = [
            { farmerWallet: demoFarmer1, cid: validVideoCID, videoFileHash: 'demo_sha256_hash_tomatoes_placeholder_for_video1', crop: 'Tomatoes (Demo Video)', pesticide: 'Copper Spray', location: 'West Field', pesticideCompany: 'AgriSource', purpose: 'sell', uploadTimestamp: new Date(now - 5*day).toISOString()},
            { farmerWallet: demoFarmer1, cid: validVideoCID, videoFileHash: 'demo_sha256_hash_strawberries_placeholder_for_video2', crop: 'Strawberries (Demo Video)', pesticide: 'Ladybugs', location: 'South Plot', pesticideCompany: 'NatureFirst', purpose: 'funding', uploadTimestamp: new Date(now - 10*day).toISOString()},
            { farmerWallet: demoFarmer2, cid: validVideoCID, videoFileHash: 'demo_sha256_hash_lettuce_placeholder_for_video3', crop: 'Lettuce (Demo Video)', pesticide: 'Nutrient Solution', location: 'Hydro Unit 1', pesticideCompany: 'HydroGrow', purpose: 'agristream', uploadTimestamp: new Date(now - 2*day).toISOString()},
            { farmerWallet: demoFarmer1, cid: validVideoCID, videoFileHash: 'demo_sha256_hash_agrovoltaic_placeholder_video4', crop: 'Shade Tolerant Herbs', pesticide: 'Minimal', location: 'Solar Panel Plot A', pesticideCompany: 'Self-Sufficient Farms', purpose: 'agrovoltaics', uploadTimestamp: new Date(now - 3*day).toISOString() },
            { farmerWallet: demoFarmer2, cid: validVideoCID, videoFileHash: 'demo_sha256_hash_corn_placeholder_video5', crop: 'Corn (Demo Video)', pesticide: 'Conventional Spray', location: 'North Field', pesticideCompany: 'FarmChem Co.', purpose: 'agristream', uploadTimestamp: new Date(now - 15*day).toISOString() },
        ];

        this.allListings = [
            { id: 'lst_demo1', farmerWallet: demoFarmer1, crop: 'Tomatoes (Demo Video)', location: 'West Field', pesticide: 'Copper Spray', pesticideCompany: 'AgriSource', cid: validVideoCID, videoFileHash: 'demo_sha256_hash_tomatoes_placeholder_for_video1', minPrice: 0.8, maxPrice: 1.2, status: 'active', createdAt: new Date(now - 4*day).toISOString(), isNew: true, txHash: 'sim_lst_tx_1' },
            { id: 'lst_demo2', farmerWallet: demoFarmer2, crop: 'Peppers (Demo Video)', location: 'Greenhouse 3', pesticide: 'Neem Oil', pesticideCompany: 'Organics Inc.', cid: validVideoCID, videoFileHash: 'demo_sha256_hash_peppers_placeholder_for_video4', minPrice: 1.0, maxPrice: 1.5, status: 'active', createdAt: new Date(now - 7*day).toISOString(), isNew: false, txHash: 'sim_lst_tx_2' },
        ];

        this.allFundingRequests = [
            { id: 'fr_demo1', farmerWallet: demoFarmer1, projectType: 'agricultural', title: 'Organic Strawberry Expansion (Demo)', crop: 'Strawberries (Demo Video)', acres: 2.5, amount: 25, method: 'organic', cid: validVideoCID, videoFileHash: 'demo_sha256_hash_strawberries_placeholder_for_video2', description: 'Expanding organic strawberry fields...', timeline: 6, roi: 18, investorShare: 20, fundedAmount: 10, status: 'partially_funded', createdAt: new Date(now - 9*day).toISOString(), investors: [{investorId: demoInvestor1, amount: 10, txHash:'sim_inv_tx_demo1'}], updates: [{id:'upd1', date: '1 week ago', text:'Initial tilling complete.'}], txHash: 'sim_fr_tx_1' },
            { id: 'fr_demo2', farmerWallet: demoFarmer2, projectType: 'agricultural', title: 'Hydroponic Lettuce Setup (Demo)', crop: 'Lettuce (Demo Video)', acres: 0.5, amount: 40, method: 'hydroponic', cid: validVideoCID, videoFileHash: 'demo_sha256_hash_lettuce_placeholder_for_video3', description: 'Setting up hydroponic system...', timeline: 4, roi: 25, investorShare: 30, fundedAmount: 0, status: 'pending', createdAt: new Date(now - 3*day).toISOString(), investors: [], updates: [], txHash: 'sim_fr_tx_2' },
            { id: 'fr_demo_solar1', farmerWallet: demoFarmer1, projectType: 'solar', title: 'Barn Roof Solar Array (Demo)', energyCapacityKW: 15, expectedAnnualYield: '18000 kWh', amount: 30, description: 'Install solar panels on the main barn roof to power operations and reduce costs.', timeline: 7, roi: 12, investorShare: 40, fundedAmount: 5, status: 'partially_funded', createdAt: new Date(now - 6*day).toISOString(), cid: null, videoFileHash: null, investors: [{investorId: demoInvestor1, amount: 5, txHash:'sim_inv_tx_solar_demo1'}], updates:[], txHash: 'sim_fr_solar_tx_1'},
            { id: 'fr_demo_wind1', farmerWallet: demoFarmer2, projectType: 'wind', title: 'Hilltop Wind Turbine (Demo)', energyCapacityKW: 10, expectedAnnualYield: '22000 kWh', amount: 50, description: 'Install a 10kW wind turbine on the west hill.', timeline: 8, roi: 14, investorShare: 35, fundedAmount: 0, status: 'pending', createdAt: new Date(now - 1*day).toISOString(), cid: null, videoFileHash: null, investors: [], updates:[], txHash: 'sim_fr_wind_tx_1', isNew: true},
        ];

        const demoBuyerPurchases = [
            { id: 'pur_demo1', buyerWallet: demoBuyer1, farmerWallet: demoFarmer1, crop: 'Tomatoes (Demo Video)', location: 'West Field', pesticide: 'Copper Spray', pesticideCompany: 'AgriSource', cid: validVideoCID, videoFileHash: 'demo_sha256_hash_tomatoes_placeholder_for_video1', price: 0.9, date: new Date(now - 2*week).toLocaleDateString(), txHash: 'sim_pur_tx_demo1' },
            { id: 'pur_demo2', buyerWallet: demoBuyer2, farmerWallet: demoFarmer2, crop: 'Lettuce (Demo Video)', location: 'Hydro Unit 1', pesticide: 'Nutrient Solution', pesticideCompany: 'HydroGrow', cid: validVideoCID, videoFileHash: 'demo_sha256_hash_lettuce_placeholder_for_video3', price: 1.1, date: new Date(now - 1*week).toLocaleDateString(), txHash: 'sim_pur_tx_demo2' },
        ];
        const demoInvestorInvestments = [
            { id: 'inv_demo1', investorWallet: demoInvestor1, projectId: 'fr_demo1', projectType: 'agricultural', projectTitle: 'Organic Strawberry Expansion (Demo)', farmerWallet: demoFarmer1, crop: 'Strawberries (Demo Video)', method: 'organic', description: 'Expanding organic strawberry fields...', acres: 2.5, timeline: 6, roi: 18, investorShare: 20, amount: 10, cid: validVideoCID, videoFileHash: 'demo_sha256_hash_strawberries_placeholder_for_video2', status: 'growing', progress: 35, investmentDate: new Date(now - 3*week).toLocaleDateString(), txHash: 'sim_inv_tx_demo1' },
            { id: 'inv_solar_demo1', investorWallet: demoInvestor1, projectId: 'fr_demo_solar1', projectType: 'solar', projectTitle: 'Barn Roof Solar Array (Demo)', farmerWallet: demoFarmer1, energyCapacityKW: 15, expectedAnnualYield: '18000 kWh', description: 'Install solar panels on the main barn roof...', timeline: 7, roi: 12, investorShare: 40, amount: 5, cid: null, videoFileHash: null, status: 'generating', progress: 15, investmentDate: new Date(now - 2*week).toLocaleDateString(), txHash: 'sim_inv_tx_solar_demo1' },
            { id: 'inv_demo2', investorWallet: demoInvestor2, projectId: 'fr_demo1', projectType: 'agricultural', projectTitle: 'Organic Strawberry Expansion (Demo)', farmerWallet: demoFarmer1, crop: 'Strawberries (Demo Video)', method: 'organic', description: 'Expanding organic strawberry fields...', acres: 2.5, timeline: 6, roi: 18, investorShare: 20, amount: 5, cid: validVideoCID, videoFileHash: 'demo_sha256_hash_strawberries_placeholder_for_video2', status: 'growing', progress: 35, investmentDate: new Date(now - 2*week).toLocaleDateString(), txHash: 'sim_inv_tx_demo2' },
            { id: 'inv_solar_demo2', investorWallet: demoInvestor2, projectId: 'fr_demo_solar1', projectType: 'solar', projectTitle: 'Barn Roof Solar Array (Demo)', farmerWallet: demoFarmer1, energyCapacityKW: 15, expectedAnnualYield: '18000 kWh', description: 'Install solar panels on the main barn roof...', timeline: 7, roi: 12, investorShare: 40, amount: 10, cid: null, videoFileHash: null, status: 'generating', progress: 15, investmentDate: new Date(now - 1*week).toLocaleDateString(), txHash: 'sim_inv_tx_solar_demo2' }
        ];
        let demoInvestorTransactions = [
            { id: 'tx_demo1', investorWallet: demoInvestor1, txHash: 'sim_inv_tx_demo1', type: 'investment', amount: 10, date: new Date(now - 3*week).toLocaleDateString(), projectId: 'fr_demo1', projectTitle: 'Organic Strawberry Expansion (Demo)', projectType: 'agricultural' },
            { id: 'tx_solar_demo1', investorWallet: demoInvestor1, txHash: 'sim_inv_tx_solar_demo1', type: 'investment', amount: 5, date: new Date(now - 2*week).toLocaleDateString(), projectId: 'fr_demo_solar1', projectTitle: 'Barn Roof Solar Array (Demo)', projectType: 'solar' },
            { id: 'tx_demo2', investorWallet: demoInvestor2, txHash: 'sim_inv_tx_demo2', type: 'investment', amount: 5, date: new Date(now - 2*week).toLocaleDateString(), projectId: 'fr_demo1', projectTitle: 'Organic Strawberry Expansion (Demo)', projectType: 'agricultural' },
            { id: 'tx_solar_demo2', investorWallet: demoInvestor2, txHash: 'sim_inv_tx_solar_demo2', type: 'investment', amount: 10, date: new Date(now - 1*week).toLocaleDateString(), projectId: 'fr_demo_solar1', projectTitle: 'Barn Roof Solar Array (Demo)', projectType: 'solar' },
        ];

        const demoFarmerSolarAssets = [ // Legacy
            { id: 'solar_asset_demo1_f1', farmerWallet: demoFarmer1, assetName: 'Main Barn Array (Legacy Solar)', capacityKW: 20, installationDate: '2023-01-15', notes: 'IoT ID: panel_set_001, South-facing', simulatedBlockchainRecord: 'tx_solar_asset_demo1' },
            { id: 'solar_asset_demo2_f1', farmerWallet: demoFarmer1, assetName: 'Pump House Panel (Legacy Solar)', capacityKW: 2.5, installationDate: '2023-06-01', notes: 'Powers irrigation pump', simulatedBlockchainRecord: 'tx_solar_asset_demo2' },
            { id: 'solar_asset_demo1_f2', farmerWallet: demoFarmer2, assetName: 'Greenhouse Rooftop (Legacy Solar)', capacityKW: 10, installationDate: '2023-03-20', notes: 'Powers greenhouse climate control', simulatedBlockchainRecord: 'tx_solar_asset_demo3' },
        ];
        const demoSolarEnergyProductionLogs = [ // Legacy
            { id: 'log_demo1_f1', solarAssetId: 'solar_asset_demo1_f1', farmerWallet: demoFarmer1, date: new Date(now - 86400000 * 5).toISOString().slice(0,10), kwhProduced: 85.5, kwhUsedOnFarm: 30.0, kwhAvailableForSale: 55.5, carbonOffsetKg: parseFloat((85.5 * this.carbonFactorKgPerKwh).toFixed(2)), simulatedBlockchainRecord: 'tx_log_demo1' },
            { id: 'log_demo2_f1', solarAssetId: 'solar_asset_demo1_f1', farmerWallet: demoFarmer1, date: new Date(now - 86400000 * 1).toISOString().slice(0,10), kwhProduced: 92.0, kwhUsedOnFarm: 35.0, kwhAvailableForSale: 57.0, carbonOffsetKg: parseFloat((92.0 * this.carbonFactorKgPerKwh).toFixed(2)), simulatedBlockchainRecord: 'tx_log_demo2' },
            { id: 'log_demo3_f1', solarAssetId: 'solar_asset_demo2_f1', farmerWallet: demoFarmer1, date: new Date(now - 86400000 * 1).toISOString().slice(0,10), kwhProduced: 10.2, kwhUsedOnFarm: 8.0, kwhAvailableForSale: 2.2, carbonOffsetKg: parseFloat((10.2 * this.carbonFactorKgPerKwh).toFixed(2)), simulatedBlockchainRecord: 'tx_log_demo3' },
            { id: 'log_demo1_f2', solarAssetId: 'solar_asset_demo1_f2', farmerWallet: demoFarmer2, date: new Date(now - 86400000 * 3).toISOString().slice(0,10), kwhProduced: 45.0, kwhUsedOnFarm: 20.0, kwhAvailableForSale: 25.0, carbonOffsetKg: parseFloat((45.0 * this.carbonFactorKgPerKwh).toFixed(2)), simulatedBlockchainRecord: 'tx_log_demo4' },
        ];

        const demoAgrovoltaicsSetups = [
            { id: 'agro_demo1_f1', farmerWallet: demoFarmer1, setupName: 'Berry Solar Cover', areaSize: 1.5, cropType: 'Blueberries', solarAssetId: 'solar_asset_demo2_f1', videoCid: validVideoCID, notes: 'Panels 3m high, allows tractor access.', simulatedBlockchainRecord: 'tx_agro_demo1', createdAt: new Date(now - month).toISOString() },
            { id: 'agro_demo2_f2', farmerWallet: demoFarmer2, setupName: 'Lettuce Solar Shade', areaSize: 0.2, cropType: 'Romaine Lettuce', solarAssetId: 'solar_asset_demo1_f2', videoCid: null, notes: 'Simple elevated structure.', simulatedBlockchainRecord: 'tx_agro_demo2', createdAt: new Date(now - 2*week).toISOString() },
        ];

         const demoCertifications = [
            { id: 'cert_demo1_f1', farmerWallet: demoFarmer1, type: 'Carbon Offset Certificate', issueDate: new Date(now - month).toLocaleDateString(), totalOffsetKg: 500, notes: 'Offset from 2023 production.', simulatedBlockchainRecord: 'tx_cert_demo1', createdAt: new Date(now - month).toISOString() },
         ];

         const demoEnergyMarketListings = [
             { id: 'energy_lst_demo1_f1', farmerWallet: demoFarmer1, solarAssetId: 'solar_asset_demo1_f1', initialKwhToSell: 50, kwhAvailable: 40, pricePerKwhSOL: 0.006, status: 'active', createdAt: new Date(now - day).toISOString(), simulatedBlockchainRecord: 'tx_energy_lst_demo1' },
             { id: 'energy_lst_demo2_f2', farmerWallet: demoFarmer2, solarAssetId: 'solar_asset_demo1_f2', initialKwhToSell: 20, kwhAvailable: 20, pricePerKwhSOL: 0.007, status: 'active', createdAt: new Date(now - 2*day).toISOString(), simulatedBlockchainRecord: 'tx_energy_lst_demo2' },
             { id: 'energy_lst_demo3_f1', farmerWallet: demoFarmer1, solarAssetId: 'solar_asset_demo2_f1', initialKwhToSell: 10, kwhAvailable: 0, pricePerKwhSOL: 0.0055, status: 'sold', createdAt: new Date(now - 3*day).toISOString(), simulatedBlockchainRecord: 'tx_energy_lst_demo3' },
         ];

         const demoEnergyTrades = [
             { id: 'energy_trade_demo1', buyerWallet: demoInvestor1, farmerWallet: demoFarmer1, listingId: 'energy_lst_demo3_f1', kwhAmount: 10, pricePerKwhSOL: 0.0055, totalAmountSOL: 0.055, tradeDate: new Date(now - 3*day).toLocaleDateString(), simulatedBlockchainRecord: 'tx_energy_trade_demo1' },
         ];
         demoEnergyTrades.forEach(trade => {
             if (trade.buyerWallet.startsWith('oid_investor_') || trade.buyerWallet.startsWith('sol_investor_')) {
                  demoInvestorTransactions.push({
                      id: 'tx_etrade_' + trade.id, investorWallet: trade.buyerWallet, txHash: trade.simulatedBlockchainRecord,
                      type: 'energy_trade', amount: -trade.totalAmountSOL, date: trade.tradeDate,
                      notes: `Bought ${trade.kwhAmount} kWh from ${this.getFarmerDisplayIdentifier(trade.farmerWallet)}`
                  });
             }
         });
         // NEW Advanced AgriSolar Demo Data
        const demoAdvancedEnergySources = [
            { id: 'adv_solar_f1_main', farmerWallet: demoFarmer1, type: 'solar', name: 'Main Farm Array', capacityKW: 50, installationDate: '2023-05-10', notes: 'Primary solar source, bifacial panels.', solarPanelType: 'Bifacial Silicon', blockchainTx: 'sim_tx_adv_solar1', createdAt: new Date(now - 2*month).toISOString() },
            { id: 'adv_wind_f1_west', farmerWallet: demoFarmer1, type: 'wind', name: 'West Hill Turbine', capacityKW: 25, installationDate: '2023-08-20', notes: 'VAWT model for lower wind speeds.', windTurbineModel: 'VAWT 25kW', blockchainTx: 'sim_tx_adv_wind1', createdAt: new Date(now - month).toISOString() },
            { id: 'adv_biomass_f2_digester', farmerWallet: demoFarmer2, type: 'biomass', name: 'Cow Manure Digester', capacityKW: 15, // Effective electrical capacity from biogas
              installationDate: '2022-11-01', notes: 'Produces biogas for generator and heating.', blockchainTx: 'sim_tx_adv_biomass1', createdAt: new Date(now - 3*month).toISOString() },
        ];

        const demoIoTDevices = [
            { id: 'iot_soil_f1_north', farmerWallet: demoFarmer1, type: 'env_sensor', name: 'North Field Soil Sensor', location: 'North Field - Sector A', status: 'active', lastReading: {value: 65, unit: '%RH', timestamp: new Date(now - 2*60*60*1000).toISOString()}, batteryLevel: 88, blockchainTx: 'sim_tx_iot_soil1', createdAt: new Date(now - week).toISOString() },
            { id: 'iot_drone_f1_main', farmerWallet: demoFarmer1, type: 'drone', name: 'AgriDrone Alpha', location: 'Main Hangar', status: 'idle', batteryLevel: 95, blockchainTx: 'sim_tx_iot_drone1', createdAt: new Date(now - 2*week).toISOString() },
            { id: 'iot_weather_f2_central', farmerWallet: demoFarmer2, type: 'weather_station', name: 'Central Weather Station', location: 'Farm Center', status: 'active', lastReading: {value: 22, unit: 'C', timestamp: new Date(now - 30*60*1000).toISOString()}, batteryLevel: 100, blockchainTx: 'sim_tx_iot_weather1', createdAt: new Date(now - month).toISOString() },
        ];
        const demoSimulatedSmartSystems = {
            irrigation: [
              {id: 'irr_sys_f1_main', farmerWallet: demoFarmer1, name: 'Main Field Drip (Smart)', type: 'Drip Irrigation', powerSource: 'Main Farm Array (Solar)', status: 'idle', blockchainTx: 'sim_tx_smrt_irr1', createdAt: new Date(now - month).toISOString()},
              {id: 'irr_sys_f2_gh', farmerWallet: demoFarmer2, name: 'Greenhouse Sprinklers (Smart)', type: 'Overhead Sprinkler', powerSource: 'Greenhouse Rooftop (Solar)', status: 'active', blockchainTx: 'sim_tx_smrt_irr2', createdAt: new Date(now - 2*week).toISOString()}
            ],
            greenhouse: [
              {id: 'gh_sys_f2_hydro', farmerWallet: demoFarmer2, name: 'Hydroponics Climate Control (Smart)', features: ['HVAC', 'LED Lighting'], powerSource: 'Greenhouse Rooftop (Solar)', status: 'active', blockchainTx: 'sim_tx_smrt_gh1', createdAt: new Date(now - week).toISOString()}
            ]
        };

        const minToMs = (min) => 1000 * 60 * min;
        const conv1Id = 'conv_demo_f1_i1';
        const conv2Id = 'conv_demo_f1_b1';
        const conv3Id = 'conv_demo_f2_i1';

        const demoConversations = [
             { id: conv1Id, participants: [demoFarmer1, demoInvestor1].sort(), lastMessageSnippet: 'Sounds good, will review the project terms tonight.', lastMessageTimestamp: new Date(now - minToMs(5)).toISOString() },
             { id: conv2Id, participants: [demoFarmer1, demoBuyer1].sort(), lastMessageSnippet: 'Yes, the tomatoes are still available. Price is negotiable within the range.', lastMessageTimestamp: new Date(now - minToMs(20)).toISOString() },
             { id: conv3Id, participants: [demoFarmer2, demoInvestor1].sort(), lastMessageSnippet: 'Thanks for the info, I\'ll consider the lettuce project!', lastMessageTimestamp: new Date(now - minToMs(15)).toISOString() },
        ];
        const demoMessages = [
             { id: 'msg_demo1a', conversationId: conv1Id, sender: demoFarmer1, receiver: demoInvestor1, text: 'Hi Investor, thanks for showing interest in the Strawberry Expansion project. Let me know if you have questions.', timestamp: new Date(now - minToMs(10)).toISOString(), read: true },
             { id: 'msg_demo1b', conversationId: conv1Id, sender: demoInvestor1, receiver: demoFarmer1, text: 'Hello Farmer! Yes, the project looks promising. What are the projected returns again?', timestamp: new Date(now - minToMs(8)).toISOString(), read: true },
             { id: 'msg_demo1c', conversationId: conv1Id, sender: demoFarmer1, receiver: demoInvestor1, text: 'We are projecting an 18% ROI over 6 months, with a 20% profit share for investors.', timestamp: new Date(now - minToMs(6)).toISOString(), read: true },
             { id: 'msg_demo1d', conversationId: conv1Id, sender: demoInvestor1, receiver: demoFarmer1, text: 'Sounds good, will review the project terms tonight.', timestamp: new Date(now - minToMs(5)).toISOString(), read: false },
             { id: 'msg_demo2a', conversationId: conv2Id, sender: demoBuyer1, receiver: demoFarmer1, text: 'Are the tomatoes still available?', timestamp: new Date(now - minToMs(30)).toISOString(), read: true },
             { id: 'msg_demo2b', conversationId: conv2Id, sender: demoFarmer1, receiver: demoBuyer1, text: 'Yes, they are. Interested in discussing the price?', timestamp: new Date(now - minToMs(25)).toISOString(), read: true },
             { id: 'msg_demo2c', conversationId: conv2Id, sender: demoBuyer1, receiver: demoFarmer1, text: 'Yes, what\'s the best price you can do for a bulk order?', timestamp: new Date(now - minToMs(22)).toISOString(), read: true },
             { id: 'msg_demo2d', conversationId: conv2Id, sender: demoFarmer1, receiver: demoBuyer1, text: 'Yes, the tomatoes are still available. Price is negotiable within the range.', timestamp: new Date(now - minToMs(20)).toISOString(), read: false },
             { id: 'msg_demo3a', conversationId: conv3Id, sender: demoInvestor1, receiver: demoFarmer2, text: 'Hi Farmer Bob, I saw your Hydroponic Lettuce project. Looks interesting!', timestamp: new Date(now - minToMs(18)).toISOString(), read: true },
             { id: 'msg_demo3b', conversationId: conv3Id, sender: demoFarmer2, receiver: demoInvestor1, text: 'Thanks Charlie! Happy to answer any questions you have.', timestamp: new Date(now - minToMs(17)).toISOString(), read: true },
             { id: 'msg_demo3c', conversationId: conv3Id, sender: demoInvestor1, receiver: demoFarmer2, text: 'Thanks for the info, I\'ll consider the lettuce project!', timestamp: new Date(now - minToMs(15)).toISOString(), read: false },
        ];
        const demoAvatarChatMessages = [
             { id: 'avatar_demo_greet_1', sender: 'bot', text: "Hi! I'm PestiVid Helper. How can I assist you today?", timestamp: new Date(now - minToMs(1)).toISOString(), readByUser: true }
        ];
         const demoNotifications = [];


        localStorage.setItem('pestiVidAppData', JSON.stringify({
            allListings: this.allListings,
            allFundingRequests: this.allFundingRequests,
            farmerVideos: demoFarmerVideos,
            buyerPurchases: demoBuyerPurchases,
            investorInvestments: demoInvestorInvestments,
            investorTransactions: demoInvestorTransactions,
            messages: demoMessages,
            conversations: demoConversations,
            avatarChatMessages: demoAvatarChatMessages,
            farmerSolarAssets: demoFarmerSolarAssets, // Legacy
            solarEnergyProductionLogs: demoSolarEnergyProductionLogs, // Legacy
            farmerAgrovoltaicsSetups: demoAgrovoltaicsSetups,
            farmerCertifications: demoCertifications,
            energyMarketListings: demoEnergyMarketListings,
            energyTrades: demoEnergyTrades,
            advancedEnergySources: demoAdvancedEnergySources, // New
            iotDevices: demoIoTDevices, // New
            simulatedSmartSystems: demoSimulatedSmartSystems, // New
            notifications: demoNotifications,
        }));

        const demoProfiles = {};
        demoProfiles[demoFarmer1] = { role: 'farmer', name: 'Alice Farmer (OID)', email: this.simulateUserEmail(demoFarmer1), phone: '555-0101', memberSince: this.simulateMemberSince(demoFarmer1), authMethod: 'orangeId'};
        demoProfiles[demoFarmer2] = { role: 'farmer', name: 'Bob Farmer (SOL)', email: this.simulateUserEmail(demoFarmer2), phone: '555-0102', memberSince: this.simulateMemberSince(demoFarmer2), authMethod: 'solana'};
        demoProfiles[demoInvestor1] = { role: 'investor', name: 'Charlie Investor (OID)', email: this.simulateUserEmail(demoInvestor1), phone: '555-0103', memberSince: this.simulateMemberSince(demoInvestor1), authMethod: 'orangeId'};
        demoProfiles[demoBuyer1] = { role: 'buyer', name: 'Dana Buyer (SOL)', email: this.simulateUserEmail(demoBuyer1), phone: '555-0104', memberSince: this.simulateMemberSince(demoBuyer1), authMethod: 'solana'};
        demoProfiles[demoInvestor2] = { role: 'investor', name: 'Eve Investor (OID)', email: this.simulateUserEmail(demoInvestor2), phone: '555-0105', memberSince: this.simulateMemberSince(demoInvestor2), authMethod: 'orangeId'};
        demoProfiles[demoBuyer2] = { role: 'buyer', name: 'Frank Buyer (SOL)', email: this.simulateUserEmail(demoBuyer2), phone: '555-0106', memberSince: this.simulateMemberSince(demoBuyer2), authMethod: 'solana'};

        localStorage.setItem('pestiVidUserProfiles', JSON.stringify(demoProfiles));
        this.filterDataForCurrentUser();
        console.log("PestiVid Demo Data Loaded/Refreshed.");
      },
      scrollToAndHighlightAgriStreamVideo() { if (!this.targetAgriStreamVideoCid) return; this.highlightedAgriStreamVideoCid = this.targetAgriStreamVideoCid; this.$nextTick(() => { const videoCardRef = this.$refs[`videoCard-${this.targetAgriStreamVideoCid}`]; if (videoCardRef && videoCardRef[0]) { videoCardRef[0].scrollIntoView({ behavior: 'smooth', block: 'center' }); setTimeout(() => { this.highlightedAgriStreamVideoCid = null; this.targetAgriStreamVideoCid = null; }, 2500); } else { this.highlightedAgriStreamVideoCid = null; this.targetAgriStreamVideoCid = null; } }); },
      getOtherParticipantInitial(conv) { if (!conv || !this.isUserAuthenticated) return '?'; const otherP = conv.participants.find(p => p !== this.currentUserIdentifier); if (!otherP) return '?'; const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles')) || {}; const otherPProfile = userProfiles[otherP]; if (otherPProfile && otherPProfile.name) return otherPProfile.name.charAt(0).toUpperCase(); return otherP.charAt(0).toUpperCase(); },
      getOtherParticipantDisplayAddress(conv) { if (!conv || !this.isUserAuthenticated) return '?'; const otherP = conv.participants.find(p => p !== this.currentUserIdentifier); if (!otherP) return '?'; const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles')) || {}; const otherPProfile = userProfiles[otherP]; if (otherPProfile && otherPProfile.name) return otherPProfile.name.split(' ')[0]; return `${otherP.substring(0,6)}...${otherP.substring(otherP.length-4)}`; },
      formatTimestamp(isoString, short = false) { if (!isoString) return ''; const date = new Date(isoString); const now = new Date(); const diffSeconds = Math.round((now - date) / 1000); const diffMinutes = Math.round(diffSeconds / 60); const diffHours = Math.round(diffMinutes / 60); const diffDays = Math.round(diffHours / 24); if (short) { if (diffMinutes < 1) return 'now'; if (diffMinutes < 60) return `${diffMinutes}m`; if (diffHours < 24) return `${diffHours}h`; if (diffDays < 7) return date.toLocaleDateString(undefined, { weekday: 'short' }).substring(0,3); return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }); } else { if (diffMinutes < 2) return 'Just now'; if (diffMinutes < 60) return `${diffMinutes} minutes ago`; if (diffHours < 24) return date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }); return date.toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' }) + ' ' + date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }); } },
      handlePlantImageUpload(event) { const file = event.target.files[0]; if (file) { this.plantImageFile = file; this.plantImageMimeType = file.type; this.plantImageUrl = URL.createObjectURL(file); this.analysisResultText = ''; this.parsedAnalysis = { plantName: null, diseaseName: null, treatmentRecommended: null }; this.analysisErrorText = ''; } },
      convertFileToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => { resolve(reader.result.split(',')[1]); }; reader.onerror = error => reject(error); }); },
      async analyzePlant() { if (!this.plantImageFile) { this.analysisErrorText = "Please upload an image first."; return; } if (this.geminiApiKey === 'YOUR_GEMINI_API_KEY_REPLACE_HERE' || !this.geminiApiKey || this.geminiApiKey.length < 30) { this.analysisErrorText = "Gemini API key is missing or invalid. Please configure it in the script."; return; } this.analysisInProgress = true; this.analysisResultText = ''; this.parsedAnalysis = { plantName: null, diseaseName: null, treatmentRecommended: null }; this.analysisErrorText = ''; try { const base64Image = await this.convertFileToBase64(this.plantImageFile); const apiKey = this.geminiApiKey; const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`; const prompt = `Analyze this image of a plant. Identify the plant if possible, then detect any visible diseases. Based on your findings, provide the following information, each on a new line, formatted exactly as: Plant: [Plant Name or 'Unknown'] Disease: [Disease Name or 'Healthy' or 'Not Apparent' or 'Unknown'] Treatment: [Recommended treatment and/or types of pesticides. If healthy, state 'No treatment needed'. If disease is not apparent or unknown, state 'Cannot recommend treatment without clear disease identification.']. Be concise and focus on actionable recommendations. If the image is not clear or not a plant, state that.`; const payload = { contents: [{ parts: [ { text: prompt }, { inline_data: { mime_type: this.plantImageMimeType, data: base64Image } } ] }], generationConfig: { "temperature": 0.4, "topK": 32, "topP": 1, "maxOutputTokens": 2048, }, safetySettings: [ { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_MEDIUM_AND_ABOVE" }, { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_MEDIUM_AND_ABOVE" }, { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_MEDIUM_AND_ABOVE" }, { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_MEDIUM_AND_ABOVE" } ] }; const response = await axios.post(url, payload); if (response.data && response.data.candidates && response.data.candidates.length > 0 && response.data.candidates[0].content && response.data.candidates[0].content.parts && response.data.candidates[0].content.parts.length > 0 && response.data.candidates[0].content.parts[0].text) { this.analysisResultText = response.data.candidates[0].content.parts[0].text; this.parseGeminiResponse(this.analysisResultText); } else if (response.data && response.data.promptFeedback && response.data.promptFeedback.blockReason) { this.analysisErrorText = `Analysis blocked by API: ${response.data.promptFeedback.blockReason}. The image or prompt may have violated safety guidelines.`; this.parsedAnalysis = { plantName: 'Blocked', diseaseName: 'Blocked', treatmentRecommended: 'Blocked by API' }; } else { console.error("Unexpected response structure from Gemini API:", response.data); throw new Error("Invalid or empty response structure from Gemini API."); } } catch (error) { console.error("Error analyzing plant image with Gemini:", error); if (error.response) { this.analysisErrorText = `Gemini API Error: ${error.response.status}. ${error.response.data?.error?.message || 'Failed to get details.'}`; if(error.response.status === 400 && error.response.data?.error?.message.toLowerCase().includes("api key not valid")) { this.analysisErrorText += " Please check if the API key is correct and enabled for the Generative Language API in your Google Cloud Project."; } else if (error.response.status === 429) { this.analysisErrorText += " You might have exceeded your API quota."; } } else if (error.request) { this.analysisErrorText = "Network error: Could not reach Gemini API. Check your internet connection."; } else { this.analysisErrorText = "An unexpected error occurred: " + error.message; } this.parsedAnalysis = { plantName: '-', diseaseName: '-', treatmentRecommended: '-' }; } finally { this.analysisInProgress = false; } },
      parseGeminiResponse(text) { const result = { plantName: 'Unknown', diseaseName: 'Not Apparent', treatmentRecommended: 'Could not determine specific treatment.' }; if (!text) { this.parsedAnalysis = result; return; } const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0); let currentPlant = null; let currentDisease = null; let currentTreatment = []; lines.forEach(line => { const lowerLine = line.toLowerCase(); if (lowerLine.startsWith('plant:')) { currentPlant = line.substring('plant:'.length).trim(); } else if (lowerLine.startsWith('disease:')) { currentDisease = line.substring('disease:'.length).trim(); } else if (lowerLine.startsWith('treatment:')) { currentTreatment.push(line.substring('treatment:'.length).trim()); } else if (currentTreatment.length > 0) { currentTreatment.push(line); } else if (currentDisease && !currentTreatment.length > 0) { currentTreatment.push(line); } else if (currentPlant && !currentDisease && !currentTreatment.length > 0) { if (lowerLine.includes("healthy") || lowerLine.includes("not apparent") || lowerLine.includes("unknown disease")) { currentDisease = line; } } }); if (currentPlant) result.plantName = currentPlant; if (currentDisease) result.diseaseName = currentDisease; if (currentTreatment.length > 0) result.treatmentRecommended = currentTreatment.join('\n'); if (result.plantName === 'Unknown' && result.diseaseName === 'Not Apparent' && result.treatmentRecommended === 'Could not determine specific treatment.') { const plantMatch = text.match(/Plant:\s*(.*)/i); const diseaseMatch = text.match(/Disease:\s*(.*)/i); const treatmentMatch = text.match(/Treatment:\s*(.*?)(?:\n|$)/is); if (plantMatch && plantMatch[1]) result.plantName = plantMatch[1].trim(); if (diseaseMatch && diseaseMatch[1]) result.diseaseName = diseaseMatch[1].trim(); if (treatmentMatch && treatmentMatch[1]) result.treatmentRecommended = treatmentMatch[1].trim(); } this.parsedAnalysis = result; },

      // AgriSolar Methods (Legacy and New Combined)
      switchAgriSolarTab(tabName) {
          this.currentAgriSolarTab = tabName;
      },
      async registerSolarAsset() { // Legacy Solar Asset
          if (!this.isUserAuthenticated || this.role !== 'farmer') { this.addNotification("You must be logged in as a farmer.", "error"); return; }
          if (!this.newSolarAssetForm.assetName || this.newSolarAssetForm.capacityKW == null || this.newSolarAssetForm.installationDate === '') { this.addNotification("Please fill in Asset Name, Capacity, and Installation Date.", "warning"); return; }
          if (parseFloat(this.newSolarAssetForm.capacityKW) <= 0) { this.addNotification("Capacity must be a positive number.", "warning"); return; }
          const simulatedTx = await this.simulateTransaction("Registering Legacy Solar Asset");
          const newAsset = {
              id: 'solar_asset_' + Date.now(), farmerWallet: this.currentUserIdentifier, assetName: this.newSolarAssetForm.assetName.trim(), capacityKW: parseFloat(this.newSolarAssetForm.capacityKW), installationDate: this.newSolarAssetForm.installationDate, notes: this.newSolarAssetForm.notes.trim(), simulatedBlockchainRecord: simulatedTx
          };
          this.farmerSolarAssets.unshift(newAsset);
          this.addNotification(`Legacy Solar asset "${newAsset.assetName}" registered.`, "success");
          this.newSolarAssetForm = { assetName: '', capacityKW: null, installationDate: '', notes: '' };
          this.saveDataToLocalStorage();
      },
      async logEnergyProduction() { // Legacy Solar Log
          if (!this.isUserAuthenticated || this.role !== 'farmer') { this.addNotification("You must be logged in as a farmer.", "error"); return; }
          const form = this.newEnergyLogForm;
          if (!form.solarAssetId || !form.date || form.kwhProduced == null || form.kwhUsedOnFarm == null) { this.addNotification("Please select an asset and fill in Date, kWh Produced, and kWh Used on Farm.", "warning"); return; }
          if (parseFloat(form.kwhProduced) < 0 || parseFloat(form.kwhUsedOnFarm) < 0) { this.addNotification("kWh values must be non-negative.", "warning"); return; }
          if (parseFloat(form.kwhUsedOnFarm) > parseFloat(form.kwhProduced)) { this.addNotification("kWh Used on Farm cannot exceed kWh Produced.", "error"); return; }
          const simulatedTx = await this.simulateTransaction("Logging Legacy Solar Production");
          const kwhProduced = parseFloat(form.kwhProduced);
          const carbonOffset = kwhProduced * this.carbonFactorKgPerKwh;
          const newLog = {
              id: 'energy_log_' + Date.now(), solarAssetId: form.solarAssetId, farmerWallet: this.currentUserIdentifier, date: form.date, kwhProduced: kwhProduced, kwhUsedOnFarm: parseFloat(form.kwhUsedOnFarm), kwhAvailableForSale: kwhProduced - parseFloat(form.kwhUsedOnFarm), carbonOffsetKg: parseFloat(carbonOffset.toFixed(2)), simulatedBlockchainRecord: simulatedTx
          };
          this.solarEnergyProductionLogs.unshift(newLog);
          this.addNotification(`Legacy Solar production logged. Carbon offset: ${newLog.carbonOffsetKg} kg CO2e.`, "success");
          this.newEnergyLogForm = { solarAssetId: '', date: new Date().toISOString().slice(0,10), kwhProduced: null, kwhUsedOnFarm: null };
          this.saveDataToLocalStorage();
      },
      getAssetName(assetId) {
          const legacyAsset = this.farmerSolarAssets.find(a => a.id === assetId);
          if (legacyAsset) return legacyAsset.assetName;
          const advancedAsset = this.advancedEnergySources.find(a => a.id === assetId);
          return advancedAsset ? advancedAsset.name : 'Unknown Asset';
      },
       async registerAgrovoltaicSetup() {
            if (!this.isUserAuthenticated || this.role !== 'farmer') { this.addNotification("You must be logged in as a farmer.", "error"); return; }
            const form = this.newAgrovoltaicSetupForm;
            if (!form.setupName || form.areaSize == null || !form.cropType || !form.solarAssetId) { this.addNotification("Please fill in Setup Name, Area Size, Crop Type, and select a Solar Asset.", "warning"); return; }
            if (parseFloat(form.areaSize) <= 0) { this.addNotification("Area Size must be a positive number.", "warning"); return; }
            if (form.videoCid && !this.farmerVideos.some(v => v.cid === form.videoCid && v.farmerWallet === this.currentUserIdentifier)) { this.addNotification("Selected video not found or doesn't belong to you.", "error"); return; }
             if (form.videoCid && this.isUsedInAgrovoltaics(form.videoCid)) { this.addNotification("Selected video is already used in an agrovoltaic setup.", "warning"); return; }
            const simulatedTx = await this.simulateTransaction("Registering Agrovoltaic Setup");
             const newSetup = {
                 id: 'agro_setup_' + Date.now(), farmerWallet: this.currentUserIdentifier, setupName: form.setupName.trim(), areaSize: parseFloat(form.areaSize), areaUnit: 'Acres', cropType: form.cropType.trim(), solarAssetId: form.solarAssetId, videoCid: form.videoCid || null, notes: form.notes.trim(), simulatedBlockchainRecord: simulatedTx, createdAt: new Date().toISOString(),
             };
             this.farmerAgrovoltaicsSetups.unshift(newSetup);
             this.addNotification(`Agrovoltaic setup "${newSetup.setupName}" registered.`, "success");
             this.newAgrovoltaicSetupForm = { setupName: '', areaSize: null, cropType: '', solarAssetId: '', videoCid: '', notes: ''};
             this.saveDataToLocalStorage();
       },
       async createEnergyListing() {
            if (!this.isUserAuthenticated || this.role !== 'farmer') { this.addNotification("You must be logged in as a farmer.", "error"); return; }
            const form = this.newEnergyListingForm;
            if (!form.solarAssetId || form.kwhToSell == null || form.pricePerKwhSOL == null) { this.addNotification("Please select an asset and fill in kWh to Sell and Price per kWh.", "warning"); return; }
            if (parseFloat(form.kwhToSell) <= 0 || parseFloat(form.pricePerKwhSOL) <= 0) { this.addNotification("kWh to Sell and Price must be positive numbers.", "warning"); return; }
             const availableFromLogs = this.solarEnergyProductionLogs.filter(log => log.solarAssetId === form.solarAssetId && log.farmerWallet === this.currentUserIdentifier).reduce((sum, log) => sum + (log.kwhAvailableForSale || 0), 0);
             const alreadyListedAvailable = this.farmerEnergyListings.filter(listing => listing.solarAssetId === form.solarAssetId && listing.status === 'active').reduce((sum, listing) => sum + (listing.kwhAvailable || 0), 0);
             const actualAvailable = availableFromLogs - alreadyListedAvailable;
            if (parseFloat(form.kwhToSell) > actualAvailable + 0.01) { this.addNotification(`You only have ${actualAvailable.toFixed(2)} kWh available to list from this asset's logs.`, "warning"); return; }
            const simulatedTx = await this.simulateTransaction("Creating Energy Listing");
            const newListing = {
                id: 'energy_lst_' + Date.now(), farmerWallet: this.currentUserIdentifier, solarAssetId: form.solarAssetId, initialKwhToSell: parseFloat(form.kwhToSell), kwhAvailable: parseFloat(form.kwhToSell), pricePerKwhSOL: parseFloat(form.pricePerKwhSOL), status: 'active', createdAt: new Date().toISOString(), simulatedBlockchainRecord: simulatedTx,
            };
            this.energyMarketListings.unshift(newListing);
            this.farmerEnergyListings.unshift(newListing);
            this.addNotification(`Energy listing created: ${newListing.initialKwhToSell.toFixed(2)} kWh from ${this.getAssetName(newListing.solarAssetId)}.`, "success");
            this.addNotification(`New Energy Listing: ${newListing.initialKwhToSell.toFixed(2)} kWh from ${this.getFarmerDisplayIdentifier(newListing.farmerWallet)}.`, 'info', null, true);
            this.newEnergyListingForm = { solarAssetId: '', kwhToSell: null, pricePerKwhSOL: null};
            this.saveDataToLocalStorage();
       },
       initiateEnergyPurchase(listing) {
           if (!this.isUserAuthenticated) { alert("Please log in to buy energy."); this.switchPage('loginChoice'); return; }
           this.selectedEnergyListing = listing;
           this.energyPurchaseAmountKwh = listing.kwhAvailable;
           this.energyPurchaseStatus = ''; this.energyPurchaseError = '';
           this.showEnergyBuyModal = true;
       },
       closeEnergyBuyModal() {
            this.showEnergyBuyModal = false; this.selectedEnergyListing = null; this.energyPurchaseAmountKwh = null; this.energyPurchaseStatus = ''; this.energyPurchaseError = '';
       },
       async processEnergyPurchase() {
            if (!this.isUserAuthenticated || !this.selectedEnergyListing || this.energyPurchaseAmountKwh == null) return;
            this.energyPurchaseStatus = ''; this.energyPurchaseError = '';
            const amountKwh = parseFloat(this.energyPurchaseAmountKwh);
            const availableKwh = this.selectedEnergyListing.kwhAvailable;
            const pricePerKwh = this.selectedEnergyListing.pricePerKwhSOL;
             if (isNaN(amountKwh) || amountKwh <= 0 || amountKwh > availableKwh + 0.001) { this.energyPurchaseError = `Enter a valid amount (max ${availableKwh.toFixed(2)} kWh).`; return; }
             const preciseAmountKwh = parseFloat(amountKwh.toFixed(2));
             const totalAmountSOL = parseFloat((preciseAmountKwh * pricePerKwh).toFixed(4));
             const txHash = await this.simulateTransaction(`Purchasing ${preciseAmountKwh} kWh energy`);
             if (!txHash) { this.energyPurchaseError = "Energy Purchase Tx failed."; this.energyPurchaseStatus = ''; return; }
             this.energyPurchaseStatus = `Processing purchase of ${preciseAmountKwh} kWh for ${totalAmountSOL} SOL... Tx: ${txHash.substring(0,10)}...`;
             try {
                 const listingIndex = this.energyMarketListings.findIndex(l => l.id === this.selectedEnergyListing.id);
                 if (listingIndex > -1) {
                     const updatedListing = { ...this.energyMarketListings[listingIndex] };
                     updatedListing.kwhAvailable = parseFloat((updatedListing.kwhAvailable - preciseAmountKwh).toFixed(2));
                     if (updatedListing.kwhAvailable <= 0.001) { updatedListing.status = 'sold'; updatedListing.kwhAvailable = 0; }
                     this.$set(this.energyMarketListings, listingIndex, updatedListing);
                 }
                 const farmerListingIndex = this.farmerEnergyListings.findIndex(l => l.id === this.selectedEnergyListing.id);
                 if (farmerListingIndex > -1) { this.$set(this.farmerEnergyListings, farmerListingIndex, this.energyMarketListings[listingIndex]); }
                 const newTrade = {
                     id: 'energy_trade_' + Date.now(), buyerWallet: this.currentUserIdentifier, farmerWallet: this.selectedEnergyListing.farmerWallet, listingId: this.selectedEnergyListing.id, solarAssetId: this.selectedEnergyListing.solarAssetId, kwhAmount: preciseAmountKwh, pricePerKwhSOL: pricePerKwh, totalAmountSOL: totalAmountSOL, tradeDate: new Date().toLocaleDateString(), simulatedBlockchainRecord: txHash,
                 };
                 this.energyTrades.unshift(newTrade);
                 this.investorTransactions.unshift({
                     id: 'tx_etrade_' + newTrade.id, investorWallet: newTrade.buyerWallet, txHash: newTrade.simulatedBlockchainRecord, type: 'energy_trade', amount: -newTrade.totalAmountSOL, date: newTrade.tradeDate, notes: `Bought ${newTrade.kwhAmount} kWh from ${this.getFarmerDisplayIdentifier(newTrade.farmerWallet)}`
                 });
                 this.investorTransactions.unshift({
                      id: 'tx_esell_' + newTrade.id, investorWallet: newTrade.farmerWallet, txHash: newTrade.simulatedBlockchainRecord, type: 'energy_trade', amount: newTrade.totalAmountSOL, date: newTrade.tradeDate, notes: `Sold ${newTrade.kwhAmount} kWh to ${this.getFarmerDisplayIdentifier(newTrade.buyerWallet)}`
                  });
                 this.investorTransactions.sort((a,b) => new Date(b.date) - new Date(a.date));
                 this.addNotification(`Purchased ${preciseAmountKwh} kWh for ${totalAmountSOL} SOL!`, 'success');
                 this.addNotification(`SIM: Energy Sold! ${preciseAmountKwh} kWh bought by ${this.getFarmerDisplayIdentifier(this.currentUserIdentifier)}.`, 'success', newTrade.farmerWallet);
                 this.energyPurchaseStatus = "Purchase successful!";
                 this.saveDataToLocalStorage();
                 setTimeout(() => { this.closeEnergyBuyModal(); }, 2500);
             } catch(err) { console.error("Energy purchase sim failed:", err); this.energyPurchaseError = "Energy purchase sim failed."; this.energyPurchaseStatus = ''; }
       },
       async requestCarbonOffsetCertificate() {
            if (!this.isUserAuthenticated || this.role !== 'farmer') { this.addNotification("You must be logged in as a farmer.", "error"); return; }
            if (this.requestCertInProgress) return;
            const totalOffset = this.farmerTotalCarbonOffsetKg;
            if (totalOffset < 100) { this.addNotification(`You need at least 100 kg of simulated CO offset to request a certificate. Current: ${totalOffset.toFixed(2)} kg.`, "warning"); return; }
            const existingCert = this.farmerCertifications.find(c => c.farmerWallet === this.currentUserIdentifier && Math.abs(c.totalOffsetKg - totalOffset) < 10);
            if (existingCert) { this.addNotification("You have already requested a certificate for a similar offset amount.", "info"); return; }
            this.requestCertInProgress = true;
            const simulatedTx = await this.simulateTransaction(`Requesting Carbon Offset Certificate for ${totalOffset.toFixed(2)} kg`);
            const newCert = {
                id: 'cert_' + Date.now(), farmerWallet: this.currentUserIdentifier, type: 'PestiVid Carbon Offset Certificate', issueDate: new Date().toLocaleDateString(), totalOffsetKg: totalOffset, notes: `Represents estimated CO offset based on logged solar energy production up to ${new Date().toLocaleDateString()}.`, simulatedBlockchainRecord: simulatedTx, createdAt: new Date().toISOString(),
            };
            this.farmerCertifications.unshift(newCert);
            this.addNotification(`Simulated Carbon Offset Certificate issued for ${totalOffset.toFixed(2)} kg CO offset!`, "success");
            this.requestCertInProgress = false;
            this.saveDataToLocalStorage();
       },
       // New Advanced AgriSolar Methods
        async registerNewEnergySource() {
            if (!this.isUserAuthenticated || this.role !== 'farmer') { this.addNotification("You must be logged in as a farmer.", "error"); return; }
            const form = this.newEnergySourceForm;
            if (!form.type || !form.name || form.capacityKW == null || !form.installationDate) {
                this.addNotification("Please fill Source Type, Name, Capacity, and Installation Date.", "warning"); return;
            }
            if (parseFloat(form.capacityKW) <= 0) { this.addNotification("Capacity must be positive.", "warning"); return; }

            const simulatedTx = await this.simulateTransaction(`Registering ${form.type} source: ${form.name}`);
            const newSource = {
                id: `${form.type}_${Date.now()}`,
                farmerWallet: this.currentUserIdentifier,
                type: form.type,
                name: form.name.trim(),
                capacityKW: parseFloat(form.capacityKW),
                installationDate: form.installationDate,
                notes: form.notes.trim(),
                solarPanelType: form.type === 'solar' ? form.solarPanelType : undefined,
                windTurbineModel: form.type === 'wind' ? form.windTurbineModel : undefined,
                blockchainTx: simulatedTx,
                createdAt: new Date().toISOString(),
            };
            this.advancedEnergySources.unshift(newSource);
            this.addNotification(`${form.type.charAt(0).toUpperCase() + form.type.slice(1)} source "${newSource.name}" registered.`, "success");
            this.newEnergySourceForm = { type: '', name: '', capacityKW: null, installationDate: new Date().toISOString().slice(0,10), notes: '', solarPanelType: '', windTurbineModel: '' };
            this.saveDataToLocalStorage();
        },
        async registerNewIoTDevice() {
            if (!this.isUserAuthenticated || this.role !== 'farmer') { this.addNotification("You must be logged in as a farmer.", "error"); return; }
            const form = this.newIoTDeviceForm;
            if (!form.type || !form.name) { this.addNotification("Please fill Device Type and Name.", "warning"); return; }

            const simulatedTx = await this.simulateTransaction(`Registering IoT Device: ${form.name}`);
            const newDevice = {
                id: `iot_${form.type}_${Date.now()}`,
                farmerWallet: this.currentUserIdentifier,
                type: form.type,
                name: form.name.trim(),
                location: form.location.trim() || 'N/A',
                status: 'active',
                lastReading: null, // Will be simulated by startSensorSimulation
                batteryLevel: 100,
                blockchainTx: simulatedTx,
                createdAt: new Date().toISOString(),
            };
            this.iotDevices.unshift(newDevice);
            this.startSensorSimulation(newDevice.id); // Start simulation for the new device
            this.addNotification(`IoT Device "${newDevice.name}" registered.`, "success");
            this.newIoTDeviceForm = { type: 'env_sensor', name: '', location: '' };
            this.saveDataToLocalStorage();
        },
        startSensorSimulation(deviceId) { // Call this when a new sensor is registered or on load
            const device = this.iotDevices.find(d => d.id === deviceId);
            if (!device || !['env_sensor', 'weather_station'].includes(device.type)) return;

            const updateReading = () => {
                let value, unit;
                if (device.type === 'env_sensor') { // Simulate soil moisture
                    value = Math.floor(Math.random() * 60) + 20; // 20-80%
                    unit = '%RH';
                } else { // Simulate temperature for weather station
                    value = Math.floor(Math.random() * 20) + 10; // 10-30C
                    unit = 'C';
                }
                device.lastReading = { value: value, unit: unit, timestamp: new Date().toISOString() };
                device.batteryLevel = Math.max(0, device.batteryLevel - Math.random() * 0.5); // Slow battery drain
                // console.log(`Simulated reading for ${device.name}: ${value} ${unit}`);
                this.$forceUpdate(); // Ensure Vue picks up nested changes
            };
            updateReading(); // Initial reading
            device.simulationInterval = setInterval(updateReading, 30000 + Math.random() * 30000); // Update every 30-60s
        },
        getEnergySourceIcon(type) {
            const icons = { solar: 'fas fa-solar-panel text-yellow-500', wind: 'fas fa-wind text-blue-400', hydro: 'fas fa-water text-cyan-500', biomass: 'fas fa-leaf text-lime-600' };
            return icons[type] || 'fas fa-plug text-gray-500';
        },
        getIoTDeviceIcon(type) {
            const icons = { env_sensor: 'fas fa-thermometer-half text-orange-500', drone: 'fas fa-helicopter text-indigo-500', robot: 'fas fa-robot text-purple-500', weather_station: 'fas fa-cloud-sun-rain text-sky-500' };
            return icons[type] || 'fas fa-microchip text-gray-500';
        },
        controlSmartSystem(systemType, systemId, action) { // e.g., systemType 'irrigation', systemId 'irr_sys_1', action 'start'
            let systemList = this.simulatedSmartSystems[systemType];
            if (!systemList) return;
            const system = systemList.find(s => s.id === systemId && s.farmerWallet === this.currentUserIdentifier);
            if (!system) { this.addNotification("Smart system not found or not yours.", "error"); return; }

            let message = "";
            if (action === 'start') { system.status = 'active'; message = `${system.name} started.`; }
            else if (action === 'stop') { system.status = 'idle'; message = `${system.name} stopped.`; }
            else if (action === 'toggle_lights' && systemType === 'greenhouse') {
                system.status = system.status === 'lights_on' ? 'active' : 'lights_on'; // Simple toggle
                message = `${system.name} lights ${system.status === 'lights_on' ? 'ON' : 'OFF'}.`;
            } else {
                message = `Action '${action}' sent to ${system.name}. (Simulated)`;
            }
            this.addNotification(message, "info");
            this.saveDataToLocalStorage();
        },
        shareDataWithResearch(institutionName) {
            this.showLoadingModal = true;
            this.loadingMessage = `Preparing to share data with ${institutionName}... (Simulated)`;
            setTimeout(() => {
                this.loadingMessage = `Data successfully shared with ${institutionName}. Thank you for contributing! (Simulated)`;
                setTimeout(() => {
                    this.showLoadingModal = false;
                    this.addNotification(`Simulated data share with ${institutionName} successful.`, 'success');
                }, 1500);
            }, 2000);
        },
        runEnergyEfficiencyAnalysis() {
            this.loadingMessage = "Analyzing energy efficiency... (Simulated)";
            this.showLoadingModal = true;
            setTimeout(() => {
                // Simulate some data based on farmer's assets for LER calculation
                const totalCapacity = this.farmerTotalRenewableCapacityKW;
                const estimatedEnergyProd = totalCapacity * 4 * 30; // kW * 4hrs/day * 30 days
                const cropYieldFactor = 0.8 + Math.random() * 0.4; // 0.8 to 1.2
                const waterSavingsFactor = 5 + Math.random() * 25; // 5 to 30%

                this.energyAnalysisResults = {
                    LER: 1.0 + Math.random() * 0.5, // e.g., 1.0 to 1.5
                    energyEfficiency: 0.75 + Math.random() * 0.15, // e.g., 0.75 to 0.90
                    cropProductivity: cropYieldFactor,
                    waterSavings: waterSavingsFactor.toFixed(1),
                    carbonOffset: (estimatedEnergyProd * this.carbonFactorKgPerKwh * cropYieldFactor).toFixed(2) // Rough estimate
                };
                this.showLoadingModal = false;
                this.addNotification("Energy efficiency analysis complete (Simulated).", "success");
            }, 2500);
        },
        runPredictiveOptimization() {
            this.loadingMessage = "Running predictive optimization AI... (Simulated)";
            this.showLoadingModal = true;
            setTimeout(() => {
                const peakHours = ["Shift high-load tasks to 10 PM - 6 AM.", "Utilize battery storage during 5 PM - 9 PM peak."];
                const loadBalancing = ["Distribute irrigation cycles across different energy sources.", "Prioritize critical systems during low generation."];
                const storageNeeds = ["Consider adding 10-20 kWh battery storage for overnight operations.", "Explore thermal storage for heating/cooling."];
                const gridIntegration = ["Potential to sell 5-15 kWh/day to grid during sunny afternoons.", "Monitor P2P energy market for favorable rates."];

                this.predictiveOptimizationResults = {
                    peakHours: peakHours[Math.floor(Math.random() * peakHours.length)],
                    loadBalancing: loadBalancing[Math.floor(Math.random() * loadBalancing.length)],
                    storageNeeds: storageNeeds[Math.floor(Math.random() * storageNeeds.length)],
                    gridIntegration: gridIntegration[Math.floor(Math.random() * gridIntegration.length)]
                };
                this.showLoadingModal = false;
                this.addNotification("Predictive optimization insights generated (Simulated).", "success");
            }, 3000);
        },
        getProjectIconClass(projectType) {
            const icons = {
                agricultural: 'fas fa-seedling text-green-600',
                solar: 'fas fa-solar-panel text-yellow-600',
                wind: 'fas fa-wind text-blue-500',
                hydro: 'fas fa-water text-cyan-500',
                biomass: 'fas fa-leaf text-lime-600',
                smart_irrigation: 'fas fa-tint text-blue-400',
                smart_greenhouse: 'fas fa-igloo text-green-400'
            };
            return icons[projectType] || 'fas fa-tasks text-gray-500';
        },
        getFundingProjectPlaceholder(field) {
            const type = this.fundingForm.projectType;
            if (field === 'title') {
                if (type === 'solar') return 'e.g., Field Solar Array Funding';
                if (type === 'wind') return 'e.g., West Ridge Wind Turbine';
                if (type === 'smart_irrigation') return 'e.g., Smart Drip System Upgrade';
                return 'e.g., Organic Tomato Expansion';
            }
            if (field === 'description') {
                 if (type === 'solar') return 'Describe the solar project, intended use of energy, location, technology...';
                 if (type === 'wind') return 'Describe wind project, turbine type, site assessment...';
                 return 'Describe your project, growing practices, and how funds will be used...';
            }
            if (field === 'timeline') {
                 if (type.includes('solar') || type.includes('wind') || type.includes('hydro') || type.includes('biomass') || type.includes('smart')) return 'e.g., 5 (years for payback)';
                 return 'How many months until harvest?';
            }
            return '';
        },
        getFundingProjectPrimaryFieldLabel(projectType) {
            if (projectType === 'agricultural') return 'Crop';
            if (projectType === 'solar' || projectType === 'wind' || projectType === 'hydro' || projectType === 'biomass') return 'Energy Capacity';
            if (projectType === 'smart_irrigation') return 'Irrigation Type';
            if (projectType === 'smart_greenhouse') return 'Greenhouse Features';
            return 'Primary Detail';
        },
        getFundingProjectPrimaryFieldValue(project) {
            if (project.projectType === 'agricultural') return project.crop;
            if (project.projectType === 'solar' || project.projectType === 'wind' || project.projectType === 'hydro' || project.projectType === 'biomass') return `${project.energyCapacityKW || '?'} kW`;
            if (project.projectType === 'smart_irrigation') return project.irrigationType || 'N/A'; // Assuming you might add irrigationType to form
            if (project.projectType === 'smart_greenhouse') return project.greenhouseFeatures || 'N/A'; // Assuming greenhouseFeatures
            return 'N/A';
        },
        getFundingProjectSecondaryFieldLabel(projectType) {
            if (projectType === 'agricultural') return 'Land Size';
            if (projectType === 'solar' || projectType === 'wind' || projectType === 'hydro' || projectType === 'biomass') return 'Annual Yield Est.';
            return 'Secondary Detail';
        },
        getFundingProjectSecondaryFieldValue(project) {
            if (project.projectType === 'agricultural') return `${project.acres || '?'} acres`;
            if (project.projectType === 'solar' || project.projectType === 'wind' || project.projectType === 'hydro' || project.projectType === 'biomass') return project.expectedAnnualYield || 'N/A';
            return 'N/A';
        },
        getFundingProjectPrimaryDisplay(project) { // For investor project cards
            if (project.projectType === 'agricultural') return `${project.crop} (${project.method || 'N/A'})`;
            if (project.projectType.includes('solar') || project.projectType.includes('wind') || project.projectType.includes('hydro') || project.projectType.includes('biomass')) {
                return `${project.projectType.split('_').map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(' ')} Project (${project.energyCapacityKW || '?'}kW)`;
            }
            if (project.projectType.includes('smart')) {
                 return `${project.projectType.split('_').map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(' ')} System`;
            }
            return project.title;
        },
        getInvestmentPortfolioSubDisplay(investment) { // For investor portfolio table
            if (investment.projectType === 'agricultural') return investment.crop;
            if (investment.projectType.includes('solar') || investment.projectType.includes('wind') || investment.projectType.includes('hydro') || investment.projectType.includes('biomass')) {
                return `${investment.energyCapacityKW || '?'}kW ${investment.projectType.split('_').map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(' ')}`;
            }
             if (investment.projectType.includes('smart')) {
                 return `${investment.projectType.split('_').map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(' ')} System`;
            }
            return 'Project';
        },
        getPayoutTypeDisplay(projectType) {
            if (!projectType) return 'Payout';
            if (projectType.includes('solar') || projectType.includes('wind') || projectType.includes('hydro') || projectType.includes('biomass')) return 'Energy Payout';
            if (projectType.includes('smart')) return 'System Payout';
            return 'Harvest Payout';
        },

      // --- AVATAR ASSISTANT METHODS (WITH SPEECH) ---
      speakText(textToSpeak, onEndCallback = null) {
          if (!('speechSynthesis' in window)) {
              console.warn("Browser does not support Speech Synthesis. Avatar cannot speak.");
              this.avatar.state = this.avatar.expanded ? 'listening' : 'idle';
              if (onEndCallback) onEndCallback();
              return;
          }
          if (speechSynthesis.speaking) { speechSynthesis.cancel(); }
          const utterance = new SpeechSynthesisUtterance(textToSpeak);
          utterance.lang = 'en-US'; utterance.rate = 1; utterance.pitch = 1;
          const voices = speechSynthesis.getVoices();
          let selectedVoice = voices.find(voice => voice.name.includes('Google US English') || voice.name.includes('Microsoft David') || voice.name.includes('Samantha'));
          if (!selectedVoice && voices.length > 0) { selectedVoice = voices.find(voice => voice.lang.startsWith('en-US')) || voices[0]; }
          if (selectedVoice) utterance.voice = selectedVoice;
          utterance.onstart = () => { this.avatar.state = 'talking'; };
          utterance.onend = () => { this.avatar.state = this.avatar.expanded ? 'listening' : 'idle'; if (onEndCallback) onEndCallback(); };
          utterance.onerror = (event) => { console.error('SpeechSynthesisUtterance.onerror', event); this.addNotification("Avatar speech error: " + event.error, "error"); this.avatar.state = this.avatar.expanded ? 'listening' : 'idle'; if (onEndCallback) onEndCallback(); };
          speechSynthesis.speak(utterance);
      },
      initializeSpeechRecognition() {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          if (!SpeechRecognition) { this.addNotification("Speech recognition not supported in this browser.", "warning"); console.warn("STT not supported."); return; }
          if (!this.speechRecognition) {
              this.speechRecognition = new SpeechRecognition();
              this.speechRecognition.continuous = false; this.speechRecognition.interimResults = false; this.speechRecognition.lang = 'en-US';
              this.speechRecognition.onstart = () => { this.avatar.isListening = true; this.avatar.state = 'listening'; console.log("Avatar STT started."); };
              this.speechRecognition.onresult = (event) => { let transcript = ''; for (let i = event.resultIndex; i < event.results.length; ++i) { if (event.results[i].isFinal) { transcript += event.results[i][0].transcript; } } if (transcript) { this.avatar.userInput = (this.avatar.userInput ? this.avatar.userInput + ' ' : '') + transcript; } console.log("Avatar STT result:", transcript); };
              this.speechRecognition.onerror = (event) => { console.error('SpeechRecognitionError:', event.error); let errorMsg = "Voice input error: " + event.error; if (event.error === 'not-allowed' || event.error === 'service-not-allowed') { errorMsg = "Microphone access denied. Please allow microphone access in browser settings."; } else if (event.error === 'no-speech') { errorMsg = "No speech detected. Please try again."; } this.addNotification(errorMsg, "error"); this.avatar.isListening = false; this.avatar.state = this.avatar.expanded ? 'listening' : 'idle'; };
              this.speechRecognition.onend = () => { this.avatar.isListening = false; if (this.avatar.state === 'listening' && !this.avatar.expanded) { this.avatar.state = 'idle'; } else if (this.avatar.expanded && this.avatar.state === 'listening') { } console.log("Avatar STT ended."); };
          }
      },
      toggleAvatarListening() {
          if (!this.speechRecognition) { this.initializeSpeechRecognition(); if (!this.speechRecognition) return; }
          if (this.avatar.isListening) { this.speechRecognition.stop(); }
          else { if ('speechSynthesis' in window && speechSynthesis.speaking) { speechSynthesis.cancel(); } try { this.speechRecognition.start(); } catch (e) { console.error("Error starting speech recognition:", e); this.addNotification("Could not start voice input. " + e.message, "error"); this.avatar.isListening = false; this.avatar.state = this.avatar.expanded ? 'listening' : 'idle'; } }
      },
      toggleAvatarExpansion(forceState = null) {
          this.avatar.expanded = forceState !== null ? forceState : !this.avatar.expanded;
          if (this.avatar.expanded) {
              this.avatar.state = 'listening'; this.updateAvatarContextAndQuickActions(); this.clearUnreadAvatarMessages();
              this.$nextTick(() => this.scrollToAvatarMessagesBottom());
              if (this.avatar.chatMessages.length === 0 || (this.avatar.chatMessages.length === 1 && this.avatar.chatMessages[0].id.startsWith('avatar-greeting-'))) {
                  const greeting = this.getAvatarGreeting();
                   if (this.avatar.chatMessages.length === 0 || (this.avatar.chatMessages.length === 1 && this.avatar.chatMessages[0].id.startsWith('avatar-greeting-'))) {
                         this.avatar.chatMessages = [{ id: 'avatar-greeting-' + Date.now(), sender: 'bot', text: greeting, timestamp: new Date().toISOString(), readByUser: true }];
                         this.speakText(greeting);
                    } else { this.avatar.state = 'listening'; }
              } else { this.avatar.state = 'listening'; }
              this.initializeSpeechRecognition();
          } else {
              this.avatar.state = 'idle';
              if (this.speechRecognition && this.avatar.isListening) { this.speechRecognition.stop(); }
              if ('speechSynthesis' in window && speechSynthesis.speaking) { speechSynthesis.cancel(); }
          }
      },
      getAvatarGreeting() {
          let pageName = this.current.replace(/([A-Z])/g, ' $1').toLowerCase();
          pageName = pageName.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
          if (this.current === 'landing') return "Hi there!  I'm the PestiVid Helper. How can I assist you today on our platform?";
          if (this.current === 'farmerAgriSolar' && this.role === 'farmer') {
             let tabName = this.currentAgriSolarTab.replace(/([A-Z])/g, ' $1').toLowerCase();
             tabName = tabName.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
             return `Welcome to the AgriSolar ${tabName} tab! How can I help you manage your farm's energy today?`;
          }
           if (this.current === 'farmerAgriSolar' && this.role !== 'farmer') {
               return "Welcome to the AgriSolar module! As a non-farmer user, you can browse the Energy Marketplace here. How can I help?";
           }
          return `Welcome to the ${pageName} page! I'm PestiVid Helper. What can I do for you here?`;
      },
      updateAvatarContextAndQuickActions() {
          this.avatar.quickActions = [];
          this.avatar.currentContextText = `User is on the ${this.current} page.`;
          switch (this.current) {
              case 'landing': this.avatar.quickActions.push({ id: 'qa_what_is', label: "What is PestiVid?", query: "Explain PestiVid briefly." }, { id: 'qa_get_started', label: "How to get started?", query: "How do I get started with PestiVid?" }); break;
              case 'farmerPestiVid':
                   if (this.role === 'farmer') { this.avatar.currentContextText += " This is where farmers record crop videos."; this.avatar.quickActions.push({ id: 'qa_record_tips', label: "Recording Tips", query: "Give me tips for recording good PestiVid videos." }, { id: 'qa_ipfs_explain', label: "What is IPFS?", query: "Explain IPFS in simple terms for a farmer." });
                   } else { this.avatar.currentContextText += " This is the video recording page, only for farmers."; this.avatar.quickActions.push({ id: 'qa_farmer_features', label: "Farmer features?", query: "What features are available only for farmers?" }); } break;
              case 'farmerAgriSolar':
                   if (this.role === 'farmer') {
                       this.avatar.currentContextText += ` Farmer is viewing the AgriSolar module, specifically the ${this.currentAgriSolarTab} tab.`;
                       this.avatar.quickActions.push({ id: 'qa_agrisolar_overview', label: "AgriSolar Overview", query: "What can I do in the AgriSolar module?" });
                       if (this.currentAgriSolarTab === 'assets') { this.avatar.quickActions.push({ id: 'qa_add_asset', label: "Add Solar Asset Help", query: "How do I register a new solar asset?" }); }
                       else if (this.currentAgriSolarTab === 'productionLog') { this.avatar.quickActions.push({ id: 'qa_log_prod', label: "Log Production Help", query: "How do I log my energy production?" }); }
                       else if (this.currentAgriSolarTab === 'agrovoltaics') { this.avatar.quickActions.push({ id: 'qa_agro_setup', label: "Agrovoltaics Help", query: "How do I register an agrovoltaic setup?" }); }
                       else if (this.currentAgriSolarTab === 'energyMarket') { this.avatar.quickActions.push({ id: 'qa_list_energy', label: "List energy help", query: "How do I list excess energy for sale?" }); }
                       else if (this.currentAgriSolarTab === 'reportsCerts') { this.avatar.quickActions.push({ id: 'qa_get_cert', label: "Get certificate help", query: "How do I get a carbon offset certificate?" }); }
                       else if (this.currentAgriSolarTab === 'multiEnergy') { this.avatar.quickActions.push({ id: 'qa_multi_energy', label: "Manage Energy Sources?", query: "How do I manage different energy sources like wind or biomass?" }); }
                       else if (this.currentAgriSolarTab === 'iotNetwork') { this.avatar.quickActions.push({ id: 'qa_iot_setup', label: "Setup IoT Devices?", query: "How do I register and use IoT devices?" }); }
                   } else {
                        this.avatar.currentContextText += ` User is viewing the AgriSolar module as a non-farmer, specifically the ${this.currentAgriSolarTab} tab.`;
                        if (this.currentAgriSolarTab === 'energyMarket') { this.avatar.quickActions.push({ id: 'qa_browse_energy', label: "Browse energy listings?", query: "How do I buy energy from the marketplace?" }); }
                         this.avatar.quickActions.push({ id: 'qa_agrisolar_farmer', label: "AgriSolar for farmers?", query: "What features are only for farmers in AgriSolar?" });
                   } break;
               case 'farmerAgriStream': if (this.role === 'farmer') { this.avatar.currentContextText += " This is the farmer's AgriStream, showing their uploaded videos."; this.avatar.quickActions.push({ id: 'qa_video_purpose', label: "Video purposes?", query: "What are the different purposes for videos?" }, { id: 'qa_upload_video', label: "Upload a video?", query: "How do I upload a new video?" }); } break;
               case 'farmerSell': if (this.role === 'farmer') { this.avatar.currentContextText += " This is where farmers create listings for sale."; this.avatar.quickActions.push({ id: 'qa_listing_tips', label: "Listing tips?", query: "Tips for creating a good listing." }, { id: 'qa_why_sell', label: "Why sell here?", query: "What are the benefits of selling on PestiVid?" }); } break;
               case 'farmerFunding': if (this.role === 'farmer') { this.avatar.currentContextText += " This is where farmers request funding for projects."; this.avatar.quickActions.push({ id: 'qa_funding_types', label: "Project types?", query: "What kinds of projects can I get funding for?" }, { id: 'qa_attract_investors', label: "Attract investors?", query: "How can I make my project attractive to investors?" }); } break;
                case 'buyerAgriSell': if (this.isUserAuthenticated) { this.avatar.currentContextText += " User is browsing the AgriSell marketplace."; this.avatar.quickActions.push({ id: 'qa_how_buy', label: "How to buy?", query: "How does buying on AgriSell work?" }, { id: 'qa_video_auth', label: "Video verification?", query: "How does video verification work for buyers?" }); } break;
                 case 'investorProjects': if (this.isUserAuthenticated) { this.avatar.currentContextText += " User is browsing investment opportunities."; this.avatar.quickActions.push({ id: 'qa_how_invest', label: "How to invest?", query: "How does investing in projects work?" }, { id: 'qa_roi_explain', label: "ROI explained?", query: "Explain how ROI is calculated for projects." }); } break;
                 case 'investorPortfolio': if (this.isUserAuthenticated) { this.avatar.currentContextText += " User is viewing their investment portfolio."; this.avatar.quickActions.push({ id: 'qa_portfolio_stats', label: "Portfolio stats?", query: "Explain the stats in my portfolio." }, { id: 'qa_payouts', label: "Payouts?", query: "How are investment payouts handled?" }); } break;
                 case 'messaging': if (this.isUserAuthenticated) { this.avatar.currentContextText += " User is using the messaging feature."; this.avatar.quickActions.push({ id: 'qa_message_user', label: "How to message someone?", query: "How do I start a conversation?" }); } break;
              case 'plantRecommendation': this.avatar.currentContextText += " This is where users can get plant disease recommendations."; this.avatar.quickActions.push({ id: 'qa_plant_how', label: "How to use?", query: "How do I use the plant recommendation feature?" }, { id: 'qa_plant_accuracy', label: "How accurate?", query: "How accurate is the plant disease detection?" }); break;
              case 'userProfile': if (this.isUserAuthenticated) { this.avatar.currentContextText += " User is viewing their profile."; this.avatar.quickActions.push({ id: 'qa_update_profile', label: "Update profile?", query: "Can I update my profile information?" }, { id: 'qa_change_role', label: "Change role?", query: "Can I change my role later?" }); } break;
              default: this.avatar.quickActions.push({ id: 'qa_general_help', label: "General Help", query: "What can you help me with?" });
          }
      },
      async sendAvatarMessage() {
          if (!this.avatar.userInput.trim() || this.avatar.isProcessing) return;
          if (this.avatar.isListening) { this.speechRecognition.stop(); }
          const userInput = this.avatar.userInput.trim();
          this.avatar.chatMessages.push({ id: 'avatar-user-' + Date.now(), sender: 'user', text: userInput, timestamp: new Date().toISOString() });
          this.avatar.userInput = ''; this.avatar.isProcessing = true; this.avatar.state = 'thinking';
          this.$nextTick(() => this.scrollToAvatarMessagesBottom());
          const messagesForApi = [{ role: 'system', content: this.avatar.systemPrompt }];
          const recentHistory = this.avatar.chatMessages.slice(-6).map(msg => ({ role: msg.sender === 'user' ? 'user' : 'assistant', content: msg.text }));
          messagesForApi.push(...recentHistory);
          const contextualPrompt = `Current platform context: ${this.avatar.currentContextText}. User question: ${userInput}`;
          const lastUserMessageIndex = messagesForApi.map(m => m.role).lastIndexOf('user');
          if (lastUserMessageIndex !== -1) { messagesForApi[lastUserMessageIndex].content = contextualPrompt; }
          else { messagesForApi.push({ role: 'user', content: contextualPrompt }); }
          try {
              const response = await axios.post('https://api.groq.com/openai/v1/chat/completions', { messages: messagesForApi, model: 'llama3-8b-8192', temperature: 0.6, max_tokens: 350, }, { headers: { 'Authorization': `Bearer ${this.groqApiKey}`, 'Content-Type': 'application/json' } });
              if (response.data.choices && response.data.choices.length > 0) {
                  const botResponse = response.data.choices[0].message.content;
                  this.avatar.chatMessages.push({ id: 'avatar-bot-' + Date.now(), sender: 'bot', text: botResponse, timestamp: new Date().toISOString(), readByUser: this.avatar.expanded });
                  this.speakText(botResponse.replace(/<\/?[^>]+(>|$)/g, ""));
              } else {
                   let errorText = "Sorry, I couldn't get a response. Please try again.";
                   if(response.data && response.data.promptFeedback && response.data.promptFeedback.blockReason) { errorText = "Response blocked due to safety concerns. Please rephrase your question."; }
                  this.avatar.chatMessages.push({ id: 'avatar-bot-' + Date.now(), sender: 'bot', text: errorText, timestamp: new Date().toISOString(), readByUser: this.avatar.expanded });
                  this.speakText(errorText);
              }
          } catch (error) {
              console.error("Error calling Groq API for Avatar:", error);
              let errorMsg = "Sorry, I encountered an error getting a response.";
               if (error.response) { errorMsg += ` (Status: ${error.response.status})`; if (error.response.status === 401) errorMsg += ". Check your Groq API key."; }
               else if (error.request) { errorMsg += " (Network Error)"; } else { errorMsg += `: ${error.message}`; }
              this.avatar.chatMessages.push({ id: 'avatar-bot-' + Date.now(), sender: 'bot', text: errorMsg, timestamp: new Date().toISOString(), readByUser: this.avatar.expanded });
              this.speakText(errorMsg);
          } finally {
              this.avatar.isProcessing = false;
              this.$nextTick(() => this.scrollToAvatarMessagesBottom());
          }
      },
      handleAvatarQuickAction(action) { this.avatar.userInput = action.query; this.sendAvatarMessage(); this.avatar.quickActions = []; },
      scrollToAvatarMessagesBottom() { const container = this.$refs.avatarMessagesContainer; if (container) { this.$nextTick(() => { container.scrollTop = container.scrollHeight; }); } },
      clearUnreadAvatarMessages() { let changed = false; this.avatar.chatMessages.forEach(msg => { if (msg.sender === 'bot' && !msg.readByUser) { msg.readByUser = true; changed = true; } }); if (changed) { this.saveDataToLocalStorage(); } },
       renderMarkdown(text) { if (window.marked && typeof window.marked.parse === 'function') { return marked.parse(text || '', { breaks: true, gfm: true }); } return (text || '').replace(/\n/g, '<br>'); },
    },
    mounted() {
      console.log("PestiVid (Orange ID & Solana & Avatar & Advanced Renewables) App Mounted.");
      if (!this.initializeOrangeIdSDK()) { console.warn("Orange ID SDK failed to initialize. Orange ID login will not be available."); }
      if (this.pinataJwt === 'YOUR_PINATA_JWT_MUST_BE_REPLACED_HERE' || !this.pinataJwt || this.pinataJwt.length < 50) { console.warn("CONFIG WARNING: Pinata JWT not set or is placeholder. Video uploads WILL FAIL until a valid JWT is provided."); }
      if (this.geminiApiKey === 'YOUR_GEMINI_API_KEY_REPLACE_HERE' || !this.geminiApiKey || this.geminiApiKey.length < 30) { console.error("CONFIG ERROR: Gemini API Key is still set to placeholder or invalid. Plant recommendation WILL FAIL."); }
      if (!this.groqApiKey || this.groqApiKey === "YOUR_GROQ_API_KEY_REPLACE_HERE" || this.groqApiKey.length < 30) { console.error("CONFIG ERROR: Groq API Key is missing or invalid. Avatar Assistant WILL FAIL."); }
      if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') { console.warn("SECURITY WARNING: Page not HTTPS. Camera access and Speech Recognition might fail."); }
      this.loadDataFromLocalStorage();
      if (this.checkOrangeIdCallback()) { return; }
      if (!this.isUserAuthenticated && !this.isAuthProcessing && window.solana && window.solana.isPhantom) {
           const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles')) || {};
           const lastSolanaUserEntry = Object.entries(userProfiles).find(([id, profile]) => profile.authMethod === 'solana');
           if (lastSolanaUserEntry) {
               const lastSolanaUserId = lastSolanaUserEntry[0];
               window.solana.request({ method: 'connect', params: { onlyIfTrusted: true } })
                   .then(resp => {
                       if (resp && resp.publicKey && resp.publicKey.toString() === lastSolanaUserId) {
                           this.$nextTick(() => { if (!this.isUserAuthenticated) { this.handleAuthenticationSuccess(resp.publicKey.toString(), 'solana'); } });
                       }
                   })
                   .catch(err => { console.log("Solana auto-reconnect failed:", err.message); this.$nextTick(() => { this.isAuthProcessing = false; this.showLoadingModal = false; }); });
           } else { this.isAuthProcessing = false; this.showLoadingModal = false; }
      } else if (this.isUserAuthenticated) {
        this.filterDataForCurrentUser(); if (this.loginMethod === 'orangeId') { this.renderOrangeIdSignOutButton('orange-id-signout-button-container'); }
        this.isAuthProcessing = false; this.showLoadingModal = false;
      } else { this.isAuthProcessing = false; this.showLoadingModal = false; }

      setInterval(() => { if(this.isUserAuthenticated && this.role==='investor') this.updateInvestmentProgress(); }, 30000);
      if (this.avatar.visible) {
        if (!this.avatar.expanded) { this.updateAvatarContextAndQuickActions(); }
        this.initializeSpeechRecognition();
      }
      if ('speechSynthesis' in window) {
          speechSynthesis.onvoiceschanged = () => { console.log("Speech synthesis voices loaded."); };
          if (speechSynthesis.getVoices().length === 0) { speechSynthesis.getVoices(); }
      }
      // Initialize sensor simulations for existing IoT devices on load
      this.iotDevices.forEach(device => {
        if (device.farmerWallet === this.currentUserIdentifier) { // Only for current farmer's devices
            this.startSensorSimulation(device.id);
        }
      });
    },
    beforeDestroy() { // Clean up intervals
        this.iotDevices.forEach(device => {
            if (device.simulationInterval) clearInterval(device.simulationInterval);
        });
    }
  });
  window.vueApp = app;
</script>
</body>
</html>