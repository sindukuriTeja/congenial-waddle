<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PestiVid - Agricultural & Renewable Energy Platform (Demo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" rel="stylesheet">
  <!-- Google Fonts (Inter) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Vue.js -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
  <!-- Axios, Chart.js, Marked.js (for Markdown) -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>


  <style>
    body { font-family: 'Inter', system-ui, sans-serif; background: #f9fafb; }
    html { scroll-behavior: smooth; overflow-x: hidden; }
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 5px; }
    ::-webkit-scrollbar-thumb:hover { background: #aaa; }
    * { scrollbar-width: thin; scrollbar-color: #ccc #f1f1f1; -ms-overflow-style: -ms-autohiding-scrollbar; }
    .progress-bar { height: 8px; border-radius: 4px; background: #e5e7eb; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
    .modal-scrollable { max-height: 85vh; overflow-y: auto; }
    .project-updates-list { max-height: 150px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 0.75rem; background-color: #f9fafb; }
    .project-update-item { padding-bottom: 0.5rem; margin-bottom: 0.5rem; border-bottom: 1px solid #f3f4f6; }
    .project-update-item:last-child { border-bottom: none; margin-bottom: 0; }
    .message-view-container { scroll-behavior: smooth; }
    .notification-badge { position: absolute; top: -5px; right: -8px; min-width: 18px; height: 18px; background-color: #ef4444; border-radius: 9px; color: white; font-size: 10px; font-weight: 600; line-height: 18px; text-align: center; padding: 0 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    .mobile-notification-badge { display: inline-block; background-color: #ef4444; color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 9px; line-height: 16px; text-align: center; vertical-align: top; margin-left: 4px; }
    .notification-toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column-reverse; gap: 10px; align-items: flex-end; }
    .notification-toast { min-width: 250px; max-width: 350px; background-color: #fff; color: #333; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); display: flex; align-items: center; opacity: 0; transform: translateX(100%); transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
    .notification-toast.show { opacity: 1; transform: translateX(0); }
    .notification-toast .icon { margin-right: 0.75rem; font-size: 1.25rem; }
    .notification-toast .icon-info { color: #3b82f6; } .notification-toast .icon-success { color: #10b981; } .notification-toast .icon-warning { color: #f59e0b; } .notification-toast .icon-error { color: #ef4444; }
    .notification-toast .message { font-size: 0.875rem; line-height: 1.3; }
    .notification-toast .close-btn { margin-left: auto; padding-left: 0.75rem; color: #9ca3af; cursor: pointer; background: none; border: none; font-size: 1rem; }
    .notification-toast .close-btn:hover { color: #6b7280; }
    .new-badge { position: absolute; top: -8px; right: -8px; background-color: #3b82f6; color: white; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .loading-modal { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 9999; }
    .loading-content { background-color: white; padding: 2rem; border-radius: 0.5rem; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    .loading-content .fa-spinner { font-size: 2rem; color: #10b981; margin-bottom: 1rem; }

    /* Chatbot Styles (Used for main Messaging Feature) */
    .chatbot-container { display: flex; flex-direction: column; height: calc(100vh - 230px); max-height: 700px; border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden; }
    .chatbot-messages { flex-grow: 1; padding: 1rem; overflow-y: auto; background-color: #f9fafb; space-y-4; }
    .chat-message { display: flex; max-width: 80%; margin-bottom: 0.5rem;}
    .chat-message.user { margin-left: auto; flex-direction: row-reverse; }
    .chat-message .message-content { display: flex; align-items: flex-end; }
    .chat-message.user .message-content { flex-direction: row-reverse; }
    .chat-message .message-bubble { padding: 0.75rem 1rem; border-radius: 1rem; line-height: 1.5; word-wrap: break-word; max-width: calc(100% - 3.5rem); /* Account for avatar */ }
    .chat-message.user .message-bubble { background-color: #10b981; color: white; border-bottom-right-radius: 0.25rem; }
    .chat-message.bot .message-bubble { background-color: #e5e7eb; color: #1f2937; border-bottom-left-radius: 0.25rem; }
    .chat-message .avatar { width: 2.5rem; height: 2.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; margin: 0 0.5rem; flex-shrink: 0; align-self: flex-end; }
    .chat-message.user .avatar { background-color: #059669; color: white; }
    .chat-message.bot .avatar { background-color: #d1d5db; color: #4b5563; }
    .chatbot-input-area { border-top: 1px solid #e5e7eb; padding: 1rem; background-color: #fff; display: flex; gap: 0.75rem; }
    .chatbot-input-area input { flex-grow: 1; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; }
    .chatbot-input-area input:focus { outline: none; border-color: #10b981; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); }
    .chatbot-input-area button { background-color: #10b981; color: white; padding: 0.75rem 1.25rem; border-radius: 0.375rem; font-weight: 600; font-size: 0.875rem; }
    .chatbot-input-area button:hover { background-color: #059669; }
    .chatbot-input-area button:disabled { background-color: #9ca3af; cursor: not-allowed; }
    .typing-indicator span { height: 8px; width: 8px; margin: 0 2px; background-color: #9ca3af; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
    .message-bubble ul, .message-bubble ol { margin-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
    .message-bubble li { margin-bottom: 0.25rem; }
    .message-bubble p { margin-bottom: 0.5rem; }
    .message-bubble p:last-child { margin-bottom: 0; }
    .message-bubble strong, .message-bubble b { font-weight: 600; }
    .message-bubble em, .message-bubble i { font-style: italic; }
    .message-bubble pre { background-color: #f3f4f6; padding: 0.5rem; border-radius: 0.25rem; overflow-x: auto; font-family: monospace; font-size: 0.875em; margin: 0.5rem 0; }
    .message-bubble code { background-color: #f3f4f6; padding: 0.1em 0.3em; border-radius: 0.25rem; font-family: monospace; font-size: 0.875em; }
    .message-bubble pre code { padding: 0; background-color: transparent; }

    .stat-card { background-color: white; border-radius: 0.5rem; padding: 1.5rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); text-align: center;}
    .stat-card .icon { font-size: 1.75rem; margin-bottom: 0.5rem; }
    .stat-card .value { font-size: 1.5rem; font-weight: 700; }
    .stat-card .label { font-size: 0.875rem; color: #6b7280; }

    /* New Avatar Assistant Styles (from second file) */
    @keyframes pulse-slow {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }
    .animate-pulse-slow {
      animation: pulse-slow 2s infinite ease-in-out;
    }
    .avatar-input-mic-btn.listening i {
        animation: pulse-red 1.5s infinite;
    }
    @keyframes pulse-red {
      0%, 100% { color: #ef4444; transform: scale(1); }
      50% { color: #f87171; transform: scale(1.1); }
    }

    /* Dropdown for Renewable Energy */
    .dropdown:hover .dropdown-menu { display: block; }
    .dropdown-menu { display: none; position: absolute; background-color: white; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 50; min-width: 160px; border-radius: 0.375rem; }
    .dropdown-menu a { color: black; padding: 10px 15px; text-decoration: none; display: block; font-size: 0.875rem; }
    .dropdown-menu a:hover { background-color: #f1f1f1; }

    /* Dashboard Stats Card Specific */
    .dashboard-stat-card { background-color: #fff; border-radius: 0.5rem; padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center;}
    .dashboard-stat-card .stat-icon { font-size: 1.5rem; margin-bottom: 0.5rem; color: #4ade80; /* Light Green */ }
    .dashboard-stat-card .stat-value { font-size: 1.25rem; font-weight: 700; color: #1f2937; }
    .dashboard-stat-card .stat-label { font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem; }
    .chart-container { position: relative; height:300px; width:100%; }
  </style>
</head>
<body class="text-gray-900">
<div id="app" class="flex flex-col min-h-screen">
  <!-- Header/Navbar -->
  <header class="bg-white shadow sticky top-0 z-30">
    <div class="max-w-7xl mx-auto px-5 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <span class="text-2xl text-green-700 font-semibold"><i class="fas fa-seedling mr-1"></i>PestiVid</span>
      </div>
      <nav class="hidden md:flex space-x-5 items-center">
        <a href="#" @click.prevent="switchPage('landing')" :class="{'font-bold text-green-700': current==='landing'}" class="hover:text-green-600">Home</a>

        <!-- Renewable Energy Dropdown -->
        <div class="relative dropdown">
             <a href="#" @click.prevent="switchPage('renewableEnergyHub'); toggleRenewableEnergyMenu();"
               :class="{'font-bold text-green-700': current.startsWith('renewable') || current.startsWith('farmerAPV') || (current === 'investorProjects' && investorFilters.projectCategory === 'renewable_energy')}"
               class="hover:text-green-600 flex items-center">
               Renewable Energy <i class="fas fa-chevron-down text-xs ml-1"></i>
            </a>
            <div class="dropdown-menu" v-show="showRenewableEnergyMenu">
                <a href="#" @click.prevent="switchPage('renewableAPVExplained'); showRenewableEnergyMenu = false;" :class="{'font-bold text-green-700': current==='renewableAPVExplained'}">APV Explained</a>
                <template v-if="isUserAuthenticated && role==='farmer'">
                    <a href="#" @click.prevent="switchPage('renewableEnergyHub'); showRenewableEnergyMenu = false;" :class="{'font-bold text-green-700': current==='renewableEnergyHub' && farmerAPVProjects.length > 0 }">My APV Dashboard</a>
                </template>
                 <template v-if="isUserAuthenticated && role==='investor'">
                    <a href="#" @click.prevent="switchPage('investorProjects', { category: 'renewable_energy' }); showRenewableEnergyMenu = false;" :class="{'font-bold text-green-700': current==='investorProjects' && investorFilters.projectCategory === 'renewable_energy'}">Invest in Green Energy</a>
                </template>
                <template v-if="!isUserAuthenticated || (role !=='farmer' && role !=='investor')">
                     <a href="#" @click.prevent="switchPage('login'); showRenewableEnergyMenu = false;" class="text-gray-500 italic">Login to manage/invest</a>
                </template>
            </div>
        </div>


        <template v-if="isUserAuthenticated">
            <!-- Farmer Menu -->
            <template v-if="role==='farmer'">
            <a href="#" @click.prevent="switchPage('farmerPestiVid')" :class="{'font-bold text-green-700': current==='farmerPestiVid'}" class="hover:text-green-600">PestiVid</a>
            <a href="#" @click.prevent="switchPage('farmerAgriStream')" :class="{'font-bold text-green-700': current==='farmerAgriStream'}" class="hover:text-green-600">AgriStream</a>
            <a href="#" @click.prevent="switchPage('farmerSell')" :class="{'font-bold text-green-700': current==='farmerSell'}" class="hover:text-green-600">Sell Crops</a>
            <a href="#" @click.prevent="switchPage('farmerFunding')" :class="{'font-bold text-green-700': current==='farmerFunding'}" class="hover:text-green-600">Get Funding</a>
            <a href="#" @click.prevent="switchPage('plantRecommendation')" :class="{'font-bold text-green-700': current==='plantRecommendation'}" class="hover:text-green-600">PlantRecommend</a>
            </template>
            <!-- Buyer Menu -->
            <template v-if="role==='buyer'">
            <a href="#" @click.prevent="switchPage('buyerAgriSell')" :class="{'font-bold text-green-700': current==='buyerAgriSell'}" class="hover:text-green-600">AgriSell</a>
            </template>
            <!-- Investor Menu -->
            <template v-if="role==='investor'">
            <a href="#" @click.prevent="switchPage('investorProjects')" :class="{'font-bold text-green-700': current==='investorProjects' && investorFilters.projectCategory !== 'renewable_energy'}" class="hover:text-green-600">Agri Projects</a>
            <a href="#" @click.prevent="switchPage('investorPortfolio')" :class="{'font-bold text-green-700': current==='investorPortfolio'}" class="hover:text-green-600">Portfolio</a>
            </template>

            <a href="#" @click.prevent="switchPage('messaging')"
            :class="{'font-bold text-green-700': current==='messaging'}"
            class="hover:text-green-600 relative px-2 py-1 flex items-center justify-center">
            <i class="fas fa-comments"></i>
            <span v-if="unreadMessageCount > 0" class="notification-badge">{{ unreadMessageCount }}</span>
            </a>

            <a href="#" @click.prevent="switchPage('userProfile')" :class="{'font-bold text-green-700': current==='userProfile'}" class="bg-green-600 text-white text-xs rounded-full px-3 py-1 select-none ml-2 hover:bg-green-700 flex items-center">
            <i class="fas fa-user-circle mr-1"></i> {{ userName ? userName.split(' ')[0] : 'User' }}
            </a>
            <a href="#" @click.prevent="handleLogout" class="hover:text-red-600 ml-2 text-sm">Sign Out</a>
        </template>
        <template v-else>
            <a href="#" @click.prevent="switchPage('login')" :class="{'font-bold text-green-700': current==='login'}" class="hover:text-green-600">Login</a>
            <a href="#" @click.prevent="switchPage('signup')" :class="{'font-bold text-green-700': current==='signup'}" class="bg-green-600 text-white text-xs rounded-full px-4 py-1.5 hover:bg-green-700">Sign Up</a>
        </template>
      </nav>
      <button class="md:hidden text-gray-500 focus:outline-none" @click="showMobileMenu = !showMobileMenu">
        <i class="fas fa-bars text-2xl"></i>
      </button>
    </div>
    <!-- Mobile Dropdown -->
    <div v-show="showMobileMenu" class="md:hidden bg-white border-t z-40">
      <div class="py-2 flex flex-col space-y-1 px-4">
        <a href="#" @click.prevent="switchPage('landing');showMobileMenu=false" :class="{'font-bold text-green-700': current==='landing'}">Home</a>
        <!-- Mobile Renewable Energy -->
        <div class="border-t pt-1 mt-1">
             <span @click="switchPage('renewableEnergyHub'); showMobileMenu=false;" class="font-semibold text-gray-700 flex justify-between items-center py-1 cursor-pointer" :class="{'font-bold text-green-700': current.startsWith('renewable')}">Renewable Energy <i class="fas fa-solar-panel text-xs text-yellow-500"></i></span>
            <!-- Sub-items can be shown on the hub page itself or further simplified for mobile -->
        </div>

        <template v-if="isUserAuthenticated">
            <template v-if="role==='farmer'">
            <a href="#" @click.prevent="switchPage('farmerPestiVid');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerPestiVid'}">PestiVid</a>
            <a href="#" @click.prevent="switchPage('farmerAgriStream');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerAgriStream'}">AgriStream</a>
            <a href="#" @click.prevent="switchPage('farmerSell');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerSell'}">Sell Crops</a>
            <a href="#" @click.prevent="switchPage('farmerFunding');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerFunding'}">Get Funding</a>
            <a href="#" @click.prevent="switchPage('plantRecommendation');showMobileMenu=false" :class="{'font-bold text-green-700': current==='plantRecommendation'}">PlantRecommend</a>
            </template>
            <template v-if="role==='buyer'">
            <a href="#" @click.prevent="switchPage('buyerAgriSell');showMobileMenu=false" :class="{'font-bold text-green-700': current==='buyerAgriSell'}">AgriSell</a>
            </template>
            <template v-if="role==='investor'">
            <a href="#" @click.prevent="switchPage('investorProjects');showMobileMenu=false" :class="{'font-bold text-green-700': current==='investorProjects' && investorFilters.projectCategory !== 'renewable_energy'}">Agri Projects</a>
            <a href="#" @click.prevent="switchPage('investorPortfolio');showMobileMenu=false" :class="{'font-bold text-green-700': current==='investorPortfolio'}">Portfolio</a>
            </template>

            <a href="#" @click.prevent="switchPage('messaging');showMobileMenu=false"
            :class="{'font-bold text-green-700': current==='messaging'}">
            <i class="fas fa-comments mr-1"></i>Messages
            <span v-if="unreadMessageCount > 0" class="mobile-notification-badge">{{ unreadMessageCount }}</span>
            </a>
            <div class="border-t mt-2 pt-2 flex justify-between items-center">
                <a href="#" @click.prevent="switchPage('userProfile');showMobileMenu=false" :class="{'font-bold text-green-700': current==='userProfile'}" class="inline-block bg-green-600 text-white text-xs rounded px-2 py-1 ml-1 flex items-center">
                    <i class="fas fa-user-circle mr-1"></i> {{ userName ? userName.split(' ')[0] : 'User' }}
                </a>
                <a href="#" @click.prevent="handleLogout();showMobileMenu=false" class="text-red-600 text-sm pr-2">Sign Out</a>
            </div>
        </template>
        <template v-else>
             <a href="#" @click.prevent="switchPage('login');showMobileMenu=false" :class="{'font-bold text-green-700': current==='login'}">Login</a>
            <a href="#" @click.prevent="switchPage('signup');showMobileMenu=false" :class="{'font-bold text-green-700': current==='signup'}" class="inline-block bg-green-600 text-white text-xs rounded px-2 py-1">Sign Up</a>
        </template>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-1 max-w-7xl mx-auto w-full px-4 pt-8 pb-8">
    <!-- Landing Section -->
    <section v-if="current==='landing'">
        <div class="flex flex-col md:flex-row items-center mb-12 pt-2">
            <div class="md:w-1/2 md:pr-8">
            <h1 class="text-4xl font-bold text-green-800 mb-4">PestiVid: Blockchain Transparency & Sustainability in Agriculture & Energy</h1>
            <p class="mb-5 text-gray-800 text-lg leading-relaxed">A secure, verified platform for agricultural marketplace, investment, and on-farm renewable energy solutions. Farmers prove quality, safety, and sustainable practices. Buyers purchase crops with complete confidence. Investors fund agricultural and Agrivoltaic projects with transparent returns.</p>
            <ul class="text-gray-700 mb-7 space-y-1 text-base">
                <li><i class="fas fa-link text-green-500 mr-2"></i>Blockchain-simulated transactions</li>
                <li><i class="fas fa-cloud-upload-alt text-green-400 mr-2"></i>Decentralized evidence storage (IPFS/Pinata)</li>
                <li><i class="fas fa-search-dollar text-green-400 mr-2"></i>Full traceability for buyers & investors</li>
                <li><i class="fas fa-solar-panel text-yellow-500 mr-2"></i>Agrivoltaics: Combine farming with solar energy</li>
                <li><i class="fas fa-chart-line text-green-500 mr-2"></i>Investment in Agriculture & Green Energy</li>
                <li><i class="fas fa-comments text-green-500 mr-2"></i>Secure messaging between users</li>
                <li><i class="fas fa-bell text-green-500 mr-2"></i>Real-time notifications</li>
                <li><i class="fas fa-robot text-blue-500 mr-2"></i>Interactive AI Helper</li>
            </ul>
            <div class="mt-4 space-x-2">
                <button class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded transition" @click="getStarted">Get Started</button>
                <button class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded transition" @click="switchPage('renewableEnergyHub')">Explore Agrivoltaics</button>
            </div>
            </div>
             <div class="md:w-1/2 mt-10 md:mt-0 flex flex-col items-center">
            <img src="https://www.farmtoplate.io/wp-content/uploads/megamenu/tech_hub_banner.png" alt="Agriculture Banner" class="rounded-lg shadow-md border w-full max-w-md mx-auto mb-4"> <!-- Consider a more APV-related image here in future -->
            <p class="text-center text-sm text-gray-600 italic">PestiVid: Verifiable practices for a sustainable future in food & energy.</p>
            </div>
        </div>
         <div class="mt-10">
            <h2 class="text-2xl text-green-700 font-semibold mb-3">How It Works (Agriculture)</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-5">
            <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
                <i class="fas fa-video text-2xl text-green-500 mb-3"></i>
                <span class="font-bold mb-1">1. Record</span>
                <p class="text-sm text-gray-600 text-center">Farmers film crop practices.</p>
            </div>
            <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
                <i class="fas fa-cloud-upload-alt text-2xl text-green-500 mb-3"></i>
                <span class="font-bold mb-1">2. Upload to IPFS</span>
                <p class="text-sm text-gray-600 text-center">Videos & info are securely stored decentrally.</p>
            </div>
            <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
                <i class="fas fa-search-dollar text-green-500 mb-3"></i>
                <span class="font-bold mb-1">3. Verification</span>
                <p class="text-sm text-gray-600 text-center">Buyers view blockchain-verified video data.</p>
            </div>
            <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
                <i class="fas fa-handshake text-green-500 mb-3"></i>
                <span class="font-bold mb-1">4. Marketplace</span>
                <p class="text-sm text-gray-600 text-center">Buy, sell, or invest, backed by verified data.</p>
            </div>
            </div>
        </div>

        <div class="mt-16 bg-green-50 rounded-lg p-8">
            <h2 class="text-2xl text-green-700 font-semibold mb-3">Agricultural & Renewable Energy Investment</h2>
            <div class="flex flex-col md:flex-row items-center">
            <div class="w-full">
                <p class="mb-4 text-gray-700">Invest in verified agricultural and agrivoltaic projects with full transparency. Track your investments through simulated blockchain technology and share in the harvest & energy profits.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 my-6">
                <div class="bg-white rounded p-4 shadow-sm">
                    <i class="fas fa-seedling text-green-600 text-2xl mb-2"></i>
                    <h3 class="font-bold mb-1">Fund Crops & APV</h3>
                    <p class="text-sm">Invest in specific crop or agrivoltaic projects.</p>
                </div>
                <div class="bg-white rounded p-4 shadow-sm">
                    <i class="fas fa-coins text-green-600 text-2xl mb-2"></i>
                    <h3 class="font-bold mb-1">Share Returns</h3>
                    <p class="text-sm">Receive dividends based on yields, market prices, and energy sales.</p>
                </div>
                <div class="bg-white rounded p-4 shadow-sm">
                    <i class="fas fa-shield-alt text-green-600 text-2xl mb-2"></i>
                    <h3 class="font-bold mb-1">Secure Platform</h3>
                    <p class="text-sm">All investments recorded on immutable ledger (Simulated).</p>
                </div>
                </div>
                <button class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded transition mt-2" @click="switchPage('investorProjects')">Become an Investor</button>
            </div>
            </div>
        </div>
    </section>

    <!-- Login Section -->
    <section v-if="current==='login'" class="max-w-md mx-auto mt-12">
         <div class="bg-white rounded-lg shadow-xl p-8">
            <h2 class="text-2xl font-bold text-green-700 mb-6 text-center">Login to PestiVid</h2>
            <form @submit.prevent="handleLogin">
                <div class="mb-4">
                    <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                    <input type="email" id="login-email" v-model="loginForm.email" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                           placeholder="you@example.com">
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="login-password" v-model="loginForm.password" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                           placeholder="••••••••">
                </div>
                <div v-if="authError" class="mb-4 text-sm text-red-600 bg-red-50 p-3 rounded border border-red-200">
                    {{ authError }}
                </div>
                <button type="submit"
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out">
                    Login
                </button>
            </form>
            <p class="mt-6 text-center text-sm text-gray-600">
                Don't have an account?
                <a href="#" @click.prevent="switchPage('signup')" class="font-medium text-green-600 hover:text-green-500">
                    Sign up here
                </a>
            </p>
        </div>
    </section>

    <!-- Sign Up Section -->
    <section v-if="current==='signup'" class="max-w-md mx-auto mt-12">
        <div class="bg-white rounded-lg shadow-xl p-8">
            <h2 class="text-2xl font-bold text-green-700 mb-6 text-center">Create PestiVid Account</h2>
            <form @submit.prevent="handleSignup">
                <div class="mb-4">
                    <label for="signup-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                    <input type="text" id="signup-name" v-model="signupForm.name" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                           placeholder="John Doe">
                </div>
                <div class="mb-4">
                    <label for="signup-email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                    <input type="email" id="signup-email" v-model="signupForm.email" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                           placeholder="you@example.com">
                </div>
                <div class="mb-4">
                    <label for="signup-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="signup-password" v-model="signupForm.password" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                           placeholder="•••••••• (min. 6 characters)">
                </div>
                <div class="mb-4">
                    <label for="signup-confirm-password" class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                    <input type="password" id="signup-confirm-password" v-model="signupForm.confirmPassword" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"
                           placeholder="••••••••">
                </div>
                <div class="mb-6">
                    <label for="signup-role" class="block text-sm font-medium text-gray-700 mb-1">I am a:</label>
                    <select id="signup-role" v-model="signupForm.role"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 bg-white">
                        <option value="farmer">Farmer</option>
                        <option value="buyer">Buyer</option>
                        <option value="investor">Investor</option>
                    </select>
                </div>
                <div v-if="authError" class="mb-4 text-sm text-red-600 bg-red-50 p-3 rounded border border-red-200">
                    {{ authError }}
                </div>
                <button type="submit"
                        class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out">
                    Sign Up
                </button>
            </form>
            <p class="mt-6 text-center text-sm text-gray-600">
                Already have an account?
                <a href="#" @click.prevent="switchPage('login')" class="font-medium text-green-600 hover:text-green-500">
                    Login here
                </a>
            </p>
        </div>
    </section>


    <!-- Farmer PestiVid Section -->
    <section v-if="current==='farmerPestiVid' && isUserAuthenticated && role === 'farmer'" class="max-w-3xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-video mr-2"></i>PestiVid - Record & Upload</h2>
        <div class="bg-white p-6 rounded-lg shadow-md">
            <p class="text-gray-600 mb-4 text-sm">Record short videos of your pesticide application or other farming practices. Upload them to IPFS for transparency. This video can then be linked when you sell crops or seek funding.</p>
             <form @submit.prevent="handleUpload" class="space-y-4">
                 <div v-if="!recording && !recordBlobUrl" class="mb-4">
                    <button @click.prevent="startRecording" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm flex items-center justify-center" :disabled="recording">
                        <i class="fas fa-camera mr-2"></i> Start Recording
                    </button>
                    <p class="text-xs text-gray-500 mt-1 text-center">Ensure your browser has camera permissions enabled for this site.</p>
                </div>

                <div v-if="showLive && recording" class="my-4">
                    <video ref="liveVideo" autoplay playsinline muted class="w-full rounded border bg-black"></video>
                    <button @click.prevent="stopRecording" class="w-full mt-2 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-sm" :disabled="!recording">
                        <i class="fas fa-stop-circle mr-2"></i> Stop Recording
                    </button>
                </div>

                <div v-if="recordBlobUrl && !uploading" class="my-4 p-4 border rounded-lg bg-gray-50">
                    <h3 class="text-md font-semibold mb-2">Preview Your Recording:</h3>
                    <video :src="recordBlobUrl" controls class="w-full rounded border mb-3"></video>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm">Crop Name</label><input type="text" v-model="recordForm.crop" required class="w-full px-3 py-1.5 border rounded text-sm"></div>
                        <div><label class="block text-sm">Pesticide/Practice</label><input type="text" v-model="recordForm.pesticide" required class="w-full px-3 py-1.5 border rounded text-sm"></div>
                        <div><label class="block text-sm">Location (Field ID)</label><input type="text" v-model="recordForm.location" class="w-full px-3 py-1.5 border rounded text-sm"></div>
                        <div><label class="block text-sm">Pesticide Company (If any)</label><input type="text" v-model="recordForm.pesticideCompany" class="w-full px-3 py-1.5 border rounded text-sm"></div>
                    </div>
                    <div class="mt-3">
                        <label class="block text-sm">Purpose of this video:</label>
                        <select v-model="recordForm.purpose" class="w-full px-3 py-1.5 border rounded bg-white text-sm">
                            <option value="agristream">General AgriStream (Farm Log)</option>
                            <option value="sell">Proof for Selling Crops</option>
                            <option value="funding">Proof for Funding Request</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full mt-4 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm" :disabled="uploading">
                        <i class="fas fa-cloud-upload-alt mr-2"></i> {{ uploading ? 'Uploading...' : 'Upload to IPFS & Save Info' }}
                    </button>
                    <button @click.prevent="resetRecording" class="w-full mt-2 bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded text-sm">
                        <i class="fas fa-trash-alt mr-2"></i> Discard & Re-record
                    </button>
                </div>

                <div v-if="uploading" class="text-center py-4">
                    <i class="fas fa-spinner fa-spin text-2xl text-green-500"></i>
                    <p class="mt-2 text-sm">Uploading video to IPFS... Please wait.</p>
                </div>
                <div v-if="uploadError" class="text-red-500 text-sm bg-red-50 p-3 rounded border border-red-200">{{ uploadError }}</div>
                <div v-if="uploadCid && !uploadError" class="text-green-600 text-sm bg-green-50 p-3 rounded border border-green-200">
                    Successfully uploaded! IPFS CID: <a :href="ipfsUrl(uploadCid)" target="_blank" class="underline hover:text-green-700 font-mono text-xs break-all">{{ uploadCid }}</a><br>
                    File Hash: <span class="font-mono text-xs break-all">{{ lastUploadedVideoFileHash }}</span><br>
                    <span v-if="lastUploadedVideoPurpose === 'sell'">This video is now available to link when you list crops for sale.</span>
                    <span v-if="lastUploadedVideoPurpose === 'funding'">This video is now available to link to a funding request.</span>
                    <span v-if="lastUploadedVideoPurpose === 'agristream'">This video has been added to your AgriStream.</span>
                </div>
             </form>
        </div>
    </section>

    <!-- Farmer AgriStream Section -->
    <section v-if="current==='farmerAgriStream' && isUserAuthenticated && role === 'farmer'" class="max-w-4xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-stream mr-2"></i>My AgriStream - Farm Log</h2>
        <p class="text-gray-600 mb-6 text-sm">This is your farm's activity log. Videos uploaded for "General AgriStream", "Sell", or "Funding" purposes will appear here. Use it to track practices, show progress to investors, or build trust with buyers.</p>

        <div v-if="farmerVideos.length === 0" class="bg-white p-6 rounded-lg shadow text-center text-gray-500">
            <i class="fas fa-film text-3xl mb-3 text-gray-400"></i>
            <p>Your AgriStream is empty. <a href="#" @click.prevent="switchPage('farmerPestiVid')" class="text-green-600 hover:underline">Upload a video</a> to get started.</p>
        </div>

        <div v-else class="space-y-6">
            <div v-for="video in farmerVideos.slice().reverse()" :key="video.cid" :id="'video-' + video.cid"
                 class="bg-white rounded-lg shadow-md overflow-hidden transition-all duration-300 ease-in-out"
                 :class="{'ring-2 ring-offset-2 ring-green-500 shadow-lg': highlightedAgriStreamVideoCid === video.cid}">
                <div class="p-5">
                    <div class="flex flex-col md:flex-row gap-5">
                        <div class="md:w-1/2">
                             <video :src="ipfsUrl(video.cid)" controls playsinline webkit-playsinline class="w-full h-64 object-cover rounded bg-black border"></video>
                        </div>
                        <div class="md:w-1/2">
                            <h3 class="text-lg font-semibold text-green-800 mb-1">{{ video.crop }} - {{ video.pesticide }}</h3>
                            <p class="text-xs text-gray-500 mb-3">Uploaded: {{ new Date(video.uploadTimestamp).toLocaleString() }}</p>
                            <div class="space-y-1 text-sm text-gray-700">
                                <p><i class="fas fa-map-marker-alt w-5 text-center mr-1 text-gray-400"></i><strong>Location:</strong> {{ video.location || 'N/A' }}</p>
                                <p><i class="fas fa-industry w-5 text-center mr-1 text-gray-400"></i><strong>Brand:</strong> {{ video.pesticideCompany || 'N/A' }}</p>
                                <p><i class="fas fa-clipboard-list w-5 text-center mr-1 text-gray-400"></i><strong>Purpose:</strong> <span class="capitalize">{{ video.purpose || 'N/A' }}</span></p>
                                <p><i class="fas fa-hashtag w-5 text-center mr-1 text-gray-400"></i><strong>IPFS CID:</strong> <a :href="ipfsUrl(video.cid)" target="_blank" class="text-blue-500 hover:underline font-mono text-xs break-all">{{ video.cid }}</a></p>
                                <p><i class="fas fa-fingerprint w-5 text-center mr-1 text-gray-400"></i><strong>File Hash:</strong> <span class="font-mono text-xs break-all" :title="video.videoFileHash">{{ video.videoFileHash ? video.videoFileHash.substring(0,30) + '...' : 'N/A'}}</span></p>
                            </div>
                             <div class="mt-4 pt-3 border-t space-x-2">
                                <button v-if="video.purpose !== 'sell'" @click="prepareListingFromVideo(video)" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded text-xs"><i class="fas fa-tag mr-1"></i> List for Sale</button>
                                <button v-if="video.purpose !== 'funding'" @click="prepareFundingFromVideo(video)" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1.5 rounded text-xs"><i class="fas fa-hand-holding-usd mr-1"></i> Seek Funding</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Farmer Sell Section -->
    <section v-if="current==='farmerSell' && isUserAuthenticated && role === 'farmer'" class="max-w-2xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-store mr-2"></i>Sell Your Crops</h2>
         <div class="bg-white p-6 rounded-lg shadow-md">
             <p class="text-gray-600 mb-4 text-sm">Create a listing for your crops. Link a PestiVid video as proof of your practices. Buyers can then view this information and make purchases.</p>
             <form @submit.prevent="createListing" class="space-y-4">
                 <div>
                     <label class="block text-sm font-medium text-gray-700">Select PestiVid Video (Proof)</label>
                     <select v-model="listingForm.cid" required class="w-full px-3 py-2 border rounded bg-white text-sm mt-1">
                         <option value="" disabled>-- Select a video --</option>
                         <option v-for="video in farmerVideos.filter(v => v.purpose === 'sell' || v.purpose === 'agristream')" :key="video.cid" :value="video.cid">
                             {{video.crop}} - {{video.pesticide}} (Uploaded: {{new Date(video.uploadTimestamp).toLocaleDateString()}})
                         </option>
                     </select>
                     <p v-if="farmerVideos.filter(v => v.purpose === 'sell' || v.purpose === 'agristream').length === 0" class="text-xs text-red-500 mt-1">
                         No videos marked for 'sell' or 'agristream' available. <a href="#" @click.prevent="switchPage('farmerPestiVid')" class="underline">Upload one first.</a>
                     </p>
                 </div>
                  <div v-if="listingForm.cid && selectedVideoForListing" class="p-3 bg-gray-50 rounded border text-xs">
                    Selected Video Details: {{selectedVideoForListing.crop}} / {{selectedVideoForListing.pesticide}} / {{selectedVideoForListing.location || 'N/A'}}
                  </div>

                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div><label class="block text-sm">Minimum Price (Credits/Unit)</label><input type="number" step="0.01" min="0" v-model.number="listingForm.minPrice" required class="w-full px-3 py-1.5 border rounded text-sm"></div>
                     <div><label class="block text-sm">Maximum Price (Credits/Unit)</label><input type="number" step="0.01" min="0" v-model.number="listingForm.maxPrice" required class="w-full px-3 py-1.5 border rounded text-sm"></div>
                 </div>
                 <div class="flex items-start">
                    <div class="flex items-center h-5"><input id="notifyBuyers" type="checkbox" v-model="listingForm.notifyBuyers" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300 rounded"></div>
                    <div class="ml-3 text-sm"><label for="notifyBuyers" class="font-medium text-gray-700">Notify potential buyers</label><p class="text-gray-500 text-xs">Checked by default. Uncheck if you don't want to send notifications for this listing.</p></div>
                 </div>
                 <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm" :disabled="!listingForm.cid">Create Listing</button>
             </form>
             <div v-if="createdListingId" class="mt-4 p-3 bg-green-50 border border-green-200 rounded text-sm">
                 Listing created successfully! Listing ID: {{ createdListingId }}.
                 <span v-if="listingNotificationSent"> Buyers have been notified.</span>
             </div>
         </div>

         <div class="mt-8">
             <h3 class="text-lg font-semibold text-gray-800 mb-3">Your Active Listings</h3>
             <div v-if="farmerListings.filter(l => l.status === 'active').length === 0" class="bg-white p-4 rounded shadow text-center text-gray-500">No active listings.</div>
             <div v-else class="space-y-4">
                 <div v-for="listing in farmerListings.filter(l => l.status === 'active')" :key="listing.id" class="bg-white p-4 rounded shadow">
                     <h4 class="font-bold">{{ listing.crop }} <span class="text-xs font-normal text-gray-500"> ({{ listing.pesticide }})</span></h4>
                     <p class="text-sm">Price Range: {{ listing.minPrice }} - {{ listing.maxPrice }} Credits</p>
                     <p class="text-xs text-gray-500">Location: {{ listing.location }} | Video CID: <a :href="ipfsUrl(listing.cid)" target="_blank" class="text-blue-500 hover:underline font-mono truncate" style="max-width:100px; display:inline-block;">{{ listing.cid }}</a></p>
                     <p class="text-xs text-gray-500">Status: <span class="capitalize font-medium" :class="listing.status === 'active' ? 'text-green-600' : 'text-red-600'">{{ listing.status }}</span></p>
                      <button @click="cancelListing(listing.id)" class="mt-2 text-xs bg-red-100 text-red-700 hover:bg-red-200 px-2 py-1 rounded">Cancel Listing</button>
                 </div>
             </div>
         </div>
    </section>
    <!-- Farmer Funding Section -->
    <section v-if="current==='farmerFunding' && isUserAuthenticated && role === 'farmer'" class="max-w-3xl mx-auto mt-6">
         <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-hand-holding-usd mr-2"></i>Get Funding for Your Projects</h2>
         <div class="bg-white p-6 rounded-lg shadow-md mb-8">
             <p class="text-gray-600 mb-4 text-sm">Request funding for your agricultural or renewable energy (APV) projects. Provide details and link a PestiVid video as proof or for project overview. Investors can then review and fund your project.</p>
             <form @submit.prevent="createFundingRequest" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Project Category</label>
                    <select v-model="fundingForm.projectCategory" required class="w-full px-3 py-2 border rounded bg-white text-sm mt-1">
                        <option value="agricultural">Agricultural Project</option>
                        <option value="renewable_energy">Renewable Energy (APV) Project</option>
                    </select>
                </div>

                <div><label class="block text-sm">Project Title / Name</label><input type="text" v-model="fundingForm.title" required class="w-full px-3 py-1.5 border rounded text-sm"></div>

                <template v-if="fundingForm.projectCategory === 'agricultural'">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm">Crop Name</label><input type="text" v-model="fundingForm.crop" required class="w-full px-3 py-1.5 border rounded text-sm"></div>
                        <div><label class="block text-sm">Acres</label><input type="number" step="0.1" min="0.1" v-model.number="fundingForm.acres" required class="w-full px-3 py-1.5 border rounded text-sm"></div>
                    </div>
                    <div>
                        <label class="block text-sm">Growing Method</label>
                        <select v-model="fundingForm.method" required class="w-full px-3 py-1.5 border rounded bg-white text-sm">
                            <option value="organic">Organic</option><option value="conventional">Conventional</option><option value="hydroponic">Hydroponic</option><option value="aquaponic">Aquaponic</option><option value="regenerative">Regenerative</option><option value="other">Other</option>
                        </select>
                    </div>
                </template>

                <template v-if="fundingForm.projectCategory === 'renewable_energy'">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm">Total Land Area for APV (Acres)</label><input type="number" step="0.1" min="0.1" v-model.number="fundingForm.acres" required class="w-full px-3 py-1.5 border rounded text-sm"></div>
                        <div><label class="block text-sm">Planned Solar Capacity (kW)</label><input type="number" step="1" min="1" v-model.number="fundingForm.solarCapacityKW" required class="w-full px-3 py-1.5 border rounded text-sm"></div>
                    </div>
                    <div>
                        <label class="block text-sm">Panel Mounting Type / APV System</label>
                        <select v-model="fundingForm.panelType" required class="w-full px-3 py-1.5 border rounded bg-white text-sm">
                             <option value="Elevated Single-Axis Tracker (20ft)">Elevated Single-Axis Tracker (20ft)</option>
                             <option value="Vertical Bifacial">Vertical Bifacial</option>
                             <option value="Fixed Elevated Canopy">Fixed Elevated Canopy</option>
                             <option value="Other">Other APV Setup</option>
                        </select>
                    </div>
                </template>

                 <div>
                     <label class="block text-sm">Relevant PestiVid Video (Optional)</label>
                     <select v-model="fundingForm.cid" class="w-full px-3 py-1.5 border rounded bg-white text-sm">
                         <option value="">-- No video / Select a video --</option>
                         <option v-for="video in farmerVideos.filter(v => v.purpose === 'funding' || v.purpose === 'agristream')" :key="video.cid" :value="video.cid">
                             {{video.crop || 'Project Video'}} - {{video.pesticide || 'Details'}} (Uploaded: {{new Date(video.uploadTimestamp).toLocaleDateString()}})
                         </option>
                     </select>
                 </div>
                 <div><label class="block text-sm">Project Description</label><textarea v-model="fundingForm.description" required rows="3" class="w-full px-3 py-1.5 border rounded text-sm"></textarea></div>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div><label class="block text-sm">Funding Amount Required (Credits)</label><input type="number" step="1" min="1" v-model.number="fundingForm.amount" required class="w-full px-3 py-1.5 border rounded text-sm"></div>
                     <div><label class="block text-sm">Project Timeline (Months)</label><input type="number" step="1" min="1" v-model.number="fundingForm.timeline" required class="w-full px-3 py-1.5 border rounded text-sm"></div>
                 </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div><label class="block text-sm">Expected ROI (%)</label><input type="number" step="0.1" min="0" v-model.number="fundingForm.roi" required class="w-full px-3 py-1.5 border rounded text-sm"></div>
                     <div><label class="block text-sm">Investor Share of Profit (%)</label><input type="number" step="0.1" min="0" max="80" v-model.number="fundingForm.investorShare" required class="w-full px-3 py-1.5 border rounded text-sm"></div>
                 </div>
                 <div class="flex items-start">
                    <div class="flex items-center h-5"><input id="notifyInvestors" type="checkbox" v-model="fundingForm.notifyInvestors" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300 rounded"></div>
                    <div class="ml-3 text-sm"><label for="notifyInvestors" class="font-medium text-gray-700">Notify potential investors</label><p class="text-gray-500 text-xs">Checked by default.</p></div>
                 </div>
                 <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">Create Funding Request</button>
             </form>
             <div v-if="createdFundingRequest" class="mt-4 p-3 bg-green-50 border border-green-200 rounded text-sm">
                 Funding request created successfully! It's now visible to investors.
             </div>
         </div>

         <div class="mt-8">
             <h3 class="text-lg font-semibold text-gray-800 mb-3">Your Funding Requests</h3>
             <div v-if="farmerFundingRequests.length === 0" class="bg-white p-4 rounded shadow text-center text-gray-500">No funding requests yet.</div>
             <div v-else class="space-y-4">
                 <div v-for="req in farmerFundingRequests" :key="req.id" class="bg-white p-4 rounded shadow">
                     <div class="flex justify-between items-start">
                         <div>
                            <h4 class="font-bold text-md">{{ req.title }}
                                <span class="ml-2 text-xs capitalize px-2 py-0.5 rounded-full font-medium" :class="getProjectCategoryColor(req.projectCategory || req.projectType)">
                                    {{ (req.projectCategory || req.projectType) | projectTypeDisplay }}
                                </span>
                            </h4>
                            <p class="text-sm text-gray-600">{{ getFundingProjectPrimaryDisplay(req) }}</p>
                         </div>
                         <span :class="{'px-2 py-1 text-xs rounded-full':true, 'bg-yellow-100 text-yellow-800': req.status==='pending' || req.status==='partially_funded', 'bg-green-100 text-green-800': req.status==='funded', 'bg-red-100 text-red-800': req.status==='cancelled'}">{{ req.status | capitalize }}</span>
                     </div>
                     <p class="text-sm mt-1">Amount: {{ req.amount }} Credits (Funded: {{ req.fundedAmount || 0 }})</p>
                     <p class="text-xs text-gray-500">ROI: {{ req.roi }}% | Timeline: {{ req.timeline }} months</p>
                     <div class="progress-bar mt-2 mb-1"><div class="progress-fill bg-green-500" :style="{width: fundingProgressPercent(req) + '%'}"></div></div>
                     <p class="text-xs text-gray-500">{{ fundingProgressPercent(req) }}% Complete</p>

                     <div class="mt-3 pt-3 border-t">
                        <h5 class="text-xs font-semibold mb-1">Post Update for Investors:</h5>
                        <div class="flex gap-2">
                            <input type="text" v-model="newUpdateText[req.id]" placeholder="E.g., Planting completed, Solar panels arrived" class="flex-grow px-2 py-1 border rounded text-xs">
                            <button @click="postProjectUpdate(req.id)" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs" :disabled="!newUpdateText[req.id] || newUpdateText[req.id].trim() === ''">Post</button>
                        </div>
                        <div v-if="req.updates && req.updates.length > 0" class="mt-2">
                            <h6 class="text-xs font-semibold text-gray-600 mb-1">Recent Updates:</h6>
                            <div class="project-updates-list text-xs" style="max-height: 80px;">
                                <div v-for="update in req.updates.slice().reverse().slice(0,3)" :key="update.id" class="project-update-item">
                                    <span class="font-medium text-gray-500">{{ update.date }}:</span> {{ update.text }}
                                </div>
                            </div>
                        </div>
                     </div>
                     <button v-if="req.status === 'pending' || req.status === 'partially_funded'" @click="cancelFundingRequest(req.id)" class="mt-3 text-xs bg-red-100 text-red-700 hover:bg-red-200 px-2 py-1 rounded">Cancel Request</button>
                 </div>
             </div>
         </div>
    </section>
    <!-- Buyer AgriSell Section -->
    <section v-if="current==='buyerAgriSell' && isUserAuthenticated && role === 'buyer'" class="max-w-6xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-shopping-basket mr-2"></i>AgriSell Marketplace</h2>
        <div class="bg-white rounded shadow-md p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-3">Filter Listings</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div> <label class="block text-gray-600">Crop Type</label> <input type="text" v-model="buyerFilters.crop" placeholder="e.g., Tomatoes" class="w-full px-2 py-1 border rounded"> </div>
                <div> <label class="block text-gray-600">Location (Field ID)</label> <input type="text" v-model="buyerFilters.location" placeholder="e.g., West Field" class="w-full px-2 py-1 border rounded"> </div>
                <div> <label class="block text-gray-600">Pesticide Company</label> <input type="text" v-model="buyerFilters.pesticideCompany" placeholder="e.g., Organic Solutions" class="w-full px-2 py-1 border rounded"> </div>
            </div>
        </div>

        <div v-if="filteredListings.length === 0" class="bg-white p-8 text-center rounded-lg shadow">
            <i class="fas fa-search text-gray-300 text-4xl mb-3"></i>
            <h3 class="text-gray-600 text-lg mb-2">No Listings Found</h3>
            <p class="text-gray-500">Try adjusting your filters or check back later for new crop listings.</p>
        </div>

        <div class="grid gap-6 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
            <div v-for="listing in filteredListings" :key="listing.id" class="bg-white rounded-lg shadow overflow-hidden">
                 <div class="p-5">
                    <h3 class="font-bold text-lg text-green-800">{{ listing.crop }}</h3>
                    <p class="text-sm text-gray-600">{{ listing.pesticide }} ({{listing.pesticideCompany || 'N/A'}})</p>
                    <p class="text-xs text-gray-500 mb-3">Location: {{ listing.location || 'N/A' }}</p>

                    <video :src="ipfsUrl(listing.cid)" controls playsinline webkit-playsinline class="w-full h-48 object-cover rounded bg-black border mb-3"></video>

                    <div class="text-sm">
                        <p><strong>Price Range:</strong> {{ listing.minPrice }} - {{ listing.maxPrice }} Credits/Unit</p>
                        <p class="text-xs"><strong>Farmer:</strong> {{ getFarmerDisplayIdentifier(listing.farmerWallet) }}
                            <button @click="showFarmerProfile(listing.farmerWallet)" class="ml-1 text-blue-500 hover:text-blue-700 text-xs focus:outline-none" title="View Farmer Info"><i class="fas fa-info-circle"></i></button>
                        </p>
                        <p class="text-xs mt-1"><strong>Video Hash (IPFS):</strong> <span class="font-mono break-all" :title="listing.videoFileHash">{{ listing.videoFileHash ? listing.videoFileHash.substring(0,15) + '...' : 'N/A'}}</span></p>
                    </div>
                    <div class="mt-4 pt-4 border-t flex flex-col sm:flex-row justify-between items-center">
                        <button @click="showBuyItemModal(listing)" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm w-full sm:w-auto mb-2 sm:mb-0">
                            <i class="fas fa-shopping-cart mr-1"></i> Buy Now
                        </button>
                        <button @click="startOrGoToConversation(listing.farmerWallet)" class="text-blue-600 hover:text-blue-700 text-xs border border-blue-400 rounded-full px-3 py-1 hover:bg-blue-50 flex items-center justify-center">
                            <i class="fas fa-envelope mr-1"></i> Message Farmer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Investor Projects Section -->
    <section v-if="current==='investorProjects' && isUserAuthenticated && role === 'investor'" class="max-w-6xl mx-auto mt-6">
      <h2 class="text-2xl font-bold text-green-700 mb-3">
          <i class="fas fa-project-diagram mr-2"></i>Investment Opportunities
          <span v-if="investorFilters.projectCategory === 'renewable_energy'" class="text-yellow-600 ml-2">(Renewable Energy Focus)</span>
      </h2>
      <div class="bg-white rounded shadow-md p-6 mb-7">
        <div class="flex flex-col md:flex-row md:items-end gap-5">
          <div class="w-full md:w-auto">
            <label class="text-gray-600 text-sm">Project Category</label>
            <select v-model="investorFilters.projectCategory" class="w-full px-2 py-1 border rounded bg-white text-sm">
                <option value="">All Projects</option>
                <option value="agricultural">Agricultural</option>
                <option value="renewable_energy">Renewable Energy (APV)</option>
            </select>
          </div>
          <template v-if="investorFilters.projectCategory === 'agricultural' || investorFilters.projectCategory === ''">
            <div class="w-full md:w-48"> <label class="text-gray-600 text-sm">Crop Type</label> <select v-model="investorFilters.crop" class="w-full px-2 py-1 border rounded bg-white text-sm"> <option value="">All Crops</option> <option v-for="c in uniqueFundingCrops" :key="c">{{c}}</option> </select> </div>
            <div class="w-full md:w-48"> <label class="text-gray-600 text-sm">Growing Method</label> <select v-model="investorFilters.method" class="w-full px-2 py-1 border rounded bg-white text-sm"> <option value="">All Methods</option> <option value="organic">Organic</option> <option value="conventional">Conventional</option> <option value="hydroponic">Hydroponic</option> <option value="aquaponic">Aquaponic</option> <option value="regenerative">Regenerative</option> </select> </div>
          </template>
           <template v-if="investorFilters.projectCategory === 'renewable_energy'">
                <div class="w-full md:w-48"> <label class="text-gray-600 text-sm">Min Capacity (kW)</label> <input type="number" v-model.number="investorFilters.minCapacity" class="w-full px-2 py-1 border rounded text-sm" placeholder="e.g., 50"> </div>
           </template>
          <div class="w-full md:w-48"> <label class="text-gray-600 text-sm">Min ROI (%)</label> <input type="number" v-model.number="investorFilters.minRoi" class="w-full px-2 py-1 border rounded text-sm" placeholder="e.g., 10"> </div>
          <div class="w-full md:w-auto"> <label class="text-gray-600 text-sm">Max Funding Needed</label> <input type="number" v-model.number="investorFilters.maxAmount" class="w-full px-2 py-1 border rounded text-sm" placeholder="e.g., 10000"> </div>
          <button type="button" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-1 rounded text-sm mt-2 md:mt-0" @click="resetInvestorFilters"> <i class="fas fa-undo mr-1"></i> Reset </button>
        </div>
      </div>
      <div class="grid gap-6 grid-cols-1 lg:grid-cols-2">
        <div v-for="project in filteredFundingRequests" :key="project.id" class="bg-white rounded-lg shadow overflow-hidden relative">
            <div v-if="project.isNew" class="new-badge">NEW</div>
            <div class="p-5 bg-gray-50 border-b flex flex-col sm:flex-row justify-between sm:items-center">
                <div class="flex items-center mb-2 sm:mb-0">
                    <i :class="getProjectIconClass(project.projectCategory || project.projectType)" class="mr-2 text-xl"></i>
                    <h3 class="font-bold text-lg text-green-800">{{ project.title }}</h3>
                </div>
                 <span class="px-2 py-1 rounded text-xs font-medium self-start sm:self-center capitalize"
                      :class="getProjectCategoryColor(project.projectCategory || project.projectType)">
                    {{ (project.projectCategory || project.projectType) | projectTypeDisplay }}
                </span>
            </div>
          <div class="p-5">
            <div class="flex flex-col md:flex-row gap-6">
              <div class="md:w-1/3">
                 <video v-if="project.cid" :src="ipfsUrl(project.cid)" controls playsinline webkit-playsinline class="rounded w-full h-40 object-cover bg-black mb-3"></video>
                 <img v-else-if="project.projectCategory === 'renewable_energy' || project.projectType === 'renewable_energy'" src="https://via.placeholder.com/300x160.png?text=APV+Project" alt="Renewable Energy Project" class="rounded w-full h-40 object-cover bg-gray-200 mb-3">
                 <div v-else class="rounded w-full h-40 bg-gray-100 flex items-center justify-center mb-3">
                    <i class="fas fa-image text-gray-400 text-4xl"></i> (No Media)
                 </div>
                 <div class="grid grid-cols-2 gap-2 text-sm">
                    <div> <div class="text-xs text-gray-500">Farmer/Dev</div> <div class="font-medium truncate flex items-center"> <span>{{ getFarmerDisplayIdentifier(project.farmerWallet) }}</span> <button @click="showFarmerProfile(project.farmerWallet)" class="ml-2 text-blue-500 hover:text-blue-700 text-xs focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> </div> </div>
                    <template v-if="project.projectCategory === 'agricultural' || project.projectType === 'agricultural'">
                        <div> <div class="text-xs text-gray-500">Land Size</div> <div class="font-medium">{{ project.acres }} acres</div> </div>
                    </template>
                    <template v-if="project.projectCategory === 'renewable_energy' || project.projectType === 'renewable_energy'">
                         <div> <div class="text-xs text-gray-500">Capacity</div> <div class="font-medium">{{ project.solarCapacityKW || 'N/A' }} kW</div> </div>
                         <div> <div class="text-xs text-gray-500">Acres</div> <div class="font-medium">{{ project.acres || 'N/A' }}</div> </div>
                    </template>
                    <div> <div class="text-xs text-gray-500">Timeline</div> <div class="font-medium">{{ project.timeline }} months</div> </div>
                    <div> <div class="text-xs text-gray-500">Expected ROI</div> <div class="font-medium text-green-700">{{ project.roi }}%</div> </div>
                 </div>
                <button @click="startOrGoToConversation(project.farmerWallet)" v-if="currentUserIdentifier !== project.farmerWallet" class="mt-3 w-full text-xs text-blue-600 hover:text-blue-700 border border-blue-400 rounded-full px-3 py-1 hover:bg-blue-50 flex items-center justify-center"> <i class="fas fa-envelope mr-1"></i> Message Farmer/Dev </button>
              </div>
              <div class="md:w-2/3">
                <div class="mb-4">
                    <div class="text-sm font-medium mb-1">{{ getFundingProjectPrimaryDisplay(project) }}</div>
                    <p class="text-sm text-gray-700 max-h-20 overflow-y-auto">{{ project.description }}</p>
                </div>
                 <div class="mb-4"> <div class="text-xs text-gray-500 mb-1">Funding Progress</div> <div class="progress-bar"> <div class="progress-fill bg-green-500" :style="{width: fundingProgressPercent(project) + '%'}"></div> </div> <div class="flex justify-between text-xs mt-1"> <span>{{ project.fundedAmount || 0 }} / {{ project.amount }} Credits</span> <span>{{ fundingProgressPercent(project) }}% Complete</span> </div> </div>
                 <div v-if="project.updates && project.updates.length > 0" class="mb-4"> <h4 class="text-sm font-semibold text-gray-700 mb-2">Recent Farmer Updates</h4> <div class="project-updates-list text-xs" style="max-height: 70px;"> <div v-for="update in project.updates.slice().reverse().slice(0,2)" :key="update.id" class="project-update-item"> <span class="font-medium text-gray-500">{{ update.date }}:</span> {{ update.text }} </div> </div> </div>
                 <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <div class="text-sm font-medium">Investment Terms</div>
                        <div class="text-xs text-gray-500">Investor Share: {{ project.investorShare }}% of profit</div>
                    </div>
                    <div class="p-3 bg-yellow-50 rounded text-sm border border-yellow-200">
                        <p>Invest to receive {{ project.investorShare }}% of the profits
                           <span v-if="project.projectCategory === 'renewable_energy' || project.projectType === 'renewable_energy'"> (from energy sales)</span>,
                           proportional to your investment. Expected return is {{ project.roi }}% over {{ project.timeline }} months.
                        </p>
                    </div>
                 </div>
                 <div class="flex flex-col sm:flex-row justify-between items-center mt-4 pt-4 border-t"> <div class="mb-3 sm:mb-0"> <label :for="'investment-amount-'+project.id" class="text-xs text-gray-500 block mb-1">Your Investment (Credits)</label> <input v-model.number="investmentAmounts[project.id]" type="number" :id="'investment-amount-'+project.id" class="px-3 py-1 border rounded w-full sm:w-32 text-sm" min="0.1" :max="maxInvestmentAmount(project)" step="0.1" :disabled="project.status === 'funded' || role !== 'investor'" :placeholder="maxInvestmentAmount(project) > 0 ? `Max ${maxInvestmentAmount(project)}` : 'Funded'"> </div> <button @click="investInProject(project)" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm w-full sm:w-auto" :disabled="project.status === 'funded' || role !== 'investor' || !investmentAmounts[project.id] || investmentAmounts[project.id] <= 0 || investmentAmounts[project.id] > maxInvestmentAmount(project)"> <i class="fas fa-coins mr-1"></i> {{ project.status === 'funded' ? 'Fully Funded' : (role !== 'investor' ? 'Switch to Investor Role' : 'Invest Now') }} </button> </div>
                 <div v-if="investmentErrors[project.id]" class="text-red-500 text-xs mt-2">{{ investmentErrors[project.id] }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div v-if="filteredFundingRequests.length === 0" class="bg-gray-50 p-8 text-center rounded-lg mt-4"> <i class="fas fa-seedling text-gray-300 text-4xl mb-3"></i> <h3 class="text-gray-600 text-lg mb-2">No Projects Found</h3> <p class="text-gray-500">Try adjusting your filters or check back later for new investment opportunities.</p> </div>
    </section>
    <!-- Investor Portfolio Section -->
    <section v-if="current==='investorPortfolio' && isUserAuthenticated && role === 'investor'" class="max-w-6xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-chart-pie mr-2"></i>Investment Portfolio</h2>
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Portfolio Overview</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6"> <div class="mb-4 md:mb-0"> <div class="text-xs text-gray-500">Total Invested</div> <div class="text-2xl font-bold text-green-700">{{ totalInvestedAmount }} Credits</div> </div> <div> <div class="text-xs text-gray-500">Active Projects</div> <div class="text-xl font-bold">{{ investorActiveProjects }}</div> </div> <div> <div class="text-xs text-gray-500">Completed</div> <div class="text-xl font-bold">{{ investorCompletedProjects }}</div> </div> <div> <div class="text-xs text-gray-500">Avg. ROI</div> <div class="text-xl font-bold text-green-700">{{ investorAvgRoi }}%</div> </div> </div>
        </div>
        <div class="bg-white rounded-lg shadow overflow-hidden mb-8">
            <div class="px-6 py-4 bg-gray-50 border-b"> <h3 class="text-lg font-semibold text-gray-800">Your Active Investments</h3> </div>
            <div v-if="investorInvestments.length === 0" class="p-8 text-center"> <i class="fas fa-chart-line text-gray-300 text-4xl mb-3"></i> <h4 class="text-gray-600 text-lg mb-2">No Active Investments</h4> <p class="text-gray-500 mb-4">You haven't invested in any agricultural projects yet.</p> <button @click="switchPage('investorProjects')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm"> <i class="fas fa-search mr-1"></i>Browse Projects </button> </div>
            <div v-else class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50"> <tr> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Farmer/Dev</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invested (Credits)</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expected Return (Credits)</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th> </tr> </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                <tr v-for="investment in investorInvestments" :key="investment.id">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900 flex items-center">
                            <i :class="getProjectIconClass(investment.projectCategory || investment.projectType)" class="mr-2"></i>
                            {{ investment.projectTitle }}
                        </div>
                        <div class="text-xs text-gray-500 ml-5">{{ getInvestmentPortfolioSubDisplay(investment) }}</div>
                    </td>
                     <td class="px-6 py-4 whitespace-nowrap text-sm capitalize" :class="getProjectCategoryColor(investment.projectCategory || investment.projectType).replace('bg-', 'text-').replace('-100', '-800')"> {{ (investment.projectCategory || investment.projectType) | projectTypeDisplay }} </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm text-gray-900">{{ getFarmerDisplayIdentifier(investment.farmerWallet, 10) }}</div> <button @click="showFarmerProfile(investment.farmerWallet)" class="text-blue-500 hover:text-blue-700 text-xs focus:outline-none mr-2" title="View Farmer Info"> <i class="fas fa-info-circle mr-1"></i>View Info </button> <button @click="startOrGoToConversation(investment.farmerWallet)" v-if="currentUserIdentifier !== investment.farmerWallet" class="text-green-600 hover:text-green-700 text-xs focus:outline-none" title="Message Farmer"> <i class="fas fa-envelope mr-1"></i>Message </button> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-mono text-gray-900">{{ investment.amount }}</div> <div class="text-xs text-gray-500">{{ investment.investmentDate }}</div> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="w-24 bg-gray-200 rounded-full h-2.5"> <div class="bg-green-600 h-2.5 rounded-full" :style="{width: investment.progress+'%'}"></div> </div> <div class="text-xs text-gray-500 mt-1">{{ investment.progress }}% Complete</div> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm text-gray-900 font-mono">{{ calculateExpectedReturn(investment) }}</div> <div class="text-xs text-gray-500">{{ investment.roi }}% ROI</div> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <span :class="{ 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true, 'bg-blue-100 text-blue-800': investment.status === 'active', 'bg-green-100 text-green-800': investment.status === 'harvested' || investment.status === 'completed', 'bg-yellow-100 text-yellow-800': investment.status === 'growing' || investment.status === 'generating' }"> {{ investment.status.charAt(0).toUpperCase() + investment.status.slice(1) }} </span> </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600"> <a href="#" @click.prevent="viewInvestmentDetails(investment)" class="hover:underline">View</a> </td>
                </tr>
                </tbody>
            </table>
            </div>
        </div>
         <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 bg-gray-50 border-b flex justify-between items-center"> <h3 class="text-lg font-semibold text-gray-800">Platform Transaction History (Simulated)</h3> <span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded-full flex items-center"> <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 16 15"><path d="m7.81 0-1.78 3.69L1.88 4.2l2.92 2.52L4.04 10 7.8 7.97 11.55 10l-.77-3.28 2.92 2.52-4.15-.51L7.82 0h-.01Zm0 15-1.78-3.69-4.15-.51 2.92-2.52L4.04 5 7.8 7.03 11.55 5l-.77 3.28 2.92 2.52-4.15-.51L7.82 15h-.01Z"></path></svg> PestiVid Platform (Simulated Ledger) </span> </div>
            <div v-if="investorTransactions.length === 0" class="p-8 text-center"> <i class="fas fa-cubes text-gray-300 text-4xl mb-3"></i> <h4 class="text-gray-600 text-lg mb-2">No Transactions Yet</h4> <p class="text-gray-500">Your investment and payout transactions on the platform will appear here.</p> </div>
            <div v-else class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50"> <tr> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Transaction ID</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount (Credits)</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th> </tr> </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                <tr v-for="tx in investorTransactions" :key="tx.id">
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="flex items-center"> <div class="text-sm font-mono text-gray-900 truncate max-w-[150px] sm:max-w-[250px]" :title="tx.txHash">{{ tx.txHash.substring(0,10) }}...{{ tx.txHash.substring(tx.txHash.length-10) }}</div> </div> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <span :class="{ 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true, 'bg-green-100 text-green-800': tx.type === 'investment', 'bg-blue-100 text-blue-800': tx.type === 'payout' }"> {{ tx.type === 'investment' ? 'Investment' : (tx.type === 'payout' ? getPayoutTypeDisplay(tx.projectCategory || tx.projectType) : tx.type) }} </span> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-mono text-gray-900">{{ tx.amount }}</div> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800"> Confirmed (Sim.) </span> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm text-gray-900">{{ tx.date }}</div> </td>
                </tr>
                </tbody>
            </table>
            </div>
        </div>
    </section>
    <!-- User Profile Section -->
    <section v-if="current==='userProfile' && isUserAuthenticated" class="max-w-6xl mx-auto mt-6">
         <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="bg-gradient-to-r from-green-700 to-green-500 p-6 text-white">
          <div class="flex flex-col md:flex-row justify-between items-center">
            <div class="flex items-center mb-4 md:mb-0">
              <div class="bg-white rounded-full w-16 h-16 flex items-center justify-center mr-4 text-green-600 shadow overflow-hidden">
                <i :class="role === 'farmer' ? 'fas fa-tractor' : (role === 'buyer' ? 'fas fa-shopping-cart' : 'fas fa-chart-line')" class="text-3xl"></i>
              </div>
              <div> <h2 class="text-2xl font-bold">{{ userName }}</h2> <p class="text-green-100 capitalize"> {{ role === 'farmer' ? 'Agricultural Producer' : role === 'buyer' ? 'Crop Buyer' : 'Agricultural Investor' }} </p> </div>
            </div>
            <div class="bg-white bg-opacity-20 rounded-lg px-4 py-2 flex items-center text-sm"> <i class="fas fa-certificate mr-2"></i> <span>{{ role === 'farmer' ? 'Verified Farmer' : role === 'buyer' ? 'Verified Buyer' : 'Verified Investor' }} (PestiVid Status)</span> </div>
          </div>
        </div>
        <div class="p-6">
          <div class="mb-8">
            <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-id-card mr-2"></i>Account Information </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
              <div>
                <div class="mb-4"> <p class="text-gray-600">Full Name (PestiVid)</p> <p class="font-medium">{{ userName }}</p> </div>
                <div class="mb-4"> <p class="text-gray-600">PestiVid User Identifier (Email)</p> <p class="font-medium font-mono break-all">{{ currentUserIdentifier }}</p> </div>
                <div> <p class="text-gray-600">PestiVid Account Type</p> <p class="font-medium capitalize">{{ role || "Not Set" }}</p> </div>
              </div>
              <div>
                <div class="mb-4"> <p class="text-gray-600">Email (PestiVid)</p> <p class="font-medium">{{ userEmail }}</p> </div>
                <div class="mb-4"> <p class="text-gray-600">Phone (PestiVid)</p> <p class="font-medium">{{ userPhone || 'Not Provided' }}</p> </div>
                <div> <p class="text-gray-600">PestiVid Member Since</p> <p class="font-medium">{{ memberSince || 'N/A' }}</p> </div>
              </div>
            </div>
             <!-- Role Switcher for Demo -->
            <div class="mt-6 border-t pt-6">
                <h4 class="text-lg font-semibold text-gray-700 mb-2">Switch Demo Role</h4>
                <p class="text-xs text-gray-500 mb-2">For demonstration purposes, you can switch your active role. This will update your profile and reload relevant data.</p>
                <select v-model="userProfileRoleForSwitch" @change="handleProfileRoleSwitch" class="w-full md:w-1/2 px-3 py-2 border rounded bg-white">
                    <option value="farmer">Farmer</option>
                    <option value="buyer">Buyer</option>
                    <option value="investor">Investor</option>
                </select>
            </div>
          </div>

          <div v-if="role === 'farmer'">
                <div class="mb-8"> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-video mr-2"></i>Your Uploaded Videos ({{ farmerVideos.length }}) </h3>
                    <div v-if="farmerVideos.length === 0" class="text-gray-500 text-center p-4 bg-gray-50 rounded">No videos uploaded yet.</div>
                    <!-- Placeholder for videos table -->
                </div>
                <div class="mb-8"> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-tags mr-2"></i>Your Active Listings ({{ farmerListings.length }}) </h3>
                    <div v-if="farmerListings.length === 0" class="text-gray-500 text-center p-4 bg-gray-50 rounded">No active listings.</div>
                     <!-- Placeholder for listings table -->
                </div>
                <div class="mb-8"> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-hand-holding-usd mr-2"></i>Your Funding Requests ({{ farmerFundingRequests.filter(r => r.projectCategory === 'agricultural' || r.projectType === 'agricultural').length }}) </h3>
                     <div v-if="farmerFundingRequests.filter(r => r.projectCategory === 'agricultural' || r.projectType === 'agricultural').length === 0" class="text-gray-500 text-center p-4 bg-gray-50 rounded">No agricultural funding requests.</div>
                    <!-- Placeholder for agri funding requests -->
                </div>
                <div> <h3 class="text-xl font-bold text-yellow-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-solar-panel mr-2"></i>Your Agrivoltaic (APV) Projects ({{ farmerAPVProjects.length }}) </h3>
                    <div v-if="farmerAPVProjects.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center"> <i class="fas fa-sun text-gray-400 text-2xl mb-2"></i> <p>You haven't set up any APV projects yet.</p> <button @click="switchPage('renewableEnergyHub')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Manage APV Projects</button> </div>
                    <div v-else class="space-y-4">
                        <div v-for="apv in farmerAPVProjects" :key="apv.id" class="border rounded-lg bg-white shadow-sm p-4">
                            <h4 class="font-bold text-lg">{{ apv.projectName }}</h4>
                            <p class="text-sm text-gray-600">{{ apv.description }}</p>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mt-3 text-xs">
                                <div><span class="font-semibold">Acres:</span> {{ apv.acres }}</div>
                                <div><span class="font-semibold">Capacity:</span> {{ apv.solarCapacityKW }} kW</div>
                                <div><span class="font-semibold">Panel Type:</span> {{ apv.panelType }}</div>
                                <div><span class="font-semibold">Status:</span> <span class="capitalize">{{ apv.status.replace('_', ' ') }}</span></div>
                                <div><span class="font-semibold">Est. Earnings/Acre/Month:</span> {{ apv.estimatedMonthlyEarningsPerAcre }} Lakhs</div>
                            </div>
                            <button @click="switchPage('renewableEnergyHub'); setActiveAPVProjectForDashboard(apv.id)" class="mt-3 text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">View Dashboard</button>
                        </div>
                    </div>
                </div>
            </div>
           <div v-if="role === 'buyer'">
                <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-history mr-2"></i>Your Purchase History ({{ buyerPurchases.length }})</h3>
                <div v-if="buyerPurchases.length === 0" class="text-gray-500 text-center p-4 bg-gray-50 rounded">No purchases made yet.</div>
                <!-- Placeholder for buyer purchase history table -->
            </div>
           <div v-if="role === 'investor'">
                 <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-briefcase mr-2"></i>Your Investment Summary</h3>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div><p class="text-gray-600">Total Invested</p><p class="font-medium text-lg">{{ totalInvestedAmount }} Credits</p></div>
                    <div><p class="text-gray-600">Active Projects</p><p class="font-medium text-lg">{{ investorActiveProjects }}</p></div>
                    <div><p class="text-gray-600">Avg. ROI</p><p class="font-medium text-lg text-green-600">{{ investorAvgRoi }}%</p></div>
                 </div>
                 <button @click="switchPage('investorPortfolio')" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm">View Full Portfolio</button>
            </div>
        </div>
      </div>
    </section>
    <!-- Messaging Section -->
    <section v-if="current==='messaging' && isUserAuthenticated" class="max-w-6xl mx-auto mt-6 h-[calc(100vh-150px)] flex flex-col">
        <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-comments mr-2"></i>Secure Messaging</h2>
        <div class="flex-1 flex bg-white rounded-lg shadow-md overflow-hidden">
            <!-- Conversation List -->
            <div class="w-1/3 border-r flex-shrink-0">
                <div class="p-4 border-b bg-gray-50">
                    <h3 class="font-semibold">Conversations <span v-if="unreadMessageCount > 0" class="text-xs text-red-500">({{unreadMessageCount}} new)</span></h3>
                </div>
                <div class="overflow-y-auto h-[calc(100%-65px)]">
                    <div v-if="conversations.length === 0" class="p-4 text-sm text-gray-500 text-center">No conversations yet.</div>
                    <div v-for="conv in conversations" :key="conv.id"
                         @click="setActiveConversation(conv.id)"
                         class="p-3 border-b hover:bg-gray-100 cursor-pointer"
                         :class="{'bg-green-50 font-semibold': activeConversationId === conv.id}">
                        <div class="flex justify-between items-center">
                            <span class="truncate">{{ getOtherParticipantName(conv) }}</span>
                            <span v-if="conv.unreadCount > 0" class="bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5">{{ conv.unreadCount }}</span>
                        </div>
                        <p class="text-xs text-gray-500 truncate">{{ conv.lastMessagePreview }}</p>
                        <p class="text-xs text-gray-400 text-right">{{ formatTimestamp(conv.lastMessageTimestamp) }}</p>
                    </div>
                </div>
            </div>
            <!-- Message View -->
            <div class="w-2/3 flex flex-col">
                <div v-if="!activeConversationId" class="flex-1 flex flex-col items-center justify-center text-gray-500 p-4">
                    <i class="fas fa-envelope-open-text text-5xl mb-4 text-gray-300"></i>
                    <p>Select a conversation to view messages.</p>
                    <p class="text-sm mt-1">Or start a new one by messaging a farmer or investor from their profile/project page.</p>
                </div>
                <div v-else class="flex-1 flex flex-col">
                    <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                        <h3 class="font-semibold">{{ getOtherParticipantName(activeConversation) }}</h3>
                        <!-- Add actions like view profile here if needed -->
                    </div>
                    <div ref="messageViewContainer" class="flex-grow p-4 overflow-y-auto space-y-4 bg-gray-100 message-view-container">
                        <div v-for="message in getConversationMessages(activeConversationId)" :key="message.id"
                             :class="['chat-message', message.sender === currentUserIdentifier ? 'user' : 'bot']"> <!-- Using bot class for receiver style -->
                             <div class="avatar">
                                {{ message.sender === currentUserIdentifier ? userName.charAt(0).toUpperCase() : getOtherParticipantName(activeConversation).charAt(0).toUpperCase() }}
                            </div>
                            <div class="message-content">
                                <div class="message-bubble" v-html="renderMarkdown(message.text)"></div>
                            </div>
                        </div>
                         <div v-if="isTyping" class="chat-message bot">
                            <div class="avatar">
                                {{ getOtherParticipantName(activeConversation).charAt(0).toUpperCase() }}
                            </div>
                            <div class="message-content">
                                <div class="message-bubble typing-indicator"><span></span><span></span><span></span></div>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 border-t bg-white">
                        <form @submit.prevent="sendMessage" class="flex gap-2">
                            <input type="text" v-model="messageInputText" placeholder="Type your message..."
                                   class="flex-grow px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" @input="handleTyping">
                            <button type="submit" :disabled="!messageInputText.trim()"
                                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md font-semibold disabled:bg-gray-400">
                                Send <i class="fas fa-paper-plane ml-1"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Plant Recommendation Section -->
    <section v-if="current==='plantRecommendation' && isUserAuthenticated" class="max-w-3xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-leaf mr-2"></i>Plant Health Analyzer (Demo)</h2>
        <div class="bg-white p-6 rounded-lg shadow-md">
            <p class="text-gray-600 mb-4 text-sm">Upload an image of a plant leaf. Our AI (powered by Google Gemini Pro Vision - Demo) will try to identify the plant, detect potential diseases, and suggest treatments.</p>

            <div class="mb-4">
                <label for="plant-image-upload" class="block text-sm font-medium text-gray-700 mb-1">Upload Plant Image</label>
                <input type="file" id="plant-image-upload" @change="handlePlantImageUpload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
            </div>

            <div v-if="plantImageUrl" class="my-4 text-center">
                <img :src="plantImageUrl" alt="Uploaded Plant" class="max-w-xs max-h-64 mx-auto rounded-md border shadow-sm">
            </div>

            <button @click="analyzePlantImage" :disabled="!plantImageFile || analysisInProgress" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm flex items-center justify-center disabled:bg-gray-400">
                <i :class="analysisInProgress ? 'fas fa-spinner fa-spin' : 'fas fa-cogs'" class="mr-2"></i>
                {{ analysisInProgress ? 'Analyzing...' : 'Analyze Plant Image' }}
            </button>

            <div v-if="analysisErrorText" class="mt-4 text-red-600 bg-red-50 p-3 rounded border border-red-200 text-sm">
                <strong>Error:</strong> {{ analysisErrorText }}
            </div>

            <div v-if="parsedAnalysis.plantName || parsedAnalysis.diseaseName || parsedAnalysis.treatmentRecommended" class="mt-6 p-4 border rounded-lg bg-green-50">
                <h3 class="text-lg font-semibold text-green-800 mb-3">Analysis Results:</h3>
                <div v-if="parsedAnalysis.plantName" class="mb-2">
                    <strong class="text-gray-700">Plant Identified:</strong> {{ parsedAnalysis.plantName }}
                </div>
                <div v-if="parsedAnalysis.diseaseName" class="mb-2">
                    <strong class="text-gray-700">Potential Disease:</strong> {{ parsedAnalysis.diseaseName }}
                </div>
                <div v-if="parsedAnalysis.treatmentRecommended" class="mb-2">
                    <strong class="text-gray-700">Recommended Treatment:</strong>
                    <div class="prose prose-sm max-w-none mt-1" v-html="renderMarkdown(parsedAnalysis.treatmentRecommended)"></div>
                </div>
            </div>
             <div v-if="analysisResultText && !(parsedAnalysis.plantName || parsedAnalysis.diseaseName || parsedAnalysis.treatmentRecommended)" class="mt-4">
                <h4 class="text-md font-semibold text-gray-700 mb-2">Raw AI Response:</h4>
                <pre class="bg-gray-100 p-3 rounded text-xs max-h-60 overflow-y-auto">{{ analysisResultText }}</pre>
            </div>
        </div>
    </section>
    <!-- Fallback message -->
    <section v-if="!isUserAuthenticated && !['landing', 'login', 'signup', 'renewableAPVExplained', 'renewableEnergyHub'].includes(current)" class="max-w-md mx-auto mt-12 text-center">
        <div class="bg-white p-8 rounded-lg shadow-xl">
            <i class="fas fa-lock text-4xl text-yellow-500 mb-4"></i>
            <h2 class="text-xl font-semibold text-gray-700 mb-2">Access Denied</h2>
            <p class="text-gray-600 mb-4">You need to be logged in to view this page.</p>
            <button @click="switchPage('login')" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded transition">Login</button>
        </div>
    </section>


    <!-- SECTION: Renewable Energy Hub (Combines APV Explained and Farmer APV Dashboard) -->
    <section v-if="current==='renewableEnergyHub'" class="max-w-6xl mx-auto mt-6">
        <h2 class="text-3xl font-bold text-green-700 mb-6 flex items-center">
            <i class="fas fa-solar-panel mr-3 text-yellow-500"></i>Renewable Energy Hub
        </h2>

        <!-- Farmer APV Dashboard View -->
        <template v-if="isUserAuthenticated && role === 'farmer' && farmerAPVProjects.length > 0">
            <div class="bg-white rounded-lg shadow-xl p-6">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 pb-4 border-b">
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800">My Agrivoltaic (APV) Projects Dashboard</h3>
                        <p class="text-sm text-gray-500">Monitor and manage your on-farm solar energy projects.</p>
                    </div>
                    <button @click="showAddAPVProjectModal = true" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm mt-3 sm:mt-0">
                        <i class="fas fa-plus mr-1"></i> Add New APV Project
                    </button>
                </div>

                <div class="mb-6">
                    <label for="apvProjectSelect" class="block text-sm font-medium text-gray-700 mb-1">Select Project to View:</label>
                    <select id="apvProjectSelect" v-model="activeAPVProjectIdForDashboard" @change="handleAPVDashboardProjectChange" class="w-full md:w-1/2 px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                        <option v-for="project in farmerAPVProjects" :key="project.id" :value="project.id">{{ project.projectName }} ({{project.solarCapacityKW}}kW)</option>
                    </select>
                </div>

                <template v-if="selectedAPVProjectForDashboard">
                    <h4 class="text-lg font-semibold text-green-700 mb-4">Stats for: {{ selectedAPVProjectForDashboard.projectName }}</h4>
                    <!-- Key Stats Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-8">
                        <div class="dashboard-stat-card"> <div class="stat-icon text-green-500"><i class="fas fa-bolt"></i></div> <div class="stat-value">{{ dashboardStats.totalProduced }} kWh</div> <div class="stat-label">Total Produced</div> </div>
                        <div class="dashboard-stat-card"> <div class="stat-icon text-blue-500"><i class="fas fa-home"></i></div> <div class="stat-value">{{ dashboardStats.totalSelfConsumed }} kWh</div> <div class="stat-label">Farm Self-Consumed</div> </div>
                        <div class="dashboard-stat-card"> <div class="stat-icon text-purple-500"><i class="fas fa-cogs"></i></div> <div class="stat-value">{{ dashboardStats.totalTrackerConsumed }} kWh</div> <div class="stat-label">Tracker Consumption</div> </div>
                        <div class="dashboard-stat-card"> <div class="stat-icon text-yellow-500"><i class="fas fa-arrow-right-arrow-left"></i></div> <div class="stat-value">{{ dashboardStats.totalSold }} kWh</div> <div class="stat-label">Total Sold to Grid</div> </div>
                        <div class="dashboard-stat-card"> <div class="stat-icon text-red-500"><i class="fas fa-plug-circle-minus"></i></div> <div class="stat-value">{{ dashboardStats.netEnergy }} kWh</div> <div class="stat-label">Net Exportable Energy</div> </div>
                        <div class="dashboard-stat-card"> <div class="stat-icon text-teal-500"><i class="fas fa-coins"></i></div> <div class="stat-value">{{ dashboardStats.totalRevenue }} Credits</div> <div class="stat-label">Total Revenue (Sim.)</div> </div>
                    </div>

                    <!-- Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white p-4 rounded-lg shadow"> <h5 class="text-md font-semibold text-gray-700 mb-2">Energy Production Over Time (Last 30 Days)</h5> <div class="chart-container"><canvas ref="energyProductionChart"></canvas></div> </div>
                        <div class="bg-white p-4 rounded-lg shadow"> <h5 class="text-md font-semibold text-gray-700 mb-2">Energy Usage Distribution</h5> <div class="chart-container"><canvas ref="energyUsageChart"></canvas></div> </div>
                    </div>

                    <!-- Energy Log -->
                    <div class="mb-8">
                        <div class="flex justify-between items-center mb-3">
                             <h4 class="text-md font-semibold text-gray-700">Energy Log for {{ selectedAPVProjectForDashboard.projectName }}</h4>
                            <button @click="openEnergyLogModal(selectedAPVProjectForDashboard.id)" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded text-xs">
                                <i class="fas fa-plus-circle mr-1"></i> Add Log Entry
                            </button>
                        </div>
                        <div v-if="getEnergyLogsForProject(selectedAPVProjectForDashboard.id).length === 0" class="text-xs text-gray-500 bg-gray-50 p-3 rounded">No energy logs yet for this project.</div>
                        <div v-else class="max-h-60 overflow-y-auto border rounded p-3 bg-gray-50 space-y-2 text-xs">
                            <div v-for="log in getEnergyLogsForProject(selectedAPVProjectForDashboard.id).slice().reverse()" :key="log.id" class="p-2 border-b last:border-b-0 hover:bg-gray-100 transition-colors">
                                <p><strong>Date:</strong> {{ new Date(log.timestamp).toLocaleDateString() }}</p>
                                <p><strong>Produced:</strong> {{ log.energyProducedKWh }} kWh | <strong>Tracker:</strong> {{ log.trackerConsumptionKWh }} kWh | <strong>Self-Used:</strong> {{ log.farmSelfConsumptionKWh }} kWh | <strong>Sold:</strong> {{ log.energySoldKWh }} kWh</p>
                                <p><strong>Revenue:</strong> {{ log.revenueFromSale ? log.revenueFromSale.toFixed(2) : '0.00' }} Credits (at {{ log.salePricePerKWh }} Cr/kWh)</p>
                            </div>
                        </div>
                    </div>

                    <!-- Simulated Panel Optimization -->
                     <div class="bg-yellow-50 p-6 rounded-lg border border-yellow-200">
                        <h4 class="text-md font-semibold text-yellow-700 mb-3"><i class="fas fa-tools mr-2"></i>Simulated Panel Optimization</h4>
                        <div class="mb-4">
                            <p class="text-sm text-gray-700"><strong>Current Panel Status (Simulated):</strong>
                                <span v-if="selectedAPVProjectForDashboard.panelType.toLowerCase().includes('tracker')">Trackers Actively Following Sun (East-West).</span>
                                <span v-else-if="selectedAPVProjectForDashboard.panelType.toLowerCase().includes('fixed')">Fixed Optimal Angle for Location.</span>
                                <span v-else>Standard Operation Mode.</span>
                            </p>
                        </div>
                        <div class="mb-4">
                            <label for="optimizationScenario" class="block text-sm font-medium text-gray-700 mb-1">"What-If" Optimization Scenario:</label>
                            <select id="optimizationScenario" v-model="apvOptimizationScenario" class="w-full md:w-1/2 px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                                <option value="maximize_morning">Maximize Morning Sun Exposure</option>
                                <option value="maximize_midday">Maximize Midday Peak Production</option>
                                <option value="maximize_evening">Maximize Evening Sun Exposure</option>
                                <option value="increase_shade">Increase Midday Ground Shade</option>
                                <option value="balanced">Balanced All-Day Production</option>
                            </select>
                        </div>
                        <button @click="simulateAPVOptimization" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded text-sm">
                            <i class="fas fa-cogs mr-1"></i> Simulate Impact
                        </button>
                        <div v-if="apvOptimizationResult" class="mt-4 p-3 bg-yellow-100 rounded border border-yellow-300 text-sm">
                            <p><strong>Simulated Impact for "{{ apvOptimizationScenario.replace(/_/g, ' ') }}":</strong></p>
                            <p>{{ apvOptimizationResult }}</p>
                            <p class="text-xs text-yellow-700 mt-1"><i>Note: This is a conceptual simulation for demonstration. Actual results vary.</i></p>
                        </div>
                    </div>

                </template>
                <div v-else-if="farmerAPVProjects.length > 0" class="text-center text-gray-500 py-8">
                    <i class="fas fa-list-check text-3xl mb-3"></i>
                    <p>Please select an APV project from the dropdown above to view its dashboard.</p>
                </div>

            </div>
        </template>

        <!-- APV Explained View (for non-farmers or farmers without projects) -->
        <template v-else>
            <div class="bg-white rounded-lg shadow-xl p-8">
                 <div v-if="isUserAuthenticated && role === 'farmer' && farmerAPVProjects.length === 0" class="mb-6 p-4 bg-blue-50 border-l-4 border-blue-400 rounded-md">
                     <p class="text-blue-700">You haven't added any APV projects yet.
                        <button @click="showAddAPVProjectModal = true" class="ml-2 font-semibold underline hover:text-blue-800">Click here to add your first APV project</button> and start tracking its performance.
                     </p>
                 </div>
                <div class="prose max-w-none text-gray-700">
                    <p class="text-lg">Agrivoltaics (APV) is an innovative approach that combines solar photovoltaic (PV) power generation with agricultural production on the same piece of land. This dual-use system aims to optimize land efficiency, creating synergies between food and energy production.</p>
                    <h3 class="text-xl font-semibold text-green-600 mt-6 mb-3">How APV Works: Our Model</h3>
                    <p>PestiVid promotes a specific APV model designed for maximum synergy:</p>
                    <ul class="list-disc list-inside space-y-2 my-4">
                        <li><strong>Elevated Solar Panels:</strong> Solar panels are mounted approximately <strong>20 feet (around 6 meters)</strong> above the ground. This height allows sufficient clearance for most standard farming machinery and activities to continue underneath.</li>
                        <li><strong>Single-Axis Tracking System:</strong> The panels are equipped with trackers that follow the sun's path. They orient towards the **East in the morning** to capture early sunlight and gradually track towards the **West in the evening**. This maximizes energy capture throughout the day.</li>
                        <li><strong>Optimized Light for Crops:</strong> The tracking and spacing of panels are designed to allow adequate sunlight to reach the crops below, particularly beneficial for shade-tolerant or partially shade-tolerant crops. The partial shading can also reduce water stress and heat damage to certain plants.</li>
                        <li><strong>Dual Output:</strong> The land produces both agricultural crops and clean electricity.</li>
                    </ul>
                    <div class="my-6 p-6 bg-yellow-50 border-l-4 border-yellow-400 rounded-md">
                        <h4 class="text-lg font-semibold text-yellow-700 mb-2"><i class="fas fa-dollar-sign mr-1"></i>Simulated Earnings Potential (Example)</h4>
                        <p class="text-yellow-800">Based on our model and ideal conditions, farmers implementing this specific APV system could potentially earn an additional (simulated) income of approximately <strong class="font-bold">1 to 2 Lakhs (₹100,000 - ₹200,000) per acre per month</strong> from the sale of solar energy generated, in addition to their crop revenue.</p>
                        <p class="text-xs text-yellow-600 mt-2"><em>Disclaimer: This is a hypothetical projection for demonstration purposes within the PestiVid platform simulation. Actual earnings can vary significantly.</em></p>
                    </div>
                    <h3 class="text-xl font-semibold text-green-600 mt-6 mb-3">Benefits of This APV Model</h3>
                     <ul class="list-disc list-inside space-y-1">
                        <li><strong>Increased Land Productivity:</strong> Generate revenue from both crops and energy on the same land.</li>
                        <li><strong>Water Conservation:</strong> Shading can reduce soil moisture evaporation and plant water needs.</li>
                        <li><strong>Crop Protection:</strong> Panels can offer protection from extreme weather like hail or excessive heat.</li>
                        <li><strong>Reduced Energy Costs for Farm:</strong> On-site generated power can be used for farm operations.</li>
                        <li><strong>Contribution to Clean Energy:</strong> Helps in transitioning towards a sustainable energy future.</li>
                    </ul>
                    <h3 class="text-xl font-semibold text-green-600 mt-6 mb-3">Considerations</h3>
                     <ul class="list-disc list-inside space-y-1">
                        <li><strong>Initial Investment:</strong> Setting up APV systems can have higher upfront costs than traditional farming.</li>
                        <li><strong>Crop Suitability:</strong> Best suited for crops that can tolerate or benefit from partial shading.</li>
                        <li><strong>Technical Expertise:</strong> Requires knowledge in both farming and solar energy system maintenance.</li>
                        <li><strong>Grid Integration:</strong> Regulations and infrastructure for selling surplus power to the grid.</li>
                    </ul>
                    <div class="mt-8 text-center space-x-4">
                        <button v-if="isUserAuthenticated && role === 'investor'" @click="switchPage('investorProjects', { category: 'renewable_energy' })" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded transition"><i class="fas fa-hand-holding-usd mr-1"></i> Invest in APV Projects</button>
                        <button v-if="!isUserAuthenticated" @click="switchPage('signup')" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded transition"><i class="fas fa-user-plus mr-1"></i> Get Started with PestiVid</button>
                    </div>
                </div>
            </div>
        </template>

         <!-- Add APV Project Modal (shared with farmerAPVDashboard) -->
        <div v-if="showAddAPVProjectModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-lg w-full modal-scrollable">
                <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                    <h3 class="font-bold text-lg text-green-700">Add New APV Project</h3>
                    <button @click="closeAddAPVProjectModal" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                </div>
                <form @submit.prevent="addAPVProject" class="p-6 space-y-4">
                    <div><label class="block text-sm">Project Name</label><input v-model="newAPVProjectForm.projectName" required class="w-full px-3 py-2 border rounded text-sm"></div>
                    <div><label class="block text-sm">Description (e.g., 20ft trackers, crop type)</label><textarea v-model="newAPVProjectForm.description" required class="w-full px-3 py-2 border rounded text-sm" rows="3"></textarea></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="block text-sm">Total Acres</label><input type="number" step="0.1" min="0.1" v-model.number="newAPVProjectForm.acres" required class="w-full px-3 py-2 border rounded text-sm"></div>
                        <div><label class="block text-sm">Solar Capacity (kW)</label><input type="number" step="1" min="1" v-model.number="newAPVProjectForm.solarCapacityKW" required class="w-full px-3 py-2 border rounded text-sm"></div>
                    </div>
                    <div><label class="block text-sm">Panel Mounting Type</label>
                        <select v-model="newAPVProjectForm.panelType" required class="w-full px-3 py-2 border rounded bg-white text-sm">
                            <option value="Elevated Single-Axis Tracker (20ft)">Elevated Single-Axis Tracker (20ft)</option>
                            <option value="Vertical Bifacial">Vertical Bifacial</option>
                            <option value="Fixed Elevated Canopy">Fixed Elevated Canopy</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div><label class="block text-sm">Est. Monthly Earnings/Acre (Lakhs ₹)</label><input type="number" step="0.1" min="0" v-model.number="newAPVProjectForm.estimatedMonthlyEarningsPerAcre" placeholder="e.g., 1.5" required class="w-full px-3 py-2 border rounded text-sm"></div>
                     <div><label class="block text-sm">Current Status</label>
                        <select v-model="newAPVProjectForm.status" required class="w-full px-3 py-2 border rounded bg-white text-sm">
                            <option value="operational">Operational</option>
                            <option value="under_construction">Under Construction</option>
                            <option value="seeking_funding">Seeking Funding</option>
                        </select>
                    </div>
                    <div class="pt-4 flex justify-end">
                        <button type="button" @click="closeAddAPVProjectModal" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded text-sm mr-2">Cancel</button>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">Add Project</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Energy Log Modal (shared with farmerAPVDashboard) -->
        <div v-if="showEnergyLogModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full modal-scrollable">
                 <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                    <h3 class="font-bold text-lg text-green-700">Log Energy Data for {{ selectedAPVProjectForDashboard ? selectedAPVProjectForDashboard.projectName : '' }}</h3>
                    <button @click="closeEnergyLogModal" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
                </div>
                <form @submit.prevent="addEnergyLogEntry" class="p-6 space-y-3">
                    <div><label class="block text-xs">Date</label><input type="date" v-model="newEnergyLogForm.timestamp" required class="w-full px-2 py-1 border rounded text-sm"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs">Energy Produced (kWh)</label><input type="number" step="0.01" min="0" v-model.number="newEnergyLogForm.energyProducedKWh" required class="w-full px-2 py-1 border rounded text-sm"></div>
                        <div><label class="block text-xs">Tracker Consumption (kWh)</label><input type="number" step="0.01" min="0" v-model.number="newEnergyLogForm.trackerConsumptionKWh" class="w-full px-2 py-1 border rounded text-sm"></div>
                        <div><label class="block text-xs">Farm Self-Consumption (kWh)</label><input type="number" step="0.01" min="0" v-model.number="newEnergyLogForm.farmSelfConsumptionKWh" class="w-full px-2 py-1 border rounded text-sm"></div>
                        <div><label class="block text-xs">Energy Sold (kWh)</label><input type="number" step="0.01" min="0" v-model.number="newEnergyLogForm.energySoldKWh" class="w-full px-2 py-1 border rounded text-sm"></div>
                    </div>
                    <div><label class="block text-xs">Sale Price per kWh (Credits)</label><input type="number" step="0.01" min="0" v-model.number="newEnergyLogForm.salePricePerKWh" class="w-full px-2 py-1 border rounded text-sm" placeholder="If energy sold"></div>
                    <div class="pt-3 flex justify-end">
                        <button type="button" @click="closeEnergyLogModal" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1.5 rounded text-xs mr-2">Cancel</button>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-xs">Add Log</button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <!-- SECTION: Renewable APV Explained (Now part of renewableEnergyHub, but kept as a separate page for direct linking if needed) -->
    <section v-if="current==='renewableAPVExplained'" class="max-w-4xl mx-auto mt-6">
        <div class="bg-white rounded-lg shadow-xl p-8">
            <h2 class="text-3xl font-bold text-green-700 mb-6 text-center"><i class="fas fa-solar-panel mr-2 text-yellow-500"></i>Agrivoltaics (APV) Explained</h2>
            <div class="prose max-w-none text-gray-700">
                <p class="text-lg">Agrivoltaics (APV) is an innovative approach that combines solar photovoltaic (PV) power generation with agricultural production on the same piece of land. This dual-use system aims to optimize land efficiency, creating synergies between food and energy production.</p>
                <h3 class="text-xl font-semibold text-green-600 mt-6 mb-3">How APV Works: Our Model</h3>
                <p>PestiVid promotes a specific APV model designed for maximum synergy:</p>
                <ul class="list-disc list-inside space-y-2 my-4">
                    <li><strong>Elevated Solar Panels:</strong> Solar panels are mounted approximately <strong>20 feet (around 6 meters)</strong> above the ground. This height allows sufficient clearance for most standard farming machinery and activities to continue underneath.</li>
                    <li><strong>Single-Axis Tracking System:</strong> The panels are equipped with trackers that follow the sun's path. They orient towards the **East in the morning** to capture early sunlight and gradually track towards the **West in the evening**. This maximizes energy capture throughout the day.</li>
                    <li><strong>Optimized Light for Crops:</strong> The tracking and spacing of panels are designed to allow adequate sunlight to reach the crops below, particularly beneficial for shade-tolerant or partially shade-tolerant crops. The partial shading can also reduce water stress and heat damage to certain plants.</li>
                    <li><strong>Dual Output:</strong> The land produces both agricultural crops and clean electricity.</li>
                </ul>
                <div class="my-6 p-6 bg-yellow-50 border-l-4 border-yellow-400 rounded-md">
                    <h4 class="text-lg font-semibold text-yellow-700 mb-2"><i class="fas fa-dollar-sign mr-1"></i>Simulated Earnings Potential (Example)</h4>
                    <p class="text-yellow-800">Based on our model and ideal conditions, farmers implementing this specific APV system could potentially earn an additional (simulated) income of approximately <strong class="font-bold">1 to 2 Lakhs (₹100,000 - ₹200,000) per acre per month</strong> from the sale of solar energy generated, in addition to their crop revenue.</p>
                    <p class="text-xs text-yellow-600 mt-2"><em>Disclaimer: This is a hypothetical projection for demonstration purposes within the PestiVid platform simulation. Actual earnings can vary significantly.</em></p>
                </div>
                <h3 class="text-xl font-semibold text-green-600 mt-6 mb-3">Benefits of This APV Model</h3>
                 <ul class="list-disc list-inside space-y-1">
                    <li><strong>Increased Land Productivity:</strong> Generate revenue from both crops and energy on the same land.</li>
                    <li><strong>Water Conservation:</strong> Shading can reduce soil moisture evaporation and plant water needs.</li>
                    <li><strong>Crop Protection:</strong> Panels can offer protection from extreme weather like hail or excessive heat.</li>
                    <li><strong>Reduced Energy Costs for Farm:</strong> On-site generated power can be used for farm operations.</li>
                    <li><strong>Contribution to Clean Energy:</strong> Helps in transitioning towards a sustainable energy future.</li>
                </ul>
                <h3 class="text-xl font-semibold text-green-600 mt-6 mb-3">Considerations</h3>
                 <ul class="list-disc list-inside space-y-1">
                    <li><strong>Initial Investment:</strong> Setting up APV systems can have higher upfront costs than traditional farming.</li>
                    <li><strong>Crop Suitability:</strong> Best suited for crops that can tolerate or benefit from partial shading.</li>
                    <li><strong>Technical Expertise:</strong> Requires knowledge in both farming and solar energy system maintenance.</li>
                    <li><strong>Grid Integration:</strong> Regulations and infrastructure for selling surplus power to the grid.</li>
                </ul>
                <div class="mt-8 text-center space-x-4">
                    <button v-if="isUserAuthenticated && role === 'farmer'" @click="switchPage('renewableEnergyHub')" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded transition"><i class="fas fa-tachometer-alt mr-1"></i> Go to My APV Hub</button>
                    <button v-if="isUserAuthenticated && role === 'investor'" @click="switchPage('investorProjects', { category: 'renewable_energy' })" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded transition"><i class="fas fa-hand-holding-usd mr-1"></i> Invest in APV Projects</button>
                    <button v-if="!isUserAuthenticated" @click="switchPage('signup')" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded transition"><i class="fas fa-user-plus mr-1"></i> Get Started with PestiVid</button>
                </div>
            </div>
        </div>
    </section>


    <!-- Modals (Purchase Video, Buy Listing, Investment Details, Farmer Profile) -->
    <div v-if="selectedPurchase && showPurchaseVideo" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-lg shadow-xl max-w-lg w-full relative mx-2 modal-scrollable">
        <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white z-10">
            <h3 class="font-bold text-lg text-green-700">View PestiVid Video</h3>
            <button class="text-gray-400 hover:text-red-500" @click="showPurchaseVideo=false"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-4">
            <video :src="ipfsUrl(selectedPurchase.cid)" controls class="w-full rounded border" playsinline webkit-playsinline></video>
            <div class="mt-3 text-sm">
                <p><strong>Crop:</strong> {{ selectedPurchase.crop }}</p>
                <p><strong>Pesticide:</strong> {{ selectedPurchase.pesticide }} ({{ selectedPurchase.pesticideCompany }})</p>
                <p><strong>Location:</strong> {{ selectedPurchase.location }}</p>
                <p class="text-xs mt-1"><strong>Video File Hash (IPFS):</strong> <span class="font-mono break-all" :title="selectedPurchase.videoFileHash">{{ selectedPurchase.videoFileHash }}</span></p>
            </div>
        </div>
        <div class="bg-gray-50 p-4 flex justify-end rounded-b-lg sticky bottom-0 border-t">
            <button @click="showPurchaseVideo=false" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded text-sm">Close</button>
        </div>
      </div>
    </div>
    <div v-if="showBuyModal && selectedListing" class="fixed inset-0 z-50 bg-black bg-opacity-60 flex justify-center items-center p-4">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-md relative mx-2">
        <div class="p-4 border-b flex justify-between items-center">
            <h3 class="font-bold text-lg text-green-700">Purchase "{{ selectedListing.crop }}"</h3>
            <button class="text-gray-400 hover:text-red-500" @click="showBuyModal=false"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-6">
            <p class="text-sm mb-1">You are about to purchase <strong>{{ selectedListing.crop }}</strong> from <strong>{{ getFarmerDisplayIdentifier(selectedListing.farmerWallet) }}</strong>.</p>
            <p class="text-xs text-gray-600 mb-3">Practices documented in video: {{ selectedListing.pesticide }}.</p>
            <div class="mb-4">
                <label for="purchase-amount" class="block text-sm font-medium text-gray-700">Agreed Price (Credits/Unit)</label>
                <input type="number" id="purchase-amount" v-model.number="purchaseAmount" :min="selectedListing.minPrice" :max="selectedListing.maxPrice" step="0.01" class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500" required>
                <p class="text-xs text-gray-500 mt-1">Price must be between {{selectedListing.minPrice}} and {{selectedListing.maxPrice}} credits.</p>
            </div>
            <div v-if="purchaseError" class="text-red-500 text-sm mb-3 p-2 bg-red-50 border border-red-200 rounded">{{ purchaseError }}</div>
            <div v-if="purchaseStatus === 'success'" class="text-green-600 text-sm mb-3 p-2 bg-green-50 border border-green-200 rounded">Purchase successful! Transaction simulated.</div>
        </div>
        <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3 rounded-b-lg">
            <button @click="showBuyModal=false" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded text-sm">Cancel</button>
            <button @click="confirmPurchase" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm" :disabled="!purchaseAmount || purchaseAmount < selectedListing.minPrice || purchaseAmount > selectedListing.maxPrice">Confirm Purchase</button>
        </div>
      </div>
    </div>
    <div v-if="showInvestmentDetailsModal && selectedInvestment" class="fixed inset-0 z-50 bg-black bg-opacity-70 flex justify-center items-center p-4">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl relative mx-2 modal-scrollable">
        <div class="p-4 bg-green-50 border-b flex justify-between items-center sticky top-0 z-10">
            <h3 class="font-bold text-lg text-green-800 flex items-center">
                <i :class="getProjectIconClass(selectedInvestment.projectCategory || selectedInvestment.projectType)" class="mr-2"></i>{{ selectedInvestment.projectTitle }}
                 <span class="ml-2 text-xs capitalize px-2 py-0.5 rounded-full" :class="getProjectCategoryColor(selectedInvestment.projectCategory || selectedInvestment.projectType)">
                    {{ (selectedInvestment.projectCategory || selectedInvestment.projectType) | projectTypeDisplay }}
                </span>
            </h3>
            <button class="text-gray-400 hover:text-red-500" @click="showInvestmentDetailsModal=false"><i class="fas fa-times"></i></button>
        </div>
         <div class="p-6">
            <div class="flex flex-col md:flex-row gap-6">
                <div class="md:w-1/3">
                    <video v-if="selectedInvestment.cid" :src="ipfsUrl(selectedInvestment.cid)" controls playsinline webkit-playsinline class="rounded w-full h-40 object-cover bg-black mb-3"></video>
                    <img v-else-if="selectedInvestment.projectCategory === 'renewable_energy' || selectedInvestment.projectType === 'renewable_energy'" src="https://via.placeholder.com/300x160.png?text=APV+Project+Visual" alt="Renewable Energy Project" class="rounded w-full h-40 object-cover bg-gray-200 mb-3">
                    <div v-else class="rounded w-full h-40 bg-gray-100 flex items-center justify-center mb-3"><i class="fas fa-image text-gray-400 text-4xl"></i> (No Media)</div>
                     <div class="mt-3 space-y-2 text-sm">
                        <div> <div class="text-xs text-gray-500">Farmer/Dev Identifier</div> <div class="font-medium flex items-center font-mono text-xs"> <span>{{ selectedInvestment.farmerWallet }}</span> <button @click="showFarmerProfile(selectedInvestment.farmerWallet); showInvestmentDetailsModal=false;" class="ml-2 text-blue-500 hover:text-blue-700 text-xs focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> <button @click="startOrGoToConversation(selectedInvestment.farmerWallet); showInvestmentDetailsModal=false;" v-if="currentUserIdentifier !== selectedInvestment.farmerWallet" class="ml-2 text-green-600 hover:text-green-700 text-xs focus:outline-none" title="Message Farmer/Dev"> <i class="fas fa-envelope"></i> </button> </div> </div>
                        <div> <div class="text-xs text-gray-500">Investment Date</div> <div class="font-medium">{{ selectedInvestment.investmentDate }}</div> </div>
                        <div> <div class="text-xs text-gray-500">Amount Invested</div> <div class="font-medium text-green-700 font-mono">{{ selectedInvestment.amount }} Credits</div> </div>
                        <div> <div class="text-xs text-gray-500">Status</div> <span :class="{'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true, 'bg-blue-100 text-blue-800': selectedInvestment.status === 'active', 'bg-green-100 text-green-800': selectedInvestment.status === 'harvested' || selectedInvestment.status === 'completed', 'bg-yellow-100 text-yellow-800': selectedInvestment.status === 'growing' || selectedInvestment.status === 'generating'}"> {{ selectedInvestment.status.charAt(0).toUpperCase() + selectedInvestment.status.slice(1) }} </span> </div>
                    </div>
                </div>
                <div class="md:w-2/3">
                    <div class="mb-4">
                        <div class="text-sm font-medium mb-1">{{ getFundingProjectPrimaryDisplay(selectedInvestment) }}</div>
                        <p class="text-sm text-gray-700 max-h-24 overflow-y-auto border p-2 rounded bg-gray-50">{{ (selectedInvestmentProject ? selectedInvestmentProject.description : selectedInvestment.description) || "No description available." }}</p>
                    </div>
                     <div class="mb-4"> <div class="text-xs text-gray-500 mb-1">Project Progress</div> <div class="progress-bar"> <div class="progress-fill bg-green-500" :style="{width: selectedInvestment.progress + '%'}"></div> </div> <div class="flex justify-between text-xs mt-1"> <span>{{ selectedInvestment.progress }}% Complete</span> <span>Est. {{ selectedInvestment.timeline }} months total</span> </div> </div>
                     <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                        <div> <div class="text-xs text-gray-500">Expected Return</div> <div class="font-medium text-green-700 font-mono">{{ calculateExpectedReturn(selectedInvestment) }} Credits</div> </div>
                        <div> <div class="text-xs text-gray-500">ROI</div> <div class="font-medium text-green-700">{{ selectedInvestment.roi }}%</div> </div>
                        <template v-if="selectedInvestment.projectCategory === 'agricultural' || selectedInvestment.projectType === 'agricultural'">
                            <div> <div class="text-xs text-gray-500">Land Size</div> <div class="font-medium">{{ selectedInvestment.acres || (selectedInvestmentProject ? selectedInvestmentProject.acres : '?') }} acres</div> </div>
                        </template>
                        <template v-if="selectedInvestment.projectCategory === 'renewable_energy' || selectedInvestment.projectType === 'renewable_energy'">
                            <div> <div class="text-xs text-gray-500">Capacity</div> <div class="font-medium">{{ selectedInvestment.solarCapacityKW || (selectedInvestmentProject ? selectedInvestmentProject.solarCapacityKW : 'N/A') }} kW</div> </div>
                             <div> <div class="text-xs text-gray-500">Land (APV)</div> <div class="font-medium">{{ selectedInvestment.acres || (selectedInvestmentProject ? selectedInvestmentProject.acres : 'N/A') }} acres</div> </div>
                        </template>
                        <div> <div class="text-xs text-gray-500">Your Share</div> <div class="font-medium">{{ selectedInvestment.investorShare }}%</div> </div>
                        <div v-if="selectedInvestment.cid || (selectedInvestmentProject && selectedInvestmentProject.cid)"> <div class="text-xs text-gray-500">Video File Hash</div> <p class="font-medium font-mono text-xs break-all" :title="selectedInvestment.videoFileHash || (selectedInvestmentProject ? selectedInvestmentProject.videoFileHash : 'N/A')">{{ (selectedInvestment.videoFileHash || (selectedInvestmentProject ? selectedInvestmentProject.videoFileHash : 'N/A')) ? (selectedInvestment.videoFileHash || (selectedInvestmentProject ? selectedInvestmentProject.videoFileHash : 'N/A')).substring(0,10) + '...' : 'N/A' }}</p> </div>
                    </div>
                     <div v-if="selectedInvestmentProject && selectedInvestmentProject.updates && selectedInvestmentProject.updates.length > 0" class="mb-4"> <h4 class="text-sm font-semibold text-gray-700 mb-2">Farmer Updates</h4> <div class="project-updates-list text-xs"> <div v-for="update in selectedInvestmentProject.updates.slice().reverse()" :key="update.id" class="project-update-item"> <span class="font-medium text-gray-500">{{ update.date }}:</span> {{ update.text }} </div> </div> </div> <div v-else-if="selectedInvestmentProject" class="mb-4 text-xs text-gray-500"> No project updates posted by the farmer yet. </div>
                     <div class="bg-gray-100 p-3 rounded mb-4 border"> <div class="text-sm font-medium mb-1">Platform Transaction (Simulated)</div> <div class="flex items-center text-xs"> <span class="font-mono bg-white px-2 py-1 rounded border mr-2 truncate" :title="selectedInvestment.txHash">{{ selectedInvestment.txHash }}</span> </div> </div>
                     <div v-if="selectedInvestment.status === 'harvested' || selectedInvestment.status === 'completed'" class="bg-green-100 p-3 rounded border border-green-200"> <div class="flex items-center"> <i class="fas fa-check-circle text-green-600 mr-2 text-lg"></i> <div> <div class="font-medium">Project Completed & Payout Processed</div> <div class="text-sm">Your return of {{ calculateExpectedReturn(selectedInvestment) }} Credits has been simulated.</div> </div> </div> </div> <div v-else-if="selectedInvestment.status === 'growing' || selectedInvestment.status === 'generating'" class="bg-yellow-50 p-3 rounded border border-yellow-200"> <div class="flex items-center"> <i class="fas fa-hourglass-half text-yellow-600 mr-2 text-lg"></i> <div> <div class="font-medium">Project In Progress</div> <div class="text-sm">Completion expected within {{ selectedInvestment.timeline }} months. Progress: {{selectedInvestment.progress}}%.</div> </div> </div> </div>
                </div>
            </div>
        </div>
        <div class="bg-gray-50 p-4 flex justify-end rounded-b-lg sticky bottom-0 border-t"> <button @click="showInvestmentDetailsModal=false" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded text-sm"> Close </button> </div>
      </div>
    </div>
    <div v-if="showFarmerProfileModal && selectedFarmerProfile" class="fixed inset-0 z-50 bg-black bg-opacity-70 flex justify-center items-center p-4">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-lg relative mx-2 modal-scrollable">
        <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white z-10">
            <h3 class="font-bold text-lg text-green-700">Farmer/Developer Profile</h3>
            <button class="text-gray-400 hover:text-red-500" @click="showFarmerProfileModal=false"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-6 text-sm">
            <div class="flex items-center mb-4">
                <div class="bg-gray-200 rounded-full w-12 h-12 flex items-center justify-center mr-3 text-gray-500">
                    <i class="fas fa-user text-2xl"></i>
                </div>
                <div>
                    <p class="font-semibold text-base">{{ selectedFarmerProfile.name }}</p>
                    <p class="text-gray-600 capitalize">{{ selectedFarmerProfile.role }}</p>
                </div>
            </div>
            <div class="space-y-2">
                <p><strong>Email (Identifier):</strong> <span class="font-mono">{{ selectedFarmerProfile.id }}</span></p>
                <p><strong>Member Since:</strong> {{ selectedFarmerProfile.memberSince || 'N/A' }}</p>
                <p><strong>Phone (Simulated):</strong> {{ selectedFarmerProfile.phone || 'Not Provided' }}</p>
                <p><strong>Status:</strong> <span class="px-2 py-0.5 text-xs bg-green-100 text-green-700 rounded-full">Verified User (Demo)</span></p>

                <div v-if="selectedFarmerProfile.role === 'farmer'">
                    <h4 class="font-semibold mt-4 pt-3 border-t mb-1">Active Listings:</h4>
                    <p v-if="getFarmerListingsForProfile(selectedFarmerProfile.id).length === 0" class="text-xs text-gray-500">No active crop listings.</p>
                    <ul v-else class="list-disc list-inside text-xs text-gray-700 space-y-0.5">
                        <li v-for="item in getFarmerListingsForProfile(selectedFarmerProfile.id).slice(0,3)" :key="item.id">{{item.crop}} ({{item.minPrice}}-{{item.maxPrice}} Cr)</li>
                        <li v-if="getFarmerListingsForProfile(selectedFarmerProfile.id).length > 3">... and more</li>
                    </ul>

                    <h4 class="font-semibold mt-3 pt-2 border-t mb-1">Open Funding Requests:</h4>
                    <p v-if="getFarmerFundingRequestsForProfile(selectedFarmerProfile.id).length === 0" class="text-xs text-gray-500">No active funding requests.</p>
                    <ul v-else class="list-disc list-inside text-xs text-gray-700 space-y-0.5">
                        <li v-for="item in getFarmerFundingRequestsForProfile(selectedFarmerProfile.id).slice(0,3)" :key="item.id">{{item.title}} ({{item.amount}} Cr)</li>
                         <li v-if="getFarmerFundingRequestsForProfile(selectedFarmerProfile.id).length > 3">... and more</li>
                    </ul>
                </div>
            </div>
        </div>
         <div class="bg-gray-50 p-4 flex justify-between items-center rounded-b-lg sticky bottom-0 border-t">
            <button @click="startOrGoToConversation(selectedFarmerProfile.id); showFarmerProfileModal=false;" v-if="currentUserIdentifier !== selectedFarmerProfile.id" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded text-xs"><i class="fas fa-envelope mr-1"></i> Message</button>
            <span v-else class="text-xs text-gray-500 italic">(This is you)</span>
            <button @click="showFarmerProfileModal=false" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1.5 rounded text-xs">Close</button>
        </div>
      </div>
    </div>

    <!-- Notification Toast Container -->
    <div class="notification-toast-container">
        <div v-for="toast in recentNotifications" :key="toast.id"
             :class="['notification-toast', toast.type, toast.show ? 'show' : '']">
            <div :class="['icon', 'icon-' + toast.type]"><i :class="toast.icon"></i></div>
            <div class="message" v-html="toast.message"></div>
            <button class="close-btn" @click="removeNotification(toast.id)">&times;</button>
        </div>
    </div>
    <!-- Loading/Transaction Modal -->
    <div v-if="showLoadingModal" class="loading-modal">
        <div class="loading-content">
            <i class="fas fa-spinner fa-spin text-green-500"></i>
            <p>{{ loadingMessage || 'Processing Transaction...' }}</p>
        </div>
    </div>
  </main>

  <footer class="bg-white border-t py-6 mt-auto text-center text-sm text-gray-500">
    <span>© {{ new Date().getFullYear() }} PestiVid • Agri & Energy Platform (Demo)</span>
  </footer>

  <!-- Interactive Avatar Assistant (NEW VERSION) -->
  <div v-if="avatar.visible"
        :class="['fixed z-[9998] p-2 flex flex-col items-end', avatar.position === 'bottom-right' ? 'bottom-4 right-4' : 'bottom-4 left-4']"
        style="transition: all 0.3s ease;">

      <div v-show="avatar.expanded"
          class="bg-white w-80 md:w-96 h-96 max-h-[70vh] mb-2 rounded-xl shadow-2xl flex flex-col overflow-hidden border border-gray-200">
          <header class="bg-green-600 text-white p-3 flex items-center justify-between">
              <div class="flex items-center">
                  <img :src="avatar.images[avatar.character]?.[avatar.state] || avatar.images.farmer.idle" alt="Avatar" class="w-8 h-8 rounded-full mr-2 border-2 border-white">
                  <h3 class="font-semibold">PestiVid Helper</h3>
              </div>
              <button @click="toggleAvatarExpansion(false)" class="text-green-100 hover:text-white">
                  <i class="fas fa-times"></i>
              </button>
          </header>

          <div class="flex-grow p-3 space-y-3 overflow-y-auto" ref="avatarMessagesContainer" style="scroll-behavior: smooth;">
              <div v-for="msg in avatar.chatMessages" :key="msg.id + '-avatar'"
                  :class="['flex', msg.sender === 'user' ? 'justify-end' : 'justify-start']">
                  <div :class="['max-w-[80%] p-2.5 rounded-lg shadow-sm text-sm', msg.sender === 'user' ? 'bg-blue-500 text-white rounded-br-none' : 'bg-gray-100 text-gray-800 rounded-bl-none']"
                      v-html="renderMarkdown(msg.text)">
                  </div>
              </div>
              <div v-if="avatar.isProcessing && avatar.state === 'thinking'" class="flex justify-start">
                    <div class="bg-gray-100 text-gray-800 p-2.5 rounded-lg shadow-sm text-sm rounded-bl-none typing-indicator">
                      <span></span><span></span><span></span>
                    </div>
              </div>
          </div>

          <div v-if="avatar.quickActions.length > 0 && !avatar.isProcessing && !avatar.isListening" class="p-2 border-t border-gray-200 flex flex-wrap gap-2 justify-center">
              <button v-for="action in avatar.quickActions" :key="action.id"
                      @click="handleAvatarQuickAction(action)"
                      class="bg-green-100 text-green-700 px-3 py-1.5 text-xs rounded-full hover:bg-green-200 transition-colors">
                  {{ action.label }}
              </button>
          </div>

          <div class="p-3 border-t border-gray-200 bg-gray-50">
              <div class="flex items-center gap-2">
                   <button @click="toggleAvatarListening"
                          :disabled="avatar.isProcessing"
                          title="Toggle Voice Input"
                          class="avatar-input-mic-btn text-gray-500 hover:text-green-600 p-2 rounded-full focus:outline-none"
                          :class="{'text-red-500 listening': avatar.isListening}">
                      <i class="fas fa-microphone text-lg"></i>
                  </button>
                  <input type="text" v-model="avatar.userInput"
                        @keyup.enter="sendAvatarMessage"
                        :placeholder="avatar.isListening ? 'Listening...' : (avatar.isProcessing ? 'Helper is thinking...' : 'Ask PestiVid Helper...')"
                        :disabled="avatar.isProcessing"
                        class="flex-grow px-3 py-2 border border-gray-300 rounded-full text-sm focus:ring-2 focus:ring-green-500 focus:border-green-500">
                  <button @click="sendAvatarMessage" :disabled="avatar.isProcessing || !avatar.userInput.trim()"
                          class="bg-green-600 hover:bg-green-700 text-white rounded-full w-10 h-10 flex items-center justify-center transition-opacity"
                          :class="{'opacity-50 cursor-not-allowed': avatar.isProcessing || !avatar.userInput.trim()}">
                      <i class="fas fa-paper-plane"></i>
                  </button>
              </div>
          </div>
      </div>

      <button @click="toggleAvatarExpansion()"
              class="w-16 h-16 rounded-full shadow-xl overflow-hidden focus:outline-none ring-4 ring-green-500/30 hover:ring-green-500/50 transition-all duration-300 relative"
              :class="[avatar.expanded ? 'transform scale-90 opacity-70' : 'transform scale-100 opacity-100', 'border-4 border-white']"
              :style="{ borderColor: avatar.expanded ? '#10B981' : 'white' }">
          <img :src="avatar.images[avatar.character]?.[avatar.state] || avatar.images.farmer.idle"
                alt="PestiVid Helper Avatar"
                class="w-full h-full object-cover transition-transform duration-500"
                :class="{'animate-pulse-slow': avatar.state === 'thinking'}">
          <div v-if="!avatar.expanded && unreadAvatarMessagesCount > 0" class="absolute top-[-4px] right-[-4px] bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center ring-2 ring-white">
              {{ unreadAvatarMessagesCount }}
          </div>
      </button>
  </div>

</div>
<script>
const app = new Vue({
    el: "#app",
    data: {
      current: 'landing',
      currentParams: {}, // To store params for the current page
      showMobileMenu: false,
      showRenewableEnergyMenu: false, // For desktop dropdown
      showRenewableEnergyMenuMobileDrop: false, // For mobile dropdown state
      isUserAuthenticated: false,
      currentUserIdentifier: null,
      role: null,
      userName: null,
      userEmail: null,
      userPhone: null,
      memberSince: null,
      userProfileRoleForSwitch: null,

      loginForm: { email: '', password: '' },
      signupForm: { name: '', email: '', password: '', confirmPassword: '', role: 'farmer' },
      authError: '',

      // Forms and states for features
      recordForm: {crop:'', pesticide:'', location:'', pesticideCompany: '', purpose: 'agristream'},
      recordStream: null, recordMediaRecorder: null, recording: false, recordBlob: null, recordBlobUrl: '', showLive: false,
      uploadCid: '', uploading: false, uploadError: '', lastUploadedVideoPurpose: '', lastUploadedVideoFileHash: '',

      listingForm: {cid:'', minPrice:'', maxPrice:'', notifyBuyers: true}, createdListingId: null, listingNotificationSent: false,

      fundingForm: {
          projectCategory: 'agricultural', title: '', crop: '', acres: null, solarCapacityKW: null, panelType: '',
          amount: null, method: '', cid: '', description: '', timeline: null, roi: null, investorShare: null, notifyInvestors: true
      },
      createdFundingRequest: false, newUpdateText: {},

      // Farmer's specific filtered data (populated from master lists)
      farmerVideos: [],
      farmerListings: [],
      farmerFundingRequests: [],
      farmerAPVProjects: [], // All APV projects for the current farmer

      // Buyer's specific filtered data
      buyerPurchases: [],

      // Investor's specific filtered data
      investorInvestments: [],
      investorTransactions: [],

      // --- MASTER DATA LISTS (holds all data, not filtered by user) ---
      allFarmerVideos_master: [],
      allListings_master: [],
      allFundingRequests_master: [],
      allAPVProjects_master: [], // All APV projects from all farmers
      allBuyerPurchases_master: [],
      allInvestorInvestments_master: [],
      allInvestorTransactions_master: [],
      messages_master: [],
      conversations_master: [],
      notifications_master: [],
      energyLog: [], // Global energy log for all APV projects

      // --- RENEWABLE ENERGY SPECIFIC STATE ---
      showAddAPVProjectModal: false,
      newAPVProjectForm: {
          projectName: '', description: '', acres: null, solarCapacityKW: null, panelType: 'Elevated Single-Axis Tracker (20ft)', estimatedMonthlyEarningsPerAcre: null, status: 'operational'
      },
      showEnergyLogModal: false,
      activeAPVProjectIdForLog: null, // Used when opening the log modal
      activeAPVProjectIdForDashboard: null, // Used for displaying dashboard stats for a specific project
      newEnergyLogForm: {
          timestamp: new Date().toISOString().split('T')[0], energyProducedKWh: null, trackerConsumptionKWh: 0, farmSelfConsumptionKWh: 0, energySoldKWh: null, salePricePerKWh: null
      },
      apvOptimizationScenario: 'balanced', // For simulated panel optimization
      apvOptimizationResult: '',
      energyProductionChartInstance: null,
      energyUsageChartInstance: null,


      // Modals and selections
      selectedPurchase: null, showPurchaseVideo: false,
      buyerFilters: {crop:'', location:'', pesticideCompany: ''}, showBuyModal: false, selectedListing: null, purchaseAmount: null, purchaseStatus: '', purchaseError: '',
      investorFilters: {projectCategory: '', crop: '', method: '', minRoi: null, maxAmount: null, minCapacity: null},
      investmentAmounts: {}, investmentErrors: {}, showInvestmentDetailsModal: false, selectedInvestment: null, selectedInvestmentProject: null,
      showFarmerProfileModal: false, selectedFarmerProfile: null,

      // Messaging
      activeConversationId: null, messageInputText: '', isTyping: false, typingTimeout: null,

      notifications: [], // User-specific notifications derived from notifications_master
      recentNotifications: [], // For displaying toasts


      // UI State
      showLoadingModal: false, loadingMessage: '',
      targetAgriStreamVideoCid: null, highlightedAgriStreamVideoCid: null,

      // API Keys & Config
      pinataJwt: 'YOUR_PINATA_JWT_MUST_BE_REPLACED_HERE',
      pinataGateway: 'gateway.pinata.cloud',
      geminiApiKey: 'YOUR_GEMINI_API_KEY_REPLACE_HERE',
      groqApiKey: "YOUR_GROQ_API_KEY_REPLACE_HERE",

      // Plant Recommendation
      plantImageFile: null, plantImageUrl: null, plantImageMimeType: null, analysisInProgress: false, analysisResultText: '', parsedAnalysis: { plantName: null, diseaseName: null, treatmentRecommended: null }, analysisErrorText: '',

      // Avatar Assistant (NEW VERSION)
      avatar: {
          visible: true,
          expanded: false,
          state: 'idle', // idle, talking, thinking, listening
          character: 'farmer', // Can be changed later to 'investor', 'buyer' etc.
          position: 'bottom-right', // 'bottom-left'
          chatMessages: [],
          userInput: '',
          quickActions: [],
          currentContextText: '', // For providing context to LLM
          images: { // Placeholder image URLs
              farmer: {
                  idle: 'https://img.icons8.com/plasticine/100/farmer-male.png',
                  talking: 'https://img.icons8.com/plasticine/100/farmer-male.png',
                  thinking: 'https://img.icons8.com/plasticine/100/farmer-male.png',
                  listening: 'https://img.icons8.com/plasticine/100/farmer-male.png'
              },
          },
          systemPrompt: "You are PestiVid Helper, a friendly and knowledgeable AI assistant for the PestiVid platform. You are represented by a visual avatar. Your goal is to help users, especially farmers, navigate the platform, understand its features (like PestiVid video uploads, AgriStream, Marketplace, Funding for agriculture and Agrivoltaics (APV), APV Explained, APV Dashboard, PlantRecommend, Messaging, Investment Opportunities, Investor Portfolio), and answer their questions. Be encouraging and clear. If asked about a specific page, try to provide relevant tips. When the user opens your chat, if you have context, offer a relevant quick action or greeting. Keep responses concise for a chat interface. If you provide lists, use markdown for bullet points.",
          isProcessing: false, // True when waiting for LLM response
          isListening: false,  // True when SpeechRecognition is active
      },
      speechRecognition: null,
    },
     filters: {
        capitalize: function (value) {
            if (!value) return ''
            value = value.toString()
            return value.charAt(0).toUpperCase() + value.slice(1)
        },
        projectTypeDisplay: function (value) {
            if (!value) return 'N/A';
            return value.replace(/_/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }
    },
    computed: {
      selectedVideoForListing() {
        if (!this.listingForm.cid) return null;
        return this.farmerVideos.find(v => v.cid === this.listingForm.cid);
      },
      filteredListings() {
        return this.allListings_master.filter(l => {
            const cropMatch = !this.buyerFilters.crop || (l.crop && l.crop.toLowerCase().includes(this.buyerFilters.crop.toLowerCase()));
            const locMatch = !this.buyerFilters.location || (l.location && l.location.toLowerCase().includes(this.buyerFilters.location.toLowerCase()));
            const companyMatch = !this.buyerFilters.pesticideCompany || (l.pesticideCompany && l.pesticideCompany.toLowerCase().includes(this.buyerFilters.pesticideCompany.toLowerCase()));
            return cropMatch && locMatch && companyMatch && l.status === 'active';
        });
      },
      uniqueFundingCrops() { const crops = this.allFundingRequests_master.filter(r => (r.projectCategory === 'agricultural' || r.projectType === 'agricultural')).map(r=>r.crop).filter(Boolean); return [...new Set(crops)].sort(); },
      filteredFundingRequests() {
          const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
          return this.allFundingRequests_master
              .map(r => ({ ...r, isNew: new Date(r.createdAt) > oneDayAgo }))
              .filter(r => {
                  const isRelevantStatus = r.status === 'pending' || r.status === 'partially_funded';
                  const currentFilterCategory = this.investorFilters.projectCategory;
                  const projectActualCategory = r.projectCategory || r.projectType;

                  const categoryMatch = !currentFilterCategory || projectActualCategory === currentFilterCategory;

                  let specificFiltersMatch = true;
                  if (projectActualCategory === 'agricultural' && (currentFilterCategory === 'agricultural' || !currentFilterCategory)) {
                      const cropMatch = !this.investorFilters.crop || (r.crop || '').toLowerCase() === this.investorFilters.crop.toLowerCase();
                      const methodMatch = !this.investorFilters.method || (r.method || '').toLowerCase() === this.investorFilters.method.toLowerCase();
                      specificFiltersMatch = cropMatch && methodMatch;
                  } else if (projectActualCategory === 'renewable_energy' && (currentFilterCategory === 'renewable_energy' || !currentFilterCategory)) {
                       const capacityMatch = !this.investorFilters.minCapacity || (r.solarCapacityKW || 0) >= this.investorFilters.minCapacity;
                       specificFiltersMatch = capacityMatch;
                  } else if (currentFilterCategory && projectActualCategory !== currentFilterCategory) {
                        return false;
                  }

                  const roiMatch = !this.investorFilters.minRoi || r.roi >= this.investorFilters.minRoi;
                  const amountMatch = !this.investorFilters.maxAmount || r.amount <= this.investorFilters.maxAmount;

                  return isRelevantStatus && categoryMatch && specificFiltersMatch && roiMatch && amountMatch;
              });
      },
      activeAPVProjectForLog() { // Used by the energy log modal
          if (!this.activeAPVProjectIdForLog) return null;
          return this.farmerAPVProjects.find(p => p.id === this.activeAPVProjectIdForLog);
      },
      selectedAPVProjectForDashboard() { // Used by the dashboard display
          if (!this.activeAPVProjectIdForDashboard) return null;
          return this.farmerAPVProjects.find(p => p.id === this.activeAPVProjectIdForDashboard);
      },
      dashboardStats() {
        if (!this.selectedAPVProjectForDashboard) {
            return { totalProduced: 0, totalSelfConsumed: 0, totalTrackerConsumed: 0, totalSold: 0, netEnergy: 0, totalRevenue: 0 };
        }
        const logs = this.getEnergyLogsForProject(this.selectedAPVProjectForDashboard.id);
        let totalProduced = 0, totalSelfConsumed = 0, totalTrackerConsumed = 0, totalSold = 0, totalRevenue = 0;
        logs.forEach(log => {
            totalProduced += (log.energyProducedKWh || 0);
            totalSelfConsumed += (log.farmSelfConsumptionKWh || 0);
            totalTrackerConsumed += (log.trackerConsumptionKWh || 0);
            totalSold += (log.energySoldKWh || 0);
            totalRevenue += (log.revenueFromSale || 0);
        });
        const netEnergy = totalProduced - totalSelfConsumed - totalTrackerConsumed;
        return {
            totalProduced: totalProduced.toFixed(1),
            totalSelfConsumed: totalSelfConsumed.toFixed(1),
            totalTrackerConsumed: totalTrackerConsumed.toFixed(1),
            totalSold: totalSold.toFixed(1),
            netEnergy: netEnergy.toFixed(1),
            totalRevenue: totalRevenue.toFixed(2)
        };
      },
      totalInvestedAmount() {
        return this.investorInvestments.reduce((sum, inv) => sum + inv.amount, 0).toFixed(2);
      },
      investorActiveProjects() {
        return this.investorInvestments.filter(inv => inv.status === 'active' || inv.status === 'growing' || inv.status === 'generating').length;
      },
      investorCompletedProjects() {
        return this.investorInvestments.filter(inv => inv.status === 'harvested' || inv.status === 'completed').length;
      },
      investorAvgRoi() {
        if (this.investorInvestments.length === 0) return 0;
        const totalRoi = this.investorInvestments.reduce((sum, inv) => sum + inv.roi, 0);
        return (totalRoi / this.investorInvestments.length).toFixed(1);
      },
      unreadMessageCount() {
        return this.conversations.reduce((count, conv) => count + (conv.unreadCount || 0), 0);
      },
      activeConversation() {
        if (!this.activeConversationId) return null;
        return this.conversations.find(c => c.id === this.activeConversationId);
      },
      unreadAvatarMessagesCount() {
          if (!this.avatar.expanded && this.avatar.chatMessages) {
              return this.avatar.chatMessages.filter(msg => msg.sender === 'bot' && !msg.readByUser).length;
          }
          return 0;
      },
    },
    watch: {
      current(newPage, oldPage) {
          window.scrollTo(0,0);
          this.authError = '';
          if (newPage === 'farmerAgriStream' && this.targetAgriStreamVideoCid) { this.scrollToAndHighlightAgriStreamVideo(); }
          else if (newPage !== 'farmerAgriStream') { this.highlightedAgriStreamVideoCid = null; }

          if (newPage === 'investorPortfolio' && this.isUserAuthenticated && this.role === 'investor') { this.updateInvestmentProgress(); }
          if (newPage === 'messaging' && this.activeConversationId && this.isUserAuthenticated) { this.scrollToMessageBottom(); this.markConversationAsRead(this.activeConversationId); }
          if (oldPage === 'plantRecommendation' && newPage !== 'plantRecommendation') { this.plantImageFile = null; this.plantImageUrl = null; this.plantImageMimeType = null; this.analysisResultText = ''; this.parsedAnalysis = { plantName: null, diseaseName: null, treatmentRecommended: null }; this.analysisErrorText = ''; }

          if (this.avatar.visible && this.avatar.expanded) {
            this.updateAvatarContextAndQuickActions();
          }
          if (newPage === 'userProfile' && this.isUserAuthenticated) { this.userProfileRoleForSwitch = this.role; }

          if (newPage === 'renewableEnergyHub' && this.isUserAuthenticated && this.role === 'farmer' && this.farmerAPVProjects.length > 0) {
              if (!this.activeAPVProjectIdForDashboard && this.farmerAPVProjects[0]) {
                  this.activeAPVProjectIdForDashboard = this.farmerAPVProjects[0].id;
              }
              this.$nextTick(this.renderAPVDashboardCharts);
          } else {
              this.destroyAPVDashboardCharts();
          }

          if (!newPage.startsWith('renewable') && !newPage.startsWith('farmerAPV') && !(newPage === 'investorProjects' && this.investorFilters.projectCategory === 'renewable_energy')) {
              this.showRenewableEnergyMenu = false;
              this.showRenewableEnergyMenuMobileDrop = false;
          }
      },
      allFarmerVideos_master: { handler() { if (this.isUserAuthenticated && this.role === 'farmer') this.filterDataForCurrentUser(); }, deep: true },
      allListings_master: { handler() { if (this.isUserAuthenticated && this.role === 'farmer') this.filterDataForCurrentUser(); }, deep: true },
      allFundingRequests_master: { handler() { if (this.isUserAuthenticated && (this.role === 'farmer' || this.role === 'investor')) this.filterDataForCurrentUser(); }, deep: true },
      allAPVProjects_master: { handler() { if (this.isUserAuthenticated && this.role === 'farmer') this.filterDataForCurrentUser(); }, deep: true },
      allBuyerPurchases_master: { handler() { if (this.isUserAuthenticated && this.role === 'buyer') this.filterDataForCurrentUser(); }, deep: true },
      allInvestorInvestments_master: { handler() { if (this.isUserAuthenticated && this.role === 'investor') this.filterDataForCurrentUser(); }, deep: true },
      allInvestorTransactions_master: { handler() { if (this.isUserAuthenticated && this.role === 'investor') this.filterDataForCurrentUser(); }, deep: true },
      messages_master: { handler() { if (this.isUserAuthenticated) this.filterDataForCurrentUser(); }, deep: true },
      conversations_master: { handler() { if (this.isUserAuthenticated) this.filterDataForCurrentUser(); }, deep: true },
      notifications_master: { handler() { if (this.isUserAuthenticated) this.filterDataForCurrentUser(); }, deep: true },
      energyLog: { handler() { if (this.current === 'renewableEnergyHub' && this.selectedAPVProjectForDashboard) this.renderAPVDashboardCharts(); }, deep: true },
      activeAPVProjectIdForDashboard(newVal, oldVal) {
        if (this.current === 'renewableEnergyHub' && newVal) {
            this.$nextTick(this.renderAPVDashboardCharts);
        } else if (!newVal) {
            this.destroyAPVDashboardCharts();
        }
      },

      'avatar.chatMessages': {
          handler(newMessages, oldMessages) {
              if (newMessages.length > (oldMessages ? oldMessages.length : 0) ) {
                  const lastMsg = newMessages[newMessages.length - 1];
                  if (lastMsg.sender === 'bot' && this.avatar.expanded && this.avatar.state !== 'talking') {
                      this.avatar.state = 'listening';
                  }
                  this.$nextTick(() => this.scrollToAvatarMessagesBottom());
                  if(lastMsg.sender === 'bot' && !this.avatar.expanded && this.avatar.state !== 'talking') {
                      this.avatar.state = 'idle';
                  }
              }
              // Save avatar chat to pestiVidAppData
              const appData = JSON.parse(localStorage.getItem('pestiVidAppData') || '{}');
              appData.avatarChatMessages = this.avatar.chatMessages;
              localStorage.setItem('pestiVidAppData', JSON.stringify(appData));
          },
          deep: true
      },
      'fundingForm.projectCategory'(newCategory) {
          if (newCategory !== 'agricultural') {
              this.fundingForm.crop = '';
              this.fundingForm.method = '';
          }
          if (newCategory !== 'renewable_energy') {
              this.fundingForm.solarCapacityKW = null;
              this.fundingForm.panelType = '';
          }
      },
      'avatar.isListening'(isListening) {
        if (isListening && 'speechSynthesis' in window && speechSynthesis.speaking) {
            speechSynthesis.cancel();
            this.avatar.state = 'listening';
        }
      }
    },
    methods: {
      // --- Navigation ---
      switchPage(page, params = {}) {
        this.currentParams = params;
        this.authError = '';
        if (!this.isUserAuthenticated && !['landing', 'login', 'signup', 'renewableAPVExplained', 'renewableEnergyHub'].includes(page)) {
            this.current = 'login';
            this.addNotification("Please login to access this page.", "warning");
        } else {
            this.current = page;
        }
        if (params && page === 'investorProjects' && params.category) {
            this.investorFilters.projectCategory = params.category;
        } else if (page === 'investorProjects' && (!params || !params.category)) {
        }
        this.showMobileMenu = false;
      },
      getStarted() {
        if (this.isUserAuthenticated) {
            if (this.role === 'farmer') this.switchPage('renewableEnergyHub');
            else if (this.role === 'investor') this.switchPage('investorProjects');
            else if (this.role === 'buyer') this.switchPage('buyerAgriSell');
            else this.switchPage('userProfile');
        } else {
            this.switchPage('signup');
        }
      },
      toggleRenewableEnergyMenu() { this.showRenewableEnergyMenu = !this.showRenewableEnergyMenu; },
      toggleRenewableEnergyMenuMobile() { this.showRenewableEnergyMenuMobileDrop = !this.showRenewableEnergyMenuMobileDrop; },

      // --- Authentication & User Profile ---
      handleLogout() {
        this.isUserAuthenticated = false;
        this.currentUserIdentifier = null;
        this.role = null;
        this.userName = null;
        this.userEmail = null;
        this.userPhone = null;
        this.memberSince = null;
        localStorage.removeItem('pestiVidCurrentUser');
        this.filterDataForCurrentUser();
        this.switchPage('landing');
        this.addNotification("Logged out successfully.", "info");
      },
      attemptAutoLogin() {
        const userJson = localStorage.getItem('pestiVidCurrentUser');
        if (userJson) {
            const userData = JSON.parse(userJson);
            const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles') || '{}');
            const fullUser = userProfiles[userData.id];

            if (fullUser) {
                this.isUserAuthenticated = true;
                this.currentUserIdentifier = fullUser.id;
                this.role = fullUser.role;
                this.userName = fullUser.name;
                this.userEmail = fullUser.email;
                this.userPhone = fullUser.phone;
                this.memberSince = fullUser.memberSince;
                return true;
            } else {
                localStorage.removeItem('pestiVidCurrentUser');
                return false;
            }
        }
        return false;
      },
      handleLogin() {
        const users = JSON.parse(localStorage.getItem('pestiVidUserProfiles') || '{}');
        const user = Object.values(users).find(u => u.email === this.loginForm.email && u.password === this.loginForm.password);
        if (user) {
            this.isUserAuthenticated = true;
            this.currentUserIdentifier = user.id;
            this.role = user.role;
            this.userName = user.name;
            this.userEmail = user.email;
            this.userPhone = user.phone;
            this.memberSince = user.memberSince;
            localStorage.setItem('pestiVidCurrentUser', JSON.stringify({id: user.id, name: user.name, role: user.role}));
            this.filterDataForCurrentUser();
            this.addNotification(`Welcome back, ${user.name}!`, "success");
            this.getStarted();
            this.loginForm = { email: '', password: '' };
        } else {
            this.authError = 'Invalid email or password.';
        }
      },
      handleSignup() {
        this.authError = '';
        if (this.signupForm.password.length < 6) {
            this.authError = "Password must be at least 6 characters long.";
            return;
        }
        if (this.signupForm.password !== this.signupForm.confirmPassword) {
            this.authError = "Passwords do not match.";
            return;
        }

        const users = JSON.parse(localStorage.getItem('pestiVidUserProfiles') || '{}');
        if (users[this.signupForm.email]) {
            this.authError = 'Email already exists.';
            return;
        }
        const newUser = {
            id: this.signupForm.email,
            name: this.signupForm.name,
            email: this.signupForm.email,
            password: this.signupForm.password,
            role: this.signupForm.role,
            memberSince: new Date().toLocaleDateString(),
            phone: this.simulateUserPhone(this.signupForm.email)
        };
        users[newUser.id] = newUser;
        localStorage.setItem('pestiVidUserProfiles', JSON.stringify(users));

        this.isUserAuthenticated = true;
        this.currentUserIdentifier = newUser.id;
        this.role = newUser.role;
        this.userName = newUser.name;
        this.userEmail = newUser.email;
        this.userPhone = newUser.phone;
        this.memberSince = newUser.memberSince;
        localStorage.setItem('pestiVidCurrentUser', JSON.stringify({id: newUser.id, name: newUser.name, role: newUser.role}));

        this.filterDataForCurrentUser();
        this.addNotification("Account created successfully! Welcome!", "success");
        this.getStarted();
        this.signupForm = { name: '', email: '', password: '', confirmPassword: '', role: 'farmer' };
      },
      handleProfileRoleSwitch() {
        if (this.userProfileRoleForSwitch && this.currentUserIdentifier) {
            const users = JSON.parse(localStorage.getItem('pestiVidUserProfiles') || '{}');
            const currentUserData = users[this.currentUserIdentifier];
            if (currentUserData) {
                currentUserData.role = this.userProfileRoleForSwitch;
                users[this.currentUserIdentifier] = currentUserData;
                localStorage.setItem('pestiVidUserProfiles', JSON.stringify(users));
                const activeUserSession = JSON.parse(localStorage.getItem('pestiVidCurrentUser'));
                if (activeUserSession && activeUserSession.id === this.currentUserIdentifier) {
                    activeUserSession.role = this.userProfileRoleForSwitch;
                    localStorage.setItem('pestiVidCurrentUser', JSON.stringify(activeUserSession));
                }
                this.role = currentUserData.role;
                this.filterDataForCurrentUser();
                this.addNotification(`Role switched to ${this.userProfileRoleForSwitch}. UI updated.`, "info");
                this.switchPage('userProfile');
            }
        }
      },
      getFarmerDisplayIdentifier(wallet, maxLength = 20) {
        const users = JSON.parse(localStorage.getItem('pestiVidUserProfiles') || '{}');
        const user = users[wallet];
        if (user && user.name) return user.name;
        const id = wallet || 'Unknown User';
        return id.length > maxLength ? id.substring(0, maxLength) + '...' : id;
      },
      showFarmerProfile(farmerWallet) {
        const users = JSON.parse(localStorage.getItem('pestiVidUserProfiles') || '{}');
        this.selectedFarmerProfile = users[farmerWallet] || { id: farmerWallet, name: 'Unknown User', role: 'N/A', memberSince: 'N/A', phone: 'N/A' };
        this.showFarmerProfileModal = true;
      },
      getFarmerListingsForProfile(farmerId) { return this.allListings_master.filter(l => l.farmerWallet === farmerId && l.status === 'active'); },
      getFarmerFundingRequestsForProfile(farmerId) { return this.allFundingRequests_master.filter(r => r.farmerWallet === farmerId && (r.status === 'pending' || r.status === 'partially_funded'));},
      simulateUserPhone(email) {
        let hash = 0;
        for (let i = 0; i < email.length; i++) {
            const char = email.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash |= 0;
        }
        return '555-' + ('0000' + Math.abs(hash % 10000)).slice(-4);
      },
      simulateMemberSince(email) {
        let hash = 0;
        for (let i = 0; i < email.length; i++) {
          hash = (hash + email.charCodeAt(i) * (i + 1)) % 3650;
        }
        const date = new Date(Date.now() - hash * 24 * 60 * 60 * 1000);
        return date.toLocaleDateString();
      },

      // --- Display Helpers ---
      getProjectIconClass(projectCategoryOrType) { if (projectCategoryOrType === 'agricultural') return 'fas fa-seedling text-green-600'; if (projectCategoryOrType === 'renewable_energy' || projectCategoryOrType === 'agrivoltaic_renewable') return 'fas fa-solar-panel text-yellow-500'; return 'fas fa-tasks text-gray-500'; },
      getProjectCategoryColor(projectCategoryOrType){ if (projectCategoryOrType === 'agricultural') return 'bg-green-100 text-green-800'; if (projectCategoryOrType === 'renewable_energy' || projectCategoryOrType === 'agrivoltaic_renewable') return 'bg-yellow-100 text-yellow-800'; return 'bg-gray-100 text-gray-800'; },
      getFundingProjectPrimaryDisplay(project) { const category = project.projectCategory || project.projectType; if (category === 'agricultural') return `${project.crop || 'N/A'} (${project.method || 'N/A'})`; if (category === 'renewable_energy') return `${project.solarCapacityKW || 'N/A'}kW Solar APV (${project.panelType || 'Generic APV'})`; return project.title; },
      getInvestmentPortfolioSubDisplay(investment) { const category = investment.projectCategory || investment.projectType; if (category === 'agricultural') return investment.crop; if (category === 'renewable_energy') return `${investment.solarCapacityKW || '?'}kW APV`; return 'Project'; },
      getPayoutTypeDisplay(projectCategoryOrType) { if (!projectCategoryOrType || projectCategoryOrType === 'agricultural') return 'Harvest Payout'; if (projectCategoryOrType === 'renewable_energy' || projectCategoryOrType === 'agrivoltaic_renewable') return 'Energy Payout'; return 'Payout'; },

      // --- IPFS & Video Recording ---
      ipfsUrl(cid) { return `https://${this.pinataGateway}/ipfs/${cid}`; },
      async uploadToPinata(file) {
        if (this.pinataJwt === 'YOUR_PINATA_JWT_MUST_BE_REPLACED_HERE' || !this.pinataJwt || this.pinataJwt.length < 50) {
            this.uploadError = "Pinata JWT not configured. Upload feature is disabled.";
            this.uploading = false;
            console.error("Pinata JWT is a placeholder. Cannot upload.");
            return null;
        }
        this.uploadError = '';
        const formData = new FormData();
        formData.append('file', file);
        try {
            this.showLoading('Uploading to IPFS via Pinata...');
            const res = await axios.post("https://api.pinata.cloud/pinning/pinFileToIPFS", formData, {
                maxBodyLength: "Infinity",
                headers: {
                    'Content-Type': `multipart/form-data; boundary=${formData._boundary}`,
                    'Authorization': `Bearer ${this.pinataJwt}`
                }
            });
            this.hideLoading();
            return res.data.IpfsHash;
        } catch (error) {
            this.hideLoading();
            console.error("Error uploading to Pinata:", error.response ? error.response.data : error);
            this.uploadError = "Failed to upload to Pinata: " + (error.response && error.response.data && error.response.data.error ? error.response.data.error.details || error.response.data.error : error.message);
            return null;
        }
      },
      startRecording() {
        this.showLive = true; this.recording = true; this.recordBlob = null; this.recordBlobUrl = ''; this.uploadError = '';
        this.$nextTick(() => {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({video:true, audio:true})
                .then(stream => {
                    this.recordStream = stream;
                    this.$refs.liveVideo.srcObject = stream;
                    const options = { mimeType: 'video/webm;codecs=vp9' };
                    if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                        console.warn(`${options.mimeType} is not Supported. Trying default.`);
                        delete options.mimeType;
                    }
                    this.recordMediaRecorder = new MediaRecorder(stream, options);
                    const chunks = [];
                    this.recordMediaRecorder.ondataavailable = e => chunks.push(e.data);
                    this.recordMediaRecorder.onstop = () => {
                        this.recordBlob = new Blob(chunks, { type: chunks[0].type || 'video/webm' });
                        this.recordBlobUrl = URL.createObjectURL(this.recordBlob);
                        chunks.length = 0;
                    };
                    this.recordMediaRecorder.start();
                }).catch(err => {
                    this.uploadError = "Camera/Mic access denied or error: " + err.message + ". Please check browser permissions.";
                    this.recording=false; this.showLive=false;
                    console.error("getUserMedia error:", err);
                });
            } else {
                this.uploadError = "Media devices (camera/microphone) are not supported by your browser.";
                this.recording=false; this.showLive=false;
            }
        });
      },
      stopRecording() { if(this.recordMediaRecorder && this.recording) {this.recordMediaRecorder.stop(); if (this.recordStream) this.recordStream.getTracks().forEach(track => track.stop()); this.recording = false; this.showLive=false;} },
      resetRecording() { this.recordForm = {crop:'', pesticide:'', location:'', pesticideCompany: '', purpose: 'agristream'}; this.recordBlob = null; this.recordBlobUrl = ''; this.uploadCid = ''; this.uploadError = ''; this.recording = false; this.showLive = false; if (this.recordStream) this.recordStream.getTracks().forEach(track => track.stop()); },
      async handleUpload() {
        if (!this.recordBlob) { this.uploadError = "No recording available to upload."; return; }
        this.uploading = true; this.uploadError = ''; this.uploadCid = '';
        try {
            const fileName = `pesti_vid_${this.recordForm.crop.replace(/\s+/g, '_') || 'generic'}_${Date.now()}.webm`;
            const file = new File([this.recordBlob], fileName, {type: this.recordBlob.type});
            const cid = await this.uploadToPinata(file);

            if(cid) {
                this.uploadCid = cid;
                this.lastUploadedVideoFileHash = 'sim_hash_' + cid.substring(0, 10) + Date.now();
                const newVideo = {
                    farmerWallet: this.currentUserIdentifier, cid: cid, videoFileHash: this.lastUploadedVideoFileHash,
                    crop: this.recordForm.crop, pesticide: this.recordForm.pesticide,
                    location: this.recordForm.location, pesticideCompany: this.recordForm.pesticideCompany,
                    purpose: this.recordForm.purpose, uploadTimestamp: new Date().toISOString()
                };
                this.allFarmerVideos_master.unshift(newVideo);
                if(this.role === 'farmer') this.farmerVideos.unshift(newVideo);

                this.lastUploadedVideoPurpose = this.recordForm.purpose;
                this.saveDataToLocalStorage();
                this.addNotification("Video uploaded successfully!", "success");
                this.recordForm = {crop:'', pesticide:'', location:'', pesticideCompany: '', purpose: 'agristream'};
            } else {
                if(!this.uploadError) this.uploadError = "Upload failed, CID not received.";
            }
        } catch (err) {
            this.uploadError = "Upload error: " + err.message;
            console.error("HandleUpload error:", err);
        } finally {
            this.uploading = false;
        }
      },
      prepareListingFromVideo(video) { this.listingForm.cid = video.cid; this.switchPage('farmerSell'); },
      prepareFundingFromVideo(video) { this.fundingForm.cid = video.cid; this.fundingForm.title = `${video.crop || 'Project'} Funding Initiative`; this.switchPage('farmerFunding'); },

      // --- Farmer Actions (Sell, Funding) ---
      createListing() {
        const selectedVideo = this.allFarmerVideos_master.find(v => v.cid === this.listingForm.cid && v.farmerWallet === this.currentUserIdentifier);
        if (!selectedVideo) { this.addNotification("Selected video not found or does not belong to you.", "error"); return; }
        const newListing = {
            id: 'lst' + Date.now(), farmerWallet: this.currentUserIdentifier,
            crop: selectedVideo.crop, location: selectedVideo.location,
            pesticide: selectedVideo.pesticide, pesticideCompany: selectedVideo.pesticideCompany,
            cid: selectedVideo.cid, videoFileHash: selectedVideo.videoFileHash,
            minPrice: this.listingForm.minPrice, maxPrice: this.listingForm.maxPrice,
            status: 'active', createdAt: new Date().toISOString(), isNew: true,
            txHash: 'sim_lst_tx_' + Date.now()
        };
        this.allListings_master.unshift(newListing);
        if (this.role === 'farmer') this.farmerListings.unshift(newListing);
        this.createdListingId = newListing.id;
        if (this.listingForm.notifyBuyers) { this.addNotification(`New Listing: "${newListing.crop}" by ${this.userName}. Video proof available.`, "info", "all_buyers"); this.listingNotificationSent = true; } else {this.listingNotificationSent = false;}
        this.saveDataToLocalStorage();
        this.addNotification("Listing created!", "success");
        this.listingForm = {cid:'', minPrice:'', maxPrice:'', notifyBuyers: true};
      },
      cancelListing(listingId) {
        const idxMaster = this.allListings_master.findIndex(l => l.id === listingId && l.farmerWallet === this.currentUserIdentifier);
        if (idxMaster > -1) this.allListings_master.splice(idxMaster, 1);
        if (this.role === 'farmer') { const idxFarmer = this.farmerListings.findIndex(l => l.id === listingId); if (idxFarmer > -1) this.farmerListings.splice(idxFarmer, 1); }
        this.saveDataToLocalStorage(); this.addNotification("Listing cancelled.", "info");
      },
      createFundingRequest() {
        const newRequest = {
            id: 'fr' + Date.now(), farmerWallet: this.currentUserIdentifier, ...this.fundingForm,
            fundedAmount: 0, status: 'pending', createdAt: new Date().toISOString(),
            investors: [], updates: [], txHash: 'sim_fr_tx_' + Date.now()
        };
        this.allFundingRequests_master.unshift(newRequest);
        if (this.role === 'farmer') this.farmerFundingRequests.unshift(newRequest);
        this.createdFundingRequest = true;
        if (this.fundingForm.notifyInvestors) { this.addNotification(`New Funding Request: "${newRequest.title}" by ${this.userName}. Target: ${newRequest.amount} Credits.`, "info", "all_investors"); }
        this.saveDataToLocalStorage();
        this.addNotification("Funding request created!", "success");
        this.fundingForm = { projectCategory: 'agricultural', title: '', crop: '', acres: null, solarCapacityKW: null, panelType: '', amount: null, method: '', cid: '', description: '', timeline: null, roi: null, investorShare: null, notifyInvestors: true };
        this.createdFundingRequest = false;
      },
      cancelFundingRequest(reqId) {
        const reqMaster = this.allFundingRequests_master.find(r => r.id === reqId && r.farmerWallet === this.currentUserIdentifier);
        if (reqMaster) reqMaster.status = 'cancelled';
        if (this.role === 'farmer') { const reqFarmer = this.farmerFundingRequests.find(r => r.id === reqId); if (reqFarmer) reqFarmer.status = 'cancelled'; }
        this.saveDataToLocalStorage(); this.addNotification("Funding request cancelled.", "info");
      },
      postProjectUpdate(projectId) {
        const text = this.newUpdateText[projectId];
        if (!text || text.trim() === '') return;
        const projectMaster = this.allFundingRequests_master.find(p => p.id === projectId && p.farmerWallet === this.currentUserIdentifier);
        if (projectMaster) {
            const update = { id: 'upd'+Date.now(), date: new Date().toLocaleDateString(), text: text };
            if (!projectMaster.updates) projectMaster.updates = [];
            projectMaster.updates.push(update);

            if(this.role === 'farmer') {
                const projectFarmer = this.farmerFundingRequests.find(p => p.id === projectId);
                if (projectFarmer) {
                    if (!projectFarmer.updates) projectFarmer.updates = [];
                    projectFarmer.updates.push(update);
                }
            }
            this.addNotification(`Update posted for "${projectMaster.title}"`, "success");
            (projectMaster.investors || []).forEach(inv => this.addNotification(`Update on "${projectMaster.title}": ${text}`, "info", inv.investorId));
            this.saveDataToLocalStorage();
            this.$set(this.newUpdateText, projectId, '');
        }
      },

      // --- Buyer Actions ---
      showBuyItemModal(listing) { this.selectedListing = listing; this.purchaseAmount = listing.minPrice; this.purchaseStatus = ''; this.purchaseError = ''; this.showBuyModal = true; },
      async confirmPurchase() {
        if (!this.selectedListing || !this.purchaseAmount) { this.purchaseError = "Invalid selection or amount."; return; }
        if (this.purchaseAmount < this.selectedListing.minPrice || this.purchaseAmount > this.selectedListing.maxPrice) { this.purchaseError = `Price must be between ${this.selectedListing.minPrice} and ${this.selectedListing.maxPrice}.`; return; }
        this.purchaseStatus = 'processing';
        const txHash = await this.simulateTransaction(`Purchasing ${this.selectedListing.crop}`);
        if (!txHash) { this.purchaseError = "Transaction simulation failed."; this.purchaseStatus = 'error'; return; }
        const purchase = {
            id: 'buy' + Date.now(), buyerWallet: this.currentUserIdentifier,
            listingId: this.selectedListing.id, ...this.selectedListing,
            agreedPrice: this.purchaseAmount, purchaseDate: new Date().toLocaleDateString(), txHash: txHash
        };
        this.allBuyerPurchases_master.unshift(purchase);
        if (this.role === 'buyer') this.buyerPurchases.unshift(purchase);

        const listingInAll = this.allListings_master.find(l => l.id === this.selectedListing.id);
        if (listingInAll) listingInAll.status = 'sold';
        const listingInFarmer = this.farmerListings.find(l => l.id === this.selectedListing.id);
        if (listingInFarmer) listingInFarmer.status = 'sold';

        this.purchaseStatus = 'success';
        this.addNotification(`Successfully purchased "${this.selectedListing.crop}"!`, "success");
        this.addNotification(`"${this.selectedListing.crop}" sold to ${this.userName}.`, "info", this.selectedListing.farmerWallet);
        this.saveDataToLocalStorage();
        setTimeout(() => {this.showBuyModal = false;}, 1500);
      },

      // --- Investor Actions ---
      async investInProject(project) {
          if (!this.isUserAuthenticated || this.role !== 'investor') { this.addNotification("Please switch to Investor role to invest.", "error"); return; }
          const amount = this.investmentAmounts[project.id];
          this.$set(this.investmentErrors, project.id, '');
          if (!amount || isNaN(amount) || amount <= 0) { this.$set(this.investmentErrors, project.id, 'Invalid investment amount.'); return; }
          const maxInvest = parseFloat(this.maxInvestmentAmount(project));
          const tolerance = 0.001;
          if (amount > maxInvest + tolerance) { this.$set(this.investmentErrors, project.id, `Maximum investment is ${maxInvest} Credits.`); return; }

          const preciseAmount = parseFloat(amount.toFixed(2));
          const txHash = await this.simulateTransaction(`Investing ${preciseAmount} Credits in ${project.title}`);
          if (!txHash) { this.$set(this.investmentErrors, project.id, 'Investment Transaction failed.'); return; }

          try {
              const projectInAllIdx = this.allFundingRequests_master.findIndex(p => p.id === project.id);
              if (projectInAllIdx === -1) throw new Error("Project not found in master list");
              const updatedProject = { ...this.allFundingRequests_master[projectInAllIdx] };
              updatedProject.fundedAmount = (updatedProject.fundedAmount || 0) + preciseAmount;
              updatedProject.investors = [...(updatedProject.investors || []), { investorId: this.currentUserIdentifier, amount: preciseAmount, txHash: txHash }];
              if (updatedProject.fundedAmount >= updatedProject.amount - tolerance) { updatedProject.status = 'funded'; updatedProject.fundedAmount = updatedProject.amount; } else { updatedProject.status = 'partially_funded'; }
              this.$set(this.allFundingRequests_master, projectInAllIdx, updatedProject);

              if (this.role === 'farmer') {
                 const farmerProjectIndex = this.farmerFundingRequests.findIndex(p => p.id === project.id);
                 if(farmerProjectIndex > -1) this.$set(this.farmerFundingRequests, farmerProjectIndex, updatedProject);
              }

              const newInvestment = {
                  id: 'inv' + Date.now(), investorWallet: this.currentUserIdentifier, projectId: project.id,
                  projectTitle: project.title, projectCategory: project.projectCategory || project.projectType, projectType: project.projectType,
                  farmerWallet: project.farmerWallet, crop: project.crop, method: project.method, description: project.description, acres: project.acres,
                  solarCapacityKW: project.solarCapacityKW, panelType: project.panelType,
                  timeline: project.timeline, roi: project.roi, investorShare: project.investorShare, amount: preciseAmount,
                  cid: project.cid, videoFileHash: project.videoFileHash, status: 'active',
                  progress: 0, investmentDate: new Date().toLocaleDateString(), txHash: txHash
              };
              this.allInvestorInvestments_master.unshift(newInvestment);
              if(this.role === 'investor') this.investorInvestments.unshift(newInvestment);

              const newTransaction = { id: 'tx' + Date.now(), investorWallet: this.currentUserIdentifier, txHash: txHash, type: 'investment', amount: preciseAmount, date: new Date().toLocaleDateString(), projectId: project.id, projectTitle: project.title, projectCategory: newInvestment.projectCategory, projectType: newInvestment.projectType };
              this.allInvestorTransactions_master.unshift(newTransaction);
               if(this.role === 'investor') {
                  this.investorTransactions.unshift(newTransaction);
                  this.investorTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
               }

              this.addNotification(`Investment of ${preciseAmount} Credits successful!`, 'success');
              this.addNotification(`SIM: ${preciseAmount} Credits invested in "${project.title}" by ${this.getFarmerDisplayIdentifier(this.currentUserIdentifier)}`, "info", project.farmerWallet);
              this.$set(this.investmentAmounts, project.id, null);
              this.saveDataToLocalStorage();
          } catch (err) {
              this.$set(this.investmentErrors, project.id, 'Investment simulation failed.');
              this.addNotification("Investment simulation failed: " + err.message, "error");
          }
      },
      viewInvestmentDetails(investment) { this.selectedInvestment = investment; this.selectedInvestmentProject = this.allFundingRequests_master.find(p => p.id === investment.projectId); this.showInvestmentDetailsModal = true; },
      maxInvestmentAmount(project) { return Math.max(0, project.amount - (project.fundedAmount || 0)).toFixed(2); },
      fundingProgressPercent(project) { return project.amount > 0 ? Math.min(100, (((project.fundedAmount || 0) / project.amount) * 100)).toFixed(0) : 0; },
      updateInvestmentProgress() {
        let changed = false;
        this.allInvestorInvestments_master.forEach(inv => {
            if ((inv.status === 'active' || inv.status === 'growing' || inv.status === 'generating') && inv.progress < 100) {
                inv.progress = Math.min(100, inv.progress + Math.floor(Math.random() * 3) + 1);
                changed = true;
                if (inv.progress >= 100) {
                    inv.status = (inv.projectCategory === 'renewable_energy' || inv.projectType === 'renewable_energy') ? 'completed' : 'harvested';
                    this.processPayout(inv);
                }
            }
        });
        if (changed) {
            if (this.role === 'investor') this.filterDataForCurrentUser();
            this.saveDataToLocalStorage();
        }
      },
      calculateExpectedReturn(investment) { return (investment.amount * (1 + investment.roi / 100)).toFixed(2); },
      processPayout(investment) {
        const payoutAmount = parseFloat(this.calculateExpectedReturn(investment));
        const txHash = 'sim_payout_tx_' + Date.now();
        const newTransaction = {
            id: 'tx_payout_' + Date.now(), investorWallet: investment.investorWallet, txHash: txHash,
            type: 'payout', amount: payoutAmount, date: new Date().toLocaleDateString(),
            projectId: investment.projectId, projectTitle: investment.projectTitle,
            projectCategory: investment.projectCategory, projectType: investment.projectType
        };
        this.allInvestorTransactions_master.unshift(newTransaction);
        if (this.role==='investor' && this.currentUserIdentifier === investment.investorWallet) {
            this.investorTransactions.unshift(newTransaction);
            this.investorTransactions.sort((a,b) => new Date(b.date) - new Date(a.date));
        }
        this.addNotification(`Payout of ${payoutAmount} Credits processed for "${investment.projectTitle}".`, "success", investment.investorWallet);
      },
      resetInvestorFilters() { this.investorFilters = {projectCategory: '', crop: '', method: '', minRoi: null, maxAmount: null, minCapacity: null}; },

      // --- Renewable Energy Methods ---
      closeAddAPVProjectModal() { this.showAddAPVProjectModal = false; this.newAPVProjectForm = { projectName: '', description: '', acres: null, solarCapacityKW: null, panelType: 'Elevated Single-Axis Tracker (20ft)', estimatedMonthlyEarningsPerAcre: null, status: 'operational' }; },
      async addAPVProject() {
          if (!this.isUserAuthenticated || this.role !== 'farmer') return;
          const form = this.newAPVProjectForm;
          if (!form.projectName || !form.description || !form.acres || !form.solarCapacityKW || !form.panelType || form.estimatedMonthlyEarningsPerAcre === null || !form.status) {
              this.addNotification("Please fill all APV project details.", "error"); return;
          }
          const newAPV = { id: 'apv' + Date.now(), farmerWallet: this.currentUserIdentifier, ...form, createdAt: new Date().toISOString() };
          this.allAPVProjects_master.unshift(newAPV);
          if(this.role === 'farmer') {
              this.farmerAPVProjects.unshift(newAPV);
              this.activeAPVProjectIdForDashboard = newAPV.id; // Auto-select the new project
          }

          if (form.status === 'seeking_funding') {
              const promptedAmount = prompt("Enter total funding required for " + form.projectName + " (Credits):", String(form.solarCapacityKW * 50));
              const promptedTimeline = prompt("Enter project timeline in months:", "12");
              const promptedRoi = prompt("Enter expected ROI % from energy sales:", "15");
              const promptedInvestorShare = prompt("Enter investor share % of energy profits:", "25");
              const fundingAmount = parseFloat(promptedAmount); const timeline = parseInt(promptedTimeline); const roi = parseFloat(promptedRoi); const investorShare = parseFloat(promptedInvestorShare);

              if (promptedAmount === null || promptedTimeline === null || promptedRoi === null || promptedInvestorShare === null || isNaN(fundingAmount) || isNaN(timeline) || isNaN(roi) || isNaN(investorShare) || fundingAmount <= 0 || timeline <= 0 || roi < 0 || investorShare <= 0 || investorShare > 80) {
                  this.addNotification(`APV project "${form.projectName}" added. Funding request creation cancelled or details invalid.`, 'warning');
              } else {
                  const fundingRequest = {
                      id: 'fr_apv_' + Date.now(), farmerWallet: this.currentUserIdentifier, projectCategory: 'renewable_energy', projectType: 'renewable_energy',
                      title: form.projectName + " (APV Funding)", amount: fundingAmount,
                      description: `Funding for ${form.acres} acre Agrivoltaic project: ${form.description}. Capacity: ${form.solarCapacityKW}kW. Panels: ${form.panelType}. Expected ROI from energy sales.`,
                      timeline: timeline, roi: roi, investorShare: investorShare, fundedAmount: 0, status: 'pending', createdAt: new Date().toISOString(),
                      investors: [], cid: null, solarCapacityKW: form.solarCapacityKW, acres: form.acres, panelType: form.panelType, updates: []
                  };
                  this.allFundingRequests_master.unshift(fundingRequest);
                  if(this.role === 'farmer') this.farmerFundingRequests.unshift(fundingRequest);
                  this.addNotification(`APV project "${form.projectName}" added and listed for funding!`, 'success');
              }
          } else {
             this.addNotification(`APV project "${form.projectName}" added successfully!`, 'success');
          }
          this.saveDataToLocalStorage();
          this.closeAddAPVProjectModal();
          if (this.current === 'renewableEnergyHub') { // If already on hub, re-render charts
             this.$nextTick(this.renderAPVDashboardCharts);
          }
      },
      openEnergyLogModal(apvProjectId) {
        this.activeAPVProjectIdForLog = apvProjectId;
        // If dashboard is active and this is the project, use its name, else find project
        const project = this.selectedAPVProjectForDashboard && this.selectedAPVProjectForDashboard.id === apvProjectId
            ? this.selectedAPVProjectForDashboard
            : this.farmerAPVProjects.find(p => p.id === apvProjectId);

        this.newEnergyLogForm = {
            timestamp: new Date().toISOString().split('T')[0],
            energyProducedKWh: null,
            trackerConsumptionKWh: project ? (project.solarCapacityKW * 0.02).toFixed(1) : 0, // Example default based on capacity
            farmSelfConsumptionKWh: project ? (project.solarCapacityKW * 0.1).toFixed(1) : 0, // Example default
            energySoldKWh: null,
            salePricePerKWh: 0.15 // Default price
        };
        this.showEnergyLogModal = true;
    },
      closeEnergyLogModal() { this.showEnergyLogModal = false; this.activeAPVProjectIdForLog = null; },
      addEnergyLogEntry() {
          if (!this.activeAPVProjectIdForLog || !this.newEnergyLogForm.timestamp || this.newEnergyLogForm.energyProducedKWh === null) {
              this.addNotification("Please select a date and enter energy produced.", "error"); return;
          }
          const newLog = {
              id: 'elog' + Date.now(), apvProjectId: this.activeAPVProjectIdForLog, ...this.newEnergyLogForm,
              revenueFromSale: (this.newEnergyLogForm.energySoldKWh && this.newEnergyLogForm.salePricePerKWh) ? this.newEnergyLogForm.energySoldKWh * this.newEnergyLogForm.salePricePerKWh : 0,
          };
          this.energyLog.unshift(newLog);
          this.addNotification("Energy log added successfully!", "success");
          this.saveDataToLocalStorage();
          this.closeEnergyLogModal();
          if (this.current === 'renewableEnergyHub' && this.selectedAPVProjectForDashboard && this.selectedAPVProjectForDashboard.id === this.activeAPVProjectIdForLog) {
             this.$nextTick(this.renderAPVDashboardCharts); // Re-render charts if current project log added
          }
      },
      getEnergyLogsForProject(apvProjectId) { return this.energyLog.filter(log => log.apvProjectId === apvProjectId).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)); },
      calculateProjectTotalEnergy(apvProjectId, type) { const logs = this.getEnergyLogsForProject(apvProjectId); let total = 0; logs.forEach(log => { if (type === 'produced') total += (log.energyProducedKWh || 0); else if (type === 'tracker') total += (log.trackerConsumptionKWh || 0); else if (type === 'sold') total += (log.energySoldKWh || 0); }); return total.toFixed(1); },
      calculateProjectTotalRevenue(apvProjectId) { const logs = this.getEnergyLogsForProject(apvProjectId); let totalRevenue = 0; logs.forEach(log => { totalRevenue += (log.revenueFromSale || 0); }); return totalRevenue.toFixed(2); },
      setActiveAPVProjectForDashboard(apvProjectId) {
        this.activeAPVProjectIdForDashboard = apvProjectId;
        // The watcher on activeAPVProjectIdForDashboard will handle chart rendering
      },
      handleAPVDashboardProjectChange() {
         // Watcher will pick this up and re-render charts
      },
      simulateAPVOptimization() {
        if (!this.selectedAPVProjectForDashboard) {
            this.apvOptimizationResult = "Please select an APV project first.";
            return;
        }
        const scenarios = {
            'maximize_morning': `For ${this.selectedAPVProjectForDashboard.projectName}, panels would tilt further East earlier. Potential Production: Slightly Higher. Ground Shade: Increased in AM.`,
            'maximize_midday': `Panels would flatten more during midday. Potential Production: Highest. Ground Shade: Maximized Under Panels.`,
            'maximize_evening': `Panels would tilt further West later. Potential Production: Slightly Higher. Ground Shade: Increased in PM.`,
            'increase_shade': `Panels adjusted for more consistent ground shading. Potential Production: Slightly Lower. Ground Shade: Moderately Increased & Consistent.`,
            'balanced': `Standard tracking algorithm active. Good overall production and balanced light distribution.`
        };
        this.apvOptimizationResult = scenarios[this.apvOptimizationScenario] || "Standard operation simulated.";
      },
      destroyAPVDashboardCharts() {
        if (this.energyProductionChartInstance) { this.energyProductionChartInstance.destroy(); this.energyProductionChartInstance = null; }
        if (this.energyUsageChartInstance) { this.energyUsageChartInstance.destroy(); this.energyUsageChartInstance = null; }
      },
      renderAPVDashboardCharts() {
        this.destroyAPVDashboardCharts();
        if (!this.selectedAPVProjectForDashboard || typeof Chart === 'undefined') return;

        const projectLogs = this.getEnergyLogsForProject(this.selectedAPVProjectForDashboard.id)
            .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)) // Sort by date ascending for chart
            .slice(-30); // Get last 30 entries

        // Energy Production Chart
        const productionCtx = this.$refs.energyProductionChart?.getContext('2d');
        if (productionCtx && projectLogs.length > 0) {
            this.energyProductionChartInstance = new Chart(productionCtx, {
                type: 'line',
                data: {
                    labels: projectLogs.map(log => new Date(log.timestamp).toLocaleDateString(undefined, {month: 'short', day: 'numeric'})),
                    datasets: [
                        { label: 'Produced (kWh)', data: projectLogs.map(log => log.energyProducedKWh), borderColor: 'rgb(75, 192, 192)', tension: 0.1, fill: false },
                        { label: 'Sold (kWh)', data: projectLogs.map(log => log.energySoldKWh), borderColor: 'rgb(255, 205, 86)', tension: 0.1, fill: false },
                        { label: 'Self-Consumed (kWh)', data: projectLogs.map(log => log.farmSelfConsumptionKWh), borderColor: 'rgb(54, 162, 235)', tension: 0.1, fill: false }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }

        // Energy Usage Distribution Chart
        const usageCtx = this.$refs.energyUsageChart?.getContext('2d');
        if (usageCtx) {
            const totalSelf = parseFloat(this.dashboardStats.totalSelfConsumed);
            const totalTracker = parseFloat(this.dashboardStats.totalTrackerConsumed);
            const totalSold = parseFloat(this.dashboardStats.totalSold);

            if (totalSelf > 0 || totalTracker > 0 || totalSold > 0) {
                this.energyUsageChartInstance = new Chart(usageCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Farm Self-Consumed', 'Tracker Consumption', 'Sold to Grid'],
                        datasets: [{
                            data: [totalSelf, totalTracker, totalSold],
                            backgroundColor: ['rgb(54, 162, 235)', 'rgb(153, 102, 255)', 'rgb(255, 205, 86)']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
        }
      },


      // --- Messaging ---
      async startOrGoToConversation(otherParticipantId) {
        if (otherParticipantId === this.currentUserIdentifier) { this.addNotification("You cannot message yourself.", "warning"); return; }
        let conversation = this.conversations_master.find(c => c.participants.includes(this.currentUserIdentifier) && c.participants.includes(otherParticipantId));
        if (!conversation) {
            conversation = { id: 'conv_' + Date.now(), participants: [this.currentUserIdentifier, otherParticipantId], lastMessageTimestamp: new Date().toISOString(), lastMessagePreview: "Conversation started.", unreadCount: 0 };
            this.conversations_master.unshift(conversation);
            this.conversations_master.sort((a, b) => new Date(b.lastMessageTimestamp) - new Date(a.lastMessageTimestamp));
        }
        this.activeConversationId = conversation.id;
        this.filterDataForCurrentUser();
        this.switchPage('messaging');
        this.$nextTick(() => this.markConversationAsRead(conversation.id));
        this.saveDataToLocalStorage();
      },
      async sendMessage() {
        if (!this.messageInputText.trim() || !this.activeConversationId) return;
        const conversation = this.conversations_master.find(c => c.id === this.activeConversationId);
        if (!conversation) return;
        const newMessage = {
            id: 'msg_' + Date.now(), conversationId: this.activeConversationId,
            sender: this.currentUserIdentifier,
            receiver: conversation.participants.find(p => p !== this.currentUserIdentifier),
            text: this.messageInputText, timestamp: new Date().toISOString(), read: false
        };
        this.messages_master.unshift(newMessage);
        conversation.lastMessageTimestamp = newMessage.timestamp;
        conversation.lastMessagePreview = newMessage.text.substring(0, 30) + (newMessage.text.length > 30 ? '...' : '');
        this.conversations_master.sort((a, b) => new Date(b.lastMessageTimestamp) - new Date(a.lastMessageTimestamp));

        this.filterDataForCurrentUser();
        this.messageInputText = '';
        this.$nextTick(() => this.scrollToMessageBottom());
        this.addNotification(`Message sent to ${this.getOtherParticipantName(conversation)}.`, 'success', newMessage.receiver);
        this.saveDataToLocalStorage();
        clearTimeout(this.typingTimeout); this.isTyping = false;
      },
      markConversationAsRead(conversationId) {
        const conversationMaster = this.conversations_master.find(c => c.id === conversationId);
        if (conversationMaster) conversationMaster.unreadCount = 0;
        const conversationLocal = this.conversations.find(c => c.id === conversationId);
        if (conversationLocal) conversationLocal.unreadCount = 0;

        this.messages_master.filter(m => m.conversationId === conversationId && m.receiver === this.currentUserIdentifier).forEach(m => m.read = true);
        this.saveDataToLocalStorage();
      },
      getOtherParticipantName(conversation) {
        if (!conversation || !conversation.participants) return 'N/A';
        const otherId = conversation.participants.find(p => p !== this.currentUserIdentifier);
        return this.getFarmerDisplayIdentifier(otherId);
      },
      getConversationMessages(conversationId) {
        return this.messages.filter(m => m.conversationId === conversationId).sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
      },
      scrollToMessageBottom() { this.$nextTick(() => { const container = this.$refs.messageViewContainer; if (container) container.scrollTop = container.scrollHeight; }); },
      handleTyping() {
        clearTimeout(this.typingTimeout); this.isTyping = true;
        this.typingTimeout = setTimeout(() => { this.isTyping = false; }, 2000);
      },
      formatTimestamp(isoString) {
        if(!isoString) return '';
        const date = new Date(isoString);
        const now = new Date();
        if (date.toDateString() === now.toDateString()) return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        return date.toLocaleDateString([], {month:'short', day:'numeric'});
      },

      // --- Notifications ---
      addNotification(message, type = 'info', recipient = null) {
        const actualRecipient = recipient || this.currentUserIdentifier;
        const newNotif = {
            id: 'notif_' + Date.now(), message: message, type: type,
            recipient: actualRecipient, timestamp: new Date().toISOString(),
            icon: this.getNotificationIcon(type), read: false, show: false
        };
        this.notifications_master.unshift(newNotif);

        if (actualRecipient === this.currentUserIdentifier ||
            (actualRecipient === "all_buyers" && this.role === "buyer") ||
            (actualRecipient === "all_investors" && this.role === "investor")) {
            this.notifications.unshift(newNotif);
            this.showNextToastNotification();
        }
        this.saveDataToLocalStorage();
      },
      getNotificationIcon(type) { switch(type){ case 'success': return 'fas fa-check-circle'; case 'error': return 'fas fa-exclamation-circle'; case 'warning': return 'fas fa-exclamation-triangle'; default: return 'fas fa-info-circle';} },
      showNextToastNotification() {
        const unshownToast = this.notifications.find(n => !n.show && !n.read && n.recipient === this.currentUserIdentifier);
        if (unshownToast && this.recentNotifications.length < 3) {
            unshownToast.show = true;
            this.recentNotifications.push(unshownToast);
            setTimeout(() => {
                this.removeNotification(unshownToast.id);
                const masterNotif = this.notifications_master.find(nm => nm.id === unshownToast.id);
                if (masterNotif) masterNotif.read = true;
                const localNotif = this.notifications.find(nl => nl.id === unshownToast.id);
                if (localNotif) localNotif.read = true;
                this.showNextToastNotification();
            }, 5000);
        }
      },
      removeNotification(id) {
        const index = this.recentNotifications.findIndex(n => n.id === id);
        if (index > -1) {
            this.recentNotifications[index].show = false;
            setTimeout(() => this.recentNotifications.splice(index, 1), 500);
        }
        this.saveDataToLocalStorage();
      },

      // --- UI Helpers & Misc ---
      async simulateTransaction(action) { this.showLoading(action + '...'); return new Promise(resolve => setTimeout(() => { this.hideLoading(); resolve('0x' + Array(64).fill(0).map(()=>Math.floor(Math.random()*16).toString(16)).join('')); }, 1500)); },
      showLoading(message = '') { this.loadingMessage = message; this.showLoadingModal = true; },
      hideLoading() { this.showLoadingModal = false; this.loadingMessage = ''; },
      scrollToAndHighlightAgriStreamVideo() {
        if (!this.targetAgriStreamVideoCid) return;
        this.$nextTick(() => {
            const videoElement = document.getElementById('video-' + this.targetAgriStreamVideoCid);
            if (videoElement) {
                videoElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                this.highlightedAgriStreamVideoCid = this.targetAgriStreamVideoCid;
                setTimeout(() => { this.highlightedAgriStreamVideoCid = null; this.targetAgriStreamVideoCid = null; }, 3000);
            } else {
                this.targetAgriStreamVideoCid = null;
            }
        });
      },
      renderMarkdown(text) {
          if (window.marked && typeof window.marked.parse === 'function') {
              return marked.parse(text || '', { breaks: true, gfm: true });
          }
          return (text || '').replace(/\n/g, '<br>');
      },

      // --- Plant Recommendation ---
      handlePlantImageUpload(event) {
        const file = event.target.files[0];
        if (file) {
            if (file.size > 4 * 1024 * 1024) {
                this.analysisErrorText = "Image size should be less than 4MB.";
                this.plantImageFile = null; this.plantImageUrl = null; this.plantImageMimeType = null;
                event.target.value = null;
                return;
            }
            this.plantImageFile = file;
            this.plantImageUrl = URL.createObjectURL(file);
            this.plantImageMimeType = file.type;
            this.analysisResultText = ''; this.parsedAnalysis = { plantName: null, diseaseName: null, treatmentRecommended: null }; this.analysisErrorText = '';
        }
      },
      async analyzePlantImage() {
        if (!this.plantImageFile || this.geminiApiKey === 'YOUR_GEMINI_API_KEY_REPLACE_HERE' || !this.geminiApiKey) {
            this.analysisErrorText = "Please upload an image and ensure Gemini API key is valid.";
            return;
        }
        this.analysisInProgress = true; this.analysisErrorText = ''; this.analysisResultText = ''; this.parsedAnalysis = { plantName: null, diseaseName: null, treatmentRecommended: null };

        const reader = new FileReader();
        reader.readAsDataURL(this.plantImageFile);
        reader.onloadend = async () => {
            const base64Data = reader.result.split(',')[1];
            const requestBody = {
                contents: [{
                    parts: [
                        { text: "Analyze this plant image. Identify the plant, any visible diseases, and suggest a brief treatment or care advice. Structure your response clearly with labels like 'Plant:', 'Disease:', 'Treatment:'." },
                        { inline_data: { mime_type: this.plantImageMimeType, data: base64Data } }
                    ]
                }],
                generationConfig: { temperature: 0.4, topK: 32, topP: 1, maxOutputTokens: 2048 }
            };

            try {
                this.showLoading("Analyzing with Gemini Vision AI...");
                const response = await axios.post(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro-vision:generateContent?key=${this.geminiApiKey}`, requestBody);
                this.hideLoading();
                if (response.data.candidates && response.data.candidates[0].content.parts[0].text) {
                    this.analysisResultText = response.data.candidates[0].content.parts[0].text;
                    this.parsedAnalysis = this.parseGeminiResponse(this.analysisResultText);
                } else {
                    this.analysisErrorText = "AI analysis did not return expected content.";
                    console.warn("Unexpected Gemini response:", response.data);
                }
            } catch (error) {
                this.hideLoading();
                console.error("Error analyzing plant image with Gemini:", error.response ? error.response.data : error);
                this.analysisErrorText = "Error analyzing image with AI: " + (error.response && error.response.data && error.response.data.error ? error.response.data.error.message : error.message);
            } finally {
                this.analysisInProgress = false;
            }
        };
        reader.onerror = (error) => {
            this.hideLoading();
            this.analysisErrorText = "Error reading file: " + error;
            this.analysisInProgress = false;
        };
      },
      parseGeminiResponse(text) {
        let plantName = null, diseaseName = null, treatmentRecommended = null;
        const plantMatch = text.match(/Plant:\s*([\s\S]*?)(Disease:|Treatment:|$)/i);
        if (plantMatch) plantName = plantMatch[1].trim();

        const diseaseMatch = text.match(/Disease:\s*([\s\S]*?)(Treatment:|$)/i);
        if (diseaseMatch) diseaseName = diseaseMatch[1].trim();

        const treatmentMatch = text.match(/Treatment:\s*([\s\S]*)/i);
        if (treatmentMatch) treatmentRecommended = treatmentMatch[1].trim();

        return { plantName, diseaseName, treatmentRecommended };
      },

      // --- AVATAR ASSISTANT METHODS ---
      speakText(textToSpeak, onEndCallback = null) {
          if (!('speechSynthesis' in window)) {
              console.warn("Browser does not support Speech Synthesis. Avatar cannot speak.");
              this.avatar.state = this.avatar.expanded ? 'listening' : 'idle';
              if (onEndCallback) onEndCallback();
              return;
          }
          if (speechSynthesis.speaking) { speechSynthesis.cancel(); }
          const utterance = new SpeechSynthesisUtterance(textToSpeak);
          utterance.lang = 'en-US'; utterance.rate = 1; utterance.pitch = 1;
          const voices = speechSynthesis.getVoices();
          let selectedVoice = voices.find(voice => voice.name.includes('Google US English') || voice.name.includes('Microsoft David') || voice.name.includes('Samantha'));
          if (!selectedVoice && voices.length > 0) { selectedVoice = voices.find(voice => voice.lang.startsWith('en-US')) || voices[0]; }
          if (selectedVoice) utterance.voice = selectedVoice;
          utterance.onstart = () => { this.avatar.state = 'talking'; };
          utterance.onend = () => { this.avatar.state = this.avatar.expanded ? 'listening' : 'idle'; if (onEndCallback) onEndCallback(); };
          utterance.onerror = (event) => { console.error('SpeechSynthesisUtterance.onerror', event); this.addNotification("Avatar speech error: " + event.error, "error"); this.avatar.state = this.avatar.expanded ? 'listening' : 'idle'; if (onEndCallback) onEndCallback(); };
          speechSynthesis.speak(utterance);
      },
      initializeSpeechRecognition() {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          if (!SpeechRecognition) { this.addNotification("Speech recognition not supported in this browser.", "warning"); console.warn("STT not supported."); return; }
          if (!this.speechRecognition) {
              this.speechRecognition = new SpeechRecognition();
              this.speechRecognition.continuous = false; this.speechRecognition.interimResults = false; this.speechRecognition.lang = 'en-US';
              this.speechRecognition.onstart = () => { this.avatar.isListening = true; this.avatar.state = 'listening'; console.log("Avatar STT started."); };
              this.speechRecognition.onresult = (event) => { let transcript = ''; for (let i = event.resultIndex; i < event.results.length; ++i) { if (event.results[i].isFinal) { transcript += event.results[i][0].transcript; } } if (transcript) { this.avatar.userInput = (this.avatar.userInput ? this.avatar.userInput + ' ' : '') + transcript; } console.log("Avatar STT result:", transcript); };
              this.speechRecognition.onerror = (event) => { console.error('SpeechRecognitionError:', event.error); let errorMsg = "Voice input error: " + event.error; if (event.error === 'not-allowed' || event.error === 'service-not-allowed') { errorMsg = "Microphone access denied. Please allow microphone access in browser settings."; } else if (event.error === 'no-speech') { errorMsg = "No speech detected. Please try again."; } this.addNotification(errorMsg, "error"); this.avatar.isListening = false; this.avatar.state = this.avatar.expanded ? 'listening' : 'idle'; };
              this.speechRecognition.onend = () => { this.avatar.isListening = false; if (this.avatar.state === 'listening' && !this.avatar.expanded) { this.avatar.state = 'idle'; } else if (this.avatar.expanded && this.avatar.state === 'listening') { } console.log("Avatar STT ended."); };
          }
      },
      toggleAvatarListening() {
        if (!this.speechRecognition) this.initializeSpeechRecognition();
        if (this.speechRecognition) {
            if (this.avatar.isListening) {
                this.speechRecognition.stop();
            } else {
                if ('speechSynthesis' in window && speechSynthesis.speaking) { speechSynthesis.cancel(); }
                try {
                    this.speechRecognition.start();
                } catch (e) {
                    console.error("Error starting STT:", e);
                    this.addNotification("Could not start voice input. " + e.message, "error");
                    this.avatar.isListening = false;
                    this.avatar.state = this.avatar.expanded ? 'listening' : 'idle';
                }
            }
        }
      },
      toggleAvatarExpansion(forceState = null) {
          this.avatar.expanded = forceState !== null ? forceState : !this.avatar.expanded;
          if (this.avatar.expanded) {
              this.avatar.state = 'listening'; this.updateAvatarContextAndQuickActions(); this.clearUnreadAvatarMessages();
              this.$nextTick(() => this.scrollToAvatarMessagesBottom());
              if (this.avatar.chatMessages.length === 0 || (this.avatar.chatMessages.length === 1 && this.avatar.chatMessages[0].id.startsWith('avatar-greeting-'))) {
                  const greeting = this.getAvatarGreeting();
                   if (this.avatar.chatMessages.length === 0 || (this.avatar.chatMessages.length === 1 && this.avatar.chatMessages[0].id.startsWith('avatar-greeting-'))) {
                         this.avatar.chatMessages = [{ id: 'avatar-greeting-' + Date.now(), sender: 'bot', text: greeting, timestamp: new Date().toISOString(), readByUser: true }];
                         this.speakText(greeting);
                    } else { this.avatar.state = 'listening'; }
              } else { this.avatar.state = 'listening'; }
              this.initializeSpeechRecognition();
          } else {
              this.avatar.state = 'idle';
              if (this.speechRecognition && this.avatar.isListening) { this.speechRecognition.stop(); }
              if ('speechSynthesis' in window && speechSynthesis.speaking) { speechSynthesis.cancel(); }
          }
      },
      getAvatarGreeting() {
          let pageName = this.current.replace(/([A-Z])/g, ' $1').toLowerCase();
          pageName = pageName.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
          if (this.current === 'landing') return "Hi there! 👋 I'm the PestiVid Helper. How can I assist you today on our platform?";
          return `Welcome to the ${pageName} page! I'm PestiVid Helper. What can I do for you here?`;
      },
      updateAvatarContextAndQuickActions() {
          this.avatar.quickActions = [];
          this.avatar.currentContextText = `User is on the ${this.current} page. ${this.isUserAuthenticated ? 'Current role: ' + this.role + '.' : 'User is not logged in.'}`;
          switch (this.current) {
              case 'landing': this.avatar.quickActions.push({ id: 'qa_what_is', label: "What is PestiVid?", query: "Explain PestiVid briefly." }, { id: 'qa_get_started', label: "How to get started?", query: "How do I get started with PestiVid?" }); break;
              case 'farmerPestiVid':
                   if (this.isUserAuthenticated && this.role === 'farmer') { this.avatar.currentContextText += " This is where farmers record crop videos."; this.avatar.quickActions.push({ id: 'qa_record_tips', label: "Recording Tips", query: "Give me tips for recording good PestiVid videos." }, { id: 'qa_ipfs_explain', label: "What is IPFS?", query: "Explain IPFS in simple terms for a farmer." });
                   } else { this.avatar.currentContextText += " This is the video recording page, only for farmers."; this.avatar.quickActions.push({ id: 'qa_farmer_features', label: "Farmer features?", query: "What features are available only for farmers?" }); } break;
               case 'farmerAgriStream': if (this.isUserAuthenticated && this.role === 'farmer') { this.avatar.currentContextText += " This is the farmer's AgriStream, showing their uploaded videos."; this.avatar.quickActions.push({ id: 'qa_video_purpose', label: "Video purposes?", query: "What are the different purposes for videos?" }, { id: 'qa_upload_video', label: "Upload a video?", query: "How do I upload a new video?" }); } break;
               case 'farmerSell': if (this.isUserAuthenticated && this.role === 'farmer') { this.avatar.currentContextText += " This is where farmers create listings for sale."; this.avatar.quickActions.push({ id: 'qa_listing_tips', label: "Listing tips?", query: "Tips for creating a good listing." }, { id: 'qa_why_sell', label: "Why sell here?", query: "What are the benefits of selling on PestiVid?" }); } break;
               case 'farmerFunding': if (this.isUserAuthenticated && this.role === 'farmer') { this.avatar.currentContextText += " This is where farmers request funding for projects."; this.avatar.quickActions.push({ id: 'qa_funding_types', label: "Project types?", query: "What kinds of projects can I get funding for?" }, { id: 'qa_attract_investors', label: "Attract investors?", query: "How can I make my project attractive to investors?" }); } break;
                case 'buyerAgriSell': if (this.isUserAuthenticated && this.role === 'buyer') { this.avatar.currentContextText += " User is browsing the AgriSell marketplace."; this.avatar.quickActions.push({ id: 'qa_how_buy', label: "How to buy?", query: "How does buying on AgriSell work?" }, { id: 'qa_video_auth', label: "Video verification?", query: "How does video verification work for buyers?" }); } break;
                 case 'investorProjects': if (this.isUserAuthenticated && this.role === 'investor') { this.avatar.currentContextText += " User is browsing investment opportunities."; this.avatar.quickActions.push({ id: 'qa_how_invest', label: "How to invest?", query: "How does investing in projects work?" }, { id: 'qa_roi_explain', label: "ROI explained?", query: "Explain how ROI is calculated for projects." }); } break;
                 case 'investorPortfolio': if (this.isUserAuthenticated && this.role === 'investor') { this.avatar.currentContextText += " User is viewing their investment portfolio."; this.avatar.quickActions.push({ id: 'qa_portfolio_stats', label: "Portfolio stats?", query: "Explain the stats in my portfolio." }, { id: 'qa_payouts', label: "Payouts?", query: "How are investment payouts handled?" }); } break;
                 case 'messaging': if (this.isUserAuthenticated) { this.avatar.currentContextText += " User is using the messaging feature."; this.avatar.quickActions.push({ id: 'qa_message_user', label: "How to message someone?", query: "How do I start a conversation?" }); } break;
              case 'plantRecommendation': if (this.isUserAuthenticated) { this.avatar.currentContextText += " This is where users can get plant disease recommendations."; this.avatar.quickActions.push({ id: 'qa_plant_how', label: "How to use?", query: "How do I use the plant recommendation feature?" }, { id: 'qa_plant_accuracy', label: "How accurate?", query: "How accurate is the plant disease detection?" }); } break;
              case 'userProfile': if (this.isUserAuthenticated) { this.avatar.currentContextText += " User is viewing their profile."; this.avatar.quickActions.push({ id: 'qa_update_profile', label: "Update profile?", query: "Can I update my profile information?" }, { id: 'qa_change_role', label: "Change role?", query: "Can I change my role later?" }); } break;
              case 'login': this.avatar.currentContextText += " User is on the login page."; this.avatar.quickActions.push({ id: 'qa_login_help', label: "Login Help", query: "I'm having trouble logging in." }, { id: 'qa_signup_instead', label: "Sign Up?", query: "How do I sign up?" }); break;
              case 'signup': this.avatar.currentContextText += " User is on the sign up page."; this.avatar.quickActions.push({ id: 'qa_signup_req', label: "Signup Requirements", query: "What information do I need to sign up?" }, { id: 'qa_roles_explain', label: "Roles?", query: "Explain the different user roles." }); break;
              case 'renewableAPVExplained': this.avatar.currentContextText += " User is learning about Agrivoltaics (APV)."; this.avatar.quickActions.push({ id: 'qa_apv_benefits', label: "APV Benefits?", query: "What are the main benefits of APV?" }, { id: 'qa_apv_earnings', label: "APV Earnings?", query: "How much can a farmer earn from APV?" }); break;
              case 'renewableEnergyHub':
                 if (this.isUserAuthenticated && this.role === 'farmer' && this.farmerAPVProjects.length > 0) {
                     this.avatar.currentContextText += " Farmer is on their APV Projects Dashboard.";
                     this.avatar.quickActions.push({ id: 'qa_add_apv_project', label: "Add APV Project?", query: "How do I add a new APV project?" }, { id: 'qa_log_energy', label: "Log Energy Data?", query: "How do I log energy data for my APV project?" });
                 } else {
                     this.avatar.currentContextText += " User is viewing the Renewable Energy Hub / APV Explanation.";
                     this.avatar.quickActions.push({ id: 'qa_apv_what_is', label: "What is APV?", query: "Explain Agrivoltaics." });
                 }
                 break;
              default: this.avatar.quickActions.push({ id: 'qa_general_help', label: "General Help", query: "What can you help me with?" });
          }
      },
      async sendAvatarMessage() {
          if (!this.avatar.userInput.trim() || this.avatar.isProcessing) return;
          if (this.avatar.isListening) { this.speechRecognition.stop(); }
          const userInput = this.avatar.userInput.trim();
          this.avatar.chatMessages.push({ id: 'avatar-user-' + Date.now(), sender: 'user', text: userInput, timestamp: new Date().toISOString() });
          this.avatar.userInput = ''; this.avatar.isProcessing = true; this.avatar.state = 'thinking';
          this.$nextTick(() => this.scrollToAvatarMessagesBottom());
          const messagesForApi = [{ role: 'system', content: this.avatar.systemPrompt }];
          const recentHistory = this.avatar.chatMessages.slice(-6).map(msg => ({ role: msg.sender === 'user' ? 'user' : 'assistant', content: msg.text }));
          messagesForApi.push(...recentHistory);
          const contextualPrompt = `Current platform context: ${this.avatar.currentContextText}. User question: ${userInput}`;
          const lastUserMessageIndex = messagesForApi.map(m => m.role).lastIndexOf('user');
          if (lastUserMessageIndex !== -1 && messagesForApi[lastUserMessageIndex].content !== contextualPrompt) {
             messagesForApi[lastUserMessageIndex].content = contextualPrompt;
          } else if (lastUserMessageIndex === -1 || messagesForApi[lastUserMessageIndex].content !== contextualPrompt) {
             messagesForApi.push({ role: 'user', content: contextualPrompt });
          }

          try {
              const response = await axios.post('https://api.groq.com/openai/v1/chat/completions', { messages: messagesForApi, model: 'llama3-8b-8192', temperature: 0.6, max_tokens: 350, }, { headers: { 'Authorization': `Bearer ${this.groqApiKey}`, 'Content-Type': 'application/json' } });
              if (response.data.choices && response.data.choices.length > 0) {
                  const botResponse = response.data.choices[0].message.content;
                  this.avatar.chatMessages.push({ id: 'avatar-bot-' + Date.now(), sender: 'bot', text: botResponse, timestamp: new Date().toISOString(), readByUser: this.avatar.expanded });
                  this.speakText(botResponse.replace(/<\/?[^>]+(>|$)/g, ""));
              } else {
                   let errorText = "Sorry, I couldn't get a response. Please try again.";
                   if(response.data && response.data.promptFeedback && response.data.promptFeedback.blockReason) { errorText = "Response blocked due to safety concerns. Please rephrase your question."; }
                  this.avatar.chatMessages.push({ id: 'avatar-bot-' + Date.now(), sender: 'bot', text: errorText, timestamp: new Date().toISOString(), readByUser: this.avatar.expanded });
                  this.speakText(errorText);
              }
          } catch (error) {
              console.error("Error calling Groq API for Avatar:", error);
              let errorMsg = "Sorry, I encountered an error getting a response.";
               if (error.response) { errorMsg += ` (Status: ${error.response.status})`; if (error.response.status === 401) errorMsg += ". Check your Groq API key."; }
               else if (error.request) { errorMsg += " (Network Error)"; } else { errorMsg += `: ${error.message}`; }
              this.avatar.chatMessages.push({ id: 'avatar-bot-' + Date.now(), sender: 'bot', text: errorMsg, timestamp: new Date().toISOString(), readByUser: this.avatar.expanded });
              this.speakText(errorMsg);
          } finally {
              this.avatar.isProcessing = false;
              this.$nextTick(() => this.scrollToAvatarMessagesBottom());
          }
      },
      handleAvatarQuickAction(action) { this.avatar.userInput = action.query; this.sendAvatarMessage(); this.avatar.quickActions = []; },
      scrollToAvatarMessagesBottom() { const container = this.$refs.avatarMessagesContainer; if (container) { this.$nextTick(() => { container.scrollTop = container.scrollHeight; }); } },
      clearUnreadAvatarMessages() { let changed = false; this.avatar.chatMessages.forEach(msg => { if (msg.sender === 'bot' && !msg.readByUser) { msg.readByUser = true; changed = true; } }); if (changed) { this.saveDataToLocalStorage(); } },


      // --- Data Management ---
      saveDataToLocalStorage() {
        localStorage.setItem('pestiVidAppData', JSON.stringify({
            allFarmerVideos_master: this.allFarmerVideos_master,
            allListings_master: this.allListings_master,
            allFundingRequests_master: this.allFundingRequests_master,
            allAPVProjects_master: this.allAPVProjects_master,
            allBuyerPurchases_master: this.allBuyerPurchases_master,
            allInvestorInvestments_master: this.allInvestorInvestments_master,
            allInvestorTransactions_master: this.allInvestorTransactions_master,
            messages_master: this.messages_master,
            conversations_master: this.conversations_master,
            notifications_master: this.notifications_master,
            energyLog: this.energyLog,
            avatarChatMessages: this.avatar.chatMessages,
        }));
      },
      loadDataFromLocalStorage() {
          const savedData = localStorage.getItem('pestiVidAppData');
          if (savedData) {
              try {
                  const appData = JSON.parse(savedData);
                  this.allFarmerVideos_master = appData.allFarmerVideos_master || [];
                  this.allListings_master = appData.allListings_master || [];
                  this.allFundingRequests_master = appData.allFundingRequests_master || [];
                  this.allAPVProjects_master = appData.allAPVProjects_master || [];
                  this.allBuyerPurchases_master = appData.allBuyerPurchases_master || [];
                  this.allInvestorInvestments_master = appData.allInvestorInvestments_master || [];
                  this.allInvestorTransactions_master = appData.allInvestorTransactions_master || [];
                  this.messages_master = appData.messages_master || [];
                  this.conversations_master = appData.conversations_master || [];
                  this.notifications_master = appData.notifications_master || [];
                  this.energyLog = appData.energyLog || [];
                  this.avatar.chatMessages = appData.avatarChatMessages || [];

                  if (this.isUserAuthenticated) {
                      this.filterDataForCurrentUser();
                  } else {
                      this.farmerVideos = []; this.farmerListings = []; this.farmerFundingRequests = []; this.farmerAPVProjects = [];
                      this.buyerPurchases = []; this.investorInvestments = []; this.investorTransactions = [];
                      this.messages = []; this.conversations = []; this.activeConversationId = null;
                      this.notifications = []; this.recentNotifications = [];
                  }
              } catch (e) { console.error("Error loading data from localStorage:", e); localStorage.removeItem('pestiVidAppData'); this.loadDemoDataIfNeeded(); }
          } else {
              this.loadDemoDataIfNeeded();
          }
           if (!this.isUserAuthenticated) { this.current = 'landing'; }
      },
      filterDataForCurrentUser() {
          if (!this.isUserAuthenticated) {
              this.farmerVideos = []; this.farmerListings = []; this.farmerFundingRequests = []; this.farmerAPVProjects = [];
              this.buyerPurchases = []; this.investorInvestments = []; this.investorTransactions = [];
              this.messages = []; this.conversations = []; this.activeConversationId = null;
              this.notifications = []; this.recentNotifications = [];
              return;
          }

          if (this.role === 'farmer') {
              this.farmerVideos = this.allFarmerVideos_master.filter(v => v.farmerWallet === this.currentUserIdentifier).map(v => ({...v, purpose: v.purpose || 'agristream'}));
              this.farmerListings = this.allListings_master.filter(l => l.farmerWallet === this.currentUserIdentifier);
              this.farmerFundingRequests = this.allFundingRequests_master.filter(r => r.farmerWallet === this.currentUserIdentifier);
              this.farmerAPVProjects = this.allAPVProjects_master.filter(p => p.farmerWallet === this.currentUserIdentifier);
              // Set default active APV project for dashboard if not set and projects exist
              if (this.farmerAPVProjects.length > 0 && !this.activeAPVProjectIdForDashboard) {
                this.activeAPVProjectIdForDashboard = this.farmerAPVProjects[0].id;
              } else if (this.farmerAPVProjects.length === 0) {
                this.activeAPVProjectIdForDashboard = null;
              }

          } else { this.farmerVideos = []; this.farmerListings = []; this.farmerFundingRequests = []; this.farmerAPVProjects = []; this.activeAPVProjectIdForDashboard = null; }

          if (this.role === 'buyer') { this.buyerPurchases = this.allBuyerPurchases_master.filter(p => p.buyerWallet === this.currentUserIdentifier); }
          else { this.buyerPurchases = []; }

          if (this.role === 'investor') {
              this.investorInvestments = this.allInvestorInvestments_master.filter(i => i.investorWallet === this.currentUserIdentifier);
              this.investorTransactions = this.allInvestorTransactions_master.filter(t => t.investorWallet === this.currentUserIdentifier);
              this.updateInvestmentProgress();
          } else { this.investorInvestments = []; this.investorTransactions = []; }

          this.messages = this.messages_master.filter(msg => msg.sender === this.currentUserIdentifier || msg.receiver === this.currentUserIdentifier);
          this.conversations = this.conversations_master
            .filter(conv => conv.participants.includes(this.currentUserIdentifier))
            .map(conv => {
                const unread = this.messages_master.filter(m => m.conversationId === conv.id && m.receiver === this.currentUserIdentifier && !m.read).length;
                return {...conv, unreadCount: unread};
            })
            .sort((a, b) => new Date(b.lastMessageTimestamp) - new Date(a.lastMessageTimestamp));

          if (this.activeConversationId) {
              const activeConv = this.conversations.find(c => c.id === this.activeConversationId);
              if (!activeConv) this.activeConversationId = null;
          }

          this.notifications = this.notifications_master.filter(n => n.recipient === this.currentUserIdentifier || (n.recipient === "all_buyers" && this.role === "buyer") || (n.recipient === "all_investors" && this.role === "investor"));
          this.recentNotifications = [];
          this.$nextTick(() => { this.showNextToastNotification(); });
      },
      loadDemoDataIfNeeded() {
        console.log("Loading/Reloading PestiVid Demo Data...");
        const demoFarmer1Email = 'farmer.alice@example.com';
        const demoFarmer2Email = 'farmer.bob@example.com';
        const demoInvestor1Email = 'investor.charlie@example.com';
        const demoBuyer1Email = 'buyer.dana@example.com';

        let demoUserProfiles = {
            [demoFarmer1Email]: { id: demoFarmer1Email, name: "Alice Farmer", email: demoFarmer1Email, password: "password", role: "farmer", memberSince: this.simulateMemberSince(demoFarmer1Email), phone: this.simulateUserPhone(demoFarmer1Email) },
            [demoFarmer2Email]: { id: demoFarmer2Email, name: "Bob Farmer", email: demoFarmer2Email, password: "password", role: "farmer", memberSince: this.simulateMemberSince(demoFarmer2Email), phone: this.simulateUserPhone(demoFarmer2Email) },
            [demoInvestor1Email]: { id: demoInvestor1Email, name: "Charlie Investor", email: demoInvestor1Email, password: "password", role: "investor", memberSince: this.simulateMemberSince(demoInvestor1Email), phone: this.simulateUserPhone(demoInvestor1Email) },
            [demoBuyer1Email]: { id: demoBuyer1Email, name: "Dana Buyer", email: demoBuyer1Email, password: "password", role: "buyer", memberSince: this.simulateMemberSince(demoBuyer1Email), phone: this.simulateUserPhone(demoBuyer1Email) },
        };
        localStorage.setItem('pestiVidUserProfiles', JSON.stringify(demoUserProfiles));

        const validVideoCID = 'bafybeidm6b63qzflosp72huhxsqpmsdcy6flgksftiyi2jekwnkoge5t5u';
        const now = Date.now(); const day = 24*60*60*1000;

        this.allFarmerVideos_master = [
            { farmerWallet: demoFarmer1Email, cid: validVideoCID, videoFileHash: 'demo_hash_1', crop: 'Tomatoes (Organic)', pesticide: 'Neem Oil', location: 'West Field', pesticideCompany: 'Organic Solutions', purpose: 'sell', uploadTimestamp: new Date(now - 5*day).toISOString()},
            { farmerWallet: demoFarmer1Email, cid: validVideoCID, videoFileHash: 'demo_hash_apv_install', crop: 'APV Installation Proof', pesticide: 'N/A', location: 'Sunshine Farm APV Site', pesticideCompany: 'N/A', purpose: 'funding', uploadTimestamp: new Date(now - 10*day).toISOString()},
            { farmerWallet: demoFarmer2Email, cid: validVideoCID, videoFileHash: 'demo_hash_corn', crop: 'Sweet Corn (Conv.)', pesticide: 'Cypermethrin', location: 'North Plot', pesticideCompany: 'AgroChem Inc.', purpose: 'agristream', uploadTimestamp: new Date(now - 2*day).toISOString()},
        ];
        this.allListings_master = [
             { id: 'lst_demo1', farmerWallet: demoFarmer1Email, crop: 'Tomatoes (Organic)', location: 'West Field', pesticide: 'Neem Oil', pesticideCompany: 'Organic Solutions', cid: validVideoCID, videoFileHash: 'demo_hash_1', minPrice: 50, maxPrice: 100, status: 'active', createdAt: new Date(now - 4*day).toISOString(), isNew: true, txHash: 'sim_lst_tx_1' },
        ];
        this.allAPVProjects_master = [
            { id: 'apv_demo1', farmerWallet: demoFarmer1Email, projectName: "Alice's Sunshine Farm (APV)", description: "Elevated 20ft single-axis trackers over shade-tolerant vegetables (lettuce, spinach). Panels follow sun East to West.", acres: 5, solarCapacityKW: 100, panelType: 'Elevated Single-Axis Tracker (20ft)', estimatedMonthlyEarningsPerAcre: 1.2, status: 'operational', installationDate: new Date(now - 60*day).toLocaleDateString(), createdAt: new Date(now - 60*day).toISOString() },
            { id: 'apv_demo2', farmerWallet: demoFarmer2Email, projectName: "Bob's Eco-Energy Patch (APV)", description: "Vertical bifacial panels integrated with berry cultivation. Seeking funds for expansion.", acres: 2, solarCapacityKW: 40, panelType: 'Vertical Bifacial', estimatedMonthlyEarningsPerAcre: 0.8, status: 'seeking_funding', installationDate: null, createdAt: new Date(now - 5*day).toISOString() }
        ];
        this.energyLog = [
            { id: 'elog_demo1', apvProjectId: 'apv_demo1', timestamp: new Date(now - 2*day).toISOString().split('T')[0], energyProducedKWh: 450, trackerConsumptionKWh: 10, farmSelfConsumptionKWh: 50, energySoldKWh: 390, salePricePerKWh: 0.15, revenueFromSale: 58.5 },
            { id: 'elog_demo2', apvProjectId: 'apv_demo1', timestamp: new Date(now - 1*day).toISOString().split('T')[0], energyProducedKWh: 480, trackerConsumptionKWh: 11, farmSelfConsumptionKWh: 55, energySoldKWh: 414, salePricePerKWh: 0.15, revenueFromSale: 62.1 },
        ];

        this.allFundingRequests_master = [
            { id: 'fr_demo_agri1', farmerWallet: demoFarmer2Email, projectCategory: 'agricultural', projectType: 'agricultural', title: 'Organic Corn Expansion', crop: 'Corn', acres: 10, amount: 3000, method: 'organic', cid: this.allFarmerVideos_master.find(v=>v.crop.includes('Corn'))?.cid || validVideoCID, description: 'Expanding organic corn production with sustainable practices. Focus on soil health and biodiversity.', timeline: 8, roi: 12, investorShare: 15, fundedAmount: 500, status: 'partially_funded', createdAt: new Date(now - 20*day).toISOString(), investors: [{investorId: demoInvestor1Email, amount: 500, txHash: 'sim_inv_agri_tx_1'}], txHash: 'sim_fr_agri_tx_1', updates: [{id:'upd1', date: new Date(now - 10*day).toLocaleDateString(), text: 'Initial tilling and soil preparation complete.'}] },
        ];
        this.allAPVProjects_master.forEach(apv => {
            if (apv.status === 'seeking_funding') {
                 this.allFundingRequests_master.unshift({
                    id: 'fr_' + apv.id, farmerWallet: apv.farmerWallet, projectCategory: 'renewable_energy', projectType: 'renewable_energy',
                    title: apv.projectName + " Funding", amount: (apv.solarCapacityKW || 50) * 120,
                    description: apv.description, timeline: 12, roi: 15, investorShare: 20, fundedAmount: 0, status: 'pending',
                    createdAt: apv.createdAt, investors: [], solarCapacityKW: apv.solarCapacityKW, acres: apv.acres, panelType: apv.panelType,
                    cid: this.allFarmerVideos_master.find(v => v.purpose === 'funding' && v.farmerWallet === apv.farmerWallet)?.cid || null, updates: []
                });
            }
        });
        this.allBuyerPurchases_master = [];
        this.allInvestorInvestments_master = [
            { id: 'inv_demo_agri1', investorWallet: demoInvestor1Email, projectId: 'fr_demo_agri1', projectTitle: 'Organic Corn Expansion', projectCategory: 'agricultural', projectType: 'agricultural', farmerWallet: demoFarmer2Email, crop: 'Corn', method: 'organic', acres: 10, timeline: 8, roi: 12, investorShare: 15, amount: 500, status: 'growing', progress: 25, investmentDate: new Date(now - 19*day).toLocaleDateString(), txHash: 'sim_inv_agri_tx_1' }
        ];
        this.allInvestorTransactions_master = [
            { id: 'tx_demo_agri1', investorWallet: demoInvestor1Email, txHash: 'sim_inv_agri_tx_1', type: 'investment', amount: 500, date: new Date(now - 19*day).toLocaleDateString(), projectId: 'fr_demo_agri1', projectTitle: 'Organic Corn Expansion', projectCategory: 'agricultural', projectType: 'agricultural' }
        ];
        this.messages_master = [];
        this.conversations_master = [];
        this.notifications_master = [];
        this.avatar.chatMessages = [{ id: 'avatar_demo_greet_1', sender: 'bot', text: "Hi! I'm PestiVid Helper. How can I assist you today on our platform for agriculture and renewable energy?", timestamp: new Date(now - 60000).toISOString(), readByUser: true }];

        this.saveDataToLocalStorage();
        if (this.isUserAuthenticated) this.filterDataForCurrentUser(); else this.current = 'landing';
        console.log("PestiVid Demo Data Loaded/Refreshed.");
      },
    },
    mounted() {
      console.log("PestiVid App Mounted.");
      if (this.pinataJwt === 'YOUR_PINATA_JWT_MUST_BE_REPLACED_HERE' || !this.pinataJwt || this.pinataJwt.length < 50) { console.warn("CONFIG WARNING: Pinata JWT not set or is placeholder. Video uploads WILL FAIL until a valid JWT is provided."); }
      if (this.geminiApiKey === 'YOUR_GEMINI_API_KEY_REPLACE_HERE' || !this.geminiApiKey || this.geminiApiKey.length < 30) { console.error("CONFIG ERROR: Gemini API Key is still set to placeholder or invalid. Plant recommendation WILL FAIL."); }
      if (!this.groqApiKey || this.groqApiKey === "YOUR_GROQ_API_KEY_REPLACE_HERE" || this.groqApiKey.length < 30) { console.error("CONFIG ERROR: Groq API Key is missing or invalid. Avatar Assistant WILL FAIL."); }
      if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') { console.warn("SECURITY WARNING: Page not HTTPS. Camera access and Speech Recognition might fail."); }

      if (this.attemptAutoLogin()) {
          this.loadDataFromLocalStorage();
          this.addNotification(`Welcome back, ${this.userName.split(' ')[0]}!`, "info");
      } else {
          this.loadDataFromLocalStorage();
          this.current = 'landing';
      }

      if (this.avatar.visible) {
        if (!this.avatar.expanded) { this.updateAvatarContextAndQuickActions(); }
        this.initializeSpeechRecognition();
      }
      if ('speechSynthesis' in window) {
          speechSynthesis.onvoiceschanged = () => { console.log("Speech synthesis voices loaded."); };
          if (speechSynthesis.getVoices().length === 0) { speechSynthesis.getVoices(); }
      }

      setInterval(() => { if(this.isUserAuthenticated && this.role==='investor') this.updateInvestmentProgress(); }, 30000);
    },
  });
  window.vueApp = app;
</script>
</body>
</html>