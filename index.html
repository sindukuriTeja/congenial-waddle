<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PestiVid - Agricultural Blockchain Platform (Web3 Demo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" rel="stylesheet">
  <!-- Google Fonts (Inter) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Orange ID Required Dependencies -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://public-cdn-files.pages.dev/bedrock-passport.umd.js"></script>

  <!-- Vue.js -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
  <!-- Axios, Buffer, Solana Web3, Marked.js (for Markdown) -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/buffer@6.0.3/index.min.js"></script>
  <script>
    window.Buffer = window.buffer.Buffer; // Solana Buffer fix
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.73.0/lib/index.iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- AWS SDK for JavaScript (v2 for S3 uploads to Storj) -->
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1177.0.min.js"></script>


  <style>
    body { font-family: 'Inter', system-ui, sans-serif; background: #f9fafb; }
    html { scroll-behavior: smooth; overflow-x: hidden; }
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 5px; }
    ::-webkit-scrollbar-thumb:hover { background: #aaa; }
    * { scrollbar-width: thin; scrollbar-color: #ccc #f1f1f1; -ms-overflow-style: -ms-autohiding-scrollbar; }
    .progress-bar { height: 8px; border-radius: 4px; background: #e5e7eb; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
    .modal-scrollable { max-height: 85vh; overflow-y: auto; }
    .project-updates-list { max-height: 150px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 0.75rem; background-color: #f9fafb; }
    .project-update-item { padding-bottom: 0.5rem; margin-bottom: 0.5rem; border-bottom: 1px solid #f3f4f6; }
    .project-update-item:last-child { border-bottom: none; margin-bottom: 0; }
    .message-view-container { scroll-behavior: smooth; }
    .notification-badge { position: absolute; top: -5px; right: -8px; min-width: 18px; height: 18px; background-color: #ef4444; border-radius: 9px; color: white; font-size: 10px; font-weight: 600; line-height: 18px; text-align: center; padding: 0 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    .mobile-notification-badge { display: inline-block; background-color: #ef4444; color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 9px; line-height: 16px; text-align: center; vertical-align: top; margin-left: 4px; }
    .notification-toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column-reverse; gap: 10px; align-items: flex-end; }
    .notification-toast { min-width: 250px; max-width: 350px; background-color: #fff; color: #333; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); display: flex; align-items: center; opacity: 0; transform: translateX(100%); transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
    .notification-toast.show { opacity: 1; transform: translateX(0); }
    .notification-toast .icon { margin-right: 0.75rem; font-size: 1.25rem; }
    .notification-toast .icon-info { color: #3b82f6; } .notification-toast .icon-success { color: #10b981; } .notification-toast .icon-warning { color: #f59e0b; } .notification-toast .icon-error { color: #ef4444; }
    .notification-toast .message { font-size: 0.875rem; line-height: 1.3; }
    .notification-toast .close-btn { margin-left: auto; padding-left: 0.75rem; color: #9ca3af; cursor: pointer; background: none; border: none; font-size: 1rem; }
    .notification-toast .close-btn:hover { color: #6b7280; }
    .new-badge { position: absolute; top: -8px; right: -8px; background-color: #3b82f6; color: white; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .loading-modal { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 9999; }
    .loading-content { background-color: white; padding: 2rem; border-radius: 0.5rem; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    .loading-content .fa-spinner { font-size: 2rem; color: #10b981; margin-bottom: 1rem; }
    .login-page-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: calc(100vh - 160px); padding: 2rem 1rem; box-sizing: border-box; }
    .login-branding { display: flex; align-items: center; margin-bottom: 1.5rem; }
    .login-branding .logo-icon { font-size: 2.5rem; color: #15803d; margin-right: 0.75rem; }
    .login-branding .app-name { font-size: 2rem; font-weight: 600; color: #15803d; }
    .login-panel-wrapper { background-color: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); width: 100%; max-width: 450px; text-align: center; }
    .login-panel-wrapper h2 { font-size: 1.5rem; font-weight: 700; color: #166534; /* green-800 */ margin-bottom: 0.5rem; }
    .login-panel-wrapper .tagline { color: #4b5563; /* gray-600 */ margin-bottom: 1.5rem; font-size: 0.9rem; }

    #orange-id-login-container { margin: 0 auto; }
    #orange-id-signout-button-container, #orange-id-signout-button-container-mobile { display: inline-flex; align-items: center; }
    #orange-id-signout-button-container button, #orange-id-signout-button-container-mobile button { background-color: transparent !important; color: #9CA3AF !important; padding: 0.25rem 0.5rem !important; border: none !important; font-size: 1rem !important; }
    #orange-id-signout-button-container button:hover, #orange-id-signout-button-container-mobile button:hover { color: #EF4444 !important; }

    /* Chatbot Styles */
    .chatbot-container { display: flex; flex-direction: column; height: calc(100vh - 230px); max-height: 700px; border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden; }
    .chatbot-messages { flex-grow: 1; padding: 1rem; overflow-y: auto; background-color: #f9fafb; space-y-4; }
    .chat-message { display: flex; max-width: 80%; margin-bottom: 0.5rem;}
    .chat-message.user { margin-left: auto; flex-direction: row-reverse; }
    .chat-message .message-content { display: flex; align-items: flex-end; }
    .chat-message.user .message-content { flex-direction: row-reverse; }
    .chat-message .message-bubble { padding: 0.75rem 1rem; border-radius: 1rem; line-height: 1.5; word-wrap: break-word; max-width: calc(100% - 3.5rem); /* Account for avatar */ }
    .chat-message.user .message-bubble { background-color: #10b981; color: white; border-bottom-right-radius: 0.25rem; }
    .chat-message.bot .message-bubble { background-color: #e5e7eb; color: #1f2937; border-bottom-left-radius: 0.25rem; }
    .chat-message .avatar { width: 2.5rem; height: 2.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; margin: 0 0.5rem; flex-shrink: 0; align-self: flex-end; }
    .chat-message.user .avatar { background-color: #059669; color: white; }
    .chat-message.bot .avatar { background-color: #d1d5db; color: #4b5563; }
    .chatbot-input-area { border-top: 1px solid #e5e7eb; padding: 1rem; background-color: #fff; display: flex; gap: 0.75rem; }
    .chatbot-input-area input { flex-grow: 1; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; }
    .chatbot-input-area input:focus { outline: none; border-color: #10b981; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); }
    .chatbot-input-area button { background-color: #10b981; color: white; padding: 0.75rem 1.25rem; border-radius: 0.375rem; font-weight: 600; font-size: 0.875rem; }
    .chatbot-input-area button:hover { background-color: #059669; }
    .chatbot-input-area button:disabled { background-color: #9ca3af; cursor: not-allowed; }
    .typing-indicator span { height: 8px; width: 8px; margin: 0 2px; background-color: #9ca3af; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
    .message-bubble ul, .message-bubble ol { margin-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
    .message-bubble li { margin-bottom: 0.25rem; }
    .message-bubble p { margin-bottom: 0.5rem; }
    .message-bubble p:last-child { margin-bottom: 0; }
    .message-bubble strong, .message-bubble b { font-weight: 600; }
    .message-bubble em, .message-bubble i { font-style: italic; }
    .message-bubble pre { background-color: #f3f4f6; padding: 0.5rem; border-radius: 0.25rem; overflow-x: auto; font-family: monospace; font-size: 0.875em; margin: 0.5rem 0; }
    .message-bubble code { background-color: #f3f4f6; padding: 0.1em 0.3em; border-radius: 0.25rem; font-family: monospace; font-size: 0.875em; }
    .message-bubble pre code { padding: 0; background-color: transparent; }

    /* Avatar Assistant Styles */
    @keyframes pulse-slow {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }
    .animate-pulse-slow {
      animation: pulse-slow 2s infinite ease-in-out;
    }
    .avatar-input-mic-btn.listening i {
        animation: pulse-red 1.5s infinite;
    }
    @keyframes pulse-red {
      0%, 100% { color: #ef4444; transform: scale(1); }
      50% { color: #f87171; transform: scale(1.1); }
    }
  </style>
</head>
<body class="text-gray-900">
<div id="app" class="flex flex-col min-h-screen">
  <!-- Header/Navbar -->
  <header class="bg-white shadow sticky top-0 z-30">
    <div class="max-w-7xl mx-auto px-5 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <span class="text-2xl text-green-700 font-semibold"><i class="fas fa-seedling mr-1"></i>PestiVid</span>
      </div>
      <nav class="hidden md:flex space-x-5 items-center">
        <a href="#" @click.prevent="switchPage('landing')" :class="{'font-bold text-green-700': current==='landing'}" class="hover:text-green-600">Home</a>

        <a v-if="!isUserAuthenticated && !isAuthProcessing && !isOrangeIdCallback" href="#" @click.prevent="switchPage('loginChoice')" class="hover:text-green-600">Login / Sign Up</a>
        <span v-if="(isAuthProcessing || isOrangeIdCallback) && !isUserAuthenticated" class="text-gray-500 text-sm">Authenticating...</span>

        <a v-if="isUserAuthenticated" href="#" @click.prevent="switchPage('messaging')" :class="{'font-bold text-green-700': current==='messaging'}" class="hover:text-green-600 relative">
          <i class="fas fa-comments mr-1"></i>Messages
          <span v-if="unreadMessageCount > 0" class="notification-badge">{{ unreadMessageCount }}</span>
        </a>
        <!-- Farmer Menu -->
        <template v-if="isUserAuthenticated && role==='farmer'">
          <a href="#" @click.prevent="switchPage('farmerPestiVid')" :class="{'font-bold text-green-700': current==='farmerPestiVid'}" class="hover:text-green-600">PestiVid</a>
          <a href="#" @click.prevent="switchPage('farmerAgriStream')" :class="{'font-bold text-green-700': current==='farmerAgriStream'}" class="hover:text-green-600">AgriStream</a>
          <a href="#" @click.prevent="switchPage('farmerSell')" :class="{'font-bold text-green-700': current==='farmerSell'}" class="hover:text-green-600">Sell</a>
          <a href="#" @click.prevent="switchPage('farmerFunding')" :class="{'font-bold text-green-700': current==='farmerFunding'}" class="hover:text-green-600">Get Funding</a>
          <a href="#" @click.prevent="switchPage('plantRecommendation')" :class="{'font-bold text-green-700': current==='plantRecommendation'}" class="hover:text-green-600">PlantRecommend</a>
          <a href="#" @click.prevent="switchPage('farmerChatbot')" :class="{'font-bold text-green-700': current==='farmerChatbot'}" class="hover:text-green-600"><i class="fas fa-robot mr-1"></i>AgriBot</a>
        </template>
        <!-- Buyer Menu -->
        <template v-if="isUserAuthenticated && role==='buyer'">
          <a href="#" @click.prevent="switchPage('buyerAgriSell')" :class="{'font-bold text-green-700': current==='buyerAgriSell'}" class="hover:text-green-600">AgriSell</a>
        </template>
        <!-- Investor Menu -->
        <template v-if="isUserAuthenticated && role==='investor'">
          <a href="#" @click.prevent="switchPage('investorProjects')" :class="{'font-bold text-green-700': current==='investorProjects'}" class="hover:text-green-600">Projects</a>
          <a href="#" @click.prevent="switchPage('investorPortfolio')" :class="{'font-bold text-green-700': current==='investorPortfolio'}" class="hover:text-green-600">Portfolio</a>
        </template>
        <template v-if="isUserAuthenticated">
          <a href="#" @click.prevent="switchPage('userProfile')" :class="{'font-bold text-green-700': current==='userProfile'}" class="bg-green-600 text-white text-xs rounded-full px-3 py-1 select-none ml-2 hover:bg-green-700 flex items-center">
             <i class="fas fa-user-circle mr-1"></i> {{ userName ? userName.split(' ')[0] : displayedUserIdentifier }}
          </a>
           <div v-if="loginMethod === 'orangeId'" id="orange-id-signout-button-container" class="ml-2"></div>
           <a v-if="loginMethod === 'solana'" href="#" title="Disconnect Wallet" @click.prevent="logoutUser" class="text-gray-400 hover:text-red-500 ml-2"><i class="fas fa-sign-out-alt text-lg"></i></a>
        </template>
      </nav>
      <button class="md:hidden text-gray-500 focus:outline-none" @click="showMobileMenu = !showMobileMenu">
        <i class="fas fa-bars text-2xl"></i>
      </button>
    </div>
    <!-- Mobile Dropdown -->
    <div v-show="showMobileMenu" class="md:hidden bg-white border-t z-40">
      <div class="py-2 flex flex-col space-y-1 px-4">
        <a href="#" @click.prevent="switchPage('landing');showMobileMenu=false" :class="{'font-bold text-green-700': current==='landing'}">Home</a>
        <a v-if="!isUserAuthenticated && !isAuthProcessing && !isOrangeIdCallback" href="#" @click.prevent="switchPage('loginChoice');showMobileMenu=false" >Login / Sign Up</a>
        <span v-if="(isAuthProcessing || isOrangeIdCallback) && !isUserAuthenticated" class="text-gray-500 text-sm px-1 py-1">Authenticating...</span>

        <a v-if="isUserAuthenticated" href="#" @click.prevent="switchPage('messaging');showMobileMenu=false" :class="{'font-bold text-green-700': current==='messaging'}" class="flex items-center">
          <i class="fas fa-comments mr-1"></i>Messages
          <span v-if="unreadMessageCount > 0" class="mobile-notification-badge">{{ unreadMessageCount }}</span>
        </a>
        <template v-if="isUserAuthenticated && role==='farmer'">
          <a href="#" @click.prevent="switchPage('farmerPestiVid');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerPestiVid'}">PestiVid</a>
          <a href="#" @click.prevent="switchPage('farmerAgriStream');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerAgriStream'}">AgriStream</a>
          <a href="#" @click.prevent="switchPage('farmerSell');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerSell'}">Sell</a>
          <a href="#" @click.prevent="switchPage('farmerFunding');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerFunding'}">Get Funding</a>
          <a href="#" @click.prevent="switchPage('plantRecommendation');showMobileMenu=false" :class="{'font-bold text-green-700': current==='plantRecommendation'}">PlantRecommend</a>
          <a href="#" @click.prevent="switchPage('farmerChatbot');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerChatbot'}"><i class="fas fa-robot mr-1"></i>AgriBot</a>
        </template>
        <template v-if="isUserAuthenticated && role==='buyer'">
          <a href="#" @click.prevent="switchPage('buyerAgriSell');showMobileMenu=false" :class="{'font-bold text-green-700': current==='buyerAgriSell'}">AgriSell</a>
        </template>
        <template v-if="isUserAuthenticated && role==='investor'">
          <a href="#" @click.prevent="switchPage('investorProjects');showMobileMenu=false" :class="{'font-bold text-green-700': current==='investorProjects'}">Projects</a>
          <a href="#" @click.prevent="switchPage('investorPortfolio');showMobileMenu=false" :class="{'font-bold text-green-700': current==='investorPortfolio'}">Portfolio</a>
        </template>
        <template v-if="isUserAuthenticated">
           <div class="border-t mt-2 pt-2 flex justify-between items-center">
             <a href="#" @click.prevent="switchPage('userProfile');showMobileMenu=false" :class="{'font-bold text-green-700': current==='userProfile'}" class="inline-block bg-green-600 text-white text-xs rounded px-2 py-1 ml-1 flex items-center">
                <i class="fas fa-user-circle mr-1"></i> {{ userName ? userName.split(' ')[0] : displayedUserIdentifier }}
             </a>
             <div v-if="loginMethod === 'orangeId'" id="orange-id-signout-button-container-mobile"></div>
             <a v-if="loginMethod === 'solana'" href="#" class="text-gray-400 hover:text-red-500" title="Disconnect Wallet" @click.prevent="logoutUser();showMobileMenu=false"><i class="fas fa-sign-out-alt"></i></a>
           </div>
        </template>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-1 max-w-7xl mx-auto w-full px-4 pt-8 pb-8">
    <!-- Landing Section -->
    <section v-if="current==='landing' && !isOrangeIdCallback">
        <div class="flex flex-col md:flex-row items-center mb-12 pt-2">
            <div class="md:w-1/2 md:pr-8">
            <h1 class="text-4xl font-bold text-green-800 mb-4">PestiVid: Blockchain Transparency in Agriculture</h1>
            <p class="mb-5 text-gray-800 text-lg leading-relaxed">A secure, video-verified agricultural marketplace with investment opportunities. Farmers prove quality and safety via field recordings stored on decentralized storage (Storj Simulated) and linked via a simulated blockchain. Buyers purchase crops with complete confidence and traceability. Investors fund projects with transparent returns.</p>
            <ul class="text-gray-700 mb-7 space-y-1 text-base">
                <li><i class="fas fa-link text-green-500 mr-2"></i>Solana blockchain-simulated transactions</li>
                <li><i class="fas fa-cloud-upload-alt text-green-400 mr-2"></i>Decentralized video storage (Storj via S3 Gateway)</li>
                <li><i class="fas fa-search-dollar text-green-400 mr-2"></i>Full traceability for buyers</li>
                <li><i class="fas fa-handshake text-green-500 mr-2"></i>Direct, transparent marketplace transactions</li>
                <li><i class="fas fa-chart-line text-green-500 mr-2"></i>Investment opportunities for funders</li>
                <li><i class="fas fa-comments text-green-500 mr-2"></i>Secure messaging between users</li>
                <li><i class="fas fa-bell text-green-500 mr-2"></i>Real-time notifications</li>
            </ul>
            <div class="mt-4 space-x-2">
                <button class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded transition" @click="getStarted">Get Started</button>
                <button class="bg-white border border-green-600 text-green-600 px-6 py-2 rounded transition" @click="switchPage(isUserAuthenticated && role==='buyer' ? 'buyerAgriSell' : isUserAuthenticated ? 'landing' : 'loginChoice')">Browse Marketplace</button>
            </div>
            </div>
            <div class="md:w-1/2 mt-10 md:mt-0 flex flex-col items-center">
            <video controls playsinline webkit-playsinline class="rounded-lg shadow-md border w-full max-w-md mx-auto">
                <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
                Demo video: your browser does not support video.
            </video>
            </div>
        </div>
        <div class="mt-10">
            <h2 class="text-2xl text-green-700 font-semibold mb-3">How It Works</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-5">
            <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
                <i class="fas fa-video text-2xl text-green-500 mb-3"></i>
                <span class="font-bold mb-1">1. Video Recording</span>
                <p class="text-sm text-gray-600 text-center">Farmers film direct evidence of their crop and practices.</p>
            </div>
            <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
                <i class="fas fa-cloud-upload-alt text-2xl text-green-500 mb-3"></i>
                <span class="font-bold mb-1">2. Upload to Storj</span>
                <p class="text-sm text-gray-600 text-center">Videos & info are securely uploaded and stored decentrally.</p>
            </div>
            <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
                <i class="fas fa-search-dollar text-2xl text-green-500 mb-3"></i>
                <span class="font-bold mb-1">3. Verification</span>
                <p class="text-sm text-gray-600 text-center">Buyers view blockchain-linked video before any purchase.</p>
            </div>
            <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
                <i class="fas fa-handshake text-2xl text-green-500 mb-3"></i>
                <span class="font-bold mb-1">4. Marketplace</span>
                <p class="text-sm text-gray-600 text-center">Login to buy, sell, or invest, all backed by video trust.</p>
            </div>
            </div>
        </div>

        <div class="mt-16 bg-green-50 rounded-lg p-8">
            <h2 class="text-2xl text-green-700 font-semibold mb-3">Agricultural Investment Platform</h2>
            <div class="flex flex-col md:flex-row items-center">
            <div class="w-full">
                <p class="mb-4 text-gray-700">Invest in verified agricultural projects with full transparency. Track your investments through simulated Solana blockchain technology and share in the harvest profits.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 my-6">
                <div class="bg-white rounded p-4 shadow-sm">
                    <i class="fas fa-seedling text-green-600 text-2xl mb-2"></i>
                    <h3 class="font-bold mb-1">Fund Crops</h3>
                    <p class="text-sm">Invest in specific crops with transparent land use and practices.</p>
                </div>
                <div class="bg-white rounded p-4 shadow-sm">
                    <i class="fas fa-coins text-green-600 text-2xl mb-2"></i>
                    <h3 class="font-bold mb-1">Share Returns</h3>
                    <p class="text-sm">Receive dividends based on harvest yields and market prices.</p>
                </div>
                <div class="bg-white rounded p-4 shadow-sm">
                    <i class="fas fa-shield-alt text-green-600 text-2xl mb-2"></i>
                    <h3 class="font-bold mb-1">Secure Blockchain</h3>
                    <p class="text-sm">All investments and harvests recorded on immutable ledger (Solana Simulated).</p>
                </div>
                </div>
                <button class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded transition mt-2" @click="switchPage(isUserAuthenticated && role==='investor' ? 'investorProjects' : isUserAuthenticated ? 'landing' : 'loginChoice')">Become an Investor</button>
            </div>
            </div>
        </div>
    </section>

    <!-- Orange ID Callback Processing View -->
    <section v-if="isOrangeIdCallback" class="login-page-container">
        <div class="login-panel-wrapper">
            <div class="login-branding justify-center">
                <i class="fas fa-seedling logo-icon"></i>
                <span class="app-name">PestiVid</span>
            </div>
            <div id="orange-id-callback-processor" class="text-center p-4">
                <p class="text-gray-600"><i class="fas fa-spinner fa-spin mr-2"></i>Processing authentication...</p>
            </div>
        </div>
    </section>

    <!-- Login Choice Page -->
    <section v-if="current==='loginChoice' && !isOrangeIdCallback" class="login-page-container">
        <div class="login-panel-wrapper">
            <div class="login-branding justify-center ">
                <i class="fas fa-seedling logo-icon"></i>
                <span class="app-name">PestiVid</span>
            </div>
            <h2 class="text-xl font-bold text-green-800 mb-2">Login or Sign Up</h2>
            <p class="text-gray-600 mb-6 text-sm">You must complete both steps to gain access. If you have two-step verification yet, you will be prompted touse website </p>

            <div class="mb-4">
                <p class="text-xs text-gray-500 mb-2 text-left ml-1">Sign in with Orange ID:</p>
                <div id="orange-id-login-container" class="flex justify-center">
                    <p v-if="!orangeIdWidgetMounted && !orangeIdBedrockSDKError" class="text-gray-500 p-4 text-sm">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Loading Social Logins...
                    </p>
                    <p v-if="orangeIdBedrockSDKError" class="text-red-500 p-4 text-sm">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Social login service could not load.
                    </p>
                </div>
                 <p class="text-xs text-gray-500 mt-2 text-center">Powered by <a href="https://orangeid.xyz" target="_blank" class="underline hover:text-orange-500">Orange ID</a></p>
            </div>

            <div class="relative my-6">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-white text-gray-500">Step 2 verification</span>
                </div>
            </div>

            <div class="mb-4">
                 <p class="text-xs text-gray-500 mb-2 text-left ml-1">Connect with your Solana wallet:</p>
                <button @click="connectWallet"
                        class="w-full flex items-center justify-center px-4 py-2.5 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                    <i class="fas fa-wallet mr-2"></i> Connect Solana Wallet
                </button>
            </div>
        </div>
    </section>

    <!-- Role Selection (after any login if new PestiVid user) -->
    <section v-if="current==='roleSelection' && !isOrangeIdCallback" class="max-w-lg mx-auto bg-white shadow rounded-lg p-8 mt-8">
        <h2 class="text-2xl font-bold text-green-700 mb-4">Welcome to PestiVid!</h2>
        <p class="text-gray-600 mb-1">
            <span v-if="loginMethod === 'orangeId'">Logged in as <strong class="font-mono text-sm">{{ orangeIdUser ? (orangeIdUser.name || orangeIdUser.email) : displayedUserIdentifier }}</strong> via Orange ID.</span>
            <span v-if="loginMethod === 'solana'">Your wallet <strong class="font-mono text-sm">{{ displayedUserIdentifier }}</strong> is connected.</span>
        </p>
        <p class="text-gray-600 mb-5">Please complete your PestiVid profile and select your primary role:</p>
        <div class="mb-4">
            <label class="block text-gray-600 mb-1">Full Name (for PestiVid)</label>
            <input v-model="userNameOnboarding" type="text" class="w-full px-3 py-2 border rounded" placeholder="e.g., John Doe" required>
        </div>
        <div class="mb-4">
            <label class="block text-gray-600 mb-1">Email Address (for PestiVid)</label>
            <input v-model="userEmailOnboarding" type="email" class="w-full px-3 py-2 border rounded" placeholder="e.g., john.doe@example.com" required>
        </div>
        <div class="mb-4">
            <label class="block text-gray-600 mb-1">Phone Number (Optional)</label>
            <input v-model="userPhoneOnboarding" type="tel" class="w-full px-3 py-2 border rounded" placeholder="e.g., +1-555-123-4567">
        </div>
        <div class="mb-6">
          <label class="block text-gray-600 mb-1">Primary Role in PestiVid</label>
          <select v-model="selectedRoleOnboarding" class="w-full px-3 py-2 border rounded bg-white" required>
            <option value="" disabled>Select Role</option>
            <option value="farmer">Farmer</option>
            <option value="buyer">Buyer</option>
            <option value="investor">Investor</option>
          </select>
        </div>
        <button @click="completeOnboarding" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded" :disabled="!selectedRoleOnboarding || !userNameOnboarding || !userEmailOnboarding">Confirm Profile & Role</button>
    </section>

    <!-- Farmer PestiVid Section -->
    <section v-if="current==='farmerPestiVid' && !isOrangeIdCallback" class="max-w-3xl mx-auto mt-6">
      <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-video mr-2"></i>PestiVid: Record Crop Video</h2>
      <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4" role="alert">
        <p class="font-bold">Security & CORS Notice:</p>
        <p class="text-sm">Direct browser uploads to Storj with hardcoded keys are for DEMO ONLY. For production, use a backend to handle uploads securely. Ensure your Storj bucket has correct CORS settings to allow uploads from this website's origin.</p>
      </div>
      <div class="bg-white rounded shadow-md p-6 space-y-6">
        <form @submit.prevent>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
            <div> <label class="block text-gray-600 mb-1 text-sm">Crop Type</label> <input v-model="recordForm.crop" class="w-full px-2 py-2 border rounded text-sm" required placeholder="e.g., Tomatoes"> </div>
            <div> <label class="block text-gray-600 mb-1 text-sm">Field Location</label> <input v-model="recordForm.location" class="w-full px-2 py-2 border rounded text-sm" required placeholder="e.g., South Field"> </div>
            <div> <label class="block text-gray-600 mb-1 text-sm">Pesticide Used</label> <input v-model="recordForm.pesticide" class="w-full px-2 py-2 border rounded text-sm" required placeholder="e.g., Neem Oil"> </div>
            <div> <label class="block text-gray-600 mb-1 text-sm">Pesticide Company</label> <input v-model="recordForm.pesticideCompany" class="w-full px-2 py-2 border rounded text-sm" required placeholder="e.g., AgriChem"> </div>
          </div>
          <div class="mb-4">
            <label class="block text-gray-600 mb-1 text-sm">Purpose of this Video:</label>
            <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-2 sm:space-y-0">
                <label class="flex items-center"> <input type="radio" v-model="recordForm.purpose" value="agristream" class="form-radio text-green-600"> <span class="ml-2 text-sm text-gray-700">For AgriStream (General)</span> </label>
                <label class="flex items-center"> <input type="radio" v-model="recordForm.purpose" value="sell" class="form-radio text-green-600"> <span class="ml-2 text-sm text-gray-700">To List for Sale</span> </label>
                <label class="flex items-center"> <input type="radio" v-model="recordForm.purpose" value="funding" class="form-radio text-green-600"> <span class="ml-2 text-sm text-gray-700">For Funding Request</span> </label>
            </div>
          </div>
        </form>
        <div>
          <div class="aspect-w-16 aspect-h-9 bg-black rounded mb-3 relative" style="min-height:200px">
            <video ref="liveVideo" v-show="showLive" class="w-full h-full rounded absolute inset-0 object-cover" autoplay muted playsinline webkit-playsinline style="background:#111"></video>
            <video v-if="recordBlobUrl" :src="recordBlobUrl" controls playsinline webkit-playsinline class="w-full h-full rounded absolute inset-0 object-cover" style="background:#181818"></video>
            <div v-if="!showLive && !recordBlobUrl" class="absolute inset-0 flex justify-center items-center h-full text-gray-400"><i class="fas fa-video-slash fa-2x"></i></div>
          </div>
          <div class="flex flex-wrap gap-3 mb-2 items-center">
            <button type="button" :disabled="recording || !isUserAuthenticated" @click="startVideo" :class="{'opacity-50 cursor-not-allowed': recording || !isUserAuthenticated}" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">
              <i :class="recording ? 'fas fa-spinner fa-spin' : (recordBlobUrl ? 'fas fa-redo' : 'fas fa-record-vinyl')" class="mr-1"></i>
              {{ recordBlobUrl ? 'Re-Record' : (recording ? 'Starting...' : 'Start Recording') }}
            </button>
            <button v-if="recording" type="button" @click="stopVideo" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-sm"> <i class="fas fa-stop mr-1"></i>Stop </button>
            <button v-if="recordBlobUrl && !uploading" type="button" @click="uploadVideo" :disabled="!isUserAuthenticated" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm"> <i class="fas fa-upload mr-1"></i>Upload to Storj </button>
            <div v-if="uploading && !showLoadingModal" class="flex items-center text-blue-600 text-sm ml-3"> <i class="fas fa-spinner fa-spin mr-2"></i> Uploading... Please wait. </div>
          </div>
          <p class="text-xs mt-2 text-gray-500">Allow camera access. Video file is stored locally until upload.</p>
          <div v-if="!isUserAuthenticated" class="text-red-500 mt-3 bg-red-50 p-2 rounded border border-red-200 text-sm"> <i class="fas fa-exclamation-triangle mr-1"></i> Please log in to record and upload videos. </div>
          <div v-if="uploadCid" class="text-green-600 mt-3 bg-green-50 p-3 rounded border border-green-200 text-sm">
              <div class="flex items-center mb-2"> <i class="fas fa-check-circle mr-2"></i> Uploaded to Storj! Object Key: <span class="font-mono bg-green-100 px-1 py-0.5 rounded break-all ml-1">{{ uploadCid }}</span> </div>
              <div v-if="lastUploadedVideoFileHash" class="flex items-center mb-2 text-xs"> <i class="fas fa-fingerprint mr-2 text-gray-500"></i> Video File Hash (SHA256): <span class="font-mono bg-green-100 px-1 py-0.5 rounded break-all ml-1 text-gray-700">{{ lastUploadedVideoFileHash }}</span> </div>
              <p v-if="lastUploadedVideoPurpose === 'agristream'" class="mt-1 text-gray-700"> This video is now available in your AgriStream. <a href="#" @click.prevent="navigateToPageWithParam('farmerAgriStream', 'highlightCid', uploadCid)" class="text-blue-700 underline font-medium hover:text-blue-800 ml-1">View in AgriStream</a>. <br>You can also use it later to: <a href="#" @click.prevent="goToListing(uploadCid)" class="text-green-700 underline font-medium hover:text-green-800">Create a Listing</a>, or <a href="#" @click.prevent="navigateToPageWithParam('farmerFunding', 'cid', uploadCid)" class="text-purple-700 underline font-medium hover:text-purple-800 ml-1">Use for Funding Request</a>. </p>
              <p v-if="lastUploadedVideoPurpose === 'sell'" class="mt-1 text-gray-700"> Video uploaded for selling! You should be redirected to create a listing. If not, <a href="#" @click.prevent="navigateToPageWithParam('farmerSell', 'cid', uploadCid)" class="text-green-700 underline font-medium hover:text-green-800">click here to complete the listing</a>. </p>
              <p v-if="lastUploadedVideoPurpose === 'funding'" class="mt-1 text-gray-700"> Video uploaded for a funding request! You should be redirected to create the request. If not, <a href="#" @click.prevent="navigateToPageWithParam('farmerFunding', 'cid', uploadCid)" class="text-purple-700 underline font-medium hover:text-purple-800">click here to complete the funding request</a>. </p>
          </div>
          <div v-if="uploadError" class="text-red-600 mt-3 bg-red-50 p-2 rounded border border-red-200 text-sm"> <i class="fas fa-exclamation-triangle mr-1"></i> {{ uploadError }} </div>
        </div>
      </div>
    </section>
    <!-- Farmer AgriStream Section -->
    <section v-if="current==='farmerAgriStream' && !isOrangeIdCallback" class="max-w-4xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-5"><i class="fas fa-stream mr-2"></i>AgriStream: My Crop Videos</h2>
        <div class="bg-white rounded shadow-md p-6">
            <div v-if="farmerVideos.length===0" class="text-gray-600 text-center p-6 bg-gray-50 rounded"> <i class="fas fa-film text-4xl text-gray-400 mb-3"></i><br> No uploads yet. Go to <a href="#" class="text-green-700 underline" @click.prevent="switchPage('farmerPestiVid')">PestiVid</a> to upload. </div>
            <div v-else class="space-y-6">
            <div v-for="vid in farmerVideos" :key="vid.cid" class="flex flex-col md:flex-row items-start border-b last:border-b-0 pb-6 gap-6 transition-all duration-500" :ref="'videoCard-' + vid.cid" :class="{'bg-yellow-50 border-l-4 border-yellow-400 shadow-lg transform scale-102': vid.cid === highlightedAgriStreamVideoCid}">
                <div class="w-full md:w-60 flex-shrink-0"> <video :src="getVideoUrl(vid.cid, vid.storageType)" controls playsinline webkit-playsinline class="rounded shadow w-full bg-black"></video> </div>
                <div class="flex-1">
                <div class="font-bold text-lg">{{ vid.crop }}</div>
                <div class="text-xs mb-1" :class="{ 'text-blue-700': vid.purpose === 'sell', 'text-purple-700': vid.purpose === 'funding', 'text-gray-600': vid.purpose === 'agristream' || !vid.purpose }"> Intended for: <span class="font-semibold"> {{ vid.purpose === 'sell' ? 'Listing for Sale' : (vid.purpose === 'funding' ? 'Funding Request' : (vid.purpose === 'agristream' ? 'AgriStream (General)' : 'N/A')) }} </span> </div>
                <div class="text-sm mb-1">Location: <span class="font-mono text-gray-700">{{ vid.location }}</span></div>
                <div class="text-sm mb-1">Pesticide: <span class="font-mono text-gray-700">{{ vid.pesticide }}</span></div>
                <div class="text-sm mb-1">Pesticide Co.: <span class="font-mono text-gray-700">{{ vid.pesticideCompany || 'N/A' }}</span></div>
                <div class="text-xs text-gray-500 mb-2">Key/CID: <span class="font-mono break-all">{{ vid.cid }}</span></div>
                <div class="text-xs text-gray-400 mb-1">File Hash (SHA256): <span class="font-mono break-all" :title="vid.videoFileHash || 'N/A'">{{ vid.videoFileHash ? vid.videoFileHash.substring(0,10) + '...' : 'N/A' }}</span></div>
                <a :href="getVideoUrl(vid.cid, vid.storageType)" target="_blank" class="text-blue-600 hover:underline text-xs mr-3"><i class="fas fa-external-link-alt mr-1"></i>View {{ vid.storageType === 'storj' ? 'on Storj Gateway' : 'on IPFS Gateway' }}</a>
                <button v-if="!isListed(vid.cid)" @click="goToListing(vid.cid)" class="text-green-600 hover:underline text-xs"> <i class="fas fa-tags mr-1"></i> {{ (vid.purpose === 'sell' && !isListed(vid.cid)) ? 'Complete Listing' : 'Create Listing' }} </button>
                <span v-else class="text-gray-500 text-xs"><i class="fas fa-check mr-1"></i>Already Listed</span>
                <button v-if="!isUsedInFunding(vid.cid) && (vid.purpose === 'funding' || vid.purpose === 'agristream')" @click="navigateToPageWithParam('farmerFunding', 'cid', vid.cid)" class="text-purple-600 hover:underline text-xs ml-2"> <i class="fas fa-hand-holding-usd mr-1"></i> {{ (vid.purpose === 'funding' && !isUsedInFunding(vid.cid)) ? 'Complete Funding Request' : 'Use for Funding' }} </button>
                <span v-if="isUsedInFunding(vid.cid)" class="text-gray-500 text-xs ml-2"><i class="fas fa-check mr-1"></i>Used for Funding</span>
                </div>
            </div>
            </div>
        </div>
    </section>
    <!-- Farmer Sell Section -->
    <section v-if="current==='farmerSell' && !isOrangeIdCallback" class="max-w-2xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-tags mr-2"></i>Sell Farm Crop on Marketplace</h2>
      <div class="bg-white rounded shadow-md p-6">
        <form @submit.prevent="createListing">
          <div class="mb-4">
            <label class="block text-gray-600 mb-1">Select Uploaded Video (Unlisted only)</label>
            <select v-model="listingForm.cid" class="w-full px-3 py-2 border rounded bg-white mb-2" required>
              <option value="" disabled>Select video...</option>
              <option v-for="vid in availableVideosForListing" :key="vid.cid" :value="vid.cid"> {{ vid.crop }} ({{ vid.location }}) - Pest: {{ vid.pesticide }} by {{ vid.pesticideCompany || 'N/A' }} ({{vid.storageType}}) </option>
              <option v-if="availableVideosForListing.length === 0" disabled>No unlisted videos available</option>
            </select>
            <p v-if="farmerVideos.length === 0" class="text-xs text-red-500">You need to upload a video first via PestiVid.</p>
            <p v-if="farmerVideos.length > 0 && availableVideosForListing.length === 0" class="text-xs text-yellow-600">All your videos are already associated with listings or not marked for sale.</p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">
            <div> <label class="block text-gray-600 mb-1">Min Price (SOL)</label> <input type="number" v-model="listingForm.minPrice" class="w-full px-3 py-2 border rounded" min="0.01" step="0.01" required placeholder="e.g., 0.5"> </div>
            <div> <label class="block text-gray-600 mb-1">Max Price (SOL)</label> <input type="number" v-model="listingForm.maxPrice" class="w-full px-3 py-2 border rounded" :min="listingForm.minPrice || 0.01" step="0.01" required placeholder="e.g., 1.5"> </div>
          </div>
          <div class="mb-4"> <label class="flex items-center"> <input type="checkbox" v-model="listingForm.notifyBuyers" class="form-checkbox h-4 w-4 text-green-600"> <span class="ml-2 text-sm text-gray-700">Notify potential buyers about this listing</span> </label> </div>
          <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded w-full" :disabled="!listingForm.cid || !isUserAuthenticated"> <i class="fas fa-plus-circle mr-1"></i>Create Listing </button>
          <div v-if="!isUserAuthenticated" class="text-red-500 mt-3 text-sm text-center">Log in to create listings.</div>
        </form>
        <div v-if="createdListingId" class="bg-green-100 text-green-700 px-4 py-3 mt-4 rounded font-medium text-sm"> <i class="fas fa-check mr-1"></i> Listing created successfully! Tx: <span class="font-mono text-xs">{{ createdListingId.substring(0,10) }}...</span> <div v-if="listingNotificationSent" class="mt-1 text-sm"> <i class="fas fa-bell mr-1"></i> Buyers have been notified about your new listing. </div> </div>
        <div class="mt-8">
          <h3 class="font-semibold mb-2 text-gray-700">Your Active Listings</h3>
          <div v-if="farmerListings.length===0" class="text-gray-600 text-sm bg-gray-50 p-4 rounded text-center">You have no active listings.</div>
          <ul v-else class="space-y-3">
            <li v-for="l in farmerListings" :key="l.id" class="py-3 px-4 border rounded flex flex-col sm:flex-row justify-between sm:items-center text-sm bg-white shadow-sm">
              <div> <span class="font-medium">{{ l.crop }}</span> <span class="text-xs text-gray-500 ml-1"> ({{l.location}})</span> <br> <span class="text-xs text-gray-500"> Key/CID: {{l.cid.substring(0, 8)}}... ({{l.storageType}})</span> | <span class="text-xs text-gray-500"> Pest. Co: {{ l.pesticideCompany || 'N/A' }}</span> <div v-if="l.notificationSent" class="text-xs text-green-600 mt-1"> <i class="fas fa-bell mr-1"></i> Buyers notified </div> </div>
              <div class="mt-2 sm:mt-0 text-right"> <span>Min: <span class="font-mono font-semibold">{{ l.minPrice }}</span> SOL</span><br> <span>Max: <span class="font-mono font-semibold">{{ l.maxPrice }}</span> SOL</span> <button v-if="!l.notificationSent" @click="notifyBuyersAboutListing(l)" class="ml-2 text-xs text-blue-600 border border-blue-300 rounded px-2 py-1 hover:bg-blue-50"> <i class="fas fa-bell-slash mr-1"></i> Notify </button> </div>
            </li>
          </ul>
        </div>
      </div>
    </section>
    <!-- Farmer Funding Section -->
    <section v-if="current==='farmerFunding' && !isOrangeIdCallback" class="max-w-3xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-money-bill-wave mr-2"></i>Request Funding for Your Farm</h2>
        <div class="bg-white rounded shadow-md p-6">
            <form @submit.prevent="createFundingRequest_V1">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div> <label class="block text-gray-600 mb-1 text-sm">Project Title</label> <input v-model="fundingForm.title" class="w-full px-3 py-2 border rounded text-sm" required placeholder="e.g., Organic Tomato Expansion"> </div>
                <div> <label class="block text-gray-600 mb-1 text-sm">Crop Type</label> <input v-model="fundingForm.crop" class="w-full px-3 py-2 border rounded text-sm" required placeholder="e.g., Roma Tomatoes"> </div>
                <div> <label class="block text-gray-600 mb-1 text-sm">Land Size (Acres)</label> <input type="number" v-model.number="fundingForm.acres" class="w-full px-3 py-2 border rounded text-sm" min="0.1" step="0.1" required placeholder="e.g., 5.5"> </div>
                <div> <label class="block text-gray-600 mb-1 text-sm">Funding Required (SOL)</label> <input type="number" v-model.number="fundingForm.amount" class="w-full px-3 py-2 border rounded text-sm" min="1" step="0.1" required placeholder="e.g., 50"> </div>
                <div> <label class="block text-gray-600 mb-1 text-sm">Growing Method</label> <select v-model="fundingForm.method" class="w-full px-3 py-2 border rounded bg-white text-sm" required> <option value="">Select method...</option> <option value="organic">Organic</option> <option value="conventional">Conventional</option> <option value="hydroponic">Hydroponic</option> <option value="aquaponic">Aquaponic</option> <option value="regenerative">Regenerative</option> </select> </div>
                <div> <label class="block text-gray-600 mb-1 text-sm">Expected ROI (%)</label> <input type="number" v-model.number="fundingForm.roi" class="w-full px-3 py-2 border rounded text-sm" min="1" max="100" required placeholder="e.g., 15"> </div>
            </div>
            <div class="mb-4"> <label class="block text-gray-600 mb-1 text-sm">Select Video Evidence</label> <select v-model="fundingForm.cid" class="w-full px-3 py-2 border rounded bg-white mb-2 text-sm" required> <option value="" disabled>Select video...</option> <option v-for="vid in availableVideosForFunding" :key="vid.cid" :value="vid.cid"> {{ vid.crop }} ({{ vid.location }}) - {{ vid.pesticideCompany || 'N/A' }} ({{vid.storageType}}) </option> <option v-if="availableVideosForFunding.length === 0" disabled>No videos suitable for funding available</option> </select> <p v-if="farmerVideos.length === 0" class="text-xs text-red-500">You need to upload a video first via PestiVid.</p> <p v-if="farmerVideos.length > 0 && availableVideosForFunding.length === 0" class="text-xs text-yellow-600">All your videos are already used for funding or not marked for funding.</p> </div>
            <div class="mb-4"> <label class="block text-gray-600 mb-1 text-sm">Project Description</label> <textarea v-model="fundingForm.description" class="w-full px-3 py-2 border rounded text-sm" rows="4" required placeholder="Describe your project, growing practices, and how funds will be used..."></textarea> </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"> <div> <label class="block text-gray-600 mb-1 text-sm">Timeline (Months)</label> <input type="number" v-model.number="fundingForm.timeline" class="w-full px-3 py-2 border rounded text-sm" min="1" max="36" required placeholder="How many months until harvest?"> </div> <div> <label class="block text-gray-600 mb-1 text-sm">Investor Share (%)</label> <input type="number" v-model.number="fundingForm.investorShare" class="w-full px-3 py-2 border rounded text-sm" min="1" max="80" required placeholder="Percentage of harvest profit for investors"> </div> </div>
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded w-full" :disabled="!fundingForm.cid || !isUserAuthenticated"> <i class="fas fa-paper-plane mr-1"></i> Create Funding Request </button>
            <div v-if="!isUserAuthenticated" class="text-red-500 mt-3 text-sm text-center">Log in to create funding requests.</div>
            </form>
            <div v-if="createdFundingRequest" class="bg-green-100 text-green-700 px-4 py-2 mt-4 rounded font-medium text-sm"> <i class="fas fa-check mr-1"></i> Funding request created and is now visible to investors! </div>
            <div class="mt-8">
            <h3 class="font-semibold mb-2 text-gray-700">Your Active Funding Requests</h3>
            <div v-if="farmerFundingRequests.length===0" class="text-gray-600 text-sm bg-gray-50 p-4 rounded text-center">You have no active funding requests.</div>
            <div v-else class="space-y-4">
                <div v-for="req in farmerFundingRequests" :key="req.id" class="border rounded-lg overflow-hidden shadow-sm bg-white">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 bg-gray-50 border-b"> <h4 class="font-bold mb-2 sm:mb-0">{{ req.title }}</h4> <div class="flex items-center space-x-2"> <span :class="{'bg-yellow-100 text-yellow-800': req.status === 'pending', 'bg-green-100 text-green-800': req.status === 'funded', 'bg-blue-100 text-blue-800': req.status === 'partially_funded'}" class="px-2 py-1 rounded text-xs font-medium"> {{ req.status === 'pending' ? 'Pending' : req.status === 'funded' ? 'Fully Funded' : (req.status === 'partially_funded' ? 'Partially Funded' : req.status) }} </span> </div> </div>
                <div class="p-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 text-sm"> <div> <div class="text-xs text-gray-500">Crop</div> <div>{{ req.crop }}</div> </div> <div> <div class="text-xs text-gray-500">Land Size</div> <div>{{ req.acres }} acres</div> </div> <div> <div class="text-xs text-gray-500">Required</div> <div>{{ req.amount }} SOL</div> </div> <div> <div class="text-xs text-gray-500">Investor Share</div> <div>{{ req.investorShare }}%</div> </div> </div>
                    <div class="mb-4"> <div class="text-xs text-gray-500 mb-1">Funding Progress</div> <div class="progress-bar"> <div class="progress-fill bg-green-500" :style="{width: fundingProgressPercent(req) + '%'}"></div> </div> <div class="flex justify-between text-xs mt-1"> <span>{{ req.fundedAmount || 0 }} SOL raised</span> <span>{{ fundingProgressPercent(req) }}% Complete</span> </div> </div>
                    <div v-if="req.fundedAmount > 0 && req.investors && req.investors.length > 0" class="mb-4"> <div class="text-xs text-gray-500 mb-2">Investors ({{req.investors.length}})</div> <div class="text-sm max-h-24 overflow-y-auto border rounded p-2 bg-gray-50 space-y-1"> <div v-for="investor in req.investors" :key="investor.investorId || investor.id" class="flex justify-between items-center py-1 text-xs"> <span><i class="fas fa-user text-gray-400 mr-1"></i>{{ investor.investorId ? (investor.investorId.substring(0,6) + '...') : 'Investor' }}</span> <span class="font-mono bg-blue-100 text-blue-800 px-1 rounded">{{ investor.amount }} SOL</span> </div> </div> </div>
                    <div class="flex justify-end mt-4"> <button v-if="req.status !== 'funded'" class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200" @click="cancelFundingRequest_V1(req.id)"> <i class="fas fa-times mr-1"></i>Cancel Request </button> <span v-if="req.status === 'funded'" class="text-xs text-green-600"><i class="fas fa-check-circle mr-1"></i>Fully Funded!</span> </div>
                </div>
                </div>
            </div>
            </div>
        </div>
    </section>
    <!-- Buyer AgriSell Section -->
    <section v-if="current==='buyerAgriSell' && !isOrangeIdCallback" class="max-w-6xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-3"><i class="fas fa-shopping-basket mr-2"></i>AgriSell: Marketplace</h2>
      <div class="bg-white rounded shadow-md p-6 mb-7">
        <div class="flex flex-col md:flex-row md:items-end gap-5">
          <div class="w-full md:w-48"> <label class="text-gray-600 text-sm">Crop Type</label> <select v-model="buyerFilters.crop" class="w-full px-2 py-1 border rounded bg-white text-sm"> <option value="">All</option> <option v-for="c in uniqueCrops" :key="c">{{c}}</option> </select> </div>
          <div class="flex-1"> <label class="text-gray-600 text-sm">Location</label> <input v-model="buyerFilters.location" class="w-full px-2 py-1 border rounded text-sm" placeholder="Search by location..."> </div>
          <div class="flex-1"> <label class="text-gray-600 text-sm">Pesticide Co.</label> <input v-model="buyerFilters.pesticideCompany" class="w-full px-2 py-1 border rounded text-sm" placeholder="Search by pesticide company..."> </div>
          <button type="button" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-1 rounded text-sm mt-2 md:mt-0" @click="resetBuyerFilters"> <i class="fas fa-undo mr-1"></i> Reset Filters </button>
        </div>
      </div>
      <div v-if="filteredListings.length === 0" class="text-gray-600 bg-gray-50 p-8 text-center rounded"> <i class="fas fa-search text-4xl text-gray-400 mb-3"></i><br> No listings found matching your criteria. Try adjusting your filters. </div>
      <div v-else class="grid gap-8 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
        <div v-for="l in filteredListings" :key="l.id" class="bg-white rounded shadow p-4 flex flex-col relative">
            <div v-if="l.isNew" class="new-badge">NEW</div>
          <div class="mb-3 flex justify-center"> <video :src="getVideoUrl(l.cid, l.storageType)" controls playsinline webkit-playsinline class="rounded w-full max-h-52 bg-black object-cover"></video> </div>
          <div class="mb-1 font-bold text-lg">{{ l.crop }}</div>
          <div class="text-xs text-gray-500 mb-1">Location: <span class="font-mono">{{ l.location }}</span></div>
          <div class="text-xs text-gray-500 mb-1">Pesticide: <span class="font-mono">{{ l.pesticide }}</span></div>
          <div class="text-xs text-gray-500 mb-2">Pesticide Co.: <span class="font-mono">{{ l.pesticideCompany || 'N/A' }}</span></div>
          <div class="text-sm my-2">Price Range: <br><span class="font-mono text-base font-semibold">{{ l.minPrice }}</span> - <span class="font-mono text-base font-semibold">{{ l.maxPrice }}</span> SOL</div>
          <div class="flex items-center text-xs text-gray-600 mb-2"> <span class="mr-1">Sold by: {{ getSellerDisplayIdentifier(l.farmerWallet) }}</span> <button @click="showFarmerProfile(l.farmerWallet)" class="text-blue-500 hover:text-blue-700 focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> </div>
          <button class="mt-auto bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded text-sm" @click="buyListing(l)" :disabled="!isUserAuthenticated || role !== 'buyer' || currentUserIdentifier === l.farmerWallet"> <i class="fas fa-shopping-cart mr-1"></i> {{ currentUserIdentifier === l.farmerWallet ? 'Your Listing' : (isUserAuthenticated && role === 'buyer' ? 'Initiate Purchase' : 'Login as Buyer to Purchase') }} </button>
          <button @click="startOrGoToConversation(l.farmerWallet)" v-if="isUserAuthenticated && currentUserIdentifier !== l.farmerWallet" class="mt-2 text-xs text-blue-600 hover:text-blue-700 border border-blue-400 rounded-full px-3 py-1 hover:bg-blue-50 flex items-center justify-center"> <i class="fas fa-envelope mr-1"></i> Message Seller </button>
        </div>
      </div>
    </section>
    <!-- Investor Projects Section -->
    <section v-if="current==='investorProjects' && !isOrangeIdCallback" class="max-w-6xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-3"><i class="fas fa-project-diagram mr-2"></i>Investment Opportunities</h2>
      <div class="bg-white rounded shadow-md p-6 mb-7">
        <div class="flex flex-col md:flex-row md:items-end gap-5">
          <div class="w-full md:w-48"> <label class="text-gray-600 text-sm">Crop Type</label> <select v-model="investorFilters.crop" class="w-full px-2 py-1 border rounded bg-white text-sm"> <option value="">All Crops</option> <option v-for="c in uniqueFundingCrops" :key="c">{{c}}</option> </select> </div>
          <div class="w-full md:w-48"> <label class="text-gray-600 text-sm">Growing Method</label> <select v-model="investorFilters.method" class="w-full px-2 py-1 border rounded bg-white text-sm"> <option value="">All Methods</option> <option value="organic">Organic</option> <option value="conventional">Conventional</option> <option value="hydroponic">Hydroponic</option> <option value="aquaponic">Aquaponic</option> <option value="regenerative">Regenerative</option> </select> </div>
          <div class="w-full md:w-48"> <label class="text-gray-600 text-sm">Min ROI (%)</label> <input type="number" v-model.number="investorFilters.minRoi" class="w-full px-2 py-1 border rounded text-sm" placeholder="e.g., 10"> </div>
          <div class="w-full md:w-48"> <label class="text-gray-600 text-sm">Max Funding Needed (SOL)</label> <input type="number" v-model.number="investorFilters.maxAmount" class="w-full px-2 py-1 border rounded text-sm" placeholder="e.g., 100"> </div>
          <button type="button" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-1 rounded text-sm mt-2 md:mt-0" @click="resetInvestorFilters"> <i class="fas fa-undo mr-1"></i> Reset Filters </button>
        </div>
      </div>
      <div class="grid gap-6 grid-cols-1 lg:grid-cols-2">
        <div v-for="project in filteredFundingRequests" :key="project.id" class="bg-white rounded-lg shadow overflow-hidden relative">
          <div v-if="project.isNew" class="new-badge">NEW</div>
          <div class="p-5 bg-gray-50 border-b flex flex-col sm:flex-row justify-between sm:items-center"> <h3 class="font-bold text-lg text-green-800 mb-2 sm:mb-0">{{ project.title }}</h3> <span :class="{'bg-yellow-100 text-yellow-800': project.status === 'pending', 'bg-green-100 text-green-800': project.status === 'funded', 'bg-blue-100 text-blue-800': project.status === 'partially_funded'}" class="px-2 py-1 rounded text-xs font-medium self-start sm:self-center"> {{ project.status === 'pending' ? 'Seeking Funding' : project.status === 'funded' ? 'Fully Funded' : 'Partially Funded' }} </span> </div>
          <div class="p-5">
            <div class="flex flex-col md:flex-row gap-6">
              <div class="md:w-1/3">
                <video :src="getVideoUrl(project.cid, project.videoStorageType)" controls playsinline webkit-playsinline class="rounded w-full h-40 object-cover bg-black mb-3"></video>
                <div class="grid grid-cols-2 gap-2 text-sm"> <div> <div class="text-xs text-gray-500">Farmer</div> <div class="font-medium truncate flex items-center"> <span>{{ getFarmerDisplayIdentifier(project.farmerWallet) }}</span> <button @click="showFarmerProfile(project.farmerWallet)" class="ml-2 text-blue-500 hover:text-blue-700 text-xs focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> </div> </div> <div> <div class="text-xs text-gray-500">Land Size</div> <div class="font-medium">{{ project.acres }} acres</div> </div> <div> <div class="text-xs text-gray-500">Timeline</div> <div class="font-medium">{{ project.timeline }} months</div> </div> <div> <div class="text-xs text-gray-500">Expected ROI</div> <div class="font-medium text-green-700">{{ project.roi }}%</div> </div> </div>
                <button @click="startOrGoToConversation(project.farmerWallet)" v-if="isUserAuthenticated && currentUserIdentifier !== project.farmerWallet" class="mt-3 w-full text-xs text-blue-600 hover:text-blue-700 border border-blue-400 rounded-full px-3 py-1 hover:bg-blue-50 flex items-center justify-center"> <i class="fas fa-envelope mr-1"></i> Message Farmer </button>
              </div>
              <div class="md:w-2/3">
                <div class="mb-4"> <div class="text-sm font-medium mb-1">{{ project.crop }} ({{ project.method }})</div> <p class="text-sm text-gray-700 max-h-20 overflow-y-auto">{{ project.description }}</p> </div>
                <div class="mb-4"> <div class="text-xs text-gray-500 mb-1">Funding Progress</div> <div class="progress-bar"> <div class="progress-fill bg-green-500" :style="{width: fundingProgressPercent(project) + '%'}"></div> </div> <div class="flex justify-between text-xs mt-1"> <span>{{ project.fundedAmount || 0 }} / {{ project.amount }} SOL</span> <span>{{ fundingProgressPercent(project) }}% Complete</span> </div> </div>
                <div v-if="project.updates && project.updates.length > 0" class="mb-4"> <h4 class="text-sm font-semibold text-gray-700 mb-2">Recent Farmer Updates</h4> <div class="project-updates-list text-xs" style="max-height: 70px;"> <div v-for="update in project.updates.slice().reverse().slice(0,2)" :key="update.id" class="project-update-item"> <span class="font-medium text-gray-500">{{ update.date }}:</span> {{ update.text }} </div> </div> </div>
                <div class="mb-4"> <div class="flex justify-between items-center mb-2"> <div class="text-sm font-medium">Investment Terms</div> <div class="text-xs text-gray-500">Investor Share: {{ project.investorShare }}% of profit</div> </div> <div class="p-3 bg-yellow-50 rounded text-sm border border-yellow-200"> <p>Invest to receive {{ project.investorShare }}% of the profits, proportional to your investment. Expected return is {{ project.roi }}% over {{ project.timeline }} months.</p> </div> </div>
                <div class="flex flex-col sm:flex-row justify-between items-center mt-4 pt-4 border-t"> <div class="mb-3 sm:mb-0"> <label :for="'investment-amount-'+project.id" class="text-xs text-gray-500 block mb-1">Your Investment (SOL)</label> <input v-model.number="investmentAmounts[project.id]" type="number" :id="'investment-amount-'+project.id" class="px-3 py-1 border rounded w-full sm:w-32 text-sm" min="0.1" :max="maxInvestmentAmount(project)" step="0.1" :disabled="project.status === 'funded' || !isUserAuthenticated || role !== 'investor'" :placeholder="maxInvestmentAmount(project) > 0 ? `Max ${maxInvestmentAmount(project)}` : 'Funded'"> </div> <button @click="investInProject(project)" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm w-full sm:w-auto" :disabled="project.status === 'funded' || !isUserAuthenticated || role !== 'investor' || !investmentAmounts[project.id] || investmentAmounts[project.id] <= 0 || investmentAmounts[project.id] > maxInvestmentAmount(project)"> <i class="fas fa-coins mr-1"></i> {{ project.status === 'funded' ? 'Fully Funded' : (!isUserAuthenticated || role !== 'investor' ? 'Login as Investor' : 'Invest Now') }} </button> </div>
                <div v-if="investmentErrors[project.id]" class="text-red-500 text-xs mt-2">{{ investmentErrors[project.id] }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div v-if="filteredFundingRequests.length === 0" class="bg-gray-50 p-8 text-center rounded-lg mt-4"> <i class="fas fa-seedling text-gray-300 text-4xl mb-3"></i> <h3 class="text-gray-600 text-lg mb-2">No Projects Found</h3> <p class="text-gray-500">Try adjusting your filters or check back later for new investment opportunities.</p> </div>
    </section>
    <!-- Investor Portfolio Section -->
    <section v-if="current==='investorPortfolio' && !isOrangeIdCallback" class="max-w-6xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-chart-pie mr-2"></i>Investment Portfolio</h2>
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Portfolio Overview</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6"> <div class="mb-4 md:mb-0"> <div class="text-xs text-gray-500">Total Invested</div> <div class="text-2xl font-bold text-green-700">{{ totalInvestedAmount }} SOL</div> </div> <div> <div class="text-xs text-gray-500">Active Projects</div> <div class="text-xl font-bold">{{ investorActiveProjects }}</div> </div> <div> <div class="text-xs text-gray-500">Completed</div> <div class="text-xl font-bold">{{ investorCompletedProjects }}</div> </div> <div> <div class="text-xs text-gray-500">Avg. ROI</div> <div class="text-xl font-bold text-green-700">{{ investorAvgRoi }}%</div> </div> </div>
        </div>
        <div class="bg-white rounded-lg shadow overflow-hidden mb-8">
            <div class="px-6 py-4 bg-gray-50 border-b"> <h3 class="text-lg font-semibold text-gray-800">Your Active Investments</h3> </div>
            <div v-if="investorInvestments.length === 0" class="p-8 text-center"> <i class="fas fa-chart-line text-gray-300 text-4xl mb-3"></i> <h4 class="text-gray-600 text-lg mb-2">No Active Investments</h4> <p class="text-gray-500 mb-4">You haven't invested in any agricultural projects yet.</p> <button @click="switchPage('investorProjects')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm"> <i class="fas fa-search mr-1"></i>Browse Projects </button> </div>
            <div v-else class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50"> <tr> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Farmer</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invested (SOL)</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expected Return (SOL)</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th> </tr> </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                <tr v-for="investment in investorInvestments" :key="investment.id">
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-medium text-gray-900">{{ investment.projectTitle }}</div> <div class="text-xs text-gray-500">{{ investment.crop }}</div> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm text-gray-900">{{ getFarmerDisplayIdentifier(investment.farmerWallet, 10) }}</div> <button @click="showFarmerProfile(investment.farmerWallet)" class="text-blue-500 hover:text-blue-700 text-xs focus:outline-none mr-2" title="View Farmer Info"> <i class="fas fa-info-circle mr-1"></i>View Info </button> <button @click="startOrGoToConversation(investment.farmerWallet)" v-if="isUserAuthenticated && currentUserIdentifier !== investment.farmerWallet" class="text-green-600 hover:text-green-700 text-xs focus:outline-none" title="Message Farmer"> <i class="fas fa-envelope mr-1"></i>Message </button> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm text-gray-900 font-mono">{{ investment.amount }}</div> <div class="text-xs text-gray-500">{{ investment.investmentDate }}</div> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="w-24 bg-gray-200 rounded-full h-2.5"> <div class="bg-green-600 h-2.5 rounded-full" :style="{width: investment.progress+'%'}"></div> </div> <div class="text-xs text-gray-500 mt-1">{{ investment.progress }}% Complete</div> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm text-gray-900 font-mono">{{ calculateExpectedReturn(investment) }}</div> <div class="text-xs text-gray-500">{{ investment.roi }}% ROI</div> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <span :class="{ 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true, 'bg-blue-100 text-blue-800': investment.status === 'active', 'bg-green-100 text-green-800': investment.status === 'harvested', 'bg-yellow-100 text-yellow-800': investment.status === 'growing' }"> {{ investment.status.charAt(0).toUpperCase() + investment.status.slice(1) }} </span> </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600"> <a href="#" @click.prevent="viewInvestmentDetails(investment)" class="hover:underline">View</a> </td>
                </tr>
                </tbody>
            </table>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 bg-gray-50 border-b flex justify-between items-center"> <h3 class="text-lg font-semibold text-gray-800">Platform Transaction History (Simulated)</h3> <span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded-full flex items-center"> <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 16 15"><path d="m7.81 0-1.78 3.69L1.88 4.2l2.92 2.52L4.04 10 7.8 7.97 11.55 10l-.77-3.28 2.92 2.52-4.15-.51L7.82 0h-.01Zm0 15-1.78-3.69-4.15-.51 2.92-2.52L4.04 5 7.8 7.03 11.55 5l-.77 3.28 2.92 2.52-4.15-.51L7.82 15h-.01Z"></path></svg> PestiVid Platform (Simulated Ledger) </span> </div>
            <div v-if="investorTransactions.length === 0" class="p-8 text-center"> <i class="fas fa-cubes text-gray-300 text-4xl mb-3"></i> <h4 class="text-gray-600 text-lg mb-2">No Transactions Yet</h4> <p class="text-gray-500">Your investment and payout transactions on the platform will appear here.</p> </div>
            <div v-else class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50"> <tr> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Transaction ID</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount (SOL)</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th> </tr> </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                <tr v-for="tx in investorTransactions" :key="tx.id">
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="flex items-center"> <div class="text-sm font-mono text-gray-900 truncate max-w-[150px] sm:max-w-[250px]" :title="tx.txHash">{{ tx.txHash.substring(0,10) }}...{{ tx.txHash.substring(tx.txHash.length-10) }}</div> <a :href="solanaExplorerUrl(tx.txHash)" target="_blank" class="ml-1 text-blue-500 hover:text-blue-700" title="View on Solana Explorer (Demo Link)"> <i class="fas fa-external-link-alt text-xs"></i> </a> </div> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <span :class="{ 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true, 'bg-green-100 text-green-800': tx.type === 'investment', 'bg-blue-100 text-blue-800': tx.type === 'payout' }"> {{ tx.type === 'investment' ? 'Investment' : 'Harvest Payout' }} </span> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-mono text-gray-900">{{ tx.amount }}</div> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800"> Confirmed (Sim.) </span> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm text-gray-900">{{ tx.date }}</div> </td>
                </tr>
                </tbody>
            </table>
            </div>
        </div>
    </section>
    <!-- User Profile Section -->
    <section v-if="current==='userProfile' && !isOrangeIdCallback" class="max-w-6xl mx-auto mt-6">
        <div v-if="!isUserAuthenticated" class="text-center p-10 bg-white rounded-lg shadow"> <i class="fas fa-exclamation-circle text-3xl text-yellow-500 mb-4"></i> <p class="text-xl text-gray-700">Please log in to view your profile.</p> </div>
      <div v-else class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="bg-gradient-to-r from-green-700 to-green-500 p-6 text-white">
          <div class="flex flex-col md:flex-row justify-between items-center">
            <div class="flex items-center mb-4 md:mb-0">
              <div class="bg-white rounded-full w-16 h-16 flex items-center justify-center mr-4 text-green-600 shadow overflow-hidden">
                <img v-if="loginMethod === 'orangeId' && orangeIdUser && orangeIdUser.picture" :src="orangeIdUser.picture" alt="Avatar" class="w-full h-full object-cover"/>
                <i v-else :class="role === 'farmer' ? 'fas fa-tractor' : (role === 'buyer' ? 'fas fa-shopping-cart' : 'fas fa-chart-line')" class="text-3xl"></i>
              </div>
              <div> <h2 class="text-2xl font-bold">{{ userName || displayedUserIdentifier }}</h2> <p class="text-green-100 capitalize"> {{ role === 'farmer' ? 'Agricultural Producer' : role === 'buyer' ? 'Crop Buyer' : 'Agricultural Investor' }} </p> </div>
            </div>
            <div class="bg-white bg-opacity-20 rounded-lg px-4 py-2 flex items-center text-sm"> <i class="fas fa-certificate mr-2"></i> <span>{{ role === 'farmer' ? 'Verified Farmer' : role === 'buyer' ? 'Verified Buyer' : 'Verified Investor' }} (PestiVid Status)</span> </div>
          </div>
        </div>
        <div class="p-6">
          <div class="mb-8">
            <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-id-card mr-2"></i>Account Information </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
              <div>
                <div class="mb-4"> <p class="text-gray-600">Full Name (PestiVid)</p> <p class="font-medium">{{ userName || 'Not Provided in PestiVid Profile' }}</p> </div>
                <div class="mb-4"> <p class="text-gray-600">PestiVid User Identifier ({{ loginMethod === 'orangeId' ? 'Orange ID' : 'Solana Wallet' }})</p> <p class="font-medium font-mono break-all">{{ currentUserIdentifier }}</p> </div>
                <div v-if="loginMethod === 'orangeId' && orangeIdUser && orangeIdUser.ethAddress" class="mb-4"> <p class="text-gray-600">ETH Address (from Orange ID, if available)</p> <p class="font-medium font-mono break-all">{{ orangeIdUser.ethAddress }}</p> </div>
                <div> <p class="text-gray-600">PestiVid Account Type</p> <p class="font-medium capitalize">{{ role || "Not Set" }}</p> </div>
              </div>
              <div>
                <div class="mb-4"> <p class="text-gray-600">Email (PestiVid)</p> <p class="font-medium">{{ userEmail || 'Not Provided in PestiVid Profile' }}</p> </div>
                <div v-if="loginMethod === 'orangeId' && orangeIdUser && orangeIdUser.email && orangeIdUser.email !== userEmail" class="mb-4"> <p class="text-gray-600">Authenticated Email (Orange ID)</p> <p class="font-medium">{{ orangeIdUser.email }}</p> </div>
                <div class="mb-4"> <p class="text-gray-600">Phone (PestiVid)</p> <p class="font-medium">{{ userPhone || 'Not Provided' }}</p> </div>
                <div> <p class="text-gray-600">PestiVid Member Since</p> <p class="font-medium">{{ memberSince || 'N/A' }}</p> </div>
              </div>
            </div>
          </div>
          
          <div v-if="role === 'farmer'" class="mb-8">
            <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-map-marker-alt mr-2"></i>Farm Information </h3>
             <p class="text-sm text-gray-600">General farm information can be displayed here (e.g., location, size, certifications if any). This section is a placeholder.</p>
             <!-- Example: <p><strong>Farm Location:</strong> {{ farmerLocationCity || 'Not Specified' }}</p> -->
          </div>

           <div v-if="role === 'farmer'">
                <div class="mb-8"> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-video mr-2"></i>Your Uploaded Videos ({{ farmerVideos.length }}) </h3> <div v-if="farmerVideos.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center"> <i class="fas fa-film text-gray-400 text-2xl mb-2"></i> <p>You haven't uploaded any videos yet.</p> <button @click="switchPage('farmerPestiVid')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Upload your first video</button> </div> <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"> <div v-for="vid in farmerVideos" :key="vid.cid" class="bg-gray-50 rounded-lg p-4 shadow-sm"> <video :src="getVideoUrl(vid.cid, vid.storageType)" controls playsinline webkit-playsinline class="w-full h-40 object-cover bg-black rounded mb-3"></video> <h4 class="font-bold">{{ vid.crop }}</h4> <div class="text-xs mb-1" :class="{ 'text-blue-700': vid.purpose === 'sell', 'text-purple-700': vid.purpose === 'funding', 'text-gray-600': vid.purpose === 'agristream' || !vid.purpose }"> Purpose: <span class="font-semibold"> {{ vid.purpose === 'sell' ? 'Sale' : (vid.purpose === 'funding' ? 'Funding' : (vid.purpose === 'agristream' ? 'General' : 'N/A')) }} </span> </div> <div class="text-sm mb-1">Location: {{ vid.location }}</div> <div class="text-sm mb-1">Pesticide: {{ vid.pesticide }}</div> <div class="text-sm mb-2">Pesticide Co.: {{ vid.pesticideCompany || 'N/A' }}</div> <div class="flex justify-between items-center mt-2 text-xs text-gray-500"> <span class="font-mono truncate" :title="vid.cid">Key/CID: {{ vid.cid.substring(0, 10) }}...</span> <a :href="getVideoUrl(vid.cid, vid.storageType)" target="_blank" class="text-blue-600 hover:underline">View</a> </div> <div class="text-xs text-gray-400 mt-1">File Hash: <span class="font-mono break-all" :title="vid.videoFileHash || 'N/A'">{{ vid.videoFileHash ? vid.videoFileHash.substring(0,10) + '...' : 'N/A' }}</span></div> </div> </div> </div>
                <div class="mb-8"> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-tags mr-2"></i>Your Active Listings ({{ farmerListings.length }}) </h3> <div v-if="farmerListings.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center"> <i class="fas fa-store text-gray-400 text-2xl mb-2"></i> <p>You don't have any active listings.</p> <button @click="switchPage('farmerSell')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Create your first listing</button> </div> <div v-else> <div class="overflow-x-auto"> <table class="min-w-full border divide-y divide-gray-200"> <thead class="bg-gray-50"> <tr> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Crop</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pesticide Co.</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price Range (SOL)</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th> </tr> </thead> <tbody class="bg-white divide-y divide-gray-200"> <tr v-for="listing in farmerListings" :key="listing.id"> <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-medium text-gray-900">{{ listing.crop }}</div> <div class="text-xs text-gray-500" :title="listing.cid">Key/CID: {{ listing.cid.substring(0, 8) }}... ({{listing.storageType}})</div> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ listing.location }} </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ listing.pesticideCompany || 'N/A' }} </td> <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm text-gray-900 font-mono">{{ listing.minPrice }} - {{ listing.maxPrice }}</div> </td> <td class="px-6 py-4 whitespace-nowrap"> <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800"> Active </span> </td> </tr> </tbody> </table> </div> </div> </div>
                <div> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-hand-holding-usd mr-2"></i>Your Funding Requests ({{ farmerFundingRequests.length }}) </h3> <div v-if="farmerFundingRequests.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center"> <i class="fas fa-money-bill-wave text-gray-400 text-2xl mb-2"></i> <p>You haven't created any funding requests yet.</p> <button @click="switchPage('farmerFunding')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Request funding for your farm</button> </div> <div v-else class="space-y-4"> <div v-for="req in farmerFundingRequests" :key="req.id" class="border rounded-lg overflow-hidden bg-white shadow-sm"> <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 bg-green-50 border-b"> <h4 class="font-bold mb-1 sm:mb-0">{{ req.title }}</h4> <span :class="{'bg-yellow-100 text-yellow-800': req.status === 'pending', 'bg-green-100 text-green-800': req.status === 'funded', 'bg-blue-100 text-blue-800': req.status === 'partially_funded'}" class="px-2 py-1 rounded text-xs font-medium"> {{ req.status === 'pending' ? 'Pending' : req.status === 'funded' ? 'Fully Funded' : (req.status === 'partially_funded' ? 'Partially Funded' : req.status) }} </span> </div> <div class="p-4 text-sm"> <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4"> <div> <div class="text-xs text-gray-500">Crop</div> <div>{{ req.crop }}</div> </div> <div> <div class="text-xs text-gray-500">Land Size</div> <div>{{ req.acres }} acres</div> </div> <div> <div class="text-xs text-gray-500">Required</div> <div class="font-mono">{{ req.amount }} SOL</div> </div> <div> <div class="text-xs text-gray-500">Raised</div> <div class="font-mono">{{ req.fundedAmount || 0 }} SOL</div> </div> </div> <div class="mb-4"> <div class="text-xs text-gray-500 mb-1">Funding Progress</div> <div class="progress-bar"> <div class="progress-fill bg-green-500" :style="{width: fundingProgressPercent(req) + '%'}"></div> </div> <div class="text-xs mt-1">{{ fundingProgressPercent(req) }}% Complete</div> </div> <div class="flex justify-end mt-4"> <button v-if="req.status !== 'funded'" class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200" @click="cancelFundingRequest_V1(req.id)"> <i class="fas fa-times mr-1"></i>Cancel Request </button> <span v-if="req.status === 'funded'" class="text-xs text-green-600"><i class="fas fa-check-circle mr-1"></i>Fully Funded!</span> </div> </div> </div> </div> </div>
            </div>
           <div v-if="role === 'buyer'"> <div> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-shopping-basket mr-2"></i>Your Purchase History ({{ buyerPurchases.length }}) </h3> <div v-if="buyerPurchases.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center"> <i class="fas fa-shopping-cart text-gray-400 text-2xl mb-2"></i> <p>You haven't made any purchases yet.</p> <button @click="switchPage('buyerAgriSell')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Browse marketplace</button> </div> <div v-else> <div class="overflow-x-auto"> <table class="min-w-full border divide-y divide-gray-200"> <thead class="bg-gray-50"> <tr> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Crop</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pesticide Co.</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price Paid (SOL)</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Purchase Date</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Seller</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Video/Tx</th> </tr> </thead> <tbody class="bg-white divide-y divide-gray-200"> <tr v-for="purchase in buyerPurchases" :key="purchase.id"> <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-medium text-gray-900">{{ purchase.crop }}</div> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ purchase.location }} </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ purchase.pesticideCompany || 'N/A' }} </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono"> {{ purchase.price }} </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ purchase.date }} </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ getSellerDisplayIdentifier(purchase.farmerWallet, 10) }} <button @click="showFarmerProfile(purchase.farmerWallet)" class="ml-1 text-blue-500 hover:text-blue-700 text-xs focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> <button @click="startOrGoToConversation(purchase.farmerWallet)" v-if="isUserAuthenticated && currentUserIdentifier !== purchase.farmerWallet" class="ml-1 text-green-600 hover:text-green-700 text-xs focus:outline-none" title="Message Seller"> <i class="fas fa-envelope"></i> </button> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600"> <a href="#" @click.prevent="viewPurchaseVideo(purchase)" class="hover:underline mr-2">Video ({{purchase.videoStorageType}})</a> <a :href="solanaExplorerUrl(purchase.txHash)" target="_blank" class="hover:underline" title="View Transaction (Demo Link)">Tx</a> </td> </tr> </tbody> </table> </div> </div> </div> </div>
           <div v-if="role === 'investor'"> <div class="mb-8"> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-chart-pie mr-2"></i>Investment Portfolio Summary </h3> <div v-if="investorInvestments.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center"> <i class="fas fa-coins text-gray-400 text-2xl mb-2"></i> <p>You haven't made any investments yet.</p> <button @click="switchPage('investorProjects')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Browse investment opportunities</button> </div> <div v-else> <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6"> <div class="bg-gray-50 p-4 rounded-lg"> <div class="text-sm text-gray-500">Total Invested</div> <div class="text-xl font-bold text-green-700">{{ totalInvestedAmount }} SOL</div> </div> <div class="bg-gray-50 p-4 rounded-lg"> <div class="text-sm text-gray-500">Projects</div> <div class="text-xl font-bold">{{ investorInvestments.length }}</div> </div> <div class="bg-gray-50 p-4 rounded-lg"> <div class="text-sm text-gray-500">Avg. ROI</div> <div class="text-xl font-bold text-green-700">{{ investorAvgRoi }}%</div> </div> <div class="bg-gray-50 p-4 rounded-lg"> <div class="text-sm text-gray-500">Completed</div> <div class="text-xl font-bold">{{ investorCompletedProjects }}</div> </div> </div> <div class="overflow-x-auto mt-4"> <h4 class="text-lg font-semibold text-gray-800 mb-3">Your Investments</h4> <table class="min-w-full border divide-y divide-gray-200"> <thead class="bg-gray-50"> <tr> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Farmer</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount (SOL)</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th> </tr> </thead> <tbody class="bg-white divide-y divide-gray-200"> <tr v-for="inv in investorInvestments" :key="inv.id"> <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-medium text-gray-900">{{ inv.projectTitle }}</div> <div class="text-xs text-gray-500">{{ inv.crop }}</div> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ getFarmerDisplayIdentifier(inv.farmerWallet, 10) }} <button @click="showFarmerProfile(inv.farmerWallet)" class="ml-1 text-blue-500 hover:text-blue-700 text-xs focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> <button @click="startOrGoToConversation(inv.farmerWallet)" v-if="isUserAuthenticated && currentUserIdentifier !== inv.farmerWallet" class="ml-1 text-green-600 hover:text-green-700 text-xs focus:outline-none" title="Message Farmer"> <i class="fas fa-envelope"></i> </button> </td> <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-mono text-gray-900">{{ inv.amount }}</div> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ inv.investmentDate }} </td> <td class="px-6 py-4 whitespace-nowrap"> <span :class="{'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true, 'bg-blue-100 text-blue-800': inv.status === 'active', 'bg-green-100 text-green-800': inv.status === 'harvested', 'bg-yellow-100 text-yellow-800': inv.status === 'growing'}"> {{ inv.status.charAt(0).toUpperCase() + inv.status.slice(1) }} </span> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600"> <a href="#" @click.prevent="viewInvestmentDetails(inv)" class="hover:underline">View</a> </td> </tr> </tbody> </table> </div> <div class="mt-4 text-right"> <button @click="switchPage('investorPortfolio')" class="text-green-700 text-sm hover:underline">Go to Full Portfolio <i class="fas fa-arrow-right ml-1"></i></button> </div> </div> </div> <div> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-link mr-2"></i>Platform Verification (Simulated) </h3> <div class="bg-gray-50 p-5 rounded-lg border"> <div class="flex items-center mb-4"> <i class="fas fa-shield-alt text-green-600 text-2xl mr-3"></i> <div> <h4 class="font-bold text-gray-800">PestiVid Platform Records</h4> <p class="text-sm text-gray-600">All your investment transactions are recorded on the PestiVid platform (Simulated Ledger).</p> </div> </div> <div v-if="investorTransactions.length > 0" class="mt-4"> <h5 class="font-medium text-sm mb-2">Recent Transactions</h5> <div class="space-y-2"> <div v-for="tx in investorTransactions.slice(0, 3)" :key="tx.id" class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-2 bg-white rounded border text-sm"> <div class="flex items-center mb-1 sm:mb-0"> <span :class="{'px-2 py-0.5 text-xs rounded-full mr-2': true, 'bg-green-100 text-green-800': tx.type === 'investment', 'bg-blue-100 text-blue-800': tx.type === 'payout'}"> {{ tx.type === 'investment' ? 'Invest' : 'Payout' }} </span> <span class="font-mono text-xs text-gray-500 truncate" :title="tx.txHash">{{ tx.txHash.substring(0, 8) }}...{{ tx.txHash.substring(tx.txHash.length - 8) }}</span> <a :href="solanaExplorerUrl(tx.txHash)" target="_blank" class="text-blue-600 hover:underline whitespace-nowrap"> <i class="fas fa-external-link-alt"></i> View (Demo Link) </a> </div> <div class="text-right w-full sm:w-auto"> <div class="font-mono text-sm">{{ tx.amount }} SOL</div> <div class="text-xs text-gray-500">{{ tx.date }}</div> </div> </div> </div> <div class="mt-3 text-right"> <button @click="switchPage('investorPortfolio')" class="text-green-700 text-sm hover:underline">View all transactions <i class="fas fa-arrow-right ml-1"></i></button> </div> </div> <div v-else class="bg-white p-4 rounded border text-center text-sm text-gray-600"> <p>No platform transactions recorded yet.</p> </div> </div> </div> </div>
        </div>
      </div>
    </section>
    <!-- Messaging Section -->
    <section v-if="current==='messaging' && !isOrangeIdCallback" class="max-w-6xl mx-auto mt-6">
        <div v-if="!isUserAuthenticated" class="text-center p-10 bg-white rounded-lg shadow"> <i class="fas fa-exclamation-circle text-3xl text-yellow-500 mb-4"></i> <p class="text-xl text-gray-700">Please log in to access messaging.</p> </div>
      <div v-else class="bg-white rounded-lg shadow-md flex" style="height: calc(100vh - 200px);">
        <div class="w-full md:w-1/3 border-r flex flex-col bg-gray-50">
            <div class="p-4 border-b"> <h2 class="text-xl font-semibold text-green-700">Conversations</h2> </div>
            <div class="overflow-y-auto flex-1">
                <div v-if="userConversations.length === 0" class="p-4 text-center text-gray-500 mt-10"> <i class="fas fa-comment-slash fa-3x mb-3 text-gray-300"></i> <p>No conversations yet.</p> <p class="text-xs mt-1">Start a chat from a user's profile or project.</p> </div>
                <div v-for="conv in userConversations" :key="conv.id" @click="selectConversation(conv.id)" class="p-3 hover:bg-gray-100 cursor-pointer border-b flex items-center space-x-3" :class="{'bg-green-100 border-l-4 border-green-500': activeConversationId === conv.id, 'bg-white': activeConversationId !== conv.id}">
                    <div class="w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center text-lg flex-shrink-0"> {{ getOtherParticipantInitial(conv) }} </div>
                    <div class="flex-1 overflow-hidden"> <div class="font-semibold text-gray-800 truncate">{{ getOtherParticipantDisplayAddress(conv) }}</div> <div class="text-xs text-gray-500 truncate">{{ conv.lastMessageSnippet }}</div> </div>
                    <div class="text-xs text-gray-400 self-start whitespace-nowrap">{{ formatTimestamp(conv.lastMessageTimestamp, true) }}</div>
                    <div v-if="getUnreadCountForConversation(conv.id) > 0" class="bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs ml-auto flex-shrink-0"> {{ getUnreadCountForConversation(conv.id) }} </div>
                </div>
            </div>
        </div>
        <div class="w-full md:w-2/3 flex flex-col bg-white">
            <div v-if="!activeConversationId" class="flex-1 flex flex-col items-center justify-center text-gray-400 p-10 text-center"> <i class="fas fa-comments fa-4x mb-4"></i> <h3 class="text-xl text-gray-600">Welcome to PestiVid Chat</h3> <p>Select a conversation from the left to view messages, or start a new chat from a user's profile or project page.</p> </div>
            <template v-else>
                <div class="p-4 border-b bg-gray-50 flex items-center sticky top-0 z-10"> <div class="w-8 h-8 rounded-full bg-green-600 text-white flex items-center justify-center text-sm mr-3 flex-shrink-0"> {{ activeConversationPartnerInitial ? activeConversationPartnerInitial : '?' }} </div> <h3 class="font-semibold text-lg text-green-800">{{ activeConversationPartnerDisplayAddress }}</h3> </div>
                <div class="flex-1 overflow-y-auto p-4 space-y-3 message-view-container bg-gray-100" ref="messageContainer">
                    <div v-if="currentMessages.length === 0" class="text-center text-gray-500 py-10"> No messages in this conversation yet. Say hello! </div>
                    <div v-for="msg in currentMessages" :key="msg.id" class="flex" :class="msg.sender === currentUserIdentifier ? 'justify-end' : 'justify-start'">
                        <div class="max-w-xs md:max-w-md lg:max-w-lg"> <div class="p-3 rounded-xl shadow" :class="msg.sender === currentUserIdentifier ? 'bg-green-600 text-white' : 'bg-white text-gray-800 border'"> <p class="text-sm leading-relaxed">{{ msg.text }}</p> </div> <p class="text-xs mt-1 px-1" :class="msg.sender === currentUserIdentifier ? 'text-gray-400 text-right' : 'text-gray-400 text-left'"> {{ formatTimestamp(msg.timestamp) }} <span v-if="msg.sender === currentUserIdentifier && msg.read"><i class="fas fa-check-double text-blue-400 ml-1" title="Read"></i></span> <span v-if="msg.sender === currentUserIdentifier && !msg.read"><i class="fas fa-check text-gray-400 ml-1" title="Sent"></i></span> </p> </div>
                    </div>
                </div>
                <div class="p-3 border-t bg-gray-50"> <form @submit.prevent="sendMessage" class="flex gap-3 items-center"> <input v-model="messageInputText" type="text" placeholder="Type your message..." class="flex-1 px-4 py-2 border border-gray-300 rounded-full focus:ring-green-500 focus:border-green-500 text-sm" required> <button type="submit" :disabled="!messageInputText.trim()" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-full text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 disabled:opacity-50"> <i class="fas fa-paper-plane mr-1"></i> Send </button> </form> </div>
            </template>
        </div>
      </div>
    </section>
    <!-- Plant Recommendation Section -->
    <section v-if="current==='plantRecommendation' && !isOrangeIdCallback" class="max-w-3xl mx-auto mt-6">
      <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-leaf mr-2"></i>Plant Disease Detection & Recommendation</h2>
      <div class="bg-white rounded shadow-md p-6 space-y-6">
        <p class="text-sm text-gray-600">Upload an image of an affected plant. it will attempt to identify the plant, detect diseases, and suggest treatments.</p>
        <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4" role="alert">
          <p class="font-bold">Developer Note (Placeholder Feature):</p>
          <p class="text-sm">This Plant Recommendation feature is currently a placeholder. The image upload works, but the analysis logic (using Gemini API) needs to be fully implemented and tested with a valid API key. The current description is illustrative.</p>
        </div>
        <div>
          <label class="block text-gray-600 mb-1 text-sm">Upload Plant Image</label>
          <input type="file" @change="handlePlantImageUpload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
        </div>
        <div v-if="plantImageUrl" class="mt-4">
          <h4 class="text-md font-semibold text-gray-700 mb-2">Image Preview:</h4>
          <img :src="plantImageUrl" alt="Plant Preview" class="max-w-xs md:max-w-sm rounded-md border shadow mx-auto">
        </div>
        <button @click="analyzePlant" :disabled="!plantImageFile || analysisInProgress" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded text-sm flex items-center justify-center" :class="{'opacity-50 cursor-not-allowed': !plantImageFile || analysisInProgress}">
          <i :class="analysisInProgress ? 'fas fa-spinner fa-spin' : 'fas fa-search-plus'" class="mr-2"></i>
          {{ analysisInProgress ? 'Analyzing...' : 'Analyze Plant with trained model' }}
        </button>
        <div v-if="analysisErrorText" class="mt-4 bg-red-100 border border-red-300 text-red-700 px-4 py-3 rounded text-sm">
          <p class="font-bold">Analysis Error:</p>
          <p>{{ analysisErrorText }}</p>
        </div>
        <div v-if="parsedAnalysis.plantName && !analysisInProgress && !analysisErrorText" class="mt-6 border-t pt-6 space-y-4">
          <h3 class="text-xl font-semibold text-green-700">Analysis Results:</h3>
          <div>
            <p class="text-sm font-medium text-gray-500">Identified Plant:</p>
            <p class="text-lg text-gray-800">{{ parsedAnalysis.plantName || 'Could not identify plant.' }}</p>
          </div>
          <div>
            <p class="text-sm font-medium text-gray-500">Detected Disease:</p>
            <p class="text-lg text-gray-800 font-semibold" :class="{'text-red-600': parsedAnalysis.diseaseName && parsedAnalysis.diseaseName.toLowerCase() !== 'healthy' && parsedAnalysis.diseaseName.toLowerCase() !== 'not apparent' && parsedAnalysis.diseaseName.toLowerCase() !== 'unknown', 'text-green-600': parsedAnalysis.diseaseName && (parsedAnalysis.diseaseName.toLowerCase() === 'healthy' || parsedAnalysis.diseaseName.toLowerCase() === 'not apparent')}">
              {{ parsedAnalysis.diseaseName || 'Could not determine disease.' }}
            </p>
          </div>
          <div>
            <p class="text-sm font-medium text-gray-500">Recommended Treatment / Pesticides:</p>
            <p class="text-md text-gray-700 whitespace-pre-wrap">{{ parsedAnalysis.treatmentRecommended || 'No specific treatment recommended.' }}</p>
          </div>
           <div v-if="analysisResultText && (!parsedAnalysis.plantName || parsedAnalysis.plantName === 'Unknown' || parsedAnalysis.plantName === '-')" class="mt-4 bg-gray-50 p-3 rounded border text-xs">
                <p class="font-semibold mb-1">Output (for debugging if parsing failed):</p>
                <pre class="whitespace-pre-wrap overflow-x-auto">{{ analysisResultText }}</pre>
            </div>
        </div>
      </div>
    </section>

    <!-- Farmer Chatbot Section (AgriBot) -->
    <section v-if="current==='farmerChatbot' && !isOrangeIdCallback" class="max-w-3xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-robot mr-2"></i>AgriBot - Your Farming Assistant</h2>
        <div v-if="!isUserAuthenticated || role !== 'farmer'" class="bg-white rounded shadow-md p-6 text-center text-gray-600">
            <i class="fas fa-exclamation-circle fa-2x text-yellow-500 mb-3"></i>
            <p>Please log in as a Farmer to use AgriBot.</p>
            <button v-if="!isUserAuthenticated" @click="switchPage('loginChoice')" class="mt-4 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">Login</button>
        </div>
        <div v-else class="bg-white rounded shadow-md chatbot-container">
            <div class="chatbot-messages" ref="chatbotMessagesContainer">
                <div v-for="msg in chatMessages" :key="msg.id" :class="['chat-message', msg.sender]">
                    <div class="message-content">
                        <div class="avatar">
                            <i :class="msg.sender === 'user' ? 'fas fa-user' : 'fas fa-robot'"></i>
                        </div>
                        <div class="message-bubble" v-html="renderMarkdown(msg.text)"></div>
                    </div>
                </div>
                <div v-if="isGroqLoading" class="chat-message bot">
                    <div class="message-content">
                         <div class="avatar"><i class="fas fa-robot"></i></div>
                         <div class="message-bubble typing-indicator">
                            <span></span><span></span><span></span>
                         </div>
                    </div>
                </div>
            </div>
            <div class="chatbot-input-area">
                <input type="text" v-model="chatInput" @keyup.enter="sendChatMessage" placeholder="Ask AgriBot about farming..." :disabled="isGroqLoading">
                <button @click="sendChatMessage" :disabled="isGroqLoading || !chatInput.trim()">
                    <i class="fas fa-paper-plane mr-1"></i> Send
                </button>
            </div>
        </div>
    </section>


    <!-- Modals (Purchase Video, Buy Listing, Investment Details, Farmer Profile) -->
    <div v-if="selectedPurchase && showPurchaseVideo && !isOrangeIdCallback" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full modal-scrollable">
        <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white z-10"> <h3 class="font-bold text-lg text-green-700">{{ selectedPurchase.crop }} - Purchase Verification</h3> <button @click="showPurchaseVideo = false" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times"></i> </button> </div>
        <div class="p-4">
            <video :src="getVideoUrl(selectedPurchase.cid, selectedPurchase.videoStorageType)" controls playsinline webkit-playsinline class="w-full rounded bg-black mb-4"></video>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div> <p class="text-gray-600">Location</p> <p class="font-medium">{{ selectedPurchase.location }}</p> </div>
                <div> <p class="text-gray-600">Pesticide Used</p> <p class="font-medium">{{ selectedPurchase.pesticide }}</p> </div>
                <div> <p class="text-gray-600">Pesticide Company</p> <p class="font-medium">{{ selectedPurchase.pesticideCompany || 'N/A' }}</p> </div>
                <div> <p class="text-gray-600">Purchase Price</p> <p class="font-medium font-mono">{{ selectedPurchase.price }} SOL</p> </div>
                <div> <p class="text-gray-600">Purchase Date</p> <p class="font-medium">{{ selectedPurchase.date }}</p> </div>
                <div> <p class="text-gray-600">Seller Identifier</p> <p class="font-medium font-mono text-xs">{{ selectedPurchase.farmerWallet }}</p> </div>
                <div>
                    <p class="text-gray-600">Video File Hash (SHA256)</p>
                    <p class="font-medium font-mono text-xs break-all" :title="selectedPurchase.videoFileHash || 'N/A'">{{ selectedPurchase.videoFileHash || 'N/A' }}</p>
                </div>
            </div>
            <div class="mt-4 bg-gray-100 p-3 rounded text-xs border">
                <p class="font-bold mb-1">Platform Verification (Simulated):</p>
                <p class="font-mono break-all mb-1">Video Key/CID ({{selectedPurchase.videoStorageType}}): {{ selectedPurchase.cid }}</p>
                <p class="font-mono break-all">Simulated Tx: {{ selectedPurchase.txHash }} <a :href="solanaExplorerUrl(selectedPurchase.txHash)" target="_blank" class="text-blue-500 hover:text-blue-700"><i class="fas fa-external-link-alt text-xs"></i></a> </p>
                <p class="mt-1 text-gray-500">Video evidence on {{ selectedPurchase.videoStorageType === 'storj' ? 'Storj' : 'IPFS'}}, linked on PestiVid platform (Simulated).</p>
                <a :href="getVideoUrl(selectedPurchase.cid, selectedPurchase.videoStorageType)" target="_blank" class="text-blue-600 hover:underline mt-1 inline-block">View on {{ selectedPurchase.videoStorageType === 'storj' ? 'Storj Gateway' : 'IPFS Gateway' }} <i class="fas fa-external-link-alt text-xs ml-1"></i></a>
            </div>
        </div>
        <div class="bg-gray-50 p-4 flex justify-end rounded-b-lg sticky bottom-0 border-t"> <button @click="showPurchaseVideo = false" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded text-sm"> Close </button> </div>
      </div>
    </div>
    <div v-if="showBuyModal && selectedListing && !isOrangeIdCallback" class="fixed inset-0 z-50 bg-black bg-opacity-60 flex justify-center items-center p-4">
      <div class="bg-white rounded shadow-lg w-full max-w-sm p-6 relative mx-2 modal-scrollable">
        <button class="absolute top-2 right-2 text-gray-400 hover:text-red-500" @click="closeBuyModal"><i class="fas fa-times"></i></button>
        <h3 class="font-bold text-green-700 text-lg mb-3">Purchase Crop Batch</h3>
        <video :src="getVideoUrl(selectedListing.cid, selectedListing.storageType)" controls playsinline webkit-playsinline class="rounded w-full mb-3 bg-black"></video>
        <div class="mb-1 font-bold">{{ selectedListing.crop }}</div>
        <div class="text-xs text-gray-600 mb-1">Location: <span class="font-mono">{{ selectedListing.location }}</span></div>
        <div class="text-xs text-gray-500 mb-1">Pesticide: <span class="font-mono">{{ selectedListing.pesticide }}</span></div>
        <div class="text-xs text-gray-500 mb-2">Pesticide Co.: <span class="font-mono">{{ selectedListing.pesticideCompany || 'N/A' }}</span></div>
        <div class="text-xs text-gray-400 mb-2">File Hash: <span class="font-mono break-all" :title="selectedListing.videoFileHash || 'N/A'">{{ selectedListing.videoFileHash ? selectedListing.videoFileHash.substring(0,10) + '...' : 'N/A' }}</span></div>
        <div class="text-sm mb-2">Price Range: <span class="mx-1 font-mono font-semibold">{{ selectedListing.minPrice }}</span> - <span class="ml-1 font-mono font-semibold">{{ selectedListing.maxPrice }}</span> SOL </div>
        <form @submit.prevent="processPurchase"> <label class="text-sm block text-gray-600 mb-1">Your Offer (SOL)</label> <input type="number" v-model.number="purchaseAmount" :min="selectedListing.minPrice" :max="selectedListing.maxPrice" step="0.01" required :placeholder="`Enter amount (${selectedListing.minPrice}-${selectedListing.maxPrice})`" class="w-full px-3 py-2 border rounded mb-3 text-sm"> <button type="submit" class="bg-green-600 hover:bg-green-700 text-white w-full py-2 rounded text-sm" :disabled="!isUserAuthenticated"> <i class="fas fa-check mr-1"></i>Confirm Purchase (Simulated) </button> </form>
        <div v-if="purchaseStatus" class="text-green-700 font-semibold mt-3 text-sm bg-green-50 p-2 rounded border border-green-200">{{purchaseStatus}}</div> <div v-if="purchaseError" class="text-red-600 font-semibold mt-3 text-sm bg-red-50 p-2 rounded border border-red-200">{{purchaseError}}</div>
      </div>
    </div>
    <div v-if="showInvestmentDetailsModal && selectedInvestment && !isOrangeIdCallback" class="fixed inset-0 z-50 bg-black bg-opacity-70 flex justify-center items-center p-4">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl relative mx-2 modal-scrollable">
        <div class="p-4 bg-green-50 border-b flex justify-between items-center sticky top-0 z-10"> <h3 class="font-bold text-lg text-green-800">{{ selectedInvestment.projectTitle }}</h3> <button class="text-gray-400 hover:text-red-500" @click="showInvestmentDetailsModal=false"><i class="fas fa-times"></i></button> </div>
        <div class="p-6"> <div class="flex flex-col md:flex-row gap-6"> <div class="md:w-1/3"> <video :src="getVideoUrl(selectedInvestment.cid, selectedInvestment.videoStorageType)" controls playsinline webkit-playsinline class="rounded w-full h-40 object-cover bg-black mb-3"></video> <div class="mt-3 space-y-2 text-sm"> <div> <div class="text-xs text-gray-500">Farmer Identifier</div> <div class="font-medium flex items-center font-mono text-xs"> <span>{{ selectedInvestment.farmerWallet }}</span> <button @click="showFarmerProfile(selectedInvestment.farmerWallet); showInvestmentDetailsModal=false;" class="ml-2 text-blue-500 hover:text-blue-700 text-xs focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> <button @click="startOrGoToConversation(selectedInvestment.farmerWallet); showInvestmentDetailsModal=false;" v-if="isUserAuthenticated && currentUserIdentifier !== selectedInvestment.farmerWallet" class="ml-2 text-green-600 hover:text-green-700 text-xs focus:outline-none" title="Message Farmer"> <i class="fas fa-envelope"></i> </button> </div> </div> <div> <div class="text-xs text-gray-500">Investment Date</div> <div class="font-medium">{{ selectedInvestment.investmentDate }}</div> </div> <div> <div class="text-xs text-gray-500">Amount Invested</div> <div class="font-medium text-green-700 font-mono">{{ selectedInvestment.amount }} SOL</div> </div> <div> <div class="text-xs text-gray-500">Status</div> <span :class="{'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true, 'bg-blue-100 text-blue-800': selectedInvestment.status === 'active', 'bg-green-100 text-green-800': selectedInvestment.status === 'harvested', 'bg-yellow-100 text-yellow-800': selectedInvestment.status === 'growing'}"> {{ selectedInvestment.status.charAt(0).toUpperCase() + selectedInvestment.status.slice(1) }} </span> </div> </div> </div> <div class="md:w-2/3"> <div class="mb-4"> <div class="text-sm font-medium mb-1">{{ selectedInvestment.crop }} ({{ selectedInvestment.method }})</div> <p class="text-sm text-gray-700 max-h-24 overflow-y-auto border p-2 rounded bg-gray-50">{{ selectedInvestment.description }}</p> </div> <div class="mb-4"> <div class="text-xs text-gray-500 mb-1">Project Progress</div> <div class="progress-bar"> <div class="progress-fill bg-green-500" :style="{width: selectedInvestment.progress + '%'}"></div> </div> <div class="flex justify-between text-xs mt-1"> <span>{{ selectedInvestment.progress }}% Complete</span> <span>Est. {{ selectedInvestment.timeline }} months total</span> </div> </div> <div class="grid grid-cols-2 gap-4 mb-4 text-sm"> <div> <div class="text-xs text-gray-500">Expected Return</div> <div class="font-medium text-green-700 font-mono">{{ calculateExpectedReturn(selectedInvestment) }} SOL</div> </div> <div> <div class="text-xs text-gray-500">ROI</div> <div class="font-medium text-green-700">{{ selectedInvestment.roi }}%</div> </div> <div> <div class="text-xs text-gray-500">Land Size</div> <div class="font-medium">{{ selectedInvestment.acres }} acres</div> </div> <div> <div class="text-xs text-gray-500">Your Share</div> <div class="font-medium">{{ selectedInvestment.investorShare }}%</div> </div> <div> <div class="text-xs text-gray-500">Video File Hash</div> <p class="font-medium font-mono text-xs break-all" :title="selectedInvestment.videoFileHash || 'N/A'">{{ selectedInvestment.videoFileHash ? selectedInvestment.videoFileHash.substring(0,10) + '...' : 'N/A' }}</p> </div> </div> <div v-if="selectedInvestmentProject && selectedInvestmentProject.updates && selectedInvestmentProject.updates.length > 0" class="mb-4"> <h4 class="text-sm font-semibold text-gray-700 mb-2">Farmer Updates</h4> <div class="project-updates-list text-xs"> <div v-for="update in selectedInvestmentProject.updates.slice().reverse()" :key="update.id" class="project-update-item"> <span class="font-medium text-gray-500">{{ update.date }}:</span> {{ update.text }} </div> </div> </div> <div v-else-if="selectedInvestmentProject" class="mb-4 text-xs text-gray-500"> No project updates posted by the farmer yet. </div> <div class="bg-gray-100 p-3 rounded mb-4 border"> <div class="text-sm font-medium mb-1">Platform Transaction (Simulated)</div> <div class="flex items-center text-xs"> <span class="font-mono bg-white px-2 py-1 rounded border mr-2 truncate" :title="selectedInvestment.txHash">{{ selectedInvestment.txHash }}</span> <a :href="solanaExplorerUrl(selectedInvestment.txHash)" target="_blank" class="text-blue-600 hover:underline whitespace-nowrap"> <i class="fas fa-external-link-alt"></i> View (Demo Link) </a> </div> </div> <div v-if="selectedInvestment.status === 'harvested'" class="bg-green-100 p-3 rounded border border-green-200"> <div class="flex items-center"> <i class="fas fa-check-circle text-green-600 mr-2 text-lg"></i> <div> <div class="font-medium">Harvest Completed & Payout Processed</div> <div class="text-sm">Your return of {{ calculateExpectedReturn(selectedInvestment) }} SOL has been simulated.</div> </div> </div> </div> <div v-else-if="selectedInvestment.status === 'growing'" class="bg-yellow-50 p-3 rounded border border-yellow-200"> <div class="flex items-center"> <i class="fas fa-hourglass-half text-yellow-600 mr-2 text-lg"></i> <div> <div class="font-medium">Project Growing</div> <div class="text-sm">Harvest expected within {{ selectedInvestment.timeline }} months. Progress: {{selectedInvestment.progress}}%.</div> </div> </div> </div> </div> </div> </div>
        <div class="bg-gray-50 p-4 flex justify-end rounded-b-lg sticky bottom-0 border-t"> <button @click="showInvestmentDetailsModal=false" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded text-sm"> Close </button> </div>
      </div>
    </div>
    <div v-if="showFarmerProfileModal && selectedFarmerProfile && !isOrangeIdCallback" class="fixed inset-0 z-50 bg-black bg-opacity-70 flex justify-center items-center p-4">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-lg relative mx-2 modal-scrollable">
        <div class="p-4 bg-green-50 border-b flex justify-between items-center sticky top-0 z-10"> <h3 class="font-bold text-lg text-green-800 flex items-center"> <i class="fas fa-user-tie mr-2"></i> Farmer Profile </h3> <button class="text-gray-400 hover:text-red-500" @click="closeFarmerProfileModal"><i class="fas fa-times"></i></button> </div>
        <div class="p-6 space-y-5"> <div class="flex items-center space-x-4"> <div class="bg-green-100 rounded-full w-16 h-16 flex items-center justify-center text-green-600 text-2xl"> <i class="fas fa-tractor"></i> </div> <div> <p class="text-xs text-gray-500">Farmer Identifier</p> <p class="font-semibold text-lg text-green-700 font-mono">{{ selectedFarmerProfile.walletAddress.substring(0,10) }}...</p> <p class="text-sm text-gray-600">Farm Name (Sim.): {{ selectedFarmerProfile.farmName || 'N/A' }}</p> </div> </div> <div class="border-t pt-4"> <p class="text-xs text-gray-500">Short Bio (Simulated)</p> <p class="text-sm text-gray-700 italic">{{ selectedFarmerProfile.bio || 'This farmer has not provided a bio yet.' }}</p> </div> <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-4"> <div> <p class="text-xs text-gray-500">PestiVid Email</p> <p class="text-sm">{{ selectedFarmerProfile.email }}</p> </div> <div> <p class="text-xs text-gray-500">PestiVid Member Since</p> <p class="text-sm">{{ selectedFarmerProfile.memberSince }}</p> </div> </div> <div class="border-t pt-4"> <p class="text-sm font-medium text-gray-700 mb-2">Platform Activity:</p> <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm"> <div class="bg-gray-100 p-3 rounded-md"> <p class="font-semibold">{{ selectedFarmerProfile.fundingRequestCount }}</p> <p class="text-xs text-gray-500">Active Funding Request(s)</p> </div> <div class="bg-gray-100 p-3 rounded-md"> <p class="font-semibold">{{ selectedFarmerProfile.activeListingCount }}</p> <p class="text-xs text-gray-500">Active Marketplace Listing(s)</p> </div> </div> <p class="text-xs text-gray-400 mt-2">(Note: Activity based on currently visible items on the platform.)</p> </div> </div>
        <div class="bg-gray-50 p-4 flex justify-between items-center rounded-b-lg sticky bottom-0 border-t"> <button @click="messageFarmerFromProfile" v-if="isUserAuthenticated && selectedFarmerProfile && currentUserIdentifier !== selectedFarmerProfile.walletAddress" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm"> <i class="fas fa-paper-plane mr-1"></i> Send Message </button> <div v-else class="w-full"></div> <button @click="closeFarmerProfileModal" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded text-sm"> Close </button> </div>
      </div>
    </div>

    <!-- Notification Toast Container -->
    <div class="notification-toast-container">
        <div v-for="n in recentNotifications" :key="n.id" class="notification-toast" :class="{'show': n.show}" :data-notif-id="n.id"> <span :class="['icon', 'icon-' + n.type]"> <i :class="n.type === 'success' ? 'fas fa-check-circle' : (n.type === 'info' ? 'fas fa-info-circle' : (n.type === 'warning' ? 'fas fa-exclamation-triangle' : 'fas fa-bug'))"></i> </span> <span class="message">{{ n.message }}</span> <button @click="dismissNotification(n.id)" class="close-btn">&times;</button> </div>
    </div>
    <!-- Loading/Transaction Modal -->
    <div v-if="showLoadingModal" class="loading-modal"> <div class="loading-content"> <i class="fas fa-spinner fa-spin"></i> <p class="text-gray-700">{{ loadingMessage }}</p> </div> </div>
  </main>

  <footer class="bg-white border-t py-6 mt-auto text-center text-sm text-gray-500">
    <span> {{ new Date().getFullYear() }} PestiVid  Blockchain Agricultural Platform (Web3 Demo)</span>
  </footer>

  <!-- Interactive Avatar Assistant -->
  <div v-if="avatar.visible"
        :class="['fixed z-[9998] p-2 flex flex-col items-end', avatar.position === 'bottom-right' ? 'bottom-4 right-4' : 'bottom-4 left-4']"
        style="transition: all 0.3s ease;">

      <div v-show="avatar.expanded"
          class="bg-white w-80 md:w-96 h-96 max-h-[70vh] mb-2 rounded-xl shadow-2xl flex flex-col overflow-hidden border border-gray-200">
          <header class="bg-green-600 text-white p-3 flex items-center justify-between">
              <div class="flex items-center">
                  <img :src="avatar.images[avatar.character]?.[avatar.state] || avatar.images.farmer.idle" alt="Avatar" class="w-8 h-8 rounded-full mr-2 border-2 border-white">
                  <h3 class="font-semibold">PestiVid Helper</h3>
              </div>
              <button @click="toggleAvatarExpansion(false)" class="text-green-100 hover:text-white">
                  <i class="fas fa-times"></i>
              </button>
          </header>

          <div class="flex-grow p-3 space-y-3 overflow-y-auto" ref="avatarMessagesContainer" style="scroll-behavior: smooth;">
              <div v-for="msg in avatar.chatMessages" :key="msg.id + '-avatar'"
                  :class="['flex', msg.sender === 'user' ? 'justify-end' : 'justify-start']">
                  <div :class="['max-w-[80%] p-2.5 rounded-lg shadow-sm text-sm', msg.sender === 'user' ? 'bg-blue-500 text-white rounded-br-none' : 'bg-gray-100 text-gray-800 rounded-bl-none']"
                      v-html="renderMarkdown(msg.text)">
                  </div>
              </div>
              <div v-if="avatar.isProcessing && avatar.state === 'thinking'" class="flex justify-start">
                    <div class="bg-gray-100 text-gray-800 p-2.5 rounded-lg shadow-sm text-sm rounded-bl-none typing-indicator">
                      <span></span><span></span><span></span>
                    </div>
              </div>
          </div>

          <div v-if="avatar.quickActions.length > 0 && !avatar.isProcessing && !avatar.isListening" class="p-2 border-t border-gray-200 flex flex-wrap gap-2 justify-center">
              <button v-for="action in avatar.quickActions" :key="action.id"
                      @click="handleAvatarQuickAction(action)"
                      class="bg-green-100 text-green-700 px-3 py-1.5 text-xs rounded-full hover:bg-green-200 transition-colors">
                  {{ action.label }}
              </button>
          </div>

          <div class="p-3 border-t border-gray-200 bg-gray-50">
              <div class="flex items-center gap-2">
                   <button @click="toggleAvatarListening"
                          :disabled="avatar.isProcessing"
                          title="Toggle Voice Input"
                          class="avatar-input-mic-btn text-gray-500 hover:text-green-600 p-2 rounded-full focus:outline-none"
                          :class="{'text-red-500 listening': avatar.isListening}">
                      <i class="fas fa-microphone text-lg"></i>
                  </button>
                  <input type="text" v-model="avatar.userInput"
                        @keyup.enter="sendAvatarMessage"
                        :placeholder="avatar.isListening ? 'Listening...' : (avatar.isProcessing ? 'Helper is thinking...' : 'Ask PestiVid Helper...')"
                        :disabled="avatar.isProcessing"
                        class="flex-grow px-3 py-2 border border-gray-300 rounded-full text-sm focus:ring-2 focus:ring-green-500 focus:border-green-500">
                  <button @click="sendAvatarMessage" :disabled="avatar.isProcessing || !avatar.userInput.trim()"
                          class="bg-green-600 hover:bg-green-700 text-white rounded-full w-10 h-10 flex items-center justify-center transition-opacity"
                          :class="{'opacity-50 cursor-not-allowed': avatar.isProcessing || !avatar.userInput.trim()}">
                      <i class="fas fa-paper-plane"></i>
                  </button>
              </div>
          </div>
      </div>

      <button @click="toggleAvatarExpansion()"
              class="w-16 h-16 rounded-full shadow-xl overflow-hidden focus:outline-none ring-4 ring-green-500/30 hover:ring-green-500/50 transition-all duration-300 relative"
              :class="[avatar.expanded ? 'transform scale-90 opacity-70' : 'transform scale-100 opacity-100', 'border-4 border-white']"
              :style="{ borderColor: avatar.expanded ? '#10B981' : 'white' }">
          <img :src="avatar.images[avatar.character]?.[avatar.state] || avatar.images.farmer.idle"
                alt="PestiVid Helper Avatar"
                class="w-full h-full object-cover transition-transform duration-500"
                :class="{'animate-pulse-slow': avatar.state === 'thinking'}">
          <div v-if="!avatar.expanded && unreadAvatarMessagesCount > 0" class="absolute top-[-4px] right-[-4px] bg-red-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center ring-2 ring-white">
              {{ unreadAvatarMessagesCount }}
          </div>
      </button>
  </div>

</div>
<script>
const app = new Vue({
    el: "#app",
    data: {
      current: 'landing',
      showMobileMenu: false,
      loginMethod: null, currentUserIdentifier: null, isAuthProcessing: false,
      orangeIdUser: null, orangeIdBedrockSDK: null, orangeIdReactRootLogin: null, orangeIdReactRootCallback: null, orangeIdReactRootSignOut: null, orangeIdReactRootSignOutMobile: null, orangeIdWidgetMounted: false, orangeIdBedrockSDKError: false, isOrangeIdCallback: false,
      bedrockConfig: { baseUrl: 'https://api.bedrockpassport.com', authCallbackUrl: window.location.href.split('?')[0].split('#')[0], tenantId: 'orange-h0zmx5nf44', },
      walletAddress: null,
      role: '', userName: '', userEmail: '', userPhone: '', memberSince: '',
      selectedRoleOnboarding: '', userNameOnboarding: '', userEmailOnboarding: '', userPhoneOnboarding: '',
      recordForm: {crop:'', pesticide:'', location:'', pesticideCompany: '', purpose: 'agristream'}, recordStream: null, recordMediaRecorder: null, recording: false, recordBlob: null, recordBlobUrl: '', showLive: false,
      uploadCid: '', // Will now store Storj Object Key for Storj uploads, or IPFS CID for IPFS
      uploading: false, uploadError: '', lastUploadedVideoPurpose: '',
      lastUploadedVideoFileHash: '',
      farmerVideos: [],
      farmerListings: [], listingForm: {cid:'', minPrice:'', maxPrice:'', notifyBuyers: true}, createdListingId: null, listingNotificationSent: false,
      farmerFundingRequests: [], fundingForm: { title: '', crop: '', acres: null, amount: null, method: '', cid: '', description: '', timeline: null, roi: null, investorShare: null, notifyInvestors: true }, createdFundingRequest: false, newUpdateText: {},
      buyerPurchases: [], selectedPurchase: null, showPurchaseVideo: false,
      allListings: [], buyerFilters: {crop:'', location:'', pesticideCompany: ''}, showBuyModal: false, selectedListing: null, purchaseAmount: null, purchaseStatus: '', purchaseError: '',
      investorInvestments: [], investorTransactions: [], investorFilters: {crop: '', method: '', minRoi: null, maxAmount: null}, allFundingRequests: [], investmentAmounts: {}, investmentErrors: {}, showInvestmentDetailsModal: false, selectedInvestment: null, selectedInvestmentProject: null,
      showFarmerProfileModal: false, selectedFarmerProfile: null,

      // Pinata Configuration (Still present for potential IPFS fallback or if mixed content is needed)
      // For new uploads, this demo will now primarily use Storj if configured.
      pinataJwt: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiJiY2Q2N2EzMC1lYmVmLTRiMWYtYjZmMi02OTI1ZGM2OWUzZDUiLCJlbWFpbCI6InRlamFzaW5kdWt1cmk1QGdtYWlsLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJwaW5fcG9saWN5Ijp7InJlZ2lvbnMiOlt7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6IkZSQTEifSx7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6Ik5ZQzEifV0sInZlcnNpb24iOjF9LCJtZmFfZW5hYmxlZCI6ZmFsc2UsInN0YXR1cyI6IkFDVElWRSJ9LCJhdXRoZW50aWNhdGlvblR5cGUiOiJzY29wZWRLZXkiLCJzY29wZWRLZXlLZXkiOiI4OTY1ODM2MDlhMzE4YjY1N2QzMSIsInNjb3BlZEtleVNlY3JldCI6ImFkNWQ2OTc5NDkwNmFjODAzOGYxOGExNmYwMmIwOTc2NjlhNjQwNDY3MDExODdiZWRmOTdjMmZiMTA2NzdiNmYiLCJleHAiOjE3NzYwOTU3OTF9.dbyd6dnaASvYze1j5zVmPkoiDuQhA3PBczy0LxsRO-U', // Keep this structure, but actual JWT needed if using Pinata
      pinataGateway: 'gateway.pinata.cloud',

      // Storj S3 Configuration - UPDATED WITH YOUR CREDENTIALS
      storjConfig: {
        accessKeyId: 'juqnefz7qw2daooplo6ixzwocdsq', // REPLACE with your actual Storj Access Key ID
        secretAccessKey: 'jztu4esblunw3itukpn5oc3yygayaeew6md6vv4szwj5awqz6bxni', // REPLACE with your actual Storj Secret Access Key
        endpoint: 'https://gateway.storjshare.io',
        bucketName: 'pestivid', // YOUR BUCKET NAME IS CORRECTLY SET HERE
        region: 'us-east-1', // Default region for S3 SDK, Storj may ignore this
      },

      conversations: [], messages: [], activeConversationId: null, messageInputText: '',
      notifications: [], recentNotifications: [],
      showLoadingModal: false, loadingMessage: '',
      targetAgriStreamVideoCid: null, highlightedAgriStreamVideoCid: null,
      geminiApiKey: 'AIzaSyDK-CIafImL53t0GjL6zGWP10lA0yYcaSs', // <-- REPLACE THIS WITH YOUR ACTUAL Google Gemini API KEY
      plantImageFile: null, plantImageUrl: null, plantImageMimeType: null, analysisInProgress: false, analysisResultText: '', parsedAnalysis: { plantName: null, diseaseName: null, treatmentRecommended: null }, analysisErrorText: '',

      // Groq Chatbot State (for page-based AgriBot)
      groqApiKey: "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", // Your Groq API Key
      chatMessages: [], // For page-based AgriBot
      chatInput: '', // For page-based AgriBot
      isGroqLoading: false, // For page-based AgriBot
      groqSystemPrompt: "You are AgriBot, a knowledgeable and friendly AI assistant for farmers. Your expertise includes crop management (like tomatoes, strawberries, lettuce, peppers), pest and disease control (organic and conventional methods), soil health, irrigation, farm-to-market advice, and general agricultural best practices. You can also help explain features of the PestiVid platform. Provide clear, concise, and actionable advice. If a question is outside your agricultural expertise, politely state that. Always remind the user that your advice is for informational purposes and they should consult with local agricultural experts or conduct their own research before making critical farming decisions.",

      // Avatar Assistant State
      avatar: {
          visible: true,
          expanded: false,
          state: 'idle',
          character: 'farmer',
          position: 'bottom-right',
          chatMessages: [],
          userInput: '',
          quickActions: [],
          currentContextText: '',
          images: {
              farmer: {
                  idle: 'https://img.icons8.com/plasticine/100/farmer-male.png',
                  talking: 'https://img.icons8.com/plasticine/100/farmer-male.png',
                  thinking: 'https://img.icons8.com/plasticine/100/farmer-male.png',
                  listening: 'https://img.icons8.com/plasticine/100/farmer-male.png'
              },
          },
          systemPrompt: "You are PestiVid Helper, a friendly and knowledgeable AI assistant for the PestiVid platform. You are represented by a visual avatar. Your goal is to help users navigate the platform, understand its features (like PestiVid video uploads, AgriStream, Marketplace, Funding, PlantRecommend, Messaging, Investment Opportunities, Investor Portfolio, Orange ID & Solana Login), and answer their questions. Be encouraging and clear. If asked about a specific page, try to provide relevant tips. When the user opens your chat, if you have context, offer a relevant quick action or greeting. Keep responses concise for a chat interface. If you provide lists, use markdown for bullet points.",
          isProcessing: false,
          isListening: false,
      },
      speechRecognition: null,
    },
    computed: {
      isUserAuthenticated() { return !!this.currentUserIdentifier && !this.isAuthProcessing && !this.isOrangeIdCallback; },
      displayedUserIdentifier() { if (!this.currentUserIdentifier) return ''; if (this.userName) return this.userName.split(' ')[0]; if (this.loginMethod === 'orangeId' && this.orangeIdUser) { return (this.orangeIdUser.name || this.orangeIdUser.email || this.currentUserIdentifier).split(' ')[0]; } if (this.loginMethod === 'solana' && this.walletAddress) { const id = this.walletAddress.toString(); return `${id.substring(0, 6)}...${id.substring(id.length - 4)}`; } return this.currentUserIdentifier.substring(0,8) + '...'; },
      uniqueCrops() { const crops = this.allListings.map(l=>l.crop).filter(Boolean); return [...new Set(crops)].sort(); },
      filteredListings() { const oneDayAgo = Date.now() - (24*60*60*1000); return this.allListings.map(l => ({...l, isNew: new Date(l.createdAt) > oneDayAgo })).filter(l => { const cropMatch = !this.buyerFilters.crop || (l.crop || '').toLowerCase() === this.buyerFilters.crop.toLowerCase(); const locMatch = !this.buyerFilters.location || (l.location || '').toLowerCase().includes(this.buyerFilters.location.toLowerCase()); const companyMatch = !this.buyerFilters.pesticideCompany || (l.pesticideCompany || '').toLowerCase().includes(this.buyerFilters.pesticideCompany.toLowerCase()); return cropMatch && locMatch && companyMatch; }); },
      availableVideosForListing() { if (!this.isUserAuthenticated) return []; const listedCids = new Set(this.farmerListings.map(l => l.cid)); return this.farmerVideos.filter(v => v.farmerWallet === this.currentUserIdentifier && (v.purpose === 'sell' || v.purpose === 'agristream') && !listedCids.has(v.cid)); },
      availableVideosForFunding() { if (!this.isUserAuthenticated) return []; const fundingCids = new Set(this.farmerFundingRequests.map(r => r.cid)); return this.farmerVideos.filter(v => v.farmerWallet === this.currentUserIdentifier && (v.purpose === 'funding' || v.purpose === 'agristream') && !fundingCids.has(v.cid)); },
      uniqueFundingCrops() { const crops = this.allFundingRequests.map(r=>r.crop).filter(Boolean); return [...new Set(crops)].sort(); },
      filteredFundingRequests() { const oneDayAgo = Date.now() - (24*60*60*1000); return this.allFundingRequests.map(r => ({ ...r, isNew: new Date(r.createdAt) > oneDayAgo })).filter(r => { const isRelevantStatus = r.status === 'pending' || r.status === 'partially_funded'; const cropMatch = !this.investorFilters.crop || (r.crop||'').toLowerCase() === this.investorFilters.crop.toLowerCase(); const methodMatch = !this.investorFilters.method || (r.method||'').toLowerCase() === this.investorFilters.method.toLowerCase(); const roiMatch = !this.investorFilters.minRoi || r.roi >= this.investorFilters.minRoi; const amountMatch = !this.investorFilters.maxAmount || r.amount <= this.investorFilters.maxAmount; return isRelevantStatus && cropMatch && methodMatch && roiMatch && amountMatch; }); },
      totalInvestedAmount() { if (!this.investorInvestments || this.investorInvestments.length === 0) return '0.00'; return this.investorInvestments.reduce((sum, inv) => sum + inv.amount, 0).toFixed(2); },
      investorActiveProjects() { if (!this.investorInvestments) return 0; return this.investorInvestments.filter(inv => inv.status === 'active' || inv.status === 'growing').length; },
      investorCompletedProjects() { if (!this.investorInvestments) return 0; return this.investorInvestments.filter(inv => inv.status === 'harvested').length; },
      investorAvgRoi() { if (!this.investorInvestments || this.investorInvestments.length === 0) return '0.0'; const totalRoi = this.investorInvestments.reduce((sum, inv) => sum + inv.roi, 0); return this.investorInvestments.length > 0 ? (totalRoi / this.investorInvestments.length).toFixed(1) : '0.0'; },
      userConversations() { if (!this.isUserAuthenticated) return []; return this.conversations.filter(conv => conv.participants.includes(this.currentUserIdentifier)).sort((a, b) => new Date(b.lastMessageTimestamp) - new Date(a.lastMessageTimestamp)); },
      currentMessages() { if (!this.activeConversationId || !this.isUserAuthenticated) return []; return this.messages.filter(msg => msg.conversationId === this.activeConversationId).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)); },
      activeConversationPartnerIdentifier() { if (!this.activeConversationId || !this.isUserAuthenticated) return null; const conv = this.conversations.find(c => c.id === this.activeConversationId); if (!conv) return null; return conv.participants.find(p => p !== this.currentUserIdentifier); },
      activeConversationPartnerDisplayAddress() { const partnerId = this.activeConversationPartnerIdentifier; if (!partnerId) return '?'; const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles')) || {}; const partnerProfile = userProfiles[partnerId]; if(partnerProfile && partnerProfile.name) return partnerProfile.name.split(" ")[0]; return `${partnerId.substring(0,6)}...${partnerId.substring(partnerId.length-4)}`; },
      activeConversationPartnerInitial() { const partnerDisplay = this.activeConversationPartnerDisplayAddress; if (!partnerDisplay || partnerDisplay === '?') return '?'; return partnerDisplay.charAt(0).toUpperCase(); },
      unreadMessageCount() { if (!this.isUserAuthenticated) return 0; return this.messages.filter(msg => msg.receiver === this.currentUserIdentifier && !msg.read).length; },
      unreadAvatarMessagesCount() {
          if (!this.avatar.expanded && this.avatar.chatMessages) {
              return this.avatar.chatMessages.filter(msg => msg.sender === 'bot' && !msg.readByUser).length;
          }
          return 0;
      },
    },
    watch: {
      current(newPage, oldPage) {
          window.scrollTo(0,0);
          if (newPage === 'farmerAgriStream' && this.targetAgriStreamVideoCid) { this.scrollToAndHighlightAgriStreamVideo(); }
          else if (newPage !== 'farmerAgriStream') { this.highlightedAgriStreamVideoCid = null; }
          if (newPage === 'investorPortfolio' && this.isUserAuthenticated && this.role === 'investor') { this.updateInvestmentProgress(); }
          if (newPage === 'messaging' && this.activeConversationId) { this.scrollToMessageBottom(); this.markConversationAsRead(this.activeConversationId); }
          if (newPage === 'loginChoice' && !this.isOrangeIdCallback && !this.isUserAuthenticated) { this.$nextTick(() => this.renderOrangeIdLoginWidget()); }
          else if (oldPage === 'loginChoice' && newPage !== 'loginChoice') { this.$nextTick(() => this.unmountOrangeIdLoginWidget()); }
          if (oldPage === 'plantRecommendation' && newPage !== 'plantRecommendation') { this.plantImageFile = null; this.plantImageUrl = null; this.plantImageMimeType = null; this.analysisResultText = ''; this.parsedAnalysis = { plantName: null, diseaseName: null, treatmentRecommended: null }; this.analysisErrorText = ''; }
          if (newPage === 'farmerChatbot') { this.initializeChatbot(); this.$nextTick(() => this.scrollToChatBottom()); }

          if (this.avatar.visible && this.avatar.expanded) {
            this.updateAvatarContextAndQuickActions();
          }
      },
      isUserAuthenticated(isAuthenticated) { this.$nextTick(() => { if (isAuthenticated && this.loginMethod === 'orangeId') { this.renderOrangeIdSignOutButton('orange-id-signout-button-container'); if (this.showMobileMenu) { this.renderOrangeIdSignOutButton('orange-id-signout-button-container-mobile', true); } } else if (!isAuthenticated) { this.unmountOrangeIdSignOutButton('orange-id-signout-button-container'); this.unmountOrangeIdSignOutButton('orange-id-signout-button-container-mobile'); } }); },
      showMobileMenu(isShown) { if (isShown && this.isUserAuthenticated && this.loginMethod === 'orangeId') { this.$nextTick(() => { this.renderOrangeIdSignOutButton('orange-id-signout-button-container-mobile', true); }); } else if (!isShown && this.loginMethod === 'orangeId') { this.unmountOrangeIdSignOutButton('orange-id-signout-button-container-mobile'); } },
      farmerVideos: { handler(newVideos) { if (this.current === 'farmerAgriStream' && this.targetAgriStreamVideoCid) { if (newVideos.some(v => v.cid === this.targetAgriStreamVideoCid)) { this.scrollToAndHighlightAgriStreamVideo(); } } }, deep: true },
      chatMessages: { handler() { if(this.current === 'farmerChatbot') this.$nextTick(() => this.scrollToChatBottom()); }, deep: true },
      'avatar.chatMessages': {
          handler(newMessages, oldMessages) {
              if (newMessages.length > (oldMessages ? oldMessages.length : 0) ) {
                  const lastMsg = newMessages[newMessages.length - 1];
                  if (lastMsg.sender === 'bot' && this.avatar.expanded && this.avatar.state !== 'talking') {
                      this.avatar.state = 'listening';
                  }
                  this.$nextTick(() => this.scrollToAvatarMessagesBottom());
                  if(lastMsg.sender === 'bot' && !this.avatar.expanded && this.avatar.state !== 'talking') {
                      this.avatar.state = 'idle';
                  }
              }
          },
          deep: true
      },
      'avatar.isListening'(isListening) {
        if (isListening && 'speechSynthesis' in window && speechSynthesis.speaking) {
            speechSynthesis.cancel();
            this.avatar.state = 'listening';
        }
      }
    },
    methods: {
      switchPage(page) { this.current = page; this.showMobileMenu = false; },
      navigateToPageWithParam(page, paramName, paramValue) { if (page === 'farmerSell' && paramName === 'cid') { this.listingForm.cid = paramValue; } else if (page === 'farmerFunding' && paramName === 'cid') { this.fundingForm.cid = paramValue; } else if (page === 'farmerAgriStream' && paramName === 'highlightCid') { this.targetAgriStreamVideoCid = paramValue; } this.switchPage(page); },
      getStarted() { if (!this.isUserAuthenticated) { this.switchPage('loginChoice'); } else if (!this.role) { this.switchPage('roleSelection'); } else if (this.role === 'farmer') { this.switchPage('farmerPestiVid'); } else if (this.role === 'buyer') { this.switchPage('buyerAgriSell'); } else if (this.role === 'investor') { this.switchPage('investorProjects'); } else { this.switchPage('landing'); } },
      handleAuthenticationSuccess(identifier, method, orangeUserDetails = null) {
          if (!identifier) {
              console.error("Authentication success called with no identifier for method:", method, orangeUserDetails);
              this.addNotification("Authentication succeeded but user identifier was missing. Please try again.", "error");
              this.isOrangeIdCallback = false;
              this.isAuthProcessing = false;
              this.showLoadingModal = false;
              this.current = 'loginChoice';
              return;
          }
          this.isOrangeIdCallback = false; this.isAuthProcessing = false; this.showLoadingModal = false;
          this.$nextTick(() => {
              this.currentUserIdentifier = identifier; this.loginMethod = method;
              if (method === 'orangeId' && orangeUserDetails) { this.orangeIdUser = orangeUserDetails; this.walletAddress = null; }
              else if (method === 'solana') { this.walletAddress = identifier; this.orangeIdUser = null; }
              this.addNotification(`${method === 'orangeId' ? 'Orange ID' : 'Solana Wallet'} authentication successful!`, 'success');
              this.loadOrSetupPestiVidProfile();
          });
      },
      initializeOrangeIdSDK() { if (!window.React || !window.ReactDOM || !window.Bedrock) { console.error('Error: Orange ID - Required libraries (React, ReactDOM, Bedrock) failed to load.'); this.orangeIdBedrockSDKError = true; this.addNotification("Orange ID login service failed to load.", "error"); return false; } this.orangeIdBedrockSDKError = false; return true; },
      renderOrangeIdLoginWidget() { if (!this.initializeOrangeIdSDK() || this.orangeIdWidgetMounted) return; const container = document.getElementById('orange-id-login-container'); if (!container) { console.error("Orange ID login container not found."); return; } this.unmountOrangeIdLoginWidget(); this.orangeIdReactRootLogin = ReactDOM.createRoot(container); try { this.orangeIdReactRootLogin.render( React.createElement( Bedrock.BedrockPassportProvider, this.bedrockConfig, React.createElement(Bedrock.LoginPanel, { title: "Sign in to PestiVid", logo: "https://sindukuriteja.github.io/favicon.ico", logoAlt: "PestiVid", showConnectWallet: false, separatorText: "After this login successfully, you will need to connect your wallet because it is a Web3 application.", features: { enableWalletConnect: false, enableAppleLogin: true, enableGoogleLogin: true, enableEmailLogin: true, }, }) ) ); this.orangeIdWidgetMounted = true; } catch (e) { console.error("Error rendering Orange ID LoginPanel:", e); this.orangeIdBedrockSDKError = true; container.innerHTML = '<p class="text-red-500 p-4 text-sm"><i class="fas fa-exclamation-triangle mr-2"></i>Failed to render login widget.</p>'; } },
      unmountOrangeIdLoginWidget() { if (this.orangeIdReactRootLogin) { this.orangeIdReactRootLogin.unmount(); this.orangeIdReactRootLogin = null; this.orangeIdWidgetMounted = false; const container = document.getElementById('orange-id-login-container'); if (container) container.innerHTML = ''; } },
      renderOrangeIdCallbackProcessor() { if (!this.initializeOrangeIdSDK()) return; const container = document.getElementById('orange-id-callback-processor'); if (!container) return; this.orangeIdReactRootCallback = ReactDOM.createRoot(container); const self = this; function AuthCallbackProcessor() { const { loginCallback, user, isAuthenticated, isLoading } = Bedrock.useBedrockPassport(); const [message, setMessage] = React.useState('Processing authentication...'); React.useEffect(() => { async function processLogin() { const params = new URLSearchParams(window.location.search); const token = params.get('token'); const refreshToken = params.get('refreshToken'); if (token && refreshToken) { try { setMessage('Verifying tokens with Orange ID...'); const bedrockUser = await loginCallback(token, refreshToken); if (bedrockUser) { setMessage('Orange ID Login successful! Finalizing PestiVid session...'); window.history.replaceState({}, document.title, window.location.pathname + window.location.hash); self.handleAuthenticationSuccess(bedrockUser.sub || bedrockUser.id, 'orangeId', bedrockUser); } else { setMessage('Orange ID Authentication failed. Please try again.'); self.addNotification("Orange ID authentication failed.", "error"); setTimeout(() => { self.isOrangeIdCallback = false; self.current = 'loginChoice'; }, 2000); } } catch (error) { console.error('Orange ID Login callback error:', error); setMessage(`An error occurred during Orange ID login: ${error.message}`); self.addNotification(`Orange ID login error: ${error.message}`, "error"); setTimeout(() => { self.isOrangeIdCallback = false; self.current = 'loginChoice'; }, 3000); } } else { setMessage('No authentication tokens found. Redirecting to login...'); setTimeout(() => { self.isOrangeIdCallback = false; self.current = 'loginChoice'; }, 2000); } } processLogin(); }, [loginCallback]); if (isLoading) return React.createElement('p', null, 'Loading Bedrock SDK...'); return React.createElement('div', { style: { textAlign: 'center', padding: '1rem' } }, message); } this.orangeIdReactRootCallback.render( React.createElement( Bedrock.BedrockPassportProvider, this.bedrockConfig, React.createElement(AuthCallbackProcessor) ) ); },
      unmountOrangeIdCallbackProcessor() { if (this.orangeIdReactRootCallback) { this.orangeIdReactRootCallback.unmount(); this.orangeIdReactRootCallback = null; const container = document.getElementById('orange-id-callback-processor'); if (container) container.innerHTML = ''; } },
      renderOrangeIdSignOutButton(containerId, isMobile = false) { if (!this.initializeOrangeIdSDK() || !this.isUserAuthenticated || this.loginMethod !== 'orangeId') return; const container = document.getElementById(containerId); if (!container) return; let rootRef = isMobile ? 'orangeIdReactRootSignOutMobile' : 'orangeIdReactRootSignOut'; this.unmountOrangeIdSignOutButton(containerId, isMobile); this[rootRef] = ReactDOM.createRoot(container); const self = this; function PestiVidSignOutWrapper() { const { logout } = Bedrock.useBedrockPassport(); return React.createElement(Bedrock.SignOutButton, { onSignOut: () => { self.clearUserSession(true); self.current = 'landing'; }, buttonContent: React.createElement('i', { className: "fas fa-sign-out-alt text-lg" }), }); } this[rootRef].render( React.createElement( Bedrock.BedrockPassportProvider, this.bedrockConfig, React.createElement(PestiVidSignOutWrapper) ) ); },
      unmountOrangeIdSignOutButton(containerId, isMobile = false) { let rootRef = isMobile ? 'orangeIdReactRootSignOutMobile' : 'orangeIdReactRootSignOut'; if (this[rootRef]) { this[rootRef].unmount(); this[rootRef] = null; const container = document.getElementById(containerId); if(container) container.innerHTML = ''; } },
      checkOrangeIdCallback() { const params = new URLSearchParams(window.location.search); const token = params.get('token'); const refreshToken = params.get('refreshToken'); if (token && refreshToken) { this.isOrangeIdCallback = true; this.isAuthProcessing = true; this.$nextTick(() => this.renderOrangeIdCallbackProcessor()); return true; } this.isOrangeIdCallback = false; return false; },
      async connectWallet() { if (typeof window.solana === 'undefined' || typeof window.solana.connect === 'undefined') { alert("Solana wallet (e.g., Phantom) not found. Please install Phantom and try again."); window.open('https://phantom.app/', '_blank'); return; } if (this.isUserAuthenticated) { if (this.loginMethod === 'solana') { this.addNotification("Solana Wallet already connected.", "info"); return; } if(!confirm(`You are logged in with ${this.loginMethod}. Switch to Solana Wallet? This will log you out of Orange ID.`)) return; await this.logoutUser(false); } this.isAuthProcessing = true; try { const resp = await window.solana.connect(); this.handleAuthenticationSuccess(resp.publicKey.toString(), 'solana'); } catch (err) { console.error("Solana Wallet connection error:", err); this.addNotification("Could not connect to Solana wallet. " + (err.message || ''), "error"); this.loginMethod = null; this.isAuthProcessing = false; } },
      async disconnectWallet() { if (window.solana && window.solana.isConnected) { try { await window.solana.disconnect(); } catch (err) { console.error("Error disconnecting Solana wallet:", err); } } this.walletAddress = null; },
      loadOrSetupPestiVidProfile() { const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles')) || {}; const pestividProfile = userProfiles[this.currentUserIdentifier]; if (pestividProfile && pestividProfile.role) { this.role = pestividProfile.role; this.userName = pestividProfile.name; this.userEmail = pestividProfile.email; this.userPhone = pestividProfile.phone || ''; this.memberSince = pestividProfile.memberSince || new Date().toLocaleDateString(); } else { this.userNameOnboarding = this.loginMethod === 'orangeId' && this.orangeIdUser ? (this.orangeIdUser.name || '') : ''; this.userEmailOnboarding = this.loginMethod === 'orangeId' && this.orangeIdUser ? (this.orangeIdUser.email || '') : ''; this.userPhoneOnboarding = ''; this.selectedRoleOnboarding = ''; this.current = 'roleSelection'; if (this.isUserAuthenticated) { this.addNotification(`Welcome! Please complete your PestiVid profile.`, 'info'); } } this.filterDataForCurrentUser(); this.showMobileMenu = false; if (this.current !== 'roleSelection') { if (this.isUserAuthenticated && this.role) { this.getStarted(); } else if (this.isUserAuthenticated && !this.role) { this.current = 'roleSelection'; } } },
      completeOnboarding() { if (!this.selectedRoleOnboarding || !this.userNameOnboarding.trim() || !this.userEmailOnboarding.trim()) { alert("Please fill in Full Name, PestiVid Email, and select a Role."); return; } if (!/\S+@\S+\.\S+/.test(this.userEmailOnboarding)) { alert("Please enter a valid PestiVid email address."); return; } this.role = this.selectedRoleOnboarding; this.userName = this.userNameOnboarding.trim(); this.userEmail = this.userEmailOnboarding.trim(); this.userPhone = this.userPhoneOnboarding.trim() || ''; this.memberSince = new Date().toLocaleDateString(); const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles')) || {}; userProfiles[this.currentUserIdentifier] = { role: this.role, name: this.userName, email: this.userEmail, phone: this.userPhone, memberSince: this.memberSince, authMethod: this.loginMethod, orangeAuthEmail: this.loginMethod === 'orangeId' && this.orangeIdUser ? this.orangeIdUser.email : null, orangeEthAddress: this.loginMethod === 'orangeId' && this.orangeIdUser ? this.orangeIdUser.ethAddress : null, }; localStorage.setItem('pestiVidUserProfiles', JSON.stringify(userProfiles)); this.filterDataForCurrentUser(); this.getStarted(); this.addNotification(`Profile for ${this.userName} setup! Welcome!`, 'success'); },
      async logoutUser(notify = true, triggerOrangeIdLogout = true) { this.showLoadingModal = true; this.loadingMessage = "Signing out..."; if (this.loginMethod === 'solana') { await this.disconnectWallet(); this.clearUserSession(notify); } else if (this.loginMethod === 'orangeId') { if (!triggerOrangeIdLogout) { this.clearUserSession(notify); } else { console.warn("Direct Orange ID logout called without UI button. Orange ID session might persist on their server. Use UI button for full logout."); this.clearUserSession(notify); } } else { this.clearUserSession(notify); } this.showLoadingModal = false; if (this.current !== 'landing') this.current = 'landing'; },
      clearUserSession(notify = true) { this.currentUserIdentifier = null; this.walletAddress = null; this.orangeIdUser = null; this.role = ''; this.userName = ''; this.userEmail = ''; this.userPhone = ''; this.memberSince = ''; this.farmerVideos = []; this.farmerListings = []; this.farmerFundingRequests = []; this.buyerPurchases = []; this.investorInvestments = []; this.investorTransactions = []; this.activeConversationId = null; this.chatMessages = []; this.unmountOrangeIdSignOutButton('orange-id-signout-button-container'); this.unmountOrangeIdSignOutButton('orange-id-signout-button-container-mobile'); if (this.loginMethod === 'orangeId') this.loginMethod = null; this.showMobileMenu = false; this.isAuthProcessing = false; this.isOrangeIdCallback = false; if (notify) this.addNotification("You have been signed out from PestiVid.", 'info'); },
      getFarmerDisplayIdentifier(wallet, length = 6) { if (!wallet) return 'N/A'; const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles')) || {}; const profile = userProfiles[wallet]; if (profile && profile.name) return profile.name.split(' ')[0]; return `${wallet.substring(0, length)}...`; },
      getSellerDisplayIdentifier(wallet, length = 6) { return this.getFarmerDisplayIdentifier(wallet, length); },
      // NOTE: This function simulates a blockchain transaction with delays.
      // It does NOT interact with the actual Solana blockchain.
      // Replace with real Solana web3.js calls for production.
      async simulateTransaction(description = "Processing...") { this.showLoadingModal = true; this.loadingMessage = "Confirm action (Simulated)..."; await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 1500)); this.loadingMessage = `${description} on PestiVid (Simulated)...`; await new Promise(resolve => setTimeout(resolve, 2000 + Math.random() * 2500)); const txHash = 'sim_tx_' + Date.now().toString(16) + Math.random().toString(16).substring(2, 12); this.showLoadingModal = false; return txHash; },
      // NOTE: Reads the entire file into memory for hashing.
      // This can cause issues with very large video files (memory consumption/browser crash).
      // For production, consider using stream-based hashing if browser support allows,
      // or perform hashing server-side after upload.
      async calculateFileHash(fileBlob) {
          if (!fileBlob) return null;
          try {
              const buffer = await fileBlob.arrayBuffer();
              const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
              const hashArray = Array.from(new Uint8Array(hashBuffer));
              const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
              return hashHex;
          } catch (error) {
              console.error("Error calculating file hash:", error);
              this.addNotification("Error calculating video integrity hash.", "error");
              return null;
          }
      },
      async startVideo() {
        if (!this.isUserAuthenticated) { alert("Please log in."); return; }
        if (this.recording || this.uploading) return;
        if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
            console.warn("HTTPS recommended for camera access. Some browsers may restrict camera access on HTTP.");
        }
        this.recordBlob = null; this.recordBlobUrl = ''; this.uploadCid = ''; this.uploadError = ''; this.lastUploadedVideoFileHash = ''; this.showLive = true;
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
            this.recordStream = stream;
            this.$refs.liveVideo.srcObject = stream;
            this.$refs.liveVideo.play();
            let chunks = [];
            this.recording = true;
            const mimeTypes = ['video/webm;codecs=vp9,opus', 'video/webm;codecs=vp8,opus', 'video/webm', 'video/mp4'];
            let selectedMimeType = mimeTypes.find(type => MediaRecorder.isTypeSupported(type)) || undefined;
            this.recordMediaRecorder = new MediaRecorder(stream, { mimeType: selectedMimeType });
            this.recordMediaRecorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
            this.recordMediaRecorder.onstop = () => {
                const blobType = this.recordMediaRecorder.mimeType || 'video/webm';
                this.recordBlob = new Blob(chunks, { type: blobType });
                if (this.recordBlobUrl) URL.revokeObjectURL(this.recordBlobUrl);
                this.recordBlobUrl = URL.createObjectURL(this.recordBlob);
                this.showLive = false;
                stream.getTracks().forEach(t => t.stop());
                this.recordStream = null;
                this.recording = false;
                chunks = []; // Clear chunks for next recording
            };
            this.recordMediaRecorder.onerror = (e) => {
                this.uploadError = "Recording error: " + (e.error ? e.error.name : "Unknown");
                console.error("MediaRecorder error:", e);
                this.stopVideo(); // Attempt to clean up
            };
            this.recordMediaRecorder.start(1000); // Start recording, gather data every second (can adjust)
        } catch (e) {
            console.error("Error starting video recording:", e);
            let userErrorMessage = "Could not start video recording. ";
            if (e.name === 'NotAllowedError' || e.name === 'SecurityError' || e.name === 'PermissionDeniedError') {
                userErrorMessage += "Camera access was denied. Please grant permission in your browser settings.";
            } else if (e.name === 'NotFoundError' || e.name === 'DevicesNotFoundError') {
                userErrorMessage += "No camera found. Ensure a camera is connected and enabled.";
            } else if (e.name === 'NotReadableError' || e.name === 'TrackStartError' || e.name === 'AbortError' || e.name === 'OverconstrainedError') {
                userErrorMessage += "Camera is currently busy, could not be accessed, or requested constraints not met. Try closing other apps using the camera or ensure your device supports the requested video settings.";
            } else {
                userErrorMessage += `An unexpected error occurred: ${e.name || e.message}.`;
            }
            if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                userErrorMessage += " Using HTTPS is strongly recommended for camera access as some browsers restrict it on HTTP.";
            }
            this.addNotification(userErrorMessage, "error");
            this.uploadError = userErrorMessage;
            this.showLive = false;
            this.recording = false;
            if (this.recordStream) { this.recordStream.getTracks().forEach(t => t.stop()); this.recordStream = null; }
        }
      },
      stopVideo() {
          if (this.recordMediaRecorder && this.recordMediaRecorder.state === "recording") {
              this.recordMediaRecorder.stop();
          }
          // Stream tracks are stopped in onstop handler, but good to be defensive
          if (this.recordStream) {
              this.recordStream.getTracks().forEach(t => t.stop());
              this.recordStream = null;
          }
          this.recording = false;
          // this.showLive = false; // onstop handler already sets this
      },
      async uploadVideo() { // Updated for Storj S3
          if (!this.isUserAuthenticated) { alert("Log in."); return; }
          if (!this.recordBlob) { alert("No video recorded or video is empty. Please record again."); return; }
          if (this.recordBlob.size === 0) { alert("Recorded video is empty. Please try recording again."); return;}
          if (!this.recordForm.crop || !this.recordForm.pesticide || !this.recordForm.location || !this.recordForm.pesticideCompany || !this.recordForm.purpose) { alert("Fill all video details & select purpose."); return; }

          if (!this.storjConfig.accessKeyId || !this.storjConfig.secretAccessKey || this.storjConfig.accessKeyId.includes('YOUR_STORJ_ACCESS_KEY_ID') || this.storjConfig.secretAccessKey.includes('YOUR_STORJ_SECRET_ACCESS_KEY')) {
              const errorMsg = "CRITICAL ERROR: Storj S3 credentials are not configured correctly. Video uploads WILL FAIL. Please update 'storjConfig' in the script with your actual Storj credentials.";
              this.uploadError = errorMsg;
              alert(errorMsg);
              console.error(errorMsg);
              return;
          }

          this.uploading = true; this.uploadCid = ''; this.uploadError = ''; this.lastUploadedVideoPurpose = ''; this.lastUploadedVideoFileHash = '';
          let videoFileHash = null;
          try {
              this.loadingMessage = "Calculating video integrity hash..."; this.showLoadingModal = true;
              videoFileHash = await this.calculateFileHash(this.recordBlob);
              this.showLoadingModal = false;
              if (!videoFileHash) { this.uploadError = "Failed to calculate video file hash. Upload aborted."; this.uploading = false; alert(this.uploadError); return; }
              this.lastUploadedVideoFileHash = videoFileHash;
          } catch (e) { this.showLoadingModal = false; this.uploadError = "Error during video hash calculation: " + e.message; this.uploading = false; alert(this.uploadError); return; }

          this.loadingMessage = "Uploading to Storj..."; this.showLoadingModal = true;
          AWS.config.update({ accessKeyId: this.storjConfig.accessKeyId, secretAccessKey: this.storjConfig.secretAccessKey, region: this.storjConfig.region, endpoint: new AWS.Endpoint(this.storjConfig.endpoint), s3ForcePathStyle: true, });
          const s3 = new AWS.S3();
          const fileExtension = (this.recordBlob.type.split('/')[1] || 'webm').split(';')[0];
          const farmerIdPart = (this.currentUserIdentifier || 'unknown_user').replace(/[^a-zA-Z0-9_-]/g, '_').substring(0, 10);
          const cropPart = (this.recordForm.crop || 'unknown_crop').replace(/[^a-zA-Z0-9_-]/g, '_').substring(0, 15);
          const objectKey = `videos/${farmerIdPart}/${Date.now()}_${cropPart}.${fileExtension}`;

          const params = {
              Bucket: this.storjConfig.bucketName, // This uses your 'pestivid' bucket name
              Key: objectKey,
              Body: this.recordBlob,
              ContentType: this.recordBlob.type,
              ACL: 'public-read', // <<< THIS LINE MAKES THE OBJECT PUBLICLY READABLE
              Metadata: {
                  'uploaderid': this.currentUserIdentifier,
                  'role': this.role,
                  'crop': this.recordForm.crop.trim(),
                  'pesticide': this.recordForm.pesticide.trim(),
                  'location': this.recordForm.location.trim(),
                  'pesticidecompany': this.recordForm.pesticideCompany.trim(),
                  'purpose': this.recordForm.purpose,
                  'uploadtimestamp': new Date().toISOString(),
                  'videofilesha256': videoFileHash
              }
          };

          try {
              const data = await s3.putObject(params).promise();
              this.uploadCid = objectKey; this.lastUploadedVideoPurpose = this.recordForm.purpose;
              const newVideoData = {
                  cid: objectKey, storageType: 'storj', videoFileHash: videoFileHash, farmerWallet: this.currentUserIdentifier,
                  crop: this.recordForm.crop.trim(), pesticide: this.recordForm.pesticide.trim(), location: this.recordForm.location.trim(),
                  pesticideCompany: this.recordForm.pesticideCompany.trim(), purpose: this.recordForm.purpose, uploadTimestamp: new Date().toISOString()
              };
              this.farmerVideos.unshift(newVideoData);
              this.recordForm = { crop: '', pesticide: '', location: '', pesticideCompany: '', purpose: 'agristream' };
              if (this.recordBlobUrl) URL.revokeObjectURL(this.recordBlobUrl);
              this.recordBlob = null; this.recordBlobUrl = '';
              this.saveDataToLocalStorage();
              if (newVideoData.purpose === 'sell') { this.addNotification(`Video for "${newVideoData.crop}" uploaded to Storj. Redirecting to complete listing.`, 'info'); this.navigateToPageWithParam('farmerSell', 'cid', objectKey); }
              else if (newVideoData.purpose === 'funding') { this.addNotification(`Video for "${newVideoData.crop}" uploaded to Storj. Redirecting to complete request.`, 'info'); this.navigateToPageWithParam('farmerFunding', 'cid', objectKey); }
              else { this.addNotification(`Video for "${newVideoData.crop}" added to AgriStream (Storj)!`, 'success'); }
          } catch (e) {
              this.uploadError = "Storj Upload failed. ";
              if (e.code === 'InvalidAccessKeyId' || e.code === 'SignatureDoesNotMatch') this.uploadError += "Invalid Storj S3 credentials. ";
              else if (e.message && e.message.toLowerCase().includes('cors')) this.uploadError += "CORS policy issue. Check bucket CORS settings in Storj console. ";
              else if (e.code === 'NoSuchBucket') this.uploadError += `Bucket '${this.storjConfig.bucketName}' not found or inaccessible. `;
              else if (e.name === 'NetworkingError') this.uploadError += "Network error. Check connection or Storj endpoint. ";
              this.uploadError += (e.message || "Unknown error");
              console.error("Storj Upload Error Details:", e); alert(this.uploadError);
              this.uploadCid = ''; this.lastUploadedVideoFileHash = '';
          } finally { this.uploading = false; this.showLoadingModal = false; }
      },
      getVideoUrl(objectKeyOrCid, storageType = null) {
          let type = storageType;
          if (!type && objectKeyOrCid) {
              if (typeof objectKeyOrCid === 'string' && (objectKeyOrCid.startsWith('bafy') || objectKeyOrCid.startsWith('Qm'))) type = 'ipfs';
              else if (typeof objectKeyOrCid === 'string' && objectKeyOrCid.includes('/')) type = 'storj';
              else type = 'ipfs';
          }
          if (type === 'storj' && objectKeyOrCid) return `${this.storjConfig.endpoint}/${this.storjConfig.bucketName}/${objectKeyOrCid}`;
          else if (type === 'ipfs' && objectKeyOrCid) return `https://${this.pinataGateway}/ipfs/${objectKeyOrCid}`;
          return "";
      },
      isListed(cid) { return this.farmerListings.some(l => l.cid === cid && l.farmerWallet === this.currentUserIdentifier); },
      isUsedInFunding(cid) { return this.farmerFundingRequests.some(req => req.cid === cid && req.farmerWallet === this.currentUserIdentifier); },
      goToListing(cid) { this.listingForm.cid = cid; this.switchPage('farmerSell'); },
      async createListing() {
          if (!this.isUserAuthenticated) { alert("Log in."); return; }
          this.createdListingId = null; this.listingNotificationSent = false;
          if (!this.listingForm.cid || !this.listingForm.minPrice || !this.listingForm.maxPrice) { alert("Select video & price."); return; }
          const minP = parseFloat(this.listingForm.minPrice); const maxP = parseFloat(this.listingForm.maxPrice);
          if (isNaN(minP) || isNaN(maxP) || minP <= 0 || maxP <= 0 || minP > maxP) { alert("Valid prices."); return; }
          let vid = this.farmerVideos.find(v => v.cid === this.listingForm.cid && v.farmerWallet === this.currentUserIdentifier);
          if (!vid) { alert("Video not found or not yours."); return; }
          if (this.isListed(vid.cid)) { alert("Video already listed."); return; }
          const txHash = await this.simulateTransaction("Creating listing");
          if (!txHash) { alert("Tx failed."); return; }
          let newListing = {
              id: 'lst' + Date.now(), farmerWallet: this.currentUserIdentifier, crop: vid.crop, location: vid.location, pesticide: vid.pesticide || '', pesticideCompany: vid.pesticideCompany || '', cid: vid.cid, storageType: vid.storageType || 'ipfs', videoFileHash: vid.videoFileHash, minPrice: minP, maxPrice: maxP, status: 'active', createdAt: new Date().toISOString(), notificationSent: false, isNew: true, txHash: txHash
          };
          this.farmerListings.unshift({ ...newListing }); this.allListings.unshift({ ...newListing });
          if (this.listingForm.notifyBuyers) { this.notifyBuyersAboutListing(newListing, true); this.listingNotificationSent = true; this.addNotification( `Marketplace Update: New listing for "${newListing.crop}" by ${this.getFarmerDisplayIdentifier(newListing.farmerWallet)}.`, 'info', null, true ); }
          this.createdListingId = txHash; this.listingForm = { cid: '', minPrice: '', maxPrice: '', notifyBuyers: true }; this.saveDataToLocalStorage();
          setTimeout(() => { this.createdListingId = null; this.listingNotificationSent = false; }, 5000);
      },
      fundingProgressPercent(req) { if (!req || !req.amount || req.amount <= 0) return 0; return Math.round(((req.fundedAmount || 0) / req.amount) * 100); },
      createFundingRequest_V1() {
          if (!this.isUserAuthenticated) { alert("Log in."); return; }
          this.createdFundingRequest = false; const form = this.fundingForm; const required = ['title', 'crop', 'acres', 'amount', 'method', 'cid', 'description', 'timeline', 'roi', 'investorShare'];
          if (!form.cid) { alert("Select video."); return; }
          if (required.some(field => !form[field])) { alert("Fill all fields."); return; }
          if (form.acres <= 0 || form.amount <= 0 || form.timeline <= 0 || form.roi <= 0 || form.investorShare <= 0 || form.investorShare > 80) { alert("Valid numbers. Investor share 1-80%."); return; }
          const vid = this.farmerVideos.find(v => v.cid === form.cid && v.farmerWallet === this.currentUserIdentifier);
          if (!vid) { alert("Video not found or not yours."); return; }
          const newRequest = {
              id: 'fr' + Date.now(), farmerWallet: this.currentUserIdentifier, title: form.title.trim(), crop: form.crop.trim(), acres: form.acres, amount: form.amount, method: form.method, cid: form.cid, videoStorageType: vid.storageType || 'ipfs', videoFileHash: vid.videoFileHash, description: form.description.trim(), timeline: form.timeline, roi: form.roi, investorShare: form.investorShare, fundedAmount: 0, status: 'pending', createdAt: new Date().toISOString(), investors: []
          };
          this.farmerFundingRequests.unshift({ ...newRequest }); this.allFundingRequests.unshift({ ...newRequest }); this.createdFundingRequest = true;
          this.addNotification( `Investment Opportunity: New project "${newRequest.title}" by ${this.getFarmerDisplayIdentifier(newRequest.farmerWallet)}.`, 'info', null, true );
          this.fundingForm = { title: '', crop: '', acres: null, amount: null, method: '', cid: '', description: '', timeline: null, roi: null, investorShare: null, notifyInvestors: true }; this.saveDataToLocalStorage();
          setTimeout(() => this.createdFundingRequest = false, 3000);
      },
      cancelFundingRequest_V1(id) { if (!this.isUserAuthenticated) { alert("Log in."); return; } const req = this.farmerFundingRequests.find(r => r.id === id && r.farmerWallet === this.currentUserIdentifier); if (!req) { alert("Request not found/yours."); return;} if (req.fundedAmount > 0) { if (!confirm("Has funding. Cancel refunds (sim). Sure?")) return; } else if (!confirm("Cancel funding request?")) return; this.farmerFundingRequests = this.farmerFundingRequests.filter(r => r.id !== id); this.allFundingRequests = this.allFundingRequests.filter(r => r.id !== id); alert(`Funding request cancelled.`); this.saveDataToLocalStorage(); },
      resetBuyerFilters() { this.buyerFilters = {crop:'', location:'', pesticideCompany: ''}; },
      buyListing(listing) { if (!this.isUserAuthenticated || this.role !== 'buyer') { alert("Login as Buyer."); if (!this.isUserAuthenticated) this.switchPage('loginChoice'); return; } if(this.currentUserIdentifier === listing.farmerWallet) { alert("Cannot buy own listing."); return; } this.selectedListing = listing; this.purchaseAmount = listing.minPrice; this.purchaseStatus = ''; this.purchaseError = ''; this.showBuyModal = true; },
      closeBuyModal() { this.showBuyModal = false; this.selectedListing = null; this.purchaseAmount = null; this.purchaseStatus = ''; this.purchaseError = ''; },
      async processPurchase() {
          if (!this.isUserAuthenticated || !this.selectedListing || !this.purchaseAmount) return;
          this.purchaseStatus = ''; this.purchaseError = '';
          const amount = parseFloat(this.purchaseAmount); const minP = this.selectedListing.minPrice; const maxP = this.selectedListing.maxPrice;
          if (isNaN(amount) || amount < minP || amount > maxP) { this.purchaseError = `Offer ${minP}-${maxP} SOL.`; return; }
          const txHash = await this.simulateTransaction(`Purchasing ${this.selectedListing.crop}`);
          if (!txHash) { this.purchaseError = "Purchase Tx failed."; this.purchaseStatus = ''; return; }
          this.purchaseStatus = `Processing for ${amount} SOL... Tx: ${txHash.substring(0,10)}...`;
          try {
              const newPurchase = {
                  id: 'pur' + Date.now(), buyerWallet: this.currentUserIdentifier, farmerWallet: this.selectedListing.farmerWallet, crop: this.selectedListing.crop, location: this.selectedListing.location, pesticide: this.selectedListing.pesticide, pesticideCompany: this.selectedListing.pesticideCompany || '', cid: this.selectedListing.cid, videoStorageType: this.selectedListing.storageType || 'ipfs', videoFileHash: this.selectedListing.videoFileHash, price: amount, date: new Date().toLocaleDateString(), txHash: txHash
              };
              this.buyerPurchases.unshift(newPurchase); this.allListings = this.allListings.filter(l => l.id !== this.selectedListing.id);
              if (this.role === 'farmer' && this.selectedListing.farmerWallet === this.currentUserIdentifier) { this.farmerListings = this.farmerListings.filter(l => l.id !== this.selectedListing.id); }
              this.addNotification(`Listing "${newPurchase.crop}" purchased!`, 'success'); this.addNotification(`Your listing "${newPurchase.crop}" purchased by ${this.getFarmerDisplayIdentifier(newPurchase.buyerWallet, 6)}...`, 'success', newPurchase.farmerWallet);
              this.purchaseStatus = "Purchase successful!"; this.saveDataToLocalStorage();
              setTimeout(() => { this.closeBuyModal(); }, 2500);
          } catch(err) { this.purchaseError = "Purchase sim failed."; this.purchaseStatus = ''; }
      },
      viewPurchaseVideo(purchase) { this.selectedPurchase = purchase; this.showPurchaseVideo = true; },
      resetInvestorFilters() { this.investorFilters = {crop: '', method: '', minRoi: null, maxAmount: null}; },
      maxInvestmentAmount(project) { if (!project || project.status === 'funded' || project.amount === undefined || project.fundedAmount === undefined) return 0; const remaining = project.amount - (project.fundedAmount || 0); return remaining > 0 ? remaining.toFixed(2) : 0; },
      async investInProject(project) {
          if (!this.isUserAuthenticated || this.role !== 'investor') { alert("Login as Investor."); if(!this.isUserAuthenticated) this.switchPage('loginChoice'); return; }
          const amount = this.investmentAmounts[project.id]; this.$set(this.investmentErrors, project.id, '');
          if (!amount || isNaN(amount) || amount <= 0) { this.$set(this.investmentErrors, project.id, 'Invalid amount.'); return; }
          const maxInvest = parseFloat(this.maxInvestmentAmount(project)); const tolerance = 0.001;
          if (amount > maxInvest + tolerance) { this.$set(this.investmentErrors, project.id, `Max ${maxInvest} SOL.`); return; }
          const preciseAmount = parseFloat(amount.toFixed(2)); const txHash = await this.simulateTransaction(`Investing ${preciseAmount} SOL`);
          if (!txHash) { this.$set(this.investmentErrors, project.id, 'Investment Tx failed.'); return; }
          try {
              const projectInAllIdx = this.allFundingRequests.findIndex(p => p.id === project.id); if (projectInAllIdx === -1) throw new Error("Project not found");
              const updatedProject = { ...this.allFundingRequests[projectInAllIdx] }; updatedProject.fundedAmount = (updatedProject.fundedAmount || 0) + preciseAmount;
              updatedProject.investors = [...(updatedProject.investors || []), { investorId: this.currentUserIdentifier, amount: preciseAmount, txHash: txHash }];
              if (updatedProject.fundedAmount >= updatedProject.amount - tolerance) { updatedProject.status = 'funded'; updatedProject.fundedAmount = updatedProject.amount; } else { updatedProject.status = 'partially_funded'; }
              this.$set(this.allFundingRequests, projectInAllIdx, updatedProject);
              const farmerProjectIndex = this.farmerFundingRequests.findIndex(p => p.id === project.id); if(farmerProjectIndex > -1) { this.$set(this.farmerFundingRequests, farmerProjectIndex, updatedProject); }
              const newInvestment = {
                  id: 'inv' + Date.now(), investorWallet: this.currentUserIdentifier, projectId: project.id, projectTitle: project.title, farmerWallet: project.farmerWallet, crop: project.crop, method: project.method, description: project.description, acres: project.acres, timeline: project.timeline, roi: project.roi, investorShare: project.investorShare, amount: preciseAmount, cid: project.cid, videoStorageType: project.videoStorageType || 'ipfs', videoFileHash: project.videoFileHash, status: 'active', progress: 0, investmentDate: new Date().toLocaleDateString(), txHash: txHash
              };
              this.investorInvestments.unshift(newInvestment);
              const newTransaction = { id: 'tx' + Date.now(), investorWallet: this.currentUserIdentifier, txHash: txHash, type: 'investment', amount: preciseAmount, date: new Date().toLocaleDateString(), projectId: project.id, projectTitle: project.title };
              this.investorTransactions.unshift(newTransaction); this.investorTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
              this.addNotification(`Investment ${preciseAmount} SOL successful!`, 'success'); this.addNotification(`${preciseAmount} SOL from ${this.getFarmerDisplayIdentifier(this.currentUserIdentifier)} for "${project.title}"!`, 'success', project.farmerWallet);
              this.$set(this.investmentAmounts, project.id, null); alert(`Invested ${preciseAmount} SOL in "${project.title}"!`); this.saveDataToLocalStorage();
          } catch (err) { this.$set(this.investmentErrors, project.id, 'Invest sim failed.'); alert("Invest sim failed."); }
      },
      updateInvestmentProgress() { const now = new Date(); this.investorInvestments.forEach(inv => { if (inv.status === 'active' || inv.status === 'growing') { const dateInvested = new Date(inv.investmentDate); const monthsElapsed = (now.getFullYear() - dateInvested.getFullYear())*12 + (now.getMonth() - dateInvested.getMonth()); let progress = 0; if (inv.timeline && inv.timeline > 0) { progress = Math.min(100, Math.max(0, Math.round((monthsElapsed/inv.timeline)*100))); } progress = Math.min(100, Math.max(inv.progress||0, progress + ((inv.progress||0)<95 ? Math.floor(Math.random()*3) : 0) )); inv.progress = progress; if (progress >= 100) { inv.status = 'harvested'; if (!inv.payoutNotified) { const expectedReturn = this.calculateExpectedReturn(inv); const payoutTxHash = 'sim_payout_tx_' + Date.now().toString(16) + Math.random().toString(16).substring(2,10); this.investorTransactions.unshift({ id: 'txp' + Date.now(), investorWallet: inv.investorWallet, txHash: payoutTxHash, type: 'payout', amount: parseFloat(expectedReturn), date: new Date().toLocaleDateString(), projectId: inv.projectId, projectTitle: inv.projectTitle }); this.investorTransactions.sort((a,b) => new Date(b.date) - new Date(a.date)); this.addNotification(`"${inv.projectTitle}" Payout ${expectedReturn} SOL!`, 'success', inv.investorWallet); this.addNotification(`"${inv.projectTitle}" Payout ${expectedReturn} SOL to ${this.getFarmerDisplayIdentifier(inv.investorWallet)}...`, 'info', inv.farmerWallet); inv.payoutNotified = true; this.saveDataToLocalStorage(); } } else if (progress > 0 && inv.status === 'active') { inv.status = 'growing'; } else if (progress === 0 && inv.status !== 'active') { inv.status = 'active'; } } }); },
      viewInvestmentDetails(investment) { this.selectedInvestmentProject = this.allFundingRequests.find(p => p.id === investment.projectId); this.selectedInvestment = { ...investment, description: this.selectedInvestmentProject ? this.selectedInvestmentProject.description : investment.description, updates: this.selectedInvestmentProject ? (this.selectedInvestmentProject.updates || []) : [] }; this.showInvestmentDetailsModal = true; },
      calculateExpectedReturn(investment) { if (!investment || !investment.amount || !investment.roi) return '0.00'; return (investment.amount * (investment.roi / 100)).toFixed(2); },
      solanaExplorerUrl(txHash) { return `https://explorer.solana.com/tx/${txHash}?cluster=devnet`; },
      showFarmerProfile(farmerIdentifier) { if (!farmerIdentifier) return; this.selectedFarmerProfile = null; const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles')) || {}; const farmerPestiVidProfile = userProfiles[farmerIdentifier] || {}; const profileData = { walletAddress: farmerIdentifier, farmName: this.simulateFarmName(farmerIdentifier), bio: this.simulateFarmerBio(farmerIdentifier), email: farmerPestiVidProfile.email || this.simulateUserEmail(farmerIdentifier), memberSince: farmerPestiVidProfile.memberSince || this.simulateMemberSince(farmerIdentifier), fundingRequestCount: this.allFundingRequests.filter(r => r.farmerWallet === farmerIdentifier && (r.status === 'pending' || r.status === 'partially_funded')).length, activeListingCount: this.allListings.filter(l => l.farmerWallet === farmerIdentifier).length, }; this.selectedFarmerProfile = profileData; this.showFarmerProfileModal = true; },
      closeFarmerProfileModal() { this.showFarmerProfileModal = false; this.selectedFarmerProfile = null; },
      simulateUserEmail(id) { return id ? `${id.substring(0, 6)}@pestivid.xyz` : 'user@example.com'; },
      simulateMemberSince(id) { let hash = 0; for (let i = 0; i < (id || '').length; i++) { hash = (hash << 5) - hash + id.charCodeAt(i); hash |= 0; } const daysAgo = Math.abs(hash % 730) + 30; const joinDate = new Date(); joinDate.setDate(joinDate.getDate() - daysAgo); return joinDate.toLocaleDateString(); },
      simulateFarmName(id) { return id ? `Farm ${id.substring(0, 5)}` : "The Good Farm"; },
      simulateFarmerBio(id) { const bios = ["Sustainable ag.", "Family farm & Web3.", "Organic specialist.", "Direct connections.", "Transparency focus."]; let bioHash = 0; for (let i = 0; i < (id || '').length; i++) { bioHash = (bioHash << 5) - bioHash + id.charCodeAt(i); bioHash |= 0; } return bios[Math.abs(bioHash % bios.length)]; },
      selectConversation(convId) { this.activeConversationId = convId; this.markConversationAsRead(convId); this.$nextTick(() => this.scrollToMessageBottom()); },
      sendMessage() { if (!this.messageInputText.trim() || !this.activeConversationId || !this.isUserAuthenticated) return; const conversation = this.conversations.find(c => c.id === this.activeConversationId); if (!conversation) return; const receiverId = conversation.participants.find(p => p !== this.currentUserIdentifier); if (!receiverId) return; const newMessage = { id: 'msg' + Date.now(), conversationId: this.activeConversationId, sender: this.currentUserIdentifier, receiver: receiverId, text: this.messageInputText.trim(), timestamp: new Date().toISOString(), read: false }; this.messages.push(newMessage); conversation.lastMessageSnippet = newMessage.text.substring(0, 35) + (newMessage.text.length > 35 ? '...' : ''); conversation.lastMessageTimestamp = newMessage.timestamp; this.conversations.sort((a, b) => new Date(b.lastMessageTimestamp) - new Date(a.lastMessageTimestamp)); this.addNotification(`New message from ${this.getFarmerDisplayIdentifier(this.currentUserIdentifier)}`, 'info', receiverId); this.messageInputText = ''; this.$nextTick(() => this.scrollToMessageBottom()); this.saveDataToLocalStorage(); },
      startOrGoToConversation(targetIdentifier) { if (!this.isUserAuthenticated || !targetIdentifier ) { if (!this.isUserAuthenticated) { alert("Log in to message."); this.switchPage('loginChoice'); return;} if (!targetIdentifier) { alert("Target missing."); return;} } if (targetIdentifier === this.currentUserIdentifier) { alert("Cannot message self."); return; } const sortedParticipants = [this.currentUserIdentifier, targetIdentifier].sort(); let conversation = this.conversations.find(conv => conv.participants.length === 2 && conv.participants.join(',') === sortedParticipants.join(',')); if (!conversation) { const newConvId = 'conv' + Date.now(); conversation = { id: newConvId, participants: sortedParticipants, lastMessageSnippet: 'Conversation started.', lastMessageTimestamp: new Date().toISOString() }; this.conversations.unshift(conversation); this.conversations.sort((a,b) => new Date(b.lastMessageTimestamp) - new Date(a.lastMessageTimestamp)); this.saveDataToLocalStorage(); } this.switchPage('messaging'); this.$nextTick(() => this.selectConversation(conversation.id)); },
      messageFarmerFromProfile() { if (this.selectedFarmerProfile && this.isUserAuthenticated && this.currentUserIdentifier !== this.selectedFarmerProfile.walletAddress) { const targetUserIdentifier = this.selectedFarmerProfile.walletAddress; this.closeFarmerProfileModal(); this.$nextTick(() => this.startOrGoToConversation(targetUserIdentifier)); } else if (this.selectedFarmerProfile && this.isUserAuthenticated && this.currentUserIdentifier === this.selectedFarmerProfile.walletAddress) { alert("Cannot message self."); } },
      scrollToMessageBottom() { const el = this.$refs.messageContainer; if (el) setTimeout(() => { el.scrollTop = el.scrollHeight; }, 50); },
      getUnreadCountForConversation(convId) { if (!this.isUserAuthenticated) return 0; return this.messages.filter(msg => msg.conversationId === convId && msg.receiver === this.currentUserIdentifier && !msg.read).length; },
      markConversationAsRead(convId) { let changed = false; this.messages.forEach(msg => { if (msg.conversationId === convId && msg.receiver === this.currentUserIdentifier && !msg.read) { msg.read = true; changed = true; } }); if (changed) this.saveDataToLocalStorage(); },
      addNotification(message, type = 'info', recipientIdentifier = null, globalBroadcast = false) {
          if (globalBroadcast && this.isUserAuthenticated) {
              const newNotification = { id: 'notif_global_' + Date.now(), message: message, type: type, timestamp: Date.now(), show: false };
              this.notifications.push(newNotification);
              if (this.recentNotifications.length === 0 || !this.recentNotifications.some(n => n.message === message && Date.now() - n.timestamp < 10000)) {
                  this.showNextToastNotification();
              }
              console.log(`GLOBAL BROADCAST (Demo): ${message}`);
          } else if (recipientIdentifier === null || recipientIdentifier === this.currentUserIdentifier) {
              const newNotification = { id: 'notif_user_' + Date.now(), message: message, type: type, timestamp: Date.now(), show: false };
              this.notifications.push(newNotification);
              if (this.recentNotifications.length === 0) {
                  this.showNextToastNotification();
              }
          } else if (recipientIdentifier) {
              console.log(`(SIM) Targeted Notif for ${recipientIdentifier}: "${message}" by ${this.getFarmerDisplayIdentifier(this.currentUserIdentifier)}`);
          }
      },
      showNextToastNotification() { if (this.recentNotifications.length >= 3 || this.notifications.length === 0) return; const notificationToShow = this.notifications.shift(); this.recentNotifications.push(notificationToShow); this.$nextTick(() => { setTimeout(() => { const index = this.recentNotifications.findIndex(n => n.id === notificationToShow.id); if(index > -1) { this.$set(this.recentNotifications[index], 'show', true); } }, 50); }); notificationToShow.timeoutId = setTimeout(() => this.dismissNotification(notificationToShow.id), 4500); },
      dismissNotification(id) { const index = this.recentNotifications.findIndex(n => n.id === id); if (index > -1) { if (this.recentNotifications[index].timeoutId) clearTimeout(this.recentNotifications[index].timeoutId); this.$set(this.recentNotifications[index], 'show', false); setTimeout(() => { const removeIndex = this.recentNotifications.findIndex(n => n.id === id); if (removeIndex > -1) this.recentNotifications.splice(removeIndex, 1); this.$nextTick(() => this.showNextToastNotification()); }, 400); } },
      notifyBuyersAboutListing(listing, markAsSent = false) { if (markAsSent) {const idx = this.allListings.findIndex(l=>l.id === listing.id); if(idx>-1) this.allListings[idx].notificationSent = true; if(this.role==='farmer') {const fidx = this.farmerListings.findIndex(l=>l.id === listing.id); if(fidx>-1) this.farmerListings[fidx].notificationSent=true;}} this.addNotification(`New listing: "${listing.crop}" from ${this.getFarmerDisplayIdentifier(listing.farmerWallet)}... available!`, 'info'); if (this.role === 'buyer' && this.currentUserIdentifier !== listing.farmerWallet) this.addNotification(`Check new listing for "${listing.crop}"!`, 'info'); console.log(`SIM: Notifying buyers about listing ${listing.id}`); },
      notifyInvestorsAboutFunding(request, markAsSent = false) { if (markAsSent) {/* mark notificationSent */} this.addNotification(`New funding: "${request.title}" by ${this.getFarmerDisplayIdentifier(request.farmerWallet)}... seeking investors!`, 'info'); if (this.role === 'investor' && this.currentUserIdentifier !== request.farmerWallet) this.addNotification(`New project "${request.title}" needs funding!`, 'info'); console.log(`SIM: Notifying investors about funding ${request.id}`); },
      saveDataToLocalStorage() { localStorage.setItem('pestiVidAppData', JSON.stringify({ allListings: this.allListings, allFundingRequests: this.allFundingRequests, farmerVideos: this.getAllFarmerVideos(), buyerPurchases: this.getAllBuyerPurchases(), investorInvestments: this.getAllInvestorInvestments(), investorTransactions: this.getAllInvestorTransactions(), messages: this.messages, conversations: this.conversations, chatMessages: this.chatMessages, avatarChatMessages: this.avatar.chatMessages, })); },
      getAllFarmerVideos() { const data = JSON.parse(localStorage.getItem('pestiVidAppData') || '{}'); let all = data.farmerVideos || []; if (this.isUserAuthenticated && this.farmerVideos.length > 0) { const userCIDs = new Set(this.farmerVideos.map(v => v.cid)); all = all.filter(v => !userCIDs.has(v.cid) || v.farmerWallet !== this.currentUserIdentifier); all.push(...this.farmerVideos); } return [...new Map(all.map(item => [item.cid + item.farmerWallet, item])).values()]; },
      getAllBuyerPurchases() { const data = JSON.parse(localStorage.getItem('pestiVidAppData') || '{}'); let all = data.buyerPurchases || []; if (this.isUserAuthenticated && this.buyerPurchases.length > 0) { const userIDs = new Set(this.buyerPurchases.map(p => p.id)); all = all.filter(p => !userIDs.has(p.id) || p.buyerWallet !== this.currentUserIdentifier); all.push(...this.buyerPurchases); } return [...new Map(all.map(item => [item.id, item])).values()]; },
      getAllInvestorInvestments() { const data = JSON.parse(localStorage.getItem('pestiVidAppData') || '{}'); let all = data.investorInvestments || []; if (this.isUserAuthenticated && this.investorInvestments.length > 0) { const userIDs = new Set(this.investorInvestments.map(i => i.id)); all = all.filter(i => !userIDs.has(i.id) || i.investorWallet !== this.currentUserIdentifier); all.push(...this.investorInvestments); } return [...new Map(all.map(item => [item.id, item])).values()]; },
      getAllInvestorTransactions() { const data = JSON.parse(localStorage.getItem('pestiVidAppData') || '{}'); let all = data.investorTransactions || []; if (this.isUserAuthenticated && this.investorTransactions.length > 0) { const userIDs = new Set(this.investorTransactions.map(i => i.id)); all = all.filter(i => !userIDs.has(i.id) || i.investorWallet !== this.currentUserIdentifier); all.push(...this.investorTransactions); } return [...new Map(all.map(item => [item.id, item])).values()]; },
      loadDataFromLocalStorage() {
        const savedData = localStorage.getItem('pestiVidAppData');
        if (savedData) {
            try {
                const appData = JSON.parse(savedData);
                this.allListings = appData.allListings || [];
                this.allFundingRequests = appData.allFundingRequests || [];
                this.messages = appData.messages || [];
                this.conversations = appData.conversations || [];
                this.chatMessages = appData.chatMessages || [];
                this.avatar.chatMessages = appData.avatarChatMessages || [];

                if (this.current === 'farmerChatbot') this.initializeChatbot();
                if (!this.currentUserIdentifier) {
                    this.farmerVideos = []; this.farmerListings = []; this.farmerFundingRequests = [];
                    this.buyerPurchases = []; this.investorInvestments = []; this.investorTransactions = [];
                } else {
                    this.filterDataForCurrentUser();
                }
            } catch (e) {
                console.error("Error loading data from localStorage:", e);
                localStorage.removeItem('pestiVidAppData');
                this.loadDemoDataIfNeeded();
            }
        } else {
            this.loadDemoDataIfNeeded();
        }
        const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles')) || {};
        if (this.currentUserIdentifier && userProfiles[this.currentUserIdentifier]) {
            const profile = userProfiles[this.currentUserIdentifier];
            this.role = profile.role; this.userName = profile.name;
            this.userEmail = profile.email; this.userPhone = profile.phone || '';
            this.memberSince = profile.memberSince || new Date().toLocaleDateString();
        }
      },
      filterDataForCurrentUser() { const appData = JSON.parse(localStorage.getItem('pestiVidAppData') || '{}'); if (!this.isUserAuthenticated) { this.farmerVideos = []; this.farmerListings = []; this.farmerFundingRequests = []; this.buyerPurchases = []; this.investorInvestments = []; this.investorTransactions = []; this.activeConversationId = null; this.messages = appData.messages || []; this.conversations = appData.conversations || []; return; } if (this.role === 'farmer') { this.farmerVideos = (appData.farmerVideos || []).filter(v => v.farmerWallet === this.currentUserIdentifier).map(v => ({...v, purpose: v.purpose || 'agristream'})); this.farmerListings = this.allListings.filter(l => l.farmerWallet === this.currentUserIdentifier); this.farmerFundingRequests = this.allFundingRequests.filter(r => r.farmerWallet === this.currentUserIdentifier); } else { this.farmerVideos = []; this.farmerListings = []; this.farmerFundingRequests = []; } if (this.role === 'buyer') { this.buyerPurchases = (appData.buyerPurchases || []).filter(p => p.buyerWallet === this.currentUserIdentifier); } else { this.buyerPurchases = []; } if (this.role === 'investor') { this.investorInvestments = (appData.investorInvestments || []).filter(i => i.investorWallet === this.currentUserIdentifier); this.investorTransactions = (appData.investorTransactions || []).filter(t => t.investorWallet === this.currentUserIdentifier); this.updateInvestmentProgress(); } else { this.investorInvestments = []; this.investorTransactions = []; } this.messages = (appData.messages || []).filter(msg => msg.sender === this.currentUserIdentifier || msg.receiver === this.currentUserIdentifier); this.conversations = (appData.conversations || []).filter(conv => conv.participants.includes(this.currentUserIdentifier)); if (this.activeConversationId) { const activeConv = this.conversations.find(c => c.id === this.activeConversationId); if (!activeConv || !activeConv.participants.includes(this.currentUserIdentifier)) { this.activeConversationId = null; } } },
      loadDemoDataIfNeeded() {
        let appDataString = localStorage.getItem('pestiVidAppData');
        let loadFreshDemo = true;
        if (appDataString) {
          try {
            const existingData = JSON.parse(appDataString);
            const hasStorageTypeStructure = (arr) => arr && arr.length > 0 && arr.every(item => typeof item.storageType === 'string' || typeof item.videoStorageType === 'string' || item.storageType === undefined || item.videoStorageType === undefined); // Allow undefined for older data

            if ( hasStorageTypeStructure(existingData.allListings) && hasStorageTypeStructure(existingData.allFundingRequests) && hasStorageTypeStructure(existingData.farmerVideos) &&
                 hasStorageTypeStructure(existingData.buyerPurchases) && hasStorageTypeStructure(existingData.investorInvestments) && (existingData.allFundingRequests?.length > 0 || existingData.allListings?.length > 0 || existingData.farmerVideos?.length > 0) ) {
              this.allListings = (existingData.allListings || []).map(l => ({...l, storageType: l.storageType || 'ipfs'})); // Default to ipfs if missing
              this.allFundingRequests = (existingData.allFundingRequests || []).map(r => ({...r, videoStorageType: r.videoStorageType || 'ipfs'}));
              this.messages = existingData.messages || [];
              this.conversations = existingData.conversations || [];
              this.chatMessages = existingData.chatMessages || [];
              this.avatar.chatMessages = existingData.avatarChatMessages || [];
              const allFarmerVideosFromStorage = (existingData.farmerVideos || []).map(v => ({...v, storageType: v.storageType || 'ipfs'}));
              this.farmerVideos = allFarmerVideosFromStorage.filter(v => this.isUserAuthenticated && v.farmerWallet === this.currentUserIdentifier);
              this.filterDataForCurrentUser(); // This will also update buyerPurchases, investorInvestments etc based on filtered allListings/allFundingRequests
              loadFreshDemo = false;
              console.log("Existing PestiVid data found. Loaded from localStorage. Ensured storageType defaults.");
            } else {
               console.log("Existing PestiVid data incomplete or missing storageType structure. Will load fresh demo data.");
            }
          } catch(e) {
            console.error("Error parsing existing demo data, loading fresh demo.", e);
          }
        }

        if (loadFreshDemo) {
          console.log("Loading/Reloading PestiVid Demo Data with Storj and IPFS examples.");
          const storjVideoKey1 = 'videos/oid_farm_1/demokey_storj_tomatoes.webm';
          const storjVideoKey2 = 'videos/oid_farm_1/demokey_storj_strawberries.mkv';
          const ipfsVideoCID = 'bafybeidm6b63qzflosp72huhxsqpmsdcy6flgksftiyi2jekwnkoge5t5u'; // Keep an IPFS example
          const oneDayAgo = new Date(Date.now() - (24*60*60*1000)).toISOString();
          const threeDaysAgo = new Date(Date.now() - (3*24*60*60*1000)).toISOString();

          const demoFarmer1 = 'oid_farmer_1_sub'; const demoFarmer2 = 'sol_farmer_2_addr';
          const demoInvestor1 = 'oid_investor_1_sub'; const demoBuyer1 = 'sol_buyer_1_addr';

          const demoFarmerVideos = [
              { farmerWallet: demoFarmer1, cid: storjVideoKey1, storageType: 'storj', videoFileHash: 'demo_sha256_hash_tomatoes_storj', crop: 'Tomatoes (Storj)', pesticide: 'Copper Spray', location: 'West Field', pesticideCompany: 'AgriSource', purpose: 'sell', uploadTimestamp: oneDayAgo},
              { farmerWallet: demoFarmer1, cid: storjVideoKey2, storageType: 'storj', videoFileHash: 'demo_sha256_hash_strawberries_storj', crop: 'Strawberries (Storj)', pesticide: 'Ladybugs', location: 'South Plot', pesticideCompany: 'NatureFirst', purpose: 'funding', uploadTimestamp: oneDayAgo},
              { farmerWallet: demoFarmer2, cid: ipfsVideoCID, storageType: 'ipfs', videoFileHash: 'demo_sha256_hash_lettuce_ipfs', crop: 'Lettuce (IPFS)', pesticide: 'Nutrient Solution', location: 'Hydro Unit 1', pesticideCompany: 'HydroGrow', purpose: 'agristream', uploadTimestamp: oneDayAgo},
          ];
          this.allListings = [
              { id: 'lst_demo1', farmerWallet: demoFarmer1, crop: 'Tomatoes (Storj)', location: 'West Field', pesticide: 'Copper Spray', pesticideCompany: 'AgriSource', cid: storjVideoKey1, storageType: 'storj', videoFileHash: 'demo_sha256_hash_tomatoes_storj', minPrice: 0.8, maxPrice: 1.2, status: 'active', createdAt: oneDayAgo, isNew: true, txHash: 'sim_lst_tx_1' },
              { id: 'lst_demo2', farmerWallet: demoFarmer2, crop: 'Peppers (IPFS)', location: 'Greenhouse 3', pesticide: 'Neem Oil', pesticideCompany: 'Organics Inc.', cid: ipfsVideoCID, storageType: 'ipfs', videoFileHash: 'demo_sha256_hash_peppers_ipfs', minPrice: 1.0, maxPrice: 1.5, status: 'active', createdAt: threeDaysAgo, isNew: false, txHash: 'sim_lst_tx_2' },
          ];
          this.allFundingRequests = [
              { id: 'fr_demo1', farmerWallet: demoFarmer1, title: 'Organic Strawberry Expansion (Storj)', crop: 'Strawberries (Storj)', acres: 2.5, amount: 25, method: 'organic', cid: storjVideoKey2, videoStorageType: 'storj', videoFileHash: 'demo_sha256_hash_strawberries_storj', description: 'Expanding organic strawberry fields...', timeline: 6, roi: 18, investorShare: 20, fundedAmount: 10, status: 'partially_funded', createdAt: oneDayAgo, investors: [{investorId: demoInvestor1, amount: 10, txHash:'sim_inv_tx_demo1'}], updates: [{id:'upd1', date: '1 week ago', text:'Initial tilling complete.'}], txHash: 'sim_fr_tx_1' },
              { id: 'fr_demo2', farmerWallet: demoFarmer2, title: 'Hydroponic Lettuce Setup (IPFS)', crop: 'Lettuce (IPFS)', acres: 0.5, amount: 40, method: 'hydroponic', cid: ipfsVideoCID, videoStorageType: 'ipfs', videoFileHash: 'demo_sha256_hash_lettuce_ipfs', description: 'Setting up hydroponic system...', timeline: 4, roi: 25, investorShare: 30, fundedAmount: 0, status: 'pending', createdAt: oneDayAgo, investors: [], updates: [], txHash: 'sim_fr_tx_2' },
          ];
          const demoBuyerPurchases = [ { id: 'pur_demo1', buyerWallet: demoBuyer1, farmerWallet: demoFarmer1, crop: 'Tomatoes (Storj)', location: 'West Field', pesticide: 'Copper Spray', pesticideCompany: 'AgriSource', cid: storjVideoKey1, videoStorageType: 'storj', videoFileHash: 'demo_sha256_hash_tomatoes_storj', price: 0.9, date: 'March 10, 2024', txHash: 'sim_pur_tx_demo1' }, ];
          const demoInvestorInvestments = [ { id: 'inv_demo1', investorWallet: demoInvestor1, projectId: 'fr_demo1', projectTitle: 'Organic Strawberry Expansion (Storj)', farmerWallet: demoFarmer1, crop: 'Strawberries (Storj)', method: 'organic', description: 'Expanding organic strawberry fields...', acres: 2.5, timeline: 6, roi: 18, investorShare: 20, amount: 10, cid: storjVideoKey2, videoStorageType: 'storj', videoFileHash: 'demo_sha256_hash_strawberries_storj', status: 'growing', progress: 30, investmentDate: 'February 15, 2024', txHash: 'sim_inv_tx_demo1' } ];
          const demoInvestorTransactions = [ { id: 'tx_demo1', investorWallet: demoInvestor1, txHash: 'sim_inv_tx_demo1', type: 'investment', amount: 10, date: 'February 15, 2024', projectId: 'fr_demo1', projectTitle: 'Organic Strawberry Expansion (Storj)' }, ];
          const nowTime = Date.now(); const minToMs = (min) => 1000 * 60 * min; const conv1Id = 'conv_demo_f1_i1';
          const demoConversations = [ { id: conv1Id, participants: [demoFarmer1, demoInvestor1].sort(), lastMessageSnippet: 'Sounds good, will review the project terms tonight.', lastMessageTimestamp: new Date(nowTime - minToMs(5)).toISOString() } ];
          const demoMessages = [
              { id: 'msg_demo1a', conversationId: conv1Id, sender: demoFarmer1, receiver: demoInvestor1, text: 'Hi Investor, thanks for showing interest in the Strawberry Expansion project. Let me know if you have questions.', timestamp: new Date(nowTime - minToMs(10)).toISOString(), read: true },
              { id: 'msg_demo1b', conversationId: conv1Id, sender: demoInvestor1, receiver: demoFarmer1, text: 'Hello Farmer! Yes, the project looks promising. What are the projected returns again?', timestamp: new Date(nowTime - minToMs(8)).toISOString(), read: true },
              { id: 'msg_demo1c', conversationId: conv1Id, sender: demoFarmer1, receiver: demoInvestor1, text: 'We are projecting an 18% ROI over 6 months, with a 20% profit share for investors.', timestamp: new Date(nowTime - minToMs(6)).toISOString(), read: true },
              { id: 'msg_demo1d', conversationId: conv1Id, sender: demoInvestor1, receiver: demoFarmer1, text: 'Sounds good, will review the project terms tonight.', timestamp: new Date(nowTime - minToMs(5)).toISOString(), read: false }
          ];
          const demoAvatarChatMessages = [
            { id: 'avatar_demo_greet_1', sender: 'bot', text: "Hi! I'm PestiVid Helper. How can I assist you today on our platform?", timestamp: new Date(nowTime - minToMs(1)).toISOString(), readByUser: true }
          ];

          localStorage.setItem('pestiVidAppData', JSON.stringify({
              allListings: this.allListings, allFundingRequests: this.allFundingRequests,
              farmerVideos: demoFarmerVideos, buyerPurchases: demoBuyerPurchases,
              investorInvestments: demoInvestorInvestments, investorTransactions: demoInvestorTransactions,
              messages: demoMessages, conversations: demoConversations,
              chatMessages: [],
              avatarChatMessages: demoAvatarChatMessages
          }));
          const demoProfiles = {};
          demoProfiles[demoFarmer1] = { role: 'farmer', name: 'Alice Farmer (OID)', email: 'alice.oid@pestivid.sim', phone: '555-0101', memberSince: this.simulateMemberSince(demoFarmer1), authMethod: 'orangeId'};
          demoProfiles[demoFarmer2] = { role: 'farmer', name: 'Bob Farmer (SOL)', email: 'bob.sol@pestivid.sim', phone: '555-0102', memberSince: this.simulateMemberSince(demoFarmer2), authMethod: 'solana'};
          demoProfiles[demoInvestor1] = { role: 'investor', name: 'Charlie Investor (OID)', email: 'charlie.oid@pestivid.sim', phone: '555-0103', memberSince: this.simulateMemberSince(demoInvestor1), authMethod: 'orangeId'};
          demoProfiles[demoBuyer1] = { role: 'buyer', name: 'Dana Buyer (SOL)', email: 'dana.sol@pestivid.sim', phone: '555-0104', memberSince: this.simulateMemberSince(demoBuyer1), authMethod: 'solana'};
          localStorage.setItem('pestiVidUserProfiles', JSON.stringify(demoProfiles));
          this.filterDataForCurrentUser();
        }
      },
      scrollToAndHighlightAgriStreamVideo() { if (!this.targetAgriStreamVideoCid) return; this.highlightedAgriStreamVideoCid = this.targetAgriStreamVideoCid; this.$nextTick(() => { const videoCardRef = this.$refs[`videoCard-${this.targetAgriStreamVideoCid}`]; if (videoCardRef && videoCardRef[0]) { videoCardRef[0].scrollIntoView({ behavior: 'smooth', block: 'center' }); setTimeout(() => { this.highlightedAgriStreamVideoCid = null; this.targetAgriStreamVideoCid = null; }, 2500); } else { this.highlightedAgriStreamVideoCid = null; this.targetAgriStreamVideoCid = null; } }); },
      getOtherParticipantInitial(conv) { if (!conv || !this.isUserAuthenticated) return '?'; const otherP = conv.participants.find(p => p !== this.currentUserIdentifier); if (!otherP) return '?'; return this.getFarmerDisplayIdentifier(otherP, 1).toUpperCase(); },
      getOtherParticipantDisplayAddress(conv) { if (!conv || !this.isUserAuthenticated) return 'Unknown User'; const otherP = conv.participants.find(p => p !== this.currentUserIdentifier); return this.getFarmerDisplayIdentifier(otherP); },
      formatTimestamp(isoString, short = false) { if (!isoString) return ''; const date = new Date(isoString); if (short) { const now = new Date(); const diffMs = now - date; const diffMins = Math.round(diffMs / 60000); const diffHours = Math.round(diffMins / 60); const diffDays = Math.round(diffHours / 24); if (diffMins < 1) return 'now'; if (diffMins < 60) return `${diffMins}m`; if (diffHours < 24) return `${diffHours}h`; if (diffDays < 7) return `${diffDays}d`; return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }); } return date.toLocaleString(undefined, { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }); },
      async handlePlantImageUpload(event) {
          const file = event.target.files[0];
          if (file) {
              this.plantImageFile = file;
              this.plantImageUrl = URL.createObjectURL(file);
              this.plantImageMimeType = file.type;
              this.analysisResultText = '';
              this.parsedAnalysis = { plantName: null, diseaseName: null, treatmentRecommended: null };
              this.analysisErrorText = '';
              console.log("Plant image selected:", file.name, file.type);
          }
      },
      async analyzePlant() {
          if (!this.plantImageFile) { alert("Please upload a plant image first."); return; }
          if (!this.geminiApiKey || this.geminiApiKey === 'YOUR_GEMINI_API_KEY_PLACEHOLDER' || this.geminiApiKey.includes('AIzaSyDK')) { // Added more specific check for placeholder
              this.analysisErrorText = "Gemini API Key not configured or is a placeholder. Analysis cannot proceed.";
              alert(this.analysisErrorText); return;
          }
          this.analysisInProgress = true; this.analysisResultText = ''; this.parsedAnalysis = { plantName: null, diseaseName: null, treatmentRecommended: null }; this.analysisErrorText = ''; this.showLoadingModal = true; this.loadingMessage = "Analyzing plant image with AI...";
          const reader = new FileReader();
          reader.readAsDataURL(this.plantImageFile);
          reader.onloadend = async () => {
              const base64Data = reader.result.split(',')[1];
              const requestBody = {
                  contents: [{
                      parts: [
                          { text: "Analyze this image of a plant. Identify the plant, any visible diseases, and suggest organic and common chemical pesticide treatments. Format your response strictly as: PLANT: [Plant Name]; DISEASE: [Disease Name or Healthy]; TREATMENT: [Detailed Treatment Suggestions]." },
                          { inline_data: { mime_type: this.plantImageMimeType, data: base64Data } }
                      ]
                  }],
                  generationConfig: { "temperature": 0.4, "topK": 32, "topP": 1, "maxOutputTokens": 1024, }
              };
              try {
                  const response = await axios.post(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro-vision:generateContent?key=${this.geminiApiKey}`, requestBody);
                  if (response.data && response.data.candidates && response.data.candidates[0] && response.data.candidates[0].content && response.data.candidates[0].content.parts && response.data.candidates[0].content.parts[0]) {
                      this.analysisResultText = response.data.candidates[0].content.parts[0].text;
                      this.parseAnalysisResult(this.analysisResultText);
                  } else { throw new Error("Unexpected response structure from Gemini API."); }
              } catch (error) {
                  console.error("Error analyzing plant with Gemini:", error);
                  this.analysisErrorText = "Error during analysis: " + (error.response ? JSON.stringify(error.response.data) : error.message);
                  this.addNotification("Plant analysis failed. " + this.analysisErrorText, "error");
              } finally {
                  this.analysisInProgress = false; this.showLoadingModal = false; this.loadingMessage = "";
                  if (!this.parsedAnalysis.plantName && this.analysisResultText) {
                      this.addNotification("AI analysis complete. Could not fully parse the result, showing raw output.", "warning");
                  } else if (this.parsedAnalysis.plantName) {
                      this.addNotification("Plant analysis complete!", "success");
                  }
              }
          };
          reader.onerror = (error) => { console.error("FileReader error:", error); this.analysisErrorText = "Error reading image file."; this.analysisInProgress = false; this.showLoadingModal = false; };
      },
      parseAnalysisResult(text) {
          this.parsedAnalysis = { plantName: "Unknown", diseaseName: "Unknown", treatmentRecommended: "Could not parse suggestions." };
          if (!text || typeof text !== 'string') return;
          const plantMatch = text.match(/PLANT:\s*([^;]+)/i);
          const diseaseMatch = text.match(/DISEASE:\s*([^;]+)/i);
          const treatmentMatch = text.match(/TREATMENT:\s*(.+)/is); // Use 's' flag for dotall
          if (plantMatch && plantMatch[1]) this.parsedAnalysis.plantName = plantMatch[1].trim();
          if (diseaseMatch && diseaseMatch[1]) this.parsedAnalysis.diseaseName = diseaseMatch[1].trim();
          if (treatmentMatch && treatmentMatch[1]) this.parsedAnalysis.treatmentRecommended = treatmentMatch[1].trim();
          if (this.parsedAnalysis.plantName === "Unknown" && this.parsedAnalysis.diseaseName === "Unknown" && text.toLowerCase().includes("healthy")) { this.parsedAnalysis.diseaseName = "Healthy"; }
      },
      renderMarkdown(text) { return text ? marked.parse(text) : ''; },
      initializeChatbot() {
          if (this.current === 'farmerChatbot' && this.isUserAuthenticated && this.role === 'farmer') {
              if (this.chatMessages.length === 0 || (this.chatMessages.length === 1 && this.chatMessages[0].sender === 'bot' && this.chatMessages[0].text.includes("Hello! I'm AgriBot"))) {
                  this.chatMessages = [{ id: Date.now(), sender: 'bot', text: "Hello! I'm AgriBot, your PestiVid farming assistant. How can I help you today? For example, you can ask about tomato blight treatment or when to plant strawberries." }];
              }
              this.$nextTick(() => this.scrollToChatBottom());
          }
      },
      async sendChatMessage() {
          if (!this.chatInput.trim() || this.isGroqLoading) return;
          if (!this.groqApiKey || this.groqApiKey === "YOUR_GROQ_API_KEY" || this.groqApiKey.includes("gsk_")) { // Added more specific check for placeholder
             // this.addNotification("AgriBot API Key not configured or is a placeholder.", "error");
             // this.isGroqLoading = false; return;
             // SIMULATED RESPONSE FOR DEMO WITHOUT REAL KEY
             const userMessageText = this.chatInput.trim();
             const userMessage = { id: Date.now() + '_user', sender: 'user', text: userMessageText };
             this.chatMessages.push(userMessage);
             this.chatInput = '';
             this.isGroqLoading = true;
             this.$nextTick(() => this.scrollToChatBottom());
             setTimeout(() => {
                let botResponseText = "I'm in demo mode. If you asked about '" + userMessageText.substring(0,20) + "...', I'd normally give a detailed answer here!";
                if (userMessageText.toLowerCase().includes("hello") || userMessageText.toLowerCase().includes("hi")) {
                    botResponseText = "Hello there! How can I assist you with your farming needs today?";
                } else if (userMessageText.toLowerCase().includes("tomato blight")) {
                    botResponseText = "For tomato blight, consider using copper-based fungicides or bio-fungicides. Ensure good air circulation and remove affected leaves promptly. For more details, consult local agricultural guidelines.";
                } else if (userMessageText.toLowerCase().includes("pestivid features")) {
                    botResponseText = "PestiVid allows farmers to upload videos of their crops for transparency, sell produce on the marketplace, and seek funding. Buyers can view these videos before purchasing, and investors can fund projects.";
                }
                const botMessage = { id: Date.now() + '_bot_sim', sender: 'bot', text: botResponseText };
                this.chatMessages.push(botMessage);
                this.isGroqLoading = false;
                this.$nextTick(() => this.scrollToChatBottom());
                this.saveDataToLocalStorage();
             }, 1500);
             return; // End of simulated response
          }
          const userMessage = { id: Date.now() + '_user', sender: 'user', text: this.chatInput.trim() };
          this.chatMessages.push(userMessage);
          const currentInput = this.chatInput; this.chatInput = ''; this.isGroqLoading = true; this.$nextTick(() => this.scrollToChatBottom());

          const messagesPayload = this.chatMessages.map(msg => ({ role: msg.sender === 'user' ? 'user' : 'assistant', content: msg.text }));
          messagesPayload.unshift({ role: 'system', content: this.groqSystemPrompt });

          try {
              const response = await axios.post('https://api.groq.com/openai/v1/chat/completions', {
                  messages: messagesPayload,
                  model: "llama3-8b-8192", // Or "mixtral-8x7b-32768"
                  temperature: 0.7, max_tokens: 1024, top_p: 1, stream: false,
              }, { headers: { 'Authorization': `Bearer ${this.groqApiKey}`, 'Content-Type': 'application/json' } });

              if (response.data && response.data.choices && response.data.choices[0] && response.data.choices[0].message) {
                  const botMessage = { id: Date.now() + '_bot', sender: 'bot', text: response.data.choices[0].message.content };
                  this.chatMessages.push(botMessage);
              } else { throw new Error("Unexpected response structure from Groq API."); }
          } catch (error) {
              console.error("Error with Groq API:", error);
              const errorText = "Sorry, I couldn't get a response from AgriBot. " + (error.response ? JSON.stringify(error.response.data.error || error.response.data) : error.message);
              this.chatMessages.push({ id: Date.now() + '_bot_error', sender: 'bot', text: errorText });
              this.addNotification(errorText, "error");
          } finally {
              this.isGroqLoading = false; this.$nextTick(() => this.scrollToChatBottom());
              this.saveDataToLocalStorage();
          }
      },
      scrollToChatBottom() { const container = this.$refs.chatbotMessagesContainer; if (container) container.scrollTop = container.scrollHeight; },
      // --- AVATAR METHODS ---
      toggleAvatarExpansion(forceState = null) {
          this.avatar.expanded = forceState !== null ? forceState : !this.avatar.expanded;
          if (this.avatar.expanded) {
              this.avatar.state = 'listening';
              this.markAvatarMessagesAsRead();
              this.$nextTick(() => this.scrollToAvatarMessagesBottom());
              this.updateAvatarContextAndQuickActions();
              if (this.avatar.chatMessages.length === 0 || (this.avatar.chatMessages.length === 1 && this.avatar.chatMessages[0].text.includes("Hi! I'm PestiVid Helper"))) {
                  this.addAvatarMessage("Hi! I'm PestiVid Helper. How can I assist you today on the PestiVid platform?", 'bot');
              }
          } else {
              this.avatar.state = 'idle';
              if (this.speechRecognition && this.avatar.isListening) {
                  this.speechRecognition.stop();
                  this.avatar.isListening = false;
              }
          }
      },
      addAvatarMessage(text, sender, isRead = false) {
          const newMessage = { id: 'avatar_msg_' + Date.now() + '_' + sender, text, sender, timestamp: Date.now(), readByUser: sender === 'user' ? true : isRead };
          this.avatar.chatMessages.push(newMessage);
          this.$nextTick(() => this.scrollToAvatarMessagesBottom());
          if (sender === 'bot' && !this.avatar.expanded && this.avatar.state !== 'talking') { // Avoid changing state if avatar is speaking via TTS
              // this.avatar.state = 'idle'; // Or 'notifying' if you add such a state
          }
          this.saveDataToLocalStorage(); // Save avatar chat messages
      },
      async sendAvatarMessage() {
          if (!this.avatar.userInput.trim() || this.avatar.isProcessing) return;
          if (!this.groqApiKey || this.groqApiKey === "YOUR_GROQ_API_KEY" || !this.groqApiKey.includes("gsk_")) {
             // this.addNotification("Avatar Helper API Key not configured or is placeholder.", "error");
             // this.avatar.isProcessing = false;
             // SIMULATED RESPONSE FOR AVATAR DEMO WITHOUT REAL KEY
             const userText = this.avatar.userInput.trim();
             this.addAvatarMessage(userText, 'user');
             this.avatar.userInput = '';
             this.avatar.isProcessing = true;
             this.avatar.state = 'thinking';
             this.avatar.quickActions = [];
             setTimeout(() => {
                let botResponseText = `Thanks for asking about "${userText.substring(0,20)}...". As a demo avatar, I'm giving a general reply. On the ${this.current} page, you can... [example action].`;
                 if (userText.toLowerCase().includes("navigate to") || userText.toLowerCase().includes("go to")) {
                    let targetPage = null;
                    if (userText.toLowerCase().includes("upload")) targetPage = 'farmerPestiVid';
                    else if (userText.toLowerCase().includes("marketplace")) targetPage = 'buyerAgriSell';
                    else if (userText.toLowerCase().includes("profile")) targetPage = 'userProfile';
                    if (targetPage) {
                        botResponseText = `Okay, I can take you to the ${targetPage.replace('farmer', '').replace('buyer', '').replace('user', '')} page.`;
                        this.handleAvatarQuickAction({ label: `Go to ${targetPage}`, targetPage: targetPage });
                    } else {
                         botResponseText = "I can help you navigate. Which page would you like to go to? (e.g., Upload, Marketplace, Profile)";
                    }
                 } else if (userText.toLowerCase().includes("hello") || userText.toLowerCase().includes("hi")) {
                    botResponseText = "Hello! I'm PestiVid Helper. How can I assist you with the platform features today?";
                 }
                this.addAvatarMessage(botResponseText, 'bot');
                this.speakAvatarResponse(botResponseText);
                this.avatar.isProcessing = false;
                if (!this.avatar.isListening) this.avatar.state = 'listening';
                this.saveDataToLocalStorage();
             }, 1800);
             return; // End of simulated response
          }

          const userText = this.avatar.userInput.trim();
          this.addAvatarMessage(userText, 'user');
          this.avatar.userInput = '';
          this.avatar.isProcessing = true;
          this.avatar.state = 'thinking';
          this.avatar.quickActions = [];

          const messagesPayload = this.avatar.chatMessages.map(msg => ({ role: msg.sender === 'user' ? 'user' : 'assistant', content: msg.text }));
          let systemPromptContent = this.avatar.systemPrompt;
          if (this.avatar.currentContextText) {
              systemPromptContent += `\n\nCURRENT PAGE CONTEXT: The user is currently on the '${this.current}' page of PestiVid. ${this.avatar.currentContextText}`;
          }
          messagesPayload.unshift({ role: 'system', content: systemPromptContent });

          try {
              const response = await axios.post('https://api.groq.com/openai/v1/chat/completions', {
                  messages: messagesPayload, model: "llama3-8b-8192", temperature: 0.6, max_tokens: 250, top_p: 1, stream: false,
              }, { headers: { 'Authorization': `Bearer ${this.groqApiKey}`, 'Content-Type': 'application/json' } });

              if (response.data && response.data.choices && response.data.choices[0] && response.data.choices[0].message) {
                  const botResponseText = response.data.choices[0].message.content;
                  this.addAvatarMessage(botResponseText, 'bot');
                  this.parseAvatarResponseForActions(botResponseText);
                  this.speakAvatarResponse(botResponseText);
              } else { throw new Error("Unexpected response structure from Groq API for Avatar."); }
          } catch (error) {
              console.error("Error with Groq API for Avatar:", error);
              const errorText = "Sorry, I couldn't get a response. " + (error.response ? JSON.stringify(error.response.data.error || error.response.data) : error.message);
              this.addAvatarMessage(errorText, 'bot');
              this.addNotification("Avatar helper error: " + errorText, "error");
          } finally {
              this.avatar.isProcessing = false;
              if (!this.avatar.isListening) this.avatar.state = 'listening';
              this.saveDataToLocalStorage();
          }
      },
      parseAvatarResponseForActions(responseText) {
        // Example: if responseText contains "[action:Go to PestiVid Upload]", create a quick action.
        // This is a very basic parser, can be made more robust.
        const actionRegex = /\[action:([^\]]+)\]/gi;
        let match;
        const newQuickActions = [];
        while ((match = actionRegex.exec(responseText)) !== null) {
            const actionLabel = match[1].trim();
            let actionTarget = '';
            if (actionLabel.toLowerCase().includes('upload') || actionLabel.toLowerCase().includes('pestivid')) actionTarget = 'farmerPestiVid';
            else if (actionLabel.toLowerCase().includes('marketplace') || actionLabel.toLowerCase().includes('buy')) actionTarget = 'buyerAgriSell';
            else if (actionLabel.toLowerCase().includes('funding') && this.role === 'farmer') actionTarget = 'farmerFunding';
            else if (actionLabel.toLowerCase().includes('projects') && this.role === 'investor') actionTarget = 'investorProjects';
            else if (actionLabel.toLowerCase().includes('profile')) actionTarget = 'userProfile';

            if(actionTarget) {
                newQuickActions.push({ id: 'qa_' + Date.now() + '_' + newQuickActions.length, label: actionLabel, targetPage: actionTarget });
            }
        }
        if (newQuickActions.length > 0) this.avatar.quickActions = newQuickActions.slice(0, 3); // Limit to 3 quick actions
      },
      handleAvatarQuickAction(action) {
          if (action.targetPage) {
              this.addAvatarMessage(`Okay, taking you to ${action.label}...`, 'bot');
              this.speakAvatarResponse(`Okay, taking you to ${action.label}.`);
              this.switchPage(action.targetPage);
              this.toggleAvatarExpansion(false);
          }
          this.avatar.quickActions = [];
      },
      scrollToAvatarMessagesBottom() { const container = this.$refs.avatarMessagesContainer; if (container) container.scrollTop = container.scrollHeight; },
      markAvatarMessagesAsRead() { this.avatar.chatMessages.forEach(msg => { if (msg.sender === 'bot') msg.readByUser = true; }); this.saveDataToLocalStorage(); },
      updateAvatarContextAndQuickActions() {
          let context = "";
          let actions = [];
          this.avatar.currentContextText = ""; // Reset previous context

          switch(this.current) {
              case 'landing':
                  context = "This is the main landing page. It describes PestiVid and its features.";
                  actions = [
                      { id: 'qa_lp_getstarted', label: "How do I start?", targetPage: this.isUserAuthenticated ? (this.role ? this.getStartedTarget() : 'roleSelection') : 'loginChoice' },
                      { id: 'qa_lp_whatis', label: "What is PestiVid?", customHandler: () => this.addAvatarMessage("PestiVid is a blockchain-based platform for transparent agriculture, connecting farmers, buyers, and investors!", 'bot') },
                  ];
                  break;
              case 'farmerPestiVid':
                  context = "This is the PestiVid page for farmers to record and upload crop videos to Storj. These videos can be used for AgriStream, selling, or funding requests.";
                  actions = [ { id: 'qa_fpv_howto', label: "How to record?", customHandler: () => this.addAvatarMessage("Fill in crop details, select purpose, then click 'Start Recording'. After stopping, click 'Upload to Storj'. Make sure to allow camera access!", 'bot') } ];
                  break;
              case 'farmerAgriStream':
                  context = "Farmers can view their uploaded videos on AgriStream, manage them, or use them to create new listings or funding requests.";
                  actions = [ { id: 'qa_fas_newlisting', label: "Create Listing?", targetPage: 'farmerSell' }];
                  break;
              case 'buyerAgriSell':
                  context = "This is the marketplace where buyers can browse and purchase crop listings verified by videos.";
                   actions = [ { id: 'qa_bas_howtobuy', label: "How to buy?", customHandler: () => this.addAvatarMessage("Browse listings, click 'Initiate Purchase', enter your offer amount, and confirm. It's a simulated purchase.", 'bot') }];
                  break;
              // Add more cases for other pages
              default:
                  context = `The user is on the ${this.current} page.`;
          }
          this.avatar.currentContextText = context;
          if (actions.length > 0 && this.avatar.chatMessages.length <= 1) { // Show initial quick actions if chat is new
              this.avatar.quickActions = actions.slice(0,2);
          } else if (this.avatar.chatMessages.length > 1) {
             this.avatar.quickActions = []; // Clear quick actions after first interaction typically
          }
      },
      getStartedTarget() { // Helper for avatar's get started quick action
        if (!this.isUserAuthenticated) return 'loginChoice';
        if (!this.role) return 'roleSelection';
        if (this.role === 'farmer') return 'farmerPestiVid';
        if (this.role === 'buyer') return 'buyerAgriSell';
        if (this.role === 'investor') return 'investorProjects';
        return 'landing';
      },
      speakAvatarResponse(textToSpeak) {
          if (!('speechSynthesis' in window) || !this.avatar.expanded) {
              this.avatar.state = this.avatar.isListening ? 'listening' : 'idle';
              return;
          }
          // Sanitize text a bit for TTS (remove markdown like *)
          const cleanText = textToSpeak.replace(/[*_`]/g, '');

          speechSynthesis.cancel(); // Cancel any previous speech
          const utterance = new SpeechSynthesisUtterance(cleanText);
          utterance.lang = 'en-US';
          utterance.pitch = 1.1;
          utterance.rate = 1;

          this.avatar.state = 'talking';

          utterance.onend = () => {
              this.$nextTick(() => {
                  if (this.avatar.expanded) { // Only transition if still expanded
                      this.avatar.state = this.avatar.isListening ? 'listening' : 'idle'; // Revert to listening or idle
                  }
              });
          };
          utterance.onerror = (event) => {
              console.error('SpeechSynthesis Error:', event.error);
              this.avatar.state = this.avatar.isListening ? 'listening' : 'idle';
          };
          speechSynthesis.speak(utterance);
      },
      initializeSpeechRecognition() {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          if (!SpeechRecognition) {
              console.warn("Speech Recognition API not supported in this browser.");
              return;
          }
          this.speechRecognition = new SpeechRecognition();
          this.speechRecognition.continuous = false;
          this.speechRecognition.lang = 'en-US';
          this.speechRecognition.interimResults = false;
          this.speechRecognition.maxAlternatives = 1;

          this.speechRecognition.onresult = (event) => {
              const speechResult = event.results[0][0].transcript;
              this.avatar.userInput = speechResult;
              this.sendAvatarMessage(); // Automatically send after speech
          };
          this.speechRecognition.onspeechend = () => {
              if (this.avatar.isListening) this.speechRecognition.stop();
          };
          this.speechRecognition.onnomatch = () => {
              this.addAvatarMessage("Sorry, I didn't catch that. Could you please repeat?", 'bot');
              this.speakAvatarResponse("Sorry, I didn't catch that. Could you please repeat?");
          };
          this.speechRecognition.onerror = (event) => {
              console.error('Speech recognition error', event.error);
              let errorMsg = "Speech recognition error: " + event.error;
              if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                errorMsg = "Microphone access denied. Please enable it in browser settings.";
              } else if (event.error === 'no-speech') {
                errorMsg = "No speech detected. Please try again.";
              }
              this.addAvatarMessage(errorMsg, 'bot');
              // this.speakAvatarResponse(errorMsg); // Avoid speaking detailed errors
              this.avatar.isListening = false;
              this.avatar.state = 'idle';
          };
          this.speechRecognition.onstart = () => {
              this.avatar.isListening = true;
              this.avatar.state = 'listening';
          };
          this.speechRecognition.onend = () => {
              this.avatar.isListening = false;
              if(this.avatar.state === 'listening') this.avatar.state = 'idle'; // Revert to idle if not already processing/talking
          };
      },
      toggleAvatarListening() {
          if (!this.speechRecognition) {
              this.addNotification("Speech input is not available in your browser.", "warning");
              return;
          }
          if (this.avatar.isListening) {
              this.speechRecognition.stop();
          } else {
              if ('speechSynthesis' in window && speechSynthesis.speaking) {
                speechSynthesis.cancel(); // Stop TTS if it's speaking
              }
              try {
                this.speechRecognition.start();
              } catch (e) {
                console.error("Error starting speech recognition:", e);
                this.addNotification("Could not start voice input. " + e.message, "error");
                this.avatar.isListening = false;
                this.avatar.state = 'idle';
              }
          }
      }
    },
    async mounted() {
      this.loadDataFromLocalStorage();
      if (!this.checkOrangeIdCallback()) {
        this.current = 'landing'; // or any default page
        this.isAuthProcessing = false;
        if (!this.isUserAuthenticated && this.current === 'loginChoice') {
            this.$nextTick(() => this.renderOrangeIdLoginWidget());
        }
      }
      if ('speechSynthesis' in window && ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) {
        this.initializeSpeechRecognition();
      } else {
        console.warn("Avatar voice features (TTS/STT) not fully supported by this browser.");
      }
      if (this.avatar.visible && this.avatar.expanded) {
        this.updateAvatarContextAndQuickActions();
      }
    }
});
</script>
</body>
</html>