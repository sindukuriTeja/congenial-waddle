<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PestiVid - Agricultural Blockchain Platform (Web3 Demo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" rel="stylesheet">
  <!-- Google Fonts (Inter) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Orange ID Required Dependencies -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://public-cdn-files.pages.dev/bedrock-passport.umd.js"></script>

  <!-- Vue.js -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
  <!-- Axios, Buffer, Solana Web3 -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/buffer@6.0.3/index.min.js"></script>
  <script>
    window.Buffer = window.buffer.Buffer; // Solana Buffer fix
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.73.0/lib/index.iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

  <style>
    body { font-family: 'Inter', system-ui, sans-serif; background: #f9fafb; }
    html { scroll-behavior: smooth; overflow-x: hidden; }
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 5px; }
    ::-webkit-scrollbar-thumb:hover { background: #aaa; }
    * { scrollbar-width: thin; scrollbar-color: #ccc #f1f1f1; -ms-overflow-style: -ms-autohiding-scrollbar; }
    .progress-bar { height: 8px; border-radius: 4px; background: #e5e7eb; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
    .modal-scrollable { max-height: 85vh; overflow-y: auto; }
    .project-updates-list { max-height: 150px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 0.75rem; background-color: #f9fafb; }
    .project-update-item { padding-bottom: 0.5rem; margin-bottom: 0.5rem; border-bottom: 1px solid #f3f4f6; }
    .project-update-item:last-child { border-bottom: none; margin-bottom: 0; }
    .weather-card { background-color: #fff; border-radius: 0.5rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
    .forecast-day { text-align: center; padding: 0.75rem; background-color: #f9fafb; border-radius: 0.375rem; border: 1px solid #e5e7eb; }
    .message-view-container { scroll-behavior: smooth; }
    .notification-badge { position: absolute; top: -5px; right: -8px; min-width: 18px; height: 18px; background-color: #ef4444; border-radius: 9px; color: white; font-size: 10px; font-weight: 600; line-height: 18px; text-align: center; padding: 0 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    .mobile-notification-badge { display: inline-block; background-color: #ef4444; color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 9px; line-height: 16px; text-align: center; vertical-align: top; margin-left: 4px; }
    .notification-toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column-reverse; gap: 10px; align-items: flex-end; }
    .notification-toast { min-width: 250px; max-width: 350px; background-color: #fff; color: #333; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); display: flex; align-items: center; opacity: 0; transform: translateX(100%); transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
    .notification-toast.show { opacity: 1; transform: translateX(0); }
    .notification-toast .icon { margin-right: 0.75rem; font-size: 1.25rem; }
    .notification-toast .icon-info { color: #3b82f6; } .notification-toast .icon-success { color: #10b981; } .notification-toast .icon-warning { color: #f59e0b; } .notification-toast .icon-error { color: #ef4444; }
    .notification-toast .message { font-size: 0.875rem; line-height: 1.3; }
    .notification-toast .close-btn { margin-left: auto; padding-left: 0.75rem; color: #9ca3af; cursor: pointer; background: none; border: none; font-size: 1rem; }
    .notification-toast .close-btn:hover { color: #6b7280; }
    .new-badge { position: absolute; top: -8px; right: -8px; background-color: #3b82f6; color: white; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .loading-modal { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 9999; }
    .loading-content { background-color: white; padding: 2rem; border-radius: 0.5rem; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    .loading-content .fa-spinner { font-size: 2rem; color: #10b981; margin-bottom: 1rem; }
    .login-page-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: calc(100vh - 160px); padding: 2rem 1rem; box-sizing: border-box; }
    .login-branding { display: flex; align-items: center; margin-bottom: 1.5rem; }
    .login-branding .logo-icon { font-size: 2.5rem; color: #15803d; margin-right: 0.75rem; }
    .login-branding .app-name { font-size: 2rem; font-weight: 600; color: #15803d; }
    .login-panel-wrapper { background-color: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); width: 100%; max-width: 450px; text-align: center; }
    .login-panel-wrapper h2 { font-size: 1.5rem; font-weight: 700; color: #166534; /* green-800 */ margin-bottom: 0.5rem; }
    .login-panel-wrapper .tagline { color: #4b5563; /* gray-600 */ margin-bottom: 1.5rem; font-size: 0.9rem; }

    /* Orange ID specific styles */
    #orange-id-login-container { margin: 0 auto; }
    #orange-id-signout-button-container, #orange-id-signout-button-container-mobile {
        display: inline-flex;
        align-items: center;
    }
    #orange-id-signout-button-container button, #orange-id-signout-button-container-mobile button {
        background-color: transparent !important;
        color: #9CA3AF !important; /* gray-400 */
        padding: 0.25rem 0.5rem !important;
        border: none !important;
        font-size: 1rem !important;
    }
    #orange-id-signout-button-container button:hover, #orange-id-signout-button-container-mobile button:hover {
        color: #EF4444 !important; /* red-500 */
    }
  </style>
</head>
<body class="text-gray-900">
<div id="app" class="flex flex-col min-h-screen">
  <!-- Header/Navbar -->
  <header class="bg-white shadow sticky top-0 z-30">
    <div class="max-w-7xl mx-auto px-5 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <span class="text-2xl text-green-700 font-semibold"><i class="fas fa-seedling mr-1"></i>PestiVid</span>
      </div>
      <nav class="hidden md:flex space-x-5 items-center">
        <a href="#" @click.prevent="switchPage('landing')" :class="{'font-bold text-green-700': current==='landing'}" class="hover:text-green-600">Home</a>

        <a v-if="!isUserAuthenticated && !isAuthProcessing && !isOrangeIdCallback" href="#" @click.prevent="switchPage('loginChoice')" class="hover:text-green-600">Login / Sign Up</a>
        <span v-if="(isAuthProcessing || isOrangeIdCallback) && !isUserAuthenticated" class="text-gray-500 text-sm">Authenticating...</span>

        <a v-if="isUserAuthenticated" href="#" @click.prevent="switchPage('messaging')" :class="{'font-bold text-green-700': current==='messaging'}" class="hover:text-green-600 relative">
          <i class="fas fa-comments mr-1"></i>Messages
          <span v-if="unreadMessageCount > 0" class="notification-badge">{{ unreadMessageCount }}</span>
        </a>
        <!-- Farmer Menu -->
        <template v-if="isUserAuthenticated && role==='farmer'">
          <a href="#" @click.prevent="switchPage('farmerPestiVid')" :class="{'font-bold text-green-700': current==='farmerPestiVid'}" class="hover:text-green-600">PestiVid</a>
          <a href="#" @click.prevent="switchPage('farmerAgriStream')" :class="{'font-bold text-green-700': current==='farmerAgriStream'}" class="hover:text-green-600">AgriStream</a>
          <a href="#" @click.prevent="switchPage('farmerSell')" :class="{'font-bold text-green-700': current==='farmerSell'}" class="hover:text-green-600">Sell</a>
          <a href="#" @click.prevent="switchPage('farmerFunding')" :class="{'font-bold text-green-700': current==='farmerFunding'}" class="hover:text-green-600">Get Funding</a>
          <a v-if="isUserAuthenticated && role==='farmer'" href="#" @click.prevent="switchPage('plantRecomendation')" :class="{'font-bold text-green-700': current==='plantRecomendation'}" class="hover:text-green-600">PlantRecomend</a>
        </template>
        <!-- Buyer Menu -->
        <template v-if="isUserAuthenticated && role==='buyer'">
          <a href="#" @click.prevent="switchPage('buyerAgriSell')" :class="{'font-bold text-green-700': current==='buyerAgriSell'}" class="hover:text-green-600">AgriSell</a>
        </template>
        <!-- Investor Menu -->
        <template v-if="isUserAuthenticated && role==='investor'">
          <a href="#" @click.prevent="switchPage('investorProjects')" :class="{'font-bold text-green-700': current==='investorProjects'}" class="hover:text-green-600">Projects</a>
          <a href="#" @click.prevent="switchPage('investorPortfolio')" :class="{'font-bold text-green-700': current==='investorPortfolio'}" class="hover:text-green-600">Portfolio</a>
        </template>
        <template v-if="isUserAuthenticated">
          <a href="#" @click.prevent="switchPage('userProfile')" :class="{'font-bold text-green-700': current==='userProfile'}" class="bg-green-600 text-white text-xs rounded-full px-3 py-1 select-none ml-2 hover:bg-green-700 flex items-center">
             <i class="fas fa-user-circle mr-1"></i> {{ userName ? userName.split(' ')[0] : displayedUserIdentifier }}
          </a>
           <div v-if="loginMethod === 'orangeId'" id="orange-id-signout-button-container" class="ml-2"></div>
           <a v-if="loginMethod === 'solana'" href="#" title="Disconnect Wallet" @click.prevent="logoutUser" class="text-gray-400 hover:text-red-500 ml-2"><i class="fas fa-sign-out-alt text-lg"></i></a>
        </template>
      </nav>
      <button class="md:hidden text-gray-500 focus:outline-none" @click="showMobileMenu = !showMobileMenu">
        <i class="fas fa-bars text-2xl"></i>
      </button>
    </div>
    <!-- Mobile Dropdown -->
    <div v-show="showMobileMenu" class="md:hidden bg-white border-t z-40">
      <div class="py-2 flex flex-col space-y-1 px-4">
        <a href="#" @click.prevent="switchPage('landing');showMobileMenu=false" :class="{'font-bold text-green-700': current==='landing'}">Home</a>
        <a v-if="!isUserAuthenticated && !isAuthProcessing && !isOrangeIdCallback" href="#" @click.prevent="switchPage('loginChoice');showMobileMenu=false" >Login / Sign Up</a>
        <span v-if="(isAuthProcessing || isOrangeIdCallback) && !isUserAuthenticated" class="text-gray-500 text-sm px-1 py-1">Authenticating...</span>

        <a v-if="isUserAuthenticated" href="#" @click.prevent="switchPage('messaging');showMobileMenu=false" :class="{'font-bold text-green-700': current==='messaging'}" class="flex items-center">
          <i class="fas fa-comments mr-1"></i>Messages
          <span v-if="unreadMessageCount > 0" class="mobile-notification-badge">{{ unreadMessageCount }}</span>
        </a>
        <template v-if="isUserAuthenticated && role==='farmer'">
          <a href="#" @click.prevent="switchPage('farmerPestiVid');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerPestiVid'}">PestiVid</a>
          <a href="#" @click.prevent="switchPage('farmerAgriStream');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerAgriStream'}">AgriStream</a>
          <a href="#" @click.prevent="switchPage('farmerSell');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerSell'}">Sell</a>
          <a href="#" @click.prevent="switchPage('farmerFunding');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerFunding'}">Get Funding</a>
          <a v-if="isUserAuthenticated && role==='farmer'" href="#" @click.prevent="switchPage('plantRecomendation');showMobileMenu=false" :class="{'font-bold text-green-700': current==='plantRecomendation'}">PlantRecomend</a>
        </template>
        <template v-if="isUserAuthenticated && role==='buyer'">
          <a href="#" @click.prevent="switchPage('buyerAgriSell');showMobileMenu=false" :class="{'font-bold text-green-700': current==='buyerAgriSell'}">AgriSell</a>
        </template>
        <template v-if="isUserAuthenticated && role==='investor'">
          <a href="#" @click.prevent="switchPage('investorProjects');showMobileMenu=false" :class="{'font-bold text-green-700': current==='investorProjects'}">Projects</a>
          <a href="#" @click.prevent="switchPage('investorPortfolio');showMobileMenu=false" :class="{'font-bold text-green-700': current==='investorPortfolio'}">Portfolio</a>
        </template>
        <template v-if="isUserAuthenticated">
           <div class="border-t mt-2 pt-2 flex justify-between items-center">
             <a href="#" @click.prevent="switchPage('userProfile');showMobileMenu=false" :class="{'font-bold text-green-700': current==='userProfile'}" class="inline-block bg-green-600 text-white text-xs rounded px-2 py-1 ml-1 flex items-center">
                <i class="fas fa-user-circle mr-1"></i> {{ userName ? userName.split(' ')[0] : displayedUserIdentifier }}
             </a>
             <div v-if="loginMethod === 'orangeId'" id="orange-id-signout-button-container-mobile"></div>
             <a v-if="loginMethod === 'solana'" href="#" class="text-gray-400 hover:text-red-500" title="Disconnect Wallet" @click.prevent="logoutUser();showMobileMenu=false"><i class="fas fa-sign-out-alt"></i></a>
           </div>
        </template>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-1 max-w-7xl mx-auto w-full px-4 pt-8 pb-8">
    <!-- Landing Section -->
    <section v-if="current==='landing' && !isOrangeIdCallback">
        <div class="flex flex-col md:flex-row items-center mb-12 pt-2">
            <div class="md:w-1/2 md:pr-8">
            <h1 class="text-4xl font-bold text-green-800 mb-4">PestiVid: Blockchain Transparency in Agriculture</h1>
            <p class="mb-5 text-gray-800 text-lg leading-relaxed">A secure, video-verified agricultural marketplace with investment opportunities. Farmers prove quality and safety via field recordings stored on blockchain (Solana Simulated) and IPFS. Buyers purchase crops with complete confidence and traceability. Investors fund projects with transparent returns.</p>
            <ul class="text-gray-700 mb-7 space-y-1 text-base">
                <li><i class="fas fa-link text-green-500 mr-2"></i>Solana blockchain-simulated transactions</li>
                <li><i class="fas fa-cloud-upload-alt text-green-400 mr-2"></i>Decentralized video storage (IPFS/Pinata)</li>
                <li><i class="fas fa-search-dollar text-green-400 mr-2"></i>Full traceability for buyers</li>
                <li><i class="fas fa-handshake text-green-500 mr-2"></i>Direct, transparent marketplace transactions</li>
                <li><i class="fas fa-chart-line text-green-500 mr-2"></i>Investment opportunities for funders</li>
                <li><i class="fas fa-comments text-green-500 mr-2"></i>Secure messaging between users</li>
                <li><i class="fas fa-bell text-green-500 mr-2"></i>Real-time notifications</li>
            </ul>
            <div class="mt-4 space-x-2">
                <button class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded transition" @click="getStarted">Get Started</button>
                <button class="bg-white border border-green-600 text-green-600 px-6 py-2 rounded transition" @click="switchPage(isUserAuthenticated && role==='buyer' ? 'buyerAgriSell' : isUserAuthenticated ? (role ? (role === 'farmer' ? 'farmerPestiVid' : (role === 'investor' ? 'investorProjects' : 'landing')) : 'roleSelection') : 'loginChoice')">Browse Marketplace</button>
            </div>
            </div>
            <div class="md:w-1/2 mt-10 md:mt-0 flex flex-col items-center">
            <video controls playsinline webkit-playsinline class="rounded-lg shadow-md border w-full max-w-md mx-auto">
                <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
                Demo video: your browser does not support video.
            </video>
            </div>
        </div>
        <div class="mt-10">
            <h2 class="text-2xl text-green-700 font-semibold mb-3">How It Works</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-5">
            <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
                <i class="fas fa-video text-2xl text-green-500 mb-3"></i>
                <span class="font-bold mb-1">1. Video Recording</span>
                <p class="text-sm text-gray-600 text-center">Farmers film direct evidence of their crop and practices.</p>
            </div>
            <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
                <i class="fas fa-cloud-upload-alt text-2xl text-green-500 mb-3"></i>
                <span class="font-bold mb-1">2. Upload to IPFS</span>
                <p class="text-sm text-gray-600 text-center">Videos & info are securely uploaded and stored decentrally.</p>
            </div>
            <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
                <i class="fas fa-search-dollar text-2xl text-green-500 mb-3"></i>
                <span class="font-bold mb-1">3. Verification</span>
                <p class="text-sm text-gray-600 text-center">Buyers view blockchain-verified video before any purchase.</p>
            </div>
            <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
                <i class="fas fa-handshake text-2xl text-green-500 mb-3"></i>
                <span class="font-bold mb-1">4. Marketplace</span>
                <p class="text-sm text-gray-600 text-center">Login to buy, sell, or invest, all backed by video trust.</p>
            </div>
            </div>
        </div>

        <div class="mt-16 bg-green-50 rounded-lg p-8">
            <h2 class="text-2xl text-green-700 font-semibold mb-3">Agricultural Investment Platform</h2>
            <div class="flex flex-col md:flex-row items-center">
            <div class="w-full">
                <p class="mb-4 text-gray-700">Invest in verified agricultural projects with full transparency. Track your investments through simulated Solana blockchain technology and share in the harvest profits.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 my-6">
                <div class="bg-white rounded p-4 shadow-sm">
                    <i class="fas fa-seedling text-green-600 text-2xl mb-2"></i>
                    <h3 class="font-bold mb-1">Fund Crops</h3>
                    <p class="text-sm">Invest in specific crops with transparent land use and practices.</p>
                </div>
                <div class="bg-white rounded p-4 shadow-sm">
                    <i class="fas fa-coins text-green-600 text-2xl mb-2"></i>
                    <h3 class="font-bold mb-1">Share Returns</h3>
                    <p class="text-sm">Receive dividends based on harvest yields and market prices.</p>
                </div>
                <div class="bg-white rounded p-4 shadow-sm">
                    <i class="fas fa-shield-alt text-green-600 text-2xl mb-2"></i>
                    <h3 class="font-bold mb-1">Secure Blockchain</h3>
                    <p class="text-sm">All investments and harvests recorded on immutable ledger (Solana Simulated).</p>
                </div>
                </div>
                <button class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded transition mt-2" @click="switchPage(isUserAuthenticated && role==='investor' ? 'investorProjects' : isUserAuthenticated ? (role ? (role === 'farmer' ? 'farmerPestiVid' : (role === 'buyer' ? 'buyerAgriSell' : 'landing')) : 'roleSelection') : 'loginChoice')">Become an Investor</button>
            </div>
            </div>
        </div>
    </section>

    <!-- Orange ID Callback Processing View -->
    <section v-if="isOrangeIdCallback" class="login-page-container">
        <div class="login-panel-wrapper">
            <div class="login-branding justify-center">
                <i class="fas fa-seedling logo-icon"></i>
                <span class="app-name">PestiVid</span>
            </div>
            <div id="orange-id-callback-processor" class="text-center p-4">
                <!-- Orange ID Callback Processor will be rendered here by React -->
                <p class="text-gray-600"><i class="fas fa-spinner fa-spin mr-2"></i>Processing authentication...</p>
            </div>
        </div>
    </section>

    <!-- Login Choice Page -->
    <section v-if="current==='loginChoice' && !isOrangeIdCallback" class="login-page-container">
        <div class="login-panel-wrapper">
            <div class="login-branding justify-center ">
                <i class="fas fa-seedling logo-icon"></i>
                <span class="app-name">PestiVid</span>
            </div>
            <h2 class="text-xl font-bold text-green-800 mb-2">Login or Sign Up</h2>
            <p class="text-gray-600 mb-6 text-sm">Choose your preferred method to access PestiVid.</p>

            <!-- Orange ID Social Login Block -->
            <div class="mb-4">
                <p class="text-xs text-gray-500 mb-2 text-left ml-1">Sign in with Orange ID:</p>
                <div id="orange-id-login-container" class="flex justify-center">
                    <p v-if="!orangeIdWidgetMounted && !orangeIdBedrockSDKError" class="text-gray-500 p-4 text-sm">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Loading Social Logins...
                    </p>
                    <p v-if="orangeIdBedrockSDKError" class="text-red-500 p-4 text-sm">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Social login service could not load.
                    </p>
                    <!-- Orange ID LoginPanel will be rendered here by renderOrangeIdLoginWidget() -->
                </div>
                 <p class="text-xs text-gray-500 mt-2 text-center">Powered by <a href="https://orangeid.xyz" target="_blank" class="underline hover:text-orange-500">Orange ID</a></p>
            </div>

            <div class="relative my-6">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-white text-gray-500">OR</span>
                </div>
            </div>

            <div class="mb-4">
                 <p class="text-xs text-gray-500 mb-2 text-left ml-1">Connect with your Solana wallet:</p>
                <button @click="connectWallet"
                        class="w-full flex items-center justify-center px-4 py-2.5 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                    <i class="fas fa-wallet mr-2"></i> Connect Solana Wallet
                </button>
            </div>
        </div>
    </section>

    <!-- Role Selection (after any login if new PestiVid user) -->
    <section v-if="current==='roleSelection' && !isOrangeIdCallback" class="max-w-lg mx-auto bg-white shadow rounded-lg p-8 mt-8">
        <h2 class="text-2xl font-bold text-green-700 mb-4">Welcome to PestiVid!</h2>
        <p class="text-gray-600 mb-1">
            <span v-if="loginMethod === 'orangeId'">Logged in as <strong class="font-mono text-sm">{{ orangeIdUser ? (orangeIdUser.name || orangeIdUser.email || displayedUserIdentifier) : displayedUserIdentifier }}</strong> via Orange ID.</span>
            <span v-if="loginMethod === 'solana'">Your wallet <strong class="font-mono text-sm">{{ displayedUserIdentifier }}</strong> is connected.</span>
        </p>
        <p class="text-gray-600 mb-5">Please complete your PestiVid profile and select your primary role:</p>
        <div class="mb-4">
            <label class="block text-gray-600 mb-1">Full Name (for PestiVid)</label>
            <input v-model="userNameOnboarding" type="text" class="w-full px-3 py-2 border rounded" placeholder="e.g., John Doe" required>
        </div>
        <div class="mb-4">
            <label class="block text-gray-600 mb-1">Email Address (for PestiVid)</label>
            <input v-model="userEmailOnboarding" type="email" class="w-full px-3 py-2 border rounded" placeholder="e.g., john.doe@example.com" required>
        </div>
        <div class="mb-4">
            <label class="block text-gray-600 mb-1">Phone Number (Optional)</label>
            <input v-model="userPhoneOnboarding" type="tel" class="w-full px-3 py-2 border rounded" placeholder="e.g., +1-555-123-4567">
        </div>
        <div class="mb-6">
          <label class="block text-gray-600 mb-1">Primary Role in PestiVid</label>
          <select v-model="selectedRoleOnboarding" class="w-full px-3 py-2 border rounded bg-white" required>
            <option value="" disabled>Select Role</option>
            <option value="farmer">Farmer</option>
            <option value="buyer">Buyer</option>
            <option value="investor">Investor</option>
          </select>
        </div>
         <div class="mb-4" v-if="selectedRoleOnboarding === 'farmer'">
            <label class="block text-gray-600 mb-1">Farm/City Name (for Weather)</label>
            <input v-model="farmerLocationCityOnboarding" type="text" class="w-full px-3 py-2 border rounded" placeholder="e.g., Davis, California">
         </div>
        <button @click="completeOnboarding" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded" :disabled="!selectedRoleOnboarding || !userNameOnboarding || !userEmailOnboarding">Confirm Profile & Role</button>
    </section>

    <section v-if="current==='farmerPestiVid' && !isOrangeIdCallback" class="max-w-3xl mx-auto mt-6">
      <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-video mr-2"></i>PestiVid: Record Crop Video</h2>
      <div class="bg-white rounded shadow-md p-6 space-y-6">
        <form @submit.prevent>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
            <div> <label class="block text-gray-600 mb-1 text-sm">Crop Type</label> <input v-model="recordForm.crop" class="w-full px-2 py-2 border rounded text-sm" required placeholder="e.g., Tomatoes"> </div>
            <div> <label class="block text-gray-600 mb-1 text-sm">Field Location</label> <input v-model="recordForm.location" class="w-full px-2 py-2 border rounded text-sm" required placeholder="e.g., South Field"> </div>
            <div> <label class="block text-gray-600 mb-1 text-sm">Pesticide Used</label> <input v-model="recordForm.pesticide" class="w-full px-2 py-2 border rounded text-sm" required placeholder="e.g., Neem Oil"> </div>
            <div> <label class="block text-gray-600 mb-1 text-sm">Pesticide Company</label> <input v-model="recordForm.pesticideCompany" class="w-full px-2 py-2 border rounded text-sm" required placeholder="e.g., AgriChem"> </div>
          </div>
          <div class="mb-4">
            <label class="block text-gray-600 mb-1 text-sm">Purpose of this Video:</label>
            <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-2 sm:space-y-0">
                <label class="flex items-center"> <input type="radio" v-model="recordForm.purpose" value="agristream" class="form-radio text-green-600"> <span class="ml-2 text-sm text-gray-700">For AgriStream (General)</span> </label>
                <label class="flex items-center"> <input type="radio" v-model="recordForm.purpose" value="sell" class="form-radio text-green-600"> <span class="ml-2 text-sm text-gray-700">To List for Sale</span> </label>
                <label class="flex items-center"> <input type="radio" v-model="recordForm.purpose" value="funding" class="form-radio text-green-600"> <span class="ml-2 text-sm text-gray-700">For Funding Request</span> </label>
            </div>
          </div>
        </form>
        <div>
          <div class="aspect-w-16 aspect-h-9 bg-black rounded mb-3 relative" style="min-height:200px">
            <video ref="liveVideo" v-show="showLive" class="w-full h-full rounded absolute inset-0 object-cover" autoplay muted playsinline webkit-playsinline style="background:#111"></video>
            <video v-if="recordBlobUrl" :src="recordBlobUrl" controls playsinline webkit-playsinline class="w-full h-full rounded absolute inset-0 object-cover" style="background:#181818"></video>
            <div v-if="!showLive && !recordBlobUrl" class="absolute inset-0 flex justify-center items-center h-full text-gray-400"><i class="fas fa-video-slash fa-2x"></i></div>
          </div>
          <div class="flex flex-wrap gap-3 mb-2 items-center">
            <button type="button" :disabled="recording || !isUserAuthenticated" @click="startVideo" :class="{'opacity-50 cursor-not-allowed': recording || !isUserAuthenticated}" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">
              <i :class="recording ? 'fas fa-spinner fa-spin' : (recordBlobUrl ? 'fas fa-redo' : 'fas fa-record-vinyl')" class="mr-1"></i>
              {{ recordBlobUrl ? 'Re-Record' : (recording ? 'Starting...' : 'Start Recording') }}
            </button>
            <button v-if="recording" type="button" @click="stopVideo" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-sm"> <i class="fas fa-stop mr-1"></i>Stop </button>
            <button v-if="recordBlobUrl && !uploading" type="button" @click="uploadVideo" :disabled="!isUserAuthenticated" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm"> <i class="fas fa-upload mr-1"></i>Upload to IPFS </button>
            <div v-if="uploading" class="flex items-center text-blue-600 text-sm ml-3"> <i class="fas fa-spinner fa-spin mr-2"></i> Uploading... Please wait. </div>
          </div>
          <p class="text-xs mt-2 text-gray-500">Allow camera access. Video file is stored locally until upload.</p>
          <div v-if="!isUserAuthenticated" class="text-red-500 mt-3 bg-red-50 p-2 rounded border border-red-200 text-sm"> <i class="fas fa-exclamation-triangle mr-1"></i> Please log in to record and upload videos. </div>
          <div v-if="uploadCid" class="text-green-600 mt-3 bg-green-50 p-3 rounded border border-green-200 text-sm">
              <div class="flex items-center mb-2"> <i class="fas fa-check-circle mr-2"></i> Uploaded to IPFS! CID: <span class="font-mono bg-green-100 px-1 py-0.5 rounded break-all ml-1">{{ uploadCid }}</span> </div>
              <p v-if="lastUploadedVideoPurpose === 'agristream'" class="mt-1 text-gray-700"> This video is now available in your AgriStream. <a href="#" @click.prevent="navigateToPageWithParam('farmerAgriStream', 'highlightCid', uploadCid)" class="text-blue-700 underline font-medium hover:text-blue-800 ml-1">View in AgriStream</a>. <br>You can also use it later to: <a href="#" @click.prevent="goToListing(uploadCid)" class="text-green-700 underline font-medium hover:text-green-800">Create a Listing</a>, or <a href="#" @click.prevent="navigateToPageWithParam('farmerFunding', 'cid', uploadCid)" class="text-purple-700 underline font-medium hover:text-purple-800 ml-1">Use for Funding Request</a>. </p>
              <p v-if="lastUploadedVideoPurpose === 'sell'" class="mt-1 text-gray-700"> Video uploaded for selling! You should be redirected to create a listing. If not, <a href="#" @click.prevent="navigateToPageWithParam('farmerSell', 'cid', uploadCid)" class="text-green-700 underline font-medium hover:text-green-800">click here to complete the listing</a>. </p>
              <p v-if="lastUploadedVideoPurpose === 'funding'" class="mt-1 text-gray-700"> Video uploaded for a funding request! You should be redirected to create the request. If not, <a href="#" @click.prevent="navigateToPageWithParam('farmerFunding', 'cid', uploadCid)" class="text-purple-700 underline font-medium hover:text-purple-800">click here to complete the funding request</a>. </p>
          </div>
          <div v-if="uploadError" class="text-red-600 mt-3 bg-red-50 p-2 rounded border border-red-200 text-sm"> <i class="fas fa-exclamation-triangle mr-1"></i> {{ uploadError }} </div>
        </div>
      </div>
    </section>
    <section v-if="current==='farmerAgriStream' && !isOrangeIdCallback" class="max-w-4xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-5"><i class="fas fa-stream mr-2"></i>AgriStream: My Crop Videos</h2>
        <div class="bg-white rounded shadow-md p-6">
            <div v-if="farmerVideos.length===0" class="text-gray-600 text-center p-6 bg-gray-50 rounded"> <i class="fas fa-film text-4xl text-gray-400 mb-3"></i><br> No uploads yet. Go to <a href="#" class="text-green-700 underline" @click.prevent="switchPage('farmerPestiVid')">PestiVid</a> to upload. </div>
            <div v-else class="space-y-6">
            <div v-for="vid in farmerVideos" :key="vid.cid" class="flex flex-col md:flex-row items-start border-b last:border-b-0 pb-6 gap-6 transition-all duration-500" :ref="'videoCard-' + vid.cid" :class="{'bg-yellow-50 border-l-4 border-yellow-400 shadow-lg transform scale-102': vid.cid === highlightedAgriStreamVideoCid}">
                <div class="w-full md:w-60 flex-shrink-0"> <video :src="ipfsUrl(vid.cid)" controls playsinline webkit-playsinline class="rounded shadow w-full bg-black"></video> </div>
                <div class="flex-1">
                <div class="font-bold text-lg">{{ vid.crop }}</div>
                <div class="text-xs mb-1" :class="{ 'text-blue-700': vid.purpose === 'sell', 'text-purple-700': vid.purpose === 'funding', 'text-gray-600': vid.purpose === 'agristream' || !vid.purpose }"> Intended for: <span class="font-semibold"> {{ vid.purpose === 'sell' ? 'Listing for Sale' : (vid.purpose === 'funding' ? 'Funding Request' : (vid.purpose === 'agristream' ? 'AgriStream (General)' : 'N/A')) }} </span> </div>
                <div class="text-sm mb-1">Location: <span class="font-mono text-gray-700">{{ vid.location }}</span></div>
                <div class="text-sm mb-1">Pesticide: <span class="font-mono text-gray-700">{{ vid.pesticide }}</span></div>
                <div class="text-sm mb-1">Pesticide Co.: <span class="font-mono text-gray-700">{{ vid.pesticideCompany || 'N/A' }}</span></div>
                <div class="text-xs text-gray-500 mb-2">CID: <span class="font-mono break-all">{{ vid.cid }}</span></div>
                <a :href="ipfsUrl(vid.cid)" target="_blank" class="text-blue-600 hover:underline text-xs mr-3"><i class="fas fa-external-link-alt mr-1"></i>View on Gateway</a>
                <button v-if="!isListed(vid.cid)" @click="goToListing(vid.cid)" class="text-green-600 hover:underline text-xs"> <i class="fas fa-tags mr-1"></i> {{ (vid.purpose === 'sell' && !isListed(vid.cid)) ? 'Complete Listing' : 'Create Listing' }} </button>
                <span v-else class="text-gray-500 text-xs"><i class="fas fa-check mr-1"></i>Already Listed</span>
                <button v-if="!isUsedInFunding(vid.cid) && (vid.purpose === 'funding' || vid.purpose === 'agristream')" @click="navigateToPageWithParam('farmerFunding', 'cid', vid.cid)" class="text-purple-600 hover:underline text-xs ml-2"> <i class="fas fa-hand-holding-usd mr-1"></i> {{ (vid.purpose === 'funding' && !isUsedInFunding(vid.cid)) ? 'Complete Funding Request' : 'Use for Funding' }} </button>
                <span v-if="isUsedInFunding(vid.cid)" class="text-gray-500 text-xs ml-2"><i class="fas fa-check mr-1"></i>Used for Funding</span>
                </div>
            </div>
            </div>
        </div>
    </section>
    <section v-if="current==='farmerSell' && !isOrangeIdCallback" class="max-w-2xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-tags mr-2"></i>Sell Farm Crop on Marketplace</h2>
      <div class="bg-white rounded shadow-md p-6">
        <form @submit.prevent="createListing">
          <div class="mb-4">
            <label class="block text-gray-600 mb-1">Select Uploaded Video (Unlisted only)</label>
            <select v-model="listingForm.cid" class="w-full px-3 py-2 border rounded bg-white mb-2" required>
              <option value="" disabled>Select video...</option>
              <option v-for="vid in availableVideosForListing" :key="vid.cid" :value="vid.cid"> {{ vid.crop }} ({{ vid.location }}) - Pest: {{ vid.pesticide }} by {{ vid.pesticideCompany || 'N/A' }} </option>
              <option v-if="availableVideosForListing.length === 0" disabled>No unlisted videos available</option>
            </select>
            <p v-if="farmerVideos.length === 0" class="text-xs text-red-500">You need to upload a video first via PestiVid.</p>
            <p v-if="farmerVideos.length > 0 && availableVideosForListing.length === 0" class="text-xs text-yellow-600">All your videos are already associated with listings or not marked for sale.</p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">
            <div> <label class="block text-gray-600 mb-1">Min Price (SOL)</label> <input type="number" v-model="listingForm.minPrice" class="w-full px-3 py-2 border rounded" min="0.01" step="0.01" required placeholder="e.g., 0.5"> </div>
            <div> <label class="block text-gray-600 mb-1">Max Price (SOL)</label> <input type="number" v-model="listingForm.maxPrice" class="w-full px-3 py-2 border rounded" :min="listingForm.minPrice || 0.01" step="0.01" required placeholder="e.g., 1.5"> </div>
          </div>
          <div class="mb-4"> <label class="flex items-center"> <input type="checkbox" v-model="listingForm.notifyBuyers" class="form-checkbox h-4 w-4 text-green-600"> <span class="ml-2 text-sm text-gray-700">Notify potential buyers about this listing</span> </label> </div>
          <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded w-full" :disabled="!listingForm.cid || !isUserAuthenticated"> <i class="fas fa-plus-circle mr-1"></i>Create Listing </button>
          <div v-if="!isUserAuthenticated" class="text-red-500 mt-3 text-sm text-center">Log in to create listings.</div>
        </form>
        <div v-if="createdListingId" class="bg-green-100 text-green-700 px-4 py-3 mt-4 rounded font-medium text-sm"> <i class="fas fa-check mr-1"></i> Listing created successfully! Tx: <span class="font-mono text-xs">{{ createdListingId.substring(0,10) }}...</span> <div v-if="listingNotificationSent" class="mt-1 text-sm"> <i class="fas fa-bell mr-1"></i> Buyers have been notified about your new listing. </div> </div>
        <div class="mt-8">
          <h3 class="font-semibold mb-2 text-gray-700">Your Active Listings</h3>
          <div v-if="farmerListings.length===0" class="text-gray-600 text-sm bg-gray-50 p-4 rounded text-center">You have no active listings.</div>
          <ul v-else class="space-y-3">
            <li v-for="l in farmerListings" :key="l.id" class="py-3 px-4 border rounded flex flex-col sm:flex-row justify-between sm:items-center text-sm bg-white shadow-sm">
              <div> <span class="font-medium">{{ l.crop }}</span> <span class="text-xs text-gray-500 ml-1"> ({{l.location}})</span> <br> <span class="text-xs text-gray-500"> CID: {{l.cid.substring(0, 8)}}...</span> | <span class="text-xs text-gray-500"> Pest. Co: {{ l.pesticideCompany || 'N/A' }}</span> <div v-if="l.notificationSent" class="text-xs text-green-600 mt-1"> <i class="fas fa-bell mr-1"></i> Buyers notified </div> </div>
              <div class="mt-2 sm:mt-0 text-right"> <span>Min: <span class="font-mono font-semibold">{{ l.minPrice }}</span> SOL</span><br> <span>Max: <span class="font-mono font-semibold">{{ l.maxPrice }}</span> SOL</span> <button v-if="!l.notificationSent" @click="notifyBuyersAboutListing(l)" class="ml-2 text-xs text-blue-600 border border-blue-300 rounded px-2 py-1 hover:bg-blue-50"> <i class="fas fa-bell-slash mr-1"></i> Notify </button> </div>
            </li>
          </ul>
        </div>
      </div>
    </section>
    <section v-if="current==='farmerFunding' && !isOrangeIdCallback" class="max-w-3xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-money-bill-wave mr-2"></i>Request Funding for Your Farm</h2>
        <div class="bg-white rounded shadow-md p-6">
            <form @submit.prevent="createFundingRequest_V1">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div> <label class="block text-gray-600 mb-1 text-sm">Project Title</label> <input v-model="fundingForm.title" class="w-full px-3 py-2 border rounded text-sm" required placeholder="e.g., Organic Tomato Expansion"> </div>
                <div> <label class="block text-gray-600 mb-1 text-sm">Crop Type</label> <input v-model="fundingForm.crop" class="w-full px-3 py-2 border rounded text-sm" required placeholder="e.g., Roma Tomatoes"> </div>
                <div> <label class="block text-gray-600 mb-1 text-sm">Land Size (Acres)</label> <input type="number" v-model.number="fundingForm.acres" class="w-full px-3 py-2 border rounded text-sm" min="0.1" step="0.1" required placeholder="e.g., 5.5"> </div>
                <div> <label class="block text-gray-600 mb-1 text-sm">Funding Required (SOL)</label> <input type="number" v-model.number="fundingForm.amount" class="w-full px-3 py-2 border rounded text-sm" min="1" step="0.1" required placeholder="e.g., 50"> </div>
                <div> <label class="block text-gray-600 mb-1 text-sm">Growing Method</label> <select v-model="fundingForm.method" class="w-full px-3 py-2 border rounded bg-white text-sm" required> <option value="">Select method...</option> <option value="organic">Organic</option> <option value="conventional">Conventional</option> <option value="hydroponic">Hydroponic</option> <option value="aquaponic">Aquaponic</option> <option value="regenerative">Regenerative</option> </select> </div>
                <div> <label class="block text-gray-600 mb-1 text-sm">Expected ROI (%)</label> <input type="number" v-model.number="fundingForm.roi" class="w-full px-3 py-2 border rounded text-sm" min="1" max="100" required placeholder="e.g., 15"> </div>
            </div>
            <div class="mb-4"> <label class="block text-gray-600 mb-1 text-sm">Select Video Evidence</label> <select v-model="fundingForm.cid" class="w-full px-3 py-2 border rounded bg-white mb-2 text-sm" required> <option value="" disabled>Select video...</option> <option v-for="vid in availableVideosForFunding" :key="vid.cid" :value="vid.cid"> {{ vid.crop }} ({{ vid.location }}) - {{ vid.pesticideCompany || 'N/A' }} </option> <option v-if="availableVideosForFunding.length === 0" disabled>No videos suitable for funding available</option> </select> <p v-if="farmerVideos.length === 0" class="text-xs text-red-500">You need to upload a video first via PestiVid.</p> <p v-if="farmerVideos.length > 0 && availableVideosForFunding.length === 0" class="text-xs text-yellow-600">All your videos are already used for funding or not marked for funding.</p> </div>
            <div class="mb-4"> <label class="block text-gray-600 mb-1 text-sm">Project Description</label> <textarea v-model="fundingForm.description" class="w-full px-3 py-2 border rounded text-sm" rows="4" required placeholder="Describe your project, growing practices, and how funds will be used..."></textarea> </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"> <div> <label class="block text-gray-600 mb-1 text-sm">Timeline (Months)</label> <input type="number" v-model.number="fundingForm.timeline" class="w-full px-3 py-2 border rounded text-sm" min="1" max="36" required placeholder="How many months until harvest?"> </div> <div> <label class="block text-gray-600 mb-1 text-sm">Investor Share (%)</label> <input type="number" v-model.number="fundingForm.investorShare" class="w-full px-3 py-2 border rounded text-sm" min="1" max="80" required placeholder="Percentage of harvest profit for investors"> </div> </div>
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded w-full" :disabled="!fundingForm.cid || !isUserAuthenticated"> <i class="fas fa-paper-plane mr-1"></i> Create Funding Request </button>
            <div v-if="!isUserAuthenticated" class="text-red-500 mt-3 text-sm text-center">Log in to create funding requests.</div>
            </form>
            <div v-if="createdFundingRequest" class="bg-green-100 text-green-700 px-4 py-2 mt-4 rounded font-medium text-sm"> <i class="fas fa-check mr-1"></i> Funding request created and is now visible to investors! </div>
            <div class="mt-8">
            <h3 class="font-semibold mb-2 text-gray-700">Your Active Funding Requests</h3>
            <div v-if="farmerFundingRequests.length===0" class="text-gray-600 text-sm bg-gray-50 p-4 rounded text-center">You have no active funding requests.</div>
            <div v-else class="space-y-4">
                <div v-for="req in farmerFundingRequests" :key="req.id" class="border rounded-lg overflow-hidden shadow-sm bg-white">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 bg-gray-50 border-b"> <h4 class="font-bold mb-2 sm:mb-0">{{ req.title }}</h4> <div class="flex items-center space-x-2"> <span :class="{'bg-yellow-100 text-yellow-800': req.status === 'pending', 'bg-green-100 text-green-800': req.status === 'funded', 'bg-blue-100 text-blue-800': req.status === 'partially_funded'}" class="px-2 py-1 rounded text-xs font-medium"> {{ req.status === 'pending' ? 'Pending' : req.status === 'funded' ? 'Fully Funded' : (req.status === 'partially_funded' ? 'Partially Funded' : req.status) }} </span> </div> </div>
                <div class="p-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 text-sm"> <div> <div class="text-xs text-gray-500">Crop</div> <div>{{ req.crop }}</div> </div> <div> <div class="text-xs text-gray-500">Land Size</div> <div>{{ req.acres }} acres</div> </div> <div> <div class="text-xs text-gray-500">Required</div> <div>{{ req.amount }} SOL</div> </div> <div> <div class="text-xs text-gray-500">Investor Share</div> <div>{{ req.investorShare }}%</div> </div> </div>
                    <div class="mb-4"> <div class="text-xs text-gray-500 mb-1">Funding Progress</div> <div class="progress-bar"> <div class="progress-fill bg-green-500" :style="{width: fundingProgressPercent(req) + '%'}"></div> </div> <div class="flex justify-between text-xs mt-1"> <span>{{ req.fundedAmount || 0 }} SOL raised</span> <span>{{ fundingProgressPercent(req) }}% Complete</span> </div> </div>
                    <div v-if="req.fundedAmount > 0 && req.investors && req.investors.length > 0" class="mb-4"> <div class="text-xs text-gray-500 mb-2">Investors ({{req.investors.length}})</div> <div class="text-sm max-h-24 overflow-y-auto border rounded p-2 bg-gray-50 space-y-1"> <div v-for="investor in req.investors" :key="investor.investorId || investor.id" class="flex justify-between items-center py-1 text-xs"> <span><i class="fas fa-user text-gray-400 mr-1"></i>{{ investor.investorId ? (getFarmerDisplayIdentifier(investor.investorId)) : 'Investor' }}</span> <span class="font-mono bg-blue-100 text-blue-800 px-1 rounded">{{ investor.amount }} SOL</span> </div> </div> </div>
                    <div class="flex justify-end mt-4"> <button v-if="req.status !== 'funded'" class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200" @click="cancelFundingRequest_V1(req.id)"> <i class="fas fa-times mr-1"></i>Cancel Request </button> <span v-if="req.status === 'funded'" class="text-xs text-green-600"><i class="fas fa-check-circle mr-1"></i>Fully Funded!</span> </div>
                </div>
                </div>
            </div>
            </div>
        </div>
    </section>
    <section v-if="current==='buyerAgriSell' && !isOrangeIdCallback" class="max-w-6xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-3"><i class="fas fa-shopping-basket mr-2"></i>AgriSell: Marketplace</h2>
      <div class="bg-white rounded shadow-md p-6 mb-7">
        <div class="flex flex-col md:flex-row md:items-end gap-5">
          <div class="w-full md:w-48"> <label class="text-gray-600 text-sm">Crop Type</label> <select v-model="buyerFilters.crop" class="w-full px-2 py-1 border rounded bg-white text-sm"> <option value="">All</option> <option v-for="c in uniqueCrops" :key="c">{{c}}</option> </select> </div>
          <div class="flex-1"> <label class="text-gray-600 text-sm">Location</label> <input v-model="buyerFilters.location" class="w-full px-2 py-1 border rounded text-sm" placeholder="Search by location..."> </div>
          <div class="flex-1"> <label class="text-gray-600 text-sm">Pesticide Co.</label> <input v-model="buyerFilters.pesticideCompany" class="w-full px-2 py-1 border rounded text-sm" placeholder="Search by pesticide company..."> </div>
          <button type="button" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-1 rounded text-sm mt-2 md:mt-0" @click="resetBuyerFilters"> <i class="fas fa-undo mr-1"></i> Reset Filters </button>
        </div>
      </div>
      <div v-if="filteredListings.length === 0" class="text-gray-600 bg-gray-50 p-8 text-center rounded"> <i class="fas fa-search text-4xl text-gray-400 mb-3"></i><br> No listings found matching your criteria. Try adjusting your filters. </div>
      <div v-else class="grid gap-8 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
        <div v-for="l in filteredListings" :key="l.id" class="bg-white rounded shadow p-4 flex flex-col relative">
            <div v-if="l.isNew" class="new-badge">NEW</div>
          <div class="mb-3 flex justify-center"> <video :src="ipfsUrl(l.cid)" controls playsinline webkit-playsinline class="rounded w-full max-h-52 bg-black object-cover"></video> </div>
          <div class="mb-1 font-bold text-lg">{{ l.crop }}</div>
          <div class="text-xs text-gray-500 mb-1">Location: <span class="font-mono">{{ l.location }}</span></div>
          <div class="text-xs text-gray-500 mb-1">Pesticide: <span class="font-mono">{{ l.pesticide }}</span></div>
          <div class="text-xs text-gray-500 mb-2">Pesticide Co.: <span class="font-mono">{{ l.pesticideCompany || 'N/A' }}</span></div>
          <div class="text-sm my-2">Price Range: <br><span class="font-mono text-base font-semibold">{{ l.minPrice }}</span> - <span class="font-mono text-base font-semibold">{{ l.maxPrice }}</span> SOL</div>
          <div class="flex items-center text-xs text-gray-600 mb-2"> <span class="mr-1">Sold by: {{ getSellerDisplayIdentifier(l.farmerWallet) }}</span> <button @click="showFarmerProfile(l.farmerWallet)" class="text-blue-500 hover:text-blue-700 focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> </div>
          <button class="mt-auto bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded text-sm" @click="buyListing(l)" :disabled="!isUserAuthenticated || role !== 'buyer' || currentUserIdentifier === l.farmerWallet"> <i class="fas fa-shopping-cart mr-1"></i> {{ currentUserIdentifier === l.farmerWallet ? 'Your Listing' : (isUserAuthenticated && role === 'buyer' ? 'Initiate Purchase' : 'Login as Buyer to Purchase') }} </button>
          <button @click="startOrGoToConversation(l.farmerWallet)" v-if="isUserAuthenticated && currentUserIdentifier !== l.farmerWallet" class="mt-2 text-xs text-blue-600 hover:text-blue-700 border border-blue-400 rounded-full px-3 py-1 hover:bg-blue-50 flex items-center justify-center"> <i class="fas fa-envelope mr-1"></i> Message Seller </button>
        </div>
      </div>
    </section>
    <section v-if="current==='investorProjects' && !isOrangeIdCallback" class="max-w-6xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-3"><i class="fas fa-project-diagram mr-2"></i>Investment Opportunities</h2>
      <div class="bg-white rounded shadow-md p-6 mb-7">
        <div class="flex flex-col md:flex-row md:items-end gap-5">
          <div class="w-full md:w-48"> <label class="text-gray-600 text-sm">Crop Type</label> <select v-model="investorFilters.crop" class="w-full px-2 py-1 border rounded bg-white text-sm"> <option value="">All Crops</option> <option v-for="c in uniqueFundingCrops" :key="c">{{c}}</option> </select> </div>
          <div class="w-full md:w-48"> <label class="text-gray-600 text-sm">Growing Method</label> <select v-model="investorFilters.method" class="w-full px-2 py-1 border rounded bg-white text-sm"> <option value="">All Methods</option> <option value="organic">Organic</option> <option value="conventional">Conventional</option> <option value="hydroponic">Hydroponic</option> <option value="aquaponic">Aquaponic</option> <option value="regenerative">Regenerative</option> </select> </div>
          <div class="w-full md:w-48"> <label class="text-gray-600 text-sm">Min ROI (%)</label> <input type="number" v-model.number="investorFilters.minRoi" class="w-full px-2 py-1 border rounded text-sm" placeholder="e.g., 10"> </div>
          <div class="w-full md:w-48"> <label class="text-gray-600 text-sm">Max Funding Needed (SOL)</label> <input type="number" v-model.number="investorFilters.maxAmount" class="w-full px-2 py-1 border rounded text-sm" placeholder="e.g., 100"> </div>
          <button type="button" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-1 rounded text-sm mt-2 md:mt-0" @click="resetInvestorFilters"> <i class="fas fa-undo mr-1"></i> Reset Filters </button>
        </div>
      </div>
      <div class="grid gap-6 grid-cols-1 lg:grid-cols-2">
        <div v-for="project in filteredFundingRequests" :key="project.id" class="bg-white rounded-lg shadow overflow-hidden relative">
          <div v-if="project.isNew" class="new-badge">NEW</div>
          <div class="p-5 bg-gray-50 border-b flex flex-col sm:flex-row justify-between sm:items-center"> <h3 class="font-bold text-lg text-green-800 mb-2 sm:mb-0">{{ project.title }}</h3> <span :class="{'bg-yellow-100 text-yellow-800': project.status === 'pending', 'bg-green-100 text-green-800': project.status === 'funded', 'bg-blue-100 text-blue-800': project.status === 'partially_funded'}" class="px-2 py-1 rounded text-xs font-medium self-start sm:self-center"> {{ project.status === 'pending' ? 'Seeking Funding' : project.status === 'funded' ? 'Fully Funded' : 'Partially Funded' }} </span> </div>
          <div class="p-5">
            <div class="flex flex-col md:flex-row gap-6">
              <div class="md:w-1/3">
                <video :src="ipfsUrl(project.cid)" controls playsinline webkit-playsinline class="rounded w-full h-40 object-cover bg-black mb-3"></video>
                <div class="grid grid-cols-2 gap-2 text-sm"> <div> <div class="text-xs text-gray-500">Farmer</div> <div class="font-medium truncate flex items-center"> <span>{{ getFarmerDisplayIdentifier(project.farmerWallet) }}</span> <button @click="showFarmerProfile(project.farmerWallet)" class="ml-2 text-blue-500 hover:text-blue-700 text-xs focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> </div> </div> <div> <div class="text-xs text-gray-500">Land Size</div> <div class="font-medium">{{ project.acres }} acres</div> </div> <div> <div class="text-xs text-gray-500">Timeline</div> <div class="font-medium">{{ project.timeline }} months</div> </div> <div> <div class="text-xs text-gray-500">Expected ROI</div> <div class="font-medium text-green-700">{{ project.roi }}%</div> </div> </div>
                <button @click="startOrGoToConversation(project.farmerWallet)" v-if="isUserAuthenticated && currentUserIdentifier !== project.farmerWallet" class="mt-3 w-full text-xs text-blue-600 hover:text-blue-700 border border-blue-400 rounded-full px-3 py-1 hover:bg-blue-50 flex items-center justify-center"> <i class="fas fa-envelope mr-1"></i> Message Farmer </button>
              </div>
              <div class="md:w-2/3">
                <div class="mb-4"> <div class="text-sm font-medium mb-1">{{ project.crop }} ({{ project.method }})</div> <p class="text-sm text-gray-700 max-h-20 overflow-y-auto">{{ project.description }}</p> </div>
                <div class="mb-4"> <div class="text-xs text-gray-500 mb-1">Funding Progress</div> <div class="progress-bar"> <div class="progress-fill bg-green-500" :style="{width: fundingProgressPercent(project) + '%'}"></div> </div> <div class="flex justify-between text-xs mt-1"> <span>{{ project.fundedAmount || 0 }} / {{ project.amount }} SOL</span> <span>{{ fundingProgressPercent(project) }}% Complete</span> </div> </div>
                <div v-if="project.updates && project.updates.length > 0" class="mb-4"> <h4 class="text-sm font-semibold text-gray-700 mb-2">Recent Farmer Updates</h4> <div class="project-updates-list text-xs" style="max-height: 70px;"> <div v-for="update in project.updates.slice().reverse().slice(0,2)" :key="update.id" class="project-update-item"> <span class="font-medium text-gray-500">{{ update.date }}:</span> {{ update.text }} </div> </div> </div>
                <div class="mb-4"> <div class="flex justify-between items-center mb-2"> <div class="text-sm font-medium">Investment Terms</div> <div class="text-xs text-gray-500">Investor Share: {{ project.investorShare }}% of profit</div> </div> <div class="p-3 bg-yellow-50 rounded text-sm border border-yellow-200"> <p>Invest to receive {{ project.investorShare }}% of the profits, proportional to your investment. Expected return is {{ project.roi }}% over {{ project.timeline }} months.</p> </div> </div>
                <div class="flex flex-col sm:flex-row justify-between items-center mt-4 pt-4 border-t"> <div class="mb-3 sm:mb-0"> <label :for="'investment-amount-'+project.id" class="text-xs text-gray-500 block mb-1">Your Investment (SOL)</label> <input v-model.number="investmentAmounts[project.id]" type="number" :id="'investment-amount-'+project.id" class="px-3 py-1 border rounded w-full sm:w-32 text-sm" min="0.1" :max="maxInvestmentAmount(project)" step="0.01" :disabled="project.status === 'funded' || !isUserAuthenticated || role !== 'investor'" :placeholder="maxInvestmentAmount(project) > 0 ? `Max ${maxInvestmentAmount(project)}` : 'Funded'"> </div> <button @click="investInProject(project)" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm w-full sm:w-auto" :disabled="project.status === 'funded' || !isUserAuthenticated || role !== 'investor' || !investmentAmounts[project.id] || investmentAmounts[project.id] <= 0 || investmentAmounts[project.id] > maxInvestmentAmount(project)"> <i class="fas fa-coins mr-1"></i> {{ project.status === 'funded' ? 'Fully Funded' : (!isUserAuthenticated || role !== 'investor' ? 'Login as Investor' : 'Invest Now') }} </button> </div>
                <div v-if="investmentErrors[project.id]" class="text-red-500 text-xs mt-2">{{ investmentErrors[project.id] }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div v-if="filteredFundingRequests.length === 0" class="bg-gray-50 p-8 text-center rounded-lg mt-4"> <i class="fas fa-seedling text-gray-300 text-4xl mb-3"></i> <h3 class="text-gray-600 text-lg mb-2">No Projects Found</h3> <p class="text-gray-500">Try adjusting your filters or check back later for new investment opportunities.</p> </div>
    </section>
    <section v-if="current==='investorPortfolio' && !isOrangeIdCallback" class="max-w-6xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-chart-pie mr-2"></i>Investment Portfolio</h2>
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Portfolio Overview</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6"> <div class="mb-4 md:mb-0"> <div class="text-xs text-gray-500">Total Invested</div> <div class="text-2xl font-bold text-green-700">{{ totalInvestedAmount }} SOL</div> </div> <div> <div class="text-xs text-gray-500">Active Projects</div> <div class="text-xl font-bold">{{ investorActiveProjects }}</div> </div> <div> <div class="text-xs text-gray-500">Completed</div> <div class="text-xl font-bold">{{ investorCompletedProjects }}</div> </div> <div> <div class="text-xs text-gray-500">Avg. ROI</div> <div class="text-xl font-bold text-green-700">{{ investorAvgRoi }}%</div> </div> </div>
        </div>
        <div class="bg-white rounded-lg shadow overflow-hidden mb-8">
            <div class="px-6 py-4 bg-gray-50 border-b"> <h3 class="text-lg font-semibold text-gray-800">Your Active Investments</h3> </div>
            <div v-if="investorInvestments.length === 0" class="p-8 text-center"> <i class="fas fa-chart-line text-gray-300 text-4xl mb-3"></i> <h4 class="text-gray-600 text-lg mb-2">No Active Investments</h4> <p class="text-gray-500 mb-4">You haven't invested in any agricultural projects yet.</p> <button @click="switchPage('investorProjects')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm"> <i class="fas fa-search mr-1"></i>Browse Projects </button> </div>
            <div v-else class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50"> <tr> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Farmer</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invested (SOL)</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expected Return (SOL)</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th> </tr> </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                <tr v-for="investment in investorInvestments" :key="investment.id">
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-medium text-gray-900">{{ investment.projectTitle }}</div> <div class="text-xs text-gray-500">{{ investment.crop }}</div> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm text-gray-900">{{ getFarmerDisplayIdentifier(investment.farmerWallet, 10) }}</div> <button @click="showFarmerProfile(investment.farmerWallet)" class="text-blue-500 hover:text-blue-700 text-xs focus:outline-none mr-2" title="View Farmer Info"> <i class="fas fa-info-circle mr-1"></i>View Info </button> <button @click="startOrGoToConversation(investment.farmerWallet)" v-if="isUserAuthenticated && currentUserIdentifier !== investment.farmerWallet" class="text-green-600 hover:text-green-700 text-xs focus:outline-none" title="Message Farmer"> <i class="fas fa-envelope mr-1"></i>Message </button> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm text-gray-900 font-mono">{{ investment.amount }}</div> <div class="text-xs text-gray-500">{{ investment.investmentDate }}</div> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="w-24 bg-gray-200 rounded-full h-2.5"> <div class="bg-green-600 h-2.5 rounded-full" :style="{width: investment.progress+'%'}"></div> </div> <div class="text-xs text-gray-500 mt-1">{{ investment.progress }}% Complete</div> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm text-gray-900 font-mono">{{ calculateExpectedReturn(investment) }}</div> <div class="text-xs text-gray-500">{{ investment.roi }}% ROI</div> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <span :class="{ 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true, 'bg-blue-100 text-blue-800': investment.status === 'active', 'bg-green-100 text-green-800': investment.status === 'harvested', 'bg-yellow-100 text-yellow-800': investment.status === 'growing' }"> {{ investment.status.charAt(0).toUpperCase() + investment.status.slice(1) }} </span> </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600"> <a href="#" @click.prevent="viewInvestmentDetails(investment)" class="hover:underline">View</a> </td>
                </tr>
                </tbody>
            </table>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 bg-gray-50 border-b flex justify-between items-center"> <h3 class="text-lg font-semibold text-gray-800">Platform Transaction History (Simulated)</h3> <span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded-full flex items-center"> <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 16 15"><path d="m7.81 0-1.78 3.69L1.88 4.2l2.92 2.52L4.04 10 7.8 7.97 11.55 10l-.77-3.28 2.92 2.52-4.15-.51L7.82 0h-.01Zm0 15-1.78-3.69-4.15-.51 2.92-2.52L4.04 5 7.8 7.03 11.55 5l-.77 3.28 2.92 2.52-4.15-.51L7.82 15h-.01Z"></path></svg> PestiVid Platform (Simulated Ledger) </span> </div>
            <div v-if="investorTransactions.length === 0" class="p-8 text-center"> <i class="fas fa-cubes text-gray-300 text-4xl mb-3"></i> <h4 class="text-gray-600 text-lg mb-2">No Transactions Yet</h4> <p class="text-gray-500">Your investment and payout transactions on the platform will appear here.</p> </div>
            <div v-else class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50"> <tr> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Transaction ID</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount (SOL)</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th> </tr> </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                <tr v-for="tx in investorTransactions" :key="tx.id">
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="flex items-center"> <div class="text-sm font-mono text-gray-900 truncate max-w-[150px] sm:max-w-[250px]" :title="tx.txHash">{{ tx.txHash.substring(0,10) }}...{{ tx.txHash.substring(tx.txHash.length-10) }}</div> <a :href="solanaExplorerUrl(tx.txHash)" target="_blank" class="ml-1 text-blue-500 hover:text-blue-700" title="View on Solana Explorer (Demo Link)"> <i class="fas fa-external-link-alt text-xs"></i> </a> </div> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <span :class="{ 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true, 'bg-green-100 text-green-800': tx.type === 'investment', 'bg-blue-100 text-blue-800': tx.type === 'payout' }"> {{ tx.type === 'investment' ? 'Investment' : 'Harvest Payout' }} </span> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-mono text-gray-900">{{ tx.amount }}</div> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800"> Confirmed (Sim.) </span> </td>
                    <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm text-gray-900">{{ tx.date }}</div> </td>
                </tr>
                </tbody>
            </table>
            </div>
        </div>
    </section>
    <section v-if="current==='userProfile' && !isOrangeIdCallback" class="max-w-6xl mx-auto mt-6">
        <div v-if="!isUserAuthenticated" class="text-center p-10 bg-white rounded-lg shadow"> <i class="fas fa-exclamation-circle text-3xl text-yellow-500 mb-4"></i> <p class="text-xl text-gray-700">Please log in to view your profile.</p> </div>
      <div v-else class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="bg-gradient-to-r from-green-700 to-green-500 p-6 text-white">
          <div class="flex flex-col md:flex-row justify-between items-center">
            <div class="flex items-center mb-4 md:mb-0">
              <div class="bg-white rounded-full w-16 h-16 flex items-center justify-center mr-4 text-green-600 shadow overflow-hidden">
                <img v-if="loginMethod === 'orangeId' && orangeIdUser && orangeIdUser.picture" :src="orangeIdUser.picture" alt="Avatar" class="w-full h-full object-cover"/>
                <i v-else :class="role === 'farmer' ? 'fas fa-tractor' : (role === 'buyer' ? 'fas fa-shopping-cart' : 'fas fa-chart-line')" class="text-3xl"></i>
              </div>
              <div> <h2 class="text-2xl font-bold">{{ userName || displayedUserIdentifier }}</h2> <p class="text-green-100 capitalize"> {{ role === 'farmer' ? 'Agricultural Producer' : role === 'buyer' ? 'Crop Buyer' : 'Agricultural Investor' }} </p> </div>
            </div>
            <div class="bg-white bg-opacity-20 rounded-lg px-4 py-2 flex items-center text-sm"> <i class="fas fa-certificate mr-2"></i> <span>{{ role === 'farmer' ? 'Verified Farmer' : role === 'buyer' ? 'Verified Buyer' : 'Verified Investor' }} (PestiVid Status)</span> </div>
          </div>
        </div>
        <div class="p-6">
          <div class="mb-8">
            <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-id-card mr-2"></i>Account Information </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
              <div>
                <div class="mb-4"> <p class="text-gray-600">Full Name (PestiVid)</p> <p class="font-medium">{{ userName || 'Not Provided in PestiVid Profile' }}</p> </div>
                <div class="mb-4"> <p class="text-gray-600">PestiVid User Identifier ({{ loginMethod === 'orangeId' ? 'Orange ID' : 'Solana Wallet' }})</p> <p class="font-medium font-mono break-all">{{ currentUserIdentifier }}</p> </div>
                <div v-if="loginMethod === 'orangeId' && orangeIdUser && orangeIdUser.ethAddress" class="mb-4"> <p class="text-gray-600">ETH Address (from Orange ID, if available)</p> <p class="font-medium font-mono break-all">{{ orangeIdUser.ethAddress }}</p> </div>
                <div> <p class="text-gray-600">PestiVid Account Type</p> <p class="font-medium capitalize">{{ role || "Not Set" }}</p> </div>
              </div>
              <div>
                <div class="mb-4"> <p class="text-gray-600">Email (PestiVid)</p> <p class="font-medium">{{ userEmail || 'Not Provided in PestiVid Profile' }}</p> </div>
                <div v-if="loginMethod === 'orangeId' && orangeIdUser && orangeIdUser.email && orangeIdUser.email !== userEmail" class="mb-4"> <p class="text-gray-600">Authenticated Email (Orange ID)</p> <p class="font-medium">{{ orangeIdUser.email }}</p> </div>
                <div class="mb-4"> <p class="text-gray-600">Phone (PestiVid)</p> <p class="font-medium">{{ userPhone || 'Not Provided' }}</p> </div>
                <div> <p class="text-gray-600">PestiVid Member Since</p> <p class="font-medium">{{ memberSince || 'N/A' }}</p> </div>
              </div>
            </div>
          </div>
          <!-- Farmer Specific Content -->
          <div v-if="role === 'farmer'" class="mb-8">
            <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-cloud-sun-rain mr-2"></i>Farm Weather Station </h3>
            <div class="weather-card">
                <div class="flex flex-col sm:flex-row gap-4 mb-6 items-end"> <div class="flex-grow"> <label for="farmerCity" class="block text-sm font-medium text-gray-700 mb-1">Farm City/Location:</label> <input type="text" id="farmerCity" v-model.trim="farmerLocationCity" @keyup.enter="fetchWeather" @change="saveFarmerCity" placeholder="e.g., Davis, California" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-sm"> </div> <button @click="fetchWeather" :disabled="weatherLoading || !farmerLocationCity" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm flex items-center justify-center" :class="{'opacity-50 cursor-not-allowed': weatherLoading || !farmerLocationCity}"> <i :class="weatherLoading ? 'fas fa-spinner fa-spin' : 'fas fa-search-location'" class="mr-2"></i> {{ weatherLoading ? 'Fetching...' : 'Get Weather' }} </button> </div>
                <div v-if="weatherError" class="mb-4 bg-red-100 border border-red-300 text-red-700 px-4 py-3 rounded text-sm"> <i class="fas fa-exclamation-triangle mr-2"></i>{{ weatherError }} </div>
                <div v-if="!weatherLoading && !weatherError && !currentWeather && !forecastWeather.length" class="text-center text-gray-500 py-4"> Enter your farm's city to see local weather conditions and forecast. </div>
                <div v-if="currentWeather && !weatherLoading" class="mb-8"> <h4 class="text-lg font-semibold text-gray-800 mb-3">Current Conditions in {{ currentWeather.name }}</h4> <div class="flex flex-col sm:flex-row items-center gap-4 bg-blue-50 p-4 rounded-lg border border-blue-200"> <img :src="getWeatherIconUrl(currentWeather.weather[0].icon)" :alt="currentWeather.weather[0].description" class="w-20 h-20"> <div class="flex-grow text-center sm:text-left"> <p class="text-3xl font-bold">{{ Math.round(currentWeather.main.temp) }}C</p> <p class="text-gray-700 capitalize">{{ currentWeather.weather[0].description }}</p> </div> <div class="text-sm text-gray-600 space-y-1 text-center sm:text-left"> <p><i class="fas fa-tint mr-1 text-blue-500"></i>Humidity: {{ currentWeather.main.humidity }}%</p> <p><i class="fas fa-wind mr-1 text-gray-500"></i>Wind: {{ currentWeather.wind.speed }} m/s</p> <p><i class="fas fa-tachometer-alt mr-1 text-gray-500"></i>Pressure: {{ currentWeather.main.pressure }} hPa</p> </div> </div> </div>
                <div v-if="forecastWeather.length > 0 && !weatherLoading"> <h4 class="text-lg font-semibold text-gray-800 mb-4">5-Day Forecast</h4> <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3"> <div v-for="day in forecastWeather" :key="day.date" class="forecast-day"> <p class="font-semibold text-sm">{{ day.dateString }}</p> <img :src="getWeatherIconUrl(day.icon)" :alt="day.description" class="w-12 h-12 mx-auto my-1"> <p class="text-lg font-bold">{{ Math.round(day.maxTemp) }} <span class="text-gray-500">/ {{ Math.round(day.minTemp) }}</span></p> <p class="text-xs text-gray-600 capitalize">{{ day.description }}</p> </div> </div> </div>
            </div>
          </div>
           <div v-if="role === 'farmer'">
                <div class="mb-8"> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-video mr-2"></i>Your Uploaded Videos ({{ farmerVideos.length }}) </h3> <div v-if="farmerVideos.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center"> <i class="fas fa-film text-gray-400 text-2xl mb-2"></i> <p>You haven't uploaded any videos yet.</p> <button @click="switchPage('farmerPestiVid')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Upload your first video</button> </div> <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"> <div v-for="vid in farmerVideos" :key="vid.cid" class="bg-gray-50 rounded-lg p-4 shadow-sm"> <video :src="ipfsUrl(vid.cid)" controls playsinline webkit-playsinline class="w-full h-40 object-cover bg-black rounded mb-3"></video> <h4 class="font-bold">{{ vid.crop }}</h4> <div class="text-xs mb-1" :class="{ 'text-blue-700': vid.purpose === 'sell', 'text-purple-700': vid.purpose === 'funding', 'text-gray-600': vid.purpose === 'agristream' || !vid.purpose }"> Purpose: <span class="font-semibold"> {{ vid.purpose === 'sell' ? 'Sale' : (vid.purpose === 'funding' ? 'Funding' : (vid.purpose === 'agristream' ? 'General' : 'N/A')) }} </span> </div> <div class="text-sm mb-1">Location: {{ vid.location }}</div> <div class="text-sm mb-1">Pesticide: {{ vid.pesticide }}</div> <div class="text-sm mb-2">Pesticide Co.: {{ vid.pesticideCompany || 'N/A' }}</div> <div class="flex justify-between items-center mt-2 text-xs text-gray-500"> <span class="font-mono truncate" :title="vid.cid">CID: {{ vid.cid.substring(0, 10) }}...</span> <a :href="ipfsUrl(vid.cid)" target="_blank" class="text-blue-600 hover:underline">View</a> </div> </div> </div> </div>
                <div class="mb-8"> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-tags mr-2"></i>Your Active Listings ({{ farmerListings.length }}) </h3> <div v-if="farmerListings.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center"> <i class="fas fa-store text-gray-400 text-2xl mb-2"></i> <p>You don't have any active listings.</p> <button @click="switchPage('farmerSell')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Create your first listing</button> </div> <div v-else> <div class="overflow-x-auto"> <table class="min-w-full border divide-y divide-gray-200"> <thead class="bg-gray-50"> <tr> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Crop</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pesticide Co.</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price Range (SOL)</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th> </tr> </thead> <tbody class="bg-white divide-y divide-gray-200"> <tr v-for="listing in farmerListings" :key="listing.id"> <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-medium text-gray-900">{{ listing.crop }}</div> <div class="text-xs text-gray-500" :title="listing.cid">CID: {{ listing.cid.substring(0, 8) }}...</div> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ listing.location }} </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ listing.pesticideCompany || 'N/A' }} </td> <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm text-gray-900 font-mono">{{ listing.minPrice }} - {{ listing.maxPrice }}</div> </td> <td class="px-6 py-4 whitespace-nowrap"> <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800"> Active </span> </td> </tr> </tbody> </table> </div> </div> </div>
                <div> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-hand-holding-usd mr-2"></i>Your Funding Requests ({{ farmerFundingRequests.length }}) </h3> <div v-if="farmerFundingRequests.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center"> <i class="fas fa-money-bill-wave text-gray-400 text-2xl mb-2"></i> <p>You haven't created any funding requests yet.</p> <button @click="switchPage('farmerFunding')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Request funding for your farm</button> </div> <div v-else class="space-y-4"> <div v-for="req in farmerFundingRequests" :key="req.id" class="border rounded-lg overflow-hidden bg-white shadow-sm"> <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 bg-green-50 border-b"> <h4 class="font-bold mb-1 sm:mb-0">{{ req.title }}</h4> <span :class="{'bg-yellow-100 text-yellow-800': req.status === 'pending', 'bg-green-100 text-green-800': req.status === 'funded', 'bg-blue-100 text-blue-800': req.status === 'partially_funded'}" class="px-2 py-1 rounded text-xs font-medium"> {{ req.status === 'pending' ? 'Pending' : req.status === 'funded' ? 'Fully Funded' : (req.status === 'partially_funded' ? 'Partially Funded' : req.status) }} </span> </div> <div class="p-4 text-sm"> <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4"> <div> <div class="text-xs text-gray-500">Crop</div> <div>{{ req.crop }}</div> </div> <div> <div class="text-xs text-gray-500">Land Size</div> <div>{{ req.acres }} acres</div> </div> <div> <div class="text-xs text-gray-500">Required</div> <div class="font-mono">{{ req.amount }} SOL</div> </div> <div> <div class="text-xs text-gray-500">Raised</div> <div class="font-mono">{{ req.fundedAmount || 0 }} SOL</div> </div> </div> <div class="mb-4"> <div class="text-xs text-gray-500 mb-1">Funding Progress</div> <div class="progress-bar"> <div class="progress-fill bg-green-500" :style="{width: fundingProgressPercent(req) + '%'}"></div> </div> <div class="text-xs mt-1">{{ fundingProgressPercent(req) }}% Complete</div> </div> <div class="flex justify-end mt-4"> <button v-if="req.status !== 'funded'" class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200" @click="cancelFundingRequest_V1(req.id)"> <i class="fas fa-times mr-1"></i>Cancel Request </button> <span v-if="req.status === 'funded'" class="text-xs text-green-600"><i class="fas fa-check-circle mr-1"></i>Fully Funded!</span> </div> </div> </div> </div> </div>
            </div>
           <div v-if="role === 'buyer'"> <div> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-shopping-basket mr-2"></i>Your Purchase History ({{ buyerPurchases.length }}) </h3> <div v-if="buyerPurchases.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center"> <i class="fas fa-shopping-cart text-gray-400 text-2xl mb-2"></i> <p>You haven't made any purchases yet.</p> <button @click="switchPage('buyerAgriSell')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Browse marketplace</button> </div> <div v-else> <div class="overflow-x-auto"> <table class="min-w-full border divide-y divide-gray-200"> <thead class="bg-gray-50"> <tr> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Crop</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pesticide Co.</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price Paid (SOL)</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Purchase Date</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Seller</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Video/Tx</th> </tr> </thead> <tbody class="bg-white divide-y divide-gray-200"> <tr v-for="purchase in buyerPurchases" :key="purchase.id"> <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-medium text-gray-900">{{ purchase.crop }}</div> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ purchase.location }} </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ purchase.pesticideCompany || 'N/A' }} </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono"> {{ purchase.price }} </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ purchase.date }} </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ getSellerDisplayIdentifier(purchase.farmerWallet, 10) }} <button @click="showFarmerProfile(purchase.farmerWallet)" class="ml-1 text-blue-500 hover:text-blue-700 text-xs focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> <button @click="startOrGoToConversation(purchase.farmerWallet)" v-if="isUserAuthenticated && currentUserIdentifier !== purchase.farmerWallet" class="ml-1 text-green-600 hover:text-green-700 text-xs focus:outline-none" title="Message Seller"> <i class="fas fa-envelope"></i> </button> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600"> <a href="#" @click.prevent="viewPurchaseVideo(purchase)" class="hover:underline mr-2">Video</a> <a :href="solanaExplorerUrl(purchase.txHash)" target="_blank" class="hover:underline" title="View Transaction (Demo Link)">Tx</a> </td> </tr> </tbody> </table> </div> </div> </div> </div>
           <div v-if="role === 'investor'"> <div class="mb-8"> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-chart-pie mr-2"></i>Investment Portfolio Summary </h3> <div v-if="investorInvestments.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center"> <i class="fas fa-coins text-gray-400 text-2xl mb-2"></i> <p>You haven't made any investments yet.</p> <button @click="switchPage('investorProjects')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Browse investment opportunities</button> </div> <div v-else> <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6"> <div class="bg-gray-50 p-4 rounded-lg"> <div class="text-sm text-gray-500">Total Invested</div> <div class="text-xl font-bold text-green-700">{{ totalInvestedAmount }} SOL</div> </div> <div class="bg-gray-50 p-4 rounded-lg"> <div class="text-sm text-gray-500">Projects</div> <div class="text-xl font-bold">{{ investorInvestments.length }}</div> </div> <div class="bg-gray-50 p-4 rounded-lg"> <div class="text-sm text-gray-500">Avg. ROI</div> <div class="text-xl font-bold text-green-700">{{ investorAvgRoi }}%</div> </div> <div class="bg-gray-50 p-4 rounded-lg"> <div class="text-sm text-gray-500">Completed</div> <div class="text-xl font-bold">{{ investorCompletedProjects }}</div> </div> </div> <div class="overflow-x-auto mt-4"> <h4 class="text-lg font-semibold text-gray-800 mb-3">Your Investments</h4> <table class="min-w-full border divide-y divide-gray-200"> <thead class="bg-gray-50"> <tr> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Farmer</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount (SOL)</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th> </tr> </thead> <tbody class="bg-white divide-y divide-gray-200"> <tr v-for="inv in investorInvestments" :key="inv.id"> <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-medium text-gray-900">{{ inv.projectTitle }}</div> <div class="text-xs text-gray-500">{{ inv.crop }}</div> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ getFarmerDisplayIdentifier(inv.farmerWallet, 10) }} <button @click="showFarmerProfile(inv.farmerWallet)" class="ml-1 text-blue-500 hover:text-blue-700 text-xs focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> <button @click="startOrGoToConversation(inv.farmerWallet)" v-if="isUserAuthenticated && currentUserIdentifier !== inv.farmerWallet" class="ml-1 text-green-600 hover:text-green-700 text-xs focus:outline-none" title="Message Farmer"> <i class="fas fa-envelope"></i> </button> </td> <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-mono text-gray-900">{{ inv.amount }}</div> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ inv.investmentDate }} </td> <td class="px-6 py-4 whitespace-nowrap"> <span :class="{'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true, 'bg-blue-100 text-blue-800': inv.status === 'active', 'bg-green-100 text-green-800': inv.status === 'harvested', 'bg-yellow-100 text-yellow-800': inv.status === 'growing'}"> {{ inv.status.charAt(0).toUpperCase() + inv.status.slice(1) }} </span> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600"> <a href="#" @click.prevent="viewInvestmentDetails(inv)" class="hover:underline">View</a> </td> </tr> </tbody> </table> </div> <div class="mt-4 text-right"> <button @click="switchPage('investorPortfolio')" class="text-green-700 text-sm hover:underline">Go to Full Portfolio <i class="fas fa-arrow-right ml-1"></i></button> </div> </div> </div> <div> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-link mr-2"></i>Platform Verification (Simulated) </h3> <div class="bg-gray-50 p-5 rounded-lg border"> <div class="flex items-center mb-4"> <i class="fas fa-shield-alt text-green-600 text-2xl mr-3"></i> <div> <h4 class="font-bold text-gray-800">PestiVid Platform Records</h4> <p class="text-sm text-gray-600">All your investment transactions are recorded on the PestiVid platform (Simulated Ledger).</p> </div> </div> <div v-if="investorTransactions.length > 0" class="mt-4"> <h5 class="font-medium text-sm mb-2">Recent Transactions</h5> <div class="space-y-2"> <div v-for="tx in investorTransactions.slice(0, 3)" :key="tx.id" class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-2 bg-white rounded border text-sm"> <div class="flex items-center mb-1 sm:mb-0"> <span :class="{'px-2 py-0.5 text-xs rounded-full mr-2': true, 'bg-green-100 text-green-800': tx.type === 'investment', 'bg-blue-100 text-blue-800': tx.type === 'payout'}"> {{ tx.type === 'investment' ? 'Invest' : 'Payout' }} </span> <span class="font-mono text-xs text-gray-500 truncate" :title="tx.txHash">{{ tx.txHash.substring(0, 8) }}...{{ tx.txHash.substring(tx.txHash.length - 8) }}</span> <a :href="solanaExplorerUrl(tx.txHash)" target="_blank" class="text-blue-600 hover:underline whitespace-nowrap ml-2"> <i class="fas fa-external-link-alt"></i> View (Demo) </a> </div> <div class="text-right w-full sm:w-auto"> <div class="font-mono text-sm">{{ tx.amount }} SOL</div> <div class="text-xs text-gray-500">{{ tx.date }}</div> </div> </div> </div> <div class="mt-3 text-right"> <button @click="switchPage('investorPortfolio')" class="text-green-700 text-sm hover:underline">View all transactions <i class="fas fa-arrow-right ml-1"></i></button> </div> </div> <div v-else class="bg-white p-4 rounded border text-center text-sm text-gray-600"> <p>No platform transactions recorded yet.</p> </div> </div> </div> </div>
        </div>
      </div>
    </section>
    <section v-if="current==='messaging' && !isOrangeIdCallback" class="max-w-6xl mx-auto mt-6">
        <div v-if="!isUserAuthenticated" class="text-center p-10 bg-white rounded-lg shadow"> <i class="fas fa-exclamation-circle text-3xl text-yellow-500 mb-4"></i> <p class="text-xl text-gray-700">Please log in to access messaging.</p> </div>
      <div v-else class="bg-white rounded-lg shadow-md flex" style="height: calc(100vh - 200px);">
        <div class="w-full md:w-1/3 border-r flex flex-col bg-gray-50">
            <div class="p-4 border-b"> <h2 class="text-xl font-semibold text-green-700">Conversations</h2> </div>
            <div class="overflow-y-auto flex-1">
                <div v-if="userConversations.length === 0" class="p-4 text-center text-gray-500 mt-10"> <i class="fas fa-comment-slash fa-3x mb-3 text-gray-300"></i> <p>No conversations yet.</p> <p class="text-xs mt-1">Start a chat from a user's profile or project.</p> </div>
                <div v-for="conv in userConversations" :key="conv.id" @click="selectConversation(conv.id)" class="p-3 hover:bg-gray-100 cursor-pointer border-b flex items-center space-x-3" :class="{'bg-green-100 border-l-4 border-green-500': activeConversationId === conv.id, 'bg-white': activeConversationId !== conv.id}">
                    <div class="w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center text-lg flex-shrink-0"> {{ getOtherParticipantInitial(conv) }} </div>
                    <div class="flex-1 overflow-hidden"> <div class="font-semibold text-gray-800 truncate">{{ getOtherParticipantDisplayAddress(conv) }}</div> <div class="text-xs text-gray-500 truncate">{{ conv.lastMessageSnippet }}</div> </div>
                    <div class="text-xs text-gray-400 self-start whitespace-nowrap">{{ formatTimestamp(conv.lastMessageTimestamp, true) }}</div>
                    <div v-if="getUnreadCountForConversation(conv.id) > 0" class="bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs ml-auto flex-shrink-0"> {{ getUnreadCountForConversation(conv.id) }} </div>
                </div>
            </div>
        </div>
        <div class="w-full md:w-2/3 flex flex-col bg-white">
            <div v-if="!activeConversationId" class="flex-1 flex flex-col items-center justify-center text-gray-400 p-10 text-center"> <i class="fas fa-comments fa-4x mb-4"></i> <h3 class="text-xl text-gray-600">Welcome to PestiVid Chat</h3> <p>Select a conversation from the left to view messages, or start a new chat from a user's profile or project page.</p> </div>
            <template v-else>
                <div class="p-4 border-b bg-gray-50 flex items-center sticky top-0 z-10"> <div class="w-8 h-8 rounded-full bg-green-600 text-white flex items-center justify-center text-sm mr-3 flex-shrink-0"> {{ activeConversationPartnerInitial ? activeConversationPartnerInitial : '?' }} </div> <h3 class="font-semibold text-lg text-green-800">{{ activeConversationPartnerDisplayAddress }}</h3> </div>
                <div class="flex-1 overflow-y-auto p-4 space-y-3 message-view-container bg-gray-100" ref="messageContainer">
                    <div v-if="currentMessages.length === 0" class="text-center text-gray-500 py-10"> No messages in this conversation yet. Say hello! </div>
                    <div v-for="msg in currentMessages" :key="msg.id" class="flex" :class="msg.sender === currentUserIdentifier ? 'justify-end' : 'justify-start'">
                        <div class="max-w-xs md:max-w-md lg:max-w-lg"> <div class="p-3 rounded-xl shadow" :class="msg.sender === currentUserIdentifier ? 'bg-green-600 text-white' : 'bg-white text-gray-800 border'"> <p class="text-sm leading-relaxed">{{ msg.text }}</p> </div> <p class="text-xs mt-1 px-1" :class="msg.sender === currentUserIdentifier ? 'text-gray-400 text-right' : 'text-gray-400 text-left'"> {{ formatTimestamp(msg.timestamp) }} <span v-if="msg.sender === currentUserIdentifier && msg.read"><i class="fas fa-check-double text-blue-400 ml-1" title="Read"></i></span> <span v-if="msg.sender === currentUserIdentifier && !msg.read"><i class="fas fa-check text-gray-400 ml-1" title="Sent"></i></span> </p> </div>
                    </div>
                </div>
                <div class="p-3 border-t bg-gray-50"> <form @submit.prevent="sendMessage" class="flex gap-3 items-center"> <input v-model="messageInputText" type="text" placeholder="Type your message..." class="flex-1 px-4 py-2 border border-gray-300 rounded-full focus:ring-green-500 focus:border-green-500 text-sm" required> <button type="submit" :disabled="!messageInputText.trim()" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-full text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 disabled:opacity-50"> <i class="fas fa-paper-plane mr-1"></i> Send </button> </form> </div>
            </template>
        </div>
      </div>
    </section>
    <section v-if="current==='plantRecomendation' && !isOrangeIdCallback" class="max-w-3xl mx-auto mt-6">
      <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-leaf mr-2"></i>Plant Disease Detection & Recommendation</h2>
      <div class="bg-white rounded shadow-md p-6 space-y-6">
        <p class="text-sm text-gray-600">Upload an image of an affected plant. Gemini AI will attempt to identify the plant, detect diseases, and suggest treatments.</p>

        <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4" role="alert">
          <p class="font-bold">Developer Note:</p>
          <p class="text-sm">The Gemini API key is currently embedded in the client-side code for this demo. In a production environment, this is insecure and should be handled via a backend proxy.</p>
        </div>

        <div>
          <label class="block text-gray-600 mb-1 text-sm">Upload Plant Image</label>
          <input type="file" @change="handlePlantImageUpload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
        </div>

        <div v-if="plantImageUrl" class="mt-4">
          <h4 class="text-md font-semibold text-gray-700 mb-2">Image Preview:</h4>
          <img :src="plantImageUrl" alt="Plant Preview" class="max-w-xs md:max-w-sm rounded-md border shadow mx-auto">
        </div>

        <button @click="analyzePlant" :disabled="!plantImageFile || analysisInProgress" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded text-sm flex items-center justify-center" :class="{'opacity-50 cursor-not-allowed': !plantImageFile || analysisInProgress}">
          <i :class="analysisInProgress ? 'fas fa-spinner fa-spin' : 'fas fa-search-plus'" class="mr-2"></i>
          {{ analysisInProgress ? 'Analyzing...' : 'Analyze Plant with Gemini AI' }}
        </button>

        <div v-if="analysisErrorText" class="mt-4 bg-red-100 border border-red-300 text-red-700 px-4 py-3 rounded text-sm">
          <p class="font-bold">Analysis Error:</p>
          <p>{{ analysisErrorText }}</p>
        </div>

        <div v-if="parsedAnalysis.plantName && !analysisInProgress && !analysisErrorText" class="mt-6 border-t pt-6 space-y-4">
          <h3 class="text-xl font-semibold text-green-700">Analysis Results:</h3>
          <div>
            <p class="text-sm font-medium text-gray-500">Identified Plant:</p>
            <p class="text-lg text-gray-800">{{ parsedAnalysis.plantName || 'Could not identify plant.' }}</p>
          </div>
          <div>
            <p class="text-sm font-medium text-gray-500">Detected Disease:</p>
            <p class="text-lg text-gray-800 font-semibold" :class="{'text-red-600': parsedAnalysis.diseaseName && parsedAnalysis.diseaseName.toLowerCase() !== 'healthy' && parsedAnalysis.diseaseName.toLowerCase() !== 'not apparent' && parsedAnalysis.diseaseName.toLowerCase() !== 'unknown', 'text-green-600': parsedAnalysis.diseaseName && (parsedAnalysis.diseaseName.toLowerCase() === 'healthy' || parsedAnalysis.diseaseName.toLowerCase() === 'not apparent')}">
              {{ parsedAnalysis.diseaseName || 'Could not determine disease.' }}
            </p>
          </div>
          <div>
            <p class="text-sm font-medium text-gray-500">Recommended Treatment / Pesticides:</p>
            <p class="text-md text-gray-700 whitespace-pre-wrap">{{ parsedAnalysis.treatmentRecommended || 'No specific treatment recommended.' }}</p>
          </div>
           <div v-if="analysisResultText && (!parsedAnalysis.plantName || parsedAnalysis.plantName === 'Unknown' || parsedAnalysis.plantName === '-')" class="mt-4 bg-gray-50 p-3 rounded border text-xs">
                <p class="font-semibold mb-1">Raw Gemini Output (for debugging if parsing failed):</p>
                <pre class="whitespace-pre-wrap overflow-x-auto">{{ analysisResultText }}</pre>
            </div>
        </div>
      </div>
    </section>

    <!-- Modals (Purchase Video, Buy Listing, Investment Details, Farmer Profile) -->
     <!-- Purchase Video Modal -->
    <div v-if="selectedPurchase && showPurchaseVideo && !isOrangeIdCallback" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full modal-scrollable">
        <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white z-10"> <h3 class="font-bold text-lg text-green-700">{{ selectedPurchase.crop }} - Purchase Verification</h3> <button @click="showPurchaseVideo = false" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times"></i> </button> </div>
        <div class="p-4"> <video :src="ipfsUrl(selectedPurchase.cid)" controls playsinline webkit-playsinline class="w-full rounded bg-black mb-4"></video> <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm"> <div> <p class="text-gray-600">Location</p> <p class="font-medium">{{ selectedPurchase.location }}</p> </div> <div> <p class="text-gray-600">Pesticide Used</p> <p class="font-medium">{{ selectedPurchase.pesticide }}</p> </div> <div> <p class="text-gray-600">Pesticide Company</p> <p class="font-medium">{{ selectedPurchase.pesticideCompany || 'N/A' }}</p> </div> <div> <p class="text-gray-600">Purchase Price</p> <p class="font-medium font-mono">{{ selectedPurchase.price }} SOL</p> </div> <div> <p class="text-gray-600">Purchase Date</p> <p class="font-medium">{{ selectedPurchase.date }}</p> </div> <div> <p class="text-gray-600">Seller Identifier</p> <p class="font-medium font-mono text-xs">{{ selectedPurchase.farmerWallet }}</p> </div> </div> <div class="mt-4 bg-gray-100 p-3 rounded text-xs border"> <p class="font-bold mb-1">Platform Verification (Simulated):</p> <p class="font-mono break-all mb-1">IPFS CID: {{ selectedPurchase.cid }}</p> <p class="font-mono break-all">Simulated Tx: {{ selectedPurchase.txHash }} <a :href="solanaExplorerUrl(selectedPurchase.txHash)" target="_blank" class="text-blue-500 hover:text-blue-700"><i class="fas fa-external-link-alt text-xs"></i></a> </p> <p class="mt-1 text-gray-500">Video evidence on IPFS, linked on PestiVid platform (Simulated).</p> <a :href="ipfsUrl(selectedPurchase.cid)" target="_blank" class="text-blue-600 hover:underline mt-1 inline-block">View on IPFS Gateway <i class="fas fa-external-link-alt text-xs ml-1"></i></a> </div> </div>
        <div class="bg-gray-50 p-4 flex justify-end rounded-b-lg sticky bottom-0 border-t"> <button @click="showPurchaseVideo = false" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded text-sm"> Close </button> </div>
      </div>
    </div>
    <!-- Buy Listing Modal -->
    <div v-if="showBuyModal && selectedListing && !isOrangeIdCallback" class="fixed inset-0 z-50 bg-black bg-opacity-60 flex justify-center items-center p-4">
      <div class="bg-white rounded shadow-lg w-full max-w-sm p-6 relative mx-2 modal-scrollable">
        <button class="absolute top-2 right-2 text-gray-400 hover:text-red-500" @click="closeBuyModal"><i class="fas fa-times"></i></button>
        <h3 class="font-bold text-green-700 text-lg mb-3">Purchase Crop Batch</h3>
        <video :src="ipfsUrl(selectedListing.cid)" controls playsinline webkit-playsinline class="rounded w-full mb-3 bg-black"></video>
        <div class="mb-1 font-bold">{{ selectedListing.crop }}</div> <div class="text-xs text-gray-600 mb-1">Location: <span class="font-mono">{{ selectedListing.location }}</span></div> <div class="text-xs text-gray-500 mb-1">Pesticide: <span class="font-mono">{{ selectedListing.pesticide }}</span></div> <div class="text-xs text-gray-500 mb-2">Pesticide Co.: <span class="font-mono">{{ selectedListing.pesticideCompany || 'N/A' }}</span></div> <div class="text-sm mb-2">Price Range: <span class="mx-1 font-mono font-semibold">{{ selectedListing.minPrice }}</span> - <span class="ml-1 font-mono font-semibold">{{ selectedListing.maxPrice }}</span> SOL </div>
        <form @submit.prevent="processPurchase"> <label class="text-sm block text-gray-600 mb-1">Your Offer (SOL)</label> <input type="number" v-model.number="purchaseAmount" :min="selectedListing.minPrice" :max="selectedListing.maxPrice" step="0.01" required :placeholder="`Enter amount (${selectedListing.minPrice}-${selectedListing.maxPrice})`" class="w-full px-3 py-2 border rounded mb-3 text-sm"> <button type="submit" class="bg-green-600 hover:bg-green-700 text-white w-full py-2 rounded text-sm" :disabled="!isUserAuthenticated"> <i class="fas fa-check mr-1"></i>Confirm Purchase (Simulated) </button> </form>
        <div v-if="purchaseStatus" class="text-green-700 font-semibold mt-3 text-sm bg-green-50 p-2 rounded border border-green-200">{{purchaseStatus}}</div> <div v-if="purchaseError" class="text-red-600 font-semibold mt-3 text-sm bg-red-50 p-2 rounded border border-red-200">{{purchaseError}}</div>
      </div>
    </div>
    <!-- Investment Details Modal -->
    <div v-if="showInvestmentDetailsModal && selectedInvestment && !isOrangeIdCallback" class="fixed inset-0 z-50 bg-black bg-opacity-70 flex justify-center items-center p-4">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl relative mx-2 modal-scrollable">
        <div class="p-4 bg-green-50 border-b flex justify-between items-center sticky top-0 z-10"> <h3 class="font-bold text-lg text-green-800">{{ selectedInvestment.projectTitle }}</h3> <button class="text-gray-400 hover:text-red-500" @click="showInvestmentDetailsModal=false"><i class="fas fa-times"></i></button> </div>
        <div class="p-6"> <div class="flex flex-col md:flex-row gap-6"> <div class="md:w-1/3"> <video :src="ipfsUrl(selectedInvestment.cid)" controls playsinline webkit-playsinline class="rounded w-full h-40 object-cover bg-black mb-3"></video> <div class="mt-3 space-y-2 text-sm"> <div> <div class="text-xs text-gray-500">Farmer Identifier</div> <div class="font-medium flex items-center font-mono text-xs"> <span>{{ selectedInvestment.farmerWallet }}</span> <button @click="showFarmerProfile(selectedInvestment.farmerWallet); showInvestmentDetailsModal=false;" class="ml-2 text-blue-500 hover:text-blue-700 text-xs focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> <button @click="startOrGoToConversation(selectedInvestment.farmerWallet); showInvestmentDetailsModal=false;" v-if="isUserAuthenticated && currentUserIdentifier !== selectedInvestment.farmerWallet" class="ml-2 text-green-600 hover:text-green-700 text-xs focus:outline-none" title="Message Farmer"> <i class="fas fa-envelope"></i> </button> </div> </div> <div> <div class="text-xs text-gray-500">Investment Date</div> <div class="font-medium">{{ selectedInvestment.investmentDate }}</div> </div> <div> <div class="text-xs text-gray-500">Amount Invested</div> <div class="font-medium text-green-700 font-mono">{{ selectedInvestment.amount }} SOL</div> </div> <div> <div class="text-xs text-gray-500">Status</div> <span :class="{'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true, 'bg-blue-100 text-blue-800': selectedInvestment.status === 'active', 'bg-green-100 text-green-800': selectedInvestment.status === 'harvested', 'bg-yellow-100 text-yellow-800': selectedInvestment.status === 'growing'}"> {{ selectedInvestment.status.charAt(0).toUpperCase() + selectedInvestment.status.slice(1) }} </span> </div> </div> </div> <div class="md:w-2/3"> <div class="mb-4"> <div class="text-sm font-medium mb-1">{{ selectedInvestment.crop }} ({{ selectedInvestment.method }})</div> <p class="text-sm text-gray-700 max-h-24 overflow-y-auto border p-2 rounded bg-gray-50">{{ selectedInvestment.description }}</p> </div> <div class="mb-4"> <div class="text-xs text-gray-500 mb-1">Project Progress</div> <div class="progress-bar"> <div class="progress-fill bg-green-500" :style="{width: selectedInvestment.progress + '%'}"></div> </div> <div class="flex justify-between text-xs mt-1"> <span>{{ selectedInvestment.progress }}% Complete</span> <span>Est. {{ selectedInvestment.timeline }} months total</span> </div> </div> <div class="grid grid-cols-2 gap-4 mb-4 text-sm"> <div> <div class="text-xs text-gray-500">Expected Return</div> <div class="font-medium text-green-700 font-mono">{{ calculateExpectedReturn(selectedInvestment) }} SOL</div> </div> <div> <div class="text-xs text-gray-500">ROI</div> <div class="font-medium text-green-700">{{ selectedInvestment.roi }}%</div> </div> <div> <div class="text-xs text-gray-500">Land Size</div> <div class="font-medium">{{ selectedInvestment.acres }} acres</div> </div> <div> <div class="text-xs text-gray-500">Your Share</div> <div class="font-medium">{{ selectedInvestment.investorShare }}%</div> </div> </div> <div v-if="selectedInvestmentProject && selectedInvestmentProject.updates && selectedInvestmentProject.updates.length > 0" class="mb-4"> <h4 class="text-sm font-semibold text-gray-700 mb-2">Farmer Updates</h4> <div class="project-updates-list text-xs"> <div v-for="update in selectedInvestmentProject.updates.slice().reverse()" :key="update.id" class="project-update-item"> <span class="font-medium text-gray-500">{{ update.date }}:</span> {{ update.text }} </div> </div> </div> <div v-else-if="selectedInvestmentProject" class="mb-4 text-xs text-gray-500"> No project updates posted by the farmer yet. </div> <div class="bg-gray-100 p-3 rounded mb-4 border"> <div class="text-sm font-medium mb-1">Platform Transaction (Simulated)</div> <div class="flex items-center text-xs"> <span class="font-mono bg-white px-2 py-1 rounded border mr-2 truncate" :title="selectedInvestment.txHash">{{ selectedInvestment.txHash }}</span> <a :href="solanaExplorerUrl(selectedInvestment.txHash)" target="_blank" class="text-blue-600 hover:underline whitespace-nowrap"> <i class="fas fa-external-link-alt"></i> View (Demo Link) </a> </div> </div> <div v-if="selectedInvestment.status === 'harvested'" class="bg-green-100 p-3 rounded border border-green-200"> <div class="flex items-center"> <i class="fas fa-check-circle text-green-600 mr-2 text-lg"></i> <div> <div class="font-medium">Harvest Completed & Payout Processed</div> <div class="text-sm">Your return of {{ calculateExpectedReturn(selectedInvestment) }} SOL has been simulated.</div> </div> </div> </div> <div v-else-if="selectedInvestment.status === 'growing'" class="bg-yellow-50 p-3 rounded border border-yellow-200"> <div class="flex items-center"> <i class="fas fa-hourglass-half text-yellow-600 mr-2 text-lg"></i> <div> <div class="font-medium">Project Growing</div> <div class="text-sm">Harvest expected within {{ selectedInvestment.timeline }} months. Progress: {{selectedInvestment.progress}}%.</div> </div> </div> </div> </div> </div> </div>
        <div class="bg-gray-50 p-4 flex justify-end rounded-b-lg sticky bottom-0 border-t"> <button @click="showInvestmentDetailsModal=false" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded text-sm"> Close </button> </div>
      </div>
    </div>
    <!-- Farmer Profile Modal -->
    <div v-if="showFarmerProfileModal && selectedFarmerProfile && !isOrangeIdCallback" class="fixed inset-0 z-50 bg-black bg-opacity-70 flex justify-center items-center p-4">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-lg relative mx-2 modal-scrollable">
        <div class="p-4 bg-green-50 border-b flex justify-between items-center sticky top-0 z-10"> <h3 class="font-bold text-lg text-green-800 flex items-center"> <i class="fas fa-user-tie mr-2"></i> Farmer Profile </h3> <button class="text-gray-400 hover:text-red-500" @click="closeFarmerProfileModal"><i class="fas fa-times"></i></button> </div>
        <div class="p-6 space-y-5"> <div class="flex items-center space-x-4"> <div class="bg-green-100 rounded-full w-16 h-16 flex items-center justify-center text-green-600 text-2xl"> <i class="fas fa-tractor"></i> </div> <div> <p class="text-xs text-gray-500">Farmer Identifier</p> <p class="font-semibold text-lg text-green-700 font-mono">{{ getFarmerDisplayIdentifier(selectedFarmerProfile.walletAddress, 10) }}</p> <p class="text-sm text-gray-600">Farm Name (Sim.): {{ selectedFarmerProfile.farmName || 'N/A' }}</p> </div> </div> <div class="border-t pt-4"> <p class="text-xs text-gray-500">Short Bio (Simulated)</p> <p class="text-sm text-gray-700 italic">{{ selectedFarmerProfile.bio || 'This farmer has not provided a bio yet.' }}</p> </div> <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-4"> <div> <p class="text-xs text-gray-500">PestiVid Email</p> <p class="text-sm">{{ selectedFarmerProfile.email }}</p> </div> <div> <p class="text-xs text-gray-500">PestiVid Member Since</p> <p class="text-sm">{{ selectedFarmerProfile.memberSince }}</p> </div> </div> <div class="border-t pt-4"> <p class="text-sm font-medium text-gray-700 mb-2">Platform Activity:</p> <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm"> <div class="bg-gray-100 p-3 rounded-md"> <p class="font-semibold">{{ selectedFarmerProfile.fundingRequestCount }}</p> <p class="text-xs text-gray-500">Active Funding Request(s)</p> </div> <div class="bg-gray-100 p-3 rounded-md"> <p class="font-semibold">{{ selectedFarmerProfile.activeListingCount }}</p> <p class="text-xs text-gray-500">Active Marketplace Listing(s)</p> </div> </div> <p class="text-xs text-gray-400 mt-2">(Note: Activity based on currently visible items on the platform.)</p> </div> </div>
        <div class="bg-gray-50 p-4 flex justify-between items-center rounded-b-lg sticky bottom-0 border-t"> <button @click="messageFarmerFromProfile" v-if="isUserAuthenticated && selectedFarmerProfile && currentUserIdentifier !== selectedFarmerProfile.walletAddress" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm"> <i class="fas fa-paper-plane mr-1"></i> Send Message </button> <div v-else class="w-full"></div> <button @click="closeFarmerProfileModal" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded text-sm"> Close </button> </div>
      </div>
    </div>


    <!-- Notification Toast Container -->
    <div class="notification-toast-container">
        <div v-for="n in recentNotifications" :key="n.id" class="notification-toast" :class="{'show': n.show}" :data-notif-id="n.id"> <span :class="['icon', 'icon-' + n.type]"> <i :class="n.type === 'success' ? 'fas fa-check-circle' : (n.type === 'info' ? 'fas fa-info-circle' : (n.type === 'warning' ? 'fas fa-exclamation-triangle' : 'fas fa-bug'))"></i> </span> <span class="message">{{ n.message }}</span> <button @click="dismissNotification(n.id)" class="close-btn">&times;</button> </div>
    </div>
    <!-- Loading/Transaction Modal -->
    <div v-if="showLoadingModal" class="loading-modal"> <div class="loading-content"> <i class="fas fa-spinner fa-spin"></i> <p class="text-gray-700">{{ loadingMessage }}</p> </div> </div>
  </main>

  <footer class="bg-white border-t py-6 mt-auto text-center text-sm text-gray-500">
    <span> {{ new Date().getFullYear() }} PestiVid  Blockchain Agricultural Platform (Web3 Demo)</span>
  </footer>
</div>
<script>

  const app = new Vue({
    el: "#app",
    data: {
      current: 'landing',
      showMobileMenu: false,

      // --- Authentication State ---
      loginMethod: null, // 'solana' or 'orangeId'
      currentUserIdentifier: null, // Solana wallet address or Orange ID user subject/ID
      isAuthProcessing: false, // General auth processing flag

      // --- Orange ID Specific State ---
      orangeIdUser: null, // Stores the user object from Orange ID SDK
      orangeIdBedrockSDK: null, // Will hold the Bedrock instance
      orangeIdReactRootLogin: null, // React root for LoginPanel
      orangeIdReactRootCallback: null, // React root for CallbackProcessor
      orangeIdReactRootSignOut: null, // React root for SignOutButton
      orangeIdReactRootSignOutMobile: null, // React root for SignOutButton mobile
      orangeIdWidgetMounted: false,
      orangeIdBedrockSDKError: false,
      isOrangeIdCallback: false, // True if current URL is an Orange ID callback
      bedrockConfig: {
        baseUrl: 'https://api.bedrockpassport.com',
        // IMPORTANT: Ensure this authCallbackUrl EXACTLY MATCHES what you've set in your Orange ID project dashboard.
        authCallbackUrl: window.location.href.split('?')[0].split('#')[0], // Removes query params and hash for clean callback
        // !!! REPLACE THESE WITH YOUR ACTUAL ORANGE ID PROJECT DETAILS !!!
        tenantId: 'YOUR_ORANGE_ID_TENANT_ID', // e.g., 'orange-xxxxxxxxxx'
        subscriptionKey: 'YOUR_ORANGE_ID_API_KEY' // e.g., 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'
        // !!! END OF ORANGE ID PLACEHOLDERS !!!
      },

      // Solana Wallet Specific State
      walletAddress: null,

      // Unified PestiVid User Profile Data
      role: '',
      userName: '',
      userEmail: '',
      userPhone: '',
      memberSince: '',
      farmerLocationCity: '',

      // Onboarding State
      selectedRoleOnboarding: '',
      userNameOnboarding: '',
      userEmailOnboarding: '',
      userPhoneOnboarding: '',
      farmerLocationCityOnboarding: '',

      // PestiVid Feature State
      recordForm: {crop:'', pesticide:'', location:'', pesticideCompany: '', purpose: 'agristream'},
      recordStream: null, recordMediaRecorder: null, recording: false, recordBlob: null, recordBlobUrl: '',
      showLive: false, uploadCid: '', uploading: false, uploadError: '', lastUploadedVideoPurpose: '',
      farmerVideos: [], farmerListings: [], listingForm: {cid:'', minPrice:'', maxPrice:'', notifyBuyers: true},
      createdListingId: null, listingNotificationSent: false,
      farmerFundingRequests: [],
      fundingForm: { title: '', crop: '', acres: null, amount: null, method: '', cid: '', description: '', timeline: null, roi: null, investorShare: null, notifyInvestors: true },
      createdFundingRequest: false,
      newUpdateText: {},
      buyerPurchases: [], selectedPurchase: null, showPurchaseVideo: false,
      allListings: [], buyerFilters: {crop:'', location:'', pesticideCompany: ''}, showBuyModal: false,
      selectedListing: null, purchaseAmount: null, purchaseStatus: '', purchaseError: '',
      investorInvestments: [], investorTransactions: [],
      investorFilters: {crop: '', method: '', minRoi: null, maxAmount: null},
      allFundingRequests: [], investmentAmounts: {}, investmentErrors: {},
      showInvestmentDetailsModal: false, selectedInvestment: null, selectedInvestmentProject: null,
      showFarmerProfileModal: false, selectedFarmerProfile: null,

      // !!! REPLACE 'YOUR_PINATA_JWT' with your actual Pinata JWT. Video uploads WILL FAIL without it. !!!
      pinataJwt: 'YOUR_PINATA_JWT',
      // !!! REPLACE 'YOUR_PINATA_GATEWAY_HOSTNAME' (e.g., 'your-gateway-name.mypinata.cloud' or 'gateway.pinata.cloud'). Video playback WILL FAIL without it. !!!
      pinataGateway: 'YOUR_PINATA_GATEWAY_HOSTNAME',

      // !!! REPLACE 'YOUR_OPENWEATHERMAP_API_KEY'. Weather feature WILL NOT WORK without it. !!!
      weatherApiKey: 'YOUR_OPENWEATHERMAP_API_KEY',

      conversations: [], messages: [], activeConversationId: null, messageInputText: '',
      notifications: [], recentNotifications: [],
      showLoadingModal: false, loadingMessage: '',
      targetAgriStreamVideoCid: null, highlightedAgriStreamVideoCid: null,

      // !!! REPLACE 'YOUR_GEMINI_API_KEY_HERE'. Plant recommendation WILL FAIL without it. !!!
      // Client-side API keys are insecure for production. Use a backend proxy.
      geminiApiKey: 'YOUR_GEMINI_API_KEY_HERE',
      plantImageFile: null,
      plantImageUrl: null,
      plantImageMimeType: null,
      analysisInProgress: false,
      analysisResultText: '',
      parsedAnalysis: { plantName: null, diseaseName: null, treatmentRecommended: null },
      analysisErrorText: '',
    },
    computed: {
      isUserAuthenticated() {
          return !!this.currentUserIdentifier && !this.isAuthProcessing && !this.isOrangeIdCallback;
      },
      displayedUserIdentifier() {
          if (!this.currentUserIdentifier) return '';
          if (this.userName) return this.userName.split(' ')[0];

          if (this.loginMethod === 'orangeId' && this.orangeIdUser) {
              const nameOrEmail = (this.orangeIdUser.name || this.orangeIdUser.email || this.currentUserIdentifier);
              return nameOrEmail.split(' ')[0];
          }
          if (this.loginMethod === 'solana' && this.walletAddress) {
              const id = this.walletAddress.toString();
              return `${id.substring(0, 6)}...${id.substring(id.length - 4)}`;
          }
          const shortId = String(this.currentUserIdentifier); // Ensure it's a string
          return shortId.substring(0,8) + '...';
      },
      uniqueCrops() { const crops = this.allListings.map(l=>l.crop).filter(Boolean); return [...new Set(crops)].sort(); },
      filteredListings() { const oneDayAgo = Date.now() - (24*60*60*1000); return this.allListings.map(l => ({...l, isNew: new Date(l.createdAt).getTime() > oneDayAgo })).filter(l => { const cropMatch = !this.buyerFilters.crop || (l.crop || '').toLowerCase() === this.buyerFilters.crop.toLowerCase(); const locMatch = !this.buyerFilters.location || (l.location || '').toLowerCase().includes(this.buyerFilters.location.toLowerCase()); const companyMatch = !this.buyerFilters.pesticideCompany || (l.pesticideCompany || '').toLowerCase().includes(this.buyerFilters.pesticideCompany.toLowerCase()); return cropMatch && locMatch && companyMatch; }); },
      availableVideosForListing() { if (!this.isUserAuthenticated) return []; const listedCids = new Set(this.farmerListings.map(l => l.cid)); return this.farmerVideos.filter(v => v.farmerWallet === this.currentUserIdentifier && (v.purpose === 'sell' || v.purpose === 'agristream') && !listedCids.has(v.cid)); },
      availableVideosForFunding() { if (!this.isUserAuthenticated) return []; const fundingCids = new Set(this.farmerFundingRequests.map(r => r.cid)); return this.farmerVideos.filter(v => v.farmerWallet === this.currentUserIdentifier && (v.purpose === 'funding' || v.purpose === 'agristream') && !fundingCids.has(v.cid)); },
      uniqueFundingCrops() { const crops = this.allFundingRequests.map(r=>r.crop).filter(Boolean); return [...new Set(crops)].sort(); },
      filteredFundingRequests() { const oneDayAgo = Date.now() - (24*60*60*1000); return this.allFundingRequests.map(r => ({ ...r, isNew: new Date(r.createdAt).getTime() > oneDayAgo })).filter(r => { const isRelevantStatus = r.status === 'pending' || r.status === 'partially_funded'; const cropMatch = !this.investorFilters.crop || (r.crop||'').toLowerCase() === this.investorFilters.crop.toLowerCase(); const methodMatch = !this.investorFilters.method || (r.method||'').toLowerCase() === this.investorFilters.method.toLowerCase(); const roiMatch = !this.investorFilters.minRoi || r.roi >= this.investorFilters.minRoi; const amountMatch = !this.investorFilters.maxAmount || r.amount <= this.investorFilters.maxAmount; return isRelevantStatus && cropMatch && methodMatch && roiMatch && amountMatch; }); },
      totalInvestedAmount() { if (!this.investorInvestments || this.investorInvestments.length === 0) return '0.00'; return this.investorInvestments.reduce((sum, inv) => sum + inv.amount, 0).toFixed(2); },
      investorActiveProjects() { if (!this.investorInvestments) return 0; return this.investorInvestments.filter(inv => inv.status === 'active' || inv.status === 'growing').length; },
      investorCompletedProjects() { if (!this.investorInvestments) return 0; return this.investorInvestments.filter(inv => inv.status === 'harvested').length; },
      investorAvgRoi() { if (!this.investorInvestments || this.investorInvestments.length === 0) return '0.0'; const totalRoi = this.investorInvestments.reduce((sum, inv) => sum + inv.roi, 0); return this.investorInvestments.length > 0 ? (totalRoi / this.investorInvestments.length).toFixed(1) : '0.0'; },
      userConversations() { if (!this.isUserAuthenticated) return []; return this.conversations.filter(conv => conv.participants.includes(this.currentUserIdentifier)).sort((a, b) => new Date(b.lastMessageTimestamp).getTime() - new Date(a.lastMessageTimestamp).getTime()); },
      currentMessages() { if (!this.activeConversationId || !this.isUserAuthenticated) return []; return this.messages.filter(msg => msg.conversationId === this.activeConversationId).sort((a, b) => new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime()); },
      activeConversationPartnerIdentifier() { if (!this.activeConversationId || !this.isUserAuthenticated) return null; const conv = this.conversations.find(c => c.id === this.activeConversationId); if (!conv) return null; return conv.participants.find(p => p !== this.currentUserIdentifier); },
      activeConversationPartnerDisplayAddress() { const partnerId = this.activeConversationPartnerIdentifier; if (!partnerId) return '?'; const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles')) || {}; const partnerProfile = userProfiles[partnerId]; if(partnerProfile && partnerProfile.name) return partnerProfile.name.split(" ")[0]; return `${String(partnerId).substring(0,6)}...${String(partnerId).substring(String(partnerId).length-4)}`; },
      activeConversationPartnerInitial() { const partnerDisplay = this.activeConversationPartnerDisplayAddress; if (!partnerDisplay || partnerDisplay === '?') return '?'; return partnerDisplay.charAt(0).toUpperCase(); },
      unreadMessageCount() { if (!this.isUserAuthenticated) return 0; return this.messages.filter(msg => msg.receiver === this.currentUserIdentifier && !msg.read).length; },
    },
    watch: {
      current(newPage, oldPage) {
          window.scrollTo(0,0);
          if (newPage === 'farmerAgriStream' && this.targetAgriStreamVideoCid) { this.scrollToAndHighlightAgriStreamVideo(); }
          else if (newPage !== 'farmerAgriStream') { this.highlightedAgriStreamVideoCid = null; }

          if (newPage === 'investorPortfolio' && this.isUserAuthenticated && this.role === 'investor') { this.updateInvestmentProgress(); }
          if (newPage === 'userProfile' && this.isUserAuthenticated && this.role === 'farmer' && this.farmerLocationCity && !this.currentWeather) { this.fetchWeather(); }
          if (newPage === 'messaging' && this.activeConversationId) { this.scrollToMessageBottom(); this.markConversationAsRead(this.activeConversationId); }

          if (newPage === 'loginChoice' && !this.isOrangeIdCallback && !this.isUserAuthenticated) {
              this.$nextTick(() => this.renderOrangeIdLoginWidget());
          } else if (oldPage === 'loginChoice' && newPage !== 'loginChoice') {
              this.$nextTick(() => this.unmountOrangeIdLoginWidget());
          }
          if (oldPage === 'plantRecomendation' && newPage !== 'plantRecomendation') {
              this.plantImageFile = null; this.plantImageUrl = null; this.plantImageMimeType = null;
              this.analysisResultText = ''; this.parsedAnalysis = { plantName: null, diseaseName: null, treatmentRecommended: null };
              this.analysisErrorText = '';
          }

          if (this.isUserAuthenticated && !this.isOrangeIdCallback) {
              if (this.role) {
                  const nonPortalPagesForAuthenticatedUser = ['landing', 'loginChoice', 'roleSelection'];
                  if (nonPortalPagesForAuthenticatedUser.includes(newPage)) {
                      console.log(`[Watcher:current] User authenticated (Role: ${this.role}), but on ${newPage}. Redirecting via getStarted().`);
                      this.$nextTick(() => {
                          if (this.isUserAuthenticated && this.role && nonPortalPagesForAuthenticatedUser.includes(this.current) && !this.isOrangeIdCallback) {
                              this.getStarted();
                          }
                      });
                  }
              } else { // User authenticated, but no PestiVid role selected yet
                  // If user is authenticated and has no role, they should be on 'roleSelection' or 'landing'.
                  // If they land on 'loginChoice' while in this state, redirect them to 'roleSelection'.
                  if (newPage === 'loginChoice') {
                     console.log(`[Watcher:current] User authenticated (No Role), but on loginChoice. Redirecting to roleSelection.`);
                     this.$nextTick(() => {
                         if (this.isUserAuthenticated && !this.role && this.current === 'loginChoice' && !this.isOrangeIdCallback) {
                             this.switchPage('roleSelection');
                         }
                     });
                  } else if (newPage !== 'roleSelection' && newPage !== 'landing') {
                     // If they are on any other page that is not 'roleSelection' or 'landing', also guide to 'roleSelection'.
                     console.log(`[Watcher:current] User authenticated (No Role), but on ${newPage}. Redirecting to roleSelection.`);
                      this.$nextTick(() => {
                          if (this.isUserAuthenticated && !this.role && this.current !== 'roleSelection' && this.current !== 'landing' && !this.isOrangeIdCallback) {
                              this.switchPage('roleSelection');
                          }
                      });
                  }
              }
          }
      },
      isUserAuthenticated(isAuthenticated) {
          this.$nextTick(() => {
              if (isAuthenticated && this.loginMethod === 'orangeId') {
                  this.renderOrangeIdSignOutButton('orange-id-signout-button-container');
                  if (this.showMobileMenu) {
                      this.renderOrangeIdSignOutButton('orange-id-signout-button-container-mobile', true);
                  }
              } else if (!isAuthenticated) {
                  this.unmountOrangeIdSignOutButton('orange-id-signout-button-container');
                  this.unmountOrangeIdSignOutButton('orange-id-signout-button-container-mobile');
              }
          });
          if (!isAuthenticated && this.current !== 'landing' && this.current !== 'loginChoice' && !this.isOrangeIdCallback) {
             console.log("[Watcher:isUserAuthenticated] User logged out, redirecting to landing.");
             this.switchPage('landing');
          }
      },
      showMobileMenu(isShown) {
          if (isShown && this.isUserAuthenticated && this.loginMethod === 'orangeId') {
              this.$nextTick(() => { this.renderOrangeIdSignOutButton('orange-id-signout-button-container-mobile', true); });
          } else if (!isShown && this.loginMethod === 'orangeId') {
              setTimeout(() => this.unmountOrangeIdSignOutButton('orange-id-signout-button-container-mobile'), 50);
          }
      },
      farmerVideos: { handler(newVideos) { if (this.current === 'farmerAgriStream' && this.targetAgriStreamVideoCid) { if (newVideos.some(v => v.cid === this.targetAgriStreamVideoCid)) { this.scrollToAndHighlightAgriStreamVideo(); } } }, deep: true },
      role(newRole, oldRole) {
            if (newRole && this.isUserAuthenticated && !this.isOrangeIdCallback) {
                const nonPortalPages = ['landing', 'loginChoice', 'roleSelection'];
                if (nonPortalPages.includes(this.current)) {
                    console.log(`[Watcher:role] Role became ${newRole}. Current page ${this.current}. Navigating via getStarted().`);
                    this.$nextTick(() => {
                         if (this.isUserAuthenticated && this.role === newRole && nonPortalPages.includes(this.current) && !this.isOrangeIdCallback) {
                            this.getStarted();
                        }
                    });
                }
            }
        }
    },
    methods: {
      switchPage(page) {
        this.current = page;
        this.showMobileMenu = false;
      },
      navigateToPageWithParam(page, paramName, paramValue) { if (page === 'farmerSell' && paramName === 'cid') { this.listingForm.cid = paramValue; } else if (page === 'farmerFunding' && paramName === 'cid') { this.fundingForm.cid = paramValue; } else if (page === 'farmerAgriStream' && paramName === 'highlightCid') { this.targetAgriStreamVideoCid = paramValue; } this.switchPage(page); },
      getStarted() {
          console.log(`getStarted called. Auth: ${this.isUserAuthenticated}, Role: ${this.role}, Current: ${this.current}`);
          if (!this.isUserAuthenticated) {
              console.log("getStarted: Not auth, to loginChoice.");
              this.switchPage('loginChoice');
          } else if (!this.role) {
              console.log("getStarted: Auth, no role, to roleSelection.");
              this.switchPage('roleSelection');
          } else if (this.role === 'farmer') {
              console.log("getStarted: Farmer, to farmerPestiVid.");
              this.switchPage('farmerPestiVid');
          } else if (this.role === 'buyer') {
              console.log("getStarted: Buyer, to buyerAgriSell.");
              this.switchPage('buyerAgriSell');
          } else if (this.role === 'investor') {
              console.log("getStarted: Investor, to investorProjects.");
              this.switchPage('investorProjects');
          } else {
              console.warn(`getStarted: Fallback, unknown role '${this.role}'. To landing.`);
              this.switchPage('landing');
          }
      },
      handleAuthenticationSuccess(identifier, method, orangeUserDetails = null) {
          console.log("PestiVid Auth Success (Call):", method, identifier, orangeUserDetails);
          this.isOrangeIdCallback = false;
          this.isAuthProcessing = false;
          this.showLoadingModal = false;

          this.$nextTick(() => {
              console.log("PestiVid Auth Success ($nextTick):", method, identifier);
              this.currentUserIdentifier = identifier;
              this.loginMethod = method;

              if (method === 'orangeId' && orangeUserDetails) {
                  this.orangeIdUser = orangeUserDetails;
                  this.walletAddress = null;
              } else if (method === 'solana') {
                  this.walletAddress = identifier;
                  this.orangeIdUser = null;
              }

              this.addNotification(`${method === 'orangeId' ? 'Orange ID' : 'Solana Wallet'} auth successful!`, 'success');
              this.loadOrSetupPestiVidProfile();
          });
      },
      initializeOrangeIdSDK() {
        if (!window.React || !window.ReactDOM || !window.Bedrock) {
            console.error('Error: Orange ID - Libs (React, ReactDOM, Bedrock) failed to load.');
            this.orangeIdBedrockSDKError = true;
            this.addNotification("Orange ID login service failed to load.", "error");
            return false;
        }

        if (!this.bedrockConfig.tenantId || this.bedrockConfig.tenantId.toUpperCase().includes("YOUR_") ) {
            console.error("CONFIG ERROR: Orange ID Tenant ID not set or is placeholder. Orange ID login WILL FAIL.");
            this.orangeIdBedrockSDKError = true;
            this.addNotification("Orange ID Tenant ID config error. Login unavailable.", "error");
            return false;
        }
        if (!this.bedrockConfig.subscriptionKey || this.bedrockConfig.subscriptionKey.toUpperCase().includes("YOUR_") ) {
            console.error("CONFIG ERROR: Orange ID Subscription Key (API Key) not set or is placeholder. Orange ID login WILL FAIL.");
            this.orangeIdBedrockSDKError = true;
            this.addNotification("Orange ID API Key config error. Login unavailable.", "error");
            return false;
        }
        this.orangeIdBedrockSDKError = false;
        return true;
      },
      renderOrangeIdLoginWidget() {
        if (!this.initializeOrangeIdSDK() || this.orangeIdWidgetMounted) return;
        const container = document.getElementById('orange-id-login-container');
        if (!container) {
            console.error("Orange ID login container not found.");
            return;
        }
        this.unmountOrangeIdLoginWidget();

        this.orangeIdReactRootLogin = ReactDOM.createRoot(container);
        try {
            this.orangeIdReactRootLogin.render(
                React.createElement(
                    Bedrock.BedrockPassportProvider,
                    this.bedrockConfig,
                    React.createElement(Bedrock.LoginPanel, {
                        title: "Sign in to PestiVid",
                        logo: "https://sindukuriteja.github.io/favicon.ico", // Replace with your actual logo URL
                        logoAlt: "PestiVid",
                        showConnectWallet: false, // Assuming you handle Solana separately
                        separatorText: "OR",
                        features: {
                            enableWalletConnect: false,
                            enableAppleLogin: true,
                            enableGoogleLogin: true,
                            enableEmailLogin: true,
                        },
                    })
                )
            );
            this.orangeIdWidgetMounted = true;
        } catch (e) {
            console.error("Error rendering Orange ID LoginPanel:", e);
            this.orangeIdBedrockSDKError = true;
            container.innerHTML = '<p class="text-red-500 p-4 text-sm"><i class="fas fa-exclamation-triangle mr-2"></i>Failed to render login widget.</p>';
        }
      },
      unmountOrangeIdLoginWidget() {
        if (this.orangeIdReactRootLogin) {
            try { this.orangeIdReactRootLogin.unmount(); } catch(e) { console.warn("Error unmounting Orange ID login widget:", e); }
            this.orangeIdReactRootLogin = null;
            this.orangeIdWidgetMounted = false;
            const container = document.getElementById('orange-id-login-container');
            if (container) container.innerHTML = '';
        }
      },
      renderOrangeIdCallbackProcessor() {
        if (!this.initializeOrangeIdSDK()) return;
        const container = document.getElementById('orange-id-callback-processor');
        if (!container) {
             console.error("Orange ID callback processor container not found.");
             this.addNotification("Login callback error: UI missing.", "error");
             this.isOrangeIdCallback = false; this.isAuthProcessing = false; this.current='loginChoice';
             return;
        }
        this.unmountOrangeIdCallbackProcessor();

        this.orangeIdReactRootCallback = ReactDOM.createRoot(container);
        const self = this;

        function AuthCallbackProcessor() {
            const { loginCallback, isLoading, error: bedrockError } = Bedrock.useBedrockPassport();
            const [message, setMessage] = React.useState('Processing authentication...');
            const [hasProcessed, setHasProcessed] = React.useState(false);

            React.useEffect(() => {
                if (hasProcessed || isLoading || bedrockError) return;

                async function processLogin() {
                    setHasProcessed(true);
                    const params = new URLSearchParams(window.location.search);
                    const token = params.get('token');
                    const refreshToken = params.get('refreshToken');

                    if (token && refreshToken) {
                        try {
                            setMessage('Verifying tokens with Orange ID...');
                            const bedrockUser = await loginCallback(token, refreshToken);
                            if (bedrockUser && bedrockUser.sub) {
                                setMessage('Orange ID Login successful! Finalizing...');
                                window.history.replaceState({}, document.title, self.bedrockConfig.authCallbackUrl + window.location.hash);
                                self.handleAuthenticationSuccess(bedrockUser.sub, 'orangeId', bedrockUser);
                            } else {
                                setMessage(`Orange ID Auth failed. User data not received. ${bedrockUser ? '' : '(No user obj)'}`);
                                self.addNotification("Orange ID auth failed (no user details).", "error");
                                setTimeout(() => { self.isOrangeIdCallback = false; self.isAuthProcessing = false; self.current = 'loginChoice'; }, 3500);
                            }
                        } catch (error) {
                            console.error('Orange ID Login callback error:', error);
                            setMessage(`Error: ${error.message}`);
                            self.addNotification(`Orange ID login error: ${error.message}`, "error");
                            setTimeout(() => { self.isOrangeIdCallback = false; self.isAuthProcessing = false; self.current = 'loginChoice'; }, 4000);
                        }
                    } else {
                        setMessage('Auth tokens not found. Redirecting...');
                         setTimeout(() => { self.isOrangeIdCallback = false; self.isAuthProcessing = false; self.current = 'loginChoice'; }, 3000);
                    }
                }
                processLogin();
            }, [loginCallback, isLoading, hasProcessed, bedrockError]);

            if (isLoading) return React.createElement('p', {className: "text-gray-600"}, React.createElement('i', {className: "fas fa-spinner fa-spin mr-2"}), 'Initializing...');
            if (bedrockError) return React.createElement('p', {className: "text-red-500"}, `SDK Error: ${bedrockError.message}. Redirecting...`);
            return React.createElement('div', { style: { textAlign: 'center', padding: '1rem' } }, React.createElement('i', {className: "fas fa-spinner fa-spin mr-2"}), message);
        }
        this.orangeIdReactRootCallback.render(
            React.createElement(
                Bedrock.BedrockPassportProvider,
                this.bedrockConfig,
                React.createElement(AuthCallbackProcessor)
            )
        );
      },
      unmountOrangeIdCallbackProcessor() {
        if (this.orangeIdReactRootCallback) {
            try { this.orangeIdReactRootCallback.unmount(); } catch(e) { console.warn("Error unmounting Orange ID callback processor:", e); }
            this.orangeIdReactRootCallback = null;
            const container = document.getElementById('orange-id-callback-processor');
            if (container) container.innerHTML = '';
        }
      },
      renderOrangeIdSignOutButton(containerId, isMobile = false) {
        if (!this.initializeOrangeIdSDK() || !this.isUserAuthenticated || this.loginMethod !== 'orangeId') return;
        const container = document.getElementById(containerId);
        if (!container) {
            console.warn(`Sign out button container ${containerId} not found.`);
            return;
        }

        let rootRef = isMobile ? 'orangeIdReactRootSignOutMobile' : 'orangeIdReactRootSignOut';
        this.unmountOrangeIdSignOutButton(containerId, isMobile);

        this[rootRef] = ReactDOM.createRoot(container);
        const self = this;

        function PestiVidSignOutWrapper() {
            const { logout } = Bedrock.useBedrockPassport();
            const handleSignOut = async () => {
                try {
                    await logout();
                } catch (e) {
                    console.error("Error during Bedrock logout:", e);
                     self.addNotification("Error signing out from Orange ID.", "error");
                } finally {
                    self.logoutUser(true, false); // Bedrock SDK handled its part, PestiVid session clear only
                }
            };
            return React.createElement(Bedrock.SignOutButton, {
                onSignOut: handleSignOut,
                buttonContent: React.createElement('i', { className: "fas fa-sign-out-alt text-lg" }),
            });
        }
        try {
            this[rootRef].render(
                React.createElement(
                    Bedrock.BedrockPassportProvider,
                    this.bedrockConfig,
                    React.createElement(PestiVidSignOutWrapper)
                )
            );
        } catch (e) {
            console.error(`Error rendering Orange ID SignOutButton in ${containerId}:`, e);
        }
      },
      unmountOrangeIdSignOutButton(containerId, isMobile = false) {
        let rootRef = isMobile ? 'orangeIdReactRootSignOutMobile' : 'orangeIdReactRootSignOut';
        if (this[rootRef]) {
            try { this[rootRef].unmount(); } catch(e) { console.warn(`Error unmounting Orange ID signout button from ${containerId}:`, e); }
            this[rootRef] = null;
            const container = document.getElementById(containerId);
            if(container) container.innerHTML = '';
        }
      },
      checkOrangeIdCallback() {
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token');
        const refreshToken = params.get('refreshToken');
        if (token && refreshToken) {
            this.isOrangeIdCallback = true;
            this.isAuthProcessing = true;
            this.$nextTick(() => {
                this.renderOrangeIdCallbackProcessor();
            });
            return true;
        }
        this.isOrangeIdCallback = false;
        return false;
      },
      async connectWallet() {
          if (typeof window.solana === 'undefined' || typeof window.solana.connect === 'undefined') {
              this.addNotification("Solana wallet (Phantom) not found. Install & try again.", "error");
              return;
          }
          if (this.isUserAuthenticated) {
               if (this.loginMethod === 'solana') {
                   this.addNotification("Solana Wallet already connected.", "info"); return;
               }
               if(!confirm(`Logged in with ${this.loginMethod === 'orangeId' ? 'Orange ID' : 'another method'}. Switch to Solana & logout current?`)) return;
               await this.logoutUser(false); // Logout current session without notification, Bedrock SDK will handle its own logout if needed via its button
           }

          this.isAuthProcessing = true;
          this.showLoadingModal = true; this.loadingMessage = "Connecting to Solana Wallet...";
          try {
              const resp = await window.solana.connect();
              this.handleAuthenticationSuccess(resp.publicKey.toString(), 'solana');
          } catch (err) {
              console.error("Solana Wallet connection error:", err);
              this.addNotification("Solana connect failed. " + (err.message || 'User rejected/error.'), "error");
              this.loginMethod = null;
              this.isAuthProcessing = false;
          } finally {
              this.showLoadingModal = false;
          }
      },
      async disconnectWallet() {
          if (window.solana && window.solana.isConnected) {
              try { await window.solana.disconnect(); } catch (err) { console.error("Error disconnecting Solana wallet:", err); }
          }
          this.walletAddress = null;
      },
      loadOrSetupPestiVidProfile() {
          console.log("loadOrSetupPestiVidProfile for:", this.currentUserIdentifier);
          const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles')) || {};
          const pestividProfile = userProfiles[this.currentUserIdentifier];

          if (pestividProfile && pestividProfile.role) {
              console.log("Existing PestiVid profile:", pestividProfile);
              this.role = pestividProfile.role;
              this.userName = pestividProfile.name;
              this.userEmail = pestividProfile.email;
              this.userPhone = pestividProfile.phone || '';
              this.memberSince = pestividProfile.memberSince || new Date().toLocaleDateString();
              if (this.role === 'farmer') { this.farmerLocationCity = pestividProfile.farmerLocationCity || ''; }
              else { this.farmerLocationCity = ''; }

              this.filterDataForCurrentUser();
              this.getStarted();
          } else {
              console.log("No complete PestiVid profile. To roleSelection.");
              this.userNameOnboarding = (this.loginMethod === 'orangeId' && this.orangeIdUser && this.orangeIdUser.name) ? this.orangeIdUser.name : '';
              this.userEmailOnboarding = (this.loginMethod === 'orangeId' && this.orangeIdUser && this.orangeIdUser.email) ? this.orangeIdUser.email : '';
              this.userPhoneOnboarding = '';
              this.farmerLocationCityOnboarding = '';
              this.selectedRoleOnboarding = '';

              this.filterDataForCurrentUser(); // Clear out any potential cross-user data before role selection
              this.switchPage('roleSelection');
              if (this.isUserAuthenticated) {
                   this.addNotification(`Welcome! Please complete PestiVid profile.`, 'info');
              }
          }
          this.showMobileMenu = false;
      },
      completeOnboarding() {
          if (!this.selectedRoleOnboarding || !this.userNameOnboarding.trim() || !this.userEmailOnboarding.trim()) {
            this.addNotification("Fill Name, PestiVid Email, and select Role.", "error");
            return;
          }
          if (!/\S+@\S+\.\S+/.test(this.userEmailOnboarding)) {
            this.addNotification("Enter a valid PestiVid email.", "error");
            return;
          }
          console.log(`Onboarding: User ${this.currentUserIdentifier}, Role ${this.selectedRoleOnboarding}, Name ${this.userNameOnboarding}`);

          this.role = this.selectedRoleOnboarding;
          this.userName = this.userNameOnboarding.trim();
          this.userEmail = this.userEmailOnboarding.trim();
          this.userPhone = this.userPhoneOnboarding.trim() || '';
          this.memberSince = new Date().toLocaleDateString();
          if (this.role === 'farmer') { this.farmerLocationCity = this.farmerLocationCityOnboarding.trim() || ''; }
          else { this.farmerLocationCity = ''; }

          const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles')) || {};
          userProfiles[this.currentUserIdentifier] = {
              role: this.role, name: this.userName, email: this.userEmail, phone: this.userPhone,
              memberSince: this.memberSince,
              farmerLocationCity: this.role === 'farmer' ? this.farmerLocationCity : undefined,
              authMethod: this.loginMethod,
              orangeAuthEmail: (this.loginMethod === 'orangeId' && this.orangeIdUser) ? this.orangeIdUser.email : null,
              orangeEthAddress: (this.loginMethod === 'orangeId' && this.orangeIdUser) ? this.orangeIdUser.ethAddress : null,
          };
          localStorage.setItem('pestiVidUserProfiles', JSON.stringify(userProfiles));

          this.filterDataForCurrentUser();
          this.getStarted();
          this.addNotification(`Profile for ${this.userName} setup! Welcome!`, 'success');
      },
      async logoutUser(notify = true, triggerBedrockLogout = true) {
          this.showLoadingModal = true;
          this.loadingMessage = "Signing out...";

          if (this.loginMethod === 'solana') {
             await this.disconnectWallet();
          } else if (this.loginMethod === 'orangeId' && triggerBedrockLogout && this.orangeIdBedrockSDK) {
              // Bedrock logout is handled by its SignOutButton component.
              // This `logoutUser` is called *after* Bedrock SDK's logout (if `triggerBedrockLogout` is false,
              // which happens when called from the SignOutButton's callback).
              // If `triggerBedrockLogout` is true (e.g. Solana user logs out, then tries to log in with Orange ID,
              // we might not have a rendered button). However, direct SDK logout is usually done via its component.
              console.log("PestiVid session clear for Orange ID user.");
          }
          this.clearUserSession(notify);
          this.showLoadingModal = false;
      },
      clearUserSession(notify = true) {
          this.currentUserIdentifier = null;
          this.walletAddress = null;
          this.orangeIdUser = null;
          this.role = ''; this.userName = ''; this.userEmail = ''; this.userPhone = ''; this.memberSince = ''; this.farmerLocationCity = '';

          this.farmerVideos = []; this.farmerListings = []; this.farmerFundingRequests = [];
          this.buyerPurchases = []; this.investorInvestments = []; this.investorTransactions = [];
          this.activeConversationId = null;

          this.unmountOrangeIdSignOutButton('orange-id-signout-button-container');
          this.unmountOrangeIdSignOutButton('orange-id-signout-button-container-mobile');

          const oldLoginMethod = this.loginMethod;
          this.loginMethod = null;
          this.showMobileMenu = false;
          this.isAuthProcessing = false;

          if (notify) this.addNotification("Signed out from PestiVid.", 'info');

          if (oldLoginMethod && this.current !== 'landing' && this.current !== 'loginChoice') {
             this.switchPage('landing');
          }
      },
      getFarmerDisplayIdentifier(wallet, length = 6) {
            if (!wallet) return 'N/A';
            const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles')) || {};
            const profile = userProfiles[wallet];
            if (profile && profile.name) return profile.name.split(' ')[0];
            const addr = String(wallet);
            return `${addr.substring(0, length)}...${addr.substring(addr.length - (length > 4 ? 4 : length))}`;
      },
      getSellerDisplayIdentifier(wallet, length = 6) {
            return this.getFarmerDisplayIdentifier(wallet, length);
      },
      async simulateTransaction(description = "Processing action...") { this.showLoadingModal = true; this.loadingMessage = "Confirming (Simulated)..."; await new Promise(resolve => setTimeout(resolve, 1200 + Math.random() * 1000)); this.loadingMessage = `${description} on PestiVid (Simulated)...`; await new Promise(resolve => setTimeout(resolve, 1800 + Math.random() * 1500)); const txHash = 'sim_tx_' + Date.now().toString(16) + Math.random().toString(16).substring(2, 14); this.showLoadingModal = false; return txHash; },
      async startVideo() { if (!this.isUserAuthenticated) { this.addNotification("Log in to record videos.", "error"); return; } if (this.recording || this.uploading) return; if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') { console.warn("HTTPS recommended for camera."); this.addNotification("Camera best over HTTPS.", "warning"); } this.recordBlob = null; this.recordBlobUrl = ''; this.uploadCid = ''; this.uploadError = ''; this.showLive = true; try { const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false }); this.recordStream = stream; this.$refs.liveVideo.srcObject = stream; this.$refs.liveVideo.play(); let chunks = []; this.recording = true; const mimeTypes = ['video/webm;codecs=vp9,opus', 'video/webm;codecs=vp8,opus', 'video/webm', 'video/mp4']; let selectedMimeType = mimeTypes.find(type => MediaRecorder.isTypeSupported(type)) || undefined; console.log("Selected MIME type:", selectedMimeType || "default"); this.recordMediaRecorder = new MediaRecorder(stream, { mimeType: selectedMimeType }); this.recordMediaRecorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); }; this.recordMediaRecorder.onstop = () => { const blobType = this.recordMediaRecorder.mimeType || (selectedMimeType || 'video/webm'); this.recordBlob = new Blob(chunks, { type: blobType }); if (this.recordBlobUrl) URL.revokeObjectURL(this.recordBlobUrl); this.recordBlobUrl = URL.createObjectURL(this.recordBlob); this.showLive = false; if(stream) stream.getTracks().forEach(t => t.stop()); this.recordStream = null; this.recording = false; }; this.recordMediaRecorder.onerror = (e) => { console.error("MediaRecorder error:", e); this.uploadError = "Recording error: " + (e.name || "Unknown"); this.stopVideo(); }; this.recordMediaRecorder.start(1000); } catch (e) { console.error("getUserMedia error:", e); let alertMsg = "Camera access failed."; if (e.name === 'NotAllowedError') alertMsg = "Camera access denied."; else if (e.name === 'NotFoundError') alertMsg = "No camera found."; else if (e.name === 'NotReadableError' || e.name === 'TrackStartError') alertMsg = "Camera in use or error."; else alertMsg = `Camera error: ${e.name || e.message}`; if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') alertMsg += " Use HTTPS for camera."; this.addNotification(alertMsg, "error"); this.showLive = false; this.recording = false; } },
      stopVideo() { if (this.recordMediaRecorder && this.recordMediaRecorder.state === "recording") { try { this.recordMediaRecorder.stop(); } catch(e) { console.warn("Error stopping MediaRecorder:", e); } } if (this.recordStream) { this.recordStream.getTracks().forEach(t => t.stop()); this.recordStream = null; } this.recording = false; this.showLive = false; },
      async uploadVideo() { if (!this.isUserAuthenticated) { this.addNotification("Log in to upload videos.", "error"); return; } if (!this.recordBlob) { this.addNotification("No video to upload.", "error"); return; } if (!this.recordForm.crop || !this.recordForm.pesticide || !this.recordForm.location || !this.recordForm.pesticideCompany || !this.recordForm.purpose) { this.addNotification("Fill details & select purpose.", "error"); return; } if (this.pinataJwt === 'YOUR_PINATA_JWT' || !this.pinataJwt || this.pinataGateway === 'YOUR_PINATA_GATEWAY_HOSTNAME' || !this.pinataGateway) { this.uploadError = "Pinata config (JWT/Gateway) missing."; this.addNotification(this.uploadError, "error"); return; } this.uploading = true; this.uploadCid = ''; this.uploadError = ''; this.lastUploadedVideoPurpose = ''; const formData = new FormData(); const fileExtension = (this.recordBlob.type.split('/')[1] || 'webm').split(';')[0]; const fileName = `pestivid_${this.currentUserIdentifier.substring(0,6)}_${Date.now()}.${fileExtension}`; formData.append('file', this.recordBlob, fileName); formData.append('pinataMetadata', JSON.stringify({ name: fileName, keyvalues: { uploaderId: this.currentUserIdentifier, role: this.role, crop: this.recordForm.crop.trim(), pesticide: this.recordForm.pesticide.trim(), location: this.recordForm.location.trim(), pesticideCompany: this.recordForm.pesticideCompany.trim(), purpose: this.recordForm.purpose, uploadTimestamp: new Date().toISOString() } })); formData.append('pinataOptions', JSON.stringify({ cidVersion: 1 })); try { const resp = await axios.post('https://api.pinata.cloud/pinning/pinFileToIPFS', formData, { maxBodyLength: Infinity, headers: { Authorization: `Bearer ${this.pinataJwt}` } }); this.uploadCid = resp.data.IpfsHash; this.lastUploadedVideoPurpose = this.recordForm.purpose; const newVideoData = { cid: this.uploadCid, farmerWallet: this.currentUserIdentifier, crop: this.recordForm.crop.trim(), pesticide: this.recordForm.pesticide.trim(), location: this.recordForm.location.trim(), pesticideCompany: this.recordForm.pesticideCompany.trim(), purpose: this.recordForm.purpose, uploadedAt: new Date().toISOString() }; this.farmerVideos.unshift(newVideoData); this.recordForm = { crop: '', pesticide: '', location: '', pesticideCompany: '', purpose: 'agristream' }; if (this.recordBlobUrl) URL.revokeObjectURL(this.recordBlobUrl); this.recordBlob = null; this.recordBlobUrl = ''; this.saveDataToLocalStorage(); if (newVideoData.purpose === 'sell') { this.addNotification(`Video for "${newVideoData.crop}" uploaded. To complete listing...`, 'info'); this.navigateToPageWithParam('farmerSell', 'cid', this.uploadCid); } else if (newVideoData.purpose === 'funding') { this.addNotification(`Video for "${newVideoData.crop}" uploaded. To complete funding...`, 'info'); this.navigateToPageWithParam('farmerFunding', 'cid', this.uploadCid); } else { this.addNotification(`Video for "${newVideoData.crop}" added to AgriStream!`, 'success'); } } catch (e) { console.error("Pinata Upload Error:", e); this.uploadError = "IPFS upload failed. "; if (e.response) { this.uploadError += `Server: ${e.response.status}. ${e.response.data?.error?.details || e.response.data?.error || e.message || ''}`; if (e.response.status === 401) this.uploadError += " Invalid Pinata JWT."; } else if (e.request) { this.uploadError += " Network/CORS error."; } else { this.uploadError += e.message || "Unknown upload error."; } this.addNotification(this.uploadError, "error"); this.uploadCid = ''; } finally { this.uploading = false; } },
      ipfsUrl(cid) { if (!cid) return ""; if (this.pinataGateway === 'YOUR_PINATA_GATEWAY_HOSTNAME' || !this.pinataGateway) { console.warn("Pinata Gateway not configured. Using public gateway."); return `https://ipfs.io/ipfs/${cid}`; } return `https://${this.pinataGateway}/ipfs/${cid}`; },
      isListed(cid) { return this.farmerListings.some(l => l.cid === cid && l.farmerWallet === this.currentUserIdentifier); },
      isUsedInFunding(cid) { return this.farmerFundingRequests.some(req => req.cid === cid && req.farmerWallet === this.currentUserIdentifier); },
      goToListing(cid) { this.listingForm.cid = cid; this.switchPage('farmerSell'); },
      async createListing() { if (!this.isUserAuthenticated) { this.addNotification("Log in to create listings.", "error"); return; } this.createdListingId = null; this.listingNotificationSent = false; if (!this.listingForm.cid || !this.listingForm.minPrice || !this.listingForm.maxPrice) { this.addNotification("Select video & set prices.", "error"); return; } const minP = parseFloat(this.listingForm.minPrice); const maxP = parseFloat(this.listingForm.maxPrice); if (isNaN(minP) || isNaN(maxP) || minP <= 0 || maxP <= 0 || minP > maxP) { this.addNotification("Valid prices, Min <= Max.", "error"); return; } let vid = this.farmerVideos.find(v => v.cid === this.listingForm.cid && v.farmerWallet === this.currentUserIdentifier); if (!vid) { this.addNotification("Video not found/yours.", "error"); return; } if (this.isListed(vid.cid)) { this.addNotification("Video already listed.", "warning"); return; } const txHash = await this.simulateTransaction("Creating listing"); if (!txHash) { this.addNotification("Listing creation failed (sim).", "error"); return; } let newListing = { id: 'lst' + Date.now(), farmerWallet: this.currentUserIdentifier, crop: vid.crop, location: vid.location, pesticide: vid.pesticide || '', pesticideCompany: vid.pesticideCompany || '', cid: vid.cid, minPrice: minP, maxPrice: maxP, status: 'active', createdAt: new Date().toISOString(), notificationSent: false, isNew: true, txHash: txHash }; this.farmerListings.unshift({ ...newListing }); this.allListings.unshift({ ...newListing }); this.addNotification(`Listing "${newListing.crop}" created!`, 'success'); if (this.listingForm.notifyBuyers) { this.notifyBuyersAboutListing(newListing, true); this.listingNotificationSent = true; } this.createdListingId = txHash; this.listingForm = { cid: '', minPrice: '', maxPrice: '', notifyBuyers: true }; this.saveDataToLocalStorage(); setTimeout(() => { this.createdListingId = null; this.listingNotificationSent = false; }, 7000); },
      fundingProgressPercent(req) { if (!req || !req.amount || req.amount <= 0) return 0; return Math.min(100, Math.round(((req.fundedAmount || 0) / req.amount) * 100)); },
      async createFundingRequest_V1() { if (!this.isUserAuthenticated) { this.addNotification("Log in to request funding.", "error"); return; } this.createdFundingRequest = false; const form = this.fundingForm; const requiredFields = ['title', 'crop', 'acres', 'amount', 'method', 'cid', 'description', 'timeline', 'roi', 'investorShare']; if (!form.cid) { this.addNotification("Select video for funding.", "error"); return; } if (requiredFields.some(field => !form[field] && form[field] !== 0)) { this.addNotification("Fill all funding fields.", "error"); return; } if (form.acres <= 0 || form.amount <= 0 || form.timeline <= 0 || form.roi <= 0 || form.investorShare <= 0 || form.investorShare > 80) { this.addNotification("Valid numbers for amounts, ROI. Share 1-80%.", "error"); return; } const vid = this.farmerVideos.find(v => v.cid === form.cid && v.farmerWallet === this.currentUserIdentifier); if (!vid) { this.addNotification("Video not found/yours.", "error"); return; } const txHash = await this.simulateTransaction("Creating funding request"); if(!txHash) { this.addNotification("Funding request failed (sim).", "error"); return; } const newRequest = { id: 'fr' + Date.now(), farmerWallet: this.currentUserIdentifier, title: form.title.trim(), crop: form.crop.trim(), acres: form.acres, amount: form.amount, method: form.method, cid: form.cid, description: form.description.trim(), timeline: form.timeline, roi: form.roi, investorShare: form.investorShare, fundedAmount: 0, status: 'pending', createdAt: new Date().toISOString(), investors: [], updates: [], txHash: txHash }; this.farmerFundingRequests.unshift({ ...newRequest }); this.allFundingRequests.unshift({ ...newRequest }); this.createdFundingRequest = true; this.addNotification(`Funding request "${newRequest.title}" created!`, 'success'); this.fundingForm = { title: '', crop: '', acres: null, amount: null, method: '', cid: '', description: '', timeline: null, roi: null, investorShare: null, notifyInvestors: true }; this.saveDataToLocalStorage(); setTimeout(() => this.createdFundingRequest = false, 5000); },
      async cancelFundingRequest_V1(id) { if (!this.isUserAuthenticated) { this.addNotification("Please log in.", "error"); return; } const reqIndex = this.farmerFundingRequests.findIndex(r => r.id === id && r.farmerWallet === this.currentUserIdentifier); if (reqIndex === -1) { this.addNotification("Funding request not found/yours.", "error"); return;} const req = this.farmerFundingRequests[reqIndex]; if (req.fundedAmount > 0) { if (!confirm("Request has funding. Cancel will sim refunds. Sure?")) return; } else if (!confirm("Cancel funding request?")) return; const txHash = await this.simulateTransaction(`Cancelling request "${req.title}"`); if(!txHash) { this.addNotification("Cancellation failed (sim).", "error"); return; } this.farmerFundingRequests.splice(reqIndex, 1); this.allFundingRequests = this.allFundingRequests.filter(r => r.id !== id); this.addNotification(`Request "${req.title}" cancelled.`, 'info'); this.saveDataToLocalStorage(); },
      resetBuyerFilters() { this.buyerFilters = {crop:'', location:'', pesticideCompany: ''}; },
      buyListing(listing) { if (!this.isUserAuthenticated || this.role !== 'buyer') { this.addNotification("Log in as Buyer to purchase.", "error"); if (!this.isUserAuthenticated) this.switchPage('loginChoice'); return; } if(this.currentUserIdentifier === listing.farmerWallet) { this.addNotification("Cannot purchase own listing.", "warning"); return; } this.selectedListing = listing; this.purchaseAmount = listing.minPrice;
        this.purchaseStatus = ''; this.purchaseError = ''; this.showBuyModal = true; },
      closeBuyModal() { this.showBuyModal = false; this.selectedListing = null; this.purchaseAmount = null; this.purchaseStatus = ''; this.purchaseError = ''; },
      async processPurchase() { if (!this.isUserAuthenticated || !this.selectedListing || this.purchaseAmount === null) return; this.purchaseStatus = ''; this.purchaseError = ''; const amount = parseFloat(this.purchaseAmount); const minP = parseFloat(this.selectedListing.minPrice); const maxP = parseFloat(this.selectedListing.maxPrice); if (isNaN(amount) || amount < minP || amount > maxP) { this.purchaseError = `Offer must be ${minP}-${maxP} SOL.`; return; } const txHash = await this.simulateTransaction(`Purchasing ${this.selectedListing.crop} for ${amount} SOL`); if (!txHash) { this.purchaseError = "Purchase failed (sim)."; this.purchaseStatus = ''; return; } this.purchaseStatus = `Processing purchase ${amount} SOL... Tx: ${txHash.substring(0,10)}...`; try { const newPurchase = { id: 'pur' + Date.now(), buyerWallet: this.currentUserIdentifier, farmerWallet: this.selectedListing.farmerWallet, crop: this.selectedListing.crop, location: this.selectedListing.location, pesticide: this.selectedListing.pesticide, pesticideCompany: this.selectedListing.pesticideCompany || '', cid: this.selectedListing.cid, price: amount, date: new Date().toLocaleDateString(), txHash: txHash }; this.buyerPurchases.unshift(newPurchase); this.allListings = this.allListings.filter(l => l.id !== this.selectedListing.id); if (this.role === 'farmer' && this.selectedListing.farmerWallet === this.currentUserIdentifier) { this.farmerListings = this.farmerListings.filter(l => l.id !== this.selectedListing.id);
        } this.addNotification(`Purchased "${newPurchase.crop}" for ${amount} SOL!`, 'success'); this.addNotification(`Listing "${newPurchase.crop}" purchased by ${this.getFarmerDisplayIdentifier(newPurchase.buyerWallet)} for ${amount} SOL!`, 'success', newPurchase.farmerWallet);
        this.purchaseStatus = "Purchase successful!"; this.saveDataToLocalStorage(); setTimeout(() => { this.closeBuyModal(); }, 2500); } catch(err) { console.error("Error processing purchase:", err); this.purchaseError = "Purchase sim error."; this.purchaseStatus = ''; } },
      viewPurchaseVideo(purchase) { this.selectedPurchase = purchase; this.showPurchaseVideo = true; },
      resetInvestorFilters() { this.investorFilters = {crop: '', method: '', minRoi: null, maxAmount: null}; },
      maxInvestmentAmount(project) { if (!project || project.status === 'funded' || typeof project.amount !== 'number' || typeof project.fundedAmount !== 'number') return 0; const remaining = project.amount - project.fundedAmount; return remaining > 0 ? parseFloat(remaining.toFixed(2)) : 0; },
      async investInProject(project) { if (!this.isUserAuthenticated || this.role !== 'investor') { this.addNotification("Log in as Investor.", "error"); if(!this.isUserAuthenticated) this.switchPage('loginChoice'); return; } const amount = parseFloat(this.investmentAmounts[project.id]); this.$set(this.investmentErrors, project.id, ''); if (isNaN(amount) || amount <= 0) { this.$set(this.investmentErrors, project.id, 'Valid positive amount.'); return; } const maxInvest = this.maxInvestmentAmount(project); const tolerance = 0.00001;
        if (amount > maxInvest + tolerance) { this.$set(this.investmentErrors, project.id, `Max investment ${maxInvest.toFixed(2)} SOL.`); return; } const preciseAmount = parseFloat(amount.toFixed(2)); const txHash = await this.simulateTransaction(`Investing ${preciseAmount} SOL in "${project.title}"`); if (!txHash) { this.$set(this.investmentErrors, project.id, 'Investment failed (sim).'); return; } try { const projectInAllIdx = this.allFundingRequests.findIndex(p => p.id === project.id); if (projectInAllIdx === -1) throw new Error("Project not found"); const updatedProject = JSON.parse(JSON.stringify(this.allFundingRequests[projectInAllIdx]));
        updatedProject.fundedAmount = parseFloat(((updatedProject.fundedAmount || 0) + preciseAmount).toFixed(2)); updatedProject.investors = [...(updatedProject.investors || []), { investorId: this.currentUserIdentifier, amount: preciseAmount, txHash: txHash, date: new Date().toLocaleDateString() }]; if (updatedProject.fundedAmount >= updatedProject.amount - tolerance) { updatedProject.status = 'funded'; updatedProject.fundedAmount = updatedProject.amount;
        } else { updatedProject.status = 'partially_funded'; } this.$set(this.allFundingRequests, projectInAllIdx, updatedProject); const farmerProjectIndex = this.farmerFundingRequests.findIndex(p => p.id === project.id); if(farmerProjectIndex > -1) { this.$set(this.farmerFundingRequests, farmerProjectIndex, updatedProject); } const newInvestment = { id: 'inv' + Date.now(), investorWallet: this.currentUserIdentifier, projectId: project.id, projectTitle: project.title, farmerWallet: project.farmerWallet, crop: project.crop, method: project.method, description: project.description, acres: project.acres, timeline: project.timeline, roi: project.roi, investorShare: project.investorShare, amount: preciseAmount, cid: project.cid, status: 'active', progress: 0, investmentDate: new Date().toLocaleDateString(), txHash: txHash }; this.investorInvestments.unshift(newInvestment); const newTransaction = { id: 'tx' + Date.now(), investorWallet: this.currentUserIdentifier, txHash: txHash, type: 'investment', amount: preciseAmount, date: new Date().toLocaleDateString(), projectId: project.id, projectTitle: project.title }; this.investorTransactions.unshift(newTransaction); this.investorTransactions.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()); this.addNotification(`Invested ${preciseAmount} SOL in "${project.title}"!`, 'success'); this.addNotification(`${preciseAmount} SOL invested by ${this.getFarmerDisplayIdentifier(this.currentUserIdentifier)} in "${project.title}"!`, 'success', project.farmerWallet);
        this.$set(this.investmentAmounts, project.id, null); this.saveDataToLocalStorage(); } catch (err) { console.error("Error investment sim:", err); this.$set(this.investmentErrors, project.id, 'Investment sim failed.'); } },
      updateInvestmentProgress() { const now = new Date(); this.investorInvestments.forEach(inv => { if (inv.status === 'active' || inv.status === 'growing') { const dateInvestedParts = inv.investmentDate.split('/');
        const dateInvested = new Date(dateInvestedParts[2], dateInvestedParts[0] - 1, dateInvestedParts[1]); const monthsElapsed = (now.getFullYear() - dateInvested.getFullYear())*12 + (now.getMonth() - dateInvested.getMonth()); let progress = 0; if (inv.timeline && inv.timeline > 0) { progress = Math.min(100, Math.max(0, Math.round((monthsElapsed/inv.timeline)*100))); } progress = Math.min(100, Math.max(inv.progress||0, progress + ((inv.progress||0)<95 ? Math.floor(Math.random()*3) : 0) )); inv.progress = progress; if (progress >= 100 && inv.status !== 'harvested') { inv.status = 'harvested'; if (!inv.payoutNotified) { const expectedReturn = this.calculateExpectedReturn(inv); const payoutTxHash = 'sim_payout_tx_' + Date.now().toString(16) + Math.random().toString(16).substring(2,10); this.investorTransactions.unshift({ id: 'txp' + Date.now(), investorWallet: inv.investorWallet, txHash: payoutTxHash, type: 'payout', amount: parseFloat(expectedReturn), date: new Date().toLocaleDateString(), projectId: inv.projectId, projectTitle: inv.projectTitle }); this.investorTransactions.sort((a,b) => new Date(b.date).getTime() - new Date(a.date).getTime()); this.addNotification(`Payout ${expectedReturn} SOL for "${inv.projectTitle}" processed!`, 'success', inv.investorWallet); this.addNotification(`Harvest payout ${expectedReturn} SOL for "${inv.projectTitle}" to investor ${this.getFarmerDisplayIdentifier(inv.investorWallet)}...`, 'info', inv.farmerWallet); inv.payoutNotified = true; this.saveDataToLocalStorage(); } } else if (progress > 0 && inv.status === 'active') { inv.status = 'growing'; } else if (progress === 0 && inv.status !== 'active') { inv.status = 'active'; } } }); },
      viewInvestmentDetails(investment) { this.selectedInvestmentProject = this.allFundingRequests.find(p => p.id === investment.projectId); this.selectedInvestment = { ...investment, description: this.selectedInvestmentProject ? this.selectedInvestmentProject.description : investment.description, updates: this.selectedInvestmentProject ? (this.selectedInvestmentProject.updates || []) : [] }; this.showInvestmentDetailsModal = true; },
      calculateExpectedReturn(investment) { if (!investment || !investment.amount || !investment.roi) return '0.00'; return (investment.amount * (investment.roi / 100)).toFixed(2); },
      solanaExplorerUrl(txHash) { return `https://explorer.solana.com/tx/${txHash}?cluster=devnet`; },
      showFarmerProfile(farmerIdentifier) { if (!farmerIdentifier) return; this.selectedFarmerProfile = null; const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles')) || {}; const farmerPestiVidProfile = userProfiles[farmerIdentifier] || {}; const profileData = { walletAddress: farmerIdentifier, farmName: this.simulateFarmName(farmerIdentifier), bio: this.simulateFarmerBio(farmerIdentifier), email: farmerPestiVidProfile.email || this.simulateUserEmail(farmerIdentifier), memberSince: farmerPestiVidProfile.memberSince || this.simulateMemberSince(farmerIdentifier), fundingRequestCount: this.allFundingRequests.filter(r => r.farmerWallet === farmerIdentifier && (r.status === 'pending' || r.status === 'partially_funded')).length, activeListingCount: this.allListings.filter(l => l.farmerWallet === farmerIdentifier && l.status === 'active').length, }; this.selectedFarmerProfile = profileData; this.showFarmerProfileModal = true; },
      closeFarmerProfileModal() { this.showFarmerProfileModal = false; this.selectedFarmerProfile = null; },
      simulateUserEmail(id) { return id ? `${String(id).substring(0, 6)}@pestivid.sim` : 'user@example.com'; },
      simulateMemberSince(id) { let hash = 0; for (let i = 0; i < String(id || '').length; i++) { hash = (hash << 5) - hash + String(id).charCodeAt(i); hash |= 0; } const daysAgo = Math.abs(hash % 730) + 30; const joinDate = new Date(); joinDate.setDate(joinDate.getDate() - daysAgo); return joinDate.toLocaleDateString(); },
      simulateFarmName(id) { return id ? `Farm ${String(id).substring(0, 5)} Agri` : "The Good Farm"; },
      simulateFarmerBio(id) { const bios = ["Sustainable ag, fresh produce.", "Family farm with Web3.", "Organic & eco-friendly.", "Direct farmer-consumer.", "Quality, transparency, future."]; let bioHash = 0; for (let i = 0; i < String(id || '').length; i++) { bioHash = (bioHash << 5) - hash + String(id).charCodeAt(i); bioHash |= 0; } return bios[Math.abs(bioHash % bios.length)]; },
      async fetchWeather() { if (!this.farmerLocationCity) { this.weatherError = "Enter farm city."; return; } if (!this.weatherApiKey || this.weatherApiKey === 'YOUR_OPENWEATHERMAP_API_KEY') { this.weatherError = "Weather API key not configured."; this.addNotification(this.weatherError, "error"); return; } this.weatherLoading = true; this.weatherError = ''; this.currentWeather = null; this.forecastWeather = []; const city = this.farmerLocationCity; const apiKey = this.weatherApiKey; const units = 'metric'; try { const currentResponse = await axios.get(`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&appid=${apiKey}&units=${units}`); this.currentWeather = currentResponse.data; const forecastResponse = await axios.get(`https://api.openweathermap.org/data/2.5/forecast?q=${encodeURIComponent(city)}&appid=${apiKey}&units=${units}`); this.forecastWeather = this.processForecastData(forecastResponse.data); } catch (error) { console.error("Weather API Error:", error); if (error.response) { this.weatherError = `Error ${error.response.status}: ${error.response.data.message || 'Could not fetch.'}`; if (error.response.status === 401) this.weatherError += " Invalid API key."; else if (error.response.status === 404) this.weatherError = `No weather for "${city}".`; } else if (error.request) { this.weatherError = "Network error: weather service."; } else { this.weatherError = "Unexpected weather error."; } this.addNotification(this.weatherError, "error"); } finally { this.weatherLoading = false; } },
      processForecastData(data) { if (!data || !data.list) return []; const dailyData = {}; data.list.forEach(item => { const date = new Date(item.dt * 1000); const dateString = date.toISOString().split('T')[0]; if (!dailyData[dateString]) { dailyData[dateString] = { date: date, dateString: date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }), temps: [], icons: [], descriptions: [] }; } dailyData[dateString].temps.push(item.main.temp); dailyData[dateString].icons.push(item.weather[0].icon); dailyData[dateString].descriptions.push(item.weather[0].description); }); return Object.values(dailyData).map(day => { let repIcon = day.icons[0]; let repDesc = day.descriptions[0]; const middayItem = data.list.find(item => { const itemDate = new Date(item.dt * 1000); return itemDate.toISOString().startsWith(day.date.toISOString().split('T')[0]) && itemDate.getHours() >= 11 && itemDate.getHours() <= 14; }); if (middayItem) { repIcon = middayItem.weather[0].icon; repDesc = middayItem.weather[0].description; } return { date: day.date, dateString: day.dateString, minTemp: Math.min(...day.temps), maxTemp: Math.max(...day.temps), icon: repIcon, description: repDesc }; }).slice(0, 5); },
      getWeatherIconUrl(iconCode) { return `https://openweathermap.org/img/wn/${iconCode}@2x.png`; },
      saveFarmerCity() { if (this.isUserAuthenticated && this.role === 'farmer') { const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles')) || {}; if (userProfiles[this.currentUserIdentifier]) { userProfiles[this.currentUserIdentifier].farmerLocationCity = this.farmerLocationCity; localStorage.setItem('pestiVidUserProfiles', JSON.stringify(userProfiles)); this.addNotification("Farm location updated.", "success", this.currentUserIdentifier); } } },
      selectConversation(convId) { this.activeConversationId = convId; this.markConversationAsRead(convId); this.$nextTick(() => this.scrollToMessageBottom()); },
      sendMessage() { if (!this.messageInputText.trim() || !this.activeConversationId || !this.isUserAuthenticated) return; const conversation = this.conversations.find(c => c.id === this.activeConversationId); if (!conversation) { console.error("Active conv not found."); return; } const receiverId = conversation.participants.find(p => p !== this.currentUserIdentifier); if (!receiverId) { console.error("Receiver ID not found."); return; } const newMessage = { id: 'msg' + Date.now(), conversationId: this.activeConversationId, sender: this.currentUserIdentifier, receiver: receiverId, text: this.messageInputText.trim(), timestamp: new Date().toISOString(), read: false }; this.messages.push(newMessage); conversation.lastMessageSnippet = newMessage.text.substring(0, 35) + (newMessage.text.length > 35 ? '...' : ''); conversation.lastMessageTimestamp = newMessage.timestamp; this.conversations.sort((a, b) => new Date(b.lastMessageTimestamp).getTime() - new Date(a.lastMessageTimestamp).getTime()); this.addNotification(`New message from ${this.getFarmerDisplayIdentifier(this.currentUserIdentifier)}`, 'info', receiverId); this.messageInputText = ''; this.$nextTick(() => this.scrollToMessageBottom()); this.saveDataToLocalStorage(); },
      startOrGoToConversation(targetIdentifier) { if (!this.isUserAuthenticated || !targetIdentifier ) { if (!this.isUserAuthenticated) { this.addNotification("Log in to send messages.", "error"); this.switchPage('loginChoice'); return;} if (!targetIdentifier) { this.addNotification("Target user missing.", "error"); return;} } if (targetIdentifier === this.currentUserIdentifier) { this.addNotification("Cannot chat with self.", "warning"); return; } const sortedParticipants = [this.currentUserIdentifier, targetIdentifier].sort(); let conversation = this.conversations.find(conv => conv.participants.length === 2 && conv.participants.join(',') === sortedParticipants.join(',')); if (!conversation) { const newConvId =  'conv' + Date.now() + '_' + sortedParticipants.join('_').substring(0,10); conversation = { id: newConvId, participants: sortedParticipants, lastMessageSnippet: 'Conversation started.', lastMessageTimestamp: new Date().toISOString() }; this.conversations.unshift(conversation); this.conversations.sort((a,b) => new Date(b.lastMessageTimestamp).getTime() - new Date(a.lastMessageTimestamp).getTime()); this.saveDataToLocalStorage(); this.addNotification(`Chat started with ${this.getFarmerDisplayIdentifier(targetIdentifier)}`, 'info'); } this.switchPage('messaging'); this.$nextTick(() => this.selectConversation(conversation.id)); },
      messageFarmerFromProfile() { if (this.selectedFarmerProfile && this.isUserAuthenticated && this.currentUserIdentifier !== this.selectedFarmerProfile.walletAddress) { const targetUserIdentifier = this.selectedFarmerProfile.walletAddress; this.closeFarmerProfileModal(); this.$nextTick(() => this.startOrGoToConversation(targetUserIdentifier)); } else if (this.selectedFarmerProfile && this.isUserAuthenticated && this.currentUserIdentifier === this.selectedFarmerProfile.walletAddress) { this.addNotification("Cannot message self.", "warning"); } else { this.addNotification("Log in to message farmer.", "error"); if(!this.isUserAuthenticated) this.switchPage('loginChoice'); } },
      scrollToMessageBottom() { this.$nextTick(() => { const el = this.$refs.messageContainer; if (el) el.scrollTop = el.scrollHeight; }); },
      getUnreadCountForConversation(convId) { if (!this.isUserAuthenticated) return 0; return this.messages.filter(msg => msg.conversationId === convId && msg.receiver === this.currentUserIdentifier && !msg.read).length; },
      markConversationAsRead(convId) { let changed = false; this.messages.forEach(msg => { if (msg.conversationId === convId && msg.receiver === this.currentUserIdentifier && !msg.read) { msg.read = true; changed = true; } }); if (changed) this.saveDataToLocalStorage(); },
      addNotification(message, type = 'info', recipientIdentifier = null) { if (recipientIdentifier === null || recipientIdentifier === this.currentUserIdentifier) { const newNotification = { id: 'notif_' + Date.now(), message: message, type: type, timestamp: Date.now(), show: false }; this.notifications.push(newNotification); if(this.recentNotifications.length < 3) {
        this.showNextToastNotification(); } } else { console.log(`(SIM NOTIF for ${this.getFarmerDisplayIdentifier(recipientIdentifier, 8)}): "${message}" (from ${this.getFarmerDisplayIdentifier(this.currentUserIdentifier, 8)})`);
        } },
      showNextToastNotification() { if (this.recentNotifications.length >= 3 || this.notifications.length === 0) return; const notificationToShow = this.notifications.shift(); this.recentNotifications.push(notificationToShow); this.$nextTick(() => { setTimeout(() => { const index = this.recentNotifications.findIndex(n => n.id === notificationToShow.id); if(index > -1) { this.$set(this.recentNotifications[index], 'show', true); } }, 50); }); notificationToShow.timeoutId = setTimeout(() => this.dismissNotification(notificationToShow.id), 4500); },
      dismissNotification(id) { const index = this.recentNotifications.findIndex(n => n.id === id); if (index > -1) { if (this.recentNotifications[index].timeoutId) clearTimeout(this.recentNotifications[index].timeoutId); this.$set(this.recentNotifications[index], 'show', false); setTimeout(() => { const removeIndex = this.recentNotifications.findIndex(n => n.id === id); if (removeIndex > -1) this.recentNotifications.splice(removeIndex, 1); this.$nextTick(() => this.showNextToastNotification()); }, 400); } },
      notifyBuyersAboutListing(listing, markAsSent = false) { if (markAsSent) {const idx = this.allListings.findIndex(l=>l.id === listing.id); if(idx>-1) this.$set(this.allListings[idx], 'notificationSent', true); if(this.role==='farmer') {const fidx = this.farmerListings.findIndex(l=>l.id === listing.id); if(fidx>-1) this.$set(this.farmerListings[fidx], 'notificationSent',true);}} this.addNotification(`New listing: "${listing.crop}" from ${this.getFarmerDisplayIdentifier(listing.farmerWallet)}!`, 'info');
        if (this.isUserAuthenticated && this.role === 'buyer' && this.currentUserIdentifier !== listing.farmerWallet) { this.addNotification(`New listing for "${listing.crop}"!`, 'info', this.currentUserIdentifier); } console.log(`SIM: Notifying buyers of listing ${listing.id}: "${listing.crop}"`); },
      notifyInvestorsAboutFunding(request, markAsSent = false) { if (markAsSent) {/* Mark on request */} this.addNotification(`New funding: "${request.title}" by ${this.getFarmerDisplayIdentifier(request.farmerWallet)}!`, 'info');
        if (this.isUserAuthenticated && this.role === 'investor' && this.currentUserIdentifier !== request.farmerWallet) { this.addNotification(`New project "${request.title}" needs funding!`, 'info', this.currentUserIdentifier); } console.log(`SIM: Notifying investors of funding ${request.id}: "${request.title}"`); },
      saveDataToLocalStorage() { localStorage.setItem('pestiVidAppData', JSON.stringify({ allListings: this.allListings, allFundingRequests: this.allFundingRequests, farmerVideos: this.getAllFarmerVideos(), buyerPurchases: this.getAllBuyerPurchases(), investorInvestments: this.getAllInvestorInvestments(), investorTransactions: this.getAllInvestorTransactions(), messages: this.messages, conversations: this.conversations, })); },
      getAllFarmerVideos() { const data = JSON.parse(localStorage.getItem('pestiVidAppData') || '{}'); let all = data.farmerVideos || []; if (this.isUserAuthenticated && this.farmerVideos.length > 0) { const userCIDs = new Set(this.farmerVideos.map(v => v.cid)); all = all.filter(v => !userCIDs.has(v.cid) || v.farmerWallet !== this.currentUserIdentifier); all.push(...this.farmerVideos); } return [...new Map(all.map(item => [item.cid + item.farmerWallet, item])).values()]; },
      getAllBuyerPurchases() { const data = JSON.parse(localStorage.getItem('pestiVidAppData') || '{}'); let all = data.buyerPurchases || []; if (this.isUserAuthenticated && this.buyerPurchases.length > 0) { const userIDs = new Set(this.buyerPurchases.map(p => p.id)); all = all.filter(p => !userIDs.has(p.id) || p.buyerWallet !== this.currentUserIdentifier); all.push(...this.buyerPurchases); } return [...new Map(all.map(item => [item.id, item])).values()]; },
      getAllInvestorInvestments() { const data = JSON.parse(localStorage.getItem('pestiVidAppData') || '{}'); let all = data.investorInvestments || []; if (this.isUserAuthenticated && this.investorInvestments.length > 0) { const userIDs = new Set(this.investorInvestments.map(i => i.id)); all = all.filter(i => !userIDs.has(i.id) || i.investorWallet !== this.currentUserIdentifier); all.push(...this.investorInvestments); } return [...new Map(all.map(item => [item.id, item])).values()]; },
      getAllInvestorTransactions() { const data = JSON.parse(localStorage.getItem('pestiVidAppData') || '{}'); let all = data.investorTransactions || []; if (this.isUserAuthenticated && this.investorTransactions.length > 0) { const userIDs = new Set(this.investorTransactions.map(i => i.id)); all = all.filter(i => !userIDs.has(i.id) || i.investorWallet !== this.currentUserIdentifier); all.push(...this.investorTransactions); } return [...new Map(all.map(item => [item.id, item])).values()]; },
      loadDataFromLocalStorage() { const savedData = localStorage.getItem('pestiVidAppData'); if (savedData) { try { const appData = JSON.parse(savedData); this.allListings = appData.allListings || []; this.allFundingRequests = appData.allFundingRequests || []; this.messages = appData.messages || []; this.conversations = appData.conversations || [];
        if (!this.currentUserIdentifier) { // If no user logged in, don't load user-specific data into Vue's reactive properties
          this.farmerVideos = []; this.farmerListings = []; this.farmerFundingRequests = []; this.buyerPurchases = []; this.investorInvestments = []; this.investorTransactions = []; this.activeConversationId = null; } else { this.filterDataForCurrentUser(); // Load for current user if one exists
        }} catch (e) { console.error("Error loading localStorage, resetting:", e); localStorage.removeItem('pestiVidAppData'); this.loadDemoDataIfNeeded(); } } else { this.loadDemoDataIfNeeded(); }
        const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles')) || {}; if (this.currentUserIdentifier && userProfiles[this.currentUserIdentifier]) { const profile = userProfiles[this.currentUserIdentifier]; this.role = profile.role; this.userName = profile.name; this.userEmail = profile.email; this.userPhone = profile.phone || ''; this.memberSince = profile.memberSince || new Date().toLocaleDateString(); if (this.role === 'farmer') { this.farmerLocationCity = profile.farmerLocationCity || ''; } } },
      filterDataForCurrentUser() { console.log("Filtering data for user:", this.currentUserIdentifier, "Role:", this.role); const appData = JSON.parse(localStorage.getItem('pestiVidAppData') || '{}');
        if (!this.isUserAuthenticated) { // Clear all user-specific data if no user is authenticated
          this.farmerVideos = []; this.farmerListings = []; this.farmerFundingRequests = []; this.buyerPurchases = []; this.investorInvestments = []; this.investorTransactions = []; this.messages = appData.messages || []; // Keep all messages for now, or filter if strictly needed
          this.conversations = appData.conversations || []; // Same for conversations
          this.activeConversationId = null; return; }
        if (this.role === 'farmer') { this.farmerVideos = (appData.farmerVideos || []).filter(v => v.farmerWallet === this.currentUserIdentifier).map(v => ({...v, purpose: v.purpose || 'agristream'})); this.farmerListings = this.allListings.filter(l => l.farmerWallet === this.currentUserIdentifier); this.farmerFundingRequests = this.allFundingRequests.filter(r => r.farmerWallet === this.currentUserIdentifier); } else { this.farmerVideos = []; this.farmerListings = []; this.farmerFundingRequests = []; }
        if (this.role === 'buyer') { this.buyerPurchases = (appData.buyerPurchases || []).filter(p => p.buyerWallet === this.currentUserIdentifier); } else { this.buyerPurchases = []; }
        if (this.role === 'investor') { this.investorInvestments = (appData.investorInvestments || []).filter(i => i.investorWallet === this.currentUserIdentifier); this.investorTransactions = (appData.investorTransactions || []).filter(t => t.investorWallet === this.currentUserIdentifier); this.updateInvestmentProgress();
        } else { this.investorInvestments = []; this.investorTransactions = []; }
        this.messages = (appData.messages || []).filter(msg => msg.sender === this.currentUserIdentifier || msg.receiver === this.currentUserIdentifier); this.conversations = (appData.conversations || []).filter(conv => conv.participants.includes(this.currentUserIdentifier)); if (this.activeConversationId) {
          const activeConv = this.conversations.find(c => c.id === this.activeConversationId); if (!activeConv) { this.activeConversationId = null; } } },
      loadDemoDataIfNeeded() {
        let appDataString = localStorage.getItem('pestiVidAppData');
        if (appDataString) {
            try {
              const existingData = JSON.parse(appDataString);
              if (existingData && ( (existingData.allFundingRequests && existingData.allFundingRequests.length > 0) || (existingData.allListings && existingData.allListings.length > 0) || (existingData.farmerVideos && existingData.farmerVideos.length > 0) )) {
                   console.log("Existing PestiVid AppData found, skipping demo data.");
                   this.allListings = existingData.allListings || [];
                   this.allFundingRequests = existingData.allFundingRequests || [];
                   this.messages = existingData.messages || [];
                   this.conversations = existingData.conversations || [];
                   // User-specific data (farmerVideos, buyerPurchases, etc.) will be filtered by filterDataForCurrentUser
                   return;
              }
            } catch(e) { console.error("Error parsing demo data, loading fresh.", e); }
        }
        console.log("No valid PestiVid AppData. Loading Demo Data.");
        const oneDayAgoISO = new Date(Date.now() - (24*60*60*1000)).toISOString();
        const threeDaysAgoISO = new Date(Date.now() - (3*24*60*60*1000)).toISOString();

        const demoFarmer1 = 'oid_farmer_alice_sub';
        const demoFarmer2 = 'sol_farmer_bob_addr';
        const demoInvestor1 = 'oid_investor_charlie_sub';
        const demoBuyer1 = 'sol_buyer_dana_addr';

        const demoFarmerVideos = [ { farmerWallet: demoFarmer1, cid: 'QmXyZDemoCIDListing1', crop: 'Organic Tomatoes', pesticide: 'Copper Spray', location: 'West Field Plot A', pesticideCompany: 'AgriSource Organics', purpose: 'sell', uploadedAt: threeDaysAgoISO }, { farmerWallet: demoFarmer1, cid: 'QmYpUkLqrn4N1YgdNvT3zJbJnbZu4wcjGbDqrXKuL71L3V', crop: 'Sweet Strawberries', pesticide: 'Beneficial Ladybugs', location: 'South Plot GreenHouse 1', pesticideCompany: 'NatureFirst BioControls', purpose: 'funding', uploadedAt: oneDayAgoISO }, { farmerWallet: demoFarmer2, cid: 'Qme6xrRfA1kqdqrRJgXqGsNebvX1hXeER4xwqUfz1m4vB1', crop: 'Crisp Lettuce', pesticide: 'Balanced Nutrient Solution', location: 'Hydroponics Unit 1', pesticideCompany: 'HydroGrow Solutions', purpose: 'agristream', uploadedAt: oneDayAgoISO }, ];
        const demoBuyerPurchases = [ { id: 'pur_demo1_tomatoes', buyerWallet: demoBuyer1, farmerWallet: demoFarmer1, crop: 'Organic Tomatoes', location: 'West Field Plot A', pesticide: 'Copper Spray', pesticideCompany: 'AgriSource Organics', cid: 'QmXyZDemoCIDListing1', price: 0.95, date: new Date(Date.now() - 2*24*60*60*1000).toLocaleDateString(), txHash: 'sim_pur_tx_demo_tomatoes' }, ];
        const demoInvestorInvestments = [ { id: 'inv_demo1_strawberries', investorWallet: demoInvestor1, projectId: 'fr_demo1_strawberries', projectTitle: 'Organic Strawberry Expansion Initiative', farmerWallet: demoFarmer1, crop: 'Sweet Strawberries', method: 'organic', description: 'Expand organic strawberry cultivation by 2.5 acres, advanced irrigation & soil health for premium yields. Funds for plants, irrigation, soil amendments.', acres: 2.5, timeline: 6, roi: 18, investorShare: 20, amount: 10.00, cid: 'QmYpUkLqrn4N1YgdNvT3zJbJnbZu4wcjGbDqrXKuL71L3V', status: 'growing', progress: 30, investmentDate: new Date(Date.now() - 45*24*60*60*1000).toLocaleDateString(), txHash: 'sim_inv_tx_demo_strawberries' } ];
        const demoInvestorTransactions = [ { id: 'tx_demo1_investment_strawberries', investorWallet: demoInvestor1, txHash: 'sim_inv_tx_demo_strawberries', type: 'investment', amount: 10.00, date: new Date(Date.now() - 45*24*60*60*1000).toLocaleDateString(), projectId: 'fr_demo1_strawberries', projectTitle: 'Organic Strawberry Expansion Initiative' }, ];
        const nowTS = Date.now(); const minToMs = (min) => 1000 * 60 * min;
        const conv1Id = 'conv_demo_f1_i1_' + nowTS;
        const demoConversations = [ { id: conv1Id, participants: [demoFarmer1, demoInvestor1].sort(), lastMessageSnippet: 'Sounds good, will review terms.', lastMessageTimestamp: new Date(nowTS - minToMs(5)).toISOString() } ];
        const demoMessages = [ { id: 'msg_demo1a_' + nowTS, conversationId: conv1Id, sender: demoFarmer1, receiver: demoInvestor1, text: 'Hi Investor Charlie, thanks for interest in Strawberry Expansion. Questions?', timestamp: new Date(nowTS - minToMs(10)).toISOString(), read: true }, { id: 'msg_demo1b_' + nowTS, conversationId: conv1Id, sender: demoInvestor1, receiver: demoFarmer1, text: 'Hello Farmer Alice! Project looks promising. Projected returns?', timestamp: new Date(nowTS - minToMs(8)).toISOString(), read: true }, { id: 'msg_demo1c_' + nowTS, conversationId: conv1Id, sender: demoFarmer1, receiver: demoInvestor1, text: 'Projecting 18% ROI over 6 months, 20% profit share for investors.', timestamp: new Date(nowTS - minToMs(6)).toISOString(), read: true }, { id: 'msg_demo1d_' + nowTS, conversationId: conv1Id, sender: demoInvestor1, receiver: demoFarmer1, text: 'Sounds good, will review terms.', timestamp: new Date(nowTS - minToMs(5)).toISOString(), read: false } ];

        this.allFundingRequests = [ { id: 'fr_demo1_strawberries', farmerWallet: demoFarmer1, title: 'Organic Strawberry Expansion Initiative', crop: 'Sweet Strawberries', acres: 2.5, amount: 25, method: 'organic', cid: 'QmYpUkLqrn4N1YgdNvT3zJbJnbZu4wcjGbDqrXKuL71L3V', description: 'Expand organic strawberry cultivation by 2.5 acres, advanced irrigation & soil health for premium yields. Funds for plants, irrigation, soil amendments.', timeline: 6, roi: 18, investorShare: 20, fundedAmount: 10, status: 'partially_funded', createdAt: oneDayAgoISO, investors: [{investorId: demoInvestor1, amount: 10, txHash:'sim_inv_tx_demo_strawberries', date: new Date(Date.now() - 45*24*60*60*1000).toLocaleDateString()}], updates: [{id: 'upd1_fr1', date: new Date(Date.now() - 10*24*60*60*1000).toLocaleDateString(), text: "Planting complete, irrigation tested."}], txHash: 'sim_fr_tx_1_strawberries' }, { id: 'fr_demo2_lettuce', farmerWallet: demoFarmer2, title: 'Advanced Hydroponic Lettuce Setup', crop: 'Crisp Lettuce', acres: 0.5, amount: 40, method: 'hydroponic', cid: 'Qme6xrRfA1kqdqrRJgXqGsNebvX1hXeER4xwqUfz1m4vB1', description: 'New NFT hydroponic system for year-round lettuce. Funds for components, setup, LED lighting.', timeline: 4, roi: 25, investorShare: 30, fundedAmount: 0, status: 'pending', createdAt: oneDayAgoISO, investors: [], updates: [], txHash: 'sim_fr_tx_2_lettuce' }, ];
        this.allListings = [ { id: 'lst_demo1_tomatoes', farmerWallet: demoFarmer1, crop: 'Organic Tomatoes', location: 'West Field Plot A', pesticide: 'Copper Spray', pesticideCompany: 'AgriSource Organics', cid: 'QmXyZDemoCIDListing1', minPrice: 0.80, maxPrice: 1.20, status: 'active', createdAt: oneDayAgoISO, isNew: true, txHash: 'sim_lst_tx_1_tomatoes' }, { id: 'lst_demo2_peppers', farmerWallet: demoFarmer2, crop: 'Bell Peppers (Mixed)', location: 'Greenhouse 3 North', pesticide: 'Neem Oil Extract', pesticideCompany: 'Organics Inc. EcoShield', cid: 'Qme6xrRfA1kqdqrRJgXqGsNebvX1hXeER4xwqUfz1m4vB1', minPrice: 1.00, maxPrice: 1.50, status: 'active', createdAt: threeDaysAgoISO, isNew: false, txHash: 'sim_lst_tx_2_peppers' }, ];

        const demoProfiles = {};
        demoProfiles[demoFarmer1] = { role: 'farmer', name: 'Alice Farmer (OID)', email: 'alice.oid@pestivid.sim', phone: '555-0101', memberSince: this.simulateMemberSince(demoFarmer1), farmerLocationCity: 'Sunnyvale, CA', authMethod: 'orangeId'};
        demoProfiles[demoFarmer2] = { role: 'farmer', name: 'Bob Gardner (SOL)', email: 'bob.sol@pestivid.sim', phone: '555-0102', memberSince: this.simulateMemberSince(demoFarmer2), farmerLocationCity: 'Greenfield, MA', authMethod: 'solana'};
        demoProfiles[demoInvestor1] = { role: 'investor', name: 'Charlie Investor (OID)', email: 'charlie.oid@pestivid.sim', phone: '555-0103', memberSince: this.simulateMemberSince(demoInvestor1), authMethod: 'orangeId'};
        demoProfiles[demoBuyer1] = { role: 'buyer', name: 'Dana Buyer (SOL)', email: 'dana.sol@pestivid.sim', phone: '555-0104', memberSince: this.simulateMemberSince(demoBuyer1), authMethod: 'solana'};

        localStorage.setItem('pestiVidAppData', JSON.stringify({ allListings: this.allListings, allFundingRequests: this.allFundingRequests, farmerVideos: demoFarmerVideos, buyerPurchases: demoBuyerPurchases, investorInvestments: demoInvestorInvestments, investorTransactions: demoInvestorTransactions, messages: demoMessages, conversations: demoConversations, }));
        localStorage.setItem('pestiVidUserProfiles', JSON.stringify(demoProfiles));
        if (this.currentUserIdentifier) { // If a user was already logged in (e.g. page reload), filter data
            this.filterDataForCurrentUser();
        }
      },
      scrollToAndHighlightAgriStreamVideo() { if (!this.targetAgriStreamVideoCid) return; this.highlightedAgriStreamVideoCid = this.targetAgriStreamVideoCid; this.$nextTick(() => { const videoCardRef = this.$refs[`videoCard-${this.targetAgriStreamVideoCid}`]; if (videoCardRef && videoCardRef[0]) { videoCardRef[0].scrollIntoView({ behavior: 'smooth', block: 'center' }); setTimeout(() => { this.highlightedAgriStreamVideoCid = null; this.targetAgriStreamVideoCid = null; }, 2500); } else { console.warn(`AgriStream video ref not found: ${this.targetAgriStreamVideoCid}`); this.highlightedAgriStreamVideoCid = null; this.targetAgriStreamVideoCid = null; } }); },
      getOtherParticipantInitial(conv) { if (!conv || !this.isUserAuthenticated) return '?'; const otherP = conv.participants.find(p => p !== this.currentUserIdentifier); if (!otherP) return '?'; const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles')) || {}; const otherPProfile = userProfiles[otherP]; if (otherPProfile && otherPProfile.name) return otherPProfile.name.charAt(0).toUpperCase(); return String(otherP).charAt(0).toUpperCase(); },
      getOtherParticipantDisplayAddress(conv) { if (!conv || !this.isUserAuthenticated) return '?'; const otherP = conv.participants.find(p => p !== this.currentUserIdentifier); if (!otherP) return '?'; const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles')) || {}; const otherPProfile = userProfiles[otherP]; if (otherPProfile && otherPProfile.name) return otherPProfile.name.split(' ')[0]; return `${String(otherP).substring(0,6)}...${String(otherP).substring(String(otherP).length-4)}`; },
      formatTimestamp(isoString, short = false) { if (!isoString) return ''; const date = new Date(isoString); const now = new Date(); const diffSeconds = Math.round((now.getTime() - date.getTime()) / 1000); const diffMinutes = Math.round(diffSeconds / 60); const diffHours = Math.round(diffMinutes / 60); const diffDays = Math.round(diffHours / 24); if (short) { if (diffMinutes < 1) return 'now'; if (diffMinutes < 60) return `${diffMinutes}m`; if (diffHours < 24) return `${diffHours}h`; if (diffDays < 7) return date.toLocaleDateString(undefined, { weekday: 'short' }).substring(0,3); return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }); } else { if (diffMinutes < 2) return 'Just now'; if (diffMinutes < 60) return `${diffMinutes}m ago`; if (diffHours < 24) return date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }); return date.toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' }) + ' ' + date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }); } },
      handlePlantImageUpload(event) { const file = event.target.files[0]; if (file) { this.plantImageFile = file; this.plantImageMimeType = file.type; this.plantImageUrl = URL.createObjectURL(file); this.analysisResultText = ''; this.parsedAnalysis = { plantName: null, diseaseName: null, treatmentRecommended: null }; this.analysisErrorText = ''; } },
      convertFileToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => { resolve(reader.result.split(',')[1]); }; reader.onerror = error => reject(error); }); },
      async analyzePlant() {
          if (!this.plantImageFile) { this.analysisErrorText = "Upload image first."; return; }
          if (this.geminiApiKey === 'YOUR_GEMINI_API_KEY_HERE' || !this.geminiApiKey || this.geminiApiKey.length < 30) { this.analysisErrorText = "Gemini API key missing/invalid."; this.addNotification(this.analysisErrorText, "error"); return; }
          this.analysisInProgress = true; this.analysisResultText = ''; this.parsedAnalysis = { plantName: null, diseaseName: null, treatmentRecommended: null }; this.analysisErrorText = '';
          try {
              const base64Image = await this.convertFileToBase64(this.plantImageFile);
              const apiKey = this.geminiApiKey; const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
              const prompt = `Analyze plant image. Identify plant, detect diseases. Format:
  Plant: [Plant Name or 'Unknown']
  Disease: [Disease Name or 'Healthy' or 'Not Apparent' or 'Unknown']
  Treatment: [Recommended treatment/pesticides. If healthy, 'No treatment needed'. If unknown disease, 'Cannot recommend treatment.'].
  Be concise. If not clear/plant, state that.`;
              const payload = { contents: [{ parts: [ { text: prompt }, { inline_data: { mime_type: this.plantImageMimeType, data: base64Image } } ] }], generationConfig: { "temperature": 0.4, "topK": 32, "topP": 1, "maxOutputTokens": 2048, }, safetySettings: [ { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_MEDIUM_AND_ABOVE" }, { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_MEDIUM_AND_ABOVE" }, { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_MEDIUM_AND_ABOVE" }, { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_MEDIUM_AND_ABOVE" } ] };
              const response = await axios.post(url, payload);
              if (response.data && response.data.candidates && response.data.candidates[0].content && response.data.candidates[0].content.parts && response.data.candidates[0].content.parts[0].text) {
                  this.analysisResultText = response.data.candidates[0].content.parts[0].text; this.parseGeminiResponse(this.analysisResultText);
              } else if (response.data && response.data.promptFeedback && response.data.promptFeedback.blockReason) {
                  this.analysisErrorText = `Analysis blocked by API: ${response.data.promptFeedback.blockReason}. Image/prompt violated safety.`; this.parsedAnalysis = { plantName: 'Blocked', diseaseName: 'Blocked', treatmentRecommended: 'Blocked by API' };
              } else { console.error("Unexpected Gemini response:", response.data); throw new Error("Invalid Gemini response."); }
          } catch (error) {
              console.error("Error analyzing with Gemini:", error);
              if (error.response) { this.analysisErrorText = `Gemini API Error: ${error.response.status}. ${error.response.data?.error?.message || 'Failed details.'}`; if(error.response.status === 400 && error.response.data?.error?.message.toLowerCase().includes("api key not valid")) { this.analysisErrorText += " Check API key & Generative Language API in GCP."; } else if (error.response.status === 429) { this.analysisErrorText += " Exceeded API quota."; }
              } else if (error.request) { this.analysisErrorText = "Network error: Gemini API. Check internet."; } else { this.analysisErrorText = "Unexpected error: " + error.message; }
              this.parsedAnalysis = { plantName: '-', diseaseName: '-', treatmentRecommended: '-' };
          } finally { this.analysisInProgress = false; }
      },
      parseGeminiResponse(text) {
          const result = { plantName: 'Unknown', diseaseName: 'Not Apparent', treatmentRecommended: 'Could not determine treatment.' }; if (!text) { this.parsedAnalysis = result; return; }
          const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0); let currentPlant = null; let currentDisease = null; let currentTreatment = [];
          lines.forEach(line => { const lowerLine = line.toLowerCase(); if (lowerLine.startsWith('plant:')) { currentPlant = line.substring('plant:'.length).trim(); } else if (lowerLine.startsWith('disease:')) { currentDisease = line.substring('disease:'.length).trim(); } else if (lowerLine.startsWith('treatment:')) { currentTreatment.push(line.substring('treatment:'.length).trim()); } else if (currentTreatment.length > 0) { currentTreatment.push(line); } else if (currentDisease && !currentTreatment.length > 0) { currentTreatment.push(line); } else if (currentPlant && !currentDisease && !currentTreatment.length > 0) { if (lowerLine.includes("healthy") || lowerLine.includes("not apparent") || lowerLine.includes("unknown disease")) { currentDisease = line; } } });
          if (currentPlant) result.plantName = currentPlant; if (currentDisease) result.diseaseName = currentDisease; if (currentTreatment.length > 0) result.treatmentRecommended = currentTreatment.join('\n');

          if (result.plantName === 'Unknown' && result.diseaseName === 'Not Apparent' && result.treatmentRecommended === 'Could not determine treatment.') { const plantMatch = text.match(/Plant:\s*(.*)/i); const diseaseMatch = text.match(/Disease:\s*(.*)/i); const treatmentMatch = text.match(/Treatment:\s*(.*?)(?:\n\n|$)/is);
            if (plantMatch && plantMatch[1]) result.plantName = plantMatch[1].trim(); if (diseaseMatch && diseaseMatch[1]) result.diseaseName = diseaseMatch[1].trim(); if (treatmentMatch && treatmentMatch[1]) result.treatmentRecommended = treatmentMatch[1].trim().replace(/\n\n/g, '\n');
          }
          this.parsedAnalysis = result;
      }
    },
    mounted() {
      console.log("PestiVid (Orange ID & Solana) App Mounted.");
      if (!this.initializeOrangeIdSDK()) {
        console.warn("Orange ID SDK failed to initialize. Orange ID login unavailable.");
      } else {
        console.log("Orange ID SDK initialized with Tenant ID:", this.bedrockConfig.tenantId, "and Subscription Key set.");
      }

      if (this.pinataJwt === 'YOUR_PINATA_JWT' || !this.pinataJwt) { console.warn("CONFIG WARNING: Pinata JWT not set. Uploads WILL FAIL."); this.addNotification("Upload service not configured.", "warning"); }
      if (this.pinataGateway === 'YOUR_PINATA_GATEWAY_HOSTNAME' || !this.pinataGateway) { console.warn("CONFIG WARNING: Pinata Gateway not set. Playback WILL FAIL."); this.addNotification("Playback service not configured.", "warning"); }
      if (this.weatherApiKey === 'YOUR_OPENWEATHERMAP_API_KEY' || !this.weatherApiKey) { console.warn("CONFIG WARNING: OpenWeatherMap Key not set. Weather WILL NOT WORK."); this.addNotification("Weather service not configured.", "warning"); }
      if (this.geminiApiKey === 'YOUR_GEMINI_API_KEY_HERE') { console.warn("CONFIG WARNING: Gemini Key not set. Plant AI WILL FAIL."); this.addNotification("Plant AI not configured.", "warning");
      } else if (this.geminiApiKey && this.geminiApiKey.startsWith('AIzaSyC') && this.geminiApiKey.length < 35) { /* A common prefix for some Google API keys */ console.warn("GEMINI API KEY: Using a key that might be a generic example. Ensure it's your actual, active key with the Generative Language API enabled and billing configured in your Google Cloud Project if needed."); }


      if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') { console.warn("SECURITY WARNING: Not HTTPS. Camera might fail/be insecure."); }

      this.loadDataFromLocalStorage();

      if (this.checkOrangeIdCallback()) {
          return; // Callback processor will handle auth success and data loading.
      }

      const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles')) || {};
      if (!this.isUserAuthenticated && !this.isAuthProcessing && window.solana && window.solana.isPhantom) {
           // Attempt auto-reconnect for last known Solana user if not already authenticated and not in OrangeID callback
           const lastSolanaUserEntries = Object.entries(userProfiles).find(([id, profile]) => profile.authMethod === 'solana');
           if (lastSolanaUserEntries) {
              const lastSolanaUserId = lastSolanaUserEntries[0];
              console.log("Attempting Solana auto-reconnect for:", lastSolanaUserId);
              window.solana.connect({ onlyIfTrusted: true })
                  .then(resp => {
                      if (resp && resp.publicKey && resp.publicKey.toString() === lastSolanaUserId) {
                          console.log("Auto-reconnected Solana:", resp.publicKey.toString());
                          this.handleAuthenticationSuccess(resp.publicKey.toString(), 'solana');
                      } else {
                         console.log("Solana auto-reconnect not trusted or different wallet:", resp);
                      }
                  })
                  .catch(err => console.log("Solana auto-reconnect failed:", err.message || err));
           }
      } else if (this.isUserAuthenticated) {
          console.log("User already authenticated on mount, filtering data:", this.currentUserIdentifier);
          this.filterDataForCurrentUser(); // Ensure data is loaded for the already authenticated user
          if (this.loginMethod === 'orangeId') {
              this.$nextTick(() => {
                this.renderOrangeIdSignOutButton('orange-id-signout-button-container');
                if(this.showMobileMenu) this.renderOrangeIdSignOutButton('orange-id-signout-button-container-mobile', true);
              });
          }
      }

      setInterval(() => { if(this.isUserAuthenticated && this.role==='investor') this.updateInvestmentProgress(); }, 30000);
    }
  });
  window.vueApp = app; // For debugging
</script>
</body>
</html>