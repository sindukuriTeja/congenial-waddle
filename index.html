<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PestiVid - Agricultural Blockchain Platform (Web3 Demo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" rel="stylesheet">
  <!-- Google Fonts (Inter) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Basic Web3 Support -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <!-- IPFS Integration for Decentralized Storage -->
  <script src="https://unpkg.com/ipfs-http-client@latest/dist/index.min.js"></script>

  <!-- Vue.js -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
  <!-- Axios, Marked.js (for Markdown) -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>



  <!-- DApp Configuration -->
  <script src="js/dapp-config.js"></script>

  <!-- Wallet Integration -->
  <script src="js/wallet-integration.js"></script>

  <!-- Component/Page Scripts (Order: Vue -> Components -> App Logic) -->
  <!-- These files (ChatInterface.js, MessagingPage.js, app.js) are not provided,
       so their functionality is assumed or placeholder.
       If they define global Vue components, they should be loaded after Vue.js
       and before the main Vue instance script.
  -->
  <script src="js/components/ChatInterface.js"></script>
  <script src="js/pages/MessagingPage.js"></script>
  <script src="js/app.js"></script> <!-- This might be redundant if the main Vue instance is inline below -->

  <!-- Styling -->
  <style>
    body { font-family: 'Inter', system-ui, sans-serif; background: #f9fafb; }
    html { scroll-behavior: smooth; overflow-x: hidden; }
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 5px; }
    ::-webkit-scrollbar-thumb:hover { background: #aaa; }
    * { scrollbar-width: thin; scrollbar-color: #ccc #f1f1f1; -ms-overflow-style: -ms-autohiding-scrollbar; }
    .progress-bar { height: 8px; border-radius: 4px; background: #e5e7eb; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
    .modal-scrollable { max-height: 85vh; overflow-y: auto; }
    .project-updates-list { max-height: 150px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 0.75rem; background-color: #f9fafb; }
    .project-update-item { padding-bottom: 0.5rem; margin-bottom: 0.5rem; border-bottom: 1px solid #f3f4f6; }
    .project-update-item:last-child { border-bottom: none; margin-bottom: 0; }
    .message-view-container { scroll-behavior: smooth; }
    .notification-badge { position: absolute; top: -5px; right: -8px; min-width: 18px; height: 18px; background-color: #ef4444; border-radius: 9px; color: white; font-size: 10px; font-weight: 600; line-height: 18px; text-align: center; padding: 0 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    .mobile-notification-badge { display: inline-block; background-color: #ef4444; color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 9px; line-height: 16px; text-align: center; vertical-align: top; margin-left: 4px; }
    .notification-toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column-reverse; gap: 10px; align-items: flex-end; }
    .notification-toast { min-width: 250px; max-width: 350px; background-color: #fff; color: #333; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); display: flex; align-items: center; opacity: 0; transform: translateX(100%); transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
    .notification-toast.show { opacity: 1; transform: translateX(0); }
    .notification-toast .icon { margin-right: 0.75rem; font-size: 1.25rem; }
    .notification-toast .icon-info { color: #3b82f6; } .notification-toast .icon-success { color: #10b981; } .notification-toast .icon-warning { color: #f59e0b; } .notification-toast .icon-error { color: #ef4444; }
    .notification-toast .message { font-size: 0.875rem; line-height: 1.3; }
    .notification-toast .close-btn { margin-left: auto; padding-left: 0.75rem; color: #9ca3af; cursor: pointer; background: none; border: none; font-size: 1rem; }
    .notification-toast .close-btn:hover { color: #6b7280; }
    .new-badge { position: absolute; top: -8px; right: -8px; background-color: #3b82f6; color: white; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .loading-modal { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 9999; }
    .loading-content { background-color: white; padding: 2rem; border-radius: 0.5rem; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    .loading-content .fa-spinner { font-size: 2rem; color: #10b981; margin-bottom: 1rem; }

    /* Chatbot Styles */
    .chatbot-container { display: flex; flex-direction: column; height: calc(100vh - 230px); max-height: 700px; border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden; }
    .chatbot-messages { flex-grow: 1; padding: 1rem; overflow-y: auto; background-color: #f9fafb; }
    .chat-message { display: flex; max-width: 80%; margin-bottom: 0.5rem;}
    .chat-message.user { margin-left: auto; flex-direction: row-reverse; }
    .chat-message .message-content { display: flex; align-items: flex-end; }
    .chat-message.user .message-content { flex-direction: row-reverse; }
    .chat-message .message-bubble { padding: 0.75rem 1rem; border-radius: 1rem; line-height: 1.5; word-wrap: break-word; max-width: calc(100% - 3.5rem); /* Account for avatar */ }
    .chat-message.user .message-bubble { background-color: #10b981; color: white; border-bottom-right-radius: 0.25rem; }
    .chat-message.bot .message-bubble { background-color: #e5e7eb; color: #1f2937; border-bottom-left-radius: 0.25rem; }
    .chat-message .avatar { width: 2.5rem; height: 2.5rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; margin: 0 0.5rem; flex-shrink: 0; align-self: flex-end; }
    .chat-message.user .avatar { background-color: #059669; color: white; }
    .chat-message.bot .avatar { background-color: #d1d5db; color: #4b5563; }
    .chatbot-input-area { border-top: 1px solid #e5e7eb; padding: 1rem; background-color: #fff; display: flex; gap: 0.75rem; }
    .chatbot-input-area input { flex-grow: 1; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; }
    .chatbot-input-area input:focus { outline: none; border-color: #10b981; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); }
    .chatbot-input-area button { background-color: #10b981; color: white; padding: 0.75rem 1.25rem; border-radius: 0.375rem; font-weight: 600; font-size: 0.875rem; }
    .chatbot-input-area button:hover { background-color: #059669; }
    .chatbot-input-area button:disabled { background-color: #9ca3af; cursor: not-allowed; }
    .typing-indicator span { height: 8px; width: 8px; margin: 0 2px; background-color: #9ca3af; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
    .message-bubble ul, .message-bubble ol { margin-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
    .message-bubble li { margin-bottom: 0.25rem; }
    .message-bubble p { margin-bottom: 0.5rem; }
    .message-bubble p:last-child { margin-bottom: 0; }
    .message-bubble strong, .message-bubble b { font-weight: 600; }
    .message-bubble em, .message-bubble i { font-style: italic; }
    .message-bubble pre { background-color: #f3f4f6; padding: 0.5rem; border-radius: 0.25rem; overflow-x: auto; font-family: monospace; font-size: 0.875em; margin: 0.5rem 0; }
    .message-bubble code { background-color: #f3f4f6; padding: 0.1em 0.3em; border-radius: 0.25rem; font-family: monospace; font-size: 0.875em; }
    .message-bubble pre code { padding: 0; background-color: transparent; }

    /* Avatar Assistant Styles */
    @keyframes pulse-slow {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }
    .animate-pulse-slow {
      animation: pulse-slow 2s infinite ease-in-out;
    }
    .avatar-input-mic-btn.listening i {
        animation: pulse-red 1.5s infinite;
    }
    @keyframes pulse-red {
      0%, 100% { color: #ef4444; transform: scale(1); }
      50% { color: #f87171; transform: scale(1.1); }
    }

    /* NEW Authentication Screen Styles (from first example) */
    .auth-container {
        min-height: 100vh;
        background-color: #e5f7ed;
    }
    .auth-card {
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.98);
    }
    /* End NEW Authentication Screen Styles */

    /* YouTube Popup Styles */
    .youtube-popup-overlay {
        backdrop-filter: blur(4px);
        animation: fadeIn 0.3s ease-out;
    }

    .youtube-popup-content {
        animation: slideIn 0.4s ease-out;
        max-height: 90vh;
        overflow-y: auto;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .youtube-close-btn {
        transition: all 0.2s ease;
    }

    .youtube-close-btn:hover {
        transform: scale(1.1);
        background-color: rgba(0, 0, 0, 0.8) !important;
    }

    /* Loading Modal Styles */
    .loading-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    .loading-content {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .loading-content i {
        font-size: 2rem;
        color: #10b981;
        margin-bottom: 1rem;
    }
  </style>
</head>
<body class="text-gray-900">
<div id="app" class="flex flex-col min-h-screen">

  <!-- Authentication Modal (Login/Signup) - Hidden, using page-based auth now -->
  <div v-if="false" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
      <div class="auth-card rounded-2xl shadow-2xl p-8 max-w-md w-full bg-white">
          <!-- Close Button -->
          <div class="text-right mb-4">
              <button @click="showAuthModal = false; showSignup = false" class="text-gray-400 hover:text-gray-600">
                  <i class="fas fa-times text-xl"></i>
              </button>
          </div>

          <!-- Logo -->
          <div class="text-center mb-8">
              <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
                  <i class="fas fa-seedling text-green-600 text-2xl"></i>
              </div>
              <h1 class="text-3xl font-bold text-gray-900 mb-2">PestiVid</h1>
              <p class="text-gray-600">Agricultural Blockchain Platform</p>
          </div>

          <!-- Login Form -->
          <div v-if="!showSignup">
              <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">Welcome Back</h2>
              <form @submit.prevent="login" class="space-y-4">
                  <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                      <input v-model="loginForm.email" type="email" required
                             class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500"
                             placeholder="Enter your email">
                  </div>
                  <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                      <input v-model="loginForm.password" type="password" required
                             class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500"
                             placeholder="Enter your password">
                  </div>
                  <div class="flex items-center justify-between">
                      <label class="flex items-center">
                          <input v-model="loginForm.remember" type="checkbox" class="form-checkbox mr-2 text-green-600">
                          <span class="text-sm text-gray-600">Remember me</span>
                      </label>
                      <a href="#" @click.prevent="forgotPassword" class="text-sm text-green-600 hover:text-green-500">
                          Forgot password?
                      </a>
                  </div>
                  <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md font-medium transition-colors">
                      <i class="fas fa-sign-in-alt mr-2"></i>Sign In
                  </button>
              </form>
              <div class="mt-6 text-center">
                  <p class="text-gray-600">Don't have an account?
                      <a href="#" @click.prevent="showSignup = true" class="text-green-600 hover:text-green-500 font-medium">Sign up</a>
                  </p>
              </div>
          </div>

          <!-- Signup Form -->
          <div v-if="showSignup">
              <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">Create Account</h2>
              <form @submit.prevent="signup" class="space-y-4">
                  <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                      <input v-model="signupForm.name" type="text" required
                             class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500"
                             placeholder="Enter your full name">
                  </div>
                  <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                      <input v-model="signupForm.email" type="email" required
                             class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500"
                             placeholder="Enter your email">
                  </div>
                  <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                      <input v-model="signupForm.phone" type="tel" required
                             class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500"
                             placeholder="Enter your phone number">
                  </div>
                  <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                      <select v-model="signupForm.role" required
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 bg-white">
                          <option value="">Select your role</option>
                          <option value="farmer">Farmer</option>
                          <option value="buyer">Buyer</option>
                          <option value="investor">Investor</option>
                          <option value="transporter">Transporter</option>
                      </select>
                  </div>

                  <!-- Wallet Connection Requirement for Farmers -->
                  <div v-if="signupForm.role === 'farmer'" class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                      <div class="flex items-center justify-between">
                          <div>
                              <h4 class="text-sm font-medium text-purple-900">Wallet Connection Required</h4>
                              <p class="text-xs text-purple-700 mt-1">Farmers must connect a MetaMask wallet to receive AVAX payments</p>
                          </div>
                          <button v-if="!walletConnected" @click="connectWallet" type="button"
                                  class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">
                              <i class="fas fa-wallet mr-1"></i>Connect Wallet
                          </button>
                          <div v-if="walletConnected" class="text-green-600 text-sm">
                              <i class="fas fa-check-circle mr-1"></i>Wallet Connected
                          </div>
                      </div>
                      <div v-if="walletConnected" class="mt-2 text-xs text-gray-600">
                          <strong>Wallet:</strong> {{ formatWalletAddress(walletAddress) }}
                      </div>
                  </div>
                  <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                      <input v-model="signupForm.password" type="password" required
                             class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500"
                             placeholder="Create a password">
                      <p class="text-xs text-gray-500 mt-1">At least 6 characters.</p>
                  </div>
                  <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
                      <input v-model="signupForm.confirmPassword" type="password" required
                             class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500"
                             placeholder="Confirm your password">
                  </div>
                  <div class="flex items-center">
                      <input v-model="signupForm.acceptTerms" type="checkbox" required class="form-checkbox mr-2 text-green-600">
                      <span class="text-sm text-gray-600">I agree to the
                          <a href="#" @click.prevent class="text-green-600 hover:text-green-500">Terms and Conditions</a>
                      </span>
                  </div>
                  <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md font-medium transition-colors">
                      <i class="fas fa-user-plus mr-2"></i>Create Account
                  </button>
              </form>
              <div class="mt-6 text-center">
                  <p class="text-gray-600">Already have an account?
                      <a href="#" @click.prevent="showSignup = false" class="text-green-600 hover:text-green-500 font-medium">Sign in</a>
                  </p>
              </div>
          </div>
      </div>
  </div>

  <!-- Main Website Content (Always Visible) -->
  <div class="flex-grow">
    <!-- Chat Interface -->
    <div class="chat-interface-container p-4"> <!-- Assuming ChatInterface is a global component or placeholder -->
        <chat-interface></chat-interface>
    </div>

    <div class="flex-grow">
        <!-- Header/Navbar (Always Shown) -->
        <header class="bg-white shadow sticky top-0 z-30">
            <div class="max-w-7xl mx-auto px-5 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <a href="#" @click.prevent="switchPage('landing')" class="text-2xl text-green-700 font-semibold hover:text-green-800 transition-colors cursor-pointer">
                        <i class="fas fa-seedling mr-1"></i>PestiVid
                    </a>
                </div>
                <nav class="hidden md:flex space-x-5 items-center">




                    <!-- Show login/signup buttons when not authenticated -->
                    <template v-if="!isAuthenticated">
                        <a href="#" @click.prevent="switchPage('login')" class="text-gray-700 hover:text-green-600 font-medium transition-colors">
                            <i class="fas fa-sign-in-alt mr-1"></i>Login
                        </a>
                        <a href="#" @click.prevent="switchPage('signup')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            <i class="fas fa-user-plus mr-1"></i>Sign Up
                        </a>
                    </template>

                    <!-- Show authenticated user menu -->
                    <template v-if="isAuthenticated">





                        <!-- Farmer Menu -->
                        <template v-if="isAuthenticated && role==='farmer'">
                            <a href="#" @click.prevent="switchPage('farmerPestiVid')" :class="{'font-bold text-green-700': current==='farmerPestiVid'}" class="hover:text-green-600">PestiVid</a>
                            <a href="#" @click.prevent="switchPage('farmerAgriStream')" :class="{'font-bold text-green-700': current==='farmerAgriStream'}" class="hover:text-green-600">AgriStream</a>
                            <a href="#" @click.prevent="switchPage('farmerSell')" :class="{'font-bold text-green-700': current==='farmerSell'}" class="hover:text-green-600">Sell</a>
                            <a href="#" @click.prevent="switchPage('farmerFunding')" :class="{'font-bold text-green-700': current==='farmerFunding'}" class="hover:text-green-600">Get Funding</a>
                            <a href="#" @click.prevent="switchPage('farmerTransport')" :class="{'font-bold text-green-700': current==='farmerTransport'}" class="hover:text-green-600">Transport</a>
                            <a href="#" @click.prevent="switchPage('plantAnalysis')" :class="{'font-bold text-green-700': current==='plantAnalysis'}" class="hover:text-green-600">Plant Analysis</a>
                            <a href="#" @click.prevent="switchPage('farmerChatbot')" :class="{'font-bold text-green-700': current==='farmerChatbot'}" class="hover:text-green-600"><i class="fas fa-robot mr-1"></i>AgriBot</a>
                            <a href="#" @click.prevent="switchPage('messaging')" :class="{'font-bold text-green-700': current==='messaging'}" class="hover:text-green-600 flex items-center">
                                <i class="fas fa-comments mr-1"></i>Messages
                                <span v-if="unreadMessageCount > 0" class="notification-badge">{{ unreadMessageCount }}</span>
                            </a>

                            <!-- Wallet Connection for Farmer -->
                            <template v-if="!walletConnected">
                                <button @click="connectWallet" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm font-medium transition-colors">
                                    <i class="fas fa-wallet mr-1"></i>Connect Wallet
                                </button>
                            </template>
                            <template v-if="walletConnected">
                                <div class="flex items-center space-x-1">
                                    <div class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">
                                        <i class="fas fa-circle text-green-500 mr-1" style="font-size: 6px;"></i>{{ walletType || 'Connected' }}
                                    </div>
                                    <button @click="disconnectWallet" class="text-gray-500 hover:text-red-600 text-xs" title="Disconnect Wallet">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </template>

                            <!-- Profile for Farmer -->
                            <a href="#" @click.prevent="switchPage('userProfile')" :class="{'font-bold text-green-700': current==='userProfile'}" class="bg-green-600 text-white text-xs rounded-full px-3 py-1 select-none hover:bg-green-700 flex items-center">
                                <i class="fas fa-user-circle mr-1"></i> {{ userNameDisplay }}
                            </a>
                        </template>


                        <!-- Buyer Menu -->
                        <template v-if="role==='buyer'">
                            <a href="#" @click.prevent="switchPage('buyerAgriSell')" :class="{'font-bold text-green-700': current==='buyerAgriSell'}" class="hover:text-green-600">AgriSell</a>
                            <a href="#" @click.prevent="switchPage('buyerTransport')" :class="{'font-bold text-green-700': current==='buyerTransport'}" class="hover:text-green-600">Transport</a>
                            <a href="#" @click.prevent="switchPage('messaging')" :class="{'font-bold text-green-700': current==='messaging'}" class="hover:text-green-600 flex items-center">
                                <i class="fas fa-comments mr-1"></i>Messages
                                <span v-if="unreadMessageCount > 0" class="notification-badge">{{ unreadMessageCount }}</span>
                            </a>
                            <a href="#" @click.prevent="switchPage('userProfile')" :class="{'font-bold text-green-700': current==='userProfile'}" class="bg-green-600 text-white text-xs rounded-full px-3 py-1 select-none hover:bg-green-700 flex items-center">
                                <i class="fas fa-user-circle mr-1"></i> {{ userNameDisplay }}
                            </a>
                        </template>
                        <!-- Investor Menu -->
                        <template v-if="role==='investor'">
                            <a href="#" @click.prevent="switchPage('investorProjects')" :class="{'font-bold text-green-700': current==='investorProjects'}" class="hover:text-green-600">Projects</a>
                            <a href="#" @click.prevent="switchPage('investorPortfolio')" :class="{'font-bold text-green-700': current==='investorPortfolio'}" class="hover:text-green-600">Portfolio</a>
                            <a href="#" @click.prevent="switchPage('investorTransport')" :class="{'font-bold text-green-700': current==='investorTransport'}" class="hover:text-green-600">Transport</a>
                            <a href="#" @click.prevent="switchPage('messaging')" :class="{'font-bold text-green-700': current==='messaging'}" class="hover:text-green-600 flex items-center">
                                <i class="fas fa-comments mr-1"></i>Messages
                                <span v-if="unreadMessageCount > 0" class="notification-badge">{{ unreadMessageCount }}</span>
                            </a>
                            <a href="#" @click.prevent="switchPage('userProfile')" :class="{'font-bold text-green-700': current==='userProfile'}" class="bg-green-600 text-white text-xs rounded-full px-3 py-1 select-none hover:bg-green-700 flex items-center">
                                <i class="fas fa-user-circle mr-1"></i> {{ userNameDisplay }}
                            </a>
                        </template>

                        <!-- Transporter Menu -->
                        <template v-if="role==='transporter'">
                            <a href="#" @click.prevent="switchPage('transporterDashboard')" :class="{'font-bold text-orange-700': current==='transporterDashboard'}" class="hover:text-orange-600">Dashboard</a>
                            <a href="#" @click.prevent="switchPage('transporterJobs')" :class="{'font-bold text-orange-700': current==='transporterJobs'}" class="hover:text-orange-600">Available Jobs</a>
                            <a href="#" @click.prevent="switchPage('transporterProfile')" :class="{'font-bold text-orange-700': current==='transporterProfile'}" class="hover:text-orange-600">My Profile</a>
                            <a href="#" @click.prevent="switchPage('transporterEarnings')" :class="{'font-bold text-orange-700': current==='transporterEarnings'}" class="hover:text-orange-600">Earnings</a>
                        </template>

                        <!-- Logout Button -->
                        <button @click="logout" class="text-gray-500 hover:text-red-600 text-xs px-2 py-1 rounded border border-gray-300 hover:border-red-400">
                            <i class="fas fa-sign-out-alt mr-1"></i>Logout
                        </button>
                    </template>
                </nav>
                <button class="md:hidden text-gray-500 focus:outline-none" @click="showMobileMenu = !showMobileMenu">
                    <i class="fas fa-bars text-2xl"></i>
                </button>
            </div>
            <!-- Mobile Dropdown -->
            <div v-show="showMobileMenu" class="md:hidden bg-white border-t z-40">
                <div class="py-2 flex flex-col space-y-1 px-4">

                    <a href="#" @click.prevent="switchPage('messaging');showMobileMenu=false" :class="{'font-bold text-green-700': current==='messaging'}" class="flex items-center">
                        <i class="fas fa-comments mr-1"></i>Messages
                        <span v-if="unreadMessageCount > 0" class="mobile-notification-badge">{{ unreadMessageCount }}</span>
                    </a>
                    <!-- Farmer Menu -->
                    <template v-if="isAuthenticated && role==='farmer'">
                        <a href="#" @click.prevent="switchPage('farmerPestiVid');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerPestiVid'}">PestiVid</a>
                        <a href="#" @click.prevent="switchPage('farmerAgriStream');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerAgriStream'}">AgriStream</a>
                        <a href="#" @click.prevent="switchPage('farmerSell');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerSell'}">Sell</a>
                        <a href="#" @click.prevent="switchPage('farmerFunding');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerFunding'}">Get Funding</a>
                        <a href="#" @click.prevent="switchPage('farmerTransport');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerTransport'}">Transport</a>
                        <a href="#" @click.prevent="switchPage('plantAnalysis');showMobileMenu=false" :class="{'font-bold text-green-700': current==='plantAnalysis'}">Plant Analysis</a>
                        <a href="#" @click.prevent="switchPage('farmerChatbot');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerChatbot'}"><i class="fas fa-robot mr-1"></i>AgriBot</a>
                        <a href="#" @click.prevent="switchPage('messaging');showMobileMenu=false" :class="{'font-bold text-green-700': current==='messaging'}" class="flex items-center">
                            <i class="fas fa-comments mr-1"></i>Messages
                            <span v-if="unreadMessageCount > 0" class="mobile-notification-badge">{{ unreadMessageCount }}</span>
                        </a>

                        <!-- Wallet Connection for Farmer Mobile -->
                        <template v-if="!walletConnected">
                            <button @click="connectWallet;showMobileMenu=false" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded font-medium transition-colors text-left">
                                <i class="fas fa-wallet mr-2"></i>Connect Wallet
                            </button>
                        </template>
                        <template v-if="walletConnected">
                            <div class="flex items-center justify-between py-2">
                                <div class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">
                                    <i class="fas fa-circle text-green-500 mr-1" style="font-size: 6px;"></i>{{ walletType || 'Connected' }}
                                </div>
                                <button @click="disconnectWallet;showMobileMenu=false" class="text-gray-500 hover:text-red-600 text-sm" title="Disconnect Wallet">
                                    <i class="fas fa-times"></i> Disconnect
                                </button>
                            </div>
                        </template>

                        <!-- Profile for Farmer Mobile -->
                        <a href="#" @click.prevent="switchPage('userProfile');showMobileMenu=false" :class="{'font-bold text-green-700': current==='userProfile'}" class="bg-green-600 text-white px-3 py-2 rounded select-none hover:bg-green-700 flex items-center">
                            <i class="fas fa-user-circle mr-2"></i> {{ userNameDisplay }}
                        </a>
                    </template>
                    <!-- Buyer Menu -->
                    <template v-if="role==='buyer'">
                        <a href="#" @click.prevent="switchPage('buyerAgriSell');showMobileMenu=false" :class="{'font-bold text-green-700': current==='buyerAgriSell'}">AgriSell</a>
                        <a href="#" @click.prevent="switchPage('buyerTransport');showMobileMenu=false" :class="{'font-bold text-green-700': current==='buyerTransport'}">Transport</a>
                        <a href="#" @click.prevent="switchPage('messaging');showMobileMenu=false" :class="{'font-bold text-green-700': current==='messaging'}" class="flex items-center">
                            <i class="fas fa-comments mr-1"></i>Messages
                            <span v-if="unreadMessageCount > 0" class="mobile-notification-badge">{{ unreadMessageCount }}</span>
                        </a>
                        <a href="#" @click.prevent="switchPage('userProfile');showMobileMenu=false" :class="{'font-bold text-green-700': current==='userProfile'}" class="bg-green-600 text-white px-3 py-2 rounded select-none hover:bg-green-700 flex items-center">
                            <i class="fas fa-user-circle mr-2"></i> {{ userNameDisplay }}
                        </a>
                    </template>
                    <!-- Investor Menu -->
                    <template v-if="role==='investor'">
                        <a href="#" @click.prevent="switchPage('investorProjects');showMobileMenu=false" :class="{'font-bold text-green-700': current==='investorProjects'}">Projects</a>
                        <a href="#" @click.prevent="switchPage('investorPortfolio');showMobileMenu=false" :class="{'font-bold text-green-700': current==='investorPortfolio'}">Portfolio</a>
                        <a href="#" @click.prevent="switchPage('investorTransport');showMobileMenu=false" :class="{'font-bold text-green-700': current==='investorTransport'}">Transport</a>
                        <a href="#" @click.prevent="switchPage('messaging');showMobileMenu=false" :class="{'font-bold text-green-700': current==='messaging'}" class="flex items-center">
                            <i class="fas fa-comments mr-1"></i>Messages
                            <span v-if="unreadMessageCount > 0" class="mobile-notification-badge">{{ unreadMessageCount }}</span>
                        </a>
                        <a href="#" @click.prevent="switchPage('userProfile');showMobileMenu=false" :class="{'font-bold text-green-700': current==='userProfile'}" class="bg-green-600 text-white px-3 py-2 rounded select-none hover:bg-green-700 flex items-center">
                            <i class="fas fa-user-circle mr-2"></i> {{ userNameDisplay }}
                        </a>
                    </template>

                    <!-- Transporter Menu -->
                    <template v-if="role==='transporter'">
                        <a href="#" @click.prevent="switchPage('transporterDashboard');showMobileMenu=false" :class="{'font-bold text-orange-700': current==='transporterDashboard'}">Dashboard</a>
                        <a href="#" @click.prevent="switchPage('transporterJobs');showMobileMenu=false" :class="{'font-bold text-orange-700': current==='transporterJobs'}">Available Jobs</a>
                        <a href="#" @click.prevent="switchPage('transporterProfile');showMobileMenu=false" :class="{'font-bold text-orange-700': current==='transporterProfile'}">My Profile</a>
                        <a href="#" @click.prevent="switchPage('transporterEarnings');showMobileMenu=false" :class="{'font-bold text-orange-700': current==='transporterEarnings'}">Earnings</a>
                    </template>
                    <div class="border-t mt-2 pt-2 flex justify-end items-center">
                        <!-- Logout Button Mobile -->
                        <button @click="logout(); showMobileMenu=false;" class="text-red-500 hover:text-red-700 text-xs px-2 py-1 rounded border border-red-300 hover:bg-red-50">
                            <i class="fas fa-sign-out-alt mr-1"></i>Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content (Shown if authenticated) -->
        <main class="flex-1 max-w-7xl mx-auto w-full px-4 pt-8 pb-8">
            <!-- This div wraps all conditional page sections -->
            <div>
                <!-- Login Page -->
                <section v-if="current==='login'" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-50 to-blue-50 py-12 px-4 sm:px-6 lg:px-8">
                    <div class="max-w-md w-full space-y-8">
                        <div class="text-center">
                            <div class="flex justify-center mb-6">
                                <div class="bg-green-600 p-3 rounded-full">
                                    <i class="fas fa-seedling text-white text-2xl"></i>
                                </div>
                            </div>
                            <h2 class="text-3xl font-bold text-gray-900 mb-2">Welcome Back</h2>
                            <p class="text-gray-600">Sign in to your PestVid account</p>
                        </div>

                        <div class="bg-white rounded-2xl shadow-xl p-8">
                            <form @submit.prevent="login" class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                                    <input v-model="loginForm.email" type="email" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors"
                                           placeholder="Enter your email">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                    <input v-model="loginForm.password" type="password" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors"
                                           placeholder="Enter your password">
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <input v-model="loginForm.remember" type="checkbox" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                                        <label class="ml-2 block text-sm text-gray-700">Remember me</label>
                                    </div>
                                    <a href="#" class="text-sm text-green-600 hover:text-green-500">Forgot password?</a>
                                </div>
                                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-medium transition-colors">
                                    <i class="fas fa-sign-in-alt mr-2"></i>Sign In
                                </button>
                            </form>



                            <div class="mt-8 text-center">
                                <p class="text-gray-600">Don't have an account?
                                    <a href="#" @click.prevent="switchPage('signup')" class="text-green-600 hover:text-green-500 font-medium">Sign up here</a>
                                </p>
                            </div>

                            <div class="mt-6 text-center">
                                <a href="#" @click.prevent="switchPage('landing')" class="text-gray-500 hover:text-gray-700 text-sm">
                                    <i class="fas fa-arrow-left mr-1"></i>Back to Home
                                </a>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Signup Page -->
                <section v-if="current==='signup'" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-50 to-blue-50 py-12 px-4 sm:px-6 lg:px-8">
                    <div class="max-w-md w-full space-y-8">
                        <div class="text-center">
                            <div class="flex justify-center mb-6">
                                <div class="bg-green-600 p-3 rounded-full">
                                    <i class="fas fa-user-plus text-white text-2xl"></i>
                                </div>
                            </div>
                            <h2 class="text-3xl font-bold text-gray-900 mb-2">Join PestVid</h2>
                            <p class="text-gray-600">Create your account to get started</p>
                        </div>

                        <div class="bg-white rounded-2xl shadow-xl p-8">
                            <form @submit.prevent="signup" class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                                    <input v-model="signupForm.name" type="text" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors"
                                           placeholder="Enter your full name">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                                    <input v-model="signupForm.email" type="email" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors"
                                           placeholder="Enter your email">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                                    <input v-model="signupForm.phone" type="tel" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors"
                                           placeholder="Enter your phone number">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                                    <select v-model="signupForm.role" required
                                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white transition-colors">
                                        <option value="">Select your role</option>
                                        <option value="farmer">Farmer</option>
                                        <option value="buyer">Buyer</option>
                                        <option value="investor">Investor</option>
                                        <option value="transporter">Transporter</option>
                                    </select>
                                </div>

                                <!-- Info for Farmers -->
                                <div v-if="signupForm.role === 'farmer'" class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <div class="flex items-center">
                                        <div class="bg-blue-100 p-2 rounded-full mr-3">
                                            <i class="fas fa-info-circle text-blue-600"></i>
                                        </div>
                                        <div>
                                            <h4 class="text-sm font-medium text-blue-900">Farmer Account</h4>
                                            <p class="text-xs text-blue-700 mt-1">You'll need to connect a MetaMask wallet when accessing farmer features to receive AVAX payments</p>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                    <input v-model="signupForm.password" type="password" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors"
                                           placeholder="Create a password">
                                    <p class="text-xs text-gray-500 mt-1">At least 6 characters</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Confirm Password</label>
                                    <input v-model="signupForm.confirmPassword" type="password" required
                                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors"
                                           placeholder="Confirm your password">
                                </div>
                                <div class="flex items-center">
                                    <input v-model="signupForm.acceptTerms" type="checkbox" required class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                                    <label class="ml-2 block text-sm text-gray-700">
                                        I agree to the <a href="#" class="text-green-600 hover:text-green-500">Terms and Conditions</a>
                                    </label>
                                </div>
                                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg font-medium transition-colors">
                                    <i class="fas fa-user-plus mr-2"></i>Create Account
                                </button>
                            </form>



                            <div class="mt-8 text-center">
                                <p class="text-gray-600">Already have an account?
                                    <a href="#" @click.prevent="switchPage('login')" class="text-green-600 hover:text-green-500 font-medium">Sign in here</a>
                                </p>
                            </div>

                            <div class="mt-6 text-center">
                                <a href="#" @click.prevent="switchPage('landing')" class="text-gray-500 hover:text-gray-700 text-sm">
                                    <i class="fas fa-arrow-left mr-1"></i>Back to Home
                                </a>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Landing Section -->
                <section v-if="current==='landing'">
                    <div class="flex flex-col md:flex-row items-center mb-12 pt-2">
                        <div class="md:w-1/2 md:pr-8">
                        <h1 class="text-4xl font-bold text-green-800 mb-4">PestiVid: Blockchain Transparency in Agriculture</h1>
                        <p class="mb-5 text-gray-800 text-lg leading-relaxed">A secure, video-verified agricultural marketplace with investment opportunities. Farmers prove quality and safety via field recordings stored on decentralized storage (IPFS via Pinata) and linked via a simulated blockchain. Buyers purchase crops with complete confidence and traceability. Investors fund projects with transparent returns.</p>
                        <ul class="text-gray-700 mb-7 space-y-1 text-base">
                            <li><i class="fas fa-link text-green-500 mr-2"></i>Avalanche blockchain transactions with MetaMask</li>
                            <li><i class="fas fa-cloud-upload-alt text-green-400 mr-2"></i>Decentralized video storage (IPFS via Pinata)</li>
                            <li><i class="fas fa-search-dollar text-green-400 mr-2"></i>Full traceability for buyers</li>
                            <li><i class="fas fa-handshake text-green-500 mr-2"></i>Direct, transparent marketplace transactions</li>
                            <li><i class="fas fa-chart-line text-green-500 mr-2"></i>Investment opportunities for funders</li>
                            <li><i class="fas fa-comments text-green-500 mr-2"></i>Secure messaging between users</li>
                            <li><i class="fas fa-bell text-green-500 mr-2"></i>Real-time notifications</li>
                        </ul>
                        <div class="mt-4 space-x-2" v-if="!isAuthenticated">
                            <button class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded transition" @click="switchPage('signup')">
                                <i class="fas fa-user-plus mr-2"></i>Get Started
                            </button>
                            <button class="bg-white border border-green-600 text-green-600 px-6 py-2 rounded transition" @click="switchPage('login')">
                                <i class="fas fa-sign-in-alt mr-2"></i>Sign In
                            </button>
                        </div>
                        <div class="mt-4 space-x-2" v-if="isAuthenticated">
                            <button class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded transition" @click="switchPage('buyerAgriSell')">
                                <i class="fas fa-store mr-2"></i>Browse Marketplace
                            </button>
                            <button class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded transition" @click="switchToUserDashboard">
                                <i class="fas fa-tachometer-alt mr-2"></i>Go to Dashboard
                            </button>
                        </div>
                        </div>
                        <div class="md:w-1/2 mt-10 md:mt-0 flex flex-col items-center">
                        <div class="w-full max-w-md mx-auto">
                            <iframe
                                src="https://www.youtube.com/embed/CfMEYWrdi3M"
                                title="PestiVid Demo Video"
                                frameborder="0"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                allowfullscreen
                                class="rounded-lg shadow-md border w-full h-64">
                            </iframe>
                        </div>
                        </div>
                    </div>
                    <div class="mt-10">
                        <h2 class="text-2xl text-green-700 font-semibold mb-3">How It Works</h2>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-5">
                        <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
                            <i class="fas fa-video text-2xl text-green-500 mb-3"></i>
                            <span class="font-bold mb-1">1. Video Recording</span>
                            <p class="text-sm text-gray-600 text-center">Farmers film direct evidence of their crop and practices.</p>
                        </div>
                        <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
                            <i class="fas fa-cloud-upload-alt text-2xl text-green-500 mb-3"></i>
                            <span class="font-bold mb-1">2. Upload to IPFS</span>
                            <p class="text-sm text-gray-600 text-center">Videos & info are securely uploaded and stored decentrally.</p>
                        </div>
                        <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
                            <i class="fas fa-search-dollar text-2xl text-green-500 mb-3"></i>
                            <span class="font-bold mb-1">3. Verification</span>
                            <p class="text-sm text-gray-600 text-center">Buyers view blockchain-linked video before any purchase.</p>
                        </div>
                        <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
                            <i class="fas fa-handshake text-2xl text-green-500 mb-3"></i>
                            <span class="font-bold mb-1">4. Marketplace</span>
                            <p class="text-sm text-gray-600 text-center">Login provides access to buying, selling, or investing.</p>
                        </div>
                        </div>
                    </div>

                    <div class="mt-16 bg-green-50 rounded-lg p-8">
                        <h2 class="text-2xl text-green-700 font-semibold mb-3">Agricultural Investment Platform</h2>
                        <div class="flex flex-col md:flex-row items-center">
                        <div class="w-full">
                            <p class="mb-4 text-gray-700">Invest in verified agricultural projects with full transparency. Track your investments through Avalanche blockchain technology and share in the harvest profits.</p>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 my-6">
                            <div class="bg-white rounded p-4 shadow-sm">
                                <i class="fas fa-seedling text-green-600 text-2xl mb-2"></i>
                                <h3 class="font-bold mb-1">Fund Crops</h3>
                                <p class="text-sm">Invest in specific crops with transparent land use and practices.</p>
                            </div>
                            <div class="bg-white rounded p-4 shadow-sm">
                                <i class="fas fa-coins text-green-600 text-2xl mb-2"></i>
                                <h3 class="font-bold mb-1">Share Returns</h3>
                                <p class="text-sm">Receive dividends based on harvest yields and market prices.</p>
                            </div>
                            <div class="bg-white rounded p-4 shadow-sm">
                                <i class="fas fa-shield-alt text-green-600 text-2xl mb-2"></i>
                                <h3 class="font-bold mb-1">Secure Blockchain</h3>
                                <p class="text-sm">All investments and harvests recorded on immutable ledger (Simulated).</p>
                            </div>
                            </div>
                            <button class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded transition mt-2" @click="switchPage('investorProjects')">Become an Investor</button>
                        </div>
                        </div>
                    </div>
                </section>

                <!-- Farmer PestiVid Section -->
                <section v-if="current==='farmerPestiVid'" class="max-w-3xl mx-auto mt-6">
                <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-video mr-2"></i>PestiVid: Record Crop Video</h2>

                <!-- Wallet Connection Info for Farmers -->
                <div v-if="!walletConnected" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4" role="alert">
                    <div class="flex items-center">
                        <div class="bg-blue-100 p-2 rounded-full mr-3">
                            <i class="fas fa-info-circle text-blue-600"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-sm font-medium text-blue-900">Wallet Connection Optional</h4>
                            <p class="text-xs text-blue-700 mt-1">You can record and upload videos without a wallet. Connect your wallet later when you want to sell crops or receive payments.</p>
                        </div>
                        <button @click="connectWallet" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded text-sm ml-3">
                            <i class="fas fa-wallet mr-1"></i>Connect Wallet
                        </button>
                    </div>
                </div>

                <div v-if="walletConnected" class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-4" role="alert">
                    <p class="font-bold">✅ Real-time Avalanche Wallet Connected</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm mt-2">
                        <div><strong>Address:</strong> {{ formatWalletAddress(walletAddress) }}</div>
                        <div><strong>Balance:</strong> {{ walletBalance }} AVAX</div>
                        <div><strong>Network:</strong> {{ walletNetworkName || 'Avalanche' }}</div>
                        <div><strong>Status:</strong> {{ realTimeMonitoring ? '🔄 Live Monitoring' : '⏸️ Static' }}</div>
                        <div v-if="lastBalanceUpdate"><strong>Last Update:</strong> {{ formatTimestamp(lastBalanceUpdate, true) }}</div>
                        <div v-if="pendingTransactions.length > 0"><strong>Pending:</strong> {{ pendingTransactions.length }} transactions</div>
                    </div>
                </div>

                <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4" role="alert" v-if="pinataJwt === 'YOUR_PINATA_JWT_MUST_BE_REPLACED_HERE'">
                    <p class="font-bold">Configuration Needed:</p>
                    <p class="text-sm">A valid Pinata JWT is required for video uploads to IPFS. The current JWT is a placeholder. Please update it in the script.</p>
                </div>
                <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4" role="alert">
                    <p class="font-bold">User: {{ currentUser ? currentUser.name : 'Farmer' }} (Role: Farmer)</p>
                    <p class="text-sm">You are logged in as a Farmer. You can upload videos and manage farmer features.</p>
                </div>
                <!-- Recording Interface - Always Available -->
                <div class="bg-white rounded shadow-md p-6 space-y-6">
                    <form @submit.prevent>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div> <label class="block text-gray-600 mb-1 text-sm">Crop Type</label> <input v-model="recordForm.crop" class="w-full px-2 py-2 border rounded text-sm" required placeholder="e.g., Tomatoes"> </div>
                        <div> <label class="block text-gray-600 mb-1 text-sm">Field Location</label> <input v-model="recordForm.location" class="w-full px-2 py-2 border rounded text-sm" required placeholder="e.g., South Field"> </div>
                        <div> <label class="block text-gray-600 mb-1 text-sm">Pesticide Used</label> <input v-model="recordForm.pesticide" class="w-full px-2 py-2 border rounded text-sm" required placeholder="e.g., Neem Oil"> </div>
                        <div> <label class="block text-gray-600 mb-1 text-sm">Pesticide Company</label> <input v-model="recordForm.pesticideCompany" class="w-full px-2 py-2 border rounded text-sm" required placeholder="e.g., AgriChem"> </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-600 mb-1 text-sm">Purpose of this Video:</label>
                        <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-2 sm:space-y-0">
                            <label class="flex items-center"> <input type="radio" v-model="recordForm.purpose" value="agristream" class="form-radio text-green-600"> <span class="ml-2 text-sm text-gray-700">For AgriStream (General)</span> </label>
                            <label class="flex items-center"> <input type="radio" v-model="recordForm.purpose" value="sell" class="form-radio text-green-600"> <span class="ml-2 text-sm text-gray-700">To List for Sale</span> </label>
                            <label class="flex items-center"> <input type="radio" v-model="recordForm.purpose" value="funding" class="form-radio text-green-600"> <span class="ml-2 text-sm text-gray-700">For Funding Request</span> </label>
                        </div>
                    </div>
                    </form>
                    <div>
                    <div class="aspect-w-16 aspect-h-9 bg-black rounded mb-3 relative" style="min-height:200px">
                        <video ref="liveVideo" v-show="showLive" class="w-full h-full rounded absolute inset-0 object-cover" autoplay muted playsinline webkit-playsinline style="background:#111"></video>
                        <video v-if="recordBlobUrl" :src="recordBlobUrl" controls playsinline webkit-playsinline class="w-full h-full rounded absolute inset-0 object-cover" style="background:#181818"></video>
                        <div v-if="!showLive && !recordBlobUrl" class="absolute inset-0 flex justify-center items-center h-full text-gray-400"><i class="fas fa-video-slash fa-2x"></i></div>
                    </div>
                    <div class="flex flex-wrap gap-3 mb-2 items-center">
                        <button type="button" :disabled="recording" @click="startVideo" :class="{'opacity-50 cursor-not-allowed': recording}" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">
                        <i :class="recording ? 'fas fa-spinner fa-spin' : (recordBlobUrl ? 'fas fa-redo' : 'fas fa-record-vinyl')" class="mr-1"></i>
                        {{ recordBlobUrl ? 'Re-Record' : (recording ? 'Starting...' : 'Start Recording') }}
                        </button>
                        <button v-if="recording" type="button" @click="stopVideo" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-sm"> <i class="fas fa-stop mr-1"></i>Stop </button>
                        <button v-if="recordBlobUrl && !uploading" type="button" @click="uploadVideo" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm"> <i class="fas fa-upload mr-1"></i>Upload to IPFS </button>
                        <div v-if="uploading && !showLoadingModal" class="flex items-center text-blue-600 text-sm ml-3"> <i class="fas fa-spinner fa-spin mr-2"></i> Uploading... Please wait. </div>
                    </div>
                    <p class="text-xs mt-2 text-gray-500">Allow camera access. Video file is stored locally until upload.</p>
                    <div v-if="uploadCid" class="text-green-600 mt-3 bg-green-50 p-3 rounded border border-green-200 text-sm">
                        <div class="flex items-center mb-2"> <i class="fas fa-check-circle mr-2"></i> Uploaded to IPFS! CID: <span class="font-mono bg-green-100 px-1 py-0.5 rounded break-all ml-1">{{ uploadCid }}</span> </div>
                        <div v-if="lastUploadedVideoFileHash" class="flex items-center mb-2 text-xs"> <i class="fas fa-fingerprint mr-2 text-gray-500"></i> Video File Hash (SHA256): <span class="font-mono bg-green-100 px-1 py-0.5 rounded break-all ml-1 text-gray-700">{{ lastUploadedVideoFileHash }}</span> </div>
                        <p v-if="lastUploadedVideoPurpose === 'agristream'" class="mt-1 text-gray-700"> This video is now available in your AgriStream. <a href="#" @click.prevent="navigateToPageWithParam('farmerAgriStream', 'highlightCid', uploadCid)" class="text-blue-700 underline font-medium hover:text-blue-800 ml-1">View in AgriStream</a>. <br>You can also use it later to: <a href="#" @click.prevent="goToListing(uploadCid)" class="text-green-700 underline font-medium hover:text-green-800">Create a Listing</a>, or <a href="#" @click.prevent="navigateToPageWithParam('farmerFunding', 'cid', uploadCid)" class="text-purple-700 underline font-medium hover:text-purple-800 ml-1">Use for Funding Request</a>. </p>
                        <p v-if="lastUploadedVideoPurpose === 'sell'" class="mt-1 text-gray-700"> Video uploaded for selling! You should be redirected to create a listing. If not, <a href="#" @click.prevent="navigateToPageWithParam('farmerSell', 'cid', uploadCid)" class="text-green-700 underline font-medium hover:text-green-800">click here to complete the listing</a>. </p>
                        <p v-if="lastUploadedVideoPurpose === 'funding'" class="mt-1 text-gray-700"> Video uploaded for a funding request! You should be redirected to create the request. If not, <a href="#" @click.prevent="navigateToPageWithParam('farmerFunding', 'cid', uploadCid)" class="text-purple-700 underline font-medium hover:text-purple-800">click here to complete the funding request</a>. </p>
                    </div>
                    <div v-if="uploadError" class="text-red-600 mt-3 bg-red-50 p-2 rounded border border-red-200 text-sm"> <i class="fas fa-exclamation-triangle mr-1"></i> {{ uploadError }} </div>
                    </div>
                </div>
                </section>
                <!-- Farmer AgriStream Section -->
                <section v-if="current==='farmerAgriStream'" class="max-w-4xl mx-auto mt-6">
                    <h2 class="text-2xl font-bold text-green-700 mb-5"><i class="fas fa-stream mr-2"></i>AgriStream: My Crop Videos</h2>
                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4" role="alert">
                        <p class="font-bold">User: {{ currentUser ? currentUser.name : 'Farmer' }} (Role: Farmer)</p>
                        <p class="text-sm">Viewing videos uploaded by you. Demo videos from other sample users may also appear if they exist in the shared data.</p>
                    </div>
                    <div class="bg-white rounded shadow-md p-6">
                        <div v-if="farmerVideos.length===0" class="text-gray-600 text-center p-6 bg-gray-50 rounded"> <i class="fas fa-film text-4xl text-gray-400 mb-3"></i><br> No uploads yet. Go to <a href="#" class="text-green-700 underline" @click.prevent="switchPage('farmerPestiVid')">PestiVid</a> to upload. </div>
                        <div v-else class="space-y-6">
                        <div v-for="vid in farmerVideos" :key="vid.cid + '-' + vid.farmerWallet" class="flex flex-col md:flex-row items-start border-b last:border-b-0 pb-6 gap-6 transition-all duration-500" :ref="'videoCard-' + vid.cid" :class="{'bg-yellow-50 border-l-4 border-yellow-400 shadow-lg transform scale-102': vid.cid === highlightedAgriStreamVideoCid}">
                            <div class="w-full md:w-60 flex-shrink-0">
                                <video :src="getVideoUrl(vid.cid, vid.storageType)"
                                       controls
                                       playsinline
                                       webkit-playsinline
                                       crossorigin="anonymous"
                                       preload="metadata"
                                       class="rounded shadow w-full bg-black"
                                       @error="handleVideoError"
                                       @loadstart="handleVideoLoadStart"
                                       @canplay="handleVideoCanPlay">
                                    <source :src="getVideoUrl(vid.cid, vid.storageType)" type="video/mp4">
                                    <source :src="getVideoUrl(vid.cid, vid.storageType)" type="video/webm">
                                    Your browser does not support the video tag.
                                </video>
                            </div>
                            <div class="flex-1">
                            <div class="font-bold text-lg">{{ vid.crop }}</div>
                            <div class="text-xs mb-1" :class="{ 'text-blue-700': vid.purpose === 'sell', 'text-purple-700': vid.purpose === 'funding', 'text-gray-600': vid.purpose === 'agristream' || !vid.purpose }"> Intended for: <span class="font-semibold"> {{ vid.purpose === 'sell' ? 'Listing for Sale' : (vid.purpose === 'funding' ? 'Funding Request' : (vid.purpose === 'agristream' ? 'AgriStream (General)' : 'N/A')) }} </span> </div>
                            <div class="text-sm mb-1">Location: <span class="font-mono text-gray-700">{{ vid.location }}</span></div>
                            <div class="text-sm mb-1">Pesticide: <span class="font-mono text-gray-700">{{ vid.pesticide }}</span></div>
                            <div class="text-sm mb-1">Pesticide Co.: <span class="font-mono text-gray-700">{{ vid.pesticideCompany || 'N/A' }}</span></div>
                            <div class="text-xs text-gray-500 mb-2">CID: <span class="font-mono break-all">{{ vid.cid }}</span></div>
                            <div class="text-xs text-gray-400 mb-1">File Hash (SHA256): <span class="font-mono break-all" :title="vid.videoFileHash || 'N/A'">{{ vid.videoFileHash ? vid.videoFileHash.substring(0,10) + '...' : 'N/A' }}</span></div>
                            <a :href="getVideoUrl(vid.cid, vid.storageType)" target="_blank" class="text-blue-600 hover:underline text-xs mr-3"><i class="fas fa-external-link-alt mr-1"></i>View {{ vid.storageType === 'ipfs' ? 'on IPFS Gateway' : 'on Gateway' }}</a>
                            <button v-if="!isListed(vid.cid) && vid.farmerWallet === currentUserIdentifier" @click="goToListing(vid.cid)" class="text-green-600 hover:underline text-xs"> <i class="fas fa-tags mr-1"></i> {{ (vid.purpose === 'sell' && !isListed(vid.cid)) ? 'Complete Listing' : 'Create Listing' }} </button>
                            <span v-else-if="isListed(vid.cid) && vid.farmerWallet === currentUserIdentifier" class="text-gray-500 text-xs"><i class="fas fa-check mr-1"></i>Already Listed</span>
                            <button v-if="!isUsedInFunding(vid.cid) && (vid.purpose === 'funding' || vid.purpose === 'agristream') && vid.farmerWallet === currentUserIdentifier" @click="navigateToPageWithParam('farmerFunding', 'cid', vid.cid)" class="text-purple-600 hover:underline text-xs ml-2"> <i class="fas fa-hand-holding-usd mr-1"></i> {{ (vid.purpose === 'funding' && !isUsedInFunding(vid.cid)) ? 'Complete Funding Request' : 'Use for Funding' }} </button>
                            <span v-if="isUsedInFunding(vid.cid) && vid.farmerWallet === currentUserIdentifier" class="text-gray-500 text-xs ml-2"><i class="fas fa-check mr-1"></i>Used for Funding</span>
                            </div>
                        </div>
                        </div>
                    </div>
                </section>
                <!-- Farmer Sell Section -->
                <section v-if="current==='farmerSell'" class="max-w-2xl mx-auto mt-6">
                    <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-tags mr-2"></i>Sell Farm Crop on Marketplace</h2>

                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4" role="alert">
                        <p class="font-bold">User: {{ currentUser ? currentUser.name : 'Farmer' }} (Role: Farmer)</p>
                        <p class="text-sm">Create and manage listings for your own uploaded videos. Connect wallet when ready to receive payments.</p>
                    </div>
                    <div class="bg-white rounded shadow-md p-6">
                        <form @submit.prevent="createListing">
                        <div class="mb-4">
                            <label class="block text-gray-600 mb-1">Select Uploaded Video (Unlisted only)</label>
                            <select v-model="listingForm.cid" class="w-full px-3 py-2 border rounded bg-white mb-2" required>
                            <option value="" disabled>Select video...</option>
                            <option v-for="vid in availableVideosForListing" :key="vid.cid" :value="vid.cid"> {{ vid.crop }} ({{ vid.location }}) - Pest: {{ vid.pesticide }} by {{ vid.pesticideCompany || 'N/A' }} ({{vid.storageType || 'ipfs'}}) </option>
                            <option v-if="availableVideosForListing.length === 0" disabled>No unlisted videos available</option>
                            </select>
                            <p v-if="farmerVideos.length === 0" class="text-xs text-red-500">You need to upload a video first via PestiVid.</p>
                            <p v-if="farmerVideos.length > 0 && availableVideosForListing.length === 0" class="text-xs text-yellow-600">All your eligible videos are already listed or not marked for sale.</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">
                            <div> <label class="block text-gray-600 mb-1">Min Price (AVAX)</label> <input type="number" v-model="listingForm.minPrice" class="w-full px-3 py-2 border rounded" min="0.0001" step="0.0001" required placeholder="e.g., 0.0001"> </div>
                            <div> <label class="block text-gray-600 mb-1">Max Price (AVAX)</label> <input type="number" v-model="listingForm.maxPrice" class="w-full px-3 py-2 border rounded" :min="listingForm.minPrice || 0.0001" step="0.0001" required placeholder="e.g., 10.0"> </div>
                        </div>
                        <div class="mb-4"> <label class="flex items-center"> <input type="checkbox" v-model="listingForm.notifyBuyers" class="form-checkbox h-4 w-4 text-green-600"> <span class="ml-2 text-sm text-gray-700">Notify potential buyers about this listing</span> </label> </div>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded w-full" :disabled="!listingForm.cid"> <i class="fas fa-plus-circle mr-1"></i>Create Listing </button>
                        </form>
                        <div v-if="createdListingId" class="bg-green-100 text-green-700 px-4 py-3 mt-4 rounded font-medium text-sm"> <i class="fas fa-check mr-1"></i> Listing created successfully! Listing ID/Tx: <span class="font-mono text-xs">{{ createdListingId.substring(0,10) }}...</span> <div v-if="listingNotificationSent" class="mt-1 text-sm"> <i class="fas fa-bell mr-1"></i> Buyers have been notified about your new listing. </div> </div>
                        <div class="mt-8">
                        <h3 class="font-semibold mb-2 text-gray-700">Your Active Listings</h3>
                        <div v-if="farmerListings.length===0" class="text-gray-600 text-sm bg-gray-50 p-4 rounded text-center">You have no active listings.</div>
                        <ul v-else class="space-y-3">
                            <li v-for="l in farmerListings" :key="l._id" class="py-3 px-4 border rounded flex flex-col sm:flex-row justify-between sm:items-center text-sm bg-white shadow-sm">
                            <div> <span class="font-medium">{{ l.crop }}</span> <span class="text-xs text-gray-500 ml-1"> ({{l.location}})</span> <br> <span class="text-xs text-gray-500"> CID: {{l.cid.substring(0, 8)}}... ({{l.storageType || 'ipfs'}})</span> | <span class="text-xs text-gray-500"> Pest. Co: {{ l.pesticideCompany || 'N/A' }}</span> <div v-if="l.notificationSent" class="text-xs text-green-600 mt-1"> <i class="fas fa-bell mr-1"></i> Buyers notified </div> </div>
                            <div class="mt-2 sm:mt-0 text-right"> <span>Min: <span class="font-mono font-semibold">{{ l.minPrice }}</span> AVAX</span><br> <span>Max: <span class="font-mono font-semibold">{{ l.maxPrice }}</span> AVAX</span> <button v-if="!l.notificationSent" @click="notifyBuyersAboutListing(l, true)" class="ml-2 text-xs text-blue-600 border border-blue-300 rounded px-2 py-1 hover:bg-blue-50"> <i class="fas fa-bell-slash mr-1"></i> Notify </button> </div>
                            </li>
                        </ul>
                        </div>
                    </div>
                </section>
                <!-- Farmer Funding Section -->
                <section v-if="current==='farmerFunding'" class="max-w-3xl mx-auto mt-6">
                    <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-money-bill-wave mr-2"></i>Request Funding for Your Farm</h2>

                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4" role="alert">
                        <p class="font-bold">User: {{ currentUser ? currentUser.name : 'Farmer' }} (Role: Farmer)</p>
                        <p class="text-sm">Create and manage funding requests for your own projects. Connect wallet when ready to receive investments.</p>
                    </div>
                    <div class="bg-white rounded shadow-md p-6">
                        <form @submit.prevent="createFundingRequest_V1">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div> <label class="block text-gray-600 mb-1 text-sm">Project Title</label> <input v-model="fundingForm.title" class="w-full px-3 py-2 border rounded text-sm" required placeholder="e.g., Organic Tomato Expansion"> </div>
                            <div> <label class="block text-gray-600 mb-1 text-sm">Crop Type</label> <input v-model="fundingForm.crop" class="w-full px-3 py-2 border rounded text-sm" required placeholder="e.g., Roma Tomatoes"> </div>
                            <div> <label class="block text-gray-600 mb-1 text-sm">Land Size (Acres)</label> <input type="number" v-model.number="fundingForm.acres" class="w-full px-3 py-2 border rounded text-sm" min="0.1" step="0.1" required placeholder="e.g., 5.5"> </div>
                            <div> <label class="block text-gray-600 mb-1 text-sm">Funding Required (AVAX)</label> <input type="number" v-model.number="fundingForm.amount" class="w-full px-3 py-2 border rounded text-sm" min="5" step="0.5" required placeholder="e.g., 250"> </div>
                            <div> <label class="block text-gray-600 mb-1 text-sm">Growing Method</label> <select v-model="fundingForm.method" class="w-full px-3 py-2 border rounded bg-white text-sm" required> <option value="">Select method...</option> <option value="organic">Organic</option> <option value="conventional">Conventional</option> <option value="hydroponic">Hydroponic</option> <option value="aquaponic">Aquaponic</option> <option value="regenerative">Regenerative</option> </select> </div>
                            <div> <label class="block text-gray-600 mb-1 text-sm">Expected ROI (%)</label> <input type="number" v-model.number="fundingForm.roi" class="w-full px-3 py-2 border rounded text-sm" min="1" max="100" required placeholder="e.g., 15"> </div>
                        </div>
                        <div class="mb-4"> <label class="block text-gray-600 mb-1 text-sm">Select Video Evidence</label> <select v-model="fundingForm.cid" class="w-full px-3 py-2 border rounded bg-white mb-2 text-sm" required> <option value="" disabled>Select video...</option> <option v-for="vid in availableVideosForFunding" :key="vid.cid" :value="vid.cid"> {{ vid.crop }} ({{ vid.location }}) - {{ vid.pesticideCompany || 'N/A' }} ({{vid.storageType || 'ipfs'}}) </option> <option v-if="availableVideosForFunding.length === 0" disabled>No videos suitable for funding available</option> </select> <p v-if="farmerVideos.length === 0" class="text-xs text-red-500">You need to upload a video first via PestiVid.</p> <p v-if="farmerVideos.length > 0 && availableVideosForFunding.length === 0" class="text-xs text-yellow-600">All your eligible videos are already used for funding or not marked for funding.</p> </div>
                        <div class="mb-4"> <label class="block text-gray-600 mb-1 text-sm">Project Description</label> <textarea v-model="fundingForm.description" class="w-full px-3 py-2 border rounded text-sm" rows="4" required placeholder="Describe your project, growing practices, and how funds will be used..."></textarea> </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"> <div> <label class="block text-gray-600 mb-1 text-sm">Timeline (Months)</label> <input type="number" v-model.number="fundingForm.timeline" class="w-full px-3 py-2 border rounded text-sm" min="1" max="36" required placeholder="How many months until harvest?"> </div> <div> <label class="block text-gray-600 mb-1 text-sm">Investor Share (%)</label> <input type="number" v-model.number="fundingForm.investorShare" class="w-full px-3 py-2 border rounded text-sm" min="1" max="80" required placeholder="Percentage of harvest profit for investors"> </div> </div>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded w-full" :disabled="!fundingForm.cid"> <i class="fas fa-paper-plane mr-1"></i> Create Funding Request </button>
                        </form>
                        <div v-if="createdFundingRequest" class="bg-green-100 text-green-700 px-4 py-2 mt-4 rounded font-medium text-sm"> <i class="fas fa-check mr-1"></i> Funding request created and is now visible to investors! </div>
                        <div class="mt-8">
                        <h3 class="font-semibold mb-2 text-gray-700">Your Active Funding Requests</h3>
                        <div v-if="farmerFundingRequests.length===0" class="text-gray-600 text-sm bg-gray-50 p-4 rounded text-center">You have no active funding requests.</div>
                        <div v-else class="space-y-4">
                            <div v-for="req in farmerFundingRequests" :key="req._id" class="border rounded-lg overflow-hidden shadow-sm bg-white">
                                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 bg-gray-50 border-b"> <h4 class="font-bold mb-2 sm:mb-0">{{ req.title }}</h4> <div class="flex items-center space-x-2"> <span :class="{'bg-yellow-100 text-yellow-800': req.status === 'pending', 'bg-green-100 text-green-800': req.status === 'funded', 'bg-blue-100 text-blue-800': req.status === 'partially_funded'}" class="px-2 py-1 rounded text-xs font-medium"> {{ req.status === 'pending' ? 'Pending' : req.status === 'funded' ? 'Fully Funded' : (req.status === 'partially_funded' ? 'Partially Funded' : req.status) }} </span> </div> </div>
                                <div class="p-4">
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 text-sm"> <div> <div class="text-xs text-gray-500">Crop</div> <div>{{ req.crop }}</div> </div> <div> <div class="text-xs text-gray-500">Land Size</div> <div>{{ req.acres }} acres</div> </div> <div> <div class="text-xs text-gray-500">Required</div> <div>{{ req.amount }} AVAX</div> </div> <div> <div class="text-xs text-gray-500">Investor Share</div> <div>{{ req.investorShare }}%</div> </div> </div>
                                    <div class="mb-4"> <div class="text-xs text-gray-500 mb-1">Funding Progress</div> <div class="progress-bar"> <div class="progress-fill bg-green-500" :style="{width: fundingProgressPercent(req) + '%'}"></div> </div> <div class="flex justify-between text-xs mt-1"> <span>{{ req.fundedAmount || 0 }} AVAX raised</span> <span>{{ fundingProgressPercent(req) }}% Complete</span> </div> </div>
                                    <div v-if="req.fundedAmount > 0 && req.investors && req.investors.length > 0" class="mb-4"> <div class="text-xs text-gray-500 mb-2">Investors ({{req.investors.length}})</div> <div class="text-sm max-h-24 overflow-y-auto border rounded p-2 bg-gray-50 space-y-1"> <div v-for="investor in req.investors" :key="investor.investorId || investor._id" class="flex justify-between items-center py-1 text-xs"> <span><i class="fas fa-user text-gray-400 mr-1"></i>{{ getFarmerDisplayIdentifier(investor.investorId, 6) }}</span> <span class="font-mono bg-blue-100 text-blue-800 px-1 rounded">{{ investor.amount }} AVAX</span> </div> </div> </div>
                                    <div class="flex justify-end mt-4"> <button v-if="req.status !== 'funded'" class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200" @click="cancelFundingRequest_V1(req._id)"> <i class="fas fa-times mr-1"></i>Cancel Request </button> <span v-if="req.status === 'funded'" class="text-xs text-green-600"><i class="fas fa-check-circle mr-1"></i>Fully Funded!</span> </div>
                                </div>
                            </div>
                        </div>
                        </div>
                    </div>
                </section>

                <!-- Farmer Transport Section -->
                <section v-if="current==='farmerTransport'" class="max-w-6xl mx-auto mt-6">
                    <h2 class="text-2xl font-bold text-orange-700 mb-4">
                        <i class="fas fa-truck mr-2"></i>Transport Services
                    </h2>

                    <div class="bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-4 mb-6" role="alert">
                        <p class="font-bold">User: {{ currentUser ? currentUser.name : 'Farmer' }} (Role: Farmer)</p>
                        <p class="text-sm">Request transport services for your crops. Connect with verified transporters for pickup and delivery.</p>
                    </div>

                    <!-- Transport Request Form -->
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-plus-circle mr-2 text-orange-600"></i>
                            Request Transport Service
                        </h3>

                        <form @submit.prevent="createTransportRequest" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Crop Type</label>
                                    <select v-model="transportForm.crop" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                                        <option value="">Select crop type</option>
                                        <option value="Rice">Rice</option>
                                        <option value="Wheat">Wheat</option>
                                        <option value="Corn">Corn</option>
                                        <option value="Tomatoes">Tomatoes</option>
                                        <option value="Potatoes">Potatoes</option>
                                        <option value="Onions">Onions</option>
                                        <option value="Carrots">Carrots</option>
                                        <option value="Cabbage">Cabbage</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Quantity (kg)</label>
                                    <input v-model.number="transportForm.quantity" type="number" min="1" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                                           placeholder="Enter quantity in kg">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Pickup Location</label>
                                    <input v-model="transportForm.pickupLocation" type="text" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                                           placeholder="Enter pickup address">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Delivery Location</label>
                                    <input v-model="transportForm.deliveryLocation" type="text" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                                           placeholder="Enter delivery address">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Preferred Pickup Date</label>
                                    <input v-model="transportForm.pickupDate" type="date" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Urgency Level</label>
                                    <select v-model="transportForm.urgency" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                                        <option value="">Select urgency</option>
                                        <option value="low">Low (3-5 days)</option>
                                        <option value="medium">Medium (1-2 days)</option>
                                        <option value="high">High (Same day)</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Special Instructions</label>
                                <textarea v-model="transportForm.instructions" rows="3"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                                          placeholder="Any special handling requirements or instructions..."></textarea>
                            </div>

                            <div class="flex items-center justify-between">
                                <div class="text-sm text-gray-600">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Transport costs will be shared between you and the buyer
                                </div>
                                <button type="submit" :disabled="!walletConnected"
                                        class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-md font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i class="fas fa-paper-plane mr-2"></i>
                                    Request Transport
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Active Transport Requests -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-list mr-2 text-orange-600"></i>
                            Your Transport Requests ({{ farmerTransportRequests.length }})
                        </h3>

                        <div v-if="farmerTransportRequests.length === 0" class="text-center py-8 text-gray-500">
                            <i class="fas fa-truck text-4xl mb-3"></i>
                            <p>No transport requests yet</p>
                            <p class="text-sm">Create your first transport request above</p>
                        </div>

                        <div v-else class="space-y-4">
                            <div v-for="request in farmerTransportRequests" :key="request._id"
                                 class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h4 class="font-semibold text-lg">{{ request.crop }} Transport</h4>
                                        <p class="text-sm text-gray-600">{{ request.quantity }}kg • {{ request.urgency }} priority</p>
                                    </div>
                                    <span :class="getTransportStatusClass(request.status)"
                                          class="px-3 py-1 rounded-full text-xs font-medium">
                                        {{ request.status.charAt(0).toUpperCase() + request.status.slice(1) }}
                                    </span>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3 text-sm">
                                    <div>
                                        <span class="text-gray-500">From:</span> {{ request.pickupLocation }}
                                    </div>
                                    <div>
                                        <span class="text-gray-500">To:</span> {{ request.deliveryLocation }}
                                    </div>
                                    <div>
                                        <span class="text-gray-500">Pickup Date:</span> {{ formatDate(request.pickupDate) }}
                                    </div>
                                    <div v-if="request.estimatedCost">
                                        <span class="text-gray-500">Estimated Cost:</span>
                                        <span class="font-semibold text-orange-600">{{ request.estimatedCost }} AVAX</span>
                                    </div>
                                </div>

                                <div v-if="request.transporter" class="bg-gray-50 rounded p-3 mb-3">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-medium">Assigned Transporter</p>
                                            <p class="text-sm text-gray-600">{{ request.transporter.name }}</p>
                                            <p class="text-sm text-gray-600">{{ request.transporter.vehicle }} • {{ request.transporter.phone }}</p>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-sm text-gray-500">Rating</div>
                                            <div class="text-yellow-500">
                                                <span v-for="i in 5" :key="i">
                                                    <i :class="i <= request.transporter.rating ? 'fas fa-star' : 'far fa-star'"></i>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex justify-between items-center">
                                    <div class="text-xs text-gray-500">
                                        Created: {{ formatTimestamp(request.createdAt, true) }}
                                    </div>
                                    <div class="space-x-2">
                                        <button v-if="request.status === 'pending'"
                                                @click="cancelTransportRequest(request._id)"
                                                class="text-red-600 hover:text-red-800 text-sm">
                                            <i class="fas fa-times mr-1"></i>Cancel
                                        </button>
                                        <button v-if="request.status === 'in_transit'"
                                                @click="trackTransport(request._id)"
                                                class="text-blue-600 hover:text-blue-800 text-sm">
                                            <i class="fas fa-map-marker-alt mr-1"></i>Track
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Buyer AgriSell Section -->
                <section v-if="current==='buyerAgriSell'" class="max-w-6xl mx-auto mt-6">
                    <h2 class="text-2xl font-bold text-green-700 mb-3"><i class="fas fa-shopping-basket mr-2"></i>AgriSell: Marketplace</h2>
                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4" role="alert">
                        <p class="font-bold">User: {{ currentUser ? currentUser.name : 'Buyer' }} (Role: Buyer)</p>
                        <p class="text-sm">Browse listings from farmers and simulate purchases.</p>
                    </div>
                    <div class="bg-white rounded shadow-md p-6 mb-7">
                        <div class="flex flex-col md:flex-row md:items-end gap-5">
                        <div class="w-full md:w-48"> <label class="text-gray-600 text-sm">Crop Type</label> <select v-model="buyerFilters.crop" class="w-full px-2 py-1 border rounded bg-white text-sm"> <option value="">All</option> <option v-for="c in uniqueCrops" :key="c">{{c}}</option> </select> </div>
                        <div class="flex-1"> <label class="text-gray-600 text-sm">Location</label> <input v-model="buyerFilters.location" class="w-full px-2 py-1 border rounded text-sm" placeholder="Search by location..."> </div>
                        <div class="flex-1"> <label class="text-gray-600 text-sm">Pesticide Co.</label> <input v-model="buyerFilters.pesticideCompany" class="w-full px-2 py-1 border rounded text-sm" placeholder="Search by pesticide company..."> </div>
                        <button type="button" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-1 rounded text-sm mt-2 md:mt-0" @click="resetBuyerFilters"> <i class="fas fa-undo mr-1"></i> Reset Filters </button>
                        </div>
                    </div>
                    <div v-if="filteredListings.length === 0" class="text-gray-600 bg-gray-50 p-8 text-center rounded"> <i class="fas fa-search text-4xl text-gray-400 mb-3"></i><br> No listings found matching your criteria. Try adjusting your filters. </div>
                    <div v-else class="grid gap-8 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
                        <div v-for="l in filteredListings" :key="l._id" class="bg-white rounded shadow p-4 flex flex-col relative">
                            <div v-if="l.isNew" class="new-badge">NEW</div>
                        <div class="mb-3 flex justify-center">
                            <video :src="getVideoUrl(l.cid, l.storageType || 'ipfs')"
                                   controls
                                   playsinline
                                   webkit-playsinline
                                   crossorigin="anonymous"
                                   preload="metadata"
                                   class="rounded w-full max-h-52 bg-black object-cover"
                                   @error="handleVideoError"
                                   @loadstart="handleVideoLoadStart"
                                   @canplay="handleVideoCanPlay">
                                <source :src="getVideoUrl(l.cid, l.storageType || 'ipfs')" type="video/mp4">
                                <source :src="getVideoUrl(l.cid, l.storageType || 'ipfs')" type="video/webm">
                                <!-- Fallback message removed - handled by error handler -->
                            </video>
                        </div>
                        <div class="mb-1 font-bold text-lg">{{ l.crop }}</div>
                        <div class="text-xs text-gray-500 mb-1">Location: <span class="font-mono">{{ l.location }}</span></div>
                        <div class="text-xs text-gray-500 mb-1">Pesticide: <span class="font-mono">{{ l.pesticide }}</span></div>
                        <div class="text-xs text-gray-500 mb-2">Pesticide Co.: <span class="font-mono">{{ l.pesticideCompany || 'N/A' }}</span></div>
                        <div class="text-sm my-2">Price Range: <br><span class="font-mono text-base font-semibold">{{ l.minPrice }}</span> - <span class="font-mono text-base font-semibold">{{ l.maxPrice }}</span> AVAX</div>
                        <div class="flex items-center text-xs text-gray-600 mb-2"> <span class="mr-1">Sold by: {{ getSellerDisplayIdentifier(l.farmerWallet) }}</span> <button @click="showFarmerProfile(l.farmerWallet)" class="text-blue-500 hover:text-blue-700 focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> </div>
                        <button class="mt-auto bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded text-sm" @click="buyListing(l)" :disabled="role !== 'buyer' || currentUserIdentifier === l.farmerWallet"> <i class="fas fa-shopping-cart mr-1"></i> {{ currentUserIdentifier === l.farmerWallet ? 'Your Listing' : (role === 'buyer' ? 'Initiate Purchase' : 'Switch to Buyer Role') }} </button>
                        <button @click="startOrGoToConversation(l.farmerWallet)" v-if="currentUserIdentifier !== l.farmerWallet" class="mt-2 text-xs text-blue-600 hover:text-blue-700 border border-blue-400 rounded-full px-3 py-1 hover:bg-blue-50 flex items-center justify-center"> <i class="fas fa-envelope mr-1"></i> Message Seller </button>
                        </div>
                    </div>
                </section>

                <!-- Buyer Transport Section -->
                <section v-if="current==='buyerTransport'" class="max-w-6xl mx-auto mt-6">
                    <h2 class="text-2xl font-bold text-blue-700 mb-4">
                        <i class="fas fa-truck mr-2"></i>Transport Services - Buyer Portal
                    </h2>

                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-6" role="alert">
                        <p class="font-bold">User: {{ currentUser ? currentUser.name : 'Buyer' }} (Role: Buyer)</p>
                        <p class="text-sm">Request transport for your purchased crops or coordinate delivery with farmers.</p>
                    </div>

                    <!-- Transport Request Form for Buyers -->
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-plus-circle mr-2 text-blue-600"></i>
                            Request Crop Delivery
                        </h3>

                        <form @submit.prevent="createBuyerTransportRequest" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Select Purchase</label>
                                    <select v-model="buyerTransportForm.purchaseId" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Select a purchase</option>
                                        <option v-for="purchase in buyerPurchases" :key="purchase._id" :value="purchase._id">
                                            {{ purchase.crop }} - {{ purchase.price }} SOL ({{ formatTimestamp(purchase.purchaseDate, true) }})
                                        </option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Delivery Address</label>
                                    <input v-model="buyerTransportForm.deliveryAddress" type="text" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="Enter your delivery address">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Preferred Delivery Date</label>
                                    <input v-model="buyerTransportForm.deliveryDate" type="date" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Urgency Level</label>
                                    <select v-model="buyerTransportForm.urgency" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Select urgency</option>
                                        <option value="low">Low (3-5 days)</option>
                                        <option value="medium">Medium (1-2 days)</option>
                                        <option value="high">High (Same day)</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Special Instructions</label>
                                <textarea v-model="buyerTransportForm.instructions" rows="3"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                          placeholder="Any special delivery requirements..."></textarea>
                            </div>

                            <div class="flex items-center justify-between">
                                <div class="text-sm text-gray-600">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    You will share transport costs with the farmer
                                </div>
                                <button type="submit" :disabled="!walletConnected"
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i class="fas fa-paper-plane mr-2"></i>
                                    Request Delivery
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Buyer Transport Requests -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-list mr-2 text-blue-600"></i>
                            Your Delivery Requests ({{ buyerTransportRequests.length }})
                        </h3>

                        <div v-if="buyerTransportRequests.length === 0" class="text-center py-8 text-gray-500">
                            <i class="fas fa-truck text-4xl mb-3"></i>
                            <p>No delivery requests yet</p>
                            <p class="text-sm">Request delivery for your purchased crops above</p>
                        </div>

                        <div v-else class="space-y-4">
                            <div v-for="request in buyerTransportRequests" :key="request._id"
                                 class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h4 class="font-semibold text-lg">{{ request.crop }} Delivery</h4>
                                        <p class="text-sm text-gray-600">{{ request.urgency }} priority • {{ request.estimatedCost }} SOL</p>
                                    </div>
                                    <span :class="getTransportStatusClass(request.status)"
                                          class="px-3 py-1 rounded-full text-xs font-medium">
                                        {{ request.status.charAt(0).toUpperCase() + request.status.slice(1) }}
                                    </span>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3 text-sm">
                                    <div>
                                        <span class="text-gray-500">From:</span> {{ request.pickupLocation }}
                                    </div>
                                    <div>
                                        <span class="text-gray-500">To:</span> {{ request.deliveryAddress }}
                                    </div>
                                    <div>
                                        <span class="text-gray-500">Delivery Date:</span> {{ formatDate(request.deliveryDate) }}
                                    </div>
                                    <div>
                                        <span class="text-gray-500">Your Share:</span>
                                        <span class="font-semibold text-blue-600">{{ (request.estimatedCost / 2).toFixed(4) }} SOL</span>
                                    </div>
                                </div>

                                <div v-if="request.transporter" class="bg-gray-50 rounded p-3 mb-3">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="font-medium">Assigned Transporter</p>
                                            <p class="text-sm text-gray-600">{{ request.transporter.name }}</p>
                                            <p class="text-sm text-gray-600">{{ request.transporter.vehicle }} • {{ request.transporter.phone }}</p>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-sm text-gray-500">Rating</div>
                                            <div class="text-yellow-500">
                                                <span v-for="i in 5" :key="i">
                                                    <i :class="i <= request.transporter.rating ? 'fas fa-star' : 'far fa-star'"></i>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex justify-between items-center">
                                    <div class="text-xs text-gray-500">
                                        Created: {{ formatTimestamp(request.createdAt, true) }}
                                    </div>
                                    <div class="space-x-2">
                                        <button v-if="request.status === 'pending'"
                                                @click="cancelBuyerTransportRequest(request._id)"
                                                class="text-red-600 hover:text-red-800 text-sm">
                                            <i class="fas fa-times mr-1"></i>Cancel
                                        </button>
                                        <button v-if="request.status === 'in_transit'"
                                                @click="trackTransport(request._id)"
                                                class="text-blue-600 hover:text-blue-800 text-sm">
                                            <i class="fas fa-map-marker-alt mr-1"></i>Track
                                        </button>
                                        <button v-if="request.status === 'assigned' && !request.paymentMade"
                                                @click="payTransportShare(request)"
                                                class="text-green-600 hover:text-green-800 text-sm">
                                            <i class="fas fa-credit-card mr-1"></i>Pay Share
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Join as Transporter Section -->
                    <div class="bg-gradient-to-r from-orange-50 to-yellow-50 rounded-lg shadow-md p-6 mt-6 border border-orange-200">
                        <div class="text-center">
                            <div class="mb-4">
                                <i class="fas fa-truck text-4xl text-orange-600 mb-2"></i>
                                <h3 class="text-xl font-bold text-gray-800">Become a Transport Provider</h3>
                                <p class="text-gray-600 mt-2">Join our transport network and earn by providing delivery services</p>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-sm">
                                <div class="flex items-center justify-center p-3 bg-white rounded-lg shadow-sm">
                                    <i class="fas fa-coins text-orange-600 mr-2"></i>
                                    <span>Earn SOL for deliveries</span>
                                </div>
                                <div class="flex items-center justify-center p-3 bg-white rounded-lg shadow-sm">
                                    <i class="fas fa-route text-orange-600 mr-2"></i>
                                    <span>Choose your service areas</span>
                                </div>
                                <div class="flex items-center justify-center p-3 bg-white rounded-lg shadow-sm">
                                    <i class="fas fa-star text-orange-600 mr-2"></i>
                                    <span>Build your reputation</span>
                                </div>
                            </div>

                            <button @click="redirectToTransportPortal()"
                                    class="bg-orange-600 hover:bg-orange-700 text-white px-8 py-3 rounded-lg font-semibold text-lg transition-colors duration-200 shadow-lg hover:shadow-xl">
                                <i class="fas fa-user-plus mr-2"></i>Join as Transporter
                            </button>

                            <p class="text-xs text-gray-500 mt-3">
                                Registration requires a small blockchain fee and vehicle verification
                            </p>
                        </div>
                    </div>
                </section>

                <!-- Investor Transport Section -->
                <section v-if="current==='investorTransport'" class="max-w-6xl mx-auto mt-6">
                    <h2 class="text-2xl font-bold text-purple-700 mb-4">
                        <i class="fas fa-truck mr-2"></i>Transport Services - Investor Portal
                    </h2>

                    <div class="bg-purple-100 border-l-4 border-purple-500 text-purple-700 p-4 mb-6" role="alert">
                        <p class="font-bold">User: {{ currentUser ? currentUser.name : 'Investor' }} (Role: Investor)</p>
                        <p class="text-sm">Coordinate transport for your funded projects and investment deliveries.</p>
                    </div>

                    <!-- Investment Transport Requests -->
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-seedling mr-2 text-purple-600"></i>
                            Investment Project Transports
                        </h3>

                        <div v-if="investorTransportRequests.length === 0" class="text-center py-8 text-gray-500">
                            <i class="fas fa-truck text-4xl mb-3"></i>
                            <p>No transport requests for your investments yet</p>
                            <p class="text-sm">Transport requests will appear when farmers need to deliver funded crops</p>
                        </div>

                        <div v-else class="space-y-4">
                            <div v-for="request in investorTransportRequests" :key="request._id"
                                 class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h4 class="font-semibold text-lg">{{ request.projectTitle }} - {{ request.crop }}</h4>
                                        <p class="text-sm text-gray-600">Investment transport • {{ request.urgency }} priority</p>
                                    </div>
                                    <span :class="getTransportStatusClass(request.status)"
                                          class="px-3 py-1 rounded-full text-xs font-medium">
                                        {{ request.status.charAt(0).toUpperCase() + request.status.slice(1) }}
                                    </span>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3 text-sm">
                                    <div>
                                        <span class="text-gray-500">From:</span> {{ request.pickupLocation }}
                                    </div>
                                    <div>
                                        <span class="text-gray-500">To:</span> {{ request.deliveryLocation }}
                                    </div>
                                    <div>
                                        <span class="text-gray-500">Investment Amount:</span>
                                        <span class="font-semibold text-purple-600">{{ request.investmentAmount }} SOL</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-500">Transport Cost:</span>
                                        <span class="font-semibold text-orange-600">{{ request.estimatedCost }} SOL</span>
                                    </div>
                                </div>

                                <div class="flex justify-between items-center">
                                    <div class="text-xs text-gray-500">
                                        Project: {{ request.projectTitle }}
                                    </div>
                                    <div class="space-x-2">
                                        <button v-if="request.status === 'assigned' && !request.investorPaymentMade"
                                                @click="payInvestorTransportShare(request)"
                                                class="text-purple-600 hover:text-purple-800 text-sm">
                                            <i class="fas fa-credit-card mr-1"></i>Pay Transport Share
                                        </button>
                                        <button v-if="request.status === 'in_transit'"
                                                @click="trackTransport(request._id)"
                                                class="text-blue-600 hover:text-blue-800 text-sm">
                                            <i class="fas fa-map-marker-alt mr-1"></i>Track Delivery
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Available Transporters -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-users mr-2 text-purple-600"></i>
                            Available Transport Providers
                        </h3>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div v-for="provider in transportProviders" :key="provider._id"
                                 class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-semibold">{{ provider.name }}</h4>
                                    <span :class="provider.available ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                                          class="px-2 py-1 rounded-full text-xs">
                                        {{ provider.available ? 'Available' : 'Busy' }}
                                    </span>
                                </div>

                                <div class="text-sm text-gray-600 space-y-1">
                                    <p><i class="fas fa-truck mr-1"></i>{{ provider.vehicle }}</p>
                                    <p><i class="fas fa-weight mr-1"></i>{{ provider.capacity }}kg capacity</p>
                                    <p><i class="fas fa-phone mr-1"></i>{{ provider.phone }}</p>
                                    <p><i class="fas fa-dollar-sign mr-1"></i>{{ provider.ratePerKm }} SOL/km</p>
                                </div>

                                <div class="flex justify-between items-center mt-3">
                                    <div class="text-yellow-500">
                                        <span v-for="i in 5" :key="i">
                                            <i :class="i <= provider.rating ? 'fas fa-star' : 'far fa-star'"></i>
                                        </span>
                                        <span class="text-sm text-gray-600 ml-1">{{ provider.rating }}</span>
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        {{ provider.serviceAreas.length }} areas
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Join as Transporter Section -->
                    <div class="bg-gradient-to-r from-orange-50 to-yellow-50 rounded-lg shadow-md p-6 mt-6 border border-orange-200">
                        <div class="text-center">
                            <div class="mb-4">
                                <i class="fas fa-truck text-4xl text-orange-600 mb-2"></i>
                                <h3 class="text-xl font-bold text-gray-800">Become a Transport Provider</h3>
                                <p class="text-gray-600 mt-2">Join our transport network and earn by providing delivery services</p>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-sm">
                                <div class="flex items-center justify-center p-3 bg-white rounded-lg shadow-sm">
                                    <i class="fas fa-coins text-orange-600 mr-2"></i>
                                    <span>Earn SOL for deliveries</span>
                                </div>
                                <div class="flex items-center justify-center p-3 bg-white rounded-lg shadow-sm">
                                    <i class="fas fa-route text-orange-600 mr-2"></i>
                                    <span>Choose your service areas</span>
                                </div>
                                <div class="flex items-center justify-center p-3 bg-white rounded-lg shadow-sm">
                                    <i class="fas fa-star text-orange-600 mr-2"></i>
                                    <span>Build your reputation</span>
                                </div>
                            </div>

                            <button @click="redirectToTransportPortal()"
                                    class="bg-orange-600 hover:bg-orange-700 text-white px-8 py-3 rounded-lg font-semibold text-lg transition-colors duration-200 shadow-lg hover:shadow-xl">
                                <i class="fas fa-user-plus mr-2"></i>Join as Transporter
                            </button>

                            <p class="text-xs text-gray-500 mt-3">
                                Registration requires a small blockchain fee and vehicle verification
                            </p>
                        </div>
                    </div>
                </section>

                <!-- Transporter Dashboard Section -->
                <section v-if="current==='transporterDashboard'" class="max-w-6xl mx-auto mt-6">
                    <h2 class="text-2xl font-bold text-orange-700 mb-4">
                        <i class="fas fa-tachometer-alt mr-2"></i>Transporter Dashboard
                    </h2>

                    <div class="bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-4 mb-6" role="alert">
                        <p class="font-bold">Welcome, {{ currentTransporter ? currentTransporter.name : 'Transporter' }}!</p>
                        <p class="text-sm">Manage your transport business, view available jobs, and track your earnings on the PestVid platform.</p>
                    </div>

                    <!-- Registration Check -->
                    <div v-if="!currentTransporter" class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <div class="text-center py-8">
                            <i class="fas fa-truck text-6xl text-orange-300 mb-4"></i>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Complete Your Registration</h3>
                            <p class="text-gray-600 mb-4">You need to register as a transport provider to access the dashboard.</p>
                            <button @click="switchPage('transporterProfile')"
                                    class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-3 rounded-lg font-medium">
                                <i class="fas fa-user-plus mr-2"></i>Register Now
                            </button>
                        </div>
                    </div>

                    <!-- Dashboard Content -->
                    <div v-if="currentTransporter" class="space-y-6">
                        <!-- Stats Overview -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <div class="bg-white rounded-lg shadow-md p-6">
                                <div class="flex items-center">
                                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                                        <i class="fas fa-check-circle text-xl"></i>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm font-medium text-gray-600">Completed Jobs</p>
                                        <p class="text-2xl font-bold text-gray-900">{{ currentTransporter.completedJobs || 0 }}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow-md p-6">
                                <div class="flex items-center">
                                    <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                        <i class="fas fa-clock text-xl"></i>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm font-medium text-gray-600">Active Jobs</p>
                                        <p class="text-2xl font-bold text-gray-900">{{ getActiveTransportJobs().length }}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow-md p-6">
                                <div class="flex items-center">
                                    <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                                        <i class="fas fa-coins text-xl"></i>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm font-medium text-gray-600">Total Earnings</p>
                                        <p class="text-2xl font-bold text-gray-900">{{ (currentTransporter.earnings || 0).toFixed(4) }} SOL</p>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white rounded-lg shadow-md p-6">
                                <div class="flex items-center">
                                    <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                                        <i class="fas fa-star text-xl"></i>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm font-medium text-gray-600">Rating</p>
                                        <p class="text-2xl font-bold text-gray-900">{{ (currentTransporter.rating || 5.0).toFixed(1) }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">
                                <i class="fas fa-bolt mr-2 text-orange-600"></i>Quick Actions
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <button @click="switchPage('transporterJobs')"
                                        class="flex items-center justify-center p-4 border-2 border-dashed border-orange-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-colors">
                                    <div class="text-center">
                                        <i class="fas fa-search text-2xl text-orange-600 mb-2"></i>
                                        <p class="font-medium text-gray-800">Find Jobs</p>
                                        <p class="text-sm text-gray-600">Browse available transport requests</p>
                                    </div>
                                </button>

                                <button @click="switchPage('transporterProfile')"
                                        class="flex items-center justify-center p-4 border-2 border-dashed border-orange-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-colors">
                                    <div class="text-center">
                                        <i class="fas fa-user-edit text-2xl text-orange-600 mb-2"></i>
                                        <p class="font-medium text-gray-800">Update Profile</p>
                                        <p class="text-sm text-gray-600">Edit your service details</p>
                                    </div>
                                </button>

                                <button @click="switchPage('transporterEarnings')"
                                        class="flex items-center justify-center p-4 border-2 border-dashed border-orange-300 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-colors">
                                    <div class="text-center">
                                        <i class="fas fa-chart-line text-2xl text-orange-600 mb-2"></i>
                                        <p class="font-medium text-gray-800">View Earnings</p>
                                        <p class="text-sm text-gray-600">Track your income and payments</p>
                                    </div>
                                </button>
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">
                                <i class="fas fa-history mr-2 text-orange-600"></i>Recent Activity
                            </h3>

                            <div v-if="getRecentTransportActivity().length === 0" class="text-center py-8 text-gray-500">
                                <i class="fas fa-clipboard-list text-4xl mb-3"></i>
                                <p>No recent activity</p>
                                <p class="text-sm">Start accepting transport jobs to see activity here</p>
                            </div>

                            <div v-else class="space-y-3">
                                <div v-for="activity in getRecentTransportActivity().slice(0, 5)" :key="activity._id"
                                     class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <div class="flex items-center">
                                        <div :class="getActivityIconClass(activity.status)" class="p-2 rounded-full mr-3">
                                            <i :class="getActivityIcon(activity.status)"></i>
                                        </div>
                                        <div>
                                            <p class="font-medium text-gray-800">{{ activity.crop }} Transport</p>
                                            <p class="text-sm text-gray-600">{{ activity.pickupLocation }} → {{ activity.deliveryLocation }}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-semibold text-orange-600">{{ activity.estimatedCost }} SOL</p>
                                        <p class="text-xs text-gray-500">{{ formatTimestamp(activity.createdAt, true) }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </section>

                <!-- Transporter Profile Section -->
                <section v-if="current==='transporterProfile'" class="max-w-4xl mx-auto mt-6">
                    <h2 class="text-2xl font-bold text-orange-700 mb-4">
                        <i class="fas fa-user-cog mr-2"></i>Transporter Profile
                    </h2>

                    <div class="bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-4 mb-6" role="alert">
                        <p class="font-bold">{{ currentTransporter ? 'Update Your Profile' : 'Complete Your Registration' }}</p>
                        <p class="text-sm">{{ currentTransporter ? 'Keep your transport service information up to date.' : 'Register as a transport provider and start earning SOL by delivering agricultural products.' }}</p>
                    </div>

                    <!-- Registration/Profile Form -->
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-truck mr-2 text-orange-600"></i>
                            {{ currentTransporter ? 'Update Transport Service' : 'Register Your Transport Service' }}
                        </h3>

                        <form @submit.prevent="registerTransporter" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Business Name</label>
                                    <input v-model="transporterForm.name" type="text" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                                           placeholder="Enter your business name">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Contact Phone</label>
                                    <input v-model="transporterForm.phone" type="tel" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                                           placeholder="Enter contact number">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Vehicle Type</label>
                                    <select v-model="transporterForm.vehicle" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                                        <option value="">Select vehicle type</option>
                                        <option value="Refrigerated Truck">Refrigerated Truck</option>
                                        <option value="Covered Truck">Covered Truck</option>
                                        <option value="Open Truck">Open Truck</option>
                                        <option value="Mini Truck">Mini Truck</option>
                                        <option value="Pickup Truck">Pickup Truck</option>
                                        <option value="Trailer">Trailer</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Capacity (kg)</label>
                                    <input v-model.number="transporterForm.capacity" type="number" min="100" max="50000" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                                           placeholder="Vehicle capacity in kg">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Rate per KM (SOL)</label>
                                    <input v-model.number="transporterForm.ratePerKm" type="number" step="0.001" min="0.001" max="1" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                                           placeholder="Your rate per kilometer">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">License Number</label>
                                    <input v-model="transporterForm.license" type="text" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                                           placeholder="Vehicle license number">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Service Areas</label>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                    <label v-for="area in availableServiceAreas" :key="area" class="flex items-center">
                                        <input type="checkbox" :value="area" v-model="transporterForm.serviceAreas"
                                               class="mr-2 text-orange-600 focus:ring-orange-500">
                                        <span class="text-sm">{{ area }}</span>
                                    </label>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Additional Information</label>
                                <textarea v-model="transporterForm.description" rows="3"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                                          placeholder="Any additional information about your service..."></textarea>
                            </div>

                            <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4">
                                <h4 class="font-medium text-yellow-800 mb-2">How Our System Works:</h4>
                                <ul class="text-sm text-yellow-700 space-y-1">
                                    <li>• <strong>FIFO Priority:</strong> Earlier registered transporters get priority</li>
                                    <li>• <strong>Price Competition:</strong> Lower rates increase your chances</li>
                                    <li>• <strong>Service Areas:</strong> Only get requests from your selected areas</li>
                                    <li>• <strong>Capacity Matching:</strong> Only requests within your capacity</li>
                                    <li>• <strong>Instant Payments:</strong> Get paid in SOL immediately upon delivery</li>
                                </ul>
                            </div>

                            <div class="flex items-center justify-between">
                                <div class="text-sm text-gray-600">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Registration requires wallet connection for payments
                                </div>
                                <button type="submit" :disabled="!walletConnected"
                                        class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-md font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i class="fas fa-truck mr-2"></i>
                                    Register as Transporter
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Existing Transporters -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-users mr-2 text-orange-600"></i>
                            Current Transport Providers ({{ transportProviders.length }})
                        </h3>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div v-for="provider in transportProviders" :key="provider._id"
                                 class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-semibold">{{ provider.name }}</h4>
                                    <span :class="provider.available ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                                          class="px-2 py-1 rounded-full text-xs">
                                        {{ provider.available ? 'Available' : 'Busy' }}
                                    </span>
                                </div>

                                <div class="text-sm text-gray-600 space-y-1">
                                    <p><i class="fas fa-truck mr-1"></i>{{ provider.vehicle }}</p>
                                    <p><i class="fas fa-weight mr-1"></i>{{ provider.capacity }}kg capacity</p>
                                    <p><i class="fas fa-dollar-sign mr-1"></i>{{ provider.ratePerKm }} SOL/km</p>
                                    <p><i class="fas fa-calendar mr-1"></i>Registered {{ formatTimestamp(provider.registeredAt, true) }}</p>
                                </div>

                                <div class="flex justify-between items-center mt-3">
                                    <div class="text-yellow-500">
                                        <span v-for="i in 5" :key="i">
                                            <i :class="i <= provider.rating ? 'fas fa-star' : 'far fa-star'"></i>
                                        </span>
                                        <span class="text-sm text-gray-600 ml-1">{{ provider.rating }}</span>
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        {{ provider.serviceAreas.length }} areas
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Transporter Jobs Section -->
                <section v-if="current==='transporterJobs'" class="max-w-6xl mx-auto mt-6">
                    <h2 class="text-2xl font-bold text-orange-700 mb-4">
                        <i class="fas fa-briefcase mr-2"></i>Available Transport Jobs
                    </h2>

                    <div class="bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-4 mb-6" role="alert">
                        <p class="font-bold">Find Transport Opportunities</p>
                        <p class="text-sm">Browse and accept transport requests from farmers, buyers, and investors. Jobs are assigned using FIFO + Price optimization.</p>
                    </div>

                    <!-- Job Filters -->
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-filter mr-2 text-orange-600"></i>Filter Jobs
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Crop Type</label>
                                <select v-model="transportJobFilters.crop" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                                    <option value="">All crops</option>
                                    <option value="Rice">Rice</option>
                                    <option value="Wheat">Wheat</option>
                                    <option value="Corn">Corn</option>
                                    <option value="Tomatoes">Tomatoes</option>
                                    <option value="Potatoes">Potatoes</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Urgency</label>
                                <select v-model="transportJobFilters.urgency" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                                    <option value="">All urgency levels</option>
                                    <option value="high">High (Same day)</option>
                                    <option value="medium">Medium (1-2 days)</option>
                                    <option value="low">Low (3-5 days)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Min Payment (SOL)</label>
                                <input v-model.number="transportJobFilters.minPayment" type="number" step="0.001" min="0"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                                       placeholder="0.000">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Service Area</label>
                                <select v-model="transportJobFilters.area" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                                    <option value="">All areas</option>
                                    <option v-for="area in availableServiceAreas" :key="area" :value="area">{{ area }}</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Available Jobs -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-list mr-2 text-orange-600"></i>
                            Available Jobs ({{ getFilteredTransportJobs().length }})
                        </h3>

                        <div v-if="getFilteredTransportJobs().length === 0" class="text-center py-8 text-gray-500">
                            <i class="fas fa-search text-4xl mb-3"></i>
                            <p>No jobs match your criteria</p>
                            <p class="text-sm">Try adjusting your filters or check back later for new opportunities</p>
                        </div>

                        <div v-else class="space-y-4">
                            <div v-for="job in getFilteredTransportJobs()" :key="job._id"
                                 class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h4 class="font-semibold text-lg">{{ job.crop }} Transport</h4>
                                        <p class="text-sm text-gray-600">{{ job.quantity }}kg • {{ job.urgency }} priority</p>
                                    </div>
                                    <div class="text-right">
                                        <span class="text-lg font-bold text-orange-600">{{ job.estimatedCost }} SOL</span>
                                        <p class="text-xs text-gray-500">{{ job.urgency === 'high' ? 'Same day' : job.urgency === 'medium' ? '1-2 days' : '3-5 days' }}</p>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3 text-sm">
                                    <div>
                                        <span class="text-gray-500">From:</span> {{ job.pickupLocation }}
                                    </div>
                                    <div>
                                        <span class="text-gray-500">To:</span> {{ job.deliveryLocation || job.deliveryAddress }}
                                    </div>
                                    <div>
                                        <span class="text-gray-500">Pickup Date:</span> {{ formatDate(job.pickupDate || job.deliveryDate) }}
                                    </div>
                                    <div>
                                        <span class="text-gray-500">Distance:</span> {{ job.estimatedDistance || 'TBD' }}km
                                    </div>
                                </div>

                                <div v-if="job.instructions" class="bg-gray-50 rounded p-3 mb-3">
                                    <p class="text-sm"><strong>Instructions:</strong> {{ job.instructions }}</p>
                                </div>

                                <div class="flex justify-between items-center">
                                    <div class="text-xs text-gray-500">
                                        Posted: {{ formatTimestamp(job.createdAt, true) }}
                                    </div>
                                    <div class="space-x-2">
                                        <button v-if="canAcceptJob(job)"
                                                @click="acceptTransportJob(job)"
                                                class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded text-sm">
                                            <i class="fas fa-check mr-1"></i>Accept Job
                                        </button>
                                        <button v-else
                                                disabled
                                                class="bg-gray-400 text-white px-4 py-2 rounded text-sm cursor-not-allowed">
                                            <i class="fas fa-times mr-1"></i>{{ getJobUnavailableReason(job) }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Transporter Earnings Section -->
                <section v-if="current==='transporterEarnings'" class="max-w-6xl mx-auto mt-6">
                    <h2 class="text-2xl font-bold text-orange-700 mb-4">
                        <i class="fas fa-chart-line mr-2"></i>Earnings & Analytics
                    </h2>

                    <div class="bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-4 mb-6" role="alert">
                        <p class="font-bold">Track Your Transport Business</p>
                        <p class="text-sm">Monitor your earnings, job completion rates, and performance metrics on the PestVid platform.</p>
                    </div>

                    <!-- Earnings Overview -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-green-100 text-green-600">
                                    <i class="fas fa-coins text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Total Earnings</p>
                                    <p class="text-2xl font-bold text-gray-900">{{ (currentTransporter?.earnings || 0).toFixed(4) }} SOL</p>
                                    <p class="text-xs text-gray-500">≈ ${{ ((currentTransporter?.earnings || 0) * 25).toFixed(2) }} USD</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg shadow-md p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                    <i class="fas fa-percentage text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">Completion Rate</p>
                                    <p class="text-2xl font-bold text-gray-900">{{ getCompletionRate() }}%</p>
                                    <p class="text-xs text-gray-500">{{ currentTransporter?.completedJobs || 0 }} of {{ currentTransporter?.totalJobs || 0 }} jobs</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg shadow-md p-6">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                                    <i class="fas fa-calendar text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">This Month</p>
                                    <p class="text-2xl font-bold text-gray-900">{{ getMonthlyEarnings().toFixed(4) }} SOL</p>
                                    <p class="text-xs text-gray-500">{{ getMonthlyJobs() }} jobs completed</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Payments -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-receipt mr-2 text-orange-600"></i>
                            Recent Payments
                        </h3>

                        <div v-if="getTransporterPayments().length === 0" class="text-center py-8 text-gray-500">
                            <i class="fas fa-wallet text-4xl mb-3"></i>
                            <p>No payments received yet</p>
                            <p class="text-sm">Complete transport jobs to start earning SOL</p>
                        </div>

                        <div v-else class="space-y-3">
                            <div v-for="payment in getTransporterPayments().slice(0, 10)" :key="payment._id"
                                 class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center">
                                    <div class="p-2 rounded-full bg-green-100 text-green-600 mr-3">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-800">{{ payment.crop }} Transport</p>
                                        <p class="text-sm text-gray-600">{{ payment.pickupLocation }} → {{ payment.deliveryLocation }}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="font-semibold text-green-600">+{{ payment.amount }} SOL</p>
                                    <p class="text-xs text-gray-500">{{ formatTimestamp(payment.paidAt, true) }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Investor Projects Section -->
                <section v-if="current==='investorProjects'" class="max-w-6xl mx-auto mt-6">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-2xl font-bold text-green-700"><i class="fas fa-project-diagram mr-2"></i>Investment Opportunities</h2>
                        <div class="flex gap-2">
                            <button @click="loadPublicPlatformData" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">
                                <i class="fas fa-sync-alt mr-1"></i>Refresh Projects
                            </button>
                            <button @click="loadUserAppData" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">
                                <i class="fas fa-user-sync mr-1"></i>Refresh My Data
                            </button>
                        </div>
                    </div>
                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4" role="alert">
                        <p class="font-bold">User: {{ currentUser ? currentUser.name : 'Investor' }} (Role: Investor)</p>
                        <p class="text-sm">Browse funding requests from farmers and simulate investments.</p>
                        <div class="mt-2 text-xs">
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded mr-2">✓ Projects Loading</span>
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded mr-2">✓ Investment System</span>
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded mr-2">✓ Portfolio Tracking</span>
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded mr-2">✓ Video Display</span>
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded mr-2">✓ Farmer Profiles</span>
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded">✓ Database Storage</span>
                        </div>
                    </div>
                <div class="bg-white rounded shadow-md p-6 mb-7">
                    <div class="flex flex-col md:flex-row md:items-end gap-5">
                    <div class="w-full md:w-48"> <label class="text-gray-600 text-sm">Crop Type</label> <select v-model="investorFilters.crop" class="w-full px-2 py-1 border rounded bg-white text-sm"> <option value="">All Crops</option> <option v-for="c in uniqueFundingCrops" :key="c">{{c}}</option> </select> </div>
                    <div class="w-full md:w-48"> <label class="text-gray-600 text-sm">Growing Method</label> <select v-model="investorFilters.method" class="w-full px-2 py-1 border rounded bg-white text-sm"> <option value="">All Methods</option> <option value="organic">Organic</option> <option value="conventional">Conventional</option> <option value="hydroponic">Hydroponic</option> <option value="aquaponic">Aquaponic</option> <option value="regenerative">Regenerative</option> </select> </div>
                    <div class="w-full md:w-48"> <label class="text-gray-600 text-sm">Min ROI (%)</label> <input type="number" v-model.number="investorFilters.minRoi" class="w-full px-2 py-1 border rounded text-sm" placeholder="e.g., 10"> </div>
                    <div class="w-full md:w-48"> <label class="text-gray-600 text-sm">Max Funding Needed (SOL)</label> <input type="number" v-model.number="investorFilters.maxAmount" class="w-full px-2 py-1 border rounded text-sm" placeholder="e.g., 100"> </div>
                    <button type="button" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-1 rounded text-sm mt-2 md:mt-0" @click="resetInvestorFilters"> <i class="fas fa-undo mr-1"></i> Reset Filters </button>
                    </div>
                </div>
                <div v-if="filteredFundingRequests.length === 0" class="text-gray-600 bg-gray-50 p-8 text-center rounded">
                    <i class="fas fa-search text-4xl text-gray-400 mb-3"></i><br>
                    <p>No investment opportunities found matching your criteria.</p>
                    <p class="text-sm mt-2">Total funding requests in database: {{ allFundingRequests.length }}</p>
                    <p class="text-sm">After filters applied: {{ filteredFundingRequests.length }}</p>
                    <button @click="debugFundingRequests" class="mt-3 bg-blue-500 text-white px-4 py-2 rounded text-sm">Debug Info</button>
                    <div class="mt-2 space-x-2">
                        <button @click="resetInvestorFilters" class="bg-gray-500 text-white px-3 py-1 rounded text-xs">Clear All Filters</button>
                        <button @click="testInvestorFunctions" class="bg-purple-500 text-white px-3 py-1 rounded text-xs">Test All Functions</button>
                    </div>
                </div>
                <div v-else class="grid gap-6 grid-cols-1 lg:grid-cols-2">
                    <div v-for="project in filteredFundingRequests" :key="project._id" class="bg-white rounded-lg shadow overflow-hidden relative">
                    <div v-if="project.isNew" class="new-badge">NEW</div>
                    <div class="p-5 bg-gray-50 border-b flex flex-col sm:flex-row justify-between sm:items-center"> <h3 class="font-bold text-lg text-green-800 mb-2 sm:mb-0">{{ project.title }}</h3> <span :class="{'bg-yellow-100 text-yellow-800': project.status === 'pending', 'bg-green-100 text-green-800': project.status === 'funded', 'bg-blue-100 text-blue-800': project.status === 'partially_funded'}" class="px-2 py-1 rounded text-xs font-medium self-start sm:self-center"> {{ project.status === 'pending' ? 'Seeking Funding' : project.status === 'funded' ? 'Fully Funded' : 'Partially Funded' }} </span> </div>
                    <div class="p-5">
                        <div class="flex flex-col md:flex-row gap-6">
                        <div class="md:w-1/3">
                            <video :src="getVideoUrl(project.cid, project.videoStorageType || 'ipfs')" controls playsinline webkit-playsinline class="rounded w-full h-40 object-cover bg-black mb-3"></video>
                            <div class="grid grid-cols-2 gap-2 text-sm"> <div> <div class="text-xs text-gray-500">Farmer</div> <div class="font-medium truncate flex items-center"> <span>{{ getFarmerDisplayIdentifier(project.farmerWallet) }}</span> <button @click="showFarmerProfile(project.farmerWallet)" class="ml-2 text-blue-500 hover:text-blue-700 text-xs focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> </div> </div> <div> <div class="text-xs text-gray-500">Land Size</div> <div class="font-medium">{{ project.acres }} acres</div> </div> <div> <div class="text-xs text-gray-500">Timeline</div> <div class="font-medium">{{ project.timeline }} months</div> </div> <div> <div class="text-xs text-gray-500">Expected ROI</div> <div class="font-medium text-green-700">{{ project.roi }}%</div> </div> </div>
                            <button @click="startOrGoToConversation(project.farmerWallet)" v-if="currentUserIdentifier !== project.farmerWallet" class="mt-3 w-full text-xs text-blue-600 hover:text-blue-700 border border-blue-400 rounded-full px-3 py-1 hover:bg-blue-50 flex items-center justify-center"> <i class="fas fa-envelope mr-1"></i> Message Farmer </button>
                        </div>
                        <div class="md:w-2/3">
                            <div class="mb-4"> <div class="text-sm font-medium mb-1">{{ project.crop }} ({{ project.method }})</div> <p class="text-sm text-gray-700 max-h-20 overflow-y-auto">{{ project.description }}</p> </div>
                            <div class="mb-4"> <div class="text-xs text-gray-500 mb-1">Funding Progress</div> <div class="progress-bar"> <div class="progress-fill bg-green-500" :style="{width: fundingProgressPercent(project) + '%'}"></div> </div> <div class="flex justify-between text-xs mt-1"> <span>{{ project.fundedAmount || 0 }} / {{ project.amount }} SOL</span> <span>{{ fundingProgressPercent(project) }}% Complete</span> </div> </div>
                            <div v-if="project.updates && project.updates.length > 0" class="mb-4"> <h4 class="text-sm font-semibold text-gray-700 mb-2">Recent Farmer Updates</h4> <div class="project-updates-list text-xs" style="max-height: 70px;"> <div v-for="update in project.updates.slice().reverse().slice(0,2)" :key="update._id" class="project-update-item"> <span class="font-medium text-gray-500">{{ formatTimestamp(update.date, true) }}:</span> {{ update.text }} </div> </div> </div>
                            <div class="mb-4"> <div class="flex justify-between items-center mb-2"> <div class="text-sm font-medium">Investment Terms</div> <div class="text-xs text-gray-500">Investor Share: {{ project.investorShare }}% of profit</div> </div> <div class="p-3 bg-yellow-50 rounded text-sm border border-yellow-200"> <p>Invest to receive {{ project.investorShare }}% of the profits, proportional to your investment. Expected return is {{ project.roi }}% over {{ project.timeline }} months.</p> </div> </div>
                            <div class="flex flex-col sm:flex-row justify-between items-center mt-4 pt-4 border-t">
                                <div class="mb-3 sm:mb-0">
                                    <label :for="'investment-amount-'+project._id" class="text-xs text-gray-500 block mb-1">Your Investment (SOL)</label>
                                    <input
                                        v-model.number="investmentAmounts[project._id]"
                                        type="number"
                                        :id="'investment-amount-'+project._id"
                                        class="px-3 py-1 border rounded w-full sm:w-32 text-sm"
                                        min="0.1"
                                        :max="maxInvestmentAmount(project)"
                                        step="0.1"
                                        :disabled="project.status === 'funded' || role !== 'investor'"
                                        :placeholder="maxInvestmentAmount(project) > 0 ? `Max ${maxInvestmentAmount(project)}` : 'Funded'"
                                        @focus="ensureInvestmentAmountExists(project._id)"
                                        @input="validateInvestmentAmount(project)"
                                    >
                                </div>
                                <button
                                    @click="investInProject(project)"
                                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm w-full sm:w-auto"
                                    :disabled="project.status === 'funded' || role !== 'investor' || !investmentAmounts[project._id] || investmentAmounts[project._id] <= 0 || investmentAmounts[project._id] > maxInvestmentAmount(project)"
                                >
                                    <i class="fas fa-coins mr-1"></i>
                                    {{ project.status === 'funded' ? 'Fully Funded' : (role !== 'investor' ? 'Switch to Investor Role' : 'Invest Now') }}
                                </button>
                            </div>
                            <div v-if="investmentErrors[project._id]" class="text-red-500 text-xs mt-2">{{ investmentErrors[project._id] }}</div>
                        </div>
                        </div>
                    </div>
                    </div>
                </div>
                <div v-if="filteredFundingRequests.length === 0" class="bg-gray-50 p-8 text-center rounded-lg mt-4"> <i class="fas fa-seedling text-gray-300 text-4xl mb-3"></i> <h3 class="text-gray-600 text-lg mb-2">No Projects Found</h3> <p class="text-gray-500">Try adjusting your filters or check back later for new investment opportunities.</p> </div>
                </section>
                <!-- Investor Portfolio Section -->
                <section v-if="current==='investorPortfolio'" class="max-w-6xl mx-auto mt-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-green-700"><i class="fas fa-chart-pie mr-2"></i>Investment Portfolio</h2>
                        <div class="flex gap-2">
                            <button @click="updateInvestmentProgress" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">
                                <i class="fas fa-sync-alt mr-1"></i>Update Progress
                            </button>
                            <button @click="loadUserAppData" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">
                                <i class="fas fa-database mr-1"></i>Refresh Data
                            </button>
                        </div>
                    </div>
                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4" role="alert">
                        <p class="font-bold">User: {{ currentUser ? currentUser.name : 'Investor' }} (Role: Investor)</p>
                        <p class="text-sm">View your simulated investments and transaction history.</p>
                        <div class="mt-2 text-xs">
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded mr-2">✓ Portfolio Tracking</span>
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded mr-2">✓ Progress Updates</span>
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded mr-2">✓ Transaction History</span>
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded">✓ ROI Calculation</span>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6 mb-8">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Portfolio Overview</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-6"> <div class="mb-4 md:mb-0"> <div class="text-xs text-gray-500">Total Invested</div> <div class="text-2xl font-bold text-green-700">{{ totalInvestedAmount }} SOL</div> </div> <div> <div class="text-xs text-gray-500">Active Projects</div> <div class="text-xl font-bold">{{ investorActiveProjects }}</div> </div> <div> <div class="text-xs text-gray-500">Completed</div> <div class="text-xl font-bold">{{ investorCompletedProjects }}</div> </div> <div> <div class="text-xs text-gray-500">Avg. ROI</div> <div class="text-xl font-bold text-green-700">{{ investorAvgRoi }}%</div> </div> </div>
                    </div>
                    <div class="bg-white rounded-lg shadow overflow-hidden mb-8">
                        <div class="px-6 py-4 bg-gray-50 border-b"> <h3 class="text-lg font-semibold text-gray-800">Your Active Investments</h3> </div>
                        <div v-if="investorInvestments.length === 0" class="p-8 text-center"> <i class="fas fa-chart-line text-gray-300 text-4xl mb-3"></i> <h4 class="text-gray-600 text-lg mb-2">No Active Investments</h4> <p class="text-gray-500 mb-4">You haven't invested in any agricultural projects yet.</p> <button @click="switchPage('investorProjects')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm"> <i class="fas fa-search mr-1"></i>Browse Projects </button> </div>
                        <div v-else class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50"> <tr> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Farmer</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invested (SOL)</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expected Return (SOL)</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th> </tr> </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                            <tr v-for="investment in investorInvestments" :key="investment._id">
                                <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-medium text-gray-900">{{ investment.projectTitle }}</div> <div class="text-xs text-gray-500">{{ investment.crop }}</div> </td>
                                <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm text-gray-900">{{ getFarmerDisplayIdentifier(investment.farmerWallet, 10) }}</div> <button @click="showFarmerProfile(investment.farmerWallet)" class="ml-2 text-blue-500 hover:text-blue-700 text-xs focus:outline-none mr-2" title="View Farmer Info"> <i class="fas fa-info-circle"></i>View Info </button> <button @click="startOrGoToConversation(investment.farmerWallet)" v-if="currentUserIdentifier !== investment.farmerWallet" class="text-green-600 hover:text-green-700 text-xs focus:outline-none" title="Message Farmer"> <i class="fas fa-envelope mr-1"></i>Message </button> </td>
                                <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-mono text-gray-900">{{ investment.amount }}</div> <div class="text-xs text-gray-500">{{ formatTimestamp(investment.investmentDate, true) }}</div> </td>
                                <td class="px-6 py-4 whitespace-nowrap"> <div class="w-24 bg-gray-200 rounded-full h-2.5"> <div class="bg-green-600 h-2.5 rounded-full" :style="{width: investment.progress+'%'}"></div> </div> <div class="text-xs text-gray-500 mt-1">{{ investment.progress }}% Complete</div> </td>
                                <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm text-gray-900 font-mono">{{ calculateExpectedReturn(investment) }}</div> <div class="text-xs text-gray-500">{{ investment.roi }}% ROI</div> </td>
                                <td class="px-6 py-4 whitespace-nowrap"> <span :class="{ 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true, 'bg-blue-100 text-blue-800': investment.status === 'active', 'bg-green-100 text-green-800': investment.status === 'harvested', 'bg-yellow-100 text-yellow-800': investment.status === 'growing' }"> {{ investment.status.charAt(0).toUpperCase() + investment.status.slice(1) }} </span> </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600"> <a href="#" @click.prevent="viewInvestmentDetails(investment)" class="hover:underline">View</a> </td>
                            </tr>
                            </tbody>
                        </table>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <div class="px-6 py-4 bg-gray-50 border-b flex justify-between items-center"> <h3 class="text-lg font-semibold text-gray-800">Platform Transaction History (Simulated)</h3> <span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded-full flex items-center"> <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 16 15"><path d="m7.81 0-1.78 3.69L1.88 4.2l2.92 2.52L4.04 10 7.8 7.97 11.55 10l-.77-3.28 2.92 2.52-4.15-.51L7.82 0h-.01Zm0 15-1.78-3.69-4.15-.51 2.92-2.52L4.04 5 7.8 7.03 11.55 5l-.77 3.28 2.92 2.52-4.15-.51L7.82 15h-.01Z"></path></svg> PestiVid Platform (Simulated Ledger) </span> </div>
                        <div v-if="investorTransactions.length === 0" class="p-8 text-center"> <i class="fas fa-cubes text-gray-300 text-4xl mb-3"></i> <h4 class="text-gray-600 text-lg mb-2">No Transactions Yet</h4> <p class="text-gray-500">Your investment and payout transactions on the platform will appear here.</p> </div>
                        <div v-else class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50"> <tr> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Transaction ID</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount (SOL)</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th> </tr> </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                            <tr v-for="tx in investorTransactions" :key="tx._id">
                                <td class="px-6 py-4 whitespace-nowrap"> <div class="flex items-center"> <div class="text-sm font-mono text-gray-900 truncate max-w-[150px] sm:max-w-[250px]" :title="tx.txHash">{{ tx.txHash.substring(0,10) }}...{{ tx.txHash.substring(tx.txHash.length-10) }}</div> <a :href="avalancheExplorerUrl(tx.txHash)" target="_blank" class="ml-1 text-blue-500 hover:text-blue-700" title="View on Avalanche Explorer (Real-time)"> <i class="fas fa-external-link-alt text-xs"></i> </a> </div> </td>
                                <td class="px-6 py-4 whitespace-nowrap"> <span :class="{ 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true, 'bg-green-100 text-green-800': tx.type === 'investment', 'bg-blue-100 text-blue-800': tx.type === 'payout' }"> {{ tx.type === 'investment' ? 'Investment' : 'Harvest Payout' }} </span> </td>
                                <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-mono text-gray-900">{{ tx.amount }}</div> </td>
                                <td class="px-6 py-4 whitespace-nowrap"> <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800"> Confirmed (Sim.) </span> </td>
                                <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm text-gray-900">{{ formatTimestamp(tx.date, true) }}</div> </td>
                            </tr>
                            </tbody>
                        </table>
                        </div>
                    </div>
                </section>
                <!-- User Profile Section -->
                <section v-if="current==='userProfile'" class="max-w-7xl mx-auto mt-6">
                    <!-- Profile Header -->
                    <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
                        <div class="bg-gradient-to-r from-green-700 to-green-500 p-6 text-white">
                            <div class="flex items-center space-x-4">
                                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center text-green-700 text-3xl shadow">
                                    <i class="fas fa-user-circle"></i>
                                </div>
                                <div class="flex-1">
                                    <h2 class="text-2xl font-bold">{{ userName }}</h2>
                                    <p class="text-green-200">{{ userRoleDisplay }} • Member since {{ memberSinceDisplay }}</p>
                                    <p class="text-green-100 text-sm font-mono">{{ currentUserIdentifier }}</p>
                                </div>
                                <div class="text-right">
                                    <div class="bg-green-600 px-4 py-2 rounded-lg">
                                        <p class="text-sm">Wallet Status</p>
                                        <p class="font-bold">{{ walletConnected ? 'Connected' : 'Not Connected' }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- User Details -->
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <p class="text-xs text-gray-500 uppercase tracking-wide">Contact Information</p>
                                    <div class="mt-2 space-y-2">
                                        <p><span class="text-gray-600">Email:</span> {{ userEmailDisplay }}</p>
                                        <p><span class="text-gray-600">Phone:</span> {{ userPhoneDisplay }}</p>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500 uppercase tracking-wide">Platform Statistics</p>
                                    <div class="mt-2 space-y-2">
                                        <p v-if="role==='farmer'"><span class="text-gray-600">Videos:</span> {{ farmerVideos.length }}</p>
                                        <p v-if="role==='farmer'"><span class="text-gray-600">Active Listings:</span> {{ farmerListings.filter(l=>l.status === 'active').length }}</p>
                                        <p v-if="role==='buyer'"><span class="text-gray-600">Purchases:</span> {{ buyerPurchases.length }}</p>
                                        <p v-if="role==='investor'"><span class="text-gray-600">Investments:</span> {{ investorInvestments.length }}</p>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500 uppercase tracking-wide">Account Status</p>
                                    <div class="mt-2 space-y-2">
                                        <p><span class="text-gray-600">Role:</span> {{ userRoleDisplay }}</p>
                                        <p><span class="text-gray-600">Messages:</span> {{ unreadMessageCount }} unread</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Videos Section (For Farmers) -->
                    <div v-if="role === 'farmer'" class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
                        <div class="bg-gray-50 px-6 py-4 border-b">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                <i class="fas fa-video mr-2 text-green-600"></i>
                                Your Uploaded Videos ({{ farmerVideos.length }})
                            </h3>
                        </div>
                        <div class="p-6">
                            <div v-if="farmerVideos.length === 0" class="text-center py-8 text-gray-500">
                                <i class="fas fa-video-slash text-4xl mb-3"></i>
                                <p>No videos uploaded yet</p>
                                <button @click="switchPage('farmerPestiVid')" class="mt-2 text-green-600 hover:text-green-700">
                                    Upload your first video
                                </button>
                            </div>
                            <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <div v-for="video in farmerVideos" :key="video.cid" class="border rounded-lg overflow-hidden">
                                    <video :src="getVideoUrl(video.cid, video.storageType)"
                                           class="w-full h-32 object-cover bg-black"
                                           controls preload="metadata">
                                    </video>
                                    <div class="p-3">
                                        <h4 class="font-semibold text-sm">{{ video.crop }}</h4>
                                        <p class="text-xs text-gray-600">{{ video.location }}</p>
                                        <p class="text-xs text-gray-500">{{ video.pesticide }}</p>
                                        <div class="mt-2 flex justify-between items-center">
                                            <span class="text-xs px-2 py-1 rounded"
                                                  :class="{'bg-blue-100 text-blue-800': video.purpose === 'sell',
                                                          'bg-purple-100 text-purple-800': video.purpose === 'funding',
                                                          'bg-gray-100 text-gray-800': video.purpose === 'agristream'}">
                                                {{ video.purpose === 'sell' ? 'For Sale' :
                                                   video.purpose === 'funding' ? 'Funding' : 'General' }}
                                            </span>
                                            <span class="text-xs text-gray-400">{{ formatTimestamp(video.uploadDate, true) }}</span>
                                        </div>
                                        <div class="mt-2 text-xs">
                                            <p class="text-gray-500 truncate">CID: {{ video.cid }}</p>
                                            <p class="text-gray-400 truncate">Hash: {{ video.videoFileHash ? video.videoFileHash.substring(0,16) + '...' : 'N/A' }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Active Listings Section (For Farmers) -->
                    <div v-if="role === 'farmer'" class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
                        <div class="bg-gray-50 px-6 py-4 border-b">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                <i class="fas fa-tags mr-2 text-green-600"></i>
                                Your Active Listings ({{ farmerListings.filter(l=>l.status === 'active').length }})
                            </h3>
                        </div>
                        <div class="p-6">
                            <div v-if="farmerListings.filter(l=>l.status === 'active').length === 0" class="text-center py-8 text-gray-500">
                                <i class="fas fa-store-slash text-4xl mb-3"></i>
                                <p>No active listings</p>
                                <button @click="switchPage('farmerSell')" class="mt-2 text-green-600 hover:text-green-700">
                                    Create your first listing
                                </button>
                            </div>
                            <div v-else class="overflow-x-auto">
                                <table class="min-w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Crop</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pesticide Co.</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price Range (SOL)</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <tr v-for="listing in farmerListings.filter(l=>l.status === 'active')" :key="listing._id">
                                            <td class="px-4 py-4 whitespace-nowrap">
                                                <div class="font-medium text-gray-900">{{ listing.crop }}</div>
                                                <div class="text-xs text-gray-500">CID: {{ listing.cid.substring(0,8) }}...</div>
                                            </td>
                                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ listing.location }}</td>
                                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ listing.pesticideCompany || 'N/A' }}</td>
                                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">{{ listing.minPrice }} - {{ listing.maxPrice }}</td>
                                            <td class="px-4 py-4 whitespace-nowrap">
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                                    Active
                                                </span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Funding Requests Section (For Farmers) -->
                    <div v-if="role === 'farmer'" class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
                        <div class="bg-gray-50 px-6 py-4 border-b">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                <i class="fas fa-hand-holding-usd mr-2 text-purple-600"></i>
                                Your Funding Requests ({{ farmerFundingRequests.length }})
                            </h3>
                        </div>
                        <div class="p-6">
                            <div v-if="farmerFundingRequests.length === 0" class="text-center py-8 text-gray-500">
                                <i class="fas fa-seedling text-4xl mb-3"></i>
                                <p>No funding requests created</p>
                                <button @click="switchPage('farmerFunding')" class="mt-2 text-purple-600 hover:text-purple-700">
                                    Create funding request
                                </button>
                            </div>
                            <div v-else class="space-y-4">
                                <div v-for="request in farmerFundingRequests" :key="request._id"
                                     class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                                    <div class="flex justify-between items-start mb-3">
                                        <div>
                                            <h4 class="font-semibold text-lg">{{ request.title }}</h4>
                                            <p class="text-sm text-gray-600">{{ request.crop }} • {{ request.acres }} acres • {{ request.method }}</p>
                                        </div>
                                        <span class="px-3 py-1 rounded-full text-xs font-medium"
                                              :class="{'bg-yellow-100 text-yellow-800': request.status === 'pending',
                                                      'bg-green-100 text-green-800': request.status === 'funded',
                                                      'bg-blue-100 text-blue-800': request.status === 'partially_funded'}">
                                            {{ request.status === 'pending' ? 'Seeking Funding' :
                                               request.status === 'funded' ? 'Fully Funded' : 'Partially Funded' }}
                                        </span>
                                    </div>

                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-3">
                                        <div>
                                            <p class="text-xs text-gray-500">Required</p>
                                            <p class="font-semibold">{{ request.amount }} SOL</p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-500">Raised</p>
                                            <p class="font-semibold text-green-600">{{ request.fundedAmount || 0 }} SOL</p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-500">Timeline</p>
                                            <p class="font-semibold">{{ request.timeline }} months</p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-500">Expected ROI</p>
                                            <p class="font-semibold text-green-600">{{ request.roi }}%</p>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="flex justify-between text-sm mb-1">
                                            <span>Funding Progress</span>
                                            <span>{{ fundingProgressPercent(request) }}%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="bg-green-500 h-2 rounded-full"
                                                 :style="{width: fundingProgressPercent(request) + '%'}"></div>
                                        </div>
                                    </div>

                                    <div class="text-xs text-gray-500">
                                        <p>CID: {{ request.cid }}</p>
                                        <p>Created: {{ formatTimestamp(request.createdAt, false) }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Transaction History Section -->
                    <div class="bg-white rounded-lg shadow-md overflow-hidden mb-6">
                        <div class="bg-gray-50 px-6 py-4 border-b">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                <i class="fas fa-history mr-2 text-blue-600"></i>
                                Transaction History
                            </h3>
                        </div>
                        <div class="p-6">
                            <!-- Farmer Sales -->
                            <div v-if="role === 'farmer' && farmerSales.length > 0" class="mb-6">
                                <h4 class="font-medium text-gray-700 mb-3 flex items-center">
                                    <i class="fas fa-dollar-sign mr-2 text-green-500"></i>
                                    Sales Made ({{ farmerSales.length }})
                                </h4>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full">
                                        <thead class="bg-green-50">
                                            <tr>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Crop</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Buyer</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Amount</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Date</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-200">
                                            <tr v-for="sale in farmerSales" :key="sale._id">
                                                <td class="px-4 py-3 text-sm">{{ sale.crop }}</td>
                                                <td class="px-4 py-3 text-sm font-mono">{{ getFarmerDisplayIdentifier(sale.buyerWallet, 12) }}</td>
                                                <td class="px-4 py-3 text-sm font-semibold text-green-600">{{ sale.price }} SOL</td>
                                                <td class="px-4 py-3 text-sm">{{ formatTimestamp(sale.saleDate, true) }}</td>
                                                <td class="px-4 py-3 text-sm">
                                                    <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">Completed</span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Buyer Purchases -->
                            <div v-if="role === 'buyer' && buyerPurchases.length > 0" class="mb-6">
                                <h4 class="font-medium text-gray-700 mb-3 flex items-center">
                                    <i class="fas fa-shopping-cart mr-2 text-blue-500"></i>
                                    Purchases Made ({{ buyerPurchases.length }})
                                </h4>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full">
                                        <thead class="bg-blue-50">
                                            <tr>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Crop</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Seller</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Amount</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Date</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-200">
                                            <tr v-for="purchase in buyerPurchases" :key="purchase._id">
                                                <td class="px-4 py-3 text-sm">{{ purchase.crop }}</td>
                                                <td class="px-4 py-3 text-sm font-mono">{{ getFarmerDisplayIdentifier(purchase.farmerWallet, 12) }}</td>
                                                <td class="px-4 py-3 text-sm font-semibold text-blue-600">{{ purchase.price }} SOL</td>
                                                <td class="px-4 py-3 text-sm">{{ formatTimestamp(purchase.purchaseDate, true) }}</td>
                                                <td class="px-4 py-3 text-sm">
                                                    <button @click="selectedPurchase = purchase; showPurchaseVideo = true"
                                                            class="text-blue-600 hover:text-blue-800 text-xs">
                                                        View Video
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Investor Investments -->
                            <div v-if="role === 'investor' && investorInvestments.length > 0" class="mb-6">
                                <h4 class="font-medium text-gray-700 mb-3 flex items-center">
                                    <i class="fas fa-coins mr-2 text-purple-500"></i>
                                    Investments Made ({{ investorInvestments.length }})
                                </h4>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full">
                                        <thead class="bg-purple-50">
                                            <tr>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Project</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Farmer</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Amount</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Expected Return</th>
                                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-200">
                                            <tr v-for="investment in investorInvestments" :key="investment._id">
                                                <td class="px-4 py-3 text-sm">{{ investment.projectTitle }}</td>
                                                <td class="px-4 py-3 text-sm font-mono">{{ getFarmerDisplayIdentifier(investment.farmerWallet, 12) }}</td>
                                                <td class="px-4 py-3 text-sm font-semibold text-purple-600">{{ investment.amount }} SOL</td>
                                                <td class="px-4 py-3 text-sm font-semibold text-green-600">{{ calculateExpectedReturn(investment) }} SOL</td>
                                                <td class="px-4 py-3 text-sm">
                                                    <span class="px-2 py-1 rounded-full text-xs"
                                                          :class="{'bg-blue-100 text-blue-800': investment.status === 'active',
                                                                  'bg-green-100 text-green-800': investment.status === 'harvested',
                                                                  'bg-yellow-100 text-yellow-800': investment.status === 'growing'}">
                                                        {{ investment.status.charAt(0).toUpperCase() + investment.status.slice(1) }}
                                                    </span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- No Transactions Message -->
                            <div v-if="(role === 'farmer' && farmerSales.length === 0) ||
                                      (role === 'buyer' && buyerPurchases.length === 0) ||
                                      (role === 'investor' && investorInvestments.length === 0)"
                                 class="text-center py-8 text-gray-500">
                                <i class="fas fa-receipt text-4xl mb-3"></i>
                                <p>No transactions yet</p>
                                <p class="text-sm">Start {{ role === 'farmer' ? 'selling crops' : role === 'buyer' ? 'buying crops' : 'investing in projects' }} to see your transaction history</p>
                            </div>
                        </div>
                    </div>
                </section>
                <!-- Messaging Section -->
                <section v-if="current==='messaging'" class="max-w-6xl mx-auto mt-6">
                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4" role="alert">
                        <p class="font-bold">User: {{ currentUser ? currentUser.name : 'User' }} - Messaging</p>
                        <p class="text-sm">Chat with other users on the platform. Messages are stored locally in your browser.</p>
                    </div>
                    <div class="bg-white rounded-lg shadow-md flex" style="height: calc(100vh - 200px);">
                        <div class="w-full md:w-1/3 border-r flex flex-col bg-gray-50">
                            <div class="p-4 border-b">
                                <h2 class="text-xl font-semibold text-green-700">Conversations</h2>
                            </div>
                            <div class="overflow-y-auto flex-1">
                                <div v-if="!userConversations || userConversations.length === 0" class="p-4 text-center text-gray-500 mt-10">
                                    <i class="fas fa-comment-slash fa-3x mb-3 text-gray-300"></i>
                                    <p>No conversations yet.</p>
                                    <p class="text-xs mt-1">Start a chat from a user's profile or project.</p>
                                </div>
                                <div v-else v-for="conv in userConversations" :key="conv._id" @click="selectConversation(conv._id)"
                                     class="p-3 hover:bg-gray-100 cursor-pointer border-b flex items-center space-x-3"
                                     :class="{'bg-green-100 border-l-4 border-green-500': activeConversationId === conv._id, 'bg-white': activeConversationId !== conv._id}">
                                    <div class="w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center text-lg flex-shrink-0">
                                        {{ getOtherParticipantInitial(conv) }}
                                    </div>
                                    <div class="flex-1 overflow-hidden">
                                        <div class="font-semibold text-gray-800 truncate">{{ getOtherParticipantDisplayAddress(conv) }}</div>
                                        <div class="text-xs text-gray-500 truncate">{{ conv.lastMessageSnippet || 'No messages yet' }}</div>
                                    </div>
                                    <div class="text-xs text-gray-400 self-start whitespace-nowrap">
                                        {{ formatTimestamp(conv.lastMessageTimestamp || Date.now(), true) }}
                                    </div>
                                    <div v-if="getUnreadCountForConversation(conv._id) > 0"
                                         class="bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs ml-auto flex-shrink-0">
                                        {{ getUnreadCountForConversation(conv._id) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="w-full md:w-2/3 flex flex-col bg-white">
                            <div v-if="!activeConversationId" class="flex-1 flex flex-col items-center justify-center text-gray-400 p-10 text-center">
                                <i class="fas fa-comments fa-4x mb-4"></i>
                                <h3 class="text-xl text-gray-600">Welcome to PestiVid Chat</h3>
                                <p>Select a conversation from the left to view messages, or start a new chat from a user's profile or project page.</p>
                            </div>
                            <template v-else>
                                <div class="p-4 border-b bg-gray-50 flex items-center sticky top-0 z-10">
                                    <div class="w-8 h-8 rounded-full bg-green-600 text-white flex items-center justify-center text-sm mr-3 flex-shrink-0">
                                        {{ activeConversationPartnerInitial || '?' }}
                                    </div>
                                    <h3 class="font-semibold text-lg text-green-800">{{ activeConversationPartnerDisplayAddress || 'Chat' }}</h3>
                                </div>
                                <div class="flex-1 overflow-y-auto p-4 space-y-3 message-view-container bg-gray-100" ref="messageContainer">
                                    <div v-if="!currentMessages || currentMessages.length === 0" class="text-center text-gray-500 py-10">
                                        No messages in this conversation yet. Say hello!
                                    </div>
                                    <div v-else v-for="msg in currentMessages" :key="msg._id" class="flex"
                                         :class="msg.sender === currentUserIdentifier ? 'justify-end' : 'justify-start'">
                                        <div class="max-w-xs md:max-w-md lg:max-w-lg">
                                            <div class="p-3 rounded-xl shadow"
                                                 :class="msg.sender === currentUserIdentifier ? 'bg-green-600 text-white' : 'bg-white text-gray-800 border'">
                                                <p class="text-sm leading-relaxed">{{ msg.text }}</p>
                                            </div>
                                            <p class="text-xs mt-1 px-1"
                                               :class="msg.sender === currentUserIdentifier ? 'text-gray-400 text-right' : 'text-gray-400 text-left'">
                                                {{ formatTimestamp(msg.timestamp || Date.now()) }}
                                                <span v-if="msg.sender === currentUserIdentifier && msg.read">
                                                    <i class="fas fa-check-double text-blue-400 ml-1" title="Read"></i>
                                                </span>
                                                <span v-if="msg.sender === currentUserIdentifier && !msg.read">
                                                    <i class="fas fa-check text-gray-400 ml-1" title="Sent"></i>
                                                </span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="p-3 border-t bg-gray-50">
                                    <form @submit.prevent="sendMessage" class="flex gap-3 items-center">
                                        <input v-model="messageInputText" type="text" placeholder="Type your message..."
                                               class="flex-1 px-4 py-2 border border-gray-300 rounded-full focus:ring-green-500 focus:border-green-500 text-sm" required>
                                        <button type="submit" :disabled="!messageInputText || !messageInputText.trim()"
                                                class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-full text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 disabled:opacity-50">
                                            <i class="fas fa-paper-plane mr-1"></i> Send
                                        </button>
                                    </form>
                                </div>
                            </template>
                        </div>
                    </div>
                </section>

                <!-- NEW Plant Analysis Section (for potato leaf) -->
                <section v-if="current==='plantAnalysis'" class="max-w-6xl mx-auto mt-6">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-2xl font-bold text-green-700"><i class="fas fa-leaf mr-2"></i>Plant Disease Analysis</h2>
                    </div>
                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4" role="alert">
                        <p class="font-bold">Plant Disease Detection (Potato Leaf)</p>
                        <p class="text-sm">Upload an image of a potato plant leaf to detect diseases and get treatment recommendations. This feature connects to an AI model.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Image Upload Section -->
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold text-green-700 mb-4">Upload Plant Image</h3>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Select a clear image of the plant leaf
                                </label>
                                <input type="file"
                                       accept="image/*"
                                       @change="handlePlantImageUpload"
                                       class="block w-full text-sm text-gray-500
                                              file:mr-4 file:py-2 file:px-4
                                              file:rounded-full file:border-0
                                              file:text-sm file:font-semibold
                                              file:bg-green-50 file:text-green-700
                                              hover:file:bg-green-100">
                            </div>
                            <div v-if="plantImageFile && plantImageUrl" class="mb-4">
                                <p class="text-sm text-gray-600 mb-2">Selected image:</p>
                                <div class="relative bg-gray-100 rounded-lg overflow-hidden" style="height: 200px;">
                                    <img :src="plantImageUrl"
                                         class="absolute inset-0 w-full h-full object-contain"
                                         alt="Selected plant image">
                                </div>
                            </div>
                            <button @click="analyzePlant"
                                    :disabled="!plantImageFile || analysisInProgress"
                                    class="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded text-sm flex items-center justify-center"
                                    :class="{'opacity-50 cursor-not-allowed': !plantImageFile || analysisInProgress}">
                                <i :class="analysisInProgress ? 'fas fa-spinner fa-spin' : 'fas fa-search-plus'" class="mr-2"></i>
                                {{ analysisInProgress ? 'Analyzing...' : 'Analyze Plant' }}
                            </button>
                        </div>
                        <!-- Analysis Results Section -->
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <h3 class="text-lg font-semibold text-green-700 mb-4">Analysis Results</h3>
                            <div v-if="analysisInProgress" class="flex flex-col items-center justify-center py-10">
                                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-700"></div>
                                <p class="mt-3 text-gray-600">Analyzing plant image...</p>
                            </div>
                            <div v-else-if="analysisErrorText" class="bg-red-50 border-l-4 border-red-500 text-red-700 p-4 rounded">
                                <p class="font-bold">Analysis Error</p>
                                <p>{{ analysisErrorText }}</p>
                            </div>
                            <div v-else-if="parsedAnalysis.diseaseName" class="space-y-4">
                                <div class="p-4 bg-gray-50 rounded-lg">
                                    <div class="flex items-center mb-3">
                                        <span class="font-semibold w-32">Plant:</span>
                                        <span>{{ parsedAnalysis.plantName }}</span>
                                    </div>
                                    <div class="flex items-center mb-3">
                                        <span class="font-semibold w-32">Disease:</span>
                                        <span :class="{'text-green-600': parsedAnalysis.diseaseName === 'Healthy' || (parsedAnalysis.diseaseName && parsedAnalysis.diseaseName.toLowerCase().includes('healthy')), 'text-red-600 font-bold': parsedAnalysis.diseaseName && parsedAnalysis.diseaseName !== 'Healthy' && !parsedAnalysis.diseaseName.toLowerCase().includes('healthy')}">
                                            {{ parsedAnalysis.diseaseName }}
                                        </span>
                                    </div>
                                    <div class="flex items-center mb-3">
                                        <span class="font-semibold w-32">Confidence:</span>
                                        <span>{{ parsedAnalysis.confidence }}</span>
                                    </div>
                                </div>
                                <div v-if="parsedAnalysis.treatmentRecommended" class="p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded-lg">
                                    <p class="font-semibold mb-2">Treatment Recommendation:</p>
                                    <p class="text-sm">{{ parsedAnalysis.treatmentRecommended }}</p>
                                </div>
                                <div v-if="analysisResultText && (!parsedAnalysis.plantName || !parsedAnalysis.diseaseName)" class="mt-4 bg-gray-50 p-3 rounded border text-xs">
                                    <p class="font-semibold mb-1">Raw AI Output (for debugging if parsing failed):</p>
                                    <pre class="whitespace-pre-wrap overflow-x-auto">{{ analysisResultText }}</pre>
                                </div>
                            </div>
                            <div v-else class="flex flex-col items-center justify-center py-10 text-gray-500">
                                <i class="fas fa-leaf text-4xl mb-3"></i>
                                <p>Upload and analyze a plant image to see results</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Farmer Chatbot Section (AgriBot) -->
                <section v-if="current==='farmerChatbot'" class="max-w-3xl mx-auto mt-6">
                    <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-robot mr-2"></i>AgriBot - Your Farming Assistant</h2>
                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4" role="alert">
                        <p class="font-bold">User: {{ currentUser ? currentUser.name : 'Farmer' }} (Role: Farmer)</p>
                        <p class="text-sm">Chat with AgriBot about farming questions. AI responses are powered by a live backend.</p>
                    </div>
                    <div class="bg-white rounded shadow-md chatbot-container">
                        <div class="chatbot-messages" ref="chatbotMessagesContainer">
                            <div v-for="msg in chatMessages" :key="msg._id" :class="['chat-message', msg.sender]">
                                <div class="message-content">
                                    <div class="avatar">
                                        <i :class="msg.sender === 'user' ? 'fas fa-user' : 'fas fa-robot'"></i>
                                    </div>
                                    <div class="message-bubble" v-html="renderMarkdown(msg.text)"></div>
                                </div>
                            </div>
                            <div v-if="isGroqLoading" class="chat-message bot">
                                <div class="message-content">
                                    <div class="avatar"><i class="fas fa-robot"></i></div>
                                    <div class="message-bubble typing-indicator">
                                        <span></span><span></span><span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="chatbot-input-area">
                            <input type="text" v-model="chatInput" @keyup.enter="sendChatMessage" placeholder="Ask AgriBot about farming..." :disabled="isGroqLoading">
                            <button @click="sendChatMessage" :disabled="isGroqLoading || !chatInput.trim()">
                                <i class="fas fa-paper-plane mr-1"></i> Send
                            </button>
                        </div>
                    </div>
                </section>
            </div> <!-- End Main Content Sections Wrapper -->

            <!-- Modals (Purchase Video, Buy Listing, Investment Details, Farmer Profile) -->
            <div v-if="selectedPurchase && showPurchaseVideo" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full modal-scrollable">
                <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white z-10"> <h3 class="font-bold text-lg text-green-700">{{ selectedPurchase.crop }} - Purchase Verification</h3> <button @click="showPurchaseVideo = false" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times"></i> </button> </div>
                <div class="p-4">
                    <video :src="getVideoUrl(selectedPurchase.cid, selectedPurchase.videoStorageType || 'ipfs')" controls playsinline webkit-playsinline class="w-full rounded bg-black mb-4"></video>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div> <p class="text-gray-600">Location</p> <p class="font-medium">{{ selectedPurchase.location }}</p> </div>
                        <div> <p class="text-gray-600">Pesticide Used</p> <p class="font-medium">{{ selectedPurchase.pesticide }}</p> </div>
                        <div> <p class="text-gray-600">Pesticide Company</p> <p class="font-medium">{{ selectedPurchase.pesticideCompany || 'N/A' }}</p> </div>
                        <div> <p class="text-gray-600">Purchase Price</p> <p class="font-medium font-mono">{{ selectedPurchase.price }} SOL</p> </div>
                        <div> <p class="text-gray-600">Purchase Date</p> <p class="font-medium">{{ formatTimestamp(selectedPurchase.purchaseDate, false) }}</p> </div>
                        <div> <p class="text-gray-600">Seller Identifier</p> <p class="font-medium font-mono text-xs">{{ selectedPurchase.farmerWallet }}</p> </div>
                        <div>
                            <p class="text-gray-600">Video File Hash (SHA256)</p>
                            <p class="font-medium font-mono text-xs break-all" :title="selectedPurchase.videoFileHash || 'N/A'">{{ selectedPurchase.videoFileHash || 'N/A' }}</p>
                        </div>
                    </div>
                    <div class="mt-4 bg-gray-100 p-3 rounded text-xs border">
                        <p class="font-bold mb-1">Platform Verification (Simulated):</p>
                        <p class="font-mono break-all mb-1">Video CID ({{selectedPurchase.videoStorageType || 'ipfs'}}): {{ selectedPurchase.cid }}</p>
                        <p class="font-mono break-all">Real-time Tx: {{ selectedPurchase.txHash }} <a :href="avalancheExplorerUrl(selectedPurchase.txHash)" target="_blank" class="text-blue-500 hover:text-blue-700"><i class="fas fa-external-link-alt text-xs"></i></a> </p>
                        <p class="mt-1 text-gray-500">Video evidence on {{ (selectedPurchase.videoStorageType || 'ipfs').toUpperCase() }}, linked on PestiVid platform (Simulated).</p>
                        <a :href="getVideoUrl(selectedPurchase.cid, selectedPurchase.videoStorageType || 'ipfs')" target="_blank" class="text-blue-600 hover:underline mt-1 inline-block">View on {{ (selectedPurchase.videoStorageType || 'ipfs').toUpperCase() }} Gateway <i class="fas fa-external-link-alt text-xs ml-1"></i></a>
                    </div>
                </div>
                <div class="bg-gray-50 p-4 flex justify-end rounded-b-lg sticky bottom-0 border-t"> <button @click="showPurchaseVideo = false" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded text-sm"> Close </button> </div>
            </div>
            </div>
            <div v-if="showBuyModal && selectedListing" class="fixed inset-0 z-50 bg-black bg-opacity-60 flex justify-center items-center p-4">
            <div class="bg-white rounded shadow-lg w-full max-w-sm p-6 relative mx-2 modal-scrollable">
                <button class="absolute top-2 right-2 text-gray-400 hover:text-red-500" @click="closeBuyModal"><i class="fas fa-times"></i></button>
                <h3 class="font-bold text-green-700 text-lg mb-3">Purchase Crop Batch</h3>
                <video :src="getVideoUrl(selectedListing.cid, selectedListing.storageType || 'ipfs')" controls playsinline webkit-playsinline class="rounded w-full mb-3 bg-black"></video>
                <div class="mb-1 font-bold">{{ selectedListing.crop }}</div>
                <div class="text-xs text-gray-600 mb-1">Location: <span class="font-mono">{{ selectedListing.location }}</span></div>
                <div class="text-xs text-gray-500 mb-1">Pesticide: <span class="font-mono">{{ selectedListing.pesticide }}</span></div>
                <div class="text-xs text-gray-500 mb-2">Pesticide Co.: <span class="font-mono">{{ selectedListing.pesticideCompany || 'N/A' }}</span></div>
                <div class="text-xs text-gray-400 mb-2">File Hash: <span class="font-mono break-all" :title="selectedListing.videoFileHash || 'N/A'">{{ selectedListing.videoFileHash ? selectedListing.videoFileHash.substring(0,10) + '...' : 'N/A' }}</span></div>
                <div class="text-sm my-2">Price Range: <br><span class="mx-1 font-mono font-semibold">{{ selectedListing.minPrice }}</span> - <span class="ml-1 font-mono font-semibold">{{ selectedListing.maxPrice }}</span> AVAX</div>
                <form @submit.prevent="processPurchase"> <label class="text-sm block text-gray-600 mb-1">Your Offer (AVAX)</label> <input type="number" v-model.number="purchaseAmount" :min="selectedListing.minPrice" :max="selectedListing.maxPrice" step="0.0001" required :placeholder="`Enter amount (${selectedListing.minPrice}-${selectedListing.maxPrice})`" class="w-full px-3 py-2 border rounded mb-3 text-sm"> <button type="submit" class="bg-green-600 hover:bg-green-700 text-white w-full py-2 rounded text-sm" :disabled="role !== 'buyer'"> <i class="fas fa-check mr-1"></i>Confirm Purchase </button> </form>
                <div v-if="purchaseStatus" class="text-green-700 font-semibold mt-3 text-sm bg-green-50 p-2 rounded border border-green-200">{{purchaseStatus}}</div> <div v-if="purchaseError" class="text-red-600 font-semibold mt-3 text-sm bg-red-50 p-2 rounded border border-red-200">{{purchaseError}}</div>
            </div>
            </div>
            <div v-if="showInvestmentDetailsModal && selectedInvestment" class="fixed inset-0 z-50 bg-black bg-opacity-70 flex justify-center items-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl relative mx-2 modal-scrollable">
                <div class="p-4 bg-green-50 border-b flex justify-between items-center sticky top-0 z-10"> <h3 class="font-bold text-lg text-green-800">{{ selectedInvestment.projectTitle }}</h3> <button class="text-gray-400 hover:text-red-500" @click="showInvestmentDetailsModal=false"><i class="fas fa-times"></i></button> </div>
                <div class="p-6"> <div class="flex flex-col md:flex-row gap-6"> <div class="md:w-1/3"> <video :src="getVideoUrl(selectedInvestment.cid, selectedInvestment.videoStorageType || 'ipfs')" controls playsinline webkit-playsinline class="rounded w-full h-40 object-cover bg-black mb-3"></video> <div class="mt-3 space-y-2 text-sm"> <div> <div class="text-xs text-gray-500">Farmer Identifier</div> <div class="font-medium flex items-center font-mono text-xs"> <span>{{ getFarmerDisplayIdentifier(selectedInvestment.farmerWallet) }}</span> <button @click="showFarmerProfile(selectedInvestment.farmerWallet); showInvestmentDetailsModal=false;" class="ml-2 text-blue-500 hover:text-blue-700 text-xs focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> <button @click="startOrGoToConversation(selectedInvestment.farmerWallet); showInvestmentDetailsModal=false;" v-if="currentUserIdentifier !== selectedInvestment.farmerWallet" class="ml-2 text-green-600 hover:text-green-700 text-xs focus:outline-none" title="Message Farmer"> <i class="fas fa-envelope"></i> </button> </div> </div> <div> <div class="text-xs text-gray-500">Investment Date</div> <div class="font-medium">{{ formatTimestamp(selectedInvestment.investmentDate, false) }}</div> </div> <div> <div class="text-xs text-gray-500">Amount Invested</div> <div class="font-medium text-green-700 font-mono">{{ selectedInvestment.amount }} SOL</div> </div> <div> <div class="text-xs text-gray-500">Status</div> <span :class="{'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true, 'bg-blue-100 text-blue-800': selectedInvestment.status === 'active', 'bg-green-100 text-green-800': selectedInvestment.status === 'harvested', 'bg-yellow-100 text-yellow-800': selectedInvestment.status === 'growing'}"> {{ selectedInvestment.status.charAt(0).toUpperCase() + selectedInvestment.status.slice(1) }} </span> </div> </div> </div> <div class="md:w-2/3"> <div class="mb-4"> <div class="text-sm font-medium mb-1">{{ selectedInvestment.crop }} ({{ selectedInvestment.method }})</div> <p class="text-sm text-gray-700 max-h-24 overflow-y-auto border p-2 rounded bg-gray-50">{{ selectedInvestment.description }}</p> </div> <div class="mb-4"> <div class="text-xs text-gray-500 mb-1">Project Progress</div> <div class="progress-bar"> <div class="progress-fill bg-green-500" :style="{width: selectedInvestment.progress + '%'}"></div> </div> <div class="flex justify-between text-xs mt-1"> <span>{{ selectedInvestment.progress }}% Complete</span> <span>Est. {{ selectedInvestment.timeline }} months total</span> </div> </div>
                                <div v-if="selectedInvestment.updates && selectedInvestment.updates.length > 0" class="mb-4">
                                    <h4 class="text-sm font-semibold text-gray-700 mb-2">Farmer Updates</h4>
                                    <div class="project-updates-list text-xs">
                                        <div v-for="(update, index) in selectedInvestment.updates.slice().reverse()" :key="update._id || index" class="project-update-item">
                                            <span class="font-medium text-gray-500">{{ formatTimestamp(update.date, true) }}:</span> {{ update.text }}
                                        </div>
                                    </div>
                                </div>
                                <div v-else class="mb-4 text-xs text-gray-500"> No project updates posted by the farmer yet. </div>
                                <div class="grid grid-cols-2 gap-4 mb-4 text-sm"> <div> <div class="text-xs text-gray-500">Expected Return</div> <div class="font-medium text-green-700 font-mono">{{ calculateExpectedReturn(selectedInvestment) }} SOL</div> </div> <div> <div class="text-xs text-gray-500">ROI</div> <div class="font-medium text-green-700">{{ selectedInvestment.roi }}%</div> </div> <div> <div class="text-xs text-gray-500">Land Size</div> <div class="font-medium">{{ selectedInvestment.acres }} acres</div> </div> <div> <div class="text-xs text-gray-500">Your Share</div> <div class="font-medium">{{ selectedInvestment.investorShare }}%</div> </div> <div> <div class="text-xs text-gray-500">Video File Hash</div> <p class="font-medium font-mono text-xs break-all" :title="selectedInvestment.videoFileHash || 'N/A'">{{ selectedInvestment.videoFileHash ? selectedInvestment.videoFileHash.substring(0,10) + '...' : 'N/A' }}</p> </div> </div> <div class="bg-gray-100 p-3 rounded mb-4 border"> <div class="text-sm font-medium mb-1">Platform Transaction (Simulated)</div> <div class="flex items-center text-xs"> <span class="font-mono bg-white px-2 py-1 rounded border mr-2 truncate" :title="selectedInvestment.txHash">{{ selectedInvestment.txHash }}</span> <a :href="solanaExplorerUrl(selectedInvestment.txHash)" target="_blank" class="text-blue-600 hover:underline whitespace-nowrap"> <i class="fas fa-external-link-alt"></i> View (Demo Link) </a> </div> </div> <div v-if="selectedInvestment.status === 'harvested'" class="bg-green-100 p-3 rounded border border-green-200"> <div class="flex items-center"> <i class="fas fa-check-circle text-green-600 mr-2 text-lg"></i> <div> <div class="font-medium">Harvest Completed & Payout Processed</div> <div class="text-sm">Your return of {{ calculateExpectedReturn(selectedInvestment) }} SOL has been simulated.</div> </div> </div> </div> <div v-else-if="selectedInvestment.status === 'growing'" class="bg-yellow-50 p-3 rounded border border-yellow-200"> <div class="flex items-center"> <i class="fas fa-hourglass-half text-yellow-600 mr-2 text-lg"></i> <div> <div class="font-medium">Project Growing</div> <div class="text-sm">Harvest expected within {{ selectedInvestment.timeline }} months. Progress: {{selectedInvestment.progress}}%.</div> </div> </div> </div> </div> </div> </div>
                <div class="bg-gray-50 p-4 flex justify-end rounded-b-lg sticky bottom-0 border-t"> <button @click="showInvestmentDetailsModal=false" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded text-sm"> Close </button> </div>
            </div>
            </div>
            <div v-if="showFarmerProfileModal && selectedFarmerProfile" class="fixed inset-0 z-50 bg-black bg-opacity-70 flex justify-center items-center p-4">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl relative mx-2 modal-scrollable">
                <div class="p-4 bg-green-50 border-b flex justify-between items-center sticky top-0 z-10">
                    <h3 class="font-bold text-lg text-green-800 flex items-center">
                        <i class="fas fa-user-tie mr-2"></i> Farmer Profile
                    </h3>
                    <button class="text-gray-400 hover:text-red-500" @click="closeFarmerProfileModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-6 space-y-5">
                    <div class="flex items-center space-x-4">
                        <div class="bg-green-100 rounded-full w-16 h-16 flex items-center justify-center text-green-600 text-2xl">
                            <i class="fas fa-tractor"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-xs text-gray-500">Farmer Identifier (PestiVid ID)</p>
                            <p class="font-semibold text-lg text-green-700 font-mono">{{ selectedFarmerProfile.walletAddress ? selectedFarmerProfile.walletAddress.substring(0,10) + '...' : 'N/A' }}</p>
                            <p class="text-sm text-gray-600">Name: {{ selectedFarmerProfile.name || 'N/A' }}</p>
                            <p class="text-xs text-gray-500 mt-1">Role: {{ selectedFarmerProfile.role || 'Farmer' }}</p>
                        </div>
                    </div>

                    <div class="border-t pt-4">
                        <p class="text-xs text-gray-500">Short Bio</p>
                        <p class="text-sm text-gray-700 italic">{{ selectedFarmerProfile.bio || 'This farmer has not provided a bio yet.' }}</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-4">
                        <div>
                            <p class="text-xs text-gray-500">PestiVid Email</p>
                            <p class="text-sm">{{ selectedFarmerProfile.email || 'N/A' }}</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500">PestiVid Member Since</p>
                            <p class="text-sm">{{ formatTimestamp(selectedFarmerProfile.memberSince, false) }}</p>
                        </div>
                    </div>

                    <div class="border-t pt-4">
                        <p class="text-sm font-medium text-gray-700 mb-3">Platform Activity:</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                            <div class="bg-blue-50 p-3 rounded-md text-center">
                                <p class="font-semibold text-blue-700 text-lg">{{ selectedFarmerProfile.fundingRequestCount || 0 }}</p>
                                <p class="text-xs text-blue-600">Funding Requests</p>
                            </div>
                            <div class="bg-green-50 p-3 rounded-md text-center">
                                <p class="font-semibold text-green-700 text-lg">{{ selectedFarmerProfile.activeListingCount || 0 }}</p>
                                <p class="text-xs text-green-600">Active Listings</p>
                            </div>
                            <div class="bg-purple-50 p-3 rounded-md text-center">
                                <p class="font-semibold text-purple-700 text-lg">{{ getFarmerVideoCount(selectedFarmerProfile.walletAddress || selectedFarmerProfile._id) }}</p>
                                <p class="text-xs text-purple-600">Videos Uploaded</p>
                            </div>
                            <div class="bg-yellow-50 p-3 rounded-md text-center">
                                <p class="font-semibold text-yellow-700 text-lg">{{ getFarmerTotalInvestments(selectedFarmerProfile.walletAddress || selectedFarmerProfile._id) }}</p>
                                <p class="text-xs text-yellow-600">SOL Raised</p>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-2">(Note: Activity based on currently visible items on the platform.)</p>
                    </div>

                    <div class="border-t pt-4">
                        <p class="text-sm font-medium text-gray-700 mb-3">Recent Projects:</p>
                        <div class="space-y-2 max-h-32 overflow-y-auto">
                            <div v-for="project in getFarmerRecentProjects(selectedFarmerProfile.walletAddress || selectedFarmerProfile._id)" :key="project._id" class="bg-gray-50 p-2 rounded text-sm">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium">{{ project.title || project.crop }}</span>
                                    <span class="text-xs text-gray-500">{{ project.amount }} SOL</span>
                                </div>
                                <div class="text-xs text-gray-600 mt-1">{{ project.method }} • {{ project.acres }} acres</div>
                            </div>
                            <div v-if="getFarmerRecentProjects(selectedFarmerProfile.walletAddress || selectedFarmerProfile._id).length === 0" class="text-xs text-gray-500 text-center py-2">
                                No recent projects found
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 p-4 flex justify-between items-center rounded-b-lg sticky bottom-0 border-t">
                    <div class="flex gap-2">
                        <button @click="messageFarmerFromProfile" v-if="selectedFarmerProfile && currentUserIdentifier !== (selectedFarmerProfile.walletAddress || selectedFarmerProfile._id)" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm">
                            <i class="fas fa-paper-plane mr-1"></i> Send Message
                        </button>
                        <button @click="viewFarmerProjects" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm">
                            <i class="fas fa-eye mr-1"></i> View Projects
                        </button>
                    </div>
                     <button @click="closeFarmerProfileModal" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded text-sm">
                        Close
                    </button>
                </div>
            </div>
            </div>

            <!-- Notification Toast Container -->
            <div class="notification-toast-container">
                <div v-for="n in recentNotifications" :key="n.id || n._id" class="notification-toast" :class="{'show': n.show}" :data-notif-id="n.id || n._id"> <span :class="['icon', 'icon-' + n.type]"> <i :class="n.type === 'success' ? 'fas fa-check-circle' : (n.type === 'info' ? 'fas fa-info-circle' : (n.type === 'warning' ? 'fas fa-exclamation-triangle' : 'fas fa-bug'))"></i> </span> <span class="message">{{ n.message }}</span> <button @click="dismissNotification(n.id || n._id)" class="close-btn">&times;</button> </div>
            </div>
            <!-- Loading/Transaction Modal -->
            <div v-if="showLoadingModal" class="loading-modal" @click="forceCloseLoadingModal">
                <div class="loading-content" @click.stop>
                    <i class="fas fa-spinner fa-spin"></i>
                    <p class="text-gray-700">{{ loadingMessage }}</p>
                    <p class="text-xs text-gray-500 mt-2">Click outside to force close if stuck</p>
                </div>
            </div>

            <!-- YouTube Video Popup Modal -->
            <div v-if="showYouTubePopup" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 youtube-popup-overlay" @click.self="closeYouTubePopup">
                <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full mx-4 overflow-hidden relative youtube-popup-content">
                    <!-- Close button -->
                    <button @click="closeYouTubePopup" class="absolute top-4 right-4 bg-black bg-opacity-50 hover:bg-opacity-70 text-white rounded-full w-10 h-10 flex items-center justify-center text-xl z-20 youtube-close-btn">
                        <i class="fas fa-times"></i>
                    </button>

                    <!-- Video Container -->
                    <div class="relative">
                        <div class="aspect-w-16 aspect-h-9">
                            <iframe
                                :src="'https://www.youtube.com/embed/' + youtubeVideoId + '?autoplay=1&rel=0&modestbranding=1'"
                                class="w-full h-96 md:h-[500px]"
                                frameborder="0"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                allowfullscreen>
                            </iframe>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div> <!-- End .flex-grow -->


  <!-- Footer -->
  <footer class="bg-white border-t py-6 mt-auto text-center text-sm text-gray-500">
    <span v-if="isAuthenticated">© {{ new Date().getFullYear() }} PestiVid • Blockchain Agricultural Platform (Role: {{ userRoleDisplay }})</span>
     <span v-else>© {{ new Date().getFullYear() }} PestiVid • Blockchain Agricultural Platform</span>
  </footer>

  <!-- Interactive Avatar Assistant -->
  <div v-if="avatar.visible && isAuthenticated"
        :class="['fixed z-[9998] p-2 flex flex-col items-end', avatar.position === 'bottom-right' ? 'bottom-4 right-4' : 'bottom-4 left-4']"
        style="transition: all 0.3s ease;">

      <div v-show="avatar.expanded"
          class="bg-white w-80 md:w-96 h-96 max-h-[70vh] mb-2 rounded-xl shadow-2xl flex flex-col overflow-hidden border border-gray-200">
          <header class="bg-green-600 text-white p-3 flex items-center justify-between">
              <div class="flex items-center">
                  <img :src="avatar.images[avatar.character]?.[avatar.state] || avatar.images.farmer.idle" alt="Avatar" class="w-8 h-8 rounded-full mr-2 border-2 border-white">
                  <h3 class="font-semibold">PestiVid Helper</h3>
              </div>
              <button @click="toggleAvatarExpansion(false)" class="text-green-100 hover:text-white">
                  <i class="fas fa-times"></i>
              </button>
          </header>

          <div class="flex-grow p-3 space-y-3 overflow-y-auto" ref="avatarMessagesContainer" style="scroll-behavior: smooth;">
              <div v-for="msg in avatar.chatMessages" :key="msg._id"
                  :class="['flex', msg.sender === 'user' ? 'justify-end' : 'justify-start']">
                  <div :class="['max-w-[80%] p-2.5 rounded-lg shadow-sm text-sm', msg.sender === 'user' ? 'bg-blue-500 text-white rounded-br-none' : 'bg-gray-100 text-gray-800 rounded-bl-none']"
                      v-html="renderMarkdown(msg.text)">
                  </div>
              </div>
              <div v-if="avatar.isProcessing && avatar.state === 'thinking'" class="flex justify-start">
                    <div class="bg-gray-100 text-gray-800 p-2.5 rounded-lg shadow-sm text-sm rounded-bl-none typing-indicator">
                      <span></span><span></span><span></span>
                    </div>
              </div>
          </div>

          <div v-if="avatar.quickActions.length > 0 && !avatar.isProcessing && !avatar.isListening" class="p-2 border-t border-gray-200 flex flex-wrap gap-2 justify-center">
              <button v-for="action in avatar.quickActions" :key="action.id"
                      @click="handleAvatarQuickAction(action)"
                      class="bg-green-100 text-green-700 px-3 py-1.5 text-xs rounded-full hover:bg-green-200 transition-colors">
                  {{ action.label }}
              </button>
          </div>

          <div class="p-3 border-t border-gray-200 bg-gray-50">
              <div class="flex items-center gap-2">
                   <button @click="toggleAvatarListening"
                          :disabled="avatar.isProcessing"
                          title="Toggle Voice Input"
                          class="avatar-input-mic-btn text-gray-500 hover:text-green-600 p-2 rounded-full focus:outline-none"
                          :class="{'text-red-500 listening': avatar.isListening}">
                      <i class="fas fa-microphone text-lg"></i>
                  </button>
                  <button @click="toggleTTS"
                         :title="avatar.ttsEnabled ? 'Disable Voice Output' : 'Enable Voice Output'"
                         class="text-gray-500 hover:text-blue-600 p-2 rounded-full focus:outline-none"
                         :class="{'text-blue-500': avatar.ttsEnabled, 'text-gray-400': !avatar.ttsEnabled}">
                      <i class="fas fa-volume-up text-lg" v-if="avatar.ttsEnabled"></i>
                      <i class="fas fa-volume-mute text-lg" v-else></i>
                  </button>
                  <input type="text" v-model="avatar.userInput"
                        @keyup.enter="sendAvatarMessage"
                        :placeholder="avatar.isListening ? 'Listening...' : (avatar.isProcessing ? 'Helper is thinking...' : 'Ask PestiVid Helper...')"
                        :disabled="avatar.isProcessing"
                        class="flex-grow px-3 py-2 border border-gray-300 rounded-full text-sm focus:ring-2 focus:ring-green-500 focus:border-green-500">
                  <button @click="sendAvatarMessage" :disabled="avatar.isProcessing || !avatar.userInput.trim()"
                          class="bg-green-600 hover:bg-green-700 text-white rounded-full w-10 h-10 flex items-center justify-center transition-opacity"
                          :class="{'opacity-50 cursor-not-allowed': avatar.isProcessing || !avatar.userInput.trim()}">
                      <i class="fas fa-paper-plane"></i>
                  </button>
              </div>
          </div>
      </div>

      <button @click="toggleAvatarExpansion()"
              class="w-16 h-16 rounded-full shadow-xl overflow-hidden focus:outline-none ring-4 ring-green-500/30 hover:ring-green-500/50 transition-all duration-300 relative"
              :class="[avatar.expanded ? 'transform scale-90 opacity-70' : 'transform scale-100 opacity-100', 'border-4 border-white']"
              :style="{ borderColor: avatar.expanded ? '#10B981' : 'white' }">
          <img :src="avatar.images[avatar.character]?.[avatar.state] || avatar.images.farmer.idle"
                alt="PestiVid Helper Avatar"
                class="w-full h-full object-cover transition-transform duration-500"
                :class="{'animate-pulse-slow': avatar.state === 'thinking'}">
            <span v-if="unreadAvatarMessagesCount > 0 && !avatar.expanded"
                class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-semibold rounded-full h-5 w-5 flex items-center justify-center shadow-md">
                {{ unreadAvatarMessagesCount }}
            </span>
      </button>
  </div>
</div> <!-- End #app -->
<script>
const app = new Vue({
el: "#app",
data: {
  // --- Backend API Configuration ---
  apiUrl: 'http://localhost:3002/api', // Main Node.js backend
  flaskApiUrl: 'http://localhost:5000', // Python (Flask) AI backend
  token: localStorage.getItem('pestivid_token') || null,

  // MongoDB Database Configuration
  mongodbEnabled: true,
  databaseConnected: false,
  authenticationMode: 'mongodb', // 'mongodb' or 'localStorage'

  // Simple blockchain configuration
  useTestnet: false,
  blockchainNetwork: 'ethereum',

  // Transport Database Configuration
  transportApiEndpoints: {
    providers: '/transport/providers',
    requests: '/transport/requests',
    payments: '/transport/payments',
    sync: '/transport/sync'
  },

  // MongoDB Transport Integration Status
  mongodbTransportEnabled: true,

  // --- Authentication State ---
  isAuthenticated: false,
  showSignup: false,
  showAuthModal: false, // Controls the login/signup modal
  currentUser: null, // { _id, name, email, role, phone, memberSince, pestividId (simulated wallet) }
  loginForm: { email: '', password: '', remember: false },
  signupForm: { name: '', email: '', phone: '', role: '', password: '', confirmPassword: '', acceptTerms: false },

  // --- User Data (Real data from backend, wallet-based) ---
  users: [], // Will be populated from backend based on wallet addresses
  currentUserIdentifier: null,
  userName: '', userEmail: '', userPhone: '', memberSince: '',

  // --- Application Data (Simulated Backend Data, loaded from localStorage) ---
  farmerVideos: [],
  farmerListings: [],
  farmerFundingRequests: [],
  farmerTransportRequests: [],
  buyerTransportRequests: [],
  investorTransportRequests: [],
  farmerSales: [],
  buyerPurchases: [],
  investorInvestments: [],
  investorTransactions: [],
  allListings: [],
  allFundingRequests: [],
  allTransportRequests: [],
  transportProviders: [],
  currentTransporter: null,
  transportJobFilters: { crop: '', urgency: '', minPayment: null, area: '' },

  // --- Forms & Modals State ---
  recordForm: {crop:'', pesticide:'', location:'', pesticideCompany: '', purpose: 'agristream'},
  listingForm: {cid:'', minPrice:null, maxPrice:null, notifyBuyers: true},
  fundingForm: { title: '', crop: '', acres: null, amount: null, method: '', cid: '', description: '', timeline: null, roi: null, investorShare: null },
  transportForm: { crop: '', quantity: null, pickupLocation: '', deliveryLocation: '', pickupDate: '', urgency: '', instructions: '' },
  buyerTransportForm: { purchaseId: '', deliveryAddress: '', deliveryDate: '', urgency: '', instructions: '' },
  transporterForm: { name: '', phone: '', vehicle: '', capacity: null, ratePerKm: null, license: '', serviceAreas: [], description: '' },
  availableServiceAreas: ['Mumbai', 'Delhi', 'Bangalore', 'Chennai', 'Pune', 'Hyderabad', 'Kolkata', 'Ahmedabad', 'Jaipur', 'Lucknow', 'Kanpur', 'Nagpur'],
  buyerFilters: {crop:'', location:'', pesticideCompany: ''},
  investorFilters: {crop: '', method: '', minRoi: null, maxAmount: null},
  showBuyModal: false, selectedListing: null, purchaseAmount: null, purchaseStatus: '', purchaseError: '', createdListingId: null, listingNotificationSent: false,
  investmentAmounts: {}, investmentErrors: {},
  showInvestmentDetailsModal: false, selectedInvestment: null,
  showFarmerProfileModal: false, selectedFarmerProfile: null,
  showPurchaseVideo: false, selectedPurchase: null,
  createdFundingRequest: false,

  // --- Media & Upload State ---
  recordStream: null, recordMediaRecorder: null, recording: false, recordBlob: null, recordBlobUrl: '',
  showLive: false, uploadCid: '', uploading: false, uploadError: '',
  lastUploadedVideoPurpose: '', lastUploadedVideoFileHash: '',
  // ========================================================================
  // !!! CRITICAL: REPLACE THIS PINATA JWT WITH YOUR OWN !!!
  // Get your JWT from https://app.pinata.cloud/keys
  // Video uploads WILL FAIL if this is not your valid JWT.
  // ========================================================================
  pinataJwt: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiIwMGYyMjQxNy01ZDhjLTQ4YzgtODQwNi0zNTBlOTZkOGMwZTgiLCJlbWFpbCI6InNpbmR1a3VyaW1lZ2hhbmFAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6ImJlNzJjZTMwNDk5YTNmNWNkZDcxIiwic2NvcGVkS2V5U2VjcmV0IjoiYTE2YjJiZDE4ZjgyNmFiZmY2MGE0Mzk5Nzk2NTZkNzMzYjY5MDJlM2U0Y2JlOTcxNTJiYTVkMTM3ZTZkMTlmYiIsImV4cCI6MTc4MTQ1MjUzNX0.o-PFoSsBVlhUdgf74ZF5ynVDtODGP0IPiknDrE33h5g', // <<<<< REPLACE THIS!
  pinataGateway: 'gateway.pinata.cloud', // Using public Pinata gateway for better compatibility

  // --- Messaging State ---
  conversations: [],
  messages: [],
  activeConversationId: null, messageInputText: '',

  // --- Notifications State ---
  notifications: [],
  recentNotifications: [],

  // --- Basic Wallet State ---
  walletConnected: false,
  walletAddress: null,
  walletBalance: 0,
  walletType: null,
  walletListenersActive: true, // Control wallet event listeners to prevent conflicts
  realTimeMonitoring: false, // Real-time wallet monitoring status
  lastBalanceUpdate: null, // Timestamp of last balance update
  walletNetworkName: 'Avalanche', // Network name for display
  pendingTransactions: [], // Array of pending transactions
  transactionConfirmations: 1, // Number of confirmations to wait for

  // Smart contract addresses (will be updated after deployment)
  marketplaceProgram: 'PestVidMarketplace111111111111111111111111',
  fundingProgram: 'PestVidFunding1111111111111111111111111',

  // --- Global UI State ---
  current: 'landing', showMobileMenu: false, showLoadingModal: false, loadingMessage: '',
  showYouTubePopup: true,
  youtubeVideoId: 'CfMEYWrdi3M', // Same video as displayed on home page



  // --- Navigation/Highlighting ---
  targetAgriStreamVideoCid: null, highlightedAgriStreamVideoCid: null,

  // --- AI Features State ---
  // Plant analysis related properties
  plantImageFile: null,
  plantImageUrl: null, // For preview
  plantImageMimeType: null,
  analysisInProgress: false,
  analysisResultText: '', // Raw text from AI
  analysisErrorText: '',
  parsedAnalysis: { // Structured data from AI response
      plantName: null,
      diseaseName: null,
      confidence: null,
      treatmentRecommended: null
  },
  chatMessages: [], chatInput: '', isGroqLoading: false,
  groqSystemPrompt: "You are AgriBot, a knowledgeable and friendly AI assistant for farmers. Your expertise includes crop management (like tomatoes, strawberries, lettuce, peppers), pest and disease control (organic and conventional methods), soil health, irrigation, farm-to-market advice, and general agricultural best practices. You can also help explain features of the PestiVid platform. Provide clear, concise, and actionable advice. If a question is outside your agricultural expertise, politely state that. Always remind the user that your advice is for informational purposes and they should consult with local agricultural experts or conduct their own research before making critical farming decisions.",

  // Avatar Helper
  avatar: {
      visible: true, expanded: false, state: 'idle', character: 'farmer', position: 'bottom-right',
      chatMessages: [], userInput: '', quickActions: [], currentContextText: '',
      images: {
          farmer: { idle: 'https://img.icons8.com/plasticine/100/farmer-male.png', talking: 'https://img.icons8.com/plasticine/100/farmer-male.png', thinking: 'https://img.icons8.com/plasticine/100/farmer-male.png', listening: 'https://img.icons8.com/plasticine/100/farmer-male.png' },
          buyer: { idle: 'https://img.icons8.com/plasticine/100/shopping-cart.png', talking: 'https://img.icons8.com/plasticine/100/shopping-cart.png', thinking: 'https://img.icons8.com/plasticine/100/shopping-cart.png', listening: 'https://img.icons8.com/plasticine/100/shopping-cart.png', },
          investor: { idle: 'https://img.icons8.com/plasticine/100/line-chart.png', talking: 'https://img.icons8.com/plasticine/100/line-chart.png', thinking: 'https://img.icons8.com/plasticine/100/line-chart.png', listening: 'https://img.icons8.com/plasticine/100/line-chart.png', }
      },
      systemPrompt: "You are PestiVid Helper, a friendly and knowledgeable AI assistant for the PestiVid platform. You are represented by a visual avatar. Your goal is to help users navigate the platform, understand its features (like PestiVid video uploads, AgriStream, Marketplace, Funding, PlantRecommend, Messaging, Investment Opportunities, Investor Portfolio, User Profile), and answer their questions. Be encouraging and clear. If asked about a specific page, try to provide relevant tips. When the user opens your chat, if you have context, offer a relevant quick action or greeting. Keep responses concise for a chat interface. Suggest navigating to relevant pages when appropriate, using the format: [action:Go to PageName].",
      isProcessing: false, isListening: false, ttsEnabled: true,
  },
  speechRecognition: null,
},
computed: {
  userRoleDisplay() { return this.role ? (this.role.charAt(0).toUpperCase() + this.role.slice(1)) : 'User'; },
  userNameDisplay() { return this.currentUser && this.currentUser.name ? this.currentUser.name.split(' ')[0] : 'User'; },
  userEmailDisplay() { return this.currentUser?.email || 'Not Provided'; },
  userPhoneDisplay() { return this.currentUser?.phone || 'Not Provided'; },
  memberSinceDisplay() {
        if (this.currentUser?.memberSince) {
             try { return new Date(this.currentUser.memberSince).toLocaleDateString(); }
             catch (e) { console.error("Error formatting memberSince date:", e, this.currentUser.memberSince); return this.currentUser.memberSince; }
        }
        return 'N/A';
   },
  role() { return this.currentUser?.role || 'Not Set'; },

  availableVideosForListing() {
       if (!this.isAuthenticated || this.role !== 'farmer' || !this.farmerVideos || !this.farmerListings) return [];
       const listedCids = new Set(this.farmerListings.filter(l => l.status === 'active').map(l => l.cid));
       return this.farmerVideos.filter(v => {
           const farmerWalletId = typeof v.farmerWallet === 'object' ? v.farmerWallet._id : v.farmerWallet;
           return farmerWalletId === this.currentUserIdentifier && (v.purpose === 'sell' || v.purpose === 'agristream') && !listedCids.has(v.cid);
       });
  },
  availableVideosForFunding() {
       if (!this.isAuthenticated || this.role !== 'farmer' || !this.farmerVideos || !this.farmerFundingRequests) return [];
       const fundingCids = new Set(this.farmerFundingRequests.filter(r => {
           const farmerWalletId = typeof r.farmerWallet === 'object' ? r.farmerWallet._id : r.farmerWallet;
           return farmerWalletId === this.currentUserIdentifier && ['pending', 'partially_funded', 'funded', 'growing'].includes(r.status);
       }).map(r => r.cid));
       return this.farmerVideos.filter(v => {
           const farmerWalletId = typeof v.farmerWallet === 'object' ? v.farmerWallet._id : v.farmerWallet;
           return farmerWalletId === this.currentUserIdentifier && (v.purpose === 'funding' || v.purpose === 'agristream') && !fundingCids.has(v.cid);
       });
  },
  uniqueCrops() {
       const crops = this.allListings.filter(l => l.status === 'active').map(l=>l.crop).filter(Boolean);
       return [...new Set(crops)].sort();
  },
  filteredListings() {
       const oneDayAgo = Date.now() - (24*60*60*1000);
       return this.allListings.filter(l => l.status === 'active')
         .map(l => ({...l, isNew: new Date(l.createdAt) > oneDayAgo }))
         .filter(l => {
            const cropMatch = !this.buyerFilters.crop || (l.crop || '').toLowerCase() === this.buyerFilters.crop.toLowerCase();
            const locMatch = !this.buyerFilters.location || (l.location || '').toLowerCase().includes(this.buyerFilters.location.toLowerCase());
            const companyMatch = !this.buyerFilters.pesticideCompany || (l.pesticideCompany || '').toLowerCase().includes(this.buyerFilters.pesticideCompany.toLowerCase());
            return cropMatch && locMatch && companyMatch;
        }).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
  },
  uniqueFundingCrops() {
       const crops = this.allFundingRequests.filter(r => ['pending', 'partially_funded'].includes(r.status)).map(r=>r.crop).filter(Boolean);
       return [...new Set(crops)].sort();
  },
  filteredFundingRequests() {
       const oneDayAgo = Date.now() - (24*60*60*1000);
       return this.allFundingRequests.filter(r => ['pending', 'partially_funded'].includes(r.status))
         .map(r => ({ ...r, isNew: new Date(r.createdAt) > oneDayAgo }))
         .filter(r => {
            const cropMatch = !this.investorFilters.crop || (r.crop||'').toLowerCase() === this.investorFilters.crop.toLowerCase();
            const methodMatch = !this.investorFilters.method || (r.method||'').toLowerCase() === this.investorFilters.method.toLowerCase();
            const roiMatch = !this.investorFilters.minRoi || r.roi >= this.investorFilters.minRoi;
            const amountMatch = !this.investorFilters.maxAmount || r.amount <= this.investorFilters.maxAmount;
            return cropMatch && methodMatch && roiMatch && amountMatch;
        }).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
  },
  totalInvestedAmount() { if (!this.investorInvestments || this.investorInvestments.length === 0) return '0.00'; return this.investorInvestments.reduce((sum, inv) => sum + inv.amount, 0).toFixed(2); },
  investorActiveProjects() { if (!this.investorInvestments) return 0; return this.investorInvestments.filter(inv => inv.status === 'active' || inv.status === 'growing').length; },
  investorCompletedProjects() { if (!this.investorInvestments) return 0; return this.investorInvestments.filter(inv => inv.status === 'harvested').length; },
  investorAvgRoi() { if (!this.investorInvestments || this.investorInvestments.length === 0) return '0.0'; const totalRoi = this.investorInvestments.reduce((sum, inv) => sum + inv.roi, 0); return this.investorInvestments.length > 0 ? (totalRoi / this.investorInvestments.length).toFixed(1) : '0.0'; },

  userConversations() {
       if (!this.isAuthenticated || !this.currentUserIdentifier || !this.conversations) return [];
       return this.conversations.filter(c => c.participants.includes(this.currentUserIdentifier))
           .slice().sort((a, b) => new Date(b.lastMessageTimestamp) - new Date(a.lastMessageTimestamp));
  },
  currentMessages() {
       if (!this.activeConversationId || !this.isAuthenticated || !this.messages) return [];
       return this.messages.filter(msg => msg.conversationId === this.activeConversationId).slice().sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
  },
  activeConversationPartnerIdentifier() {
       if (!this.activeConversationId || !this.isAuthenticated || !this.conversations || !this.currentUserIdentifier) return null;
       const conv = this.conversations.find(c => c._id === this.activeConversationId);
       if (!conv) return null;
       return conv.participants.find(p => p !== this.currentUserIdentifier);
  },
  activeConversationPartnerDisplayAddress() {
        const partnerId = this.activeConversationPartnerIdentifier;
        if (!partnerId) return 'Loading...';
        const partnerUser = this.users.find(u => u._id === partnerId);
        if (partnerUser && partnerUser.name) return partnerUser.name.split(" ")[0];
        return `User ${partnerId.toString().substring(partnerId.length-4)}`;
   },
  activeConversationPartnerInitial() {
       const partnerDisplay = this.activeConversationPartnerDisplayAddress;
       if (!partnerDisplay || partnerDisplay === 'Loading...') return '?';
       return partnerDisplay.charAt(0).toUpperCase();
  },
  unreadMessageCount() {
       if (!this.isAuthenticated || !this.currentUserIdentifier || !this.messages) return 0;
       let count = 0;
       this.conversations.forEach(conv => {
           if (conv.participants.includes(this.currentUserIdentifier)) {
               count += this.messages.filter(msg =>
                   msg.conversationId === conv._id &&
                   msg.receiver === this.currentUserIdentifier &&
                   !msg.read
               ).length;
           }
       });
       return count;
  },
  unreadAvatarMessagesCount() {
       if (!this.isAuthenticated || this.avatar.expanded || !this.avatar.chatMessages) return 0;
       return this.avatar.chatMessages.filter(msg => msg.sender === 'bot' && !msg.readByUser).length;
  },
},
watch: {
    filteredFundingRequests: {
        handler() {
            this.$nextTick(() => {
                this.initializeInvestmentAmounts();
            });
        },
        immediate: true
    },
    current(newPage, oldPage) {
        window.scrollTo(0,0);
        if (newPage === 'farmerAgriStream' && this.targetAgriStreamVideoCid) {
             this.scrollToAndHighlightAgriStreamVideo();
         } else if (newPage !== 'farmerAgriStream') {
             this.highlightedAgriStreamVideoCid = null;
         }
        // Load public data when visiting marketplace or investor projects (for all users)
        if (newPage === 'buyerAgriSell' || newPage === 'investorProjects') {
            this.loadPublicPlatformData();
        }

        // Load investor-specific data when visiting investor pages
        if ((newPage === 'investorProjects' || newPage === 'investorPortfolio') && this.role === 'investor' && this.isAuthenticated) {
            this.loadUserAppData();
        }

        if (this.isAuthenticated) {
             if (newPage === 'messaging') {
                 this.loadUserConversations();
                 if (this.activeConversationId) {
                     this.$nextTick(() => {
                          this.scrollToMessageBottom();
                          this.markConversationAsRead(this.activeConversationId);
                     });
                 }
             }
             if (newPage === 'investorPortfolio' && this.role === 'investor') {
                  this.updateInvestmentProgress();
             }
            if (newPage === 'farmerChatbot' && this.role === 'farmer') {
                this.initializeChatbot();
                this.$nextTick(() => this.scrollToChatBottom());
            }
            if (this.avatar.visible && this.avatar.expanded) {
                this.updateAvatarContextAndQuickActions();
            }
        }
        if (oldPage === 'plantAnalysis' && newPage !== 'plantAnalysis') { // Changed from plantRecommendation
            this.plantImageFile = null; this.plantImageUrl = null; this.plantImageMimeType = null;
            this.analysisResultText = ''; this.parsedAnalysis = { plantName: null, diseaseName: null, confidence: null, treatmentRecommended: null };
            this.analysisErrorText = '';
        }
    },
    chatMessages: {
        handler() { if (this.current === 'farmerChatbot') this.$nextTick(() => this.scrollToChatBottom()); },
        deep: true
    },
    messages: {
         handler() { if (this.current === 'messaging' && this.activeConversationId) this.$nextTick(() => this.scrollToMessageBottom()); },
         deep: true
     },
    activeConversationId(newConvId, oldConvId) {
         if (newConvId && this.current === 'messaging') {
             this.loadMessagesForConversation(newConvId);
             this.$nextTick(() => {
                  this.scrollToMessageBottom();
                  this.markConversationAsRead(newConvId);
              });
         }
    },
    'avatar.chatMessages': {
        handler(newMessages, oldMessages) { if (newMessages.length > (oldMessages ? oldMessages.length : 0) ) this.$nextTick(() => this.scrollToAvatarMessagesBottom()); },
        deep: true
    },
     'avatar.isListening'(isListening) {
         if (isListening) { if ('speechSynthesis' in window && speechSynthesis.speaking) { speechSynthesis.cancel(); this.avatar.state = 'listening'; }}
         else { if (this.avatar.state === 'listening') this.avatar.state = 'idle'; }
     },
     role(newRole, oldRole) {
         if (this.isAuthenticated) {
             this.avatar.character = newRole || 'farmer';
             this.updateAvatarContextAndQuickActions();
         }
     },
    isAuthenticated(isAuth, wasAuth) {
         if (isAuth) {
             console.log("isAuthenticated changed to true. User:", this.currentUserIdentifier);
             this.avatar.character = this.role || 'farmer';
             if (!this.speechRecognition && ('speechSynthesis' in window && ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window))) {
                this.initializeSpeechRecognition();
             } else if (!('speechSynthesis'in window) || !('SpeechRecognition'in window || 'webkitSpeechRecognition'in window)) {
                console.warn("Avatar voice features (TTS/STT) not fully supported by this browser.");
                this.avatar.visible = false;
             }
             this.loadUserAppData();
         } else {
             console.log("isAuthenticated changed to false. Clearing session data.");
             if ('speechSynthesis' in window && speechSynthesis.speaking) { speechSynthesis.cancel(); }
             if (this.speechRecognition && this.avatar.isListening) { this.speechRecognition.stop(); }
             this.avatar.isListening = false; this.avatar.isProcessing = false; this.avatar.state = 'idle';
             this.avatar.expanded = false; this.avatar.chatMessages = [];
             this.clearUserSpecificData();
         }
    }
},
methods: {
    // --- Utility ---
    generateId(prefix = 'id_') { return prefix + Date.now().toString(36) + Math.random().toString(36).substring(2, 10); },
    generateSimulatedTxHash(prefix = 'sim_tx') { return this.generateId(prefix); },

    // YouTube Popup Functions
    closeYouTubePopup() {
        this.showYouTubePopup = false;
    },

    skipVideoAndExplore() {
        this.showYouTubePopup = false;
        // Stay on landing page to let users explore
    },

























    // --- MongoDB Database Connection Verification ---
    async verifyDatabaseConnection() {
        console.log('🔍 Verifying MongoDB database connection...');

        try {
            const response = await axios.get(this.apiUrl.replace('/api', '') + '/health', {
                timeout: 5000
            });

            if (response.data && response.status === 200) {
                this.databaseConnected = true;
                console.log('✅ Database connection verified:', response.data);
                return true;
            } else {
                throw new Error('Invalid health check response');
            }
        } catch (error) {
            console.error('❌ Database connection failed:', error.message);
            this.databaseConnected = false;
            this.authenticationMode = 'localStorage';
            return false;
        }
    },

    // --- MongoDB Authentication System ---
    async authenticateWithMongoDB(email, password) {
        console.log('🔐 Authenticating with MongoDB database...');

        try {
            const response = await axios.post(this.apiUrl + '/auth/login', {
                email: email.trim(),
                password: password
            }, {
                timeout: 10000,
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.data && response.data.token && response.data.user) {
                console.log('✅ MongoDB authentication successful:', response.data.user);

                // Set authentication data
                this.token = response.data.token;
                this.currentUser = response.data.user;
                this.isAuthenticated = true;
                this.currentUserIdentifier = this.currentUser._id;

                // Set user properties
                this.userName = this.currentUser.name;
                this.userEmail = this.currentUser.email;
                this.userPhone = this.currentUser.phone || '';
                this.memberSince = this.currentUser.memberSince || this.currentUser.createdAt;

                // Set authorization header for future requests
                axios.defaults.headers.common['Authorization'] = `Bearer ${this.token}`;

                // Save to localStorage
                localStorage.setItem('pestivid_token', this.token);
                localStorage.setItem('pestivid_user_id', this.currentUser._id);
                localStorage.setItem('pestivid_user_data', JSON.stringify(this.currentUser));

                return {
                    success: true,
                    user: this.currentUser,
                    token: this.token
                };
            } else {
                throw new Error('Invalid response format from server');
            }
        } catch (error) {
            console.error('❌ MongoDB authentication failed:', error);

            let errorMessage = 'Authentication failed';
            if (error.response?.data?.message) {
                errorMessage = error.response.data.message;
            } else if (error.message === 'Network Error') {
                errorMessage = 'Cannot connect to server. Please check if the backend is running.';
            } else if (error.code === 'ECONNREFUSED') {
                errorMessage = 'Server connection refused. Please start the backend server.';
            } else if (error.message.includes('timeout')) {
                errorMessage = 'Request timeout. Server may be slow or unavailable.';
            }

            return {
                success: false,
                error: errorMessage,
                details: error.response?.data || error.message
            };
        }
    },

    // --- localStorage Fallback Authentication (Demo Mode) ---
    async authenticateWithLocalStorage(email, password) {
        console.log('📦 Attempting localStorage authentication fallback...');

        // Demo user credentials for offline mode
        const demoUsers = [
            { email: 'demo.farmer@pestivid.sim', password: 'password123', role: 'farmer', name: 'Demo Farmer' },
            { email: 'demo.buyer@pestivid.sim', password: 'password123', role: 'buyer', name: 'Demo Buyer' },
            { email: 'demo.investor@pestivid.sim', password: 'password123', role: 'investor', name: 'Demo Investor' },
            { email: 'demo.transporter@pestivid.sim', password: 'password123', role: 'transporter', name: 'Demo Transporter' },
            { email: 'alice@example.com', password: 'alice123', role: 'farmer', name: 'Alice Farmer' },
            { email: 'bob@example.com', password: 'bob123', role: 'buyer', name: 'Bob Buyer' },
            { email: 'charlie@example.com', password: 'charlie123', role: 'investor', name: 'Charlie Investor' }
        ];

        const user = demoUsers.find(u => u.email === email.trim() && u.password === password);

        if (user) {
            // Create mock user object
            this.currentUser = {
                _id: 'local_' + Date.now(),
                name: user.name,
                email: user.email,
                role: user.role,
                memberSince: new Date().toISOString(),
                createdAt: new Date().toISOString()
            };

            this.token = 'local_token_' + Date.now();
            this.isAuthenticated = true;
            this.currentUserIdentifier = this.currentUser._id;

            // Set user properties
            this.userName = this.currentUser.name;
            this.userEmail = this.currentUser.email;
            this.userPhone = '';
            this.memberSince = this.currentUser.memberSince;

            // Save to localStorage
            localStorage.setItem('pestivid_token', this.token);
            localStorage.setItem('pestivid_user_id', this.currentUser._id);
            localStorage.setItem('pestivid_user_data', JSON.stringify(this.currentUser));

            return {
                success: true,
                user: this.currentUser,
                token: this.token
            };
        } else {
            return {
                success: false,
                error: 'Invalid demo credentials. Use demo.farmer@pestivid.sim / password123'
            };
        }
    },

    // --- Database Transport Data Loading ---
    async loadTransportDataFromDatabase() {
        console.log('🚛 Loading transport data from database...');

        try {
            // Load transport providers with timeout
            const providersResponse = await Promise.race([
                axios.get(this.apiUrl + '/transport/providers', {
                    headers: { 'Authorization': `Bearer ${this.token}` },
                    timeout: 5000
                }),
                new Promise((_, reject) => setTimeout(() => reject(new Error('Providers API timeout')), 5000))
            ]);
            this.transportProviders = providersResponse.data || [];
            console.log('✅ Loaded transport providers from database:', this.transportProviders.length);

            // Load transport requests with timeout
            const requestsResponse = await Promise.race([
                axios.get(this.apiUrl + '/transport/requests', {
                    headers: { 'Authorization': `Bearer ${this.token}` },
                    timeout: 5000
                }),
                new Promise((_, reject) => setTimeout(() => reject(new Error('Requests API timeout')), 5000))
            ]);
            this.allTransportRequests = requestsResponse.data || [];

            // Filter requests by user role
            if (this.role === 'farmer') {
                this.farmerTransportRequests = this.allTransportRequests.filter(req =>
                    req.farmerWallet === this.currentUserIdentifier
                );
            } else if (this.role === 'buyer') {
                this.buyerTransportRequests = this.allTransportRequests.filter(req =>
                    req.buyerWallet === this.currentUserIdentifier
                );
            } else if (this.role === 'investor') {
                this.investorTransportRequests = this.allTransportRequests.filter(req =>
                    req.investorWallet === this.currentUserIdentifier
                );
            }

            console.log('✅ Loaded transport requests from database:', this.allTransportRequests.length);

            // Load current transporter profile if user is a transporter
            if (this.walletConnected) {
                const transporterResponse = await axios.get(this.apiUrl + `/transport/providers/wallet/${this.walletAddress}`, {
                    headers: { 'Authorization': `Bearer ${this.token}` }
                });
                if (transporterResponse.data) {
                    this.currentTransporter = transporterResponse.data;
                    console.log('✅ Loaded current transporter profile from database');
                }
            }

        } catch (error) {
            console.error('❌ Failed to load transport data from database:', error);
            console.log('📦 Falling back to localStorage...');

            // Fallback to localStorage
            this.loadTransportDataFromLocalStorage();
        }
    },

    loadTransportDataFromLocalStorage() {
        console.log('📦 Loading transport data from localStorage...');

        // Load transport providers
        this.transportProviders = JSON.parse(localStorage.getItem('pestivid_transportProviders') || '[]');

        // Load transport requests
        this.farmerTransportRequests = JSON.parse(localStorage.getItem('pestivid_farmerTransportRequests') || '[]');
        this.buyerTransportRequests = JSON.parse(localStorage.getItem('pestivid_buyerTransportRequests') || '[]');
        this.investorTransportRequests = JSON.parse(localStorage.getItem('pestivid_investorTransportRequests') || '[]');
        this.allTransportRequests = JSON.parse(localStorage.getItem('pestivid_allTransportRequests') || '[]');

        // Load current transporter
        const savedTransporter = localStorage.getItem('pestivid_currentTransporter');
        if (savedTransporter) {
            const transporter = JSON.parse(savedTransporter);
            if (transporter.walletAddress === this.walletAddress) {
                this.currentTransporter = transporter;
            }
        }

        console.log('📦 Loaded transport data from localStorage');
    },

    async saveTransportDataToDatabase(data, endpoint) {
        try {
            const response = await axios.post(this.apiUrl + endpoint, data, {
                headers: { 'Authorization': `Bearer ${this.token}` }
            });
            console.log('✅ Transport data saved to database:', endpoint);
            return response.data;
        } catch (error) {
            console.error('❌ Failed to save transport data to database:', error);
            throw error;
        }
    },

    async updateTransportDataInDatabase(id, data, endpoint) {
        try {
            const response = await axios.put(this.apiUrl + `${endpoint}/${id}`, data, {
                headers: { 'Authorization': `Bearer ${this.token}` }
            });
            console.log('✅ Transport data updated in database:', endpoint);
            return response.data;
        } catch (error) {
            console.error('❌ Failed to update transport data in database:', error);
            throw error;
        }
    },

    async syncTransportDataToDatabase() {
        if (!this.token) {
            console.log('⚠️ No authentication token, skipping database sync');
            return;
        }

        console.log('🔄 Syncing transport data to database...');

        try {
            // Sync transport providers
            for (const provider of this.transportProviders) {
                try {
                    await axios.post(this.apiUrl + '/transport/providers/sync', provider, {
                        headers: { 'Authorization': `Bearer ${this.token}` }
                    });
                } catch (error) {
                    console.error('Failed to sync provider:', provider._id, error);
                }
            }

            // Sync transport requests
            for (const request of this.allTransportRequests) {
                try {
                    await axios.post(this.apiUrl + '/transport/requests/sync', request, {
                        headers: { 'Authorization': `Bearer ${this.token}` }
                    });
                } catch (error) {
                    console.error('Failed to sync request:', request._id, error);
                }
            }

            console.log('✅ Transport data synced to database');
            this.addNotification('Transport data synced to database successfully!', 'success');

        } catch (error) {
            console.error('❌ Failed to sync transport data to database:', error);
            this.addNotification('Failed to sync transport data to database.', 'error');
        }
    },

    async backupTransportDataToLocalStorage() {
        console.log('💾 Backing up transport data to localStorage...');

        localStorage.setItem('pestivid_transportProviders', JSON.stringify(this.transportProviders));
        localStorage.setItem('pestivid_allTransportRequests', JSON.stringify(this.allTransportRequests));
        localStorage.setItem('pestivid_farmerTransportRequests', JSON.stringify(this.farmerTransportRequests));
        localStorage.setItem('pestivid_buyerTransportRequests', JSON.stringify(this.buyerTransportRequests));
        localStorage.setItem('pestivid_investorTransportRequests', JSON.stringify(this.investorTransportRequests));

        if (this.currentTransporter) {
            localStorage.setItem('pestivid_currentTransporter', JSON.stringify(this.currentTransporter));
        }

        console.log('✅ Transport data backed up to localStorage');
    },

    // --- IPFS Integration ---
    async initializeIPFS() {
        try {
            // Initialize IPFS client for direct uploads (alternative to Pinata)
            if (typeof IpfsHttpClient !== 'undefined') {
                this.ipfsClient = IpfsHttpClient.create({
                    host: 'ipfs.infura.io',
                    port: 5001,
                    protocol: 'https',
                    headers: {
                        authorization: 'Basic ' + btoa('YOUR_INFURA_PROJECT_ID:YOUR_INFURA_PROJECT_SECRET')
                    }
                });
                console.log('✅ IPFS client initialized');
                return true;
            } else {
                console.warn('IPFS client not available');
                return false;
            }
        } catch (error) {
            console.error('Failed to initialize IPFS:', error);
            return false;
        }
    },

    async uploadToIPFSDirect(file, metadata) {
        try {
            if (!this.ipfsClient) {
                await this.initializeIPFS();
            }

            if (!this.ipfsClient) {
                throw new Error('IPFS client not available');
            }

            // Add file to IPFS
            const result = await this.ipfsClient.add(file, {
                progress: (prog) => console.log(`IPFS upload progress: ${prog}`)
            });

            // Add metadata
            const metadataResult = await this.ipfsClient.add(JSON.stringify(metadata));

            return {
                success: true,
                cid: result.cid.toString(),
                metadataCid: metadataResult.cid.toString(),
                size: result.size
            };
        } catch (error) {
            console.error('Direct IPFS upload failed:', error);
            return {
                success: false,
                error: error.message
            };
        }
    },

    // Add sample videos for demonstration
    addSampleVideos() {
        const sampleVideos = [
            {
                _id: 'sample_video_1',
                cid: 'QmSampleTomatoVideo123456789',
                crop: 'Tomatoes',
                location: 'North Field A',
                pesticide: 'Organic Neem Oil',
                pesticideCompany: 'EcoFarm Solutions',
                purpose: 'agristream',
                farmerWallet: 'demo_farmer_wallet_1',
                uploadDate: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(), // 7 days ago
                storageType: 'demo',
                videoFileHash: 'sha256_sample_tomato_hash_123',
                description: 'Healthy tomato plants in North Field A, treated with organic neem oil for pest prevention'
            },
            {
                _id: 'sample_video_2',
                cid: 'QmSampleCornVideo789012345',
                crop: 'Sweet Corn',
                location: 'South Field B',
                pesticide: 'Bacillus Thuringiensis',
                pesticideCompany: 'BioProtect Inc',
                purpose: 'sell',
                farmerWallet: 'demo_farmer_wallet_2',
                uploadDate: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(), // 3 days ago
                storageType: 'demo',
                videoFileHash: 'sha256_sample_corn_hash_456',
                description: 'Premium sweet corn ready for harvest, treated with biological pest control'
            },
            {
                _id: 'sample_video_3',
                cid: 'QmSampleCarrotVideo345678901',
                crop: 'Carrots',
                location: 'East Field C',
                pesticide: 'Pyrethrin Spray',
                pesticideCompany: 'GreenGuard Organics',
                purpose: 'funding',
                farmerWallet: 'demo_farmer_wallet_3',
                uploadDate: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(), // 1 day ago
                storageType: 'demo',
                videoFileHash: 'sha256_sample_carrot_hash_789',
                description: 'Carrot cultivation project seeking investment for expansion to organic farming methods'
            }
        ];

        this.farmerVideos = sampleVideos;
        localStorage.setItem('pestivid_farmerVideos', JSON.stringify(this.farmerVideos));
        console.log('✅ Sample videos added to PestiVid platform');
    },

    // Add sample listings for demonstration
    addSampleListings() {
        const sampleListings = [
            {
                _id: 'sample_listing_1',
                cid: 'QmSampleTomatoVideo123456789',
                crop: 'Tomatoes',
                location: 'North Field A',
                pesticide: 'Organic Neem Oil',
                pesticideCompany: 'EcoFarm Solutions',
                minPrice: 0.5,
                maxPrice: 1.2,
                farmerWallet: 'demo_farmer_wallet_1',
                status: 'active',
                createdAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                storageType: 'demo',
                videoFileHash: 'sha256_sample_tomato_hash_123',
                buyerNotifications: true,
                isNew: true
            },
            {
                _id: 'sample_listing_2',
                cid: 'QmSampleCornVideo789012345',
                crop: 'Sweet Corn',
                location: 'South Field B',
                pesticide: 'Bacillus Thuringiensis',
                pesticideCompany: 'BioProtect Inc',
                minPrice: 0.8,
                maxPrice: 1.5,
                farmerWallet: 'demo_farmer_wallet_2',
                status: 'active',
                createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                storageType: 'demo',
                videoFileHash: 'sha256_sample_corn_hash_456',
                buyerNotifications: true,
                isNew: false
            }
        ];

        this.allListings = sampleListings;
        localStorage.setItem('pestivid_allListings', JSON.stringify(this.allListings));
        console.log('✅ Sample listings added to marketplace');
    },

    // Add sample funding requests for demonstration
    addSampleFundingRequests() {
        const sampleFundingRequests = [
            {
                _id: 'sample_funding_1',
                cid: 'QmSampleCarrotVideo345678901',
                title: 'Organic Carrot Farm Expansion',
                crop: 'Carrots',
                location: 'East Field C',
                pesticide: 'Pyrethrin Spray',
                pesticideCompany: 'GreenGuard Organics',
                method: 'Organic Farming',
                acres: 5,
                timeline: 8,
                roi: 15,
                investorShare: 25,
                amount: 10,
                fundedAmount: 3.5,
                farmerWallet: 'demo_farmer_wallet_3',
                status: 'partially_funded',
                createdAt: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                videoStorageType: 'demo',
                videoFileHash: 'sha256_sample_carrot_hash_789',
                description: 'Expanding our organic carrot production to meet growing demand. This project will convert 5 acres to certified organic farming methods, implementing sustainable pest control and soil management practices.',
                updates: [
                    {
                        _id: 'update_1',
                        date: new Date(Date.now() - 12 * 60 * 60 * 1000).toISOString(),
                        text: 'Soil preparation completed. Organic certification process initiated.'
                    },
                    {
                        _id: 'update_2',
                        date: new Date(Date.now() - 6 * 60 * 60 * 1000).toISOString(),
                        text: 'Seeds ordered from certified organic supplier. Planting scheduled for next week.'
                    }
                ],
                isNew: true
            }
        ];

        this.allFundingRequests = sampleFundingRequests;
        localStorage.setItem('pestivid_allFundingRequests', JSON.stringify(this.allFundingRequests));
        console.log('✅ Sample funding requests added to platform');
    },

    // Load user data by wallet address (for real wallet-based identification)
    async loadUserByWallet(walletAddress) {
        try {
            const response = await axios.get(`${this.apiUrl}/users/wallet/${walletAddress}`);
            if (response.data.success) {
                return response.data.user;
            }
        } catch (error) {
            console.warn('User not found for wallet:', walletAddress);
        }
        return null;
    },

    // Get display name for wallet address (real wallet-based)
    getWalletDisplayName(walletAddress) {
        if (!walletAddress) return 'Unknown';

        // Check if we have user data for this wallet
        const user = this.users.find(u => u.walletAddress === walletAddress);
        if (user) {
            return user.name;
        }

        // Return formatted wallet address if no user found
        return this.formatWalletAddress(walletAddress);
    },

    // --- Simple Wallet Connection Methods ---

    // Direct wallet connection (no loading modal) - Enhanced with error handling
    async connectWallet() {
        console.log('🔄 Starting wallet connection...');

        try {
            // Use the new wallet integration
            if (!window.pestVidWallet) {
                this.addNotification('Wallet integration not loaded', 'error');
                return false;
            }

            // Connect using the new MetaMask method
            const result = await window.pestVidWallet.connectMetaMask();

            if (result.success) {
                console.log('✅ Wallet connected via integration:', result);

                this.walletAddress = result.address;
                this.walletType = 'MetaMask (Avalanche)';
                this.walletConnected = true;
                this.walletBalance = result.balance;

                // Setup wallet listeners for account/network changes
                this.setupWalletListeners();

                // Save connection state
                localStorage.setItem('walletConnected', 'true');
                localStorage.setItem('walletAddress', this.walletAddress);
                localStorage.setItem('walletType', this.walletType);

                this.addNotification('✅ Wallet connected to Avalanche network!', 'success');
                return true;
            } else {
                throw new Error(result.error || 'Wallet connection failed');
            }

        } catch (error) {
            console.error('❌ AVAX wallet connection failed:', error);

            let errorMessage = 'Failed to connect wallet: ';
            if (error.code === 4001) {
                errorMessage += 'User rejected the connection';
            } else if (error.message.includes('MetaMask not installed')) {
                errorMessage += 'Please install MetaMask wallet';
            } else {
                errorMessage += error.message;
            }

            this.addNotification(errorMessage, 'error');

            // Reset wallet state on error
            this.walletConnected = false;
            this.walletAddress = null;
            this.walletType = null;
            this.walletBalance = 0;

            return false;
        }
    },

    // Simple wallet disconnect
    disconnectWallet() {
        this.walletAddress = null;
        this.walletType = null;
        this.walletConnected = false;
        this.walletBalance = 0;

        // Clear saved connection state
        localStorage.removeItem('walletConnected');
        localStorage.removeItem('walletAddress');
        localStorage.removeItem('walletType');

        // Disconnect from wallet integration if available
        if (window.pestVidWallet) {
            window.pestVidWallet.isConnected = false;
            window.pestVidWallet.walletAddress = null;
            window.pestVidWallet.signer = null;
        }

        this.addNotification('Wallet disconnected', 'info');
    },

    // Separate method for the actual connection logic
    async performWalletConnection() {
        console.log('🔄 Starting performWalletConnection...');

        try {
            // Step 1: Request account access (this handles both locked and unlocked states)
            console.log('📝 Requesting MetaMask accounts...');

            const accounts = await Promise.race([
                window.ethereum.request({
                    method: 'eth_requestAccounts'
                }),
                new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('MetaMask connection timeout - please unlock MetaMask and try again')), 30000)
                )
            ]);

            console.log('✅ Got accounts from MetaMask:', accounts);

            // Step 2: Validate accounts
            if (!accounts || accounts.length === 0) {
                throw new Error('No accounts found in MetaMask');
            }

            console.log('🔧 Setting wallet state...');
            this.walletAddress = accounts[0];
            this.walletType = 'MetaMask';
            this.walletConnected = true;
            this.walletConnectedAt = new Date().toISOString();

            // Step 3: Get current network
            console.log('🌐 Getting network information...');
            const chainId = await window.ethereum.request({ method: 'eth_chainId' });
            this.currentChainId = chainId;

            console.log('✅ MetaMask connected successfully!');
            console.log('📍 Wallet Address:', this.walletAddress);
            console.log('🌐 Current Network:', chainId);

            // Verify real-time Avalanche blockchain connection
            const targetChainId = this.useTestnet ? '0xA869' : '0xA86A';
            if (chainId !== targetChainId) {
                console.log('⚠️ Wrong network detected, switching to Avalanche...');
                this.addNotification('Switching to Avalanche network for real-time blockchain...', 'info');
                try {
                    await this.switchToAvalanche();
                } catch (switchError) {
                    console.warn('Network switch failed:', switchError);
                    this.addNotification('Failed to switch to Avalanche network. Please switch manually.', 'warning');
                }
            }

            // Get wallet balance
            try {
                await this.getBalance();
            } catch (balanceError) {
                console.warn('Failed to get wallet balance:', balanceError);
                this.walletBalance = 0;
            }

            // Setup wallet event listeners
            try {
                this.setupWalletListeners();
            } catch (listenerError) {
                console.warn('Failed to setup wallet listeners:', listenerError);
            }



            this.addNotification(`✅ MetaMask connected to Avalanche blockchain!`, 'success');
            this.addNotification(`Address: ${this.formatWalletAddress(this.walletAddress)}`, 'info');

            // Link wallet to user account if authenticated
            if (this.isAuthenticated) {
                try {
                    await this.linkWalletToUser();
                } catch (linkError) {
                    console.warn('Failed to link wallet to user:', linkError);
                }
            }

            return true;

        } catch (error) {
            console.error('❌ Wallet connection error:', error);
            throw error; // Re-throw to be handled by main connectWallet method
        }
    },

    // Auto-connect wallet when needed
    async ensureWalletConnected() {
        if (this.walletConnected) {
            return true;
        }

        console.log('🔄 Auto-connecting wallet...');
        this.addNotification('Connecting wallet for blockchain operations...', 'info');

        return await this.connectWallet();
    },

    // Ensure user is on Avalanche network
    async ensureAvalancheNetwork() {
        try {
            if (!window.ethereum) {
                throw new Error('MetaMask not installed');
            }

            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const network = await provider.getNetwork();

            // Check if on Avalanche Mainnet (43114) or Fuji Testnet (43113)
            if (network.chainId !== 43114 && network.chainId !== 43113) {
                console.log('🔄 Switching to Avalanche network...');

                try {
                    // Try to switch to Avalanche Mainnet
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0xA86A' }], // 43114 in hex
                    });
                } catch (switchError) {
                    // If network doesn't exist, add it
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0xA86A',
                                chainName: 'Avalanche Network',
                                nativeCurrency: {
                                    name: 'AVAX',
                                    symbol: 'AVAX',
                                    decimals: 18
                                },
                                rpcUrls: ['https://api.avax.network/ext/bc/C/rpc'],
                                blockExplorerUrls: ['https://snowtrace.io/']
                            }]
                        });
                    } else {
                        throw switchError;
                    }
                }

                this.addNotification('Switched to Avalanche network', 'success');
            }

            return true;
        } catch (error) {
            console.error('❌ Failed to ensure Avalanche network:', error);
            this.addNotification('Please switch to Avalanche network in MetaMask', 'error');
            return false;
        }
    },

    // Force close loading modal (emergency method)
    forceCloseLoadingModal() {
        console.log('🔧 Force closing loading modal...');
        this.showLoadingModal = false;
        this.loadingMessage = '';
        this.addNotification('Loading modal force closed', 'info');

        // If user is authenticated but wallet not connected, suggest connecting
        if (this.isAuthenticated && !this.walletConnected) {
            setTimeout(() => {
                this.addNotification('💡 Tip: Connect your wallet for full blockchain functionality', 'info');
            }, 2000);
        }
    },

    // Debug wallet connection status
    debugWalletStatus() {
        console.log('🔍 Wallet Debug Status:');
        console.log('- walletConnected:', this.walletConnected);
        console.log('- walletAddress:', this.walletAddress);
        console.log('- walletBalance:', this.walletBalance);
        console.log('- walletType:', this.walletType);
        console.log('- currentChainId:', this.currentChainId);
        console.log('- showLoadingModal:', this.showLoadingModal);
        console.log('- loadingMessage:', this.loadingMessage);
        console.log('- MetaMask available:', !!(window.ethereum && window.ethereum.isMetaMask));

        if (window.ethereum) {
            window.ethereum.request({ method: 'eth_accounts' }).then(accounts => {
                console.log('- MetaMask accounts:', accounts);
            });
        }
    },

    // Manual wallet connection trigger (for debugging)
    async manualConnectWallet() {
        console.log('🔧 Manual wallet connection triggered...');
        this.forceCloseLoadingModal(); // Close any stuck modals first
        const result = await this.connectWallet();
        console.log('🔧 Manual connection result:', result);
        return result;
    },

    // Quick wallet status check
    quickWalletCheck() {
        console.log('⚡ Quick Wallet Check:');
        console.log('- MetaMask available:', !!(window.ethereum && window.ethereum.isMetaMask));
        console.log('- App walletConnected:', this.walletConnected);
        console.log('- App walletAddress:', this.walletAddress);
        console.log('- Loading modal shown:', this.showLoadingModal);
        console.log('- Loading message:', this.loadingMessage);

        if (window.ethereum) {
            window.ethereum.request({ method: 'eth_accounts' }).then(accounts => {
                console.log('- MetaMask accounts:', accounts);
                console.log('- Accounts match app:', accounts[0] === this.walletAddress);
            });
        }
    },









    // Switch to Avalanche network
    async switchToAvalanche() {
        try {
            const network = this.useTestnet ? this.avalancheConfig.testnet : this.avalancheConfig.mainnet;

            // Try to switch to the network
            await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: network.chainId }]
            });

            this.currentChainId = network.chainId;
            this.addNotification('Switched to Avalanche network', 'success');

        } catch (switchError) {
            // If network doesn't exist, add it
            if (switchError.code === 4902) {
                await this.addAvalancheNetwork();
            } else {
                console.error('Failed to switch network:', switchError);
                this.addNotification('Failed to switch network', 'error');
            }
        }
    },

    // Add Avalanche network to MetaMask
    async addAvalancheNetwork() {
        try {
            const network = this.useTestnet ? this.avalancheConfig.testnet : this.avalancheConfig.mainnet;

            await window.ethereum.request({
                method: 'wallet_addEthereumChain',
                params: [network]
            });

            this.currentChainId = network.chainId;
            this.addNotification('Avalanche network added to MetaMask', 'success');

        } catch (error) {
            console.error('Failed to add network:', error);
            this.addNotification('Failed to add Avalanche network', 'error');
        }
    },

    // Get wallet balance (ETH/AVAX)
    async getBalance() {
        try {
            if (!this.walletAddress) return;

            // Skip balance updates if wallet listeners are disabled (e.g., during video recording)
            if (!this.walletListenersActive) {
                console.log('⏸️ Skipping balance update - wallet listeners disabled');
                return;
            }

            console.log('💰 Fetching wallet balance...');

            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const balance = await provider.getBalance(this.walletAddress);
            const balanceInETH = ethers.utils.formatEther(balance);
            this.walletBalance = parseFloat(balanceInETH).toFixed(4);

            // Update last balance update timestamp
            this.lastBalanceUpdate = Date.now();

            console.log(`✅ Wallet balance: ${this.walletBalance} AVAX`);

        } catch (error) {
            console.error('❌ Failed to get wallet balance:', error);
            this.walletBalance = 0;
        }
    },

    // Alias for getBalance() to maintain compatibility
    async getAVAXBalance() {
        return await this.getBalance();
    },

    // Create marketplace listing on Avalanche blockchain
    async createAvalancheMarketplaceListing(listingData) {
        try {
            console.log('🔗 Creating Avalanche marketplace listing...', listingData);

            if (!this.walletConnected || !this.walletAddress) {
                throw new Error('Wallet not connected');
            }

            // For now, create a simple transaction to record the listing on-chain
            // In a full implementation, this would interact with a smart contract
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const signer = provider.getSigner();

            // Create a simple transaction with listing data in the transaction data field
            const listingDataString = JSON.stringify({
                action: 'create_listing',
                cid: listingData.cid,
                crop: listingData.crop,
                minPrice: listingData.minPrice,
                maxPrice: listingData.maxPrice,
                timestamp: Date.now()
            });

            // Convert string to hex for transaction data
            const dataHex = ethers.utils.hexlify(ethers.utils.toUtf8Bytes(listingDataString));

            // Send a small transaction with the listing data
            const tx = await signer.sendTransaction({
                to: this.walletAddress, // Send to self
                value: ethers.utils.parseEther('0.001'), // Small amount (0.001 AVAX)
                data: dataHex
            });

            console.log('✅ Listing transaction sent:', tx.hash);

            // Wait for transaction confirmation
            const receipt = await tx.wait();

            console.log('✅ Listing transaction confirmed:', receipt);

            return {
                success: true,
                signature: tx.hash,
                blockNumber: receipt.blockNumber,
                gasUsed: receipt.gasUsed.toString()
            };

        } catch (error) {
            console.error('❌ Failed to create Avalanche marketplace listing:', error);
            return {
                success: false,
                error: error.message
            };
        }
    },

    // Get real-time transaction history
    async getTransactionHistory(limit = 10) {
        try {
            if (!this.walletAddress) return [];

            console.log('📜 Fetching real-time transaction history...');

            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const currentBlock = await provider.getBlockNumber();

            // Get recent transactions (this is a simplified version)
            // In production, you'd use Avalanche API or indexing service
            const transactions = [];

            // Check last 1000 blocks for transactions
            const startBlock = Math.max(0, currentBlock - 1000);

            for (let i = currentBlock; i > startBlock && transactions.length < limit; i--) {
                try {
                    const block = await provider.getBlockWithTransactions(i);

                    for (const tx of block.transactions) {
                        if (tx.from === this.walletAddress || tx.to === this.walletAddress) {
                            const receipt = await provider.getTransactionReceipt(tx.hash);

                            transactions.push({
                                hash: tx.hash,
                                from: tx.from,
                                to: tx.to,
                                value: ethers.utils.formatEther(tx.value),
                                blockNumber: tx.blockNumber,
                                timestamp: block.timestamp,
                                status: receipt.status === 1 ? 'success' : 'failed',
                                gasUsed: receipt.gasUsed.toString(),
                                type: tx.from === this.walletAddress ? 'sent' : 'received'
                            });

                            if (transactions.length >= limit) break;
                        }
                    }
                } catch (blockError) {
                    // Skip blocks that can't be fetched
                    continue;
                }
            }

            console.log(`📜 Found ${transactions.length} recent transactions`);
            return transactions;

        } catch (error) {
            console.error('❌ Failed to get transaction history:', error);
            return [];
        }
    },

    // Setup basic wallet event listeners
    setupWalletListeners() {
        if (window.ethereum) {
            console.log('🔄 Setting up wallet listeners...');

            // Account changed
            window.ethereum.on('accountsChanged', async (accounts) => {
                try {
                    if (accounts.length === 0) {
                        this.addNotification('Wallet disconnected', 'warning');
                        this.disconnectWallet();
                    } else {
                        const newAddress = accounts[0];
                        if (newAddress !== this.walletAddress) {
                            this.walletAddress = newAddress;
                            this.addNotification(`Switched to account: ${this.formatWalletAddress(newAddress)}`, 'info');

                            // Only update balance if wallet listeners are active
                            if (this.walletListenersActive) {
                                await this.getBalance();
                            }
                        }
                    }
                } catch (error) {
                    console.error('❌ Error handling account change:', error);
                    // Don't break the app, just log the error
                }
            });

            // Chain changed
            window.ethereum.on('chainChanged', async (chainId) => {
                try {
                    console.log('🌐 Network changed:', chainId);

                    // Only update balance if wallet listeners are active
                    if (this.walletListenersActive) {
                        await this.getBalance();
                    }
                } catch (error) {
                    console.error('❌ Error handling chain change:', error);
                    // Don't break the app, just log the error
                }
            });

            console.log('✅ Wallet listeners active');
        }
    },



    // Simple wallet disconnect (already implemented above)
    // disconnectWallet() method is already defined above

    async updateWalletBalance() {
        if (!this.walletConnected || !window.pestVidWallet) return;

        try {
            console.log('🔄 Updating wallet balance...');
            const balance = await window.pestVidWallet.updateBalance();
            this.walletBalance = balance;
            console.log(`💰 Balance updated: ${balance} AVAX`);
        } catch (error) {
            console.error('❌ Error updating wallet balance:', error);
            // Fallback to direct balance check
            try {
                await this.getAVAXBalance();
            } catch (fallbackError) {
                console.error('❌ Fallback balance update failed:', fallbackError);
            }
        }
    },

    // Test wallet integration functionality
    async testWalletIntegration() {
        try {
            console.log('🧪 Testing wallet integration...');

            if (!window.pestVidWallet) {
                throw new Error('Wallet integration not initialized');
            }

            console.log('✅ Wallet integration available');
            console.log('📊 Wallet state:', {
                connected: window.pestVidWallet.isConnected,
                address: window.pestVidWallet.walletAddress,
                balance: window.pestVidWallet.balance
            });

            this.addNotification('Wallet integration test completed - check console', 'info');

        } catch (error) {
            console.error('❌ Wallet integration test failed:', error);
            this.addNotification(`Wallet test failed: ${error.message}`, 'error');
        }
    },

    // Send real-time AVAX transaction
    async sendAVAXTransaction(toAddress, amount, purpose = 'Payment') {
        try {
            if (!this.walletConnected) {
                throw new Error('MetaMask wallet not connected');
            }

            console.log(`🚀 Initiating real-time AVAX transaction...`);
            console.log(`💰 Amount: ${amount} AVAX`);
            console.log(`📍 To: ${toAddress}`);
            console.log(`📝 Purpose: ${purpose}`);

            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const signer = provider.getSigner();

            // Verify network is Avalanche
            const network = await provider.getNetwork();
            if (network.chainId !== 43114 && network.chainId !== 43113) {
                throw new Error('Please switch to Avalanche network');
            }

            // Convert amount to Wei
            const amountWei = ethers.utils.parseEther(amount.toString());

            // Get current gas price from Avalanche network
            const gasPrice = await provider.getGasPrice();
            console.log(`⛽ Current gas price: ${ethers.utils.formatUnits(gasPrice, 'gwei')} gwei`);

            // Estimate gas limit
            const gasLimit = await provider.estimateGas({
                to: toAddress,
                value: amountWei
            });

            // Prepare transaction with real-time gas estimation
            const transaction = {
                to: toAddress,
                value: amountWei,
                gasLimit: gasLimit,
                gasPrice: gasPrice
            };

            // Calculate total cost
            const totalCost = amountWei.add(gasLimit.mul(gasPrice));
            const totalCostAVAX = ethers.utils.formatEther(totalCost);

            console.log(`💸 Total transaction cost: ${totalCostAVAX} AVAX (including gas)`);

            // Check balance
            const balance = await provider.getBalance(this.walletAddress);
            if (balance.lt(totalCost)) {
                throw new Error(`Insufficient AVAX balance. Need ${totalCostAVAX} AVAX but have ${ethers.utils.formatEther(balance)} AVAX`);
            }

            // Send transaction to Avalanche blockchain
            console.log('📡 Broadcasting transaction to Avalanche network...');
            const tx = await signer.sendTransaction(transaction);

            // Add to pending transactions
            this.pendingTransactions.push({
                hash: tx.hash,
                purpose: purpose,
                amount: amount,
                to: toAddress,
                timestamp: new Date().toISOString(),
                status: 'pending'
            });

            this.addNotification(`Transaction broadcast to Avalanche! Hash: ${tx.hash.substring(0, 10)}...`, 'info');

            // Real-time confirmation tracking
            console.log('⏳ Waiting for blockchain confirmation...');
            const receipt = await tx.wait(this.transactionConfirmations);

            // Update pending transaction status
            const pendingTx = this.pendingTransactions.find(ptx => ptx.hash === tx.hash);
            if (pendingTx) {
                pendingTx.status = receipt.status === 1 ? 'confirmed' : 'failed';
                pendingTx.blockNumber = receipt.blockNumber;
                pendingTx.gasUsed = receipt.gasUsed.toString();
            }

            if (receipt.status === 1) {
                console.log('✅ Transaction confirmed on Avalanche blockchain!');
                console.log(`📦 Block number: ${receipt.blockNumber}`);
                console.log(`⛽ Gas used: ${receipt.gasUsed.toString()}`);

                this.addNotification(`${purpose} successful! Confirmed in block ${receipt.blockNumber}`, 'success');

                // Real-time balance update
                await this.updateWalletBalance();

                return {
                    success: true,
                    signature: tx.hash,
                    txHash: tx.hash,
                    receipt: receipt,
                    blockNumber: receipt.blockNumber,
                    gasUsed: receipt.gasUsed.toString(),
                    network: network.chainId === 43114 ? 'avalanche-mainnet' : 'avalanche-fuji'
                };
            } else {
                throw new Error('Transaction failed on blockchain');
            }

        } catch (error) {
            console.error('❌ Real-time AVAX transaction failed:', error);

            let errorMessage = error.message;
            if (error.code === 4001) {
                errorMessage = 'Transaction rejected by user in MetaMask';
            } else if (error.code === -32603) {
                errorMessage = 'Insufficient AVAX for gas fees';
            } else if (error.code === -32000) {
                errorMessage = 'Transaction underpriced or nonce too low';
            } else if (error.message.includes('insufficient funds')) {
                errorMessage = 'Insufficient AVAX balance for transaction';
            }

            this.addNotification(`Transaction failed: ${errorMessage}`, 'error');

            return {
                success: false,
                error: errorMessage
            };
        }
    },

    async linkWalletToUser() {
        if (!this.isAuthenticated || !this.walletAddress) return;

        try {
            await axios.put(`${this.apiUrl}/users/${this.currentUserIdentifier}/wallet`, {
                walletAddress: this.walletAddress
            }, {
                headers: { 'Authorization': `Bearer ${this.token}` }
            });

            // Update current user object
            if (this.currentUser) {
                this.currentUser.walletAddress = this.walletAddress;
            }

            this.addNotification('Wallet linked to your account', 'success');
        } catch (error) {
            console.error('Error linking wallet to user:', error);
            this.addNotification('Failed to link wallet to account', 'warning');
        }
    },

    async updateNetworkStatus() {
        if (!window.pestVidWallet) return;

        try {
            this.networkStatus = await window.pestVidWallet.getNetworkStatus();
        } catch (error) {
            console.error('Error updating network status:', error);
        }
    },

    formatWalletAddress(address, length = 8) {
        if (!address) return '';
        const str = address.toString();
        return `${str.substring(0, length)}...${str.substring(str.length - 4)}`;
    },

    showWalletInstallationGuide() {
        const message = `
            <div class="text-left">
                <p class="mb-2"><strong>MetaMask wallet not found!</strong></p>
                <p class="mb-2">To use PestVid DApp on Avalanche blockchain, you need MetaMask:</p>
                <ul class="list-disc list-inside mb-3 text-sm">
                    <li><a href="https://metamask.io/download/" target="_blank" class="text-blue-600 underline">Install MetaMask Extension</a> (Required)</li>
                    <li>Available for Chrome, Firefox, Edge, and Brave browsers</li>
                </ul>
                <p class="text-sm text-gray-600">After installation, refresh this page and click "Connect Wallet"</p>
                <p class="text-xs text-gray-500 mt-2">MetaMask will automatically connect to Avalanche network</p>
            </div>
        `;

        // Create a custom notification for wallet installation
        this.notifications.unshift({
            id: this.generateId('wallet_install_'),
            message: message,
            type: 'info',
            timestamp: new Date().toISOString(),
            persistent: true
        });
    },

    async requestFujiAirdrop() {
        if (!this.walletConnected) {
            this.addNotification('Please connect your MetaMask wallet first', 'error');
            return;
        }

        // Check if on Fuji testnet
        if (this.currentChainId !== '0xA869') {
            this.addNotification('Please switch to Avalanche Fuji Testnet to use faucet', 'warning');
            await this.switchToAvalanche();
            return;
        }

        try {
            this.showLoadingModal = true;
            this.loadingMessage = 'Requesting Fuji testnet AVAX...';

            // Open Avalanche Fuji faucet in new tab
            const faucetUrl = `https://faucet.avax.network/?subnet=c&token=c&address=${this.walletAddress}`;
            window.open(faucetUrl, '_blank');

            this.addNotification('Faucet opened in new tab. Please complete the request there.', 'info');

            // Wait a bit and then refresh balance
            setTimeout(async () => {
                await this.getAVAXBalance();
                this.addNotification('Balance updated. If you received AVAX, it should show now.', 'success');
            }, 5000);

        } catch (error) {
            console.error('Faucet request failed:', error);
            this.addNotification('Faucet request failed: ' + error.message, 'error');
        } finally {
            this.showLoadingModal = false;
        }
    },

    // connectWalletForSignup method removed - wallet connection now happens when accessing farmer features

    // --- Video Error Handling ---
    handleVideoError(event) {
        console.error('Video loading error:', event);
        const video = event.target;
        const src = video.src;
        console.error('Failed to load video from:', src);

        // Hide the video element and show a loading message
        video.style.display = 'none';

        // Create or update error message
        let errorDiv = video.parentElement.querySelector('.video-error-message');
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.className = 'video-error-message bg-gray-100 border-2 border-dashed border-gray-300 rounded p-4 text-center text-gray-600';
            video.parentElement.appendChild(errorDiv);
        }
        errorDiv.innerHTML = '<i class="fas fa-video-slash text-2xl mb-2 text-gray-400"></i><br><span class="text-sm">Loading video from IPFS...</span>';

        // Extract CID from the URL
        const cidMatch = src.match(/\/ipfs\/([^/?]+)/);
        if (cidMatch && cidMatch[1]) {
            const cid = cidMatch[1];

            // Try alternative gateway if this is the first failure
            if (!src.includes('?fallback=1')) {
                const alternativeUrl = this.getAlternativeVideoUrl(cid, 'ipfs');
                if (alternativeUrl) {
                    console.log('Trying alternative IPFS gateway:', alternativeUrl);
                    errorDiv.innerHTML = '<i class="fas fa-sync fa-spin text-2xl mb-2 text-blue-400"></i><br><span class="text-sm">Trying alternative gateway...</span>';
                    setTimeout(() => {
                        video.src = alternativeUrl + '?fallback=1';
                        video.load();
                    }, 1000);
                    return;
                }
            }
        }

        // Final fallback - try to reload with cache busting
        if (src && !src.includes('?reload=1')) {
            errorDiv.innerHTML = '<i class="fas fa-redo fa-spin text-2xl mb-2 text-orange-400"></i><br><span class="text-sm">Retrying video load...</span>';
            setTimeout(() => {
                video.src = src + (src.includes('?') ? '&' : '?') + 'reload=1&t=' + Date.now();
                video.load();
            }, 2000);
        } else {
            console.error('Video failed to load even with fallbacks');
            errorDiv.innerHTML = '<i class="fas fa-exclamation-triangle text-2xl mb-2 text-red-400"></i><br><span class="text-sm">Video temporarily unavailable</span><br><span class="text-xs text-gray-500">IPFS content may still be syncing</span>';
            this.addNotification('Video failed to load. IPFS content may not be available yet.', 'warning');
        }
    },
    handleVideoLoadStart(event) {
        console.log('Video loading started:', event.target.src);
    },
    handleVideoCanPlay(event) {
        console.log('Video can play:', event.target.src);
        const video = event.target;

        // Show the video and hide any error message
        video.style.display = 'block';
        const errorDiv = video.parentElement.querySelector('.video-error-message');
        if (errorDiv) {
            errorDiv.remove();
        }
    },

    switchPage(page) {
        console.log('🔄 Switching to page:', page);
        console.log('📊 Current state:', {
            page: page,
            currentPage: this.current,
            role: this.role,
            isAuthenticated: this.isAuthenticated,
            currentUser: this.currentUser
        });

        this.current = page;
        this.showMobileMenu = false;

        // Add notification for debugging
        this.addNotification(`Switched to ${page}`, 'info');

        console.log('✅ Page switched to:', this.current);
    },

    // Debug method to check current state
    debugCurrentState() {
        console.log('🔍 Current State Debug:');
        console.log('- isAuthenticated:', this.isAuthenticated);
        console.log('- role:', this.role);
        console.log('- current page:', this.current);
        console.log('- currentUser:', this.currentUser);
        console.log('- currentUserIdentifier:', this.currentUserIdentifier);
        this.addNotification(`Debug: Auth=${this.isAuthenticated}, Role=${this.role}, Page=${this.current}`, 'info');
    },

    // Force navigate to PestiVid (for debugging)
    forceToPestiVid() {
        console.log('🔧 Force navigating to PestiVid...');
        console.log('🔍 Current state before force navigation:', {
            isAuthenticated: this.isAuthenticated,
            role: this.role,
            currentUser: this.currentUser,
            current: this.current
        });

        if (!this.isAuthenticated) {
            this.addNotification('❌ Please login first', 'warning');
            return;
        }

        // Force navigate regardless of role for debugging
        this.current = 'farmerPestiVid';
        this.addNotification('✅ Force navigated to PestiVid', 'success');

        console.log('✅ Force navigation complete. Current page:', this.current);
    },

    // Temporarily disable wallet listeners to prevent conflicts during video recording
    disableWalletListeners() {
        console.log('🔇 Temporarily disabling wallet listeners for video recording...');
        this.walletListenersActive = false;

        // Stop any ongoing wallet monitoring
        if (this.balanceUpdateInterval) {
            clearInterval(this.balanceUpdateInterval);
            this.balanceUpdateInterval = null;
        }
    },

    // Re-enable wallet listeners after video recording
    enableWalletListeners() {
        console.log('🔊 Re-enabling wallet listeners after video recording...');
        this.walletListenersActive = true;

        // Restart wallet monitoring if wallet is connected
        if (this.walletConnected && this.realTimeMonitoring) {
            // Note: startRealTimeMonitoring method needs to be implemented if real-time monitoring is needed
            console.log('🔄 Would restart real-time monitoring here');
        }
    },

    // Debug method to check wallet listener status
    debugWalletListeners() {
        console.log('🔍 Wallet Listeners Debug:');
        console.log('- walletListenersActive:', this.walletListenersActive);
        console.log('- walletConnected:', this.walletConnected);
        console.log('- recording:', this.recording);
        console.log('- uploading:', this.uploading);
        console.log('- realTimeMonitoring:', this.realTimeMonitoring);

        this.addNotification(`Wallet Listeners: ${this.walletListenersActive ? 'Active' : 'Disabled'}`, 'info');
    },

    // Comprehensive debug method to test PestiVid functionality
    async debugPestiVidFunctionality() {
        console.log('🧪 Testing PestiVid Functionality...');

        const testResults = {
            navigation: false,
            authentication: false,
            role: false,
            videoSection: false,
            cameraAccess: false,
            walletConflict: false
        };

        try {
            // Test 1: Navigation
            console.log('1️⃣ Testing navigation...');
            const originalPage = this.current;
            this.current = 'farmerPestiVid';
            testResults.navigation = (this.current === 'farmerPestiVid');
            console.log('✅ Navigation test:', testResults.navigation);

            // Test 2: Authentication
            console.log('2️⃣ Testing authentication...');
            testResults.authentication = this.isAuthenticated;
            console.log('✅ Authentication test:', testResults.authentication);

            // Test 3: Role
            console.log('3️⃣ Testing role...');
            testResults.role = (this.role === 'farmer');
            console.log('✅ Role test:', testResults.role, '(Current role:', this.role, ')');

            // Test 4: Video section visibility
            console.log('4️⃣ Testing video section...');
            testResults.videoSection = (this.current === 'farmerPestiVid' && this.isAuthenticated && this.role === 'farmer');
            console.log('✅ Video section test:', testResults.videoSection);

            // Test 5: Camera access (simulated)
            console.log('5️⃣ Testing camera access simulation...');
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                testResults.cameraAccess = true;
                console.log('✅ Camera API available');
            } else {
                console.log('❌ Camera API not available');
            }

            // Test 6: Wallet conflict
            console.log('6️⃣ Testing wallet conflict...');
            testResults.walletConflict = (this.walletConnected && !this.walletListenersActive);
            console.log('✅ Wallet conflict test:', testResults.walletConflict);

            // Summary
            console.log('📊 Test Results Summary:', testResults);

            const passedTests = Object.values(testResults).filter(result => result === true).length;
            const totalTests = Object.keys(testResults).length;

            this.addNotification(`PestiVid Test: ${passedTests}/${totalTests} tests passed`, passedTests === totalTests ? 'success' : 'warning');

            // Restore original page
            this.current = originalPage;

            return testResults;

        } catch (error) {
            console.error('❌ Error during PestiVid functionality test:', error);
            this.addNotification('PestiVid test failed: ' + error.message, 'error');
            return testResults;
        }
    },

    // Test PestiVid after wallet connection
    async testPestiVidWithWallet() {
        console.log('🧪 Testing PestiVid with Wallet Connection...');

        try {
            // Step 1: Connect wallet if not connected
            if (!this.walletConnected) {
                console.log('1️⃣ Connecting wallet first...');
                const connected = await this.connectWallet();
                if (!connected) {
                    this.addNotification('❌ Wallet connection failed - cannot test PestiVid', 'error');
                    return false;
                }

                // Wait a moment for wallet state to settle
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            // Step 2: Test PestiVid functionality
            console.log('2️⃣ Testing PestiVid functionality with wallet connected...');
            const testResults = await this.debugPestiVidFunctionality();

            // Step 3: Specific wallet-related tests
            console.log('3️⃣ Running wallet-specific tests...');

            const walletTests = {
                walletConnected: this.walletConnected,
                walletListenersActive: this.walletListenersActive,
                balanceLoaded: this.walletBalance !== null,
                noJSErrors: true // We'll assume true if we get this far
            };

            console.log('📊 Wallet-specific test results:', walletTests);

            // Step 4: Try to navigate to PestiVid
            console.log('4️⃣ Testing PestiVid navigation with wallet connected...');
            const originalPage = this.current;

            try {
                this.switchPage('farmerPestiVid');
                const navigationWorked = (this.current === 'farmerPestiVid');
                console.log('✅ Navigation with wallet:', navigationWorked);

                if (navigationWorked) {
                    this.addNotification('✅ PestiVid works with wallet connected!', 'success');
                } else {
                    this.addNotification('❌ PestiVid navigation failed with wallet', 'error');
                }

                return navigationWorked;

            } finally {
                // Restore original page after test
                setTimeout(() => {
                    this.current = originalPage;
                }, 2000);
            }

        } catch (error) {
            console.error('❌ Error testing PestiVid with wallet:', error);
            this.addNotification('❌ PestiVid wallet test failed: ' + error.message, 'error');
            return false;
        }
    },

    // Debug method to test listing creation
    async debugListingCreation() {
        console.log('🧪 Testing Listing Creation...');

        try {
            // Test 1: Check authentication
            if (!this.isAuthenticated || this.role !== 'farmer') {
                this.addNotification('❌ Must be logged in as farmer to test listing', 'error');
                return false;
            }

            // Test 2: Check wallet connection
            if (!this.walletConnected || !this.walletAddress) {
                this.addNotification('❌ Wallet must be connected to test listing', 'error');
                return false;
            }

            // Test 3: Check if there are videos available for listing
            const availableVideos = this.availableVideosForListing;
            if (!availableVideos || availableVideos.length === 0) {
                this.addNotification('❌ No videos available for listing. Upload a video first.', 'warning');
                return false;
            }

            // Test 4: Test blockchain listing method
            const testListingData = {
                cid: 'test_cid_123',
                crop: 'Test Crop',
                minPrice: 1.0,
                maxPrice: 2.0,
                farmerWallet: this.walletAddress
            };

            console.log('🔗 Testing blockchain listing creation...');
            const txResult = await this.createAvalancheMarketplaceListing(testListingData);

            if (txResult.success) {
                this.addNotification('✅ Listing creation test passed!', 'success');
                console.log('✅ Test transaction result:', txResult);
                return true;
            } else {
                this.addNotification('⚠️ Blockchain test failed, but database listing should still work', 'warning');
                console.log('⚠️ Test failed:', txResult.error);
                return false;
            }

        } catch (error) {
            console.error('❌ Listing creation test failed:', error);
            this.addNotification('❌ Listing test failed: ' + error.message, 'error');
            return false;
        }
    },

    // Test all on-chain AVAX transactions
    async testOnChainTransactions() {
        console.log('🧪 Testing On-Chain AVAX Transactions...');

        try {
            // Test 1: Check wallet connection and network
            if (!this.walletConnected || !this.walletAddress) {
                this.addNotification('❌ Wallet must be connected to test on-chain transactions', 'error');
                return false;
            }

            // Test 2: Verify Avalanche network
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const network = await provider.getNetwork();

            if (network.chainId !== 43114 && network.chainId !== 43113) {
                this.addNotification('❌ Please switch to Avalanche network', 'error');
                return false;
            }

            console.log('✅ Network check passed:', network.chainId === 43114 ? 'Avalanche Mainnet' : 'Avalanche Fuji');

            // Test 3: Check balance
            const balance = await provider.getBalance(this.walletAddress);
            const balanceAVAX = ethers.utils.formatEther(balance);

            if (parseFloat(balanceAVAX) < 0.01) {
                this.addNotification('❌ Insufficient AVAX balance for testing (need at least 0.01 AVAX)', 'warning');
                return false;
            }

            console.log('✅ Balance check passed:', balanceAVAX, 'AVAX');

            // Test 4: Test small transaction to self
            console.log('🔄 Testing small AVAX transaction...');
            const testAmount = 0.001; // Small test amount

            const txResult = await this.sendAVAXTransaction(
                this.walletAddress, // Send to self
                testAmount,
                'On-Chain Transaction Test'
            );

            if (txResult.success) {
                this.addNotification('✅ On-chain AVAX transaction test successful!', 'success');
                console.log('✅ Test transaction confirmed:', txResult.signature);

                return true;
            } else {
                this.addNotification('❌ On-chain transaction test failed: ' + txResult.error, 'error');
                return false;
            }

        } catch (error) {
            console.error('❌ On-chain transaction test failed:', error);
            this.addNotification('❌ Transaction test failed: ' + error.message, 'error');
            return false;
        }
    },

    // Get transaction status from Avalanche blockchain
    async getTransactionStatus(txHash) {
        try {
            if (!txHash) return null;

            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const receipt = await provider.getTransactionReceipt(txHash);

            if (receipt) {
                return {
                    confirmed: true,
                    success: receipt.status === 1,
                    blockNumber: receipt.blockNumber,
                    gasUsed: receipt.gasUsed.toString(),
                    confirmations: await provider.getBlockNumber() - receipt.blockNumber
                };
            } else {
                // Transaction might be pending
                const tx = await provider.getTransaction(txHash);
                return tx ? { confirmed: false, pending: true } : null;
            }
        } catch (error) {
            console.error('Error getting transaction status:', error);
            return null;
        }
    },

    // View transaction on Avalanche explorer
    viewTransactionOnExplorer(txHash) {
        if (!txHash) return;

        // Use Snowtrace for Avalanche Mainnet or Fuji testnet
        const explorerUrl = 'https://snowtrace.io/tx/' + txHash;
        window.open(explorerUrl, '_blank');

        this.addNotification('Opening transaction in Avalanche explorer...', 'info');
    },

    // Debug purchase process
    async debugPurchaseProcess(listing) {
        console.log('🧪 Debugging Purchase Process...');

        try {
            // Test 1: Check authentication and role
            if (!this.isAuthenticated || this.role !== 'buyer') {
                this.addNotification('❌ Must be logged in as buyer to debug purchase', 'error');
                return false;
            }

            // Test 2: Check wallet connection
            if (!this.walletConnected || !this.walletAddress) {
                this.addNotification('❌ Wallet must be connected to debug purchase', 'error');
                return false;
            }

            // Test 3: Check listing data
            const testListing = listing || this.selectedListing;
            if (!testListing) {
                this.addNotification('❌ No listing selected for purchase debug', 'error');
                return false;
            }

            console.log('✅ Listing data:', testListing);

            // Test 4: Check farmer wallet address
            try {
                const farmerResponse = await axios.get(`${this.apiUrl}/users/${testListing.farmerWallet}`);
                const farmerWalletAddress = farmerResponse.data.walletAddress;

                if (!farmerWalletAddress) {
                    this.addNotification('❌ Farmer wallet address not found', 'error');
                    return false;
                }

                if (!ethers.utils.isAddress(farmerWalletAddress)) {
                    this.addNotification('❌ Invalid farmer wallet address format', 'error');
                    return false;
                }

                console.log('✅ Farmer wallet address:', farmerWalletAddress);
            } catch (error) {
                this.addNotification('❌ Failed to get farmer wallet: ' + error.message, 'error');
                return false;
            }

            // Test 5: Check balance
            const testAmount = testListing.minPrice;
            if (this.walletBalance < testAmount) {
                this.addNotification(`❌ Insufficient balance: ${this.walletBalance} AVAX < ${testAmount} AVAX`, 'error');
                return false;
            }

            console.log('✅ Balance check passed:', this.walletBalance, 'AVAX');

            // Test 6: Check network
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const network = await provider.getNetwork();

            if (network.chainId !== 43114 && network.chainId !== 43113) {
                this.addNotification('❌ Not on Avalanche network', 'error');
                return false;
            }

            console.log('✅ Network check passed:', network.chainId === 43114 ? 'Avalanche Mainnet' : 'Avalanche Fuji');

            this.addNotification('✅ Purchase debug completed - all checks passed!', 'success');
            return true;

        } catch (error) {
            console.error('❌ Purchase debug failed:', error);
            this.addNotification('❌ Purchase debug failed: ' + error.message, 'error');
            return false;
        }
    },

    // Test complete purchase flow
    async testCompletePurchaseFlow() {
        console.log('🧪 Testing Complete Purchase Flow...');

        try {
            // Step 1: Check prerequisites
            if (!this.isAuthenticated || this.role !== 'buyer') {
                this.addNotification('❌ Must be logged in as buyer to test purchase flow', 'error');
                return false;
            }

            if (!this.walletConnected || !this.walletAddress) {
                this.addNotification('❌ Wallet must be connected to test purchase flow', 'error');
                return false;
            }

            // Step 2: Find a test listing
            const testListing = this.allListings.find(l => l.status === 'active' && l.farmerWallet !== this.currentUserIdentifier);

            if (!testListing) {
                this.addNotification('❌ No active listings available for testing', 'warning');
                return false;
            }

            console.log('✅ Found test listing:', testListing.crop);

            // Step 3: Test farmer wallet lookup
            try {
                const farmerResponse = await axios.get(`${this.apiUrl}/users/${testListing.farmerWallet}`);
                const farmerWalletAddress = farmerResponse.data.walletAddress;

                if (!farmerWalletAddress || !ethers.utils.isAddress(farmerWalletAddress)) {
                    this.addNotification('❌ Invalid farmer wallet address', 'error');
                    return false;
                }

                console.log('✅ Farmer wallet verified:', farmerWalletAddress);
            } catch (error) {
                this.addNotification('❌ Failed to verify farmer wallet: ' + error.message, 'error');
                return false;
            }

            // Step 4: Test balance check
            const testAmount = testListing.minPrice;
            if (this.walletBalance < testAmount) {
                this.addNotification(`❌ Insufficient balance for test: ${this.walletBalance} < ${testAmount} AVAX`, 'warning');
                return false;
            }

            console.log('✅ Balance sufficient for test purchase');

            // Step 5: Test network
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const network = await provider.getNetwork();

            if (network.chainId !== 43114 && network.chainId !== 43113) {
                this.addNotification('❌ Not on Avalanche network', 'error');
                return false;
            }

            console.log('✅ Network check passed');

            this.addNotification('✅ Purchase flow test completed - ready for real purchase!', 'success');

            // Optionally set up the purchase modal with test data
            this.selectedListing = testListing;
            this.purchaseAmount = testAmount;

            return true;

        } catch (error) {
            console.error('❌ Purchase flow test failed:', error);
            this.addNotification('❌ Purchase flow test failed: ' + error.message, 'error');
            return false;
        }
    },

    // Debug current purchase state
    debugCurrentPurchaseState() {
        console.log('🔍 PURCHASE STATE DEBUG:');
        console.log('='.repeat(50));

        // Authentication state
        console.log('👤 Authentication:');
        console.log('  - isAuthenticated:', this.isAuthenticated);
        console.log('  - role:', this.role);
        console.log('  - currentUser:', this.currentUser);
        console.log('  - token:', this.token ? 'Present' : 'Missing');

        // Wallet state
        console.log('💳 Wallet:');
        console.log('  - walletConnected:', this.walletConnected);
        console.log('  - walletAddress:', this.walletAddress);
        console.log('  - walletBalance:', this.walletBalance);
        console.log('  - walletType:', this.walletType);

        // Selected listing
        console.log('📋 Selected Listing:');
        console.log('  - selectedListing:', this.selectedListing);
        if (this.selectedListing) {
            console.log('  - listing ID:', this.selectedListing._id);
            console.log('  - crop:', this.selectedListing.crop);
            console.log('  - minPrice:', this.selectedListing.minPrice);
            console.log('  - maxPrice:', this.selectedListing.maxPrice);
            console.log('  - farmerWallet:', this.selectedListing.farmerWallet);
            console.log('  - status:', this.selectedListing.status);
        }

        // Purchase form
        console.log('💰 Purchase Form:');
        console.log('  - purchaseAmount:', this.purchaseAmount);
        console.log('  - purchaseError:', this.purchaseError);
        console.log('  - purchaseStatus:', this.purchaseStatus);
        console.log('  - showBuyModal:', this.showBuyModal);

        // API configuration
        console.log('🌐 API:');
        console.log('  - apiUrl:', this.apiUrl);
        console.log('  - loadingMessage:', this.loadingMessage);
        console.log('  - showLoadingModal:', this.showLoadingModal);

        // Network state
        if (window.ethereum) {
            console.log('🔗 Network:');
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            provider.getNetwork().then(network => {
                console.log('  - chainId:', network.chainId);
                console.log('  - name:', network.name);
            }).catch(err => {
                console.log('  - network error:', err.message);
            });
        }

        console.log('='.repeat(50));

        this.addNotification('Purchase state logged to console', 'info');
    },

    switchToUserDashboard() {
        // Navigate to appropriate dashboard based on user role
        if (this.role === 'farmer') {
            this.switchPage('farmerPestiVid');
        } else if (this.role === 'buyer') {
            this.switchPage('buyerAgriSell');
        } else if (this.role === 'investor') {
            this.switchPage('investorProjects');
        } else {
            this.switchPage('userProfile');
        }
    },
    navigateToPageWithParam(page, paramName, paramValue) {
         if (page === 'farmerSell' && paramName === 'cid') this.listingForm.cid = paramValue;
         else if (page === 'farmerFunding' && paramName === 'cid') this.fundingForm.cid = paramValue;
         else if (page === 'farmerAgriStream' && paramName === 'highlightCid') this.targetAgriStreamVideoCid = paramValue;
         this.switchPage(page);
    },
    getStarted() {
        if (!this.isAuthenticated) { this.addNotification("Please sign up or log in to get started.", "info"); return; }
        if (this.role === 'farmer') { this.switchPage('farmerPestiVid'); }
        else if (this.role === 'buyer') { this.switchPage('buyerAgriSell'); }
        else if (this.role === 'investor') { this.switchPage('investorProjects'); }
        else { this.switchPage('userProfile'); }
    },
    getFarmerDisplayIdentifier(userId, length = 8) {
         if (!userId) return 'N/A';

         // Check if this is the current user
         if (userId === this.currentUserIdentifier && this.currentUser && this.currentUser.name) {
             return this.currentUser.name.split(' ')[0];
         }

         // Look for user in users array
         const user = this.users.find(u => u._id === userId || u.pestividId === userId);
         if (user && user.name) return user.name.split(' ')[0];

         // Fallback to a more readable format
         if (typeof userId === 'string') {
             // If it's a long ID, show first 6 and last 4 characters
             if (userId.length > 12) {
                 return `${userId.substring(0, 6)}...${userId.substring(userId.length - 4)}`;
             }
             return `${userId.substring(0, length)}...`;
         }
         return 'Unknown User';
     },
     getSellerDisplayIdentifier(userId, length = 8) { return this.getFarmerDisplayIdentifier(userId, length); },
     getVideoUrl(objectKeyOrCid, storageType = null) {
         if (!objectKeyOrCid) {
             console.warn('No CID/Key provided for video URL generation');
             return "https://www.w3schools.com/html/mov_bbb.mp4"; // Default fallback
         }

         // Handle demo videos with sample content
         if (storageType === 'demo' || objectKeyOrCid.startsWith('QmSample')) {
             // Return different sample videos based on crop type
             if (objectKeyOrCid.includes('Tomato')) {
                 return "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4";
             } else if (objectKeyOrCid.includes('Corn')) {
                 return "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4";
             } else if (objectKeyOrCid.includes('Carrot')) {
                 return "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerBlazes.mp4";
             } else {
                 // Generic agricultural sample video
                 return "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4";
             }
         }

         let type = storageType;
         if (!type && objectKeyOrCid) {
             // Try to infer type if not provided
             if (typeof objectKeyOrCid === 'string' && (objectKeyOrCid.startsWith('bafy') || objectKeyOrCid.startsWith('Qm'))) {
                 type = 'ipfs';
             } else {
                 type = 'ipfs'; // Default to IPFS
             }
         }

         if (type === 'ipfs' && objectKeyOrCid) {
             const cleanCid = objectKeyOrCid.trim();

             // Try multiple IPFS gateways for better reliability
             const gateways = [
                 this.pinataGateway || 'gateway.pinata.cloud',
                 'ipfs.io',
                 'cloudflare-ipfs.com',
                 'dweb.link'
             ];

             // Use the first available gateway
             const gateway = gateways[0];
             const url = `https://${gateway}/ipfs/${cleanCid}`;
             // console.log(`Generated IPFS URL: ${url} (using gateway: ${gateway})`); // Can be too noisy
             return url;
         }

         console.warn(`Cannot generate video URL for CID/Key: ${objectKeyOrCid} (Storage: ${storageType}). Check config or data.`);
         return "https://www.w3schools.com/html/mov_bbb.mp4"; // Default fallback
     },

    // Alternative video URL for fallback
    getAlternativeVideoUrl(objectKeyOrCid, storageType = null) {
         if (!objectKeyOrCid || storageType !== 'ipfs') return null;

         const cleanCid = objectKeyOrCid.trim();
         const alternativeGateways = [
             'ipfs.io',
             'cloudflare-ipfs.com',
             'dweb.link'
         ];

         // Return a different gateway than the primary one
         const gateway = alternativeGateways[Math.floor(Math.random() * alternativeGateways.length)];
         return `https://${gateway}/ipfs/${cleanCid}`;
     },
    async calculateFileHash(fileBlob) {
         if (!fileBlob) return null;
         try {
             const buffer = await fileBlob.arrayBuffer();
             const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
             const hashArray = Array.from(new Uint8Array(hashBuffer));
             return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
         } catch (error) { console.error("Error calculating file hash:", error); this.addNotification("Error calculating video integrity hash.", "error"); return null; }
     },

    // --- Authentication Methods ---
    async login() {
        // Validation
        if (!this.loginForm.email || !this.loginForm.password) {
            this.addNotification("Please fill in all fields.", "error");
            return;
        }

        this.showLoadingModal = true;
        this.loadingMessage = "Connecting to MongoDB database...";

        // Auto-close loading modal after 30 seconds if still open
        setTimeout(() => {
            if (this.showLoadingModal && this.loadingMessage.includes('database')) {
                console.warn('⚠️ Auto-closing stuck loading modal after 30 seconds');
                this.forceCloseLoadingModal();
                this.addNotification('Login process took too long. Please try again.', 'warning');
            }
        }, 30000);

        console.log('🚀 Starting MongoDB login process...');
        console.log('📧 Email:', this.loginForm.email);
        console.log('🔗 API URL:', this.apiUrl);

        try {
            // Step 1: Verify database connection
            this.loadingMessage = "Verifying database connection...";
            const dbConnected = await this.verifyDatabaseConnection();

            if (!dbConnected) {
                throw new Error('Cannot connect to MongoDB database. Please check if the backend server is running.');
            }

            // Step 2: Authenticate with MongoDB
            this.loadingMessage = "Authenticating with MongoDB...";
            console.log('🔐 Attempting MongoDB authentication...');

            const authResult = await this.authenticateWithMongoDB(this.loginForm.email, this.loginForm.password);

            if (authResult.success) {
                console.log('✅ MongoDB authentication successful!');

                // Save remember preference
                if (this.loginForm.remember) {
                    localStorage.setItem('pestivid_email', this.loginForm.email);
                    localStorage.setItem('pestivid_remember', 'true');
                }

                this.addNotification(`Welcome back, ${this.userNameDisplay}!`, 'success');

                // Clear form
                this.loginForm.email = '';
                this.loginForm.password = '';

                // Load user-specific data from database (with timeout)
                this.loadingMessage = "Loading your data from database...";
                try {
                    await Promise.race([
                        this.loadUserDataFromDatabase(),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('Database loading timeout')), 10000))
                    ]);
                } catch (error) {
                    console.warn('⚠️ Database loading failed or timed out:', error.message);
                    // Continue with login even if database loading fails
                }

                // Try to connect wallet after successful login
                this.loadingMessage = "Checking wallet connection...";
                try {
                    if (!this.walletConnected) {
                        await this.checkExistingWalletConnection();
                        if (this.walletConnected) {
                            this.addNotification('✅ Wallet automatically connected!', 'success');
                        } else {
                            this.addNotification('💡 Connect your wallet for blockchain features', 'info');
                        }
                    }
                } catch (error) {
                    console.warn('⚠️ Wallet connection check failed:', error.message);
                    this.addNotification('💡 Connect your wallet manually for blockchain features', 'info');
                }

                // Close loading modal before redirect
                this.showLoadingModal = false;
                this.loadingMessage = "";

                // Redirect based on role
                this.redirectAfterLogin();

                return;
            } else {
                throw new Error(authResult.error || 'Authentication failed');
            }

        } catch (error) {
            console.error('❌ MongoDB login failed:', error);

            let errorMessage = "Login failed. ";
            if (error.message.includes('Cannot connect')) {
                errorMessage += "Cannot connect to database server. Please ensure the backend is running on port 3002.";
            } else if (error.message.includes('timeout')) {
                errorMessage += "Database connection timeout. Please try again.";
            } else if (error.message.includes('Invalid credentials') || error.message.includes('Authentication failed')) {
                errorMessage += "Invalid email or password. Please check your credentials.";
            } else {
                errorMessage += error.message || "Unknown error occurred.";
            }

            // Add helpful debug information
            console.error('🔍 Debug Info:');
            console.error('📡 API URL:', this.apiUrl + '/auth/login');
            console.error('🗄️ Database Connected:', this.databaseConnected);
            console.error('📧 Email:', this.loginForm.email);

            this.addNotification(errorMessage, "error");
            this.showLoadingModal = false;
            this.loadingMessage = "";
        }
    },

    // Redirect user after successful login based on role
    redirectAfterLogin() {
        console.log('🎯 Redirecting user based on role:', this.role);

        // Always go to home page first as per user preference
        this.current = 'landing';

        // Show success message with role-specific information
        const rolePages = {
            'farmer': 'PestiVid upload page',
            'buyer': 'AgriSell marketplace',
            'investor': 'Investment projects',
            'transporter': 'Transport dashboard'
        };

        const rolePage = rolePages[this.role] || 'platform features';
        this.addNotification(`✅ Welcome back! You can access ${rolePage} from the navigation menu.`, 'success');
    },

    // Load user-specific data from database after login
    async loadUserDataFromDatabase() {
        if (!this.token || !this.databaseConnected) {
            console.log('⚠️ Skipping database data loading - no token or connection');
            return;
        }

        try {
            console.log('📊 Loading user data from MongoDB database...');

            // Load transport data if user is involved in transport (with timeout)
            if (this.mongodbTransportEnabled) {
                await Promise.race([
                    this.loadTransportDataFromDatabase(),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('Transport data loading timeout')), 5000))
                ]);
            }

            console.log('✅ User data loaded from MongoDB database');
        } catch (error) {
            console.error('❌ Failed to load user data from database:', error);
            // Continue without failing the login process - use fallback data
            if (error.message.includes('timeout')) {
                console.log('🔄 Using fallback transport data due to timeout');
                this.loadTransportDataFromLocalStorage();
            }
        }
    },
    signup() {
        if (this.signupForm.password !== this.signupForm.confirmPassword) { this.addNotification("Passwords do not match.", "error"); return; }
        if (!this.signupForm.acceptTerms) { this.addNotification("You must agree to the terms and conditions.", "warning"); return; }

        // Validate phone number
        if (!this.signupForm.phone || this.signupForm.phone.length < 10) {
            this.addNotification("Please enter a valid phone number.", "error");
            return;
        }

        this.loadingMessage = "Creating account..."; this.showLoadingModal = true;

        const signupData = {
            name: this.signupForm.name,
            email: this.signupForm.email,
            phone: this.signupForm.phone,
            password: this.signupForm.password,
            role: this.signupForm.role
        };

        axios.post(this.apiUrl + '/auth/register', signupData)
        .then(response => {
             // Add new user to local users array for demo lookups (if it's not already there - backend would handle uniqueness)
            if (!this.users.find(u => u.email === response.data.user.email)) {
                this.users.push({ ...response.data.user, passwordHash: this.signupForm.password}); // Store password for demo login if needed
                localStorage.setItem('pestivid_users', JSON.stringify(this.users)); // Update users in localStorage for demo
            }

            this.addNotification("Signup successful! Redirecting to login...", "success");
            this.loginForm.email = this.signupForm.email;
            this.loginForm.password = '';
            this.signupForm = { name: '', email: '', phone: '', role: '', password: '', confirmPassword: '', acceptTerms: false };
            this.showLoadingModal = false; this.loadingMessage = "";

            // Redirect to login page after successful signup
            setTimeout(() => {
                this.current = 'login';
            }, 1500);
        })
        .catch(error => {
            this.addNotification("Signup failed. " + (error.response?.data?.message || "Please try again."), "error");
            this.showLoadingModal = false; this.loadingMessage = "";
        });
    },
    logout() {
        this.addNotification("You have been logged out.", "info");
        this.token = null; this.currentUser = null; this.isAuthenticated = false; this.currentUserIdentifier = null;
        this.userName = ''; this.userEmail = ''; this.userPhone = ''; this.memberSince = '';
        localStorage.removeItem('pestivid_token'); localStorage.removeItem('pestivid_user_id');
        // Optionally keep email: localStorage.removeItem('pestivid_email');
        delete axios.defaults.headers.common['Authorization'];
        this.current = 'landing'; this.showMobileMenu = false;
    },
    clearAuthAndRefresh() {
        // Clear all authentication data and refresh page to fix JWT issues
        this.token = null; this.currentUser = null; this.isAuthenticated = false; this.currentUserIdentifier = null; this.role = null;
        localStorage.clear(); // Clear all localStorage data
        delete axios.defaults.headers.common['Authorization'];
        this.addNotification("Authentication cleared. Please login again.", "info");
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    },
    async testMessagingAPI() {
        // Test function to debug messaging API
        console.log('Testing messaging API...');
        console.log('Current user:', this.currentUserIdentifier);
        console.log('Token:', this.token ? 'Present' : 'Missing');
        console.log('API URL:', this.apiUrl);

        try {
            // Test basic API connectivity
            const testResponse = await axios.get(`${this.apiUrl}/messaging/test`);
            console.log('Test endpoint response:', testResponse.data);

            // Test authenticated endpoint
            const authTestResponse = await axios.get(`${this.apiUrl}/messaging/conversations/${this.currentUserIdentifier}`, {
                headers: { 'Authorization': `Bearer ${this.token}` }
            });
            console.log('Auth test response:', authTestResponse.data);

        } catch (error) {
            console.error('API test failed:', error);
            console.error('Error response:', error.response);
        }
    },
    forgotPassword() { this.addNotification("Password reset is not available in this demo.", "info"); },

    async loadPublicPlatformData() {
        try {
            console.log('Loading public platform data from API...');
            // Load active listings from API (public endpoint, no auth required)
            const listingsResponse = await axios.get(`${this.apiUrl}/listings`);
            if (listingsResponse.data && Array.isArray(listingsResponse.data)) {
                this.allListings = listingsResponse.data.filter(l => l.status === 'active');
                console.log('Loaded public listings:', this.allListings.length);
            }

            // Load funding requests from API (public endpoint, no auth required)
            const fundingResponse = await axios.get(`${this.apiUrl}/funding-requests`);
            if (fundingResponse.data && Array.isArray(fundingResponse.data)) {
                this.allFundingRequests = fundingResponse.data.filter(r => ['pending', 'partially_funded'].includes(r.status));
                console.log('Loaded public funding requests:', this.allFundingRequests.length);

                // Initialize investment amounts for loaded projects
                this.$nextTick(() => {
                    this.initializeInvestmentAmounts();
                });
            }

            console.log('Public platform data loaded from API successfully');
        } catch (error) {
            console.error('Error loading public platform data from API:', error);
            // Fallback to localStorage for now
            this.allListings = JSON.parse(localStorage.getItem('pestivid_allListings') || '[]').filter(l => l.status === 'active');
            this.allFundingRequests = JSON.parse(localStorage.getItem('pestivid_allFundingRequests') || '[]').filter(r => ['pending', 'partially_funded'].includes(r.status));
        }
    },
    async loadUserAppData() {
        if (!this.isAuthenticated || !this.currentUserIdentifier) return;

        try {
            // Load farmer videos from API (wallet-based filtering)
            if (this.role === 'farmer') {
                // Use wallet address for farmer data if available
                const farmerIdentifier = this.walletAddress || this.currentUserIdentifier;

                const videosResponse = await axios.get(`${this.apiUrl}/videos/farmer/${this.currentUserIdentifier}`);
                this.farmerVideos = videosResponse.data;

                // Filter listings by wallet address for real DApp functionality
                const listingsResponse = await axios.get(`${this.apiUrl}/listings/farmer/${this.currentUserIdentifier}`);
                this.farmerListings = listingsResponse.data.filter(l => {
                    return l.farmerWalletAddress === this.walletAddress ||
                           (typeof l.farmerWallet === 'object' ? l.farmerWallet._id : l.farmerWallet) === this.currentUserIdentifier;
                });

                try {
                    const fundingResponse = await axios.get(`${this.apiUrl}/funding-requests/farmer/${this.currentUserIdentifier}`, {
                        headers: { 'Authorization': `Bearer ${this.token}` }
                    });
                    this.farmerFundingRequests = fundingResponse.data;
                    console.log('Loaded farmer funding requests from database:', this.farmerFundingRequests.length);
                } catch (error) {
                    console.error('Error loading farmer funding requests from database:', error);
                    // Fallback to localStorage
                    this.farmerFundingRequests = JSON.parse(localStorage.getItem('pestivid_farmerFundingRequests') || '[]')
                        .filter(r => r.farmerWallet === this.currentUserIdentifier);
                }
            }

            if (this.role === 'buyer') {
                try {
                    const purchasesResponse = await axios.get(`${this.apiUrl}/purchases/buyer/${this.currentUserIdentifier}`, {
                        headers: { 'Authorization': `Bearer ${this.token}` }
                    });
                    this.buyerPurchases = purchasesResponse.data;
                    console.log('Loaded buyer purchases from database:', this.buyerPurchases.length);
                } catch (error) {
                    console.error('Error loading buyer purchases from database:', error);
                    // Fallback to localStorage
                    this.buyerPurchases = JSON.parse(localStorage.getItem('pestivid_buyerPurchases') || '[]')
                        .filter(p => p.buyerWallet === this.currentUserIdentifier);
                }
            }

            if (this.role === 'investor') {
                try {
                    const investmentsResponse = await axios.get(`${this.apiUrl}/investments/investor/${this.currentUserIdentifier}`, {
                        headers: { 'Authorization': `Bearer ${this.token}` }
                    });
                    this.investorInvestments = investmentsResponse.data;
                    console.log('Loaded investor investments from database:', this.investorInvestments.length);

                    const transactionsResponse = await axios.get(`${this.apiUrl}/transactions/user/${this.currentUserIdentifier}`, {
                        headers: { 'Authorization': `Bearer ${this.token}` }
                    });
                    this.investorTransactions = transactionsResponse.data;
                    console.log('Loaded investor transactions from database:', this.investorTransactions.length);
                } catch (error) {
                    console.error('Error loading investor data from database:', error);
                    // Fallback to localStorage
                    this.investorInvestments = JSON.parse(localStorage.getItem('pestivid_investorInvestments') || '[]')
                        .filter(i => i.investorWallet === this.currentUserIdentifier);
                    this.investorTransactions = JSON.parse(localStorage.getItem('pestivid_investorTransactions') || '[]')
                        .filter(t => t.userId === this.currentUserIdentifier);
                }
            }

            console.log('User data loaded from API successfully');
        } catch (error) {
            console.error('Error loading user data from API:', error);
            // Fallback to localStorage for now
            this.farmerVideos = JSON.parse(localStorage.getItem('pestivid_farmerVideos') || '[]').filter(v => v.farmerWallet === this.currentUserIdentifier);
            this.farmerListings = JSON.parse(localStorage.getItem('pestivid_farmerListings') || '[]').filter(l => l.farmerWallet === this.currentUserIdentifier);
            this.farmerFundingRequests = JSON.parse(localStorage.getItem('pestivid_farmerFundingRequests') || '[]').filter(r => r.farmerWallet === this.currentUserIdentifier);
            this.buyerPurchases = JSON.parse(localStorage.getItem('pestivid_buyerPurchases') || '[]').filter(p => p.buyerWallet === this.currentUserIdentifier);
            this.investorInvestments = JSON.parse(localStorage.getItem('pestivid_investorInvestments') || '[]').filter(i => i.investorWallet === this.currentUserIdentifier);
            this.investorTransactions = JSON.parse(localStorage.getItem('pestivid_investorTransactions') || '[]').filter(t => t.userId === this.currentUserIdentifier);
        }

        this.loadUserConversations();
        this.loadUserNotifications();
        this.loadAvatarChatHistory();
        const storedAgriBotChat = localStorage.getItem(`pestivid_agribot_chat_${this.currentUserIdentifier}`);
        if (storedAgriBotChat) this.chatMessages = JSON.parse(storedAgriBotChat); else this.chatMessages = [];
    },
    clearUserSpecificData() {
        this.farmerVideos = []; this.farmerListings = []; this.farmerFundingRequests = []; this.farmerTransportRequests = [];
        this.buyerPurchases = []; this.buyerTransportRequests = [];
        this.investorInvestments = []; this.investorTransactions = []; this.investorTransportRequests = [];
        this.conversations = []; this.messages = []; this.notifications = [];
        this.chatMessages = [];
        this.avatar.chatMessages = [];
    },

    // --- Farmer PestiVid ---
    async startVideo() {
        console.log('🎥 Starting video recording...');
        console.log('📊 Current state:', {
            isAuthenticated: this.isAuthenticated,
            role: this.role,
            recording: this.recording,
            uploading: this.uploading,
            walletConnected: this.walletConnected
        });

        if (!this.isAuthenticated || this.role !== 'farmer') {
            this.addNotification("Please log in as a Farmer to record videos.", "info");
            return;
        }

        // Wallet connection is optional for recording
        // Users will be prompted to connect wallet when they want to sell or get funding

        if (this.recording || this.uploading) {
            console.log('⚠️ Already recording or uploading, skipping...');
            return;
        }

        // Validate form fields before starting recording
        if (!this.recordForm.crop || !this.recordForm.location || !this.recordForm.pesticide || !this.recordForm.pesticideCompany || !this.recordForm.purpose) {
            this.addNotification("Please fill in all crop details before recording.", "warning");
            return;
        }

        console.log('✅ Validation passed, starting camera...');

        if (window.location.protocol !== 'https:' && !['localhost', '127.0.0.1'].includes(window.location.hostname) ) {
             console.warn("HTTPS is highly recommended for camera access.");
         }
        // Reset video state (isolated from wallet state)
        this.recordBlob = null;
        if (this.recordBlobUrl) URL.revokeObjectURL(this.recordBlobUrl);
        this.recordBlobUrl = '';
        this.uploadCid = '';
        this.uploadError = '';
        this.lastUploadedVideoFileHash = '';

        // Set recording state
        this.showLive = true;
        this.recording = true;

        console.log('📹 Requesting camera access...');

        try {
            // Temporarily disable wallet listeners during video recording to prevent conflicts
            this.disableWalletListeners();

            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment" },
                audio: false
            });

            console.log('✅ Camera access granted, setting up recording...');
            this.recordStream = stream;
            this.$refs.liveVideo.srcObject = stream;
            this.$refs.liveVideo.play();

            let chunks = [];
            const mimeTypes = ['video/webm;codecs=vp9,opus', 'video/webm;codecs=vp8,opus', 'video/webm', 'video/mp4'];
            let selectedMimeType = mimeTypes.find(type => MediaRecorder.isTypeSupported(type)) || undefined;

            this.recordMediaRecorder = new MediaRecorder(stream, { mimeType: selectedMimeType });

            this.recordMediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) chunks.push(e.data);
            };

            this.recordMediaRecorder.onstop = () => {
                console.log('🛑 Recording stopped, processing video...');
                const blobType = this.recordMediaRecorder.mimeType || 'video/webm';
                this.recordBlob = new Blob(chunks, { type: blobType });
                if (this.recordBlobUrl) URL.revokeObjectURL(this.recordBlobUrl);
                this.recordBlobUrl = URL.createObjectURL(this.recordBlob);
                this.showLive = false;
                stream.getTracks().forEach(t => t.stop());
                this.recordStream = null;
                this.recording = false;
                chunks = [];

                // Re-enable wallet listeners after recording
                this.enableWalletListeners();
                console.log('✅ Video recording completed successfully');
            };

            this.recordMediaRecorder.onerror = (e) => {
                console.error("MediaRecorder error:", e);
                this.uploadError = "Recording error: " + (e.error ? e.error.name : "Unknown");
                this.addNotification(this.uploadError, "error");
                // Re-enable wallet listeners on error
                this.enableWalletListeners();
                this.stopVideo();
            };

            this.recordMediaRecorder.start(1000);
            console.log('🎬 Recording started successfully');
        } catch (e) {
            console.error("❌ Error starting video recording:", e);

            // Re-enable wallet listeners on error
            this.enableWalletListeners();

            let userErrorMessage = "Could not start video recording. ";

            if (e.name === 'NotAllowedError' || e.name === 'PermissionDeniedError') {
                userErrorMessage += "Camera access was denied. Please allow camera access and try again.";
            } else if (e.name === 'NotFoundError' || e.name === 'DevicesNotFoundError') {
                userErrorMessage += "No camera found. Please check your camera connection.";
            } else if (e.name === 'NotReadableError') {
                userErrorMessage += "Camera is already in use by another application.";
            } else if (e.name === 'OverconstrainedError') {
                userErrorMessage += "Camera constraints could not be satisfied.";
            } else {
                userErrorMessage += `Error: ${e.name || e.message}.`;
            }

            if (window.location.protocol !== 'https:' && !['localhost', '127.0.0.1'].includes(window.location.hostname)) {
                userErrorMessage += " Note: HTTPS is recommended for camera access.";
            }

            // Add wallet connection status to error message for debugging
            if (this.walletConnected) {
                userErrorMessage += " (Wallet connected - this might be related to the issue)";
            }

            this.addNotification(userErrorMessage, "error");
            this.uploadError = userErrorMessage;
            this.showLive = false;
            this.recording = false;

            if (this.recordStream) {
                this.recordStream.getTracks().forEach(t => t.stop());
                this.recordStream = null;
            }
        }
    },
    stopVideo() {
        console.log('🛑 Stopping video recording...');

        if (this.recordMediaRecorder && this.recordMediaRecorder.state === "recording") {
            this.recordMediaRecorder.stop();
        }

        if (this.recordStream) {
            this.recordStream.getTracks().forEach(t => t.stop());
            this.recordStream = null;
        }

        this.recording = false;

        // Ensure wallet listeners are re-enabled when stopping video
        this.enableWalletListeners();

        console.log('✅ Video recording stopped and wallet listeners restored');
    },
    async uploadVideo() {
        if (!this.isAuthenticated || this.role !== 'farmer') { this.addNotification("Log in as Farmer.", "info"); return; }
        if (!this.recordBlob || this.recordBlob.size === 0) { this.addNotification("No video or empty video.", "warning"); return; }
        if (!this.recordForm.crop || !this.recordForm.location || !this.recordForm.purpose) { this.addNotification("Fill video details.", "warning"); return; }

        if (this.pinataJwt === 'YOUR_PINATA_JWT_MUST_BE_REPLACED_HERE' || !this.pinataJwt || this.pinataJwt.length < 50) {
            const errorMsg = "CRITICAL ERROR: Pinata JWT is not configured. Video uploads WILL FAIL. Please update 'pinataJwt' in the script.";
            this.uploadError = errorMsg;
            this.addNotification(errorMsg, "error");
            console.error(errorMsg);
            return;
        }

        this.uploading = true; this.uploadCid = ''; this.uploadError = ''; this.lastUploadedVideoFileHash = '';
        this.loadingMessage = "Calculating hash..."; this.showLoadingModal = true;
        const videoFileHash = await this.calculateFileHash(this.recordBlob);
        if (!videoFileHash) { this.showLoadingModal = false; this.uploadError = "Hash calculation failed."; this.addNotification(this.uploadError, "error"); this.uploading = false; return; }
        this.lastUploadedVideoFileHash = videoFileHash;

        this.loadingMessage = "Uploading to IPFS via Pinata...";
        const formData = new FormData();
        const fileExtension = (this.recordBlob.type.split('/')[1] || 'webm').split(';')[0];
        const farmerIdPart = (this.currentUserIdentifier || 'unknown_farmer').toString().replace(/[^a-zA-Z0-9_-]/g, '_').substring(0, 20);
        const cropPart = (this.recordForm.crop || 'crop').replace(/[^a-zA-Z0-9_-]/g, '_').substring(0, 15);
        const fileName = `pestivid_${farmerIdPart}_${Date.now()}_${cropPart}.${fileExtension}`;
        formData.append('file', this.recordBlob, fileName);
        const metadata = {
            name: fileName,
            keyvalues: {
                uploaderId: this.currentUserIdentifier.toString(),
                role: this.role,
                crop: this.recordForm.crop.trim(),
                pesticide: (this.recordForm.pesticide || '').trim(),
                location: this.recordForm.location.trim(),
                pesticideCompany: (this.recordForm.pesticideCompany || '').trim(),
                purpose: this.recordForm.purpose,
                uploadTimestamp: new Date().toISOString(),
                videoFileSHA256: videoFileHash || '',
            }
        };
        formData.append('pinataMetadata', JSON.stringify(metadata));
        formData.append('pinataOptions', JSON.stringify({ cidVersion: 1 }));

        try {
            const resp = await axios.post('https://api.pinata.cloud/pinning/pinFileToIPFS', formData, {
                maxBodyLength: Infinity, // Recommended for file uploads
                headers: {
                    'Authorization': `Bearer ${this.pinataJwt}`,
                    // Content-Type is automatically set by browser for FormData
                }
            });
            this.saveVideoMetadata(resp.data.IpfsHash, 'ipfs', videoFileHash);
        } catch (e) {
            console.error("Pinata Upload Error:", e);
            let errMsg = "IPFS upload failed. ";
            if (e.response) {
                errMsg += `Server: ${e.response.status}. ${e.response.data?.error?.details || e.response.data?.error || e.message}`;
                if (e.response.status === 401) errMsg += " Bad Pinata JWT (check it's valid & has pinning permissions).";
            } else if (e.request) {
                errMsg += " Network/CORS error.";
            } else {
                errMsg += e.message || "Unknown error";
            }
            this.uploadError = errMsg; this.addNotification(this.uploadError, "error");
        } finally {
            this.uploading = false; this.showLoadingModal = false; this.loadingMessage = '';
        }
    },
    async saveVideoMetadata(cid, storageType, videoFileHash) {
        try {
            const videoData = {
                cid: cid, // This is the IPFS Hash
                storageType: storageType, // Should be 'ipfs'
                videoFileHash: videoFileHash,
                crop: this.recordForm.crop.trim(),
                pesticide: (this.recordForm.pesticide || '').trim(),
                location: this.recordForm.location.trim(),
                pesticideCompany: (this.recordForm.pesticideCompany || '').trim(),
                purpose: this.recordForm.purpose
            };

            const response = await axios.post(`${this.apiUrl}/videos`, videoData, {
                headers: {
                    'Authorization': `Bearer ${this.token}`,
                    'Content-Type': 'application/json'
                }
            });

            this.farmerVideos.unshift(response.data); // Update UI immediately

            this.uploadCid = response.data.cid; // This is the IPFS Hash
            this.lastUploadedVideoPurpose = response.data.purpose;
            this.lastUploadedVideoFileHash = response.data.videoFileHash;

            this.recordForm = { crop: '', pesticide: '', location: '', pesticideCompany: '', purpose: 'agristream' };
            if (this.recordBlobUrl) URL.revokeObjectURL(this.recordBlobUrl);
            this.recordBlob = null;
            this.recordBlobUrl = '';

            if (response.data.purpose === 'sell') {
                this.addNotification(`Video for "${response.data.crop}" uploaded to IPFS and saved to database. Ready for listing!`, 'info');
                // Automatically redirect to sell page to create listing
                this.navigateToPageWithParam('farmerSell', 'cid', response.data.cid);
            } else if (response.data.purpose === 'funding') {
                this.addNotification(`Video for "${response.data.crop}" uploaded to IPFS and saved to database. Redirecting...`, 'info');
                this.navigateToPageWithParam('farmerFunding', 'cid', response.data.cid);
            } else {
                this.addNotification(`Video for "${response.data.crop}" uploaded to IPFS and saved to database! Added to AgriStream.`, 'success');
                if (this.current === 'farmerAgriStream') {
                    this.targetAgriStreamVideoCid = response.data.cid;
                    this.$nextTick(() => this.scrollToAndHighlightAgriStreamVideo());
                }
            }
        } catch (error) {
            console.error('Error saving video metadata (after IPFS upload):', error);
            this.addNotification('Failed to save video metadata post-upload: ' + (error.response?.data?.message || error.message), 'error');
            // Note: IPFS upload might have succeeded, but DB save failed. Handle this discrepancy.
        } finally {
            this.uploading = false; // Ensure this is reset
        }
    },


    // --- Farmer AgriStream ---
    isListed(cid) {
        return this.farmerListings.some(l => {
            const farmerWalletId = typeof l.farmerWallet === 'object' ? l.farmerWallet._id : l.farmerWallet;
            return l.cid === cid && farmerWalletId === this.currentUserIdentifier && l.status === 'active';
        });
    },
    isUsedInFunding(cid) {
        return this.farmerFundingRequests.some(req => {
            const farmerWalletId = typeof req.farmerWallet === 'object' ? req.farmerWallet._id : req.farmerWallet;
            return req.cid === cid && farmerWalletId === this.currentUserIdentifier && ['pending', 'partially_funded', 'funded', 'growing'].includes(req.status);
        });
    },
    goToListing(cid) { this.navigateToPageWithParam('farmerSell', 'cid', cid); },
    scrollToAndHighlightAgriStreamVideo() {
        if (this.targetAgriStreamVideoCid) {
            this.highlightedAgriStreamVideoCid = this.targetAgriStreamVideoCid;
            this.$nextTick(() => {
                const videoCardRef = this.$refs['videoCard-' + this.targetAgriStreamVideoCid];
                if (videoCardRef && videoCardRef[0]) {
                    videoCardRef[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                    setTimeout(() => { this.highlightedAgriStreamVideoCid = null; this.targetAgriStreamVideoCid = null; }, 3000);
                } else {
                    setTimeout(() => {
                        const videoCardRefRetry = this.$refs['videoCard-' + this.targetAgriStreamVideoCid];
                        if (videoCardRefRetry && videoCardRefRetry[0]) videoCardRefRetry[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                        setTimeout(() => { this.highlightedAgriStreamVideoCid = null; this.targetAgriStreamVideoCid = null; }, 3000);
                    }, 500);
                }
            });
        }
    },

    // --- Farmer Sell ---
    async createListing() {
        if (!this.isAuthenticated || this.role !== 'farmer') { this.addNotification("Log in as Farmer.", "info"); return; }

        // Auto-connect wallet when creating listing
        if (!this.walletConnected) {
            this.addNotification("Connecting wallet to create listings and receive payments...", "info");
            const connected = await this.ensureWalletConnected();
            if (!connected) {
                this.addNotification("Wallet connection required to create listings.", "warning");
                return;
            }
        }

        // Validate wallet address
        if (!this.walletAddress) {
            this.addNotification("Wallet not properly connected. Please reconnect your MetaMask wallet.", "warning");
            return;
        }

        if (!this.listingForm.cid || this.listingForm.minPrice === null || this.listingForm.maxPrice === null) { this.addNotification("Select video and price range.", "warning"); return; }
        const minP = parseFloat(this.listingForm.minPrice); const maxP = parseFloat(this.listingForm.maxPrice);

        if (isNaN(minP) || isNaN(maxP) || minP < 0.0001 || maxP < 0.0001 || minP > maxP) { this.addNotification("Valid prices required. Minimum price must be at least 0.0001 AVAX.", "warning"); return; }

        const vid = this.farmerVideos.find(v => {
            const farmerWalletId = typeof v.farmerWallet === 'object' ? v.farmerWallet._id : v.farmerWallet;
            return v.cid === this.listingForm.cid && farmerWalletId === this.currentUserIdentifier;
        });
        if (!vid) { this.addNotification("Video not found or invalid.", "error"); return; }
        if (this.isListed(vid.cid)) { this.addNotification("Video already listed.", "warning"); return; }

        console.log('Found video for listing:', vid);

        // Validate that the video has required fields
        if (!vid.crop || vid.crop.trim() === '') {
            this.addNotification("Video is missing crop information. Please re-upload the video with complete details.", "error");
            return;
        }
        if (!vid.location || vid.location.trim() === '') {
            this.addNotification("Video is missing location information. Please re-upload the video with complete details.", "error");
            return;
        }

        this.loadingMessage = "Creating listing..."; this.showLoadingModal = true;
        this.createdListingId = null; this.listingNotificationSent = false;

        try {
            // Create blockchain transaction for listing (small fee to record on-chain)
            this.loadingMessage = "Recording listing on blockchain...";

            const listingBlockchainData = {
                cid: this.listingForm.cid,
                crop: vid.crop.trim(),
                minPrice: minP,
                maxPrice: maxP,
                farmerWallet: this.walletAddress // Use MetaMask wallet address
            };

            // Create marketplace listing on Avalanche blockchain
            let txResult;
            try {
                txResult = await this.createAvalancheMarketplaceListing(listingBlockchainData);

                if (!txResult.success) {
                    console.warn('⚠️ Blockchain listing failed, creating database-only listing:', txResult.error);
                    // Create a fallback transaction result for database storage
                    txResult = {
                        success: true,
                        signature: 'db_only_' + Date.now(),
                        blockNumber: 0,
                        gasUsed: '0',
                        fallback: true
                    };
                }
            } catch (blockchainError) {
                console.warn('⚠️ Blockchain error, creating database-only listing:', blockchainError);
                // Create a fallback transaction result for database storage
                txResult = {
                    success: true,
                    signature: 'db_only_' + Date.now(),
                    blockNumber: 0,
                    gasUsed: '0',
                    fallback: true
                };
            }

            this.loadingMessage = "Saving listing to database...";

            const listingData = {
                cid: this.listingForm.cid, // This is IPFS CID
                storageType: 'ipfs', // Explicitly set
                videoFileHash: vid.videoFileHash || '',
                crop: vid.crop.trim(),
                location: vid.location.trim(),
                pesticide: (vid.pesticide || '').trim(),
                pesticideCompany: (vid.pesticideCompany || '').trim(),
                minPrice: minP,
                maxPrice: maxP,
                notifyBuyers: this.listingForm.notifyBuyers,
                txHash: txResult.signature, // Real blockchain transaction hash
                blockchainNetwork: 'avalanche-mainnet',
                farmerWallet: this.walletAddress // Use MetaMask wallet address
            };

            console.log('Creating listing with blockchain data:', listingData);
            console.log('Video crop:', vid.crop, 'Video location:', vid.location);

            const response = await axios.post(`${this.apiUrl}/listings`, listingData, {
                headers: {
                    'Authorization': `Bearer ${this.token}`,
                    'Content-Type': 'application/json'
                }
            });

            this.farmerListings.unshift(response.data);
            this.allListings.unshift(response.data);

            // Refresh public marketplace data to ensure the listing appears for buyers
            await this.loadPublicPlatformData();

            this.createdListingId = txResult.signature; // Use transaction hash or fallback ID
            this.listingNotificationSent = response.data.notificationSent;

            if (txResult.fallback) {
                this.addNotification(`Listing created successfully! Now available in marketplace.`, 'success');
            } else {
                this.addNotification(`Listing created on blockchain! Transaction: ${txResult.signature.substring(0, 8)}... Now available in marketplace.`, 'success');
            }

            if (response.data.notificationSent) {
                this.addNotification('Potential buyers will be notified.', 'info', null, true);
            }

            this.listingForm = { cid: '', minPrice: null, maxPrice: null, notifyBuyers: true };
            setTimeout(() => { this.createdListingId = null; this.uploadError = ''; }, 5000);

        } catch (error) {
            console.error('Error creating listing:', error);
            this.addNotification('Failed to create listing: ' + (error.response?.data?.message || error.message), 'error');
        } finally {
            this.showLoadingModal = false;
            this.loadingMessage = '';
        }
    },
    notifyBuyersAboutListing(listing, isResend = false) {
         if (!listing.notificationSent || isResend) {
             this.addNotification(`Simulating notification to buyers for "${listing.crop}".`, "success", null, true);
             const lIdx = this.farmerListings.findIndex(l => l._id === listing._id);
             if (lIdx > -1) this.$set(this.farmerListings[lIdx], 'notificationSent', true);
             const allLIdx = this.allListings.findIndex(l => l._id === listing._id);
             if (allLIdx > -1) this.$set(this.allListings[allLIdx], 'notificationSent', true);
              localStorage.setItem('pestivid_farmerListings', JSON.stringify(this.farmerListings));
              localStorage.setItem('pestivid_allListings', JSON.stringify(this.allListings));
         } else { this.addNotification("Buyers already notified for this listing.", "info"); }
    },

    // --- Farmer Funding ---
    fundingProgressPercent(req) {
        if (!req || typeof req.fundedAmount !== 'number' || typeof req.amount !== 'number' || req.amount === 0) return 0;
        return Math.min(100, Math.round((req.fundedAmount / req.amount) * 100));
    },
    async createFundingRequest_V1() {
        if (!this.isAuthenticated || this.role !== 'farmer') { this.addNotification("Log in as Farmer.", "info"); return; }

        // Check wallet connection when creating funding request
        if (!this.walletConnected) {
            this.addNotification("Please connect your wallet to create funding requests and receive investments from investors.", "warning");
            return;
        }

        const form = this.fundingForm;
        const required = ['title', 'crop', 'acres', 'amount', 'method', 'cid', 'description', 'timeline', 'roi', 'investorShare'];
        if (required.some(field => form[field] === null || form[field] === undefined || (typeof form[field] === 'string' && form[field].trim() === ''))) { this.addNotification("Fill all required fields.", "warning"); return; }
        const parsedAcres = parseFloat(form.acres); const parsedAmount = parseFloat(form.amount);
        const parsedTimeline = parseInt(form.timeline, 10); const parsedRoi = parseFloat(form.roi);
        const parsedInvestorShare = parseFloat(form.investorShare);
        if (isNaN(parsedAcres) || parsedAcres <= 0 || isNaN(parsedAmount) || parsedAmount <= 0 || isNaN(parsedTimeline) || parsedTimeline <= 0 || isNaN(parsedRoi) || parsedRoi < 0 || parsedRoi > 100 || isNaN(parsedInvestorShare) || parsedInvestorShare < 0 || parsedInvestorShare > 100) { this.addNotification("Valid numeric values required.", "warning"); return; }
        if (parsedInvestorShare > 80 && this.role !== 'admin') { this.addNotification("Investor Share cannot exceed 80%.", "warning"); return;}

        const vid = this.farmerVideos.find(v => v.cid === form.cid && v.farmerWallet === this.currentUserIdentifier);
        if (!vid) { this.addNotification("Selected video not found for funding.", "error"); return; }
        if (this.isUsedInFunding(vid.cid)) { this.addNotification("Video already used for a funding request.", "warning"); return; }

        this.loadingMessage = "Creating funding request..."; this.showLoadingModal = true; this.createdFundingRequest = false;

        try {
            // Send funding request to backend API
            const fundingRequestData = {
                title: form.title.trim(),
                crop: form.crop.trim(),
                acres: parsedAcres,
                amount: parsedAmount,
                method: form.method,
                cid: form.cid,
                videoStorageType: 'ipfs',
                videoFileHash: vid.videoFileHash,
                description: form.description.trim(),
                timeline: parsedTimeline,
                roi: parsedRoi,
                investorShare: parsedInvestorShare
            };

            console.log('Creating funding request:', fundingRequestData);

            const response = await axios.post(`${this.apiUrl}/funding-requests`, fundingRequestData, {
                headers: {
                    'Authorization': `Bearer ${this.token}`,
                    'Content-Type': 'application/json'
                }
            });

            console.log('Funding request created successfully:', response.data);

            // Add to local arrays for immediate UI update
            this.farmerFundingRequests.unshift(response.data);
            this.allFundingRequests.unshift(response.data);

            // Save to localStorage as backup
            localStorage.setItem('pestivid_farmerFundingRequests', JSON.stringify(this.farmerFundingRequests));
            localStorage.setItem('pestivid_allFundingRequests', JSON.stringify(this.allFundingRequests));

            // Refresh public platform data to ensure the funding request appears for investors
            await this.loadPublicPlatformData();

            this.createdFundingRequest = true;
            this.addNotification(`Investment Opportunity: "${response.data.title}" by ${this.getFarmerDisplayIdentifier(response.data.farmerWallet)} created successfully. Investors will be notified.`, 'info', null, true);
            this.fundingForm = { title: '', crop: '', acres: null, amount: null, method: '', cid: '', description: '', timeline: null, roi: null, investorShare: null };
            setTimeout(() => { this.createdFundingRequest = false; }, 3000);
            this.showLoadingModal = false; this.loadingMessage = '';

        } catch (error) {
            console.error('Error creating funding request:', error);
            this.showLoadingModal = false; this.loadingMessage = '';

            // Fallback to local storage
            console.log('Falling back to local storage...');
            const newRequest = {
                _id: this.generateId('fundreq_'), title: form.title.trim(), crop: form.crop.trim(), acres: parsedAcres, amount: parsedAmount, fundedAmount: 0,
                method: form.method, cid: form.cid, videoStorageType: 'ipfs', videoFileHash: vid.videoFileHash,
                description: form.description.trim(), timeline: parsedTimeline, roi: parsedRoi, investorShare: parsedInvestorShare,
                farmerWallet: this.currentUserIdentifier, status: 'pending', investors: [], updates: [], createdAt: new Date().toISOString(),
            };
            this.farmerFundingRequests.unshift(newRequest);
            this.allFundingRequests.unshift(newRequest);
            localStorage.setItem('pestivid_farmerFundingRequests', JSON.stringify(this.farmerFundingRequests));
            localStorage.setItem('pestivid_allFundingRequests', JSON.stringify(this.allFundingRequests));
            this.createdFundingRequest = true;
            this.addNotification(`Investment Opportunity: "${newRequest.title}" by ${this.getFarmerDisplayIdentifier(newRequest.farmerWallet)} created successfully (stored locally). API connection issue.`, 'warning', null, true);
            this.fundingForm = { title: '', crop: '', acres: null, amount: null, method: '', cid: '', description: '', timeline: null, roi: null, investorShare: null };
            setTimeout(() => { this.createdFundingRequest = false; }, 3000);
        }
    },
    cancelFundingRequest_V1(requestId) {
        if (!this.isAuthenticated || this.role !== 'farmer') { this.addNotification("Log in as Farmer.", "info"); return; }
        const reqIndex = this.farmerFundingRequests.findIndex(r => r._id === requestId && r.farmerWallet === this.currentUserIdentifier);
        if (reqIndex === -1) { this.addNotification("Request not found.", "error"); return; }
        const req = this.farmerFundingRequests[reqIndex];
        if (req.fundedAmount > 0) { if (!confirm(`Request has ${req.fundedAmount} SOL funding. Cancelling simulates refund. Cancel "${req.title}"?`)) return; }
        else { if (!confirm(`Cancel funding request "${req.title}"?`)) return; }

        this.loadingMessage = "Cancelling request..."; this.showLoadingModal = true;
        this.farmerFundingRequests.splice(reqIndex, 1);
        const allReqIndex = this.allFundingRequests.findIndex(r => r._id === requestId);
        if (allReqIndex > -1) this.allFundingRequests.splice(allReqIndex, 1);
        localStorage.setItem('pestivid_farmerFundingRequests', JSON.stringify(this.farmerFundingRequests));
        localStorage.setItem('pestivid_allFundingRequests', JSON.stringify(this.allFundingRequests));
        this.addNotification(`Request "${req.title}" cancelled. Investors refunded (simulated).`, 'success');
        this.showLoadingModal = false; this.loadingMessage = '';
    },

    // --- Buyer AgriSell ---
    resetBuyerFilters() { this.buyerFilters = {crop:'', location:'', pesticideCompany: ''}; },
    async buyListing(listing) {
        if (!this.isAuthenticated || this.role !== 'buyer') { this.addNotification("Log in as Buyer.", "info"); return; }
        if (this.currentUserIdentifier === listing.farmerWallet) { this.addNotification("Cannot buy your own listing.", "warning"); return; }

        // Auto-connect wallet for blockchain purchases
        if (!this.walletConnected) {
            this.addNotification("Connecting wallet for blockchain purchase...", "info");
            const connected = await this.ensureWalletConnected();
            if (!connected) {
                this.addNotification("Wallet connection required for blockchain purchases.", "warning");
                return;
            }
        }

        this.selectedListing = listing; this.purchaseAmount = parseFloat(listing.minPrice.toFixed(2));
        this.purchaseStatus = ''; this.purchaseError = ''; this.showBuyModal = true;
    },
    closeBuyModal() { this.showBuyModal = false; this.selectedListing = null; this.purchaseAmount = null; },
    async processPurchase() {
        console.log('🚀 PURCHASE DEBUG: Starting processPurchase()');
        console.log('📊 PURCHASE DEBUG: selectedListing:', this.selectedListing);
        console.log('💰 PURCHASE DEBUG: purchaseAmount:', this.purchaseAmount);

        if (!this.selectedListing || this.purchaseAmount === null) {
            console.log('❌ PURCHASE DEBUG: Missing listing or amount');
            return;
        }

        const amount = parseFloat(this.purchaseAmount);
        console.log('💵 PURCHASE DEBUG: Parsed amount:', amount);

        if (isNaN(amount) || amount < this.selectedListing.minPrice || amount > this.selectedListing.maxPrice) {
            const error = `Offer must be between ${this.selectedListing.minPrice} and ${this.selectedListing.maxPrice} AVAX.`;
            console.log('❌ PURCHASE DEBUG: Amount validation failed:', error);
            this.purchaseError = error;
            return;
        }

        // Check wallet connection
        console.log('🔗 PURCHASE DEBUG: Checking wallet connection...');
        console.log('🔗 PURCHASE DEBUG: walletConnected:', this.walletConnected);
        console.log('🔗 PURCHASE DEBUG: walletAddress:', this.walletAddress);

        if (!this.walletConnected || !this.walletAddress) {
            const error = 'Please connect your MetaMask wallet to complete the purchase';
            console.log('❌ PURCHASE DEBUG: Wallet not connected:', error);
            this.purchaseError = error;
            return;
        }

        // Check sufficient balance
        console.log('💰 PURCHASE DEBUG: Checking balance...');
        console.log('💰 PURCHASE DEBUG: walletBalance:', this.walletBalance);
        console.log('💰 PURCHASE DEBUG: required amount:', amount);

        if (this.walletBalance < amount) {
            const error = `Insufficient balance. You have ${this.walletBalance} AVAX but need ${amount} AVAX`;
            console.log('❌ PURCHASE DEBUG: Insufficient balance:', error);
            this.purchaseError = error;
            return;
        }

        console.log('✅ PURCHASE DEBUG: All validations passed, starting transaction...');
        this.purchaseError = '';
        this.purchaseStatus = 'Processing blockchain transaction...';
        this.loadingMessage = "Processing blockchain transaction...";
        this.showLoadingModal = true;

        try {
            console.log('🔄 PURCHASE DEBUG: Starting try block...');

            // Get farmer's wallet address from user data
            console.log('👨‍🌾 PURCHASE DEBUG: Getting farmer wallet address...');
            console.log('👨‍🌾 PURCHASE DEBUG: API URL:', this.apiUrl);
            console.log('👨‍🌾 PURCHASE DEBUG: Farmer ID:', this.selectedListing.farmerWallet);
            console.log('👨‍🌾 PURCHASE DEBUG: Token:', this.token ? 'Present' : 'Missing');

            const farmerResponse = await axios.get(`${this.apiUrl}/users/${this.selectedListing.farmerWallet}`, {
                headers: {
                    'Authorization': `Bearer ${this.token}`,
                    'Content-Type': 'application/json'
                }
            });

            console.log('👨‍🌾 PURCHASE DEBUG: Farmer response:', farmerResponse.data);
            const farmerWalletAddress = farmerResponse.data.walletAddress;

            if (!farmerWalletAddress) {
                console.log('❌ PURCHASE DEBUG: No farmer wallet address found');
                throw new Error('Farmer wallet address not found. Farmer must connect their wallet first.');
            }

            console.log('✅ PURCHASE DEBUG: Farmer wallet address:', farmerWalletAddress);

            this.purchaseStatus = 'Sending AVAX transaction...';
            console.log('⛓️ PURCHASE DEBUG: Starting blockchain transaction...');

            // Validate addresses before transaction
            console.log('🔍 PURCHASE DEBUG: Validating wallet addresses...');
            if (!ethers.utils.isAddress(farmerWalletAddress)) {
                console.log('❌ PURCHASE DEBUG: Invalid farmer wallet address:', farmerWalletAddress);
                throw new Error('Invalid farmer wallet address: ' + farmerWalletAddress);
            }

            if (!ethers.utils.isAddress(this.walletAddress)) {
                console.log('❌ PURCHASE DEBUG: Invalid buyer wallet address:', this.walletAddress);
                throw new Error('Invalid buyer wallet address: ' + this.walletAddress);
            }

            console.log('✅ PURCHASE DEBUG: Wallet addresses validated');
            console.log('🔄 PURCHASE DEBUG: Initiating purchase transaction...');
            console.log('💰 PURCHASE DEBUG: Amount:', amount, 'AVAX');
            console.log('👨‍🌾 PURCHASE DEBUG: Farmer wallet:', farmerWalletAddress);
            console.log('🛒 PURCHASE DEBUG: Buyer wallet:', this.walletAddress);

            // Send real AVAX transaction using MetaMask wallet integration
            console.log('📡 PURCHASE DEBUG: Calling sendAVAXTransaction...');
            const txResult = await this.sendAVAXTransaction(
                farmerWalletAddress,
                amount,
                'Crop Purchase'
            );

            console.log('📡 PURCHASE DEBUG: Transaction result:', txResult);

            if (!txResult.success) {
                console.log('❌ PURCHASE DEBUG: Blockchain transaction failed:', txResult.error);
                throw new Error('Blockchain transaction failed: ' + txResult.error);
            }

            console.log('✅ PURCHASE DEBUG: Blockchain transaction successful:', txResult.signature);

            this.purchaseStatus = 'Recording purchase in database...';
            console.log('💾 PURCHASE DEBUG: Starting database recording...');

            // Record purchase in backend with transaction signature
            const purchaseData = {
                listingId: this.selectedListing._id,
                offerPrice: amount,
                buyerWallet: this.walletAddress,
                farmerWallet: farmerWalletAddress,
                txHash: txResult.signature,
                blockchainNetwork: txResult.network || 'avalanche-mainnet'
            };

            console.log('💾 PURCHASE DEBUG: Purchase data to send:', purchaseData);
            console.log('💾 PURCHASE DEBUG: API endpoint:', `${this.apiUrl}/purchases`);

            let response;
            try {
                response = await axios.post(`${this.apiUrl}/purchases`, purchaseData, {
                    headers: {
                        'Authorization': `Bearer ${this.token}`,
                        'Content-Type': 'application/json'
                    }
                });
            } catch (apiError) {
                console.warn('⚠️ API purchase recording failed, using local storage fallback:', apiError);

                // Fallback: Create local purchase record
                const localPurchase = {
                    _id: 'local_' + Date.now(),
                    ...purchaseData,
                    purchaseDate: new Date().toISOString(),
                    status: 'completed',
                    crop: this.selectedListing.crop,
                    location: this.selectedListing.location,
                    pesticide: this.selectedListing.pesticide,
                    pesticideCompany: this.selectedListing.pesticideCompany
                };

                response = { data: localPurchase };
                this.addNotification('⚠️ Purchase recorded locally due to API issue', 'warning');
            }

            console.log('Purchase recorded:', response.data);

            // Update listing status to sold
            try {
                await axios.put(`${this.apiUrl}/listings/${this.selectedListing._id}`, {
                    status: 'sold',
                    soldTo: this.walletAddress,
                    finalPrice: amount,
                    txHash: txResult.signature
                }, {
                    headers: { 'Authorization': `Bearer ${this.token}` }
                });
            } catch (listingUpdateError) {
                console.warn('⚠️ Listing update failed, continuing with local update:', listingUpdateError);
                // Continue with local updates even if API fails
            }

            // Add to local arrays for immediate UI update
            this.buyerPurchases.unshift(response.data);

            // Remove from marketplace listings
            const listingIndexAll = this.allListings.findIndex(l => l._id === this.selectedListing._id);
            if (listingIndexAll > -1) this.allListings.splice(listingIndexAll, 1);

            // Update farmer listings status
            const listingIndexFarmer = this.farmerListings.findIndex(l => l._id === this.selectedListing._id);
            if (listingIndexFarmer > -1) this.farmerListings[listingIndexFarmer].status = 'sold';

            // Save to localStorage as backup
            localStorage.setItem('pestivid_buyerPurchases', JSON.stringify(this.buyerPurchases));
            localStorage.setItem('pestivid_allListings', JSON.stringify(this.allListings));
            localStorage.setItem('pestivid_farmerListings', JSON.stringify(this.farmerListings));

            // Update wallet balance
            await this.updateWalletBalance();

            this.purchaseStatus = 'Purchase completed successfully!';
            this.addNotification(`Successfully purchased ${this.selectedListing.crop} for ${amount} AVAX! Transaction: ${txResult.signature.substring(0, 8)}...`, 'success');

            // Refresh marketplace data
            await this.loadPublicPlatformData();

            setTimeout(() => { this.closeBuyModal(); }, 2000);
            this.showLoadingModal = false;
            this.loadingMessage = "";

        } catch (error) {
            console.log('❌ PURCHASE DEBUG: Error caught in processPurchase:');
            console.log('❌ PURCHASE DEBUG: Error object:', error);
            console.log('❌ PURCHASE DEBUG: Error message:', error.message);
            console.log('❌ PURCHASE DEBUG: Error stack:', error.stack);

            if (error.response) {
                console.log('❌ PURCHASE DEBUG: Error response status:', error.response.status);
                console.log('❌ PURCHASE DEBUG: Error response data:', error.response.data);
                console.log('❌ PURCHASE DEBUG: Error response headers:', error.response.headers);
            }

            if (error.request) {
                console.log('❌ PURCHASE DEBUG: Error request:', error.request);
            }

            console.error('❌ PURCHASE DEBUG: Full error processing purchase:', error);

            // Provide more detailed error information
            let errorMessage = 'Failed to process purchase. ';

            if (error.message.includes('Farmer wallet address not found')) {
                errorMessage += 'Farmer must connect their wallet first.';
                console.log('❌ PURCHASE DEBUG: Farmer wallet issue detected');
            } else if (error.message.includes('Blockchain transaction failed')) {
                errorMessage += 'Blockchain transaction failed: ' + error.message.split(': ')[1];
                console.log('❌ PURCHASE DEBUG: Blockchain transaction issue detected');
            } else if (error.response?.status === 404) {
                errorMessage += 'Listing not found or no longer available.';
                console.log('❌ PURCHASE DEBUG: 404 error - listing not found');
            } else if (error.response?.status === 400) {
                errorMessage += error.response.data?.message || 'Invalid purchase data.';
                console.log('❌ PURCHASE DEBUG: 400 error - bad request');
            } else if (error.response?.status === 500) {
                errorMessage += 'Server error. Please try again later.';
                console.log('❌ PURCHASE DEBUG: 500 error - server error');
            } else if (error.message.includes('Network Error')) {
                errorMessage += 'Network connection error. Check your internet connection.';
                console.log('❌ PURCHASE DEBUG: Network error detected');
            } else if (error.code === 4001) {
                errorMessage += 'Transaction rejected by user in MetaMask.';
                console.log('❌ PURCHASE DEBUG: User rejected transaction');
            } else if (error.code === -32603) {
                errorMessage += 'Insufficient AVAX for gas fees.';
                console.log('❌ PURCHASE DEBUG: Insufficient gas');
            } else {
                errorMessage += error.message || 'Unknown error occurred.';
                console.log('❌ PURCHASE DEBUG: Unknown error type');
            }

            console.log('❌ PURCHASE DEBUG: Final error message:', errorMessage);

            this.purchaseError = errorMessage;
            this.purchaseStatus = '';
            this.showLoadingModal = false;
            this.loadingMessage = "";
            this.addNotification(errorMessage, 'error');
        }
    },

    // --- Transport Services ---
    async createTransportRequest() {
        if (!this.isAuthenticated || this.role !== 'farmer') {
            this.addNotification("Please log in as a farmer to request transport services.", "info");
            return;
        }

        // Validate wallet connection
        if (!this.walletConnected) {
            this.addNotification("Please connect your wallet to request transport services.", "warning");
            return;
        }

        // Validate form
        const form = this.transportForm;
        if (!form.crop || !form.quantity || !form.pickupLocation || !form.deliveryLocation || !form.pickupDate || !form.urgency) {
            this.addNotification("Please fill in all required fields.", "warning");
            return;
        }

        this.loadingMessage = "Creating transport request...";
        this.showLoadingModal = true;

        try {
            // Create transport request with smart matching
            const transportRequest = {
                _id: this.generateId('transport_'),
                farmerWallet: this.currentUserIdentifier,
                crop: form.crop.trim(),
                quantity: parseFloat(form.quantity),
                pickupLocation: form.pickupLocation.trim(),
                deliveryLocation: form.deliveryLocation.trim(),
                pickupDate: form.pickupDate,
                urgency: form.urgency,
                instructions: form.instructions.trim(),
                status: 'pending',
                createdAt: new Date().toISOString(),
                estimatedDistance: this.calculateDistance(form.pickupLocation, form.deliveryLocation),
                estimatedCost: this.calculateTransportCost(form.quantity, form.urgency),
                transporter: null,
                txHash: null
            };

            // Find best transporter using FIFO + Price algorithm
            const bestTransporter = await this.findBestTransporter(transportRequest);
            if (bestTransporter) {
                transportRequest.transporter = bestTransporter;
                transportRequest.status = 'assigned';
                transportRequest.estimatedCost = bestTransporter.quote;
            }

            // Create blockchain transaction for transport request
            if (this.walletConnected) {
                const txResult = await this.sendAVAXTransaction(
                    this.walletAddress, // Small fee for creating request
                    0.001,
                    'Transport Request Creation'
                );
                if (txResult.success) {
                    transportRequest.txHash = txResult.signature;
                }
            }

            // Save to database
            try {
                const response = await axios.post(this.apiUrl + '/transport/requests', transportRequest, {
                    headers: { 'Authorization': `Bearer ${this.token}` }
                });

                console.log('✅ Transport request saved to database:', response.data);

                // Update local arrays with database response
                this.farmerTransportRequests.unshift(response.data);
                this.allTransportRequests.unshift(response.data);

            } catch (dbError) {
                console.error('❌ Failed to save transport request to database:', dbError);
                console.log('📦 Falling back to localStorage...');

                // Fallback to localStorage if database fails
                this.farmerTransportRequests.unshift(transportRequest);
                this.allTransportRequests.unshift(transportRequest);
                localStorage.setItem('pestivid_farmerTransportRequests', JSON.stringify(this.farmerTransportRequests));
                localStorage.setItem('pestivid_allTransportRequests', JSON.stringify(this.allTransportRequests));
            }

            this.addNotification(
                bestTransporter
                    ? `Transport request created and assigned to ${bestTransporter.name}!`
                    : 'Transport request created! Waiting for transporter assignment.',
                'success'
            );

            // Reset form
            this.transportForm = { crop: '', quantity: null, pickupLocation: '', deliveryLocation: '', pickupDate: '', urgency: '', instructions: '' };

        } catch (error) {
            console.error('Error creating transport request:', error);
            this.addNotification('Failed to create transport request. Please try again.', 'error');
        } finally {
            this.showLoadingModal = false;
            this.loadingMessage = '';
        }
    },

    // Smart Matching Algorithm: FIFO + Price Optimization
    async findBestTransporter(request) {
        try {
            // Filter available transporters by location and capacity
            const availableTransporters = this.transportProviders.filter(transporter => {
                return transporter.available &&
                       transporter.capacity >= request.quantity &&
                       this.isInServiceArea(transporter, request.pickupLocation);
            });

            if (availableTransporters.length === 0) {
                return null;
            }

            // Sort by: Registration time (FIFO) + Price (lowest first)
            const sortedTransporters = availableTransporters.map(transporter => {
                const quote = this.calculateTransporterQuote(transporter, request);
                return {
                    ...transporter,
                    quote,
                    priority: this.calculateTransporterPriority(transporter, request, quote)
                };
            }).sort((a, b) => {
                // First by priority (FIFO + urgency), then by price
                if (a.priority !== b.priority) return b.priority - a.priority;
                return a.quote - b.quote;
            });

            return sortedTransporters[0];

        } catch (error) {
            console.error('Error finding best transporter:', error);
            return null;
        }
    },

    calculateTransporterPriority(transporter, request, quote) {
        let priority = 0;

        // FIFO: Earlier registration gets higher priority
        const registrationAge = Date.now() - new Date(transporter.registeredAt).getTime();
        priority += Math.max(0, 100 - (registrationAge / (1000 * 60 * 60 * 24))); // Days since registration

        // Urgency bonus
        const urgencyBonus = { high: 50, medium: 25, low: 0 };
        priority += urgencyBonus[request.urgency] || 0;

        // Rating bonus
        priority += transporter.rating * 10;

        // Price penalty (lower price = higher priority)
        priority -= quote * 0.1;

        return priority;
    },

    calculateTransporterQuote(transporter, request) {
        const baseRate = transporter.ratePerKm || 0.01; // SOL per km
        const distance = this.calculateDistance(request.pickupLocation, request.deliveryLocation);
        const weightMultiplier = Math.max(1, request.quantity / 1000); // Per ton
        const urgencyMultiplier = { high: 1.5, medium: 1.2, low: 1.0 };

        return (baseRate * distance * weightMultiplier * (urgencyMultiplier[request.urgency] || 1)).toFixed(4);
    },

    calculateDistance(from, to) {
        // Simplified distance calculation (in production, use Google Maps API)
        return Math.floor(Math.random() * 100) + 10; // 10-110 km
    },

    calculateTransportCost(quantity, urgency) {
        const baseRate = 0.01; // SOL per kg
        const urgencyMultiplier = { high: 1.5, medium: 1.2, low: 1.0 };
        return (quantity * baseRate * (urgencyMultiplier[urgency] || 1)).toFixed(4);
    },

    isInServiceArea(transporter, location) {
        // Simplified service area check (in production, use geolocation)
        return transporter.serviceAreas.some(area =>
            location.toLowerCase().includes(area.toLowerCase())
        );
    },

    getTransportStatusClass(status) {
        const statusClasses = {
            pending: 'bg-yellow-100 text-yellow-800',
            assigned: 'bg-blue-100 text-blue-800',
            in_transit: 'bg-purple-100 text-purple-800',
            delivered: 'bg-green-100 text-green-800',
            cancelled: 'bg-red-100 text-red-800'
        };
        return statusClasses[status] || 'bg-gray-100 text-gray-800';
    },

    async cancelTransportRequest(requestId) {
        if (!confirm('Are you sure you want to cancel this transport request?')) {
            return;
        }

        try {
            const requestIndex = this.farmerTransportRequests.findIndex(r => r._id === requestId);
            if (requestIndex === -1) {
                this.addNotification('Transport request not found.', 'error');
                return;
            }

            // Remove from arrays
            this.farmerTransportRequests.splice(requestIndex, 1);
            const allIndex = this.allTransportRequests.findIndex(r => r._id === requestId);
            if (allIndex > -1) {
                this.allTransportRequests.splice(allIndex, 1);
            }

            // Update localStorage
            localStorage.setItem('pestivid_farmerTransportRequests', JSON.stringify(this.farmerTransportRequests));
            localStorage.setItem('pestivid_allTransportRequests', JSON.stringify(this.allTransportRequests));

            this.addNotification('Transport request cancelled successfully.', 'success');

        } catch (error) {
            console.error('Error cancelling transport request:', error);
            this.addNotification('Failed to cancel transport request.', 'error');
        }
    },

    trackTransport(requestId) {
        const request = this.farmerTransportRequests.find(r => r._id === requestId);
        if (request) {
            this.addNotification(`Tracking: ${request.crop} transport is currently in transit to ${request.deliveryLocation}`, 'info');
            // In production, this would show real-time GPS tracking
        }
    },

    formatDate(dateString) {
        return new Date(dateString).toLocaleDateString();
    },

    // Initialize sample transport providers
    initializeTransportProviders() {
        this.transportProviders = [
            {
                _id: 'transport_001',
                name: 'AgriTransport Pro',
                vehicle: 'Refrigerated Truck',
                capacity: 5000, // kg
                phone: '+1-555-0101',
                rating: 4.8,
                ratePerKm: 0.008,
                available: true,
                serviceAreas: ['Mumbai', 'Delhi', 'Bangalore', 'Chennai'],
                registeredAt: '2024-01-15T10:00:00Z',
                walletAddress: 'transport1_wallet_address'
            },
            {
                _id: 'transport_002',
                name: 'FarmLogistics Express',
                vehicle: 'Covered Truck',
                capacity: 3000,
                phone: '+1-555-0102',
                rating: 4.5,
                ratePerKm: 0.007,
                available: true,
                serviceAreas: ['Pune', 'Mumbai', 'Nashik'],
                registeredAt: '2024-01-20T14:30:00Z',
                walletAddress: 'transport2_wallet_address'
            },
            {
                _id: 'transport_003',
                name: 'CropMover Solutions',
                vehicle: 'Open Truck',
                capacity: 8000,
                phone: '+1-555-0103',
                rating: 4.2,
                ratePerKm: 0.006,
                available: true,
                serviceAreas: ['Delhi', 'Gurgaon', 'Noida', 'Faridabad'],
                registeredAt: '2024-02-01T09:15:00Z',
                walletAddress: 'transport3_wallet_address'
            }
        ];

        localStorage.setItem('pestivid_transportProviders', JSON.stringify(this.transportProviders));
    },

    // Buyer Transport Methods
    async createBuyerTransportRequest() {
        if (!this.isAuthenticated || this.role !== 'buyer') {
            this.addNotification("Please log in as a buyer to request delivery services.", "info");
            return;
        }

        if (!this.walletConnected) {
            this.addNotification("Please connect your wallet to request delivery services.", "warning");
            return;
        }

        const form = this.buyerTransportForm;
        if (!form.purchaseId || !form.deliveryAddress || !form.deliveryDate || !form.urgency) {
            this.addNotification("Please fill in all required fields.", "warning");
            return;
        }

        // Find the selected purchase
        const selectedPurchase = this.buyerPurchases.find(p => p._id === form.purchaseId);
        if (!selectedPurchase) {
            this.addNotification("Selected purchase not found.", "error");
            return;
        }

        this.loadingMessage = "Creating delivery request...";
        this.showLoadingModal = true;

        try {
            // Create transport request object with proper structure for MongoDB
            const transportRequest = {
                _id: this.generateId('buyer_transport_'),
                buyerWallet: this.currentUserIdentifier,
                farmerWallet: selectedPurchase.farmerWallet || selectedPurchase.farmer,
                crop: selectedPurchase.crop,
                quantity: selectedPurchase.quantity || 100,
                pickupLocation: {
                    address: selectedPurchase.location || 'Farm Location',
                    coordinates: selectedPurchase.coordinates || null
                },
                deliveryLocation: {
                    address: form.deliveryAddress.trim(),
                    coordinates: null
                },
                pickupDate: new Date(form.deliveryDate),
                urgency: form.urgency,
                instructions: form.instructions.trim(),
                specialRequirements: [],
                status: 'pending',
                createdAt: new Date().toISOString(),
                estimatedCost: this.calculateTransportCost(selectedPurchase.quantity || 100, form.urgency),
                transporter: null,
                paymentMade: false,
                txHash: null,
                // Additional buyer-specific fields
                purchaseId: form.purchaseId,
                deliveryAddress: form.deliveryAddress.trim(),
                deliveryDate: form.deliveryDate
            };

            // Find best transporter using FIFO + Price algorithm
            const bestTransporter = await this.findBestTransporter(transportRequest);
            if (bestTransporter) {
                transportRequest.transporter = bestTransporter;
                transportRequest.status = 'assigned';
                transportRequest.estimatedCost = bestTransporter.quote;
            }

            // Create blockchain transaction for request creation
            if (this.walletConnected) {
                const txResult = await this.sendAVAXTransaction(
                    this.walletAddress,
                    0.001, // Small fee for creating request
                    'Transport Request Creation'
                );
                if (txResult.success) {
                    transportRequest.txHash = txResult.signature;
                }
            }

            // Save to MongoDB database
            try {
                const response = await axios.post(this.apiUrl + '/transport/requests', transportRequest, {
                    headers: { 'Authorization': `Bearer ${this.token}` }
                });

                console.log('✅ Buyer transport request saved to database:', response.data);

                // Update local arrays with database response
                this.buyerTransportRequests.unshift(response.data);
                this.allTransportRequests.unshift(response.data);

            } catch (dbError) {
                console.error('❌ Failed to save buyer transport request to database:', dbError);
                console.log('📦 Falling back to localStorage...');

                // Fallback to localStorage if database fails
                this.buyerTransportRequests.unshift(transportRequest);
                this.allTransportRequests.unshift(transportRequest);
                localStorage.setItem('pestivid_buyerTransportRequests', JSON.stringify(this.buyerTransportRequests));
                localStorage.setItem('pestivid_allTransportRequests', JSON.stringify(this.allTransportRequests));
            }

            this.addNotification(
                bestTransporter
                    ? `Delivery request created and assigned to ${bestTransporter.name}!`
                    : 'Delivery request created! Waiting for transporter assignment.',
                'success'
            );

            // Reset form
            this.buyerTransportForm = { purchaseId: '', deliveryAddress: '', deliveryDate: '', urgency: '', instructions: '' };

        } catch (error) {
            console.error('Error creating delivery request:', error);
            this.addNotification('Failed to create delivery request. Please try again.', 'error');
        } finally {
            this.showLoadingModal = false;
            this.loadingMessage = '';
        }
    },

    async cancelBuyerTransportRequest(requestId) {
        if (!confirm('Are you sure you want to cancel this delivery request?')) {
            return;
        }

        this.loadingMessage = "Cancelling delivery request...";
        this.showLoadingModal = true;

        try {
            const requestIndex = this.buyerTransportRequests.findIndex(r => r._id === requestId);
            if (requestIndex === -1) {
                this.addNotification('Delivery request not found.', 'error');
                return;
            }

            // Update status to cancelled in database
            try {
                await axios.put(this.apiUrl + `/transport/requests/${requestId}`, {
                    status: 'cancelled',
                    cancelledAt: new Date().toISOString()
                }, {
                    headers: { 'Authorization': `Bearer ${this.token}` }
                });

                console.log('✅ Buyer transport request cancelled in database');

                // Remove from local arrays
                this.buyerTransportRequests.splice(requestIndex, 1);
                const allIndex = this.allTransportRequests.findIndex(r => r._id === requestId);
                if (allIndex > -1) {
                    this.allTransportRequests.splice(allIndex, 1);
                }

            } catch (dbError) {
                console.error('❌ Failed to cancel request in database:', dbError);
                console.log('📦 Falling back to localStorage...');

                // Fallback to localStorage if database fails
                this.buyerTransportRequests.splice(requestIndex, 1);
                const allIndex = this.allTransportRequests.findIndex(r => r._id === requestId);
                if (allIndex > -1) {
                    this.allTransportRequests.splice(allIndex, 1);
                }
                localStorage.setItem('pestivid_buyerTransportRequests', JSON.stringify(this.buyerTransportRequests));
                localStorage.setItem('pestivid_allTransportRequests', JSON.stringify(this.allTransportRequests));
            }

            this.addNotification('Delivery request cancelled successfully.', 'success');

        } catch (error) {
            console.error('Error cancelling delivery request:', error);
            this.addNotification('Failed to cancel delivery request.', 'error');
        } finally {
            this.showLoadingModal = false;
            this.loadingMessage = '';
        }
    },

    async payTransportShare(request) {
        if (!this.walletConnected) {
            this.addNotification("Please connect your wallet to make payment.", "warning");
            return;
        }

        const shareAmount = (parseFloat(request.estimatedCost) / 2).toFixed(4);

        if (this.walletBalance < shareAmount) {
            this.addNotification(`Insufficient balance. You need ${shareAmount} AVAX to pay your transport share.`, "error");
            return;
        }

        this.loadingMessage = `Paying transport share: ${shareAmount} SOL...`;
        this.showLoadingModal = true;

        try {
            // Send payment to transporter
            const txResult = await this.sendAVAXTransaction(
                request.transporter.walletAddress,
                parseFloat(shareAmount),
                'Transport Payment'
            );

            if (txResult.success) {
                // Update request status in database
                try {
                    await axios.put(this.apiUrl + `/transport/requests/${request._id}`, {
                        paymentMade: true,
                        paymentTxHash: txResult.signature,
                        status: 'paid',
                        paymentStatus: 'paid'
                    }, {
                        headers: { 'Authorization': `Bearer ${this.token}` }
                    });

                    console.log('✅ Buyer transport payment updated in database');

                    // Update local request status
                    const requestIndex = this.buyerTransportRequests.findIndex(r => r._id === request._id);
                    if (requestIndex > -1) {
                        this.buyerTransportRequests[requestIndex].paymentMade = true;
                        this.buyerTransportRequests[requestIndex].paymentTxHash = txResult.signature;
                        this.buyerTransportRequests[requestIndex].status = 'paid';
                    }

                    // Create payment record in database
                    const paymentData = {
                        requestId: request._id,
                        transporterId: request.transporter.providerId || request.transporter._id,
                        amount: parseFloat(shareAmount),
                        currency: 'SOL',
                        paymentType: 'transport_fee',
                        txHash: txResult.signature,
                        payer: {
                            walletAddress: this.walletAddress,
                            role: 'buyer',
                            name: this.currentUser?.name
                        },
                        payee: {
                            walletAddress: request.transporter.walletAddress,
                            name: request.transporter.name,
                            transporterName: request.transporter.name
                        },
                        serviceDetails: {
                            crop: request.crop,
                            quantity: request.quantity,
                            pickupLocation: request.pickupLocation?.address || request.pickupLocation,
                            deliveryLocation: request.deliveryLocation?.address || request.deliveryAddress,
                            pickupDate: request.pickupDate,
                            deliveryDate: request.deliveryDate
                        },
                        status: 'confirmed'
                    };

                    await axios.post(this.apiUrl + '/transport/payments', paymentData, {
                        headers: { 'Authorization': `Bearer ${this.token}` }
                    });

                    console.log('✅ Transport payment record created in database');

                } catch (dbError) {
                    console.error('❌ Failed to update payment in database:', dbError);
                    console.log('📦 Falling back to localStorage...');

                    // Fallback to localStorage if database fails
                    const requestIndex = this.buyerTransportRequests.findIndex(r => r._id === request._id);
                    if (requestIndex > -1) {
                        this.buyerTransportRequests[requestIndex].paymentMade = true;
                        this.buyerTransportRequests[requestIndex].paymentTxHash = txResult.signature;
                        this.buyerTransportRequests[requestIndex].status = 'paid';
                    }
                    localStorage.setItem('pestivid_buyerTransportRequests', JSON.stringify(this.buyerTransportRequests));
                }

                // Update wallet balance
                await this.updateWalletBalance();

                this.addNotification(`Transport share payment successful! Transaction: ${txResult.signature.substring(0, 8)}...`, 'success');
            } else {
                throw new Error('Payment transaction failed');
            }

        } catch (error) {
            console.error('Error paying transport share:', error);
            this.addNotification('Failed to pay transport share. Please try again.', 'error');
        } finally {
            this.showLoadingModal = false;
            this.loadingMessage = '';
        }
    },

    async payInvestorTransportShare(request) {
        if (!this.walletConnected) {
            this.addNotification("Please connect your wallet to make payment.", "warning");
            return;
        }

        const shareAmount = (parseFloat(request.estimatedCost) / 2).toFixed(4);

        if (this.walletBalance < shareAmount) {
            this.addNotification(`Insufficient balance. You need ${shareAmount} AVAX to pay transport share.`, "error");
            return;
        }

        this.loadingMessage = `Paying investment transport share: ${shareAmount} SOL...`;
        this.showLoadingModal = true;

        try {
            const txResult = await this.sendAVAXTransaction(
                request.transporter.walletAddress,
                parseFloat(shareAmount),
                'Transport Payment'
            );

            if (txResult.success) {
                const requestIndex = this.investorTransportRequests.findIndex(r => r._id === request._id);
                if (requestIndex > -1) {
                    this.investorTransportRequests[requestIndex].investorPaymentMade = true;
                    this.investorTransportRequests[requestIndex].investorPaymentTxHash = txResult.signature;
                    this.investorTransportRequests[requestIndex].status = 'investor_paid';
                }

                localStorage.setItem('pestivid_investorTransportRequests', JSON.stringify(this.investorTransportRequests));
                await this.updateWalletBalance();

                this.addNotification(`Investment transport share payment successful! Transaction: ${txResult.signature.substring(0, 8)}...`, 'success');
            } else {
                throw new Error('Payment transaction failed');
            }

        } catch (error) {
            console.error('Error paying investment transport share:', error);
            this.addNotification('Failed to pay transport share. Please try again.', 'error');
        } finally {
            this.showLoadingModal = false;
            this.loadingMessage = '';
        }
    },

    // Generate investor transport requests based on investments
    generateInvestorTransportRequests() {
        this.investorTransportRequests = [];

        // Create transport requests for investments that need delivery
        this.investorInvestments.forEach(investment => {
            if (investment.status === 'harvested' || investment.status === 'ready_for_transport') {
                const transportRequest = {
                    _id: this.generateId('investor_transport_'),
                    investorWallet: this.currentUserIdentifier,
                    investmentId: investment._id,
                    projectTitle: investment.projectTitle,
                    crop: investment.crop || 'Mixed Crops',
                    farmerWallet: investment.farmerWallet,
                    pickupLocation: investment.location || 'Farm Location',
                    deliveryLocation: 'Investor Warehouse',
                    urgency: 'medium',
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    investmentAmount: investment.amount,
                    estimatedCost: this.calculateTransportCost(investment.expectedYield || 1000, 'medium'),
                    transporter: null,
                    investorPaymentMade: false
                };

                this.investorTransportRequests.push(transportRequest);
            }
        });

        localStorage.setItem('pestivid_investorTransportRequests', JSON.stringify(this.investorTransportRequests));
    },

    // Transporter Registration
    async registerTransporter() {
        if (!this.walletConnected) {
            this.addNotification("Please connect your wallet to register as a transporter.", "warning");
            return;
        }

        const form = this.transporterForm;
        if (!form.name || !form.phone || !form.vehicle || !form.capacity || !form.ratePerKm || !form.license || form.serviceAreas.length === 0) {
            this.addNotification("Please fill in all required fields and select at least one service area.", "warning");
            return;
        }

        // Check if already registered
        const existingTransporter = this.transportProviders.find(t => t.walletAddress === this.walletAddress);
        if (existingTransporter) {
            this.addNotification("You are already registered as a transport provider.", "info");
            return;
        }

        this.loadingMessage = "Registering as transport provider...";
        this.showLoadingModal = true;

        try {
            // Create registration transaction
            const registrationFee = 0.01; // 0.01 SOL registration fee

            if (this.walletBalance < registrationFee) {
                throw new Error(`Insufficient balance. You need ${registrationFee} AVAX for registration.`);
            }

            const txResult = await this.sendAVAXTransaction(
                this.walletAddress, // Send to self as registration fee
                registrationFee,
                'Transport Provider Registration'
            );

            if (!txResult.success) {
                throw new Error('Registration transaction failed');
            }

            // Create transporter profile
            const newTransporter = {
                _id: this.generateId('transporter_'),
                name: form.name.trim(),
                phone: form.phone.trim(),
                vehicle: form.vehicle,
                capacity: parseInt(form.capacity),
                ratePerKm: parseFloat(form.ratePerKm),
                license: form.license.trim(),
                serviceAreas: [...form.serviceAreas],
                description: form.description.trim(),
                walletAddress: this.walletAddress,
                available: true,
                rating: 5.0, // Start with perfect rating
                registeredAt: new Date().toISOString(),
                registrationTxHash: txResult.signature,
                totalJobs: 0,
                completedJobs: 0,
                earnings: 0
            };

            // Save to database
            try {
                const response = await axios.post(this.apiUrl + '/transport/providers', newTransporter, {
                    headers: { 'Authorization': `Bearer ${this.token}` }
                });

                console.log('✅ Transporter registered in database:', response.data);

                // Update local array with database response
                this.transportProviders.unshift(response.data);

            } catch (dbError) {
                console.error('❌ Failed to save transporter to database:', dbError);
                console.log('📦 Falling back to localStorage...');

                // Fallback to localStorage if database fails
                this.transportProviders.unshift(newTransporter);
                localStorage.setItem('pestivid_transportProviders', JSON.stringify(this.transportProviders));
            }

            // Update wallet balance
            await this.updateWalletBalance();

            this.addNotification(`Successfully registered as transport provider! Registration fee: ${registrationFee} SOL. Transaction: ${txResult.signature.substring(0, 8)}...`, 'success');

            // Reset form
            this.transporterForm = { name: '', phone: '', vehicle: '', capacity: null, ratePerKm: null, license: '', serviceAreas: [], description: '' };

            // Switch to transport view
            this.switchPage('farmerTransport');

        } catch (error) {
            console.error('Error registering transporter:', error);
            this.addNotification(error.message || 'Failed to register as transport provider. Please try again.', 'error');
        } finally {
            this.showLoadingModal = false;
            this.loadingMessage = '';
        }
    },

    // Transporter Dashboard Methods
    getActiveTransportJobs() {
        if (!this.currentTransporter) return [];
        return this.allTransportRequests.filter(job =>
            job.transporter && job.transporter._id === this.currentTransporter._id &&
            ['assigned', 'in_transit'].includes(job.status)
        );
    },

    getRecentTransportActivity() {
        if (!this.currentTransporter) return [];
        return this.allTransportRequests.filter(job =>
            job.transporter && job.transporter._id === this.currentTransporter._id
        ).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    },

    getActivityIcon(status) {
        const icons = {
            pending: 'fas fa-clock',
            assigned: 'fas fa-check-circle',
            in_transit: 'fas fa-truck',
            delivered: 'fas fa-flag-checkered',
            cancelled: 'fas fa-times-circle'
        };
        return icons[status] || 'fas fa-question-circle';
    },

    getActivityIconClass(status) {
        const classes = {
            pending: 'bg-yellow-100 text-yellow-600',
            assigned: 'bg-blue-100 text-blue-600',
            in_transit: 'bg-purple-100 text-purple-600',
            delivered: 'bg-green-100 text-green-600',
            cancelled: 'bg-red-100 text-red-600'
        };
        return classes[status] || 'bg-gray-100 text-gray-600';
    },

    // Transporter Jobs Methods
    getFilteredTransportJobs() {
        if (!this.currentTransporter) return [];

        let jobs = this.allTransportRequests.filter(job =>
            job.status === 'pending' &&
            !job.transporter &&
            this.canTransporterHandleJob(job)
        );

        // Apply filters
        if (this.transportJobFilters.crop) {
            jobs = jobs.filter(job => job.crop === this.transportJobFilters.crop);
        }
        if (this.transportJobFilters.urgency) {
            jobs = jobs.filter(job => job.urgency === this.transportJobFilters.urgency);
        }
        if (this.transportJobFilters.minPayment) {
            jobs = jobs.filter(job => parseFloat(job.estimatedCost) >= this.transportJobFilters.minPayment);
        }
        if (this.transportJobFilters.area) {
            jobs = jobs.filter(job =>
                job.pickupLocation.toLowerCase().includes(this.transportJobFilters.area.toLowerCase()) ||
                (job.deliveryLocation && job.deliveryLocation.toLowerCase().includes(this.transportJobFilters.area.toLowerCase()))
            );
        }

        return jobs.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt)); // FIFO
    },

    canTransporterHandleJob(job) {
        if (!this.currentTransporter) return false;

        // Check capacity
        if (job.quantity && job.quantity > this.currentTransporter.capacity) {
            return false;
        }

        // Check service area
        const jobLocation = job.pickupLocation.toLowerCase();
        return this.currentTransporter.serviceAreas.some(area =>
            jobLocation.includes(area.toLowerCase())
        );
    },

    canAcceptJob(job) {
        return this.currentTransporter &&
               this.currentTransporter.available &&
               this.canTransporterHandleJob(job);
    },

    getJobUnavailableReason(job) {
        if (!this.currentTransporter) return 'Not registered';
        if (!this.currentTransporter.available) return 'Unavailable';
        if (job.quantity && job.quantity > this.currentTransporter.capacity) return 'Over capacity';
        if (!this.canTransporterHandleJob(job)) return 'Outside area';
        return 'Unavailable';
    },

    async acceptTransportJob(job) {
        if (!this.canAcceptJob(job)) {
            this.addNotification('Cannot accept this job. Check requirements.', 'warning');
            return;
        }

        this.loadingMessage = 'Accepting transport job...';
        this.showLoadingModal = true;

        try {
            // Update job with transporter assignment
            const jobIndex = this.allTransportRequests.findIndex(j => j._id === job._id);
            if (jobIndex > -1) {
                this.allTransportRequests[jobIndex].transporter = { ...this.currentTransporter };
                this.allTransportRequests[jobIndex].status = 'assigned';
                this.allTransportRequests[jobIndex].assignedAt = new Date().toISOString();
            }

            // Update transporter stats
            this.currentTransporter.totalJobs = (this.currentTransporter.totalJobs || 0) + 1;
            this.currentTransporter.available = false; // Mark as busy

            // Update in transportProviders array
            const providerIndex = this.transportProviders.findIndex(p => p._id === this.currentTransporter._id);
            if (providerIndex > -1) {
                this.transportProviders[providerIndex] = { ...this.currentTransporter };
            }

            // Save to database
            try {
                // Update transport request status
                await axios.put(this.apiUrl + `/transport/requests/${job._id}`, {
                    transporter: this.currentTransporter,
                    status: 'assigned',
                    assignedAt: new Date().toISOString()
                }, {
                    headers: { 'Authorization': `Bearer ${this.token}` }
                });

                // Update transporter stats
                await axios.put(this.apiUrl + `/transport/providers/${this.currentTransporter._id}`, {
                    totalJobs: this.currentTransporter.totalJobs,
                    available: false
                }, {
                    headers: { 'Authorization': `Bearer ${this.token}` }
                });

                console.log('✅ Transport job assignment saved to database');

            } catch (dbError) {
                console.error('❌ Failed to save job assignment to database:', dbError);
                console.log('📦 Falling back to localStorage...');

                // Fallback to localStorage if database fails
                localStorage.setItem('pestivid_allTransportRequests', JSON.stringify(this.allTransportRequests));
                localStorage.setItem('pestivid_transportProviders', JSON.stringify(this.transportProviders));
                localStorage.setItem('pestivid_currentTransporter', JSON.stringify(this.currentTransporter));
            }

            this.addNotification(`Job accepted! You are now assigned to transport ${job.crop}.`, 'success');

            // Switch to dashboard
            this.switchPage('transporterDashboard');

        } catch (error) {
            console.error('Error accepting job:', error);
            this.addNotification('Failed to accept job. Please try again.', 'error');
        } finally {
            this.showLoadingModal = false;
            this.loadingMessage = '';
        }
    },

    // Complete Transport Job
    async completeTransportJob(jobId) {
        if (!this.currentTransporter) {
            this.addNotification('You must be registered as a transporter to complete jobs.', 'error');
            return;
        }

        this.loadingMessage = 'Completing transport job...';
        this.showLoadingModal = true;

        try {
            // Find the job
            const jobIndex = this.allTransportRequests.findIndex(j => j._id === jobId);
            if (jobIndex === -1) {
                throw new Error('Job not found');
            }

            const job = this.allTransportRequests[jobIndex];

            // Update job status
            this.allTransportRequests[jobIndex].status = 'completed';
            this.allTransportRequests[jobIndex].completedAt = new Date().toISOString();

            // Update transporter stats
            this.currentTransporter.completedJobs = (this.currentTransporter.completedJobs || 0) + 1;
            this.currentTransporter.available = true; // Mark as available again
            this.currentTransporter.earnings = (this.currentTransporter.earnings || 0) + job.estimatedCost;

            // Update in transportProviders array
            const providerIndex = this.transportProviders.findIndex(p => p._id === this.currentTransporter._id);
            if (providerIndex > -1) {
                this.transportProviders[providerIndex] = { ...this.currentTransporter };
            }

            // Save to database
            try {
                // Update transport request status
                await axios.put(this.apiUrl + `/transport/requests/${jobId}`, {
                    status: 'completed',
                    completedAt: new Date().toISOString()
                }, {
                    headers: { 'Authorization': `Bearer ${this.token}` }
                });

                // Update transporter stats
                await axios.put(this.apiUrl + `/transport/providers/${this.currentTransporter._id}`, {
                    completedJobs: this.currentTransporter.completedJobs,
                    available: true,
                    earnings: this.currentTransporter.earnings
                }, {
                    headers: { 'Authorization': `Bearer ${this.token}` }
                });

                console.log('✅ Transport job completion saved to database');

            } catch (dbError) {
                console.error('❌ Failed to save job completion to database:', dbError);
                console.log('📦 Falling back to localStorage...');

                // Fallback to localStorage if database fails
                localStorage.setItem('pestivid_allTransportRequests', JSON.stringify(this.allTransportRequests));
                localStorage.setItem('pestivid_transportProviders', JSON.stringify(this.transportProviders));
                localStorage.setItem('pestivid_currentTransporter', JSON.stringify(this.currentTransporter));
            }

            this.addNotification(`Job completed successfully! Earned ${job.estimatedCost} SOL.`, 'success');

        } catch (error) {
            console.error('Error completing job:', error);
            this.addNotification('Failed to complete job. Please try again.', 'error');
        } finally {
            this.showLoadingModal = false;
            this.loadingMessage = '';
        }
    },

    // Redirect to Transport Portal
    redirectToTransportPortal() {
        console.log('🚛 Redirecting to Transport Portal...');

        // Check if user is logged in
        if (!this.isLoggedIn) {
            this.addNotification('Please login to access the Transport Portal.', 'warning');
            this.switchPage('login');
            return;
        }

        // Check if wallet is connected
        if (!this.walletConnected) {
            this.addNotification('Please connect your wallet to register as a transporter.', 'warning');
            return;
        }

        // Switch to transporter profile page for registration
        this.addNotification('Welcome to the Transport Portal! Please complete your registration.', 'info');
        this.switchPage('transporterProfile');
    },

    // Transporter Earnings Methods
    getCompletionRate() {
        if (!this.currentTransporter || !this.currentTransporter.totalJobs) return 0;
        return Math.round((this.currentTransporter.completedJobs / this.currentTransporter.totalJobs) * 100);
    },

    getMonthlyEarnings() {
        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();

        return this.getTransporterPayments()
            .filter(payment => {
                const paymentDate = new Date(payment.paidAt);
                return paymentDate.getMonth() === currentMonth && paymentDate.getFullYear() === currentYear;
            })
            .reduce((total, payment) => total + parseFloat(payment.amount), 0);
    },

    getMonthlyJobs() {
        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();

        return this.getTransporterPayments()
            .filter(payment => {
                const paymentDate = new Date(payment.paidAt);
                return paymentDate.getMonth() === currentMonth && paymentDate.getFullYear() === currentYear;
            }).length;
    },

    getTransporterPayments() {
        if (!this.currentTransporter) return [];

        // Simulate payment records based on completed jobs
        return this.allTransportRequests
            .filter(job =>
                job.transporter &&
                job.transporter._id === this.currentTransporter._id &&
                job.status === 'delivered'
            )
            .map(job => ({
                _id: job._id + '_payment',
                crop: job.crop,
                pickupLocation: job.pickupLocation,
                deliveryLocation: job.deliveryLocation || job.deliveryAddress,
                amount: job.estimatedCost,
                paidAt: job.deliveredAt || job.createdAt
            }));
    },

    // Load current transporter profile
    loadCurrentTransporter() {
        if (!this.walletAddress) return;

        // Find transporter by wallet address
        this.currentTransporter = this.transportProviders.find(t => t.walletAddress === this.walletAddress);

        // Load from localStorage if not found
        if (!this.currentTransporter) {
            const saved = localStorage.getItem('pestivid_currentTransporter');
            if (saved) {
                const savedTransporter = JSON.parse(saved);
                if (savedTransporter.walletAddress === this.walletAddress) {
                    this.currentTransporter = savedTransporter;
                }
            }
        }
    },

    // --- Investor Projects ---
    resetInvestorFilters() { this.investorFilters = {crop: '', method: '', minRoi: null, maxAmount: null}; },
    debugFundingRequests() {
        console.log('=== FUNDING REQUESTS DEBUG ===');
        console.log('Total allFundingRequests:', this.allFundingRequests.length);
        console.log('All funding requests:', this.allFundingRequests);
        console.log('Current filters:', this.investorFilters);
        console.log('Filtered results:', this.filteredFundingRequests.length);
        console.log('Filtered funding requests:', this.filteredFundingRequests);
        console.log('Unique crops:', this.uniqueFundingCrops);
        console.log('Current user role:', this.role);
        console.log('Is authenticated:', this.isAuthenticated);
        this.addNotification('Debug info logged to console. Check browser developer tools.', 'info');
    },
    testInvestorFunctions() {
        console.log('=== INVESTOR PORTAL FUNCTION TEST ===');

        // Test 1: Data Loading
        console.log('✓ Testing Data Loading...');
        console.log('- allFundingRequests:', this.allFundingRequests.length);
        console.log('- investorInvestments:', this.investorInvestments.length);
        console.log('- investorTransactions:', this.investorTransactions.length);

        // Test 2: Computed Properties
        console.log('✓ Testing Computed Properties...');
        console.log('- totalInvestedAmount:', this.totalInvestedAmount);
        console.log('- investorActiveProjects:', this.investorActiveProjects);
        console.log('- investorCompletedProjects:', this.investorCompletedProjects);
        console.log('- investorAvgRoi:', this.investorAvgRoi);

        // Test 3: Filtering
        console.log('✓ Testing Filtering...');
        console.log('- filteredFundingRequests:', this.filteredFundingRequests.length);
        console.log('- uniqueFundingCrops:', this.uniqueFundingCrops);

        // Test 4: Video Functions
        console.log('✓ Testing Video Functions...');
        if (this.allFundingRequests.length > 0) {
            const firstProject = this.allFundingRequests[0];
            if (firstProject.cid) {
                console.log('- getVideoUrl test:', this.getVideoUrl(firstProject.cid, firstProject.videoStorageType || 'ipfs'));
            }
        }

        // Test 5: Investment Functions
        console.log('✓ Testing Investment Functions...');
        console.log('- maxInvestmentAmount function exists:', typeof this.maxInvestmentAmount === 'function');
        console.log('- investInProject function exists:', typeof this.investInProject === 'function');
        console.log('- calculateExpectedReturn function exists:', typeof this.calculateExpectedReturn === 'function');

        // Test 6: User Functions
        console.log('✓ Testing User Functions...');
        console.log('- getFarmerDisplayIdentifier function exists:', typeof this.getFarmerDisplayIdentifier === 'function');
        console.log('- showFarmerProfile function exists:', typeof this.showFarmerProfile === 'function');
        console.log('- startOrGoToConversation function exists:', typeof this.startOrGoToConversation === 'function');

        // Test 7: Navigation Functions
        console.log('✓ Testing Navigation Functions...');
        console.log('- switchPage function exists:', typeof this.switchPage === 'function');
        console.log('- loadPublicPlatformData function exists:', typeof this.loadPublicPlatformData === 'function');
        console.log('- loadUserAppData function exists:', typeof this.loadUserAppData === 'function');

        console.log('=== ALL INVESTOR FUNCTIONS TESTED ===');
        this.addNotification('All investor portal functions tested successfully! Check console for details.', 'success');
    },
    maxInvestmentAmount(project) {
        if (!project || typeof project.amount !== 'number') return 0;
        const fundedAmount = project.fundedAmount || 0;
        const remaining = project.amount - fundedAmount;
        return Math.max(0, parseFloat(remaining.toFixed(2)));
    },
    ensureInvestmentAmountExists(projectId) {
        if (!this.investmentAmounts[projectId]) {
            this.$set(this.investmentAmounts, projectId, null);
        }
    },
    validateInvestmentAmount(project) {
        const amount = this.investmentAmounts[project._id];
        this.$set(this.investmentErrors, project._id, '');

        if (amount && amount > 0) {
            const maxAmount = this.maxInvestmentAmount(project);
            if (amount > maxAmount) {
                this.$set(this.investmentErrors, project._id, `Maximum investment: ${maxAmount} SOL`);
            }
        }
    },
    initializeInvestmentAmounts() {
        // Initialize investment amounts for all projects
        if (this.filteredFundingRequests && this.filteredFundingRequests.length > 0) {
            this.filteredFundingRequests.forEach(project => {
                if (!this.investmentAmounts[project._id]) {
                    this.$set(this.investmentAmounts, project._id, null);
                }
                if (!this.investmentErrors[project._id]) {
                    this.$set(this.investmentErrors, project._id, '');
                }
            });
        }
    },
    async investInProject(project) {
        if (!this.isAuthenticated || this.role !== 'investor') { this.addNotification("Log in as Investor.", "info"); return; }

        // Check wallet connection when investing
        if (!this.walletConnected) {
            this.addNotification("Please connect your wallet to make investments on the blockchain", "warning");
            return;
        }

        const amount = this.investmentAmounts[project._id]; this.$set(this.investmentErrors, project._id, '');
        if (!amount || isNaN(amount) || amount <= 0) { this.$set(this.investmentErrors, project._id, 'Invalid amount.'); return; }
        const maxInvest = parseFloat(this.maxInvestmentAmount(project));
        if (amount > maxInvest + 0.001) { this.$set(this.investmentErrors, project._id, `Max ${maxInvest.toFixed(2)} SOL.`); return; }
        const preciseAmount = parseFloat(amount.toFixed(2));

        this.loadingMessage = `Investing ${preciseAmount} SOL...`; this.showLoadingModal = true;

        try {
            // Check wallet balance before investment
            if (this.walletBalance < preciseAmount) {
                throw new Error(`Insufficient balance. You have ${this.walletBalance} AVAX but need ${preciseAmount} AVAX`);
            }

            // Get farmer's wallet address from user data
            const farmerResponse = await axios.get(`${this.apiUrl}/users/${project.farmerWallet}`);
            const farmerWalletAddress = farmerResponse.data.walletAddress;

            if (!farmerWalletAddress) {
                throw new Error('Farmer wallet address not found. Farmer must connect their wallet first.');
            }

            this.loadingMessage = 'Sending AVAX transaction to farmer...';

            // Send real AVAX transaction using MetaMask wallet integration
            const txResult = await this.sendAVAXTransaction(
                farmerWalletAddress,
                preciseAmount,
                `Investment in ${project.crop} project`
            );

            if (!txResult.success) {
                throw new Error('Blockchain transaction failed: ' + txResult.error);
            }

            this.loadingMessage = 'Recording investment in database...';

            // Send investment to backend API with blockchain transaction data
            const investmentData = {
                projectId: project._id,
                amount: preciseAmount,
                txHash: txResult.signature,
                blockchainNetwork: txResult.network || 'avalanche-mainnet',
                investorWallet: this.walletAddress,
                farmerWallet: farmerWalletAddress
            };

            console.log('Creating investment with blockchain data:', investmentData);

            const response = await axios.post(`${this.apiUrl}/investments`, investmentData, {
                headers: {
                    'Authorization': `Bearer ${this.token}`,
                    'Content-Type': 'application/json'
                }
            });

            console.log('Investment created successfully:', response.data);

            // Add to local arrays for immediate UI update
            this.investorInvestments.unshift(response.data);

            // Update project funding status locally for immediate UI feedback
            const projectIndexAll = this.allFundingRequests.findIndex(r => r._id === project._id);
            if (projectIndexAll > -1) {
                this.allFundingRequests[projectIndexAll].fundedAmount += preciseAmount;
                if (this.allFundingRequests[projectIndexAll].fundedAmount >= this.allFundingRequests[projectIndexAll].amount) {
                    this.allFundingRequests[projectIndexAll].status = 'funded';
                    this.addNotification(`Project "${project.title}" is now fully funded!`, 'success', project.farmerWallet);
                } else {
                    this.allFundingRequests[projectIndexAll].status = 'partially_funded';
                }
                if (!this.allFundingRequests[projectIndexAll].investors) this.allFundingRequests[projectIndexAll].investors = [];
                this.allFundingRequests[projectIndexAll].investors.push({ investorId: this.currentUserIdentifier, amount: preciseAmount });
            }

            // Update farmer funding requests locally
            const projectIndexFarmer = this.farmerFundingRequests.findIndex(r => r._id === project._id);
            if (projectIndexFarmer > -1) {
                this.farmerFundingRequests[projectIndexFarmer].fundedAmount += preciseAmount;
                this.farmerFundingRequests[projectIndexFarmer].status = this.allFundingRequests[projectIndexAll]?.status || 'partially_funded';
                if (!this.farmerFundingRequests[projectIndexFarmer].investors) this.farmerFundingRequests[projectIndexFarmer].investors = [];
                this.farmerFundingRequests[projectIndexFarmer].investors.push({ investorId: this.currentUserIdentifier, amount: preciseAmount });
            }

            // Add transaction record locally
            this.investorTransactions.unshift({
                _id: response.data._id + '_tx',
                userId: this.currentUserIdentifier,
                txHash: txResult.signature,  // Use real blockchain transaction hash
                type: 'investment',
                amount: preciseAmount,
                projectId: project._id,
                date: response.data.investmentDate,
                status: 'confirmed'
            });

            // Save to localStorage as backup
            localStorage.setItem('pestivid_investorInvestments', JSON.stringify(this.investorInvestments));
            localStorage.setItem('pestivid_allFundingRequests', JSON.stringify(this.allFundingRequests));
            localStorage.setItem('pestivid_farmerFundingRequests', JSON.stringify(this.farmerFundingRequests));
            localStorage.setItem('pestivid_investorTransactions', JSON.stringify(this.investorTransactions));

            // Update wallet balance after transaction
            await this.updateWalletBalance();

            this.addNotification(`Investment of ${preciseAmount} SOL successful! Transaction: ${txResult.signature.substring(0, 8)}...`, 'success');
            this.addNotification(`Farmer ${this.getFarmerDisplayIdentifier(project.farmerWallet)} received your investment on-chain.`, 'info', project.farmerWallet);
            this.$set(this.investmentAmounts, project._id, null);
            this.showLoadingModal = false; this.loadingMessage = '';

            // Refresh data to show updated balances
            await this.loadPublicPlatformData();

        } catch (error) {
            console.error('Error creating investment:', error);
            this.showLoadingModal = false; this.loadingMessage = '';

            // Fallback to local storage
            console.log('Falling back to local storage...');
            const newInvestment = {
                _id: this.generateId('invest_'), projectId: project._id, projectTitle: project.title,
                crop: project.crop, method: project.method, acres: project.acres, timeline: project.timeline, roi: project.roi, investorShare: project.investorShare,
                cid: project.cid, videoStorageType: project.videoStorageType || 'ipfs', videoFileHash: project.videoFileHash, description: project.description,
                amount: preciseAmount, investorWallet: this.currentUserIdentifier, farmerWallet: project.farmerWallet,
                investmentDate: new Date().toISOString(), status: 'active', progress: 0,
                txHash: this.generateSimulatedTxHash('invest_tx_'), updates: project.updates || []
            };
            this.investorInvestments.unshift(newInvestment);

            // Update project funding status locally
            const projectIndexAll = this.allFundingRequests.findIndex(r => r._id === project._id);
            if (projectIndexAll > -1) {
                this.allFundingRequests[projectIndexAll].fundedAmount += preciseAmount;
                if (this.allFundingRequests[projectIndexAll].fundedAmount >= this.allFundingRequests[projectIndexAll].amount) {
                    this.allFundingRequests[projectIndexAll].status = 'funded';
                    this.addNotification(`Project "${project.title}" is now fully funded!`, 'success', project.farmerWallet);
                } else {
                    this.allFundingRequests[projectIndexAll].status = 'partially_funded';
                }
                if (!this.allFundingRequests[projectIndexAll].investors) this.allFundingRequests[projectIndexAll].investors = [];
                this.allFundingRequests[projectIndexAll].investors.push({ investorId: this.currentUserIdentifier, amount: preciseAmount });
            }

            // Save to localStorage
            localStorage.setItem('pestivid_investorInvestments', JSON.stringify(this.investorInvestments));
            localStorage.setItem('pestivid_allFundingRequests', JSON.stringify(this.allFundingRequests));

            this.addNotification(`Investment of ${preciseAmount} SOL successful (stored locally). API connection issue.`, 'warning');
            this.$set(this.investmentAmounts, project._id, null);
        }
    },

    // --- Investor Portfolio ---
    updateInvestmentProgress() {
        if (!this.isAuthenticated || this.role !== 'investor' || !this.investorInvestments) return;
        const now = new Date();
        this.investorInvestments.forEach(inv => {
            if (inv.status === 'active' || inv.status === 'growing') {
                const investmentDate = new Date(inv.investmentDate);
                const totalDurationMs = (inv.timeline || 1) * 30 * 24 * 60 * 60 * 1000;
                const elapsedMs = now - investmentDate;
                let simulatedProgress = (totalDurationMs > 0) ? Math.min(100, Math.max(0, Math.round((elapsedMs / totalDurationMs) * 100))) : 0;
                let seed = 0; if (inv._id) { for (let i = 0; i < inv._id.length; i++) seed = (seed << 5) - seed + inv._id.charCodeAt(i); seed = Math.abs(seed); }
                const randomIncrement = (seed % 15) + 5;
                simulatedProgress = Math.min(100, Math.max(inv.progress || 0, simulatedProgress + ( (elapsedMs / totalDurationMs > 0.1) ? randomIncrement : 0 ) ) );

                if(simulatedProgress > (inv.progress || 0)){
                    inv.progress = simulatedProgress;
                    if(inv.progress > 0 && inv.status === 'active') inv.status = 'growing';
                }

                if (inv.progress >= 100 && inv.status !== 'harvested' && !inv.payoutNotified) {
                    inv.status = 'harvested';
                    inv.payoutAmount = parseFloat(this.calculateExpectedReturn(inv));
                    inv.payoutDate = new Date().toISOString();
                    inv.payoutTxHash = this.generateSimulatedTxHash('payout_tx_');
                    inv.payoutNotified = true;
                    this.investorTransactions.unshift({
                        _id: this.generateId('tx_'), userId: this.currentUserIdentifier, txHash: inv.payoutTxHash,
                        type: 'payout', amount: inv.payoutAmount, projectId: inv.projectId, date: inv.payoutDate, status: 'confirmed'
                    });
                    this.addNotification(`Harvest Payout for "${inv.projectTitle}": ${inv.payoutAmount.toFixed(2)} SOL processed (simulated).`, 'success', this.currentUserIdentifier);
                    const project = this.allFundingRequests.find(p => p._id === inv.projectId);
                    if (project && project.status !== 'completed') {
                        project.status = 'completed';
                        this.addNotification(`Project "${project.title}" is now completed!`, 'info', project.farmerWallet);
                    }
                }
            }
        });
        localStorage.setItem('pestivid_investorInvestments', JSON.stringify(this.investorInvestments));
        localStorage.setItem('pestivid_investorTransactions', JSON.stringify(this.investorTransactions));
        localStorage.setItem('pestivid_allFundingRequests', JSON.stringify(this.allFundingRequests));
    },
    calculateExpectedReturn(investment) {
         if (!investment || investment.amount === undefined || investment.roi === undefined) return '0.00';
         return (investment.amount * (investment.roi / 100)).toFixed(2);
     },
    viewInvestmentDetails(investment) {
        const projectDetails = this.allFundingRequests.find(p => p._id === investment.projectId) || this.farmerFundingRequests.find(p => p._id === investment.projectId);
        this.selectedInvestment = {
            ...investment,
            description: projectDetails ? projectDetails.description : (investment.description || 'N/A'),
            updates: projectDetails ? (projectDetails.updates || []) : (investment.updates || []),
            cid: projectDetails ? projectDetails.cid : investment.cid,
            videoStorageType: projectDetails ? projectDetails.videoStorageType : (investment.videoStorageType || 'ipfs'),
            videoFileHash: projectDetails ? projectDetails.videoFileHash : investment.videoFileHash,
            investmentDate: investment.investmentDate ? new Date(investment.investmentDate) : null,
            payoutDate: investment.payoutDate ? new Date(investment.payoutDate) : null,
        };
        this.showInvestmentDetailsModal = true;
    },
    // Real-time Avalanche explorer URL
    avalancheExplorerUrl(txHash) {
        if (!txHash || txHash.startsWith('sim_')) return '#';

        // Use appropriate explorer based on network
        const isMainnet = this.currentChainId === '0xA86A' || this.blockchainNetwork === 'avalanche-mainnet';
        const explorerBase = isMainnet ? 'https://snowtrace.io' : 'https://testnet.snowtrace.io';

        return `${explorerBase}/tx/${txHash}`;
    },

    // Get real-time transaction status from Avalanche
    async getTransactionStatus(txHash) {
        try {
            if (!txHash || txHash.startsWith('sim_')) return { status: 'simulated' };

            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const receipt = await provider.getTransactionReceipt(txHash);

            if (receipt) {
                return {
                    status: receipt.status === 1 ? 'confirmed' : 'failed',
                    blockNumber: receipt.blockNumber,
                    gasUsed: receipt.gasUsed.toString(),
                    confirmations: await provider.getBlockNumber() - receipt.blockNumber
                };
            } else {
                // Check if transaction is pending
                const tx = await provider.getTransaction(txHash);
                return tx ? { status: 'pending' } : { status: 'not_found' };
            }
        } catch (error) {
            console.error('Error getting transaction status:', error);
            return { status: 'error', error: error.message };
        }
    },

    // Real blockchain transaction verification
    async verifyTransaction(signature) {
        try {
            if (!window.pestVidWallet || !window.pestVidWallet.connection) {
                return { verified: false, error: 'Wallet not connected' };
            }

            const transaction = await window.pestVidWallet.connection.getTransaction(signature);

            if (transaction) {
                return {
                    verified: true,
                    blockTime: transaction.blockTime,
                    slot: transaction.slot,
                    fee: transaction.meta.fee,
                    status: transaction.meta.err ? 'failed' : 'success'
                };
            } else {
                return { verified: false, error: 'Transaction not found' };
            }
        } catch (error) {
            console.error('Transaction verification failed:', error);
            return { verified: false, error: error.message };
        }
    },

    // --- User Profile & Farmer Profile Modal ---
    async showFarmerProfile(farmerId) {
         if (!farmerId) {
             this.addNotification("No farmer ID provided.", "error");
             return;
         }

         this.loadingMessage = "Loading farmer profile...";
         this.showLoadingModal = true;

         console.log('Looking for farmer profile:', farmerId);
         console.log('Available users:', this.users.length);

         // First try to find in users array
         let farmer = this.users.find(u => u._id === farmerId || u.pestividId === farmerId);

         // If not found in users array, try to load from backend or create a profile
         if (!farmer) {
             console.log('Farmer not found in users array, attempting to load from backend...');

             try {
                 // Try to load user from backend
                 const response = await axios.get(`${this.apiUrl}/users/${farmerId}`, {
                     headers: { 'Authorization': `Bearer ${this.token}` }
                 });

                 if (response.data) {
                     farmer = response.data;
                     // Add to users array for future reference
                     this.users.push(farmer);
                 }
             } catch (error) {
                 console.log('Could not load farmer from backend, creating demo profile...');

                 // Create a demo farmer profile based on available data
                 const farmerFundingRequests = this.allFundingRequests.filter(r => r.farmerWallet === farmerId);
                 const farmerListings = this.allListings.filter(l => l.farmerWallet === farmerId);

                 farmer = {
                     _id: farmerId,
                     pestividId: farmerId,
                     name: this.getFarmerDisplayIdentifier(farmerId),
                     email: `${farmerId.substring(0, 8)}@pestivid.demo`,
                     memberSince: farmerFundingRequests.length > 0 ? farmerFundingRequests[0].createdAt : new Date().toISOString(),
                     role: 'farmer'
                 };

                 // Add to users array
                 this.users.push(farmer);
             }
         }

         if (farmer) {
             this.selectedFarmerProfile = {
                 ...farmer,
                 walletAddress: farmer.pestividId || farmer._id,
                 fundingRequestCount: this.allFundingRequests.filter(r => r.farmerWallet === farmerId && ['pending', 'partially_funded'].includes(r.status)).length,
                 activeListingCount: this.allListings.filter(l => l.farmerWallet === farmerId && l.status === 'active').length,
                 bio: `${farmer.name} is a dedicated agricultural producer on PestiVid, committed to quality and transparency. (Demo Bio)`,
             };
             this.showFarmerProfileModal = true;
             console.log('Farmer profile loaded:', this.selectedFarmerProfile);
         } else {
             this.addNotification("Farmer profile could not be loaded.", "error");
             console.error('Failed to load farmer profile for ID:', farmerId);
         }

         this.showLoadingModal = false;
         this.loadingMessage = '';
     },
     closeFarmerProfileModal() { this.showFarmerProfileModal = false; this.selectedFarmerProfile = null; },
     messageFarmerFromProfile() {
        if (this.selectedFarmerProfile && (this.selectedFarmerProfile._id || this.selectedFarmerProfile.walletAddress)) {
            this.startOrGoToConversation(this.selectedFarmerProfile._id || this.selectedFarmerProfile.walletAddress);
            this.closeFarmerProfileModal();
        }
     },
     viewFarmerProjects() {
        if (this.selectedFarmerProfile) {
            // Close the profile modal and go to projects page with farmer filter
            this.closeFarmerProfileModal();
            this.switchPage('investorProjects');
            // Add a small delay to ensure page switch completes
            this.$nextTick(() => {
                // You could add a farmer filter here if needed
                this.addNotification(`Viewing projects from ${this.selectedFarmerProfile.name}`, 'info');
            });
        }
     },
     getFarmerVideoCount(farmerId) {
        if (!farmerId) return 0;
        return this.farmerVideos.filter(v => v.farmerWallet === farmerId).length;
     },
     getFarmerTotalInvestments(farmerId) {
        if (!farmerId) return 0;
        // Calculate total SOL raised by farmer
        const farmerProjects = this.allFundingRequests.filter(r => r.farmerWallet === farmerId);
        const totalRaised = farmerProjects.reduce((sum, project) => sum + (project.fundedAmount || 0), 0);
        return totalRaised.toFixed(1);
     },
     getFarmerRecentProjects(farmerId) {
        if (!farmerId) return [];
        // Get recent projects from farmer
        return this.allFundingRequests
            .filter(r => r.farmerWallet === farmerId)
            .sort((a, b) => new Date(b.createdAt || b.timestamp || 0) - new Date(a.createdAt || a.timestamp || 0))
            .slice(0, 3);
     },
    viewPurchaseVideo(purchase) { this.selectedPurchase = purchase; this.showPurchaseVideo = true; },
    viewSaleVideo(sale) {
        // Reuse the purchase video modal for sales
        this.selectedPurchase = {
            ...sale,
            // Map sale fields to purchase fields for modal compatibility
            farmerWallet: this.currentUserIdentifier,
            buyerWallet: sale.buyerWallet,
            purchaseDate: sale.purchaseDate
        };
        this.showPurchaseVideo = true;
    },
    showBuyerProfile(buyerId) {
        // Reuse the farmer profile modal for buyers
        this.showFarmerProfile(buyerId);
    },

    // --- Messaging ---
    async loadUserConversations() {
        if (!this.isAuthenticated || !this.currentUserIdentifier) return;

        try {
            // Load conversations from backend API
            const conversationsResponse = await axios.get(`${this.apiUrl}/messaging/conversations/${this.currentUserIdentifier}`, {
                headers: { 'Authorization': `Bearer ${this.token}` }
            });

            if (conversationsResponse.data && Array.isArray(conversationsResponse.data)) {
                this.conversations = conversationsResponse.data.sort((a, b) =>
                    new Date(b.lastMessageTimestamp) - new Date(a.lastMessageTimestamp)
                );
                console.log('Loaded conversations from database:', this.conversations.length);
            }

            // Load all messages for the user
            const messagesResponse = await axios.get(`${this.apiUrl}/messaging/messages/${this.currentUserIdentifier}`, {
                headers: { 'Authorization': `Bearer ${this.token}` }
            });

            if (messagesResponse.data && Array.isArray(messagesResponse.data)) {
                this.messages = messagesResponse.data;
                console.log('Loaded messages from database:', this.messages.length);
            }

            // Save to localStorage as backup
            localStorage.setItem('pestivid_conversations', JSON.stringify(this.conversations));
            localStorage.setItem('pestivid_messages', JSON.stringify(this.messages));

        } catch (error) {
            console.error('Error loading conversations from database:', error);
            // Fallback to localStorage
            this.conversations = JSON.parse(localStorage.getItem('pestivid_conversations') || '[]')
                .filter(c => c.participants.includes(this.currentUserIdentifier))
                .sort((a, b) => new Date(b.lastMessageTimestamp) - new Date(a.lastMessageTimestamp));
            this.messages = JSON.parse(localStorage.getItem('pestivid_messages') || '[]');
        }
    },
    loadMessagesForConversation(conversationId) {
        if (!conversationId || !this.isAuthenticated || !this.currentUserIdentifier) return;
        console.log(`Switched to conversation ${conversationId}. Messages should re-filter.`);
    },
    async startOrGoToConversation(targetUserId) {
        if (!this.isAuthenticated || !this.currentUserIdentifier || !targetUserId) { this.addNotification("Log in to chat.", "info"); return; }
        if (targetUserId === this.currentUserIdentifier) { this.addNotification("Cannot message yourself.", "warning"); return; }

        try {
            // Check if conversation already exists locally
            let conversation = this.conversations.find(c =>
                c.participants.includes(this.currentUserIdentifier) && c.participants.includes(targetUserId)
            );

            if (!conversation) {
                // Create new conversation via backend API
                console.log('Creating conversation with:', targetUserId);
                console.log('API URL:', `${this.apiUrl}/messaging/conversations`);
                console.log('Token:', this.token ? 'Present' : 'Missing');

                const response = await axios.post(`${this.apiUrl}/messaging/conversations`, {
                    targetUserId: targetUserId
                }, {
                    headers: { 'Authorization': `Bearer ${this.token}` }
                });

                conversation = response.data;
                console.log('Created new conversation:', conversation);

                // Add to local conversations array
                this.conversations.unshift(conversation);
                localStorage.setItem('pestivid_conversations', JSON.stringify(this.conversations));
            } else {
                // Move existing conversation to top
                const index = this.conversations.findIndex(c => c._id === conversation._id);
                if (index > 0) {
                    const [movedConv] = this.conversations.splice(index, 1);
                    this.conversations.unshift(movedConv);
                    localStorage.setItem('pestivid_conversations', JSON.stringify(this.conversations));
                }
            }

            this.addNotification(`Chat with ${this.getFarmerDisplayIdentifier(targetUserId)} ready.`, 'info');
            this.switchPage('messaging');
            this.$nextTick(() => {
                 this.activeConversationId = conversation._id;
                 this.scrollToMessageBottom();
                 this.markConversationAsRead(conversation._id);
            });

        } catch (error) {
            console.error('Error creating/accessing conversation:', error);
            console.error('Error details:', error.response ? error.response.data : error.message);
            console.error('Error status:', error.response ? error.response.status : 'No response');

            // Fallback to local conversation creation
            console.log('Falling back to local conversation creation...');
            const conversation = {
                _id: this.generateId('conv_'),
                participants: [this.currentUserIdentifier, targetUserId],
                lastMessageSnippet: 'Started a new conversation.',
                lastMessageTimestamp: new Date().toISOString(),
                createdBy: this.currentUserIdentifier,
                isLocal: true // Mark as local conversation
            };
            this.conversations.unshift(conversation);
            localStorage.setItem('pestivid_conversations', JSON.stringify(this.conversations));

            this.addNotification(`Chat with ${this.getFarmerDisplayIdentifier(targetUserId)} ready (local mode).`, 'warning');
            this.switchPage('messaging');
            this.$nextTick(() => {
                 this.activeConversationId = conversation._id;
                 this.scrollToMessageBottom();
                 this.markConversationAsRead(conversation._id);
            });
        }
    },
    selectConversation(convId) { this.activeConversationId = convId; },
    async sendMessage() {
        if (!this.messageInputText.trim() || !this.activeConversationId || !this.isAuthenticated || !this.currentUserIdentifier) return;
        const messageText = this.messageInputText.trim();
        const conversation = this.conversations.find(c => c._id === this.activeConversationId);
        if (!conversation) { this.addNotification("Invalid conversation.", "error"); return; }
        const receiverId = conversation.participants.find(p => p !== this.currentUserIdentifier);
        if (!receiverId) { this.addNotification("Error sending: receiver not found.", "error"); return; }

        // Check if this is a local conversation (fallback mode)
        if (conversation.isLocal) {
            console.log('Sending message in local mode (conversation is local)');
            this.sendMessageLocal(messageText, conversation, receiverId);
            return;
        }

        try {
            // Send message to backend API
            console.log('Sending message to:', `${this.apiUrl}/messaging/conversations/${this.activeConversationId}/messages`);
            console.log('Message text:', messageText);
            console.log('Token:', this.token ? 'Present' : 'Missing');
            console.log('Conversation ID:', this.activeConversationId);

            const response = await axios.post(`${this.apiUrl}/messaging/conversations/${this.activeConversationId}/messages`, {
                text: messageText
            }, {
                headers: { 'Authorization': `Bearer ${this.token}` }
            });

            console.log('Message sent successfully:', response.data);

            // Add message to local array for immediate UI update
            const newMessage = {
                _id: response.data._id,
                conversationId: this.activeConversationId,
                sender: this.currentUserIdentifier,
                receiver: receiverId,
                text: messageText,
                timestamp: response.data.timestamp,
                read: false,
            };
            this.messages.push(newMessage);

            // Update conversation snippet and timestamp
            conversation.lastMessageSnippet = messageText.substring(0, 30) + (messageText.length > 30 ? '...' : '');
            conversation.lastMessageTimestamp = newMessage.timestamp;

            // Move conversation to top
            const index = this.conversations.findIndex(c => c._id === conversation._id);
            if (index > 0) {
                const [movedConv] = this.conversations.splice(index, 1);
                this.conversations.unshift(movedConv);
            }

            // Save to localStorage as backup
            localStorage.setItem('pestivid_messages', JSON.stringify(this.messages));
            localStorage.setItem('pestivid_conversations', JSON.stringify(this.conversations));

            this.messageInputText = '';
            this.$nextTick(() => this.scrollToMessageBottom());

        } catch (error) {
            console.error('Error sending message:', error);
            console.error('Error details:', error.response ? error.response.data : error.message);
            console.error('Error status:', error.response ? error.response.status : 'No response');
            console.error('Error config:', error.config);

            // Fallback to local storage
            console.log('Falling back to local storage...');
            this.sendMessageLocal(messageText, conversation, receiverId);
            this.addNotification('Message sent (stored locally). API connection issue.', 'warning');
        }
    },
    sendMessageLocal(messageText, conversation, receiverId) {
        // Local message sending function
        const newMessage = {
            _id: this.generateId('msg_'),
            conversationId: this.activeConversationId,
            sender: this.currentUserIdentifier,
            receiver: receiverId,
            text: messageText,
            timestamp: new Date().toISOString(),
            read: false,
        };
        this.messages.push(newMessage);

        // Update conversation snippet and timestamp
        conversation.lastMessageSnippet = messageText.substring(0, 30) + (messageText.length > 30 ? '...' : '');
        conversation.lastMessageTimestamp = newMessage.timestamp;

        // Move conversation to top
        const index = this.conversations.findIndex(c => c._id === conversation._id);
        if (index > 0) {
            const [movedConv] = this.conversations.splice(index, 1);
            this.conversations.unshift(movedConv);
        }

        // Save to localStorage as backup
        localStorage.setItem('pestivid_messages', JSON.stringify(this.messages));
        localStorage.setItem('pestivid_conversations', JSON.stringify(this.conversations));

        this.messageInputText = '';
        this.$nextTick(() => this.scrollToMessageBottom());

        if (conversation.isLocal) {
            this.addNotification('Message sent (local mode).', 'info');
        }
    },
    scrollToMessageBottom() { const el = this.$refs.messageContainer; if (el) setTimeout(() => { el.scrollTop = el.scrollHeight; }, 50); },
    getUnreadCountForConversation(convId) {
        if (!this.isAuthenticated || !this.currentUserIdentifier || !this.messages) return 0;
        return this.messages.filter(msg => msg.conversationId === convId && msg.receiver === this.currentUserIdentifier && !msg.read).length;
    },
    markConversationAsRead(convId) {
        if (!this.isAuthenticated || !this.currentUserIdentifier || !convId) return;
        let changed = false;
        this.messages.forEach(msg => {
            if (msg.conversationId === convId && msg.receiver === this.currentUserIdentifier && !msg.read) {
                msg.read = true; changed = true;
            }
        });
        if(changed) localStorage.setItem('pestivid_messages', JSON.stringify(this.messages));
    },
    getOtherParticipantInitial(conv) {
        const partnerId = conv.participants.find(p => p !== this.currentUserIdentifier);
        const partnerUser = this.users.find(u => u._id === partnerId);
        return partnerUser && partnerUser.name ? partnerUser.name.charAt(0).toUpperCase() : '?';
    },
    getOtherParticipantDisplayAddress(conv) {
        const partnerId = conv.participants.find(p => p !== this.currentUserIdentifier);
        return this.getFarmerDisplayIdentifier(partnerId);
    },

    // --- Notifications ---
    loadUserNotifications() {
        if (!this.isAuthenticated || !this.currentUserIdentifier) return;
        this.notifications = JSON.parse(localStorage.getItem('pestivid_notifications') || '[]')
            .filter(n => n.recipient === this.currentUserIdentifier || n.global)
            .sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

        this.notifications.forEach(n => {
            if (!n.read && !this.recentNotifications.some(rn => rn._id === n._id || rn.temp_id === n._id )) {
                this.recentNotifications.push({ ...n, show: false, isTemp: false, temp_id: n._id });
            }
        });
        this.showNextToastNotification();
    },
    addNotification(message, type = 'info', recipientId = null, globalBroadcast = false) {
        const newNotif = {
            _id: this.generateId('notif_'), recipient: recipientId || (globalBroadcast ? null : this.currentUserIdentifier),
            type: type, message: message, timestamp: new Date().toISOString(), read: false,
            global: globalBroadcast, isTemp: true,
        };
        if (recipientId === this.currentUserIdentifier || globalBroadcast || (recipientId === null && !globalBroadcast && this.isAuthenticated)) {
             this.recentNotifications.push({...newNotif, show: false});
             this.showNextToastNotification();
        }
        this.notifications.unshift(newNotif);
        localStorage.setItem('pestivid_notifications', JSON.stringify(this.notifications));
    },
    showNextToastNotification() {
        if (this.recentNotifications.filter(n => n.show).length >= 3) return;
        const nextToastCandidate = this.recentNotifications.find(n => !n.show);
        if (nextToastCandidate) {
            setTimeout(() => {
                const idx = this.recentNotifications.findIndex(n => (n._id === nextToastCandidate._id) || (n.temp_id === nextToastCandidate.temp_id));
                if(idx > -1) {
                     this.$set(this.recentNotifications[idx], 'show', true);
                     const autoDismissDuration = nextToastCandidate.type === 'error' ? 6000 : 4500;
                     this.recentNotifications[idx].timeoutId = setTimeout(() => this.dismissNotification(nextToastCandidate._id || nextToastCandidate.temp_id), autoDismissDuration);
                }
            }, 50);
        }
    },
    dismissNotification(id) {
        const index = this.recentNotifications.findIndex(n => (n._id === id) || (n.temp_id === id));
        if (index > -1) {
            if (this.recentNotifications[index].timeoutId) clearTimeout(this.recentNotifications[index].timeoutId);
            const notificationToDismiss = this.recentNotifications[index];
            this.$set(this.recentNotifications[index], 'show', false);

            const mainNotifIdx = this.notifications.findIndex(n => n._id === (notificationToDismiss._id || notificationToDismiss.temp_id));
            if (mainNotifIdx > -1) {
                 this.$set(this.notifications[mainNotifIdx], 'read', true);
                 localStorage.setItem('pestivid_notifications', JSON.stringify(this.notifications));
            }

            setTimeout(() => {
                const removeIndex = this.recentNotifications.findIndex(n => (n._id === id) || (n.temp_id === id));
                if (removeIndex > -1) {
                    this.recentNotifications.splice(removeIndex, 1);
                    this.$nextTick(() => this.showNextToastNotification());
                }
            }, 400);
        }
    },
    formatTimestamp(isoString, short = false) {
        if (!isoString) return ''; try { const date = new Date(isoString);
        if (short) { const now = new Date(); const diffMs = now - date; const diffMins = Math.round(diffMs / 60000); const diffHours = Math.round(diffMins / 60); const diffDays = Math.round(diffHours / 24);
        if (diffMins < 1) return 'now'; if (diffMins < 60) return `${diffMins}m`; if (diffHours < 24) return `${diffHours}h`; if (diffDays < 7) return `${diffDays}d`; return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }); }
        return date.toLocaleString(undefined, { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        } catch (e) { console.error("Error formatting timestamp:", e, isoString); return isoString; }
    },

    // --- Plant Analysis (AI Integration) ---
    handlePlantImageUpload(event) {
        const file = event.target.files[0];
        if (file) {
            this.plantImageFile = file;
            if (this.plantImageUrl) URL.revokeObjectURL(this.plantImageUrl);
            this.plantImageUrl = URL.createObjectURL(file);
            this.plantImageMimeType = file.type;
            this.analysisResultText = '';
            this.parsedAnalysis = { plantName: null, diseaseName: null, confidence: null, treatmentRecommended: null };
            this.analysisErrorText = '';
        } else {
            this.plantImageFile = null;
            if (this.plantImageUrl) URL.revokeObjectURL(this.plantImageUrl);
            this.plantImageUrl = null;
            this.plantImageMimeType = null;
            this.analysisResultText = '';
            this.parsedAnalysis = { plantName: null, diseaseName: null, confidence: null, treatmentRecommended: null };
            this.analysisErrorText = '';
        }
    },
    async analyzePlant() {
        if (!this.plantImageFile) {
            this.addNotification("Please upload a plant image first.", "warning");
            return;
        }

        this.analysisInProgress = true;
        this.analysisResultText = '';
        this.parsedAnalysis = { plantName: null, diseaseName: null, confidence: null, treatmentRecommended: null };
        this.analysisErrorText = '';

        try {
            const formData = new FormData();
            formData.append('file', this.plantImageFile);

            console.log("Sending request to Flask server...");
            
            // Use the simple server since it's working
            const url = 'http://localhost:5000/predict';
            console.log(`Using endpoint: ${url}`);
            
            // Try using fetch instead of axios
            const response = await fetch(url, {
                method: 'POST',
                body: formData,
                // Don't set Content-Type header, let the browser set it with the boundary
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            console.log("Response received:", result);
            
            this.analysisResultText = JSON.stringify(result, null, 2);

            if (result.error) {
                this.analysisErrorText = result.error;
                this.addNotification(`Analysis error: ${result.error}`, "error");
            } else {
                this.parsedAnalysis = {
                    plantName: "Potato Plant",
                    diseaseName: result.disease || "Unknown",
                    confidence: result.confidence || "N/A",
                    treatmentRecommended: result.recommendation || "No specific treatment recommended."
                };
                this.addNotification("Plant analysis complete!", "success");
            }
        } catch (error) {
            console.error('Plant analysis request error:', error);
            this.analysisErrorText = `Error: ${error.message}`;
            this.addNotification(this.analysisErrorText, "error");
        } finally {
            this.analysisInProgress = false;
        }
    },

    // --- Farmer Chatbot (AgriBot - AI Integrated) ---
    renderMarkdown(text) { if (window.marked) return marked.parse(text || ''); return text || ''; },
    initializeChatbot() {
        if (this.current === 'farmerChatbot' && this.isAuthenticated && this.role === 'farmer') {
            const storedAgriBotChat = localStorage.getItem(`pestivid_agribot_chat_${this.currentUserIdentifier}`);
            if (storedAgriBotChat) {
                this.chatMessages = JSON.parse(storedAgriBotChat);
            } else if (this.chatMessages.length === 0) {
                this.chatMessages.push({ _id: this.generateId('bot_init_'), sender: 'bot', text: "Hello! I'm AgriBot, your AI farming assistant. How can I help you today?", timestamp: new Date().toISOString() });
            }
        } else if (this.current === 'farmerChatbot' && (!this.isAuthenticated || this.role !== 'farmer')) {
            this.chatMessages = [{ _id: this.generateId('bot_access_'), sender: 'bot', text: "Please log in as a Farmer to use AgriBot." }];
        }
        this.$nextTick(() => this.scrollToChatBottom());
    },
    async sendChatMessage() {
        if (!this.chatInput.trim() || this.isGroqLoading || !this.isAuthenticated || this.role !== 'farmer') return;
        
        const userMessageText = this.chatInput.trim();
        this.chatMessages.push({ _id: this.generateId('user_'), sender: 'user', text: userMessageText, timestamp: new Date().toISOString() });
        this.chatInput = '';
        this.$nextTick(() => this.scrollToChatBottom());

        this.isGroqLoading = true;

        try {
            // Make a POST request to your Flask backend
            const response = await axios.post(`${this.flaskApiUrl}/chat`, {
                question: userMessageText 
            });

            // The response.data should be: { question: "...", answer: "..." }
            const botResponse = response.data.answer;

            this.chatMessages.push({ _id: this.generateId('bot_'), sender: 'bot', text: botResponse, timestamp: new Date().toISOString() });

        } catch (error) {
            console.error("Error communicating with the AgriBot backend:", error);
            let errorMessage = "I'm having trouble connecting to my brain right now. Please try again in a moment.";
            if (error.code === "ERR_NETWORK") {
                errorMessage += " (Is the AI server running?)";
            } else if (error.response) {
                errorMessage += ` (Error: ${error.response.status})`;
            }
            
            // Add an error message to the chat interface for the user
            this.chatMessages.push({ _id: this.generateId('bot_err_'), sender: 'bot', text: errorMessage, timestamp: new Date().toISOString() });
            
            // Also add a system notification
            this.addNotification("Could not get response from AgriBot.", "error");

        } finally {
            // This block will run whether the API call succeeded or failed
            this.isGroqLoading = false;
            
            // Save chat history to localStorage
            if (this.isAuthenticated && this.currentUserIdentifier) {
                localStorage.setItem(`pestivid_agribot_chat_${this.currentUserIdentifier}`, JSON.stringify(this.chatMessages));
            }

            this.$nextTick(() => this.scrollToChatBottom());
        }
    },
    scrollToChatBottom() { const container = this.$refs.chatbotMessagesContainer; if (container) setTimeout(() => { container.scrollTop = container.scrollHeight; }, 50); },

    // --- Avatar Assistant (AI Simulated) ---
    toggleAvatarExpansion(forceState = null) {
        if (!this.isAuthenticated) return; const newState = forceState !== null ? forceState : !this.avatar.expanded; this.avatar.expanded = newState;
        if (this.avatar.expanded) { this.avatar.state = 'listening'; this.markAvatarMessagesAsRead(); this.$nextTick(() => this.scrollToAvatarMessagesBottom()); this.updateAvatarContextAndQuickActions();
            if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) { if (!this.speechRecognition) this.initializeSpeechRecognition(); if (this.speechRecognition && !this.avatar.isListening) { try { this.speechRecognition.start(); } catch (e) { console.error("Error starting speech recognition:", e); this.addAvatarMessage("Could not start voice input.", 'bot'); this.avatar.isListening = false; this.avatar.state = 'idle'; }}
            } else { this.addAvatarMessage("Voice input not supported by your browser.", 'bot'); this.avatar.isListening = false;}
        } else { this.avatar.state = 'idle'; if (this.speechRecognition && this.avatar.isListening) this.speechRecognition.stop(); if ('speechSynthesis' in window && speechSynthesis.speaking) { speechSynthesis.cancel(); this.avatar.state = 'idle'; }}
    },
    addAvatarMessage(text, sender, isRead = false) {
        if (!this.isAuthenticated || !this.currentUserIdentifier) return;
        const newMessage = { _id: this.generateId('avatar_msg_'), text: text, sender: sender, timestamp: new Date().toISOString(), readByUser: sender === 'user' ? true : isRead, };
        this.avatar.chatMessages.push(newMessage); this.$nextTick(() => this.scrollToAvatarMessagesBottom());
        localStorage.setItem(`pestivid_avatar_chat_${this.currentUserIdentifier}`, JSON.stringify(this.avatar.chatMessages));
        if (sender === 'bot' && !this.avatar.expanded && 'speechSynthesis' in window) this.speakAvatarResponse(text);
    },
    async sendAvatarMessage() {
        if (!this.avatar.userInput.trim() || this.avatar.isProcessing || !this.isAuthenticated || !this.currentUserIdentifier) return;
        const userText = this.avatar.userInput.trim(); this.addAvatarMessage(userText, 'user');
        this.avatar.userInput = ''; this.avatar.isProcessing = true; this.avatar.state = 'thinking'; this.avatar.quickActions = [];
        await new Promise(resolve => setTimeout(resolve, 1200));

        let botText = `Okay, you said: "${userText}". `;
        if (userText.toLowerCase().includes("help")) botText += "I can help you navigate PestiVid. What would you like to do? Try asking about 'uploading a video' or 'finding investments'. [action:Go to Home]";
        else if (userText.toLowerCase().includes("upload video")) botText += "To upload a video, go to the PestiVid page. [action:Go to PestiVid]";
        else if (userText.toLowerCase().includes("buy crops")) botText += "You can browse and buy crops on the AgriSell Marketplace. [action:Go to Marketplace]";
        else if (userText.toLowerCase().includes("invest")) botText += "Looking for investment opportunities? Check out the Projects page. [action:Go to Projects]";
        else botText += "This is a simulated response. For real assistance, I'd connect to an AI model. How else can I assist? [action:Close Helper]";

        this.addAvatarMessage(botText, 'bot', this.avatar.expanded); this.parseAvatarResponseForActions(botText); this.speakAvatarResponse(botText);
        this.avatar.isProcessing = false; this.avatar.state = this.avatar.isListening ? 'listening' : 'idle';
    },
    parseAvatarResponseForActions(responseText) {
        const actionRegex = /\[action:([^\]]+)\]/gi; let match; const newQuickActions = []; const seenActions = new Set(); let cleanedResponseText = responseText;
        while ((match = actionRegex.exec(responseText)) !== null) {
            const actionTagContent = match[1].trim(); let actionLabel = actionTagContent; let actionTargetPage = null; let isSwitchRoleAction = false; let targetRole = null;
            if (actionTagContent.toLowerCase().startsWith('go to ')) {
                const pageName = actionTagContent.substring('go to '.length).trim();
                actionLabel = `Go to ${pageName}`; const pageNameLower = pageName.toLowerCase();
                if (pageNameLower.includes('pestivid') || pageNameLower.includes('upload')) actionTargetPage = 'farmerPestiVid';
                else if (pageNameLower.includes('marketplace') || pageNameLower.includes('agrisell') || pageNameLower.includes('buy')) actionTargetPage = 'buyerAgriSell';
                else if (pageNameLower.includes('funding') || pageNameLower.includes('get funding')) actionTargetPage = 'farmerFunding';
                else if (pageNameLower.includes('invest') || pageNameLower.includes('projects') || pageNameLower.includes('opportunities')) actionTargetPage = 'investorProjects';
                else if (pageNameLower.includes('portfolio')) actionTargetPage = 'investorPortfolio';
                else if (pageNameLower.includes('profile') || pageNameLower.includes('my account')) actionTargetPage = 'userProfile';
                else if (pageNameLower.includes('messaging') || pageNameLower.includes('chat')) actionTargetPage = 'messaging';
                else if (pageNameLower.includes('plant analysis') || pageNameLower.includes('disease detection')) actionTargetPage = 'plantAnalysis'; // Updated
                else if (pageNameLower.includes('agribot')) actionTargetPage = 'farmerChatbot';
                else if (pageNameLower.includes('home') || pageNameLower.includes('landing')) actionTargetPage = 'landing';
                if (actionTargetPage) { const requiredRole = this.getRoleForPage(actionTargetPage); if (requiredRole && requiredRole !== this.role) { isSwitchRoleAction = true; targetRole = requiredRole; actionLabel = `Switch to ${targetRole.charAt(0).toUpperCase() + targetRole.slice(1)} Role`; }}
            } else if (actionTagContent.toLowerCase() === 'close helper') { actionLabel = 'Close Helper'; actionTargetPage = 'custom_close';}
            if (actionTargetPage && !seenActions.has(actionLabel)) {
                if (isSwitchRoleAction) newQuickActions.push({ id: this.generateId('qa_'), label: actionLabel, customHandler: () => this.switchDemoRoleAndLogin(targetRole) });
                else if (actionTargetPage === 'custom_close') newQuickActions.push({ id: this.generateId('qa_'), label: actionLabel, customHandler: () => this.toggleAvatarExpansion(false) });
                else newQuickActions.push({ id: this.generateId('qa_'), label: actionLabel, targetPage: actionTargetPage });
                seenActions.add(actionLabel);
            }
            cleanedResponseText = cleanedResponseText.replace(match[0], '').trim();
        }
        cleanedResponseText = cleanedResponseText.replace(/\[action:\s*\]/gi, '').trim();
        if (this.avatar.chatMessages.length > 0) { const lastBotMsgIndex = this.avatar.chatMessages.map(msg => msg.sender).lastIndexOf('bot'); if (lastBotMsgIndex !== -1) this.$set(this.avatar.chatMessages[lastBotMsgIndex], 'text', cleanedResponseText); }
        this.avatar.quickActions = newQuickActions.slice(0, 3);
        if (this.avatar.quickActions.length < 3 && !seenActions.has("Close Helper")) this.avatar.quickActions.push({ id: 'qa_close_default', label: "Close Helper", customHandler: () => this.toggleAvatarExpansion(false) });
        if (this.avatar.quickActions.length < 3 && !seenActions.has("Go to Home") && this.current !== 'landing') this.avatar.quickActions.push({ id: 'qa_home_default', label: "Go to Home", targetPage: 'landing' });
        this.avatar.quickActions = this.avatar.quickActions.slice(0, 3);
    },
    switchDemoRoleAndLogin(targetRole) {
         if (!targetRole || !['farmer', 'buyer', 'investor', 'transporter'].includes(targetRole)) return;
          const demoUserForRole = this.users.find(u => u.role === targetRole && u.email.startsWith('demo.'));
          if (!demoUserForRole) { this.addNotification(`Demo user for "${targetRole}" not found.`, 'error'); return; }
         this.addNotification(`Switching to Demo ${targetRole.charAt(0).toUpperCase() + targetRole.slice(1)}... Log in.`, 'info');
         this.logout();
          this.loginForm.email = demoUserForRole.email; this.loginForm.password = demoUserForRole.passwordHash;
          this.loginForm.remember = true; this.showSignup = false;
         this.$nextTick(() => {
               this.addAvatarMessage(`Login form ready for Demo ${targetRole.charAt(0).toUpperCase() + targetRole.slice(1)}. Sign in as "${demoUserForRole.email}".`, 'bot');
               this.speakAvatarResponse(`Login form ready for Demo ${targetRole.charAt(0).toUpperCase() + targetRole.slice(1)}. Sign in.`);
         });
         this.toggleAvatarExpansion(false);
    },
    handleAvatarQuickAction(action) {
          if (action.targetPage) { this.addAvatarMessage(`Okay, going to ${action.label.replace('Go to ','')}...`, 'bot'); this.speakAvatarResponse(`Okay, going to ${action.label.replace('Go to ','')}.`); this.switchPage(action.targetPage); this.toggleAvatarExpansion(false); }
          else if (action.customHandler) action.customHandler();
          this.avatar.quickActions = [];
    },
    getRoleForPage(page) {
         if (page.startsWith('farmerPestiVid') || page.startsWith('farmerAgriStream') || page.startsWith('farmerSell') || page.startsWith('farmerFunding') || page === 'plantAnalysis' || page === 'farmerChatbot') return 'farmer'; // Updated
         if (page.startsWith('buyerAgriSell')) return 'buyer';
         if (page.startsWith('investorProjects') || page.startsWith('investorPortfolio')) return 'investor';
         if (page === 'userProfile' || page === 'messaging' || page === 'landing') return this.role;
         return null;
    },
    scrollToAvatarMessagesBottom() { const el = this.$refs.avatarMessagesContainer; if (el) setTimeout(() => { el.scrollTop = el.scrollHeight; }, 50); },
    markAvatarMessagesAsRead() {
        if (!this.isAuthenticated || !this.currentUserIdentifier || !this.avatar.chatMessages) return;
        let changed = false;
        this.avatar.chatMessages.forEach(msg => { if (msg.sender === 'bot' && !msg.readByUser) { msg.readByUser = true; changed = true; } });
        if (changed) localStorage.setItem(`pestivid_avatar_chat_${this.currentUserIdentifier}`, JSON.stringify(this.avatar.chatMessages));
    },
    loadAvatarChatHistory() {
        if (!this.isAuthenticated || !this.currentUserIdentifier) return;
        const storedChat = localStorage.getItem(`pestivid_avatar_chat_${this.currentUserIdentifier}`);
        if (storedChat) { this.avatar.chatMessages = JSON.parse(storedChat); }
        else { this.avatar.chatMessages = []; }
    },
    speakAvatarResponse(textToSpeak) {
        // Enhanced TTS error handling and prevention
        if (!('speechSynthesis' in window)) {
            console.warn('Speech synthesis not supported');
            this.avatar.state = this.avatar.isListening ? 'listening' : 'idle';
            return;
        }

        if (!this.avatar.expanded || !this.avatar.ttsEnabled) {
            this.avatar.state = this.avatar.isListening ? 'listening' : 'idle';
            return;
        }

        try {
            // Cancel any existing speech to prevent conflicts
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                // Wait a bit for cancellation to complete
                setTimeout(() => this.processSpeech(textToSpeak), 100);
                return;
            }

            this.processSpeech(textToSpeak);

        } catch (error) {
            console.error('Error in speakAvatarResponse:', error);
            this.avatar.state = this.avatar.isListening ? 'listening' : 'idle';
        }
    },

    processSpeech(textToSpeak) {
        try {
            let cleanText = textToSpeak;
            cleanText = cleanText.replace(/[*_~`#\-+\d.\s]+(?=\s)/g, '').trim();
            cleanText = cleanText.replace(/\[action:[^\]]+\]/gi, '').trim();
            cleanText = cleanText.replace(/\s{2,}/g, ' ');

            if (!cleanText || cleanText.length === 0) {
                this.avatar.state = this.avatar.isListening ? 'listening' : 'idle';
                return;
            }

            // Limit text length to prevent long speech
            if (cleanText.length > 200) {
                cleanText = cleanText.substring(0, 200) + '...';
            }

            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'en-US';
            utterance.pitch = 1.1;
            utterance.rate = 1.0;
            utterance.volume = 0.8;

            utterance.onstart = () => {
                this.avatar.state = 'talking';
            };

            utterance.onend = () => {
                this.$nextTick(() => {
                    this.avatar.state = this.avatar.expanded && this.speechRecognition && this.avatar.isListening ? 'listening' : 'idle';
                });
            };

            utterance.onerror = (event) => {
                console.error('SpeechSynthesis Error:', event.error);
                this.$nextTick(() => {
                    this.avatar.state = this.avatar.expanded && this.speechRecognition && this.avatar.isListening ? 'listening' : 'idle';

                    // Only show error notification for serious errors, not interruptions
                    if (event.error !== 'interrupted' && event.error !== 'canceled') {
                        this.addNotification(`Voice error: ${event.error}`, 'warning');
                    }
                });
            };

            // Add timeout to prevent hanging
            setTimeout(() => {
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                    this.avatar.state = this.avatar.isListening ? 'listening' : 'idle';
                }
            }, 10000); // 10 second timeout

            speechSynthesis.speak(utterance);

        } catch (error) {
            console.error('Error in processSpeech:', error);
            this.avatar.state = this.avatar.isListening ? 'listening' : 'idle';
        }
    },
    initializeSpeechRecognition() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) { console.warn("Speech Recognition API not supported."); this.avatar.visible = false; this.addNotification("Voice input not supported by your browser.", 'warning'); return; }
        if (this.speechRecognition) return; console.log("Initializing Speech Recognition..."); this.speechRecognition = new SpeechRecognition();
        this.speechRecognition.continuous = false; this.speechRecognition.lang = 'en-US'; this.speechRecognition.interimResults = false; this.speechRecognition.maxAlternatives = 1;
        this.speechRecognition.onresult = (event) => { const speechResult = event.results[0][0].transcript; console.log("Speech recognized:", speechResult); this.avatar.userInput = speechResult; this.avatar.isListening = false; this.avatar.state = 'idle'; this.sendAvatarMessage(); };
        this.speechRecognition.onspeechend = () => { if (this.avatar.isListening) this.speechRecognition.stop(); };
        this.speechRecognition.onend = () => { this.avatar.isListening = false; if (this.avatar.state === 'listening') this.avatar.state = 'idle'; };
        this.speechRecognition.onnomatch = () => { this.addAvatarMessage("Sorry, I didn't catch that.", 'bot'); this.speakAvatarResponse("Sorry, I didn't catch that."); };
        this.speechRecognition.onerror = (event) => { console.error('Speech recognition error:', event.error); let errorMsg = "Speech error: " + event.error; if (event.error === 'not-allowed' || event.error === 'service-not-allowed') errorMsg = "Mic access denied."; else if (event.error === 'no-speech') errorMsg = "No speech detected."; else if (event.error === 'aborted') return; else if (event.error === 'network') errorMsg = "Network error during speech recognition."; this.addAvatarMessage(`Voice input error: ${errorMsg}`, 'bot'); this.addNotification(`Voice input error: ${errorMsg}`, 'error'); this.avatar.isListening = false; this.avatar.state = 'idle'; };
        this.speechRecognition.onstart = () => { this.avatar.isListening = true; this.avatar.state = 'listening'; };
    },
    toggleAvatarListening() {
        if (!this.isAuthenticated || !this.speechRecognition) { if(!this.speechRecognition) this.addNotification("Voice input not available.", "warning"); return; }
        if (this.avatar.isProcessing) { this.addNotification("Helper is processing. Wait.", "info"); return; }
        if ('speechSynthesis' in window && speechSynthesis.speaking) { speechSynthesis.cancel(); this.avatar.state = 'idle'; }
        if (this.avatar.isListening) { this.speechRecognition.stop(); }
        else { try { this.speechRecognition.start(); } catch (e) { console.error("Error starting speech recognition:", e); let errorMsg = "Could not start voice input. "; if (e.message.includes('already started')) errorMsg = "Voice input already active."; else errorMsg += e.message; this.addNotification(errorMsg, "error"); this.avatar.isListening = false; this.avatar.state = 'idle'; }}
    },
    toggleTTS() {
        this.avatar.ttsEnabled = !this.avatar.ttsEnabled;

        // Cancel any current speech when disabling
        if (!this.avatar.ttsEnabled && 'speechSynthesis' in window && speechSynthesis.speaking) {
            speechSynthesis.cancel();
            this.avatar.state = this.avatar.isListening ? 'listening' : 'idle';
        }

        const status = this.avatar.ttsEnabled ? 'enabled' : 'disabled';
        this.addNotification(`Voice output ${status}`, 'info');
        console.log(`TTS ${status}`);
    },
    updateAvatarContextAndQuickActions() {
        let context = ""; let actions = []; const page = this.current; const userRole = this.role;
        if (!this.isAuthenticated) { this.avatar.quickActions = []; this.avatar.currentContextText = "User is not logged in."; return; }
        context += `User role: ${userRole}. Current page: ${page}. `;
        switch(page) {
            case 'landing':
                context += "Welcome to PestiVid's home page! This is your central hub for blockchain-powered agricultural transparency. From here you can access all platform features including video uploads, marketplace, funding, and AI-powered plant analysis.";
                actions.push({ id: 'qa_explore_marketplace', label: "Explore Marketplace", targetPage: 'buyerAgriSell'});
                if (userRole === 'farmer') actions.push({ id: 'qa_upload_video', label: "Upload PestiVid", targetPage: 'farmerPestiVid'});
                if (userRole === 'investor') actions.push({ id: 'qa_view_projects', label: "View Projects", targetPage: 'investorProjects'});
                break;
            case 'farmerPestiVid':
                context += "This is the PestiVid upload page where farmers create transparent video records of their farming practices. Record videos showing your crops, pesticide applications, and farming methods. These videos are stored on IPFS blockchain for immutable transparency and help build trust with buyers and investors.";
                actions.push({ id: 'qa_how_to_record', label: "How to record?", customHandler: () => {this.addAvatarMessage("Fill in crop details like crop type, location, pesticide company, and purpose. Click 'Start Recording' to begin video capture. Allow camera access when prompted. After recording, click 'Upload to IPFS' to store your video permanently on the blockchain.", "bot"); this.speakAvatarResponse("Fill in crop details like crop type, location, pesticide company, and purpose. Click Start Recording to begin video capture. Allow camera access when prompted. After recording, click Upload to IPFS to store your video permanently on the blockchain.");} });
                actions.push({ id: 'qa_view_my_videos', label: "View My Videos", targetPage: 'farmerAgriStream'});
                break;
            case 'farmerAgriStream':
                context += "AgriStream is your video library showing all your uploaded PestiVid content. This creates a transparent timeline of your farming activities that buyers and investors can review. Each video includes metadata about crops, treatments, and farming practices, building your reputation for transparency.";
                actions.push({ id: 'qa_create_listing_from_video', label: "Create Listing?", customHandler: () => {this.addAvatarMessage("You can create marketplace listings directly from your videos here. Click 'Create Listing' on any video card to list those crops for sale. This connects your transparent farming videos to your marketplace offerings.", "bot"); this.speakAvatarResponse("You can create marketplace listings directly from your videos here. Click Create Listing on any video card to list those crops for sale. This connects your transparent farming videos to your marketplace offerings.");} });
                actions.push({ id: 'qa_upload_new_video', label: "Upload New Video", targetPage: 'farmerPestiVid'});
                break;
            case 'farmerSell':
                context += "The marketplace selling page lets farmers list their crops for sale. Connect your PestiVid videos to listings so buyers can see exactly how your crops were grown. Set price ranges and enable buyer notifications. Transparency through video evidence helps you get better prices.";
                actions.push({ id: 'qa_select_video_for_listing', label: "How to list?", customHandler: () => {this.addAvatarMessage("Select an unlisted video from the dropdown that shows your crop quality. Set your minimum and maximum price range. Enable buyer notifications to alert potential customers. Click 'Create Listing' to publish. Your transparent farming videos help justify premium pricing!", "bot"); this.speakAvatarResponse("Select an unlisted video from the dropdown that shows your crop quality. Set your minimum and maximum price range. Enable buyer notifications to alert potential customers. Click Create Listing to publish. Your transparent farming videos help justify premium pricing!");} });
                actions.push({ id: 'qa_view_marketplace', label: "View Marketplace", targetPage: 'buyerAgriSell'});
                break;
            case 'farmerFunding':
                context += "Request funding for your agricultural projects from investors. Create detailed funding requests with project descriptions, expected ROI, timelines, and investor share percentages. Link your PestiVid videos to show your farming expertise and build investor confidence.";
                actions.push({ id: 'qa_how_to_request_funding', label: "How to request funding?", customHandler: () => {this.addAvatarMessage("Fill out the funding form with your project title, crop type, acreage, funding amount needed, farming method, timeline, expected ROI, and investor share percentage. Select a relevant PestiVid video to demonstrate your farming capabilities. Submit your request and investors can browse and fund your project.", "bot"); this.speakAvatarResponse("Fill out the funding form with your project title, crop type, acreage, funding amount needed, farming method, timeline, expected ROI, and investor share percentage. Select a relevant PestiVid video to demonstrate your farming capabilities. Submit your request and investors can browse and fund your project.");} });
                actions.push({ id: 'qa_view_investor_projects', label: "See Investor View", targetPage: 'investorProjects'});
                break;
            case 'plantAnalysis':
                context += "AI-powered plant disease detection using advanced CLIP model technology. Upload photos of your plants to get instant disease identification and treatment recommendations. This helps farmers quickly diagnose problems and take appropriate action to protect their crops.";
                actions.push({ id: 'qa_how_plant_analysis_works', label: "How plant analysis works?", customHandler: () => {this.addAvatarMessage("Upload a clear photo of an affected plant leaf or area. Our AI CLIP model will analyze the image to identify the plant type, detect any diseases, and provide specific treatment recommendations. The analysis includes confidence scores and detailed explanations.", "bot");this.speakAvatarResponse("Upload a clear photo of an affected plant leaf or area. Our AI CLIP model will analyze the image to identify the plant type, detect any diseases, and provide specific treatment recommendations. The analysis includes confidence scores and detailed explanations.");} });
                break;
            case 'farmerChatbot':
                context += "AgriBot is your AI farming assistant providing personalized agricultural advice. Ask questions about crop management, pest control, seasonal planning, soil health, irrigation, and farming best practices. Get instant, expert-level guidance tailored to your specific farming needs.";
                actions.push({ id: 'qa_ask_about_pests', label: "Ask about pests", customHandler: () => {this.avatar.userInput = "How to control aphids on tomatoes?"; this.sendAvatarMessage();} });
                break;
            case 'buyerAgriSell':
                context += "The AgriSell marketplace where buyers can browse and purchase crops directly from farmers. Each listing includes transparent PestiVid videos showing exactly how crops were grown, what treatments were used, and current crop conditions. Filter by crop type, location, and farming practices.";
                actions.push({ id: 'qa_how_to_buy', label: "How to buy?", customHandler: () => {this.addAvatarMessage("Browse crop listings and watch the linked PestiVid videos to see farming practices and crop quality. Use filters to find specific crops or locations. Click 'Initiate Purchase' on a listing, enter your offer within the price range, and confirm. You can also message farmers for more details.", "bot"); this.speakAvatarResponse("Browse crop listings and watch the linked PestiVid videos to see farming practices and crop quality. Use filters to find specific crops or locations. Click Initiate Purchase on a listing, enter your offer within the price range, and confirm. You can also message farmers for more details.");} });
                if (userRole !== 'buyer') actions.push({ id: 'qa_switch_to_buyer', label: "Switch to Buyer Role", customHandler: () => this.switchDemoRoleAndLogin('buyer') });
                break;
            case 'investorProjects':
                context += "Browse agricultural investment opportunities from farmers seeking funding. Each project includes detailed information about crop types, acreage, expected returns, timelines, and farming methods. Review linked PestiVid videos to assess farmer expertise before investing.";
                actions.push({ id: 'qa_how_to_invest', label: "How to invest?", customHandler: () => {this.addAvatarMessage("Review project details including crop type, funding amount, expected ROI, timeline, and farmer's track record. Watch linked PestiVid videos to assess the farmer's capabilities. Enter your investment amount and click 'Invest Now'. Track your investments in your portfolio.", "bot");this.speakAvatarResponse("Review project details including crop type, funding amount, expected ROI, timeline, and farmer's track record. Watch linked PestiVid videos to assess the farmer's capabilities. Enter your investment amount and click Invest Now. Track your investments in your portfolio.");} });
                actions.push({ id: 'qa_view_my_portfolio', label: "My Portfolio", targetPage: 'investorPortfolio'});
                if (userRole !== 'investor') actions.push({ id: 'qa_switch_to_investor', label: "Switch to Investor Role", customHandler: () => this.switchDemoRoleAndLogin('investor') });
                break;
            case 'investorPortfolio':
                context += "Your investment portfolio dashboard showing all your agricultural investments, their current status, expected returns, and performance metrics. Track funding progress, project timelines, and communicate with farmers about your investments.";
                actions.push({ id: 'qa_browse_more_projects', label: "Browse More Projects", targetPage: 'investorProjects'});
                break;
            case 'userProfile':
                context += "Your PestiVid profile page displaying your account information, role, member since date, and platform statistics. This is where you can view your account details and platform activity summary.";
                actions.push({ id: 'qa_edit_profile_info', label: "Edit Profile?", customHandler: () => {this.addAvatarMessage("Profile editing features are coming soon! Currently, your profile shows information from your signup. Future updates will allow you to customize your profile, add bio, farming specialties, and more.", "bot");this.speakAvatarResponse("Profile editing features are coming soon! Currently, your profile shows information from your signup. Future updates will allow you to customize your profile, add bio, farming specialties, and more.");} });
                break;
            case 'messaging':
                context += "The PestiVid messaging system for communicating with other platform users. Start conversations with farmers about their crops, discuss investment opportunities, or get support. All messages are organized by conversation for easy tracking.";
                actions.push({ id: 'qa_how_to_start_chat', label: "How to start a chat?", customHandler: () => {this.addAvatarMessage("Start new conversations by clicking message icons on user profiles, marketplace listings, or investment projects. You can also search for users to message. All your conversations appear here with unread message indicators.", "bot");this.speakAvatarResponse("Start new conversations by clicking message icons on user profiles, marketplace listings, or investment projects. You can also search for users to message. All your conversations appear here with unread message indicators.");} });
                break;
            default:
                context += "You're currently on a page I'm not familiar with. Let me know if you need help navigating or have questions about PestiVid features!";
        }
        if (page !== 'landing' && !actions.some(a => a.targetPage === 'landing')) actions.push({ id: 'qa_go_home_generic', label: "Go to Home", targetPage: 'landing'});
        if (!actions.some(a => a.customHandler && a.label.includes("Close Helper"))) actions.push({ id: 'qa_close_helper_generic', label: "Close Helper", customHandler: () => this.toggleAvatarExpansion(false) });
        const uniqueActions = []; const seenLabels = new Set();
        for (const action of actions) { if (!seenLabels.has(action.label)) { uniqueActions.push(action); seenLabels.add(action.label); } if (uniqueActions.length >=3) break; }
        this.avatar.quickActions = uniqueActions.slice(0, 3); this.avatar.currentContextText = context;
        if(this.avatar.expanded && !this.avatar.userInput && !this.avatar.isProcessing) {
            let greeting = `Welcome to the ${page.replace(/([A-Z])/g, ' $1').trim()} page! `;
            // Add the detailed context explanation
            greeting += context.replace(`User role: ${userRole}. Current page: ${page}. `, '') + " ";
            if (uniqueActions.length > 0 && uniqueActions[0].label !== "Close Helper" && uniqueActions[0].label !== "Go to Home") {
                greeting += `You can ${uniqueActions[0].label.toLowerCase().replace('go to ', 'explore the ')}. How can I help?`;
            } else {
                greeting += "How can I assist you here?";
            }
            const lastBotMsg = this.avatar.chatMessages.length > 0 ? this.avatar.chatMessages[this.avatar.chatMessages.length -1] : null;
            if (!lastBotMsg || lastBotMsg.sender === 'user' || !lastBotMsg.text.startsWith("Welcome to the")) {
                this.addAvatarMessage(greeting, 'bot');
                this.speakAvatarResponse(greeting);
            }
        }
    },



    // --- Data Loading ---
    async loadDataFromDatabase() { // This method is illustrative of a backend integration
        if (!this.isAuthenticated) return;

        try {
            console.log('Loading data from database...');

            // Load videos from database
            const videosResponse = await axios.get(`${this.apiUrl}/videos`, {
                headers: { 'Authorization': `Bearer ${this.token}` }
            });
            if (videosResponse.data && Array.isArray(videosResponse.data)) {
                this.farmerVideos = videosResponse.data;
                console.log('Loaded videos from database:', this.farmerVideos.length);
            }

            // Load listings from database
            const listingsResponse = await axios.get(`${this.apiUrl}/listings`, {
                headers: { 'Authorization': `Bearer ${this.token}` }
            });
            if (listingsResponse.data && Array.isArray(listingsResponse.data)) {
                this.allListings = listingsResponse.data;
                this.farmerListings = listingsResponse.data.filter(l => {
                    const farmerWalletId = typeof l.farmerWallet === 'object' ? l.farmerWallet._id : l.farmerWallet;
                    return farmerWalletId === this.currentUserIdentifier;
                });
                console.log('Loaded listings from database:', this.allListings.length);
            }

            // Load purchases from database
            if (this.role === 'buyer') {
                const purchasesResponse = await axios.get(`${this.apiUrl}/purchases/buyer/${this.currentUserIdentifier}`, {
                    headers: { 'Authorization': `Bearer ${this.token}` }
                });
                if (purchasesResponse.data && Array.isArray(purchasesResponse.data)) {
                    this.buyerPurchases = purchasesResponse.data;
                    console.log('Loaded buyer purchases from database:', this.buyerPurchases.length);
                }
            }

            // Load farmer sales (purchases of their listings) from database
            if (this.role === 'farmer') {
                const salesResponse = await axios.get(`${this.apiUrl}/purchases/farmer/${this.currentUserIdentifier}`, {
                    headers: { 'Authorization': `Bearer ${this.token}` }
                });
                if (salesResponse.data && Array.isArray(salesResponse.data)) {
                    this.farmerSales = salesResponse.data;
                    console.log('Loaded farmer sales from database:', this.farmerSales.length);
                }
            }

        } catch (error) {
            console.error('Error loading data from database:', error);
            this.addNotification('Failed to load data from database. Using local data.', 'warning');
        }
    },

    // Initialize DApp with blockchain connections
    async initializeDApp() {
        console.log('🔗 Initializing blockchain connections...');

        try {
            // Initialize IPFS for decentralized storage
            await this.initializeIPFS();

            // Check if MetaMask is already connected
            await this.checkExistingWalletConnection();

            // Load authentication state
            this.loadAuthState();

            // Load platform data
            await this.loadPublicPlatformData();

            console.log('✅ DApp initialization complete');

        } catch (error) {
            console.error('❌ DApp initialization failed:', error);
            this.addNotification('DApp initialization failed. Some features may not work properly.', 'warning');
        }
    },

    // Check if wallet is already connected
    async checkExistingWalletConnection() {
        try {
            if (window.ethereum) {
                console.log('🔍 Checking for existing wallet connection...');

                // Check if already connected (without prompting user)
                const accounts = await window.ethereum.request({
                    method: 'eth_accounts'
                });

                if (accounts && accounts.length > 0) {
                    console.log('🔄 Found existing wallet connection, restoring silently...');
                    await this.restoreExistingWalletConnection(accounts[0]);
                } else {
                    console.log('💡 Wallet available but not connected');
                }
            } else {
                console.log('🦊 No wallet detected');
            }
        } catch (error) {
            console.log('No existing wallet connection found:', error.message);
        }
    },

    // Restore existing wallet connection without showing loading modal
    async restoreExistingWalletConnection(account) {
        try {
            console.log('🔄 Restoring wallet connection for:', account);

            // Set wallet state
            this.walletAddress = account;
            this.walletType = 'Web3 Wallet';
            this.walletConnected = true;

            console.log('✅ Wallet connection restored:', this.walletAddress);

            // Get balance and setup listeners (with error handling)
            try {
                await this.getBalance();
                this.setupWalletListeners();
            } catch (setupError) {
                console.warn('Some wallet features failed to initialize:', setupError);
            }

            // Link wallet to user account if authenticated
            if (this.isAuthenticated) {
                try {
                    await this.linkWalletToUser();
                } catch (linkError) {
                    console.warn('Failed to link wallet to user during restore:', linkError);
                }
            }

            this.addNotification(`✅ Wallet connection restored: ${this.formatWalletAddress(this.walletAddress)}`, 'success');

        } catch (error) {
            console.error('❌ Failed to restore wallet connection:', error);
            // Don't show error notification during silent restore
        }
    },

    // Initialize wallet integration
    async initializeWalletIntegration() {
        try {
            console.log('🔗 Initializing wallet integration...');

            // Create global wallet instance
            if (typeof PestVidWallet !== 'undefined') {
                window.pestVidWallet = new PestVidWallet();
                console.log('✅ Wallet integration initialized successfully');

                // Check if wallet was previously connected
                if (localStorage.getItem('walletConnected') === 'true') {
                    console.log('🔄 Attempting to reconnect wallet...');
                    await this.connectWallet();
                }
            } else {
                console.error('❌ PestVidWallet class not found');
            }
        } catch (error) {
            console.error('❌ Failed to initialize wallet integration:', error);
        }
    },

    // --- Lifecycle Hook ---
    async mounted() {
        console.log('🚀 Initializing PestVid DApp...');

        // Initialize wallet integration first
        await this.initializeWalletIntegration();

        // Initialize DApp with blockchain connections
        await this.initializeDApp();



        // Load transport data from database (with localStorage fallback)
        if (this.token) {
            await this.loadTransportDataFromDatabase();
        } else {
            this.loadTransportDataFromLocalStorage();
            // Initialize transport providers if not already loaded
            if (this.transportProviders.length === 0) {
                this.initializeTransportProviders();
            }
        }

        // --- API KEY WARNINGS ---
        if (this.pinataJwt === 'YOUR_PINATA_JWT_MUST_BE_REPLACED_HERE' || !this.pinataJwt || this.pinataJwt.length < 50) {
             console.warn("CONFIG WARNING: Pinata JWT not set or is placeholder. Video uploads WILL FAIL until a valid JWT is provided.");
        }
        // --- END API KEY WARNINGS ---

        const storedUsers = localStorage.getItem('pestivid_users');
        if (storedUsers) this.users = JSON.parse(storedUsers); else localStorage.setItem('pestivid_users', JSON.stringify(this.users));

        // Load farmer videos with sample videos
        this.farmerVideos = JSON.parse(localStorage.getItem('pestivid_farmerVideos') || '[]');

        // Add sample videos if none exist
        if (this.farmerVideos.length === 0) {
            this.addSampleVideos();
            this.addSampleListings();
            this.addSampleFundingRequests();
        }
        this.farmerListings = JSON.parse(localStorage.getItem('pestivid_farmerListings') || '[]');
        this.farmerFundingRequests = JSON.parse(localStorage.getItem('pestivid_farmerFundingRequests') || '[]');
        this.buyerPurchases = JSON.parse(localStorage.getItem('pestivid_buyerPurchases') || '[]');
        this.investorInvestments = JSON.parse(localStorage.getItem('pestivid_investorInvestments') || '[]');
        this.investorTransactions = JSON.parse(localStorage.getItem('pestivid_investorTransactions') || '[]');

        // Transport data is now loaded from database above, but keep localStorage as fallback
        if (!this.token) {
            this.farmerTransportRequests = JSON.parse(localStorage.getItem('pestivid_farmerTransportRequests') || '[]');
            this.buyerTransportRequests = JSON.parse(localStorage.getItem('pestivid_buyerTransportRequests') || '[]');
            this.investorTransportRequests = JSON.parse(localStorage.getItem('pestivid_investorTransportRequests') || '[]');
        }

        // Generate investor transport requests if needed
        if (this.role === 'investor' && this.investorTransportRequests.length === 0) {
            this.generateInvestorTransportRequests();
        }

        // Load transporter profile if user is a transporter
        if (this.role === 'transporter') {
            this.loadCurrentTransporter();
        }
        this.conversations = JSON.parse(localStorage.getItem('pestivid_conversations') || '[]');
        this.messages = JSON.parse(localStorage.getItem('pestivid_messages') || '[]');
        this.notifications = JSON.parse(localStorage.getItem('pestivid_notifications') || '[]');
         // Initialize allListings and allFundingRequests from the potentially wider stored versions
        this.allListings = JSON.parse(localStorage.getItem('pestivid_allListings') || JSON.stringify(this.farmerListings.filter(l => l.status === 'active')));
        this.allFundingRequests = JSON.parse(localStorage.getItem('pestivid_allFundingRequests') || JSON.stringify(this.farmerFundingRequests.filter(r => ['pending', 'partially_funded'].includes(r.status))));


        const rememberedEmail = localStorage.getItem('pestivid_email'); if (rememberedEmail) this.loginForm.email = rememberedEmail;
        const storedToken = localStorage.getItem('pestivid_token');
        const storedUserId = localStorage.getItem('pestivid_user_id'); // This should be the internal _id

        if (storedToken && storedUserId) {
            const user = this.users.find(u => u._id === storedUserId); // Find user by internal _id
            if (user) {
                this.token = storedToken; this.currentUser = { ...user }; this.isAuthenticated = true; this.currentUserIdentifier = user._id;
                this.userName = user.name; this.userEmail = user.email; this.userPhone = user.phone; this.memberSince = user.memberSince;
                axios.defaults.headers.common['Authorization'] = `Bearer ${this.token}`;
                this.addNotification(`Welcome back, ${this.userNameDisplay}! (Session Restored)`, 'success');

                this.loadUserAppData(); // This will correctly filter data based on currentUserIdentifier
                await this.loadDataFromDatabase(); // Load data from MongoDB

                this.avatar.character = this.role || 'farmer';
                if ('speechSynthesis' in window && ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window)) { if (!this.speechRecognition) this.initializeSpeechRecognition(); }
                else { console.warn("Avatar voice features not supported."); this.avatar.visible = false; }
                this.current = 'landing'; // Stay on landing page after login/session restore
            } else { this.logout(); /* Invalid stored user ID */ }
        } else {
            console.log("No stored session. User not authenticated.");
            // Show home page for non-authenticated users
            this.current = 'landing';
            // Load public platform data even when not authenticated
            await this.loadPublicPlatformData();
        }

        window.addEventListener('beforeunload', () => {
            // Persist all global lists, not just user-filtered ones, to simulate a shared backend for the demo
            localStorage.setItem('pestivid_farmerVideos', JSON.stringify(this.farmerVideos)); // Contains all farmer videos
            localStorage.setItem('pestivid_farmerListings', JSON.stringify(this.farmerListings)); // All farmer listings
            localStorage.setItem('pestivid_farmerFundingRequests', JSON.stringify(this.farmerFundingRequests)); // All funding requests
            localStorage.setItem('pestivid_farmerTransportRequests', JSON.stringify(this.farmerTransportRequests)); // All transport requests
            localStorage.setItem('pestivid_buyerPurchases', JSON.stringify(this.buyerPurchases)); // All purchases
            localStorage.setItem('pestivid_buyerTransportRequests', JSON.stringify(this.buyerTransportRequests)); // Buyer transport requests
            localStorage.setItem('pestivid_investorInvestments', JSON.stringify(this.investorInvestments)); // All investments
            localStorage.setItem('pestivid_investorTransactions', JSON.stringify(this.investorTransactions)); // All transactions
            localStorage.setItem('pestivid_investorTransportRequests', JSON.stringify(this.investorTransportRequests)); // Investor transport requests
            localStorage.setItem('pestivid_conversations', JSON.stringify(this.conversations));
            localStorage.setItem('pestivid_messages', JSON.stringify(this.messages));
            localStorage.setItem('pestivid_notifications', JSON.stringify(this.notifications));
            // Persist public marketplace views as well
            localStorage.setItem('pestivid_allListings', JSON.stringify(this.allListings));
            localStorage.setItem('pestivid_allFundingRequests', JSON.stringify(this.allFundingRequests));

            if(this.isAuthenticated && this.currentUserIdentifier){
                localStorage.setItem(`pestivid_avatar_chat_${this.currentUserIdentifier}`, JSON.stringify(this.avatar.chatMessages));
                localStorage.setItem(`pestivid_agribot_chat_${this.currentUserIdentifier}`, JSON.stringify(this.chatMessages));
            }
        });
    }
}
});
</script>
</body>
</html>