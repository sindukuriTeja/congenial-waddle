<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Orange ID Login Demo</title>

  <!-- Optional: Include Tailwind CSS for styling -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Custom styles to supplement Tailwind or override */
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"; /* Tailwind default font */
      background-color: #f5f5f5; /* Light grey background */
      margin: 0;
      padding: 0;
      color: #333; /* Default text color */
      min-height: 100vh; /* Ensure body takes at least full viewport height */
      display: flex;
      flex-direction: column; /* Arrange content vertically */
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem; /* Responsive padding */
    }

    header {
        background-color: white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05); /* Subtle shadow */
        padding: 1rem 0; /* Add vertical padding */
    }

    main {
       flex-grow: 1; /* Allow main content area to grow and push footer down */
       display: flex;
       justify-content: center; /* Center content horizontally */
       align-items: center; /* Center content vertically */
       padding: 2rem 1rem; /* Add padding */
    }

    .login-area {
        text-align: center; /* Center the elements inside this area */
        width: 100%; /* Take full width */
        max-width: 500px; /* Limit max width */
    }

    #bedrock-login-widget {
      max-width: 400px; /* Keep the widget container max-width */
      margin: 20px auto; /* Center the widget and add vertical margin */
      background-color: white; /* Widget background */
      border-radius: 8px; /* Rounded corners */
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Shadow */
      padding: 1.5rem; /* Inner padding */
    }

    /* Basic styling for the user info message */
    #user-info-display {
        margin-top: 1rem;
        text-align: center;
        font-size: 1.1rem;
        color: #555;
    }

    footer {
        margin-top: auto; /* Push footer to the bottom */
        padding: 1rem 1rem; /* Adjust padding */
        text-align: center;
        color: #777;
        font-size: 0.9rem;
        background-color: white; /* Light background */
        box-shadow: 0 -1px 3px rgba(0,0,0,0.05); /* Subtle shadow */
    }
  </style>
</head>

<body>

  <header>
    <div class="container">
      <h1 class="text-2xl font-bold text-gray-800 text-center">Orange ID Login Demo</h1>
    </div>
  </header>

  <main>
    <div class="login-area">
        <h2 class="text-3xl font-extrabold mb-4 text-gray-800">Welcome Back!</h2>
        <p class="text-lg text-gray-600 mb-8">Sign in to access your account.</p>

        <!-- This div will contain the login widget or callback/user info -->
        <div id="bedrock-login-widget"></div>

        <!-- This div will show user info after login (text only) -->
        <div id="user-info-display">
           <!-- Content will be placed here by the script -->
        </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <p>Â© 2023 Your Company Name. All rights reserved. | Powered by Orange ID by Bedrock</p>
    </div>
  </footer>

  <!-- Required Dependencies -->
  <!-- These must be loaded AFTER the divs they will render into -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://public-cdn-files.pages.dev/bedrock-passport.umd.js"></script>

  <!-- Initialization and Callback Handling Script -->
  <script>
    (function () {
      // Ensure required libraries are loaded
      if (!window.React || !window.ReactDOM || !window.Bedrock) {
        console.error('Error: Required libraries failed to load.');
        const errorDiv = document.getElementById('bedrock-login-widget') || document.body;
        errorDiv.innerHTML = '<div style="color: red; text-align: center;">Error loading authentication widget. Please check your internet connection.</div>';
        return;
      }

      // Configuration - !!! REPLACE WITH YOUR NEW PROJECT DETAILS !!!
      const bedrockConfig = {
        baseUrl: 'https://api.bedrockpassport.com',
        // This should typically be window.location.origin for simple setups
        // Make sure this origin (e.g., https://your-new-website.com) is whitelisted in your NEW Bedrock project
        authCallbackUrl: window.location.origin,
        tenantId: 'YOUR_NEW_PROJECT_ID', // <<< REPLACE THIS WITH YOUR NEW PROJECT ID
        subscriptionKey: 'YOUR_NEW_API_KEY', // <<< REPLACE THIS WITH YOUR NEW API KEY
      };

      // Container for widget and main react rendering area
      const widgetContainer = document.getElementById('bedrock-login-widget');
      // Container for user info display (text only)
      const userInfoDisplay = document.getElementById('user-info-display');

      // Create a React root for the main display area (widget or user info/callback status)
      const root = ReactDOM.createRoot(widgetContainer);

      // Function to display user info and render a sign-out button
      function DisplayUserInfoAndSignOut() {
          // Use the hook to access user state and signOut function
          const { user, signOut, loading, error } = Bedrock.useBedrockPassport();
          // State for potential messages (optional, could use userInfoDisplay div)
          // const [message, setMessage] = React.useState('');

          React.useEffect(() => {
              // Update the separate user info div whenever user/loading state changes
              if (!loading) {
                  if (user) {
                      userInfoDisplay.innerHTML = `Logged in as: <span class="font-semibold">${user.displayName || user.name || user.email}</span>`;
                      // console.log('User object:', user); // Log the full user object
                  } else {
                      userInfoDisplay.innerHTML = 'Not logged in.';
                  }
              } else {
                 userInfoDisplay.innerHTML = 'Checking login status...'; // Message while loading user state
              }
              // Handle hook errors by updating the user info div
              if(error) {
                   userInfoDisplay.innerHTML = `<span style="color: red;">Error checking login status: ${error.message || error}</span>`;
              }
          }, [user, loading, error]); // Depend on hook state

          // This component itself only renders the Sign Out button if a user exists.
          // The user info text is handled by updating userInfoDisplay.innerHTML in the effect.
          if (loading || error || !user) {
              // If loading, error, or no user, render nothing *here* (the effect updates userInfoDisplay)
              // Or render a loading placeholder within the widget container if preferred
               if(loading) return React.createElement('div', { style: { textAlign: 'center', padding: '1rem' } }, 'Checking login status...');
               if(error) return React.createElement('div', { style: { color: 'red', textAlign: 'center', padding: '1rem' } }, 'Error loading user state.');
               return null; // Nothing to render in the widget container if no user and no loading/error
          }


          return React.createElement('div', { style: {textAlign: 'center', marginTop: '1rem'} },
              React.createElement(
                  'button',
                  {
                      // Using Tailwind classes + custom style for centering
                      className: 'px-6 py-2 bg-red-600 text-white font-semibold rounded-full shadow hover:bg-red-700 transition duration-300',
                      onClick: async () => {
                          await signOut();
                          // Clear user info display immediately
                          userInfoDisplay.innerHTML = 'Logging out...';
                          // Optional: Redirect or refresh after logout
                          setTimeout(() => {
                             window.location.href = window.location.origin; // Redirect to clear everything and show login panel
                          }, 500); // Small delay
                      }
                  },
                  'Sign Out'
              )
          );
      }


      // Check if we're handling a callback (tokens in the URL)
      const params = new URLSearchParams(window.location.search);
      const token = params.get('token');
      const refreshToken = params.get('refreshToken');

      if (token && refreshToken) {
        // We're handling a callback
        function AuthCallbackProcessor() {
          // Use the hook to access the loginCallback function
          const {loginCallback} = Bedrock.useBedrockPassport();
          const [message, setMessage] = React.useState(
            'Processing authentication...'
          );
           const [loginProcessed, setLoginProcessed] = React.useState(false);

          React.useEffect(() => {
             if (!loginProcessed) {
               setLoginProcessed(true); // Mark as processed to run only once
               async function processLogin() {
                 try {
                   setMessage('Verifying tokens...');
                   const success = await loginCallback(token, refreshToken);

                   if (success) {
                     setMessage('Login successful! Redirecting...');
                     // Remove token parameters from URL and refresh/redirect
                     window.history.replaceState(
                       {},
                       document.title,
                       window.location.pathname
                     );
                     // Reload the page to show the logged-in state / user info
                     setTimeout(() => {
                          window.location.reload();
                     }, 1000);
                   } else {
                     setMessage('Authentication failed. Please try again.');
                     // Redirect back to the login page after failure
                      setTimeout(() => {
                         window.history.replaceState({}, document.title, window.location.pathname); // Clean URL
                         window.location.reload(); // Reload to show login form again
                      }, 2000);
                   }
                 } catch (error) {
                   console.error('Login error:', error);
                   setMessage('An error occurred during login.');
                    // Redirect back to the login page on error
                    setTimeout(() => {
                       window.history.replaceState({}, document.title, window.location.pathname); // Clean URL
                       window.location.reload(); // Reload to show login form again
                    }, 2000);
                 }
               }
               processLogin();
             }
          }, [loginCallback, token, refreshToken, loginProcessed]); // Depend on hook and state

          // Render message during callback processing inside the widget container
          return React.createElement(
            'div',
            {style: {textAlign: 'center', padding: '1rem'}},
            message
          );
        }

        // Render callback processor into the widget container
        root.render(
          React.createElement(
            Bedrock.BedrockPassportProvider,
            bedrockConfig,
            React.createElement(AuthCallbackProcessor)
          )
        );

      } else {
          // Not handling a callback. Need to check if a user is already logged in.
          // Use a component that utilizes the Bedrock hook for this check.
          const CheckUserStateAndRender = () => {
              // Use the hook to access user state
              const { user, loading, error } = Bedrock.useBedrockPassport();

               React.useEffect(() => {
                   // Once loading is false, determine what to render
                   if (!loading) {
                       if (user) {
                            // User is logged in, render the user info and sign out button component
                            // This component will handle rendering the Sign Out button in the widgetContainer
                            root.render(
                                React.createElement(
                                    Bedrock.BedrockPassportProvider,
                                    bedrockConfig,
                                    React.createElement(DisplayUserInfoAndSignOut)
                                )
                            );
                       } else {
                            // No user logged in, render the login panel
                             root.render(
                                React.createElement(
                                    Bedrock.BedrockPassportProvider,
                                    bedrockConfig,
                                    React.createElement(Bedrock.LoginPanel, {
                                      // Content options
                                      title: "Sign in to",
                                      logo: "https://irp.cdn-website.com/e81c109a/dms3rep/multi/orange-web3-logo-v2a-20241018.svg",
                                      logoAlt: "Orange Web3",
                                      walletButtonText: "Connect Wallet",
                                      showConnectWallet: false, // Toggle this if needed
                                      separatorText: "OR",

                                      // Feature toggles - Enabled Email login as per your snippet
                                      features: {
                                        enableWalletConnect: false, // Toggle this
                                        enableAppleLogin: true, // Toggle this
                                        enableGoogleLogin: true, // Toggle this
                                        enableEmailLogin: true, // Toggle this
                                      },

                                      // Style options (Tailwind classes work well here)
                                      titleClass: "text-2xl font-bold text-gray-800 mb-4", // Added bottom margin
                                      logoClass: "ml-2 h-8",
                                      panelClass: "p-6 md:p-8 rounded-2xl",
                                      buttonClass: "w-full mb-3 py-3 border rounded-md font-semibold text-center transition duration-200 hover:border-orange-500 hover:text-orange-500",
                                      separatorTextClass: "bg-white text-gray-500 px-2",
                                      separatorClass: "bg-gray-300",
                                      linkRowClass: "justify-center mt-4",
                                      headerClass: "justify-center mb-6", // Adjusted bottom margin
                                    })
                                )
                            );
                       }
                   }
               }, [user, loading, error, bedrockConfig, root]); // Re-run if hook state, config or root changes

              // Initially show a message while the hook checks the user state
              if (loading) {
                 userInfoDisplay.innerHTML = 'Checking login status...'; // Update separate div
                 return React.createElement('div', { style: { textAlign: 'center', padding: '1rem' } }, 'Checking login status...'); // Placeholder in widget area
              }
              if (error) {
                 userInfoDisplay.innerHTML = `<span style="color: red;">Error checking login status: ${error.message || error}</span>`; // Update separate div
                 return React.createElement('div', { style: { color: 'red', textAlign: 'center', padding: '1rem' } }, 'Error loading user state.'); // Placeholder in widget area
              }

              // If not loading and no user yet, return null here - the useEffect will trigger renderLoginPanel
              return null;
          };

           // Initially render the component that checks user state and decides what to show
           root.render(
              React.createElement(
                  Bedrock.BedrockPassportProvider,
                  bedrockConfig,
                  // Pass the component that will decide rendering based on user state
                  React.createElement(CheckUserStateAndRender)
              )
           );
      }
    })();
  </script>
</body>
</html>