<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PestiVid - Agricultural Blockchain Platform (Web3 Demo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" rel="stylesheet">
  <!-- Google Fonts (Inter) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Orange ID Required Dependencies (React 18+, ReactDOM 18+) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Ensure Bedrock Passport is version compatible with React 18+ -->
  <script src="https://public-cdn-files.pages.dev/bedrock-passport.umd.js"></script>

  <!-- Vue.js -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
  <!-- Axios, Buffer, Solana Web3 -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/buffer@6.0.3/index.min.js"></script>
  <script>
    window.Buffer = window.buffer.Buffer; // Solana Buffer fix
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.73.0/lib/index.iife.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

  <style>
    body { font-family: 'Inter', system-ui, sans-serif; background: #f9fafb; }
    html { scroll-behavior: smooth; overflow-x: hidden; }
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 5px; }
    ::-webkit-scrollbar-thumb:hover { background: #aaa; }
    * { scrollbar-width: thin; scrollbar-color: #ccc #f1f1f1; -ms-overflow-style: -ms-autohiding-scrollbar; }
    .progress-bar { height: 8px; border-radius: 4px; background: #e5e7eb; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
    .modal-scrollable { max-height: 85vh; overflow-y: auto; }
    .project-updates-list { max-height: 150px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.375rem; padding: 0.75rem; background-color: #f9fafb; }
    .project-update-item { padding-bottom: 0.5rem; margin-bottom: 0.5rem; border-bottom: 1px solid #f3f4f6; }
    .project-update-item:last-child { border-bottom: none; margin-bottom: 0; }
    .weather-card { background-color: #fff; border-radius: 0.5rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
    .forecast-day { text-align: center; padding: 0.75rem; background-color: #f9fafb; border-radius: 0.375rem; border: 1px solid #e5e7eb; }
    .message-view-container { scroll-behavior: smooth; }
    .notification-badge { position: absolute; top: -5px; right: -8px; min-width: 18px; height: 18px; background-color: #ef4444; border-radius: 9px; color: white; font-size: 10px; font-weight: 600; line-height: 18px; text-align: center; padding: 0 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    .mobile-notification-badge { display: inline-block; background-color: #ef4444; color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 9px; line-height: 16px; text-align: center; vertical-align: top; margin-left: 4px; }
    .notification-toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column-reverse; gap: 10px; align-items: flex-end; }
    .notification-toast { min-width: 250px; max-width: 350px; background-color: #fff; color: #333; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); display: flex; align-items: center; opacity: 0; transform: translateX(100%); transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
    .notification-toast.show { opacity: 1; transform: translateX(0); }
    .notification-toast .icon { margin-right: 0.75rem; font-size: 1.25rem; }
    .notification-toast .icon-info { color: #3b82f6; } .notification-toast .icon-success { color: #10b981; } .notification-toast .icon-warning { color: #f59e0b; } .notification-toast .icon-error { color: #ef4444; }
    .notification-toast .message { font-size: 0.875rem; line-height: 1.3; }
    .notification-toast .close-btn { margin-left: auto; padding-left: 0.75rem; color: #9ca3af; cursor: pointer; background: none; border: none; font-size: 1rem; }
    .notification-toast .close-btn:hover { color: #6b7280; }
    .new-badge { position: absolute; top: -8px; right: -8px; background-color: #3b82f6; color: white; font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .loading-modal { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 9999; }
    .loading-content { background-color: white; padding: 2rem; border-radius: 0.5rem; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    .loading-content .fa-spinner { font-size: 2rem; color: #10b981; margin-bottom: 1rem; }
    .login-page-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: calc(100vh - 160px); padding: 2rem 1rem; box-sizing: border-box; }
    .login-branding { display: flex; align-items: center; margin-bottom: 1.5rem; }
    .login-branding .logo-icon { font-size: 2.5rem; color: #15803d; margin-right: 0.75rem; }
    .login-branding .app-name { font-size: 2rem; font-weight: 600; color: #15803d; }
    .login-panel-wrapper { background-color: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); width: 100%; max-width: 450px; text-align: center; }
    .login-panel-wrapper h2 { font-size: 1.5rem; font-weight: 700; color: #166534; /* green-800 */ margin-bottom: 0.5rem; }
    .login-panel-wrapper .tagline { color: #4b5563; /* gray-600 */ margin-bottom: 1.5rem; font-size: 0.9rem; }

    /* Orange ID specific styles */
    #orange-id-login-container { margin: 0 auto; }
    #orange-id-signout-button-container, #orange-id-signout-button-container-mobile {
        display: inline-flex;
        align-items: center;
    }
    #orange-id-signout-button-container button, #orange-id-signout-button-container-mobile button {
        background-color: transparent !important;
        color: #9CA3AF !important; /* gray-400 */
        padding: 0.25rem 0.5rem !important;
        border: none !important;
        font-size: 1rem !important;
    }
    #orange-id-signout-button-container button:hover, #orange-id-signout-button-container-mobile button:hover {
        color: #EF4444 !important; /* red-500 */
    }
    /* Fix for horizontal overflow on tables */
    .overflow-x-auto table {
        width: 100%;
        min-width: 600px; /* Adjust as needed */
    }
  </style>
</head>
<body class="text-gray-900">
<div id="app" class="flex flex-col min-h-screen">
  <!-- Header/Navbar -->
  <header class="bg-white shadow sticky top-0 z-30">
    <div class="max-w-7xl mx-auto px-5 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <span class="text-2xl text-green-700 font-semibold"><i class="fas fa-seedling mr-1"></i>PestiVid</span>
      </div>
      <nav class="hidden md:flex space-x-5 items-center">
        <a href="#" @click.prevent="switchPage('landing')" :class="{'font-bold text-green-700': current==='landing'}" class="hover:text-green-600">Home</a>

        <!-- Show Login/Signup only if not authenticated and not processing auth -->
        <a v-if="!isUserAuthenticated && !isAuthProcessing && !isOrangeIdCallback" href="#" @click.prevent="switchPage('loginChoice')" class="hover:text-green-600">Login / Sign Up</a>
        <span v-if="(isAuthProcessing || isOrangeIdCallback) && !isUserAuthenticated" class="text-gray-500 text-sm">Authenticating...</span>

        <a v-if="isUserAuthenticated" href="#" @click.prevent="switchPage('messaging')" :class="{'font-bold text-green-700': current==='messaging'}" class="hover:text-green-600 relative">
          <i class="fas fa-comments mr-1"></i>Messages
          <span v-if="unreadMessageCount > 0" class="notification-badge">{{ unreadMessageCount }}</span>
        </a>
        <!-- Farmer Menu -->
        <template v-if="isUserAuthenticated && role==='farmer'">
          <a href="#" @click.prevent="switchPage('farmerPestiVid')" :class="{'font-bold text-green-700': current==='farmerPestiVid'}" class="hover:text-green-600">PestiVid</a>
          <a href="#" @click.prevent="switchPage('farmerAgriStream')" :class="{'font-bold text-green-700': current==='farmerAgriStream'}" class="hover:text-green-600">AgriStream</a>
          <a href="#" @click.prevent="switchPage('farmerSell')" :class="{'font-bold text-green-700': current==='farmerSell'}" class="hover:text-green-600">Sell</a>
          <a href="#" @click.prevent="switchPage('farmerFunding')" :class="{'font-bold text-green-700': current==='farmerFunding'}" class="hover:text-green-600">Get Funding</a>
          <a v-if="isUserAuthenticated && role==='farmer'" href="#" @click.prevent="switchPage('plantRecomendation')" :class="{'font-bold text-green-700': current==='plantRecomendation'}" class="hover:text-green-600">PlantRecommend</a>
        </template>
        <!-- Buyer Menu -->
        <template v-if="isUserAuthenticated && role==='buyer'">
          <a href="#" @click.prevent="switchPage('buyerAgriSell')" :class="{'font-bold text-green-700': current==='buyerAgriSell'}" class="hover:text-green-600">AgriSell</a>
        </template>
        <!-- Investor Menu -->
        <template v-if="isUserAuthenticated && role==='investor'">
          <a href="#" @click.prevent="switchPage('investorProjects')" :class="{'font-bold text-green-700': current==='investorProjects'}" class="hover:text-green-600">Projects</a>
          <a href="#" @click.prevent="switchPage('investorPortfolio')" :class="{'font-bold text-green-700': current==='investorPortfolio'}" class="hover:text-green-600">Portfolio</a>
        </template>
        <template v-if="isUserAuthenticated">
          <a href="#" @click.prevent="switchPage('userProfile')" :class="{'font-bold text-green-700': current==='userProfile'}" class="bg-green-600 text-white text-xs rounded-full px-3 py-1 select-none ml-2 hover:bg-green-700 flex items-center">
             <i class="fas fa-user-circle mr-1"></i> {{ userName ? userName.split(' ')[0] : displayedUserIdentifier }}
          </a>
           <div v-if="loginMethod === 'orangeId'" id="orange-id-signout-button-container" class="ml-2"></div>
           <a v-if="loginMethod === 'solana'" href="#" title="Disconnect Wallet" @click.prevent="logoutUser" class="text-gray-400 hover:text-red-500 ml-2"><i class="fas fa-sign-out-alt text-lg"></i></a>
        </template>
      </nav>
      <button class="md:hidden text-gray-500 focus:outline-none" @click="showMobileMenu = !showMobileMenu">
        <i class="fas fa-bars text-2xl"></i>
      </button>
    </div>
    <!-- Mobile Dropdown -->
    <div v-show="showMobileMenu" class="md:hidden bg-white border-t z-40">
      <div class="py-2 flex flex-col space-y-1 px-4">
        <a href="#" @click.prevent="switchPage('landing');showMobileMenu=false" :class="{'font-bold text-green-700': current==='landing'}">Home</a>
        <a v-if="!isUserAuthenticated && !isAuthProcessing && !isOrangeIdCallback" href="#" @click.prevent="switchPage('loginChoice');showMobileMenu=false" >Login / Sign Up</a>
        <span v-if="(isAuthProcessing || isOrangeIdCallback) && !isUserAuthenticated" class="text-gray-500 text-sm px-1 py-1">Authenticating...</span>

        <a v-if="isUserAuthenticated" href="#" @click.prevent="switchPage('messaging');showMobileMenu=false" :class="{'font-bold text-green-700': current==='messaging'}" class="flex items-center">
          <i class="fas fa-comments mr-1"></i>Messages
          <span v-if="unreadMessageCount > 0" class="mobile-notification-badge">{{ unreadMessageCount }}</span>
        </a>
        <template v-if="isUserAuthenticated && role==='farmer'">
          <a href="#" @click.prevent="switchPage('farmerPestiVid');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerPestiVid'}">PestiVid</a>
          <a href="#" @click.prevent="switchPage('farmerAgriStream');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerAgriStream'}">AgriStream</a>
          <a href="#" @click.prevent="switchPage('farmerSell');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerSell'}">Sell</a>
          <a href="#" @click.prevent="switchPage('farmerFunding');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerFunding'}">Get Funding</a>
          <a v-if="isUserAuthenticated && role==='farmer'" href="#" @click.prevent="switchPage('plantRecomendation');showMobileMenu=false" :class="{'font-bold text-green-700': current==='plantRecomendation'}">PlantRecommend</a>
        </template>
        <template v-if="isUserAuthenticated && role==='buyer'">
          <a href="#" @click.prevent="switchPage('buyerAgriSell');showMobileMenu=false" :class="{'font-bold text-green-700': current==='buyerAgriSell'}">AgriSell</a>
        </template>
        <template v-if="isUserAuthenticated && role==='investor'">
          <a href="#" @click.prevent="switchPage('investorProjects');showMobileMenu=false" :class="{'font-bold text-green-700': current==='investorProjects'}">Projects</a>
          <a href="#" @click.prevent="switchPage('investorPortfolio');showMobileMenu=false" :class="{'font-bold text-green-700': current==='investorPortfolio'}">Portfolio</a>
        </template>
        <template v-if="isUserAuthenticated">
           <div class="border-t mt-2 pt-2 flex justify-between items-center">
             <a href="#" @click.prevent="switchPage('userProfile');showMobileMenu=false" :class="{'font-bold text-green-700': current==='userProfile'}" class="inline-block bg-green-600 text-white text-xs rounded px-2 py-1 ml-1 flex items-center">
                <i class="fas fa-user-circle mr-1"></i> {{ userName ? userName.split(' ')[0] : displayedUserIdentifier }}
             </a>
             <div v-if="loginMethod === 'orangeId'" id="orange-id-signout-button-container-mobile"></div>
             <a v-if="loginMethod === 'solana'" href="#" class="text-gray-400 hover:text-red-500" title="Disconnect Wallet" @click.prevent="logoutUser();showMobileMenu=false"><i class="fas fa-sign-out-alt"></i></a>
           </div>
        </template>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <!-- Only render content section if not in Orange ID callback processing -->
  <main class="flex-1 max-w-7xl mx-auto w-full px-4 pt-8 pb-8" v-if="!isOrangeIdCallback">
    <!-- Landing Section -->
    <section v-if="current==='landing'">
        <div class="flex flex-col md:flex-row items-center mb-12 pt-2">
            <div class="md:w-1/2 md:pr-8">
            <h1 class="text-4xl font-bold text-green-800 mb-4">PestiVid: Blockchain Transparency in Agriculture</h1>
            <p class="mb-5 text-gray-800 text-lg leading-relaxed">A secure, video-verified agricultural marketplace with investment opportunities. Farmers prove quality and safety via field recordings stored on blockchain (Solana Simulated) and IPFS. Buyers purchase crops with complete confidence and traceability. Investors fund projects with transparent returns.</p>
            <ul class="text-gray-700 mb-7 space-y-1 text-base">
                <li><i class="fas fa-link text-green-500 mr-2"></i>Solana blockchain-simulated transactions</li>
                <li><i class="fas fa-cloud-upload-alt text-green-400 mr-2"></i>Decentralized video storage (IPFS/Pinata)</li>
                <li><i class="fas fa-search-dollar text-green-400 mr-2"></i>Full traceability for buyers</li>
                <li><i class="fas fa-handshake text-green-500 mr-2"></i>Direct, transparent marketplace transactions</li>
                <li><i class="fas fa-chart-line text-green-500 mr-2"></i>Investment opportunities for funders</li>
                <li><i class="fas fa-comments text-green-500 mr-2"></i>Secure messaging between users</li>
                <li><i class="fas fa-bell text-green-500 mr-2"></i>Real-time notifications</li>
            </ul>
            <div class="mt-4 space-x-2">
                <!-- Adjusted Get Started logic -->
                <button class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded transition" @click="getStarted">Get Started</button>
                 <!-- Adjusted Browse Marketplace logic - redirects based on auth state -->
                <button class="bg-white border border-green-600 text-green-600 px-6 py-2 rounded transition" @click="getStarted">Browse Marketplace</button>
            </div>
            </div>
            <div class="md:w-1/2 mt-10 md:mt-0 flex flex-col items-center">
            <video controls playsinline webkit-playsinline class="rounded-lg shadow-md border w-full max-w-md mx-auto">
                <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
                Demo video: your browser does not support video.
            </video>
            </div>
        </div>
        <div class="mt-10">
            <h2 class="text-2xl text-green-700 font-semibold mb-3">How It Works</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-5">
            <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
                <i class="fas fa-video text-2xl text-green-500 mb-3"></i>
                <span class="font-bold mb-1">1. Video Recording</span>
                <p class="text-sm text-gray-600 text-center">Farmers film direct evidence of their crop and practices.</p>
            </div>
            <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
                <i class="fas fa-cloud-upload-alt text-2xl text-green-500 mb-3"></i>
                <span class="font-bold mb-1">2. Upload to IPFS</span>
                <p class="text-sm text-gray-600 text-center">Videos & info are securely uploaded and stored decentrally.</p>
            </div>
            <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
                <i class="fas fa-search-dollar text-2xl text-green-500 mb-3"></i>
                <span class="font-bold mb-1">3. Verification</span>
                <p class="text-sm text-gray-600 text-center">Buyers view blockchain-verified video before any purchase.</p>
            </div>
            <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
                <i class="fas fa-handshake text-2xl text-green-500 mb-3"></i>
                <span class="font-bold mb-1">4. Marketplace</span>
                <p class="text-sm text-gray-600 text-center">Login to buy, sell, or invest, all backed by video trust.</p>
            </div>
            </div>
        </div>

        <div class="mt-16 bg-green-50 rounded-lg p-8">
            <h2 class="text-2xl text-green-700 font-semibold mb-3">Agricultural Investment Platform</h2>
            <div class="flex flex-col md:flex-row items-center">
            <div class="w-full">
                <p class="mb-4 text-gray-700">Invest in verified agricultural projects with full transparency. Track your investments through simulated Solana blockchain technology and share in the harvest profits.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 my-6">
                <div class="bg-white rounded p-4 shadow-sm">
                    <i class="fas fa-seedling text-green-600 text-2xl mb-2"></i>
                    <h3 class="font-bold mb-1">Fund Crops</h3>
                    <p class="text-sm">Invest in specific crops with transparent land use and practices.</p>
                </div>
                <div class="bg-white rounded p-4 shadow-sm">
                    <i class="fas fa-coins text-green-600 text-2xl mb-2"></i>
                    <h3 class="font-bold mb-1">Share Returns</h3>
                    <p class="text-sm">Receive dividends based on harvest yields and market prices.</p>
                </div>
                <div class="bg-white rounded p-4 shadow-sm">
                    <i class="fas fa-shield-alt text-green-600 text-2xl mb-2"></i>
                    <h3 class="font-bold mb-1">Secure Blockchain</h3>
                    <p class="text-sm">All investments and harvests recorded on immutable ledger (Simulated).</p>
                </div>
                </div>
                 <!-- Adjusted Become an Investor logic - redirects based on auth state -->
                <button class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded transition mt-2" @click="getStarted">Become an Investor</button>
            </div>
            </div>
        </div>
    </section>

    <!-- Login Choice Page -->
    <section v-if="current==='loginChoice'" class="login-page-container">
        <div class="login-panel-wrapper">
            <div class="login-branding justify-center ">
                <i class="fas fa-seedling logo-icon"></i>
                <span class="app-name">PestiVid</span>
            </div>
            <h2 class="text-xl font-bold text-green-800 mb-2">Login or Sign Up</h2>
            <p class="text-gray-600 mb-6 text-sm">Choose your preferred method to access PestiVid.</p>

            <!-- Orange ID Social Login Block -->
            <div class="mb-4">
                <p class="text-xs text-gray-500 mb-2 text-left ml-1">Sign in with Orange ID:</p>
                <div id="orange-id-login-container" class="flex justify-center">
                    <p v-if="!orangeIdWidgetMounted && !orangeIdBedrockSDKError" class="text-gray-500 p-4 text-sm">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Loading Social Logins...
                    </p>
                    <p v-if="orangeIdBedrockSDKError" class="text-red-500 p-4 text-sm">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Social login service could not load. Check API Keys.
                    </p>
                    <!-- Orange ID LoginPanel will be rendered here by renderOrangeIdLoginWidget() -->
                </div>
                 <p class="text-xs text-gray-500 mt-2 text-center">Powered by <a href="https://orangeid.xyz" target="_blank" class="underline hover:text-orange-500">Orange ID</a></p>
            </div>

            <div class="relative my-6">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-white text-gray-500">OR</span>
                </div>
            </div>

            <div class="mb-4">
                 <p class="text-xs text-gray-500 mb-2 text-left ml-1">Connect with your Solana wallet:</p>
                <button @click="connectWallet"
                        class="w-full flex items-center justify-center px-4 py-2.5 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                    <i class="fas fa-wallet mr-2"></i> Connect Solana Wallet
                </button>
            </div>
        </div>
    </section>

     <!-- Orange ID Callback Processing View - Show only during callback -->
    <section v-if="isOrangeIdCallback" class="login-page-container">
        <div class="login-panel-wrapper">
            <div class="login-branding justify-center">
                <i class="fas fa-seedling logo-icon"></i>
                <span class="app-name">PestiVid</span>
            </div>
            <div id="orange-id-callback-processor" class="text-center p-4">
                <!-- Orange ID Callback Processor will be rendered here by React -->
                <p class="text-gray-600"><i class="fas fa-spinner fa-spin mr-2"></i>Processing authentication...</p>
            </div>
        </div>
    </section>


    <!-- Role Selection (after any login if new PestiVid user) -->
    <section v-if="current==='roleSelection'" class="max-w-lg mx-auto bg-white shadow rounded-lg p-8 mt-8">
        <h2 class="text-2xl font-bold text-green-700 mb-4">Welcome to PestiVid!</h2>
        <p class="text-gray-600 mb-1">
            <span v-if="loginMethod === 'orangeId'">Logged in as <strong class="font-mono text-sm">{{ orangeIdUser ? (orangeIdUser.name || orangeIdUser.email || displayedUserIdentifier) : displayedUserIdentifier }}</strong> via Orange ID.</span>
            <span v-if="loginMethod === 'solana'">Your wallet <strong class="font-mono text-sm">{{ displayedUserIdentifier }}</strong> is connected.</span>
        </p>
        <p class="text-gray-600 mb-5">Please complete your PestiVid profile and select your primary role:</p>
        <div class="mb-4">
            <label class="block text-gray-600 mb-1">Full Name (for PestiVid)</label>
            <input v-model="userNameOnboarding" type="text" class="w-full px-3 py-2 border rounded" placeholder="e.g., John Doe" required>
        </div>
        <div class="mb-4">
            <label class="block text-gray-600 mb-1">Email Address (for PestiVid)</label>
            <input v-model="userEmailOnboarding" type="email" class="w-full px-3 py-2 border rounded" placeholder="e.g., john.doe@example.com" required>
        </div>
        <div class="mb-4">
            <label class="block text-gray-600 mb-1">Phone Number (Optional)</label>
            <input v-model="userPhoneOnboarding" type="tel" class="w-full px-3 py-2 border rounded" placeholder="e.g., +1-555-123-4567">
        </div>
        <div class="mb-6">
          <label class="block text-gray-600 mb-1">Primary Role in PestiVid</label>
          <select v-model="selectedRoleOnboarding" class="w-full px-3 py-2 border rounded bg-white" required>
            <option value="" disabled>Select Role</option>
            <option value="farmer">Farmer</option>
            <option value="buyer">Buyer</option>
            <option value="investor">Investor</option>
          </select>
        </div>
         <div class="mb-4" v-if="selectedRoleOnboarding === 'farmer'">
            <label class="block text-gray-600 mb-1">Farm/City Name (for Weather)</label>
            <input v-model="farmerLocationCityOnboarding" type="text" class="w-full px-3 py-2 border rounded" placeholder="e.g., Davis, California">
         </div>
        <button @click="completeOnboarding" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded" :disabled="!selectedRoleOnboarding || !userNameOnboarding || !userEmailOnboarding">Confirm Profile & Role</button>
    </section>

    <section v-if="current==='farmerPestiVid'" class="max-w-3xl mx-auto mt-6">
      <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-video mr-2"></i>PestiVid: Record Crop Video</h2>
      <div v-if="!isUserAuthenticated || role !== 'farmer'" class="text-center p-10 bg-white rounded-lg shadow"> <i class="fas fa-exclamation-circle text-3xl text-yellow-500 mb-4"></i> <p class="text-xl text-gray-700">Please log in as a Farmer to access PestiVid video recording.</p> </div>
      <div v-else class="bg-white rounded shadow-md p-6 space-y-6">
        <form @submit.prevent>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
            <div> <label class="block text-gray-600 mb-1 text-sm">Crop Type</label> <input v-model="recordForm.crop" class="w-full px-2 py-2 border rounded text-sm" required placeholder="e.g., Tomatoes"> </div>
            <div> <label class="block text-gray-600 mb-1 text-sm">Field Location</label> <input v-model="recordForm.location" class="w-full px-2 py-2 border rounded text-sm" required placeholder="e.g., South Field"> </div>
            <div> <label class="block text-gray-600 mb-1 text-sm">Pesticide Used</label> <input v-model="recordForm.pesticide" class="w-full px-2 py-2 border rounded text-sm" required placeholder="e.g., Neem Oil"> </div>
            <div> <label class="block text-gray-600 mb-1 text-sm">Pesticide Company</label> <input v-model="recordForm.pesticideCompany" class="w-full px-2 py-2 border rounded text-sm" required placeholder="e.g., AgriChem"> </div>
          </div>
          <div class="mb-4">
            <label class="block text-gray-600 mb-1 text-sm">Purpose of this Video:</label>
            <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-2 sm:space-y-0">
                <label class="flex items-center"> <input type="radio" v-model="recordForm.purpose" value="agristream" class="form-radio text-green-600"> <span class="ml-2 text-sm text-gray-700">For AgriStream (General)</span> </label>
                <label class="flex items-center"> <input type="radio" v-model="recordForm.purpose" value="sell" class="form-radio text-green-600"> <span class="ml-2 text-sm text-gray-700">To List for Sale</span> </label>
                <label class="flex items-center"> <input type="radio" v-model="recordForm.purpose" value="funding" class="form-radio text-green-600"> <span class="ml-2 text-sm text-gray-700">For Funding Request</span> </label>
            </div>
          </div>
        </form>
        <div>
          <div class="aspect-w-16 aspect-h-9 bg-black rounded mb-3 relative" style="min-height:200px">
            <video ref="liveVideo" v-show="showLive" class="w-full h-full rounded absolute inset-0 object-cover" autoplay muted playsinline webkit-playsinline style="background:#111"></video>
            <video v-if="recordBlobUrl" :src="recordBlobUrl" controls playsinline webkit-playsinline class="w-full h-full rounded absolute inset-0 object-cover" style="background:#181818"></video>
            <div v-if="!showLive && !recordBlobUrl" class="absolute inset-0 flex justify-center items-center h-full text-gray-400"><i class="fas fa-video-slash fa-2x"></i></div>
          </div>
          <div class="flex flex-wrap gap-3 mb-2 items-center">
            <button type="button" :disabled="recording || !isUserAuthenticated || role !== 'farmer'" @click="startVideo" :class="{'opacity-50 cursor-not-allowed': recording || !isUserAuthenticated || role !== 'farmer'}" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">
              <i :class="recording ? 'fas fa-spinner fa-spin' : (recordBlobUrl ? 'fas fa-redo' : 'fas fa-record-vinyl')" class="mr-1"></i>
              {{ recordBlobUrl ? 'Re-Record' : (recording ? 'Starting...' : 'Start Recording') }}
            </button>
            <button v-if="recording" type="button" @click="stopVideo" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-sm"> <i class="fas fa-stop mr-1"></i>Stop </button>
            <button v-if="recordBlobUrl && !uploading" type="button" @click="uploadVideo" :disabled="!isUserAuthenticated || role !== 'farmer'" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm"> <i class="fas fa-upload mr-1"></i>Upload to IPFS </button>
            <div v-if="uploading" class="flex items-center text-blue-600 text-sm ml-3"> <i class="fas fa-spinner fa-spin mr-2"></i> Uploading... Please wait. </div>
          </div>
          <p class="text-xs mt-2 text-gray-500">Allow camera access. Video file is stored locally until upload.</p>
          <div v-if="!isUserAuthenticated" class="text-red-500 mt-3 bg-red-50 p-2 rounded border border-red-200 text-sm"> <i class="fas fa-exclamation-triangle mr-1"></i> Please log in to record and upload videos. </div>
          <div v-if="uploadCid" class="text-green-600 mt-3 bg-green-50 p-3 rounded border border-green-200 text-sm">
              <div class="flex items-center mb-2"> <i class="fas fa-check-circle mr-2"></i> Uploaded to IPFS! CID: <span class="font-mono bg-green-100 px-1 py-0.5 rounded break-all ml-1">{{ uploadCid }}</span> </div>
              <p v-if="lastUploadedVideoPurpose === 'agristream'" class="mt-1 text-gray-700"> This video is now available in your AgriStream. <a href="#" @click.prevent="navigateToPageWithParam('farmerAgriStream', 'highlightCid', uploadCid)" class="text-blue-700 underline font-medium hover:text-blue-800 ml-1">View in AgriStream</a>. <br>You can also use it later to: <a href="#" @click.prevent="goToListing(uploadCid)" class="text-green-700 underline font-medium hover:text-green-800">Create a Listing</a>, or <a href="#" @click.prevent="navigateToPageWithParam('farmerFunding', 'cid', uploadCid)" class="text-purple-700 underline font-medium hover:text-purple-800 ml-1">Use for Funding Request</a>. </p>
              <p v-if="lastUploadedVideoPurpose === 'sell'" class="mt-1 text-gray-700"> Video uploaded for selling! You should be redirected to create a listing. If not, <a href="#" @click.prevent="navigateToPageWithParam('farmerSell', 'cid', uploadCid)" class="text-green-700 underline font-medium hover:text-green-800">click here to complete the listing</a>. </p>
              <p v-if="lastUploadedVideoPurpose === 'funding'" class="mt-1 text-gray-700"> Video uploaded for a funding request! You should be redirected to create the request. If not, <a href="#" @click.prevent="navigateToPageWithParam('farmerFunding', 'cid', uploadCid)" class="text-purple-700 underline font-medium hover:text-purple-800">click here to complete the funding request</a>. </p>
          </div>
          <div v-if="uploadError" class="text-red-600 mt-3 bg-red-50 p-2 rounded border border-red-200 text-sm"> <i class="fas fa-exclamation-triangle mr-1"></i> {{ uploadError }} </div>
        </div>
      </div>
    </section>
    <section v-if="current==='farmerAgriStream'" class="max-w-4xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-5"><i class="fas fa-stream mr-2"></i>AgriStream: My Crop Videos</h2>
         <div v-if="!isUserAuthenticated || role !== 'farmer'" class="text-center p-10 bg-white rounded-lg shadow"> <i class="fas fa-exclamation-circle text-3xl text-yellow-500 mb-4"></i> <p class="text-xl text-gray-700">Please log in as a Farmer to access AgriStream.</p> </div>
         <div v-else class="bg-white rounded shadow-md p-6">
            <div v-if="farmerVideos.length===0" class="text-gray-600 text-center p-6 bg-gray-50 rounded"> <i class="fas fa-film text-4xl text-gray-400 mb-3"></i><br> No uploads yet. Go to <a href="#" class="text-green-700 underline" @click.prevent="switchPage('farmerPestiVid')">PestiVid</a> to upload. </div>
            <div v-else class="space-y-6">
            <div v-for="vid in farmerVideos" :key="vid.cid" class="flex flex-col md:flex-row items-start border-b last:border-b-0 pb-6 gap-6 transition-all duration-500" :ref="'videoCard-' + vid.cid" :class="{'bg-yellow-50 border-l-4 border-yellow-400 shadow-lg transform scale-102': vid.cid === highlightedAgriStreamVideoCid}">
                <div class="w-full md:w-60 flex-shrink-0"> <video :src="ipfsUrl(vid.cid)" controls playsinline webkit-playsinline class="rounded shadow w-full bg-black"></video> </div>
                <div class="flex-1">
                <div class="font-bold text-lg">{{ vid.crop }}</div>
                <div class="text-xs mb-1" :class="{ 'text-blue-700': vid.purpose === 'sell', 'text-purple-700': vid.purpose === 'funding', 'text-gray-600': vid.purpose === 'agristream' || !vid.purpose }"> Intended for: <span class="font-semibold"> {{ vid.purpose === 'sell' ? 'Listing for Sale' : (vid.purpose === 'funding' ? 'Funding Request' : (vid.purpose === 'agristream' ? 'AgriStream (General)' : 'N/A')) }} </span> </div>
                <div class="text-sm mb-1">Location: <span class="font-mono text-gray-700">{{ vid.location }}</span></div>
                <div class="text-sm mb-1">Pesticide: <span class="font-mono text-gray-700">{{ vid.pesticide }}</span></div>
                <div class="text-sm mb-1">Pesticide Co.: <span class="font-mono text-gray-700">{{ vid.pesticideCompany || 'N/A' }}</span></div>
                <div class="text-xs text-gray-500 mb-2">CID: <span class="font-mono break-all">{{ vid.cid }}</span></div>
                <a :href="ipfsUrl(vid.cid)" target="_blank" class="text-blue-600 hover:underline text-xs mr-3"><i class="fas fa-external-link-alt mr-1"></i>View on Gateway</a>
                <button v-if="!isListed(vid.cid)" @click="goToListing(vid.cid)" class="text-green-600 hover:underline text-xs"> <i class="fas fa-tags mr-1"></i> {{ (vid.purpose === 'sell' && !isListed(vid.cid)) ? 'Complete Listing' : 'Create Listing' }} </button>
                <span v-else class="text-gray-500 text-xs"><i class="fas fa-check mr-1"></i>Already Listed</span>
                <button v-if="!isUsedInFunding(vid.cid) && (vid.purpose === 'funding' || vid.purpose === 'agristream')" @click="navigateToPageWithParam('farmerFunding', 'cid', vid.cid)" class="text-purple-600 hover:underline text-xs ml-2"> <i class="fas fa-hand-holding-usd mr-1"></i> {{ (vid.purpose === 'funding' && !isUsedInFunding(vid.cid)) ? 'Complete Funding Request' : 'Use for Funding' }} </button>
                <span v-if="isUsedInFunding(vid.cid)" class="text-gray-500 text-xs ml-2"><i class="fas fa-check mr-1"></i>Used for Funding</span>
                </div>
            </div>
            </div>
        </div>
    </section>
    <section v-if="current==='farmerSell'" class="max-w-2xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-tags mr-2"></i>Sell Farm Crop on Marketplace</h2>
        <div v-if="!isUserAuthenticated || role !== 'farmer'" class="text-center p-10 bg-white rounded-lg shadow"> <i class="fas fa-exclamation-circle text-3xl text-yellow-500 mb-4"></i> <p class="text-xl text-gray-700">Please log in as a Farmer to sell crops.</p> </div>
        <div v-else class="bg-white rounded shadow-md p-6">
            <form @submit.prevent="createListing">
              <div class="mb-4">
                <label class="block text-gray-600 mb-1">Select Uploaded Video (Unlisted only)</label>
                <select v-model="listingForm.cid" class="w-full px-3 py-2 border rounded bg-white mb-2" required>
                  <option value="" disabled>Select video...</option>
                  <option v-for="vid in availableVideosForListing" :key="vid.cid" :value="vid.cid"> {{ vid.crop }} ({{ vid.location }}) - Pest: {{ vid.pesticide }} by {{ vid.pesticideCompany || 'N/A' }} </option>
                  <option v-if="farmerVideos.length > 0 && availableVideosForListing.length === 0" disabled>No unlisted 'For Sale' or 'General' videos available</option>
                   <option v-if="farmerVideos.length === 0" disabled>No videos uploaded yet</option>
                </select>
                <p v-if="farmerVideos.length === 0" class="text-xs text-red-500">You need to upload a video first via PestiVid.</p>
                <p v-if="farmerVideos.length > 0 && availableVideosForListing.length === 0" class="text-xs text-yellow-600">All your 'For Sale' or 'General' videos are already associated with listings.</p>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">
                <div> <label class="block text-gray-600 mb-1">Min Price (SOL)</label> <input type="number" v-model="listingForm.minPrice" class="w-full px-3 py-2 border rounded" min="0.01" step="0.01" required placeholder="e.g., 0.5"> </div>
                <div> <label class="block text-gray-600 mb-1">Max Price (SOL)</label> <input type="number" v-model="listingForm.maxPrice" class="w-full px-3 py-2 border rounded" :min="listingForm.minPrice || 0.01" step="0.01" required placeholder="e.g., 1.5"> </div>
              </div>
              <div class="mb-4"> <label class="flex items-center"> <input type="checkbox" v-model="listingForm.notifyBuyers" class="form-checkbox h-4 w-4 text-green-600"> <span class="ml-2 text-sm text-gray-700">Notify potential buyers about this listing</span> </label> </div>
              <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded w-full" :disabled="!listingForm.cid || !isUserAuthenticated || role !== 'farmer'"> <i class="fas fa-plus-circle mr-1"></i>Create Listing </button>
            </form>
            <div v-if="createdListingId" class="bg-green-100 text-green-700 px-4 py-3 mt-4 rounded font-medium text-sm"> <i class="fas fa-check mr-1"></i> Listing created successfully! Tx: <span class="font-mono text-xs">{{ createdListingId.substring(0,10) }}...</span> <div v-if="listingNotificationSent" class="mt-1 text-sm"> <i class="fas fa-bell mr-1"></i> Buyers have been notified about your new listing. </div> </div>
            <div class="mt-8">
              <h3 class="font-semibold mb-2 text-gray-700">Your Active Listings</h3>
              <div v-if="farmerListings.length===0" class="text-gray-600 text-sm bg-gray-50 p-4 rounded text-center">You have no active listings.</div>
              <ul v-else class="space-y-3">
                <li v-for="l in farmerListings" :key="l.id" class="py-3 px-4 border rounded flex flex-col sm:flex-row justify-between sm:items-center text-sm bg-white shadow-sm">
                  <div> <span class="font-medium">{{ l.crop }}</span> <span class="text-xs text-gray-500 ml-1"> ({{l.location}})</span> <br> <span class="text-xs text-gray-500"> CID: {{l.cid.substring(0, 8)}}...</span> | <span class="text-xs text-gray-500"> Pest. Co: {{ l.pesticideCompany || 'N/A' }}</span> <div v-if="l.notificationSent" class="text-xs text-green-600 mt-1"> <i class="fas fa-bell mr-1"></i> Buyers notified </div> </div>
                  <div class="mt-2 sm:mt-0 text-right"> <span>Min: <span class="font-mono font-semibold">{{ l.minPrice }}</span> SOL</span><br> <span>Max: <span class="font-mono font-semibold">{{ l.maxPrice }}</span> SOL</span> <button v-if="!l.notificationSent" @click="notifyBuyersAboutListing(l, true)" class="ml-2 text-xs text-blue-600 border border-blue-300 rounded px-2 py-1 hover:bg-blue-50"> <i class="fas fa-bell mr-1"></i> Notify </button> </div>
                </li>
              </ul>
            </div>
        </div>
    </section>
    <section v-if="current==='farmerFunding'" class="max-w-3xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-money-bill-wave mr-2"></i>Request Funding for Your Farm</h2>
         <div v-if="!isUserAuthenticated || role !== 'farmer'" class="text-center p-10 bg-white rounded-lg shadow"> <i class="fas fa-exclamation-circle text-3xl text-yellow-500 mb-4"></i> <p class="text-xl text-gray-700">Please log in as a Farmer to request funding.</p> </div>
        <div v-else class="bg-white rounded shadow-md p-6">
            <form @submit.prevent="createFundingRequest_V1">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div> <label class="block text-gray-600 mb-1 text-sm">Project Title</label> <input v-model="fundingForm.title" class="w-full px-3 py-2 border rounded text-sm" required placeholder="e.g., Organic Tomato Expansion"> </div>
                <div> <label class="block text-gray-600 mb-1 text-sm">Crop Type</label> <input v-model="fundingForm.crop" class="w-full px-3 py-2 border rounded text-sm" required placeholder="e.g., Roma Tomatoes"> </div>
                <div> <label class="block text-gray-600 mb-1 text-sm">Land Size (Acres)</label> <input type="number" v-model.number="fundingForm.acres" class="w-full px-3 py-2 border rounded text-sm" min="0.1" step="0.1" required placeholder="e.g., 5.5"> </div>
                <div> <label class="block text-gray-600 mb-1 text-sm">Funding Required (SOL)</label> <input type="number" v-model.number="fundingForm.amount" class="w-full px-3 py-2 border rounded text-sm" min="1" step="0.1" required placeholder="e.g., 50"> </div>
                <div> <label class="block text-gray-600 mb-1 text-sm">Growing Method</label> <select v-model="fundingForm.method" class="w-full px-3 py-2 border rounded bg-white text-sm" required> <option value="">Select method...</option> <option value="organic">Organic</option> <option value="conventional">Conventional</option> <option value="hydroponic">Hydroponic</option> <option value="aquaponic">Aquaponic</option> <option value="regenerative">Regenerative</option> </select> </div>
                <div> <label class="block text-gray-600 mb-1 text-sm">Expected ROI (%)</label> <input type="number" v-model.number="fundingForm.roi" class="w-full px-3 py-2 border rounded text-sm" min="1" max="100" required placeholder="e.g., 15"> </div>
            </div>
            <div class="mb-4"> <label class="block text-gray-600 mb-1 text-sm">Select Video Evidence</label> <select v-model="fundingForm.cid" class="w-full px-3 py-2 border rounded bg-white mb-2 text-sm" required> <option value="" disabled>Select video...</option> <option v-for="vid in availableVideosForFunding" :key="vid.cid" :value="vid.cid"> {{ vid.crop }} ({{ vid.location }}) - {{ vid.pesticideCompany || 'N/A' }} </option> <option v-if="farmerVideos.length > 0 && availableVideosForFunding.length === 0" disabled>No unlisted 'For Funding' or 'General' videos available</option> <option v-if="farmerVideos.length === 0" disabled>No videos uploaded yet</option></select> <p v-if="farmerVideos.length === 0" class="text-xs text-red-500">You need to upload a video first via PestiVid.</p> <p v-if="farmerVideos.length > 0 && availableVideosForFunding.length === 0" class="text-xs text-yellow-600">All your 'For Funding' or 'General' videos are already used for funding.</p> </div>
            <div class="mb-4"> <label class="block text-gray-600 mb-1 text-sm">Project Description</label> <textarea v-model="fundingForm.description" class="w-full px-3 py-2 border rounded text-sm" rows="4" required placeholder="Describe your project, growing practices, and how funds will be used..."></textarea> </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"> <div> <label class="block text-gray-600 mb-1 text-sm">Timeline (Months)</label> <input type="number" v-model.number="fundingForm.timeline" class="w-full px-3 py-2 border rounded text-sm" min="1" max="36" required placeholder="How many months until harvest?"> </div> <div> <label class="block text-gray-600 mb-1 text-sm">Investor Share (%)</label> <input type="number" v-model.number="fundingForm.investorShare" class="w-full px-3 py-2 border rounded text-sm" min="1" max="80" required placeholder="Percentage of harvest profit for investors"> </div> </div>
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded w-full" :disabled="!fundingForm.cid || !isUserAuthenticated || role !== 'farmer'"> <i class="fas fa-paper-plane mr-1"></i> Create Funding Request </button>
            </form>
            <div v-if="createdFundingRequest" class="bg-green-100 text-green-700 px-4 py-2 mt-4 rounded font-medium text-sm"> <i class="fas fa-check mr-1"></i> Funding request created and is now visible to investors! </div>
            <div class="mt-8">
            <h3 class="font-semibold mb-2 text-gray-700">Your Active Funding Requests</h3>
            <div v-if="farmerFundingRequests.length===0" class="text-gray-600 text-sm bg-gray-50 p-4 rounded text-center">You have no active funding requests.</div>
            <div v-else class="space-y-4">
                <div v-for="req in farmerFundingRequests" :key="req.id" class="border rounded-lg overflow-hidden shadow-sm bg-white">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 bg-gray-50 border-b"> <h4 class="font-bold mb-2 sm:mb-0">{{ req.title }}</h4> <div class="flex items-center space-x-2"> <span :class="{'bg-yellow-100 text-yellow-800': req.status === 'pending', 'bg-green-100 text-green-800': req.status === 'funded', 'bg-blue-100 text-blue-800': req.status === 'partially_funded'}" class="px-2 py-1 rounded text-xs font-medium"> {{ req.status === 'pending' ? 'Pending' : req.status === 'funded' ? 'Fully Funded' : (req.status === 'partially_funded' ? 'Partially Funded' : req.status) }} </span> </div> </div>
                <div class="p-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 text-sm"> <div> <div class="text-xs text-gray-500">Crop</div> <div>{{ req.crop }}</div> </div> <div> <div class="text-xs text-gray-500">Land Size</div> <div>{{ req.acres }} acres</div> </div> <div> <div class="text-xs text-gray-500">Required</div> <div>{{ req.amount }} SOL</div> </div> <div> <div class="text-xs text-gray-500">Investor Share</div> <div>{{ req.investorShare }}%</div> </div> </div>
                    <div class="mb-4"> <div class="text-xs text-gray-500 mb-1">Funding Progress</div> <div class="progress-bar"> <div class="progress-fill bg-green-500" :style="{width: fundingProgressPercent(req) + '%'}"></div> </div> <div class="flex justify-between text-xs mt-1"> <span>{{ req.fundedAmount || 0 }} SOL raised</span> <span>{{ fundingProgressPercent(req) }}% Complete</span> </div> </div>
                    <div v-if="req.fundedAmount > 0 && req.investors && req.investors.length > 0" class="mb-4"> <div class="text-xs text-gray-500 mb-2">Investors ({{req.investors.length}})</div> <div class="text-sm max-h-24 overflow-y-auto border rounded p-2 bg-gray-50 space-y-1"> <div v-for="investor in req.investors" :key="investor.investorId || investor.id" class="flex justify-between items-center py-1 text-xs"> <span><i class="fas fa-user text-gray-400 mr-1"></i>{{ investor.investorId ? (getFarmerDisplayIdentifier(investor.investorId)) : 'Investor' }}</span> <span class="font-mono bg-blue-100 text-blue-800 px-1 rounded">{{ investor.amount }} SOL</span> </div> </div> </div>
                    <div class="flex justify-end mt-4"> <button v-if="req.status !== 'funded'" class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200" @click="cancelFundingRequest_V1(req.id)"> <i class="fas fa-times mr-1"></i>Cancel Request </button> <span v-if="req.status === 'funded'" class="text-xs text-green-600"><i class="fas fa-check-circle mr-1"></i>Fully Funded!</span> </div>
                </div>
                </div>
            </div>
            </div>
        </div>
    </section>
    <section v-if="current==='buyerAgriSell'" class="max-w-6xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-3"><i class="fas fa-shopping-basket mr-2"></i>AgriSell: Marketplace</h2>
         <div v-if="!isUserAuthenticated || role !== 'buyer'" class="text-center p-10 bg-white rounded-lg shadow"> <i class="fas fa-exclamation-circle text-3xl text-yellow-500 mb-4"></i> <p class="text-xl text-gray-700">Please log in as a Buyer to browse the marketplace.</p> </div>
         <div v-else>
            <div class="bg-white rounded shadow-md p-6 mb-7">
              <div class="flex flex-col md:flex-row md:items-end gap-5">
                <div class="w-full md:w-48"> <label class="block text-gray-600 text-sm">Crop Type</label> <select v-model="buyerFilters.crop" class="w-full px-2 py-1 border rounded bg-white text-sm"> <option value="">All</option> <option v-for="c in uniqueCrops" :key="c">{{c}}</option> </select> </div>
                <div class="flex-1"> <label class="block text-gray-600 text-sm">Location</label> <input v-model="buyerFilters.location" class="w-full px-2 py-1 border rounded text-sm" placeholder="Search by location..."> </div>
                <div class="flex-1"> <label class="block text-gray-600 text-sm">Pesticide Co.</label> <input v-model="buyerFilters.pesticideCompany" class="w-full px-2 py-1 border rounded text-sm" placeholder="Search by pesticide company..."> </div>
                <button type="button" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-1 rounded text-sm mt-2 md:mt-0" @click="resetBuyerFilters"> <i class="fas fa-undo mr-1"></i> Reset Filters </button>
              </div>
            </div>
            <div v-if="filteredListings.length === 0" class="text-gray-600 bg-gray-50 p-8 text-center rounded"> <i class="fas fa-search text-4xl text-gray-400 mb-3"></i><br> No listings found matching your criteria. Try adjusting your filters. </div>
            <div v-else class="grid gap-8 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
              <div v-for="l in filteredListings" :key="l.id" class="bg-white rounded shadow p-4 flex flex-col relative">
                  <div v-if="l.isNew" class="new-badge">NEW</div>
                <div class="mb-3 flex justify-center"> <video :src="ipfsUrl(l.cid)" controls playsinline webkit-playsinline class="rounded w-full max-h-52 bg-black object-cover"></video> </div>
                <div class="mb-1 font-bold text-lg">{{ l.crop }}</div>
                <div class="text-xs text-gray-500 mb-1">Location: <span class="font-mono">{{ l.location }}</span></div>
                <div class="text-xs text-gray-500 mb-1">Pesticide: <span class="font-mono">{{ l.pesticide }}</span></div>
                <div class="text-xs text-gray-500 mb-2">Pesticide Co.: <span class="font-mono">{{ l.pesticideCompany || 'N/A' }}</span></div>
                <div class="text-sm my-2">Price Range: <br><span class="font-mono text-base font-semibold">{{ l.minPrice }}</span> - <span class="font-mono text-base font-semibold">{{ l.maxPrice }}</span> SOL</div>
                <div class="flex items-center text-xs text-gray-600 mb-2"> <span class="mr-1">Sold by: {{ getSellerDisplayIdentifier(l.farmerWallet) }}</span> <button @click="showFarmerProfile(l.farmerWallet)" class="text-blue-500 hover:text-blue-700 focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> </div>
                <button class="mt-auto bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded text-sm" @click="buyListing(l)" :disabled="!isUserAuthenticated || role !== 'buyer' || currentUserIdentifier === l.farmerWallet"> <i class="fas fa-shopping-cart mr-1"></i> {{ currentUserIdentifier === l.farmerWallet ? 'Your Listing' : (isUserAuthenticated && role === 'buyer' ? 'Initiate Purchase' : 'Login as Buyer to Purchase') }} </button>
                <button @click="startOrGoToConversation(l.farmerWallet)" v-if="isUserAuthenticated && currentUserIdentifier !== l.farmerWallet" class="mt-2 text-xs text-blue-600 hover:text-blue-700 border border-blue-400 rounded-full px-3 py-1 hover:bg-blue-50 flex items-center justify-center"> <i class="fas fa-envelope mr-1"></i> Message Seller </button>
              </div>
            </div>
         </div>
    </section>
    <section v-if="current==='investorProjects'" class="max-w-6xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-3"><i class="fas fa-project-diagram mr-2"></i>Investment Opportunities</h2>
        <div v-if="!isUserAuthenticated || role !== 'investor'" class="text-center p-10 bg-white rounded-lg shadow"> <i class="fas fa-exclamation-circle text-3xl text-yellow-500 mb-4"></i> <p class="text-xl text-gray-700">Please log in as an Investor to view projects.</p> </div>
        <div v-else>
          <div class="bg-white rounded shadow-md p-6 mb-7">
            <div class="flex flex-col md:flex-row md:items-end gap-5">
              <div class="w-full md:w-48"> <label class="block text-gray-600 text-sm">Crop Type</label> <select v-model="investorFilters.crop" class="w-full px-2 py-1 border rounded bg-white text-sm"> <option value="">All Crops</option> <option v-for="c in uniqueFundingCrops" :key="c">{{c}}</option> </select> </div>
              <div class="w-full md:w-48"> <label class="block text-gray-600 text-sm">Growing Method</label> <select v-model="investorFilters.method" class="w-full px-2 py-1 border rounded bg-white text-sm"> <option value="">All Methods</option> <option value="organic">Organic</option> <option value="conventional">Conventional</option> <option value="hydroponic">Hydroponic</option> <option value="aquaponic">Aquaponic</option> <option value="regenerative">Regenerative</option> </select> </div>
              <div class="w-full md:w-48"> <label class="block text-gray-600 text-sm">Min ROI (%)</label> <input type="number" v-model.number="investorFilters.minRoi" class="w-full px-2 py-1 border rounded text-sm" placeholder="e.g., 10"> </div>
              <div class="w-full md:w-48"> <label class="block text-gray-600 text-sm">Max Funding Needed (SOL)</label> <input type="number" v-model.number="investorFilters.maxAmount" class="w-full px-2 py-1 border rounded text-sm" placeholder="e.g., 100"> </div>
              <button type="button" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-1 rounded text-sm mt-2 md:mt-0" @click="resetInvestorFilters"> <i class="fas fa-undo mr-1"></i> Reset Filters </button>
            </div>
          </div>
          <div v-if="filteredFundingRequests.length === 0" class="text-gray-600 bg-gray-50 p-8 text-center rounded"> <i class="fas fa-search text-4xl text-gray-400 mb-3"></i><br> No projects found matching your criteria. Try adjusting your filters. </div>
          <div v-else class="grid gap-6 grid-cols-1 lg:grid-cols-2">
            <div v-for="project in filteredFundingRequests" :key="project.id" class="bg-white rounded-lg shadow overflow-hidden relative">
              <div v-if="project.isNew" class="new-badge">NEW</div>
              <div class="p-5 bg-gray-50 border-b flex flex-col sm:flex-row justify-between sm:items-center"> <h3 class="font-bold text-lg text-green-800 mb-2 sm:mb-0">{{ project.title }}</h3> <span :class="{'bg-yellow-100 text-yellow-800': project.status === 'pending', 'bg-green-100 text-green-800': project.status === 'funded', 'bg-blue-100 text-blue-800': project.status === 'partially_funded'}" class="px-2 py-1 rounded text-xs font-medium self-start sm:self-center"> {{ project.status === 'pending' ? 'Seeking Funding' : project.status === 'funded' ? 'Fully Funded' : 'Partial Funding' }} </span> </div>
              <div class="p-5">
                <div class="flex flex-col md:flex-row gap-6">
                  <div class="md:w-1/3">
                    <video :src="ipfsUrl(project.cid)" controls playsinline webkit-playsinline class="rounded w-full h-40 object-cover bg-black mb-3"></video>
                    <div class="grid grid-cols-2 gap-2 text-sm"> <div> <div class="text-xs text-gray-500">Farmer</div> <div class="font-medium truncate flex items-center"> <span>{{ getFarmerDisplayIdentifier(project.farmerWallet) }}</span> <button @click="showFarmerProfile(project.farmerWallet)" class="ml-2 text-blue-500 hover:text-blue-700 text-xs focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> </div> </div> <div> <div class="text-xs text-gray-500">Land Size</div> <div class="font-medium">{{ project.acres }} acres</div> </div> <div> <div class="text-xs text-gray-500">Timeline</div> <div class="font-medium">{{ project.timeline }} months</div> </div> <div> <div class="text-xs text-gray-500">Expected ROI</div> <div class="font-medium text-green-700">{{ project.roi }}%</div> </div> </div>
                    <button @click="startOrGoToConversation(project.farmerWallet)" v-if="isUserAuthenticated && currentUserIdentifier !== project.farmerWallet" class="mt-3 w-full text-xs text-blue-600 hover:text-blue-700 border border-blue-400 rounded-full px-3 py-1 hover:bg-blue-50 flex items-center justify-center"> <i class="fas fa-envelope mr-1"></i> Message Farmer </button>
                  </div>
                  <div class="md:w-2/3">
                    <div class="mb-4"> <div class="text-sm font-medium mb-1">{{ project.crop }} ({{ project.method }})</div> <p class="text-sm text-gray-700 max-h-20 overflow-y-auto">{{ project.description }}</p> </div>
                    <div class="mb-4"> <div class="text-xs text-gray-500 mb-1">Funding Progress</div> <div class="progress-bar"> <div class="progress-fill bg-green-500" :style="{width: fundingProgressPercent(project) + '%'}"></div> </div> <div class="flex justify-between text-xs mt-1"> <span>{{ project.fundedAmount || 0 }} / {{ project.amount }} SOL</span> <span>{{ fundingProgressPercent(project) }}% Complete</span> </div> </div>
                    <div v-if="project.updates && project.updates.length > 0" class="mb-4"> <h4 class="text-sm font-semibold text-gray-700 mb-2">Recent Farmer Updates</h4> <div class="project-updates-list text-xs" style="max-height: 70px;"> <div v-for="update in project.updates.slice().reverse().slice(0,2)" :key="update.id" class="project-update-item"> <span class="font-medium text-gray-500">{{ update.date }}:</span> {{ update.text }} </div> </div> </div>
                    <div class="mb-4"> <div class="flex justify-between items-center mb-2"> <div class="text-sm font-medium">Investment Terms</div> <div class="text-xs text-gray-500">Investor Share: {{ project.investorShare }}% of profit</div> </div> <div class="p-3 bg-yellow-50 rounded text-sm border border-yellow-200"> <p>Invest to receive {{ project.investorShare }}% of the profits, proportional to your investment. Expected return is {{ project.roi }}% over {{ project.timeline }} months.</p> </div> </div>
                    <div class="flex flex-col sm:flex-row justify-between items-center mt-4 pt-4 border-t"> <div class="mb-3 sm:mb-0"> <label :for="'investment-amount-'+project.id" class="text-xs text-gray-500 block mb-1">Your Investment (SOL)</label> <input v-model.number="investmentAmounts[project.id]" type="number" :id="'investment-amount-'+project.id" class="px-3 py-1 border rounded w-full sm:w-32 text-sm" min="0.1" :max="maxInvestmentAmount(project)" step="0.01" :disabled="project.status === 'funded' || !isUserAuthenticated || role !== 'investor'" :placeholder="maxInvestmentAmount(project) > 0 ? `Max ${maxInvestmentAmount(project)}` : 'Funded'"> </div> <button @click="investInProject(project)" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm w-full sm:w-auto" :disabled="project.status === 'funded' || !isUserAuthenticated || role !== 'investor' || !investmentAmounts[project.id] || investmentAmounts[project.id] <= 0 || investmentAmounts[project.id] > maxInvestmentAmount(project) + 0.00001"> <i class="fas fa-coins mr-1"></i> {{ project.status === 'funded' ? 'Fully Funded' : (!isUserAuthenticated || role !== 'investor' ? 'Login as Investor' : 'Invest Now') }} </button> </div>
                    <div v-if="investmentErrors[project.id]" class="text-red-500 text-xs mt-2">{{ investmentErrors[project.id] }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div v-if="filteredFundingRequests.length === 0" class="bg-gray-50 p-8 text-center rounded-lg mt-4"> <i class="fas fa-seedling text-gray-300 text-4xl mb-3"></i> <h3 class="text-gray-600 text-lg mb-2">No Projects Found</h3> <p class="text-gray-500">Try adjusting your filters or check back later for new investment opportunities.</p> </div>
        </div>
    </section>
    <section v-if="current==='investorPortfolio'" class="max-w-6xl mx-auto mt-6">
        <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-chart-pie mr-2"></i>Investment Portfolio</h2>
        <div v-if="!isUserAuthenticated || role !== 'investor'" class="text-center p-10 bg-white rounded-lg shadow"> <i class="fas fa-exclamation-circle text-3xl text-yellow-500 mb-4"></i> <p class="text-xl text-gray-700">Please log in as an Investor to view your portfolio.</p> </div>
        <div v-else>
            <div class="bg-white rounded-lg shadow p-6 mb-8">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Portfolio Overview</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6"> <div class="mb-4 md:mb-0"> <div class="text-xs text-gray-500">Total Invested</div> <div class="text-2xl font-bold text-green-700">{{ totalInvestedAmount }} SOL</div> </div> <div> <div class="text-xs text-gray-500">Active Projects</div> <div class="text-xl font-bold">{{ investorActiveProjects }}</div> </div> <div> <div class="text-xs text-gray-500">Completed</div> <div class="text-xl font-bold">{{ investorCompletedProjects }}</div> </div> <div> <div class="text-xs text-gray-500">Avg. ROI (Est.)</div> <div class="text-xl font-bold text-green-700">{{ investorAvgRoi }}%</div> </div> </div>
            </div>
            <div class="bg-white rounded-lg shadow overflow-hidden mb-8">
                <div class="px-6 py-4 bg-gray-50 border-b"> <h3 class="text-lg font-semibold text-gray-800">Your Active Investments</h3> </div>
                <div v-if="investorInvestments.length === 0" class="p-8 text-center"> <i class="fas fa-chart-line text-gray-300 text-4xl mb-3"></i> <h4 class="text-gray-600 text-lg mb-2">No Active Investments</h4> <p class="text-gray-500 mb-4">You haven't invested in any agricultural projects yet.</p> <button @click="switchPage('investorProjects')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm"> <i class="fas fa-search mr-1"></i>Browse Projects </button> </div>
                <div v-else class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50"> <tr> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Farmer</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invested (SOL)</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expected Return (SOL)</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th> </tr> </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                    <tr v-for="investment in investorInvestments" :key="investment.id">
                        <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-medium text-gray-900">{{ investment.projectTitle }}</div> <div class="text-xs text-gray-500">{{ investment.crop }}</div> </td>
                        <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm text-gray-900">{{ getFarmerDisplayIdentifier(investment.farmerWallet, 10) }}</div> <button @click="showFarmerProfile(investment.farmerWallet)" class="text-blue-500 hover:text-blue-700 text-xs focus:outline-none mr-2" title="View Farmer Info"> <i class="fas fa-info-circle mr-1"></i>View Info </button> <button @click="startOrGoToConversation(investment.farmerWallet)" v-if="isUserAuthenticated && currentUserIdentifier !== investment.farmerWallet" class="text-green-600 hover:text-green-700 text-xs focus:outline-none" title="Message Farmer"> <i class="fas fa-envelope mr-1"></i>Message </button> </td>
                        <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm text-gray-900 font-mono">{{ investment.amount }}</div> <div class="text-xs text-gray-500">{{ investment.investmentDate }}</div> </td>
                        <td class="px-6 py-4 whitespace-nowrap"> <div class="w-24 bg-gray-200 rounded-full h-2.5"> <div class="bg-green-600 h-2.5 rounded-full" :style="{width: investment.progress + '%'}"></div> </div> <div class="text-xs text-gray-500 mt-1">{{ investment.progress }}% Complete</div> </td>
                        <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm text-gray-900 font-mono">{{ calculateExpectedReturn(investment) }}</div> <div class="text-xs text-gray-500">{{ investment.roi }}% ROI</div> </td>
                        <td class="px-6 py-4 whitespace-nowrap"> <span :class="{ 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true, 'bg-blue-100 text-blue-800': investment.status === 'active', 'bg-green-100 text-green-800': investment.status === 'harvested', 'bg-yellow-100 text-yellow-800': investment.status === 'growing' }"> {{ investment.status === 'active' ? 'Active' : investment.status === 'harvested' ? 'Harvested' : (investment.status === 'growing' ? 'Growing' : investment.status) }} </span> </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600"> <a href="#" @click.prevent="viewInvestmentDetails(investment)" class="hover:underline">View</a> </td>
                    </tr>
                    </tbody>
                </table>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="px-6 py-4 bg-gray-50 border-b flex justify-between items-center"> <h3 class="text-lg font-semibold text-gray-800">Platform Transaction History (Simulated)</h3> <span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded-full flex items-center"> <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 16 15"><path d="m7.81 0-1.78 3.69L1.88 4.2l2.92 2.52L4.04 10 7.8 7.97 11.55 10l-.77-3.28 2.92 2.52-4.15-.51L7.82 0h-.01Zm0 15-1.78-3.69-4.15-.51 2.92-2.52L4.04 5 7.8 7.03 11.55 5l-.77 3.28 2.92 2.52-4.15-.51L7.82 15h-.01Z"></path></svg> PestiVid Platform (Simulated Ledger) </span> </div>
                <div v-if="investorTransactions.length === 0" class="p-8 text-center"> <i class="fas fa-cubes text-gray-300 text-4xl mb-3"></i> <h4 class="text-gray-600 text-lg mb-2">No Transactions Yet</h4> <p class="text-gray-500">Your investment and payout transactions on the platform will appear here.</p> </div>
                <div v-else class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50"> <tr> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Transaction ID</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount (SOL)</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th> </tr> </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                    <tr v-for="tx in investorTransactions" :key="tx.id">
                        <td class="px-6 py-4 whitespace-nowrap"> <div class="flex items-center"> <div class="text-sm font-mono text-gray-900 truncate max-w-[150px] sm:max-w-[250px]" :title="tx.txHash">{{ tx.txHash.substring(0,10) }}...{{ tx.txHash.substring(tx.txHash.length-10) }}</div> <a :href="solanaExplorerUrl(tx.txHash)" target="_blank" class="ml-1 text-blue-500 hover:text-blue-700" title="View on Solana Explorer (Demo Link)"> <i class="fas fa-external-link-alt text-xs"></i> </a> </div> </td>
                        <td class="px-6 py-4 whitespace-nowrap"> <span :class="{ 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true, 'bg-green-100 text-green-800': tx.type === 'investment', 'bg-blue-100 text-blue-800': tx.type === 'payout' }"> {{ tx.type === 'investment' ? 'Investment' : 'Harvest Payout' }} </span> </td>
                        <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-mono text-gray-900">{{ tx.amount }}</div> </td>
                        <td class="px-6 py-4 whitespace-nowrap"> <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800"> Confirmed (Sim.) </span> </td>
                        <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm text-gray-900">{{ tx.date }}</div> </td>
                    </tr>
                    </tbody>
                </table>
                </div>
            </div>
        </div>
    </section>
    <section v-if="current==='userProfile'" class="max-w-6xl mx-auto mt-6">
        <div v-if="!isUserAuthenticated" class="text-center p-10 bg-white rounded-lg shadow"> <i class="fas fa-exclamation-circle text-3xl text-yellow-500 mb-4"></i> <p class="text-xl text-gray-700">Please log in to view your profile.</p> </div>
      <div v-else class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="bg-gradient-to-r from-green-700 to-green-500 p-6 text-white">
          <div class="flex flex-col md:flex-row justify-between items-center">
            <div class="flex items-center mb-4 md:mb-0">
              <div class="bg-white rounded-full w-16 h-16 flex items-center justify-center mr-4 text-green-600 shadow overflow-hidden">
                <img v-if="loginMethod === 'orangeId' && orangeIdUser && orangeIdUser.picture" :src="orangeIdUser.picture" alt="Avatar" class="w-full h-full object-cover"/>
                <i v-else :class="role === 'farmer' ? 'fas fa-tractor' : (role === 'buyer' ? 'fas fa-shopping-cart' : 'fas fa-chart-line')" class="text-3xl"></i>
              </div>
              <div> <h2 class="text-2xl font-bold">{{ userName || displayedUserIdentifier }}</h2> <p class="text-green-100 capitalize"> {{ role === 'farmer' ? 'Agricultural Producer' : role === 'buyer' ? 'Crop Buyer' : 'Agricultural Investor' }} </p> </div>
            </div>
            <div class="bg-white bg-opacity-20 rounded-lg px-4 py-2 flex items-center text-sm"> <i class="fas fa-certificate mr-2"></i> <span>{{ role === 'farmer' ? 'Verified Farmer' : role === 'buyer' ? 'Verified Buyer' : 'Verified Investor' }} (PestiVid Status)</span> </div>
          </div>
        </div>
        <div class="p-6">
          <div class="mb-8">
            <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-id-card mr-2"></i>Account Information </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
              <div>
                <div class="mb-4"> <p class="text-gray-600">Full Name (PestiVid)</p> <p class="font-medium">{{ userName || 'Not Provided in PestiVid Profile' }}</p> </div>
                <div class="mb-4"> <p class="text-gray-600">PestiVid User Identifier ({{ loginMethod === 'orangeId' ? 'Orange ID' : 'Solana Wallet' }})</p> <p class="font-medium font-mono break-all">{{ currentUserIdentifier }}</p> </div>
                <div v-if="loginMethod === 'orangeId' && orangeIdUser && orangeIdUser.ethAddress" class="mb-4"> <p class="text-gray-600">ETH Address (from Orange ID, if available)</p> <p class="font-medium font-mono break-all">{{ orangeIdUser.ethAddress }}</p> </div>
                <div> <p class="text-gray-600">PestiVid Account Type</p> <p class="font-medium capitalize">{{ role || "Not Set" }}</p> </div>
              </div>
              <div>
                <div class="mb-4"> <p class="text-gray-600">Email (PestiVid)</p> <p class="font-medium">{{ userEmail || 'Not Provided in PestiVid Profile' }}</p> </div>
                <div v-if="loginMethod === 'orangeId' && orangeIdUser && orangeIdUser.email && orangeIdUser.email !== userEmail" class="mb-4"> <p class="text-gray-600">Authenticated Email (Orange ID)</p> <p class="font-medium">{{ orangeIdUser.email }}</p> </div>
                <div class="mb-4"> <p class="text-gray-600">Phone (PestiVid)</p> <p class="font-medium">{{ userPhone || 'Not Provided' }}</p> </div>
                <div> <p class="text-gray-600">PestiVid Member Since</p> <p class="font-medium">{{ memberSince || 'N/A' }}</p> </div>
              </div>
            </div>
          </div>
          <!-- Farmer Specific Content -->
          <div v-if="role === 'farmer'" class="mb-8">
            <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-cloud-sun-rain mr-2"></i>Farm Weather Station </h3>
            <div class="weather-card">
                <div class="flex flex-col sm:flex-row gap-4 mb-6 items-end"> <div class="flex-grow"> <label for="farmerCity" class="block text-sm font-medium text-gray-700 mb-1">Farm City/Location:</label> <input type="text" id="farmerCity" v-model.trim="farmerLocationCity" @keyup.enter="fetchWeather" @change="saveFarmerCity" placeholder="e.g., Davis, California" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-sm"> </div> <button @click="fetchWeather" :disabled="weatherLoading || !farmerLocationCity" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm flex items-center justify-center" :class="{'opacity-50 cursor-not-allowed': weatherLoading || !farmerLocationCity}"> <i :class="weatherLoading ? 'fas fa-spinner fa-spin' : 'fas fa-search-location'" class="mr-2"></i> {{ weatherLoading ? 'Fetching...' : 'Get Weather' }} </button> </div>
                <div v-if="weatherError" class="mb-4 bg-red-100 border border-red-300 text-red-700 px-4 py-3 rounded text-sm"> <i class="fas fa-exclamation-triangle mr-2"></i>{{ weatherError }} </div>
                <div v-if="!weatherLoading && !weatherError && !currentWeather && !forecastWeather.length" class="text-center text-gray-500 py-4"> Enter your farm's city to see local weather conditions and forecast. </div>
                <div v-if="currentWeather && !weatherLoading" class="mb-8"> <h4 class="text-lg font-semibold text-gray-800 mb-3">Current Conditions in {{ currentWeather.name }}</h4> <div class="flex flex-col sm:flex-row items-center gap-4 bg-blue-50 p-4 rounded-lg border border-blue-200"> <img :src="getWeatherIconUrl(currentWeather.weather[0].icon)" :alt="currentWeather.weather[0].description" class="w-20 h-20"> <div class="flex-grow text-center sm:text-left"> <p class="text-3xl font-bold">{{ Math.round(currentWeather.main.temp) }}°C</p> <p class="text-gray-700 capitalize">{{ currentWeather.weather[0].description }}</p> </div> <div class="text-sm text-gray-600 space-y-1 text-center sm:text-left"> <p><i class="fas fa-tint mr-1 text-blue-500"></i>Humidity: {{ currentWeather.main.humidity }}%</p> <p><i class="fas fa-wind mr-1 text-gray-500"></i>Wind: {{ currentWeather.wind.speed }} m/s</p> <p><i class="fas fa-tachometer-alt mr-1 text-gray-500"></i>Pressure: {{ currentWeather.main.pressure }} hPa</p> </div> </div> </div>
                <div v-if="forecastWeather.length > 0 && !weatherLoading"> <h4 class="text-lg font-semibold text-gray-800 mb-4">5-Day Forecast</h4> <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3"> <div v-for="day in forecastWeather" :key="day.date" class="forecast-day"> <p class="font-semibold text-sm">{{ day.dateString }}</p> <img :src="getWeatherIconUrl(day.icon)" :alt="day.description" class="w-12 h-12 mx-auto my-1"> <p class="text-lg font-bold">{{ Math.round(day.maxTemp) }}° <span class="text-gray-500">/ {{ Math.round(day.minTemp) }}°</span></p> <p class="text-xs text-gray-600 capitalize">{{ day.description }}</p> </div> </div> </div>
            </div>
          </div>
           <div v-if="role === 'farmer'">
                <div class="mb-8"> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-video mr-2"></i>Your Uploaded Videos ({{ farmerVideos.length }}) </h3> <div v-if="farmerVideos.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center"> <i class="fas fa-film text-gray-400 text-2xl mb-2"></i> <p>You haven't uploaded any videos yet.</p> <button @click="switchPage('farmerPestiVid')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Upload your first video</button> </div> <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"> <div v-for="vid in farmerVideos" :key="vid.cid" class="bg-gray-50 rounded-lg p-4 shadow-sm"> <video :src="ipfsUrl(vid.cid)" controls playsinline webkit-playsinline class="w-full h-40 object-cover bg-black rounded mb-3"></video> <h4 class="font-bold">{{ vid.crop }}</h4> <div class="text-xs mb-1" :class="{ 'text-blue-700': vid.purpose === 'sell', 'text-purple-700': vid.purpose === 'funding', 'text-gray-600': vid.purpose === 'agristream' || !vid.purpose }"> Purpose: <span class="font-semibold"> {{ vid.purpose === 'sell' ? 'Sale' : (vid.purpose === 'funding' ? 'Funding' : (vid.purpose === 'agristream' ? 'General' : 'N/A')) }} </span> </div> <div class="text-sm mb-1">Location: {{ vid.location }}</div> <div class="text-sm mb-1">Pesticide: {{ vid.pesticide }}</div> <div class="text-sm mb-2">Pesticide Co.: {{ vid.pesticideCompany || 'N/A' }}</div> <div class="flex justify-between items-center mt-2 text-xs text-gray-500"> <span class="font-mono truncate" :title="vid.cid">CID: {{ vid.cid.substring(0, 10) }}...</span> <a :href="ipfsUrl(vid.cid)" target="_blank" class="text-blue-600 hover:underline">View</a> </div> </div> </div> </div>
                <div class="mb-8"> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-tags mr-2"></i>Your Active Listings ({{ farmerListings.length }}) </h3> <div v-if="farmerListings.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center"> <i class="fas fa-store text-gray-400 text-2xl mb-2"></i> <p>You don't have any active listings.</p> <button @click="switchPage('farmerSell')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Create your first listing</button> </div> <div v-else> <div class="overflow-x-auto"> <table class="min-w-full border divide-y divide-gray-200"> <thead class="bg-gray-50"> <tr> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Crop</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pesticide Co.</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price Range (SOL)</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th> </tr> </thead> <tbody class="bg-white divide-y divide-gray-200"> <tr v-for="listing in farmerListings" :key="listing.id"> <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-medium text-gray-900">{{ listing.crop }}</div> <div class="text-xs text-gray-500" :title="listing.cid">CID: {{ listing.cid.substring(0, 8) }}...</div> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ listing.location }} </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ listing.pesticideCompany || 'N/A' }} </td> <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm text-gray-900 font-mono">{{ listing.minPrice }} - {{ listing.maxPrice }}</div> </td> <td class="px-6 py-4 whitespace-nowrap"> <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800"> Active </span> </td> </tr> </tbody> </table> </div> </div> </div>
                <div> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-hand-holding-usd mr-2"></i>Your Funding Requests ({{ farmerFundingRequests.length }}) </h3> <div v-if="farmerFundingRequests.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center"> <i class="fas fa-money-bill-wave text-gray-400 text-2xl mb-2"></i> <p>You haven't created any funding requests yet.</p> <button @click="switchPage('farmerFunding')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Request funding for your farm</button> </div> <div v-else class="space-y-4"> <div v-for="req in farmerFundingRequests" :key="req.id" class="border rounded-lg overflow-hidden bg-white shadow-sm"> <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 bg-green-50 border-b"> <h4 class="font-bold mb-1 sm:mb-0">{{ req.title }}</h4> <span :class="{'bg-yellow-100 text-yellow-800': req.status === 'pending', 'bg-green-100 text-green-800': req.status === 'funded', 'bg-blue-100 text-blue-800': req.status === 'partially_funded'}" class="px-2 py-1 rounded text-xs font-medium"> {{ req.status === 'pending' ? 'Pending' : req.status === 'funded' ? 'Fully Funded' : (req.status === 'partially_funded' ? 'Partially Funded' : req.status) }} </span> </div> <div class="p-4 text-sm"> <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4"> <div> <div class="text-xs text-gray-500">Crop</div> <div>{{ req.crop }}</div> </div> <div> <div class="text-xs text-gray-500">Land Size</div> <div>{{ req.acres }} acres</div> </div> <div> <div class="text-xs text-gray-500">Required</div> <div class="font-mono">{{ req.amount }} SOL</div> </div> <div> <div class="text-xs text-gray-500">Raised</div> <div class="font-mono">{{ req.fundedAmount || 0 }} SOL</div> </div> </div> <div class="mb-4"> <div class="text-xs text-gray-500 mb-1">Funding Progress</div> <div class="progress-bar"> <div class="progress-fill bg-green-500" :style="{width: fundingProgressPercent(req) + '%'}"></div> </div> <div class="text-xs mt-1">{{ fundingProgressPercent(req) }}% Complete</div> </div> <div class="flex justify-end mt-4"> <button v-if="req.status !== 'funded'" class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200" @click="cancelFundingRequest_V1(req.id)"> <i class="fas fa-times mr-1"></i>Cancel Request </button> <span v-if="req.status === 'funded'" class="text-xs text-green-600"><i class="fas fa-check-circle mr-1"></i>Fully Funded!</span> </div> </div> </div> </div> </div>
            </div>
           <div v-if="role === 'buyer'"> <div> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-shopping-basket mr-2"></i>Your Purchase History ({{ buyerPurchases.length }}) </h3> <div v-if="buyerPurchases.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center"> <i class="fas fa-shopping-cart text-gray-400 text-2xl mb-2"></i> <p>You haven't made any purchases yet.</p> <button @click="switchPage('buyerAgriSell')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Browse marketplace</button> </div> <div v-else> <div class="overflow-x-auto"> <table class="min-w-full border divide-y divide-gray-200"> <thead class="bg-gray-50"> <tr> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Crop</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pesticide Co.</th> <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price Paid (SOL)</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Purchase Date</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Seller</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Video/Tx</th> </tr> </thead> <tbody class="bg-white divide-y divide-gray-200"> <tr v-for="purchase in buyerPurchases" :key="purchase.id"> <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-medium text-gray-900">{{ purchase.crop }}</div> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ purchase.location }} </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ purchase.pesticideCompany || 'N/A' }} </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono"> {{ purchase.price }} </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ purchase.date }} </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ getSellerDisplayIdentifier(purchase.farmerWallet, 10) }} <button @click="showFarmerProfile(purchase.farmerWallet)" class="ml-1 text-blue-500 hover:text-blue-700 text-xs focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> <button @click="startOrGoToConversation(purchase.farmerWallet)" v-if="isUserAuthenticated && currentUserIdentifier !== purchase.farmerWallet" class="ml-1 text-green-600 hover:text-green-700 text-xs focus:outline-none" title="Message Seller"> <i class="fas fa-envelope"></i> </button> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600"> <a href="#" @click.prevent="viewPurchaseVideo(purchase)" class="hover:underline mr-2">Video</a> <a :href="solanaExplorerUrl(purchase.txHash)" target="_blank" class="hover:underline" title="View Transaction (Demo Link)">Tx</a> </td> </tr> </tbody> </table> </div> </div> </div> </div>
           <div v-if="role === 'investor'"> <div class="mb-8"> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-chart-pie mr-2"></i>Investment Portfolio Summary </h3> <div v-if="investorInvestments.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center"> <i class="fas fa-coins text-gray-400 text-2xl mb-2"></i> <p>You haven't made any investments yet.</p> <button @click="switchPage('investorProjects')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Browse investment opportunities</button> </div> <div v-else> <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6"> <div class="bg-gray-50 p-4 rounded-lg"> <div class="text-sm text-gray-500">Total Invested</div> <div class="text-xl font-bold text-green-700">{{ totalInvestedAmount }} SOL</div> </div> <div class="bg-gray-50 p-4 rounded-lg"> <div class="text-sm text-gray-500">Projects</div> <div class="text-xl font-bold">{{ investorInvestments.length }}</div> </div> <div class="bg-gray-50 p-4 rounded-lg"> <div class="text-sm text-gray-500">Avg. ROI (Est.)</div> <div class="text-xl font-bold text-green-700">{{ investorAvgRoi }}%</div> </div> <div class="bg-gray-50 p-4 rounded-lg"> <div class="text-sm text-gray-500">Completed</div> <div class="text-xl font-bold">{{ investorCompletedProjects }}</div> </div> </div> <div class="overflow-x-auto mt-4"> <h4 class="text-lg font-semibold text-gray-800 mb-3">Your Investments</h4> <table class="min-w-full border divide-y divide-gray-200"> <thead class="bg-gray-50"> <tr> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Farmer</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount (SOL)</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th> <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th> </tr> </thead> <tbody class="bg-white divide-y divide-gray-200"> <tr v-for="inv in investorInvestments" :key="inv.id"> <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-medium text-gray-900">{{ inv.projectTitle }}</div> <div class="text-xs text-gray-500">{{ inv.crop }}</div> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ getFarmerDisplayIdentifier(inv.farmerWallet, 10) }} <button @click="showFarmerProfile(inv.farmerWallet)" class="ml-1 text-blue-500 hover:text-blue-700 text-xs focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> <button @click="startOrGoToConversation(inv.farmerWallet)" v-if="isUserAuthenticated && currentUserIdentifier !== inv.farmerWallet" class="ml-1 text-green-600 hover:text-green-700 text-xs focus:outline-none" title="Message Farmer"> <i class="fas fa-envelope"></i> </button> </td> <td class="px-6 py-4 whitespace-nowrap"> <div class="text-sm font-mono text-gray-900">{{ inv.amount }}</div> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"> {{ inv.investmentDate }} </td> <td class="px-6 py-4 whitespace-nowrap"> <span :class="{'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true, 'bg-blue-100 text-blue-800': inv.status === 'active', 'bg-green-100 text-green-800': inv.status === 'harvested', 'bg-yellow-100 text-yellow-800': inv.status === 'growing'}"> {{ inv.status === 'active' ? 'Active' : inv.status === 'harvested' ? 'Harvested' : (inv.status === 'growing' ? 'Growing' : inv.status) }} </span> </td> <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600"> <a href="#" @click.prevent="viewInvestmentDetails(inv)" class="hover:underline">View</a> </td> </tr> </tbody> </table> </div> <div class="mt-4 text-right"> <button @click="switchPage('investorPortfolio')" class="text-green-700 text-sm hover:underline">Go to Full Portfolio <i class="fas fa-arrow-right ml-1"></i></button> </div> </div> </div> <div> <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center"> <i class="fas fa-link mr-2"></i>Platform Verification (Simulated) </h3> <div class="bg-gray-50 p-5 rounded-lg border"> <div class="flex items-center mb-4"> <i class="fas fa-shield-alt text-green-600 text-2xl mr-3"></i> <div> <h4 class="font-bold text-gray-800">PestiVid Platform Records</h4> <p class="text-sm text-gray-600">All your investment transactions are recorded on the PestiVid platform (Simulated Ledger).</p> </div> </div> <div v-if="investorTransactions.length > 0" class="mt-4"> <h5 class="font-medium text-sm mb-2">Recent Transactions</h5> <div class="space-y-2"> <div v-for="tx in investorTransactions.slice(0, 3)" :key="tx.id" class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-2 bg-white rounded border text-sm"> <div class="flex items-center mb-1 sm:mb-0"> <span :class="{'px-2 py-0.5 text-xs rounded-full mr-2': true, 'bg-green-100 text-green-800': tx.type === 'investment', 'bg-blue-100 text-blue-800': tx.type === 'payout'}"> {{ tx.type === 'investment' ? 'Invest' : 'Payout' }} </span> <span class="font-mono text-xs text-gray-500 truncate" :title="tx.txHash">{{ tx.txHash.substring(0, 8) }}...{{ tx.txHash.substring(tx.txHash.length - 8) }}</span> <a :href="solanaExplorerUrl(tx.txHash)" target="_blank" class="text-blue-600 hover:underline whitespace-nowrap ml-2"> <i class="fas fa-external-link-alt"></i> View (Demo) </a> </div> <div class="text-right w-full sm:w-auto"> <div class="font-mono text-sm">{{ tx.amount }} SOL</div> <div class="text-xs text-gray-500">{{ tx.date }}</div> </div> </div> </div> <div class="mt-3 text-right"> <button @click="switchPage('investorPortfolio')" class="text-green-700 text-sm hover:underline">View all transactions <i class="fas fa-arrow-right ml-1"></i></button> </div> </div> <div v-else class="bg-white p-4 rounded border text-center text-sm text-gray-600"> <p>No platform transactions recorded yet.</p> </div> </div> </div> </div>
        </div>
      </section>
    <section v-if="current==='messaging'" class="max-w-6xl mx-auto mt-6">
        <div v-if="!isUserAuthenticated" class="text-center p-10 bg-white rounded-lg shadow"> <i class="fas fa-exclamation-circle text-3xl text-yellow-500 mb-4"></i> <p class="text-xl text-gray-700">Please log in to access messaging.</p> </div>
      <div v-else class="bg-white rounded-lg shadow-md flex" style="height: calc(100vh - 200px);">
        <div class="w-full md:w-1/3 border-r flex flex-col bg-gray-50">
            <div class="p-4 border-b"> <h2 class="text-xl font-semibold text-green-700">Conversations</h2> </div>
            <div class="overflow-y-auto flex-1">
                <div v-if="userConversations.length === 0" class="p-4 text-center text-gray-500 mt-10"> <i class="fas fa-comment-slash fa-3x mb-3 text-gray-300"></i> <p>No conversations yet.</p> <p class="text-xs mt-1">Start a chat from a user's profile or project.</p> </div>
                <div v-for="conv in userConversations" :key="conv.id" @click="selectConversation(conv.id)" class="p-3 hover:bg-gray-100 cursor-pointer border-b flex items-center space-x-3" :class="{'bg-green-100 border-l-4 border-green-500': activeConversationId === conv.id, 'bg-white': activeConversationId !== conv.id}">
                    <div class="w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center text-lg flex-shrink-0"> {{ getOtherParticipantInitial(conv) }} </div>
                    <div class="flex-1 overflow-hidden"> <div class="font-semibold text-gray-800 truncate">{{ getOtherParticipantDisplayAddress(conv) }}</div> <div class="text-xs text-gray-500 truncate">{{ conv.lastMessageSnippet }}</div> </div>
                    <div class="text-xs text-gray-400 self-start whitespace-nowrap">{{ formatTimestamp(conv.lastMessageTimestamp, true) }}</div>
                    <div v-if="getUnreadCountForConversation(conv.id) > 0" class="bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs ml-auto flex-shrink-0"> {{ getUnreadCountForConversation(conv.id) }} </div>
                </div>
            </div>
        </div>
        <div class="w-full md:w-2/3 flex flex-col bg-white">
            <div v-if="!activeConversationId" class="flex-1 flex flex-col items-center justify-center text-gray-400 p-10 text-center"> <i class="fas fa-comments fa-4x mb-4"></i> <h3 class="text-xl text-gray-600">Welcome to PestiVid Chat</h3> <p>Select a conversation from the left to view messages, or start a new chat from a user's profile or project page.</p> </div>
            <template v-else>
                <div class="p-4 border-b bg-gray-50 flex items-center sticky top-0 z-10"> <div class="w-8 h-8 rounded-full bg-green-600 text-white flex items-center justify-center text-sm mr-3 flex-shrink-0"> {{ activeConversationPartnerInitial ? activeConversationPartnerInitial : '?' }} </div> <h3 class="font-semibold text-lg text-green-800">{{ activeConversationPartnerDisplayAddress }}</h3> </div>
                <div class="flex-1 overflow-y-auto p-4 space-y-3 message-view-container bg-gray-100" ref="messageContainer">
                    <div v-if="currentMessages.length === 0" class="text-center text-gray-500 py-10"> No messages in this conversation yet. Say hello! </div>
                    <div v-for="msg in currentMessages" :key="msg.id" class="flex" :class="msg.sender === currentUserIdentifier ? 'justify-end' : 'justify-start'">
                        <div class="max-w-xs md:max-w-md lg:max-w-lg"> <div class="p-3 rounded-xl shadow" :class="msg.sender === currentUserIdentifier ? 'bg-green-600 text-white' : 'bg-white text-gray-800 border'"> <p class="text-sm leading-relaxed">{{ msg.text }}</p> </div> <p class="text-xs mt-1 px-1" :class="msg.sender === currentUserIdentifier ? 'text-gray-400 text-right' : 'text-gray-400 text-left'"> {{ formatTimestamp(msg.timestamp) }} <span v-if="msg.sender === currentUserIdentifier && msg.read"><i class="fas fa-check-double text-blue-400 ml-1" title="Read"></i></span> <span v-if="msg.sender === currentUserIdentifier && !msg.read"><i class="fas fa-check text-gray-400 ml-1" title="Sent"></i></span> </p> </div>
                    </div>
                </div>
                <div class="p-3 border-t bg-gray-50"> <form @submit.prevent="sendMessage" class="flex gap-3 items-center"> <input v-model="messageInputText" type="text" placeholder="Type your message..." class="flex-1 px-4 py-2 border border-gray-300 rounded-full focus:ring-green-500 focus:border-green-500 text-sm" required> <button type="submit" :disabled="!messageInputText.trim()" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-full text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 disabled:opacity-50"> <i class="fas fa-paper-plane mr-1"></i> Send </button> </form> </div>
            </template>
        </div>
      </div>
    </section>
    <section v-if="current==='plantRecomendation'" class="max-w-3xl mx-auto mt-6">
      <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-leaf mr-2"></i>Plant Disease Detection & Recommendation</h2>
       <div v-if="!isUserAuthenticated || role !== 'farmer'" class="text-center p-10 bg-white rounded-lg shadow"> <i class="fas fa-exclamation-circle text-3xl text-yellow-500 mb-4"></i> <p class="text-xl text-gray-700">Please log in as a Farmer to access Plant Recommendation.</p> </div>
      <div v-else class="bg-white rounded shadow-md p-6 space-y-6">
        <p class="text-sm text-gray-600">Upload an image of an affected plant. Gemini AI will attempt to identify the plant, detect diseases, and suggest treatments.</p>

        <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4" role="alert">
          <p class="font-bold">Developer Note:</p>
          <p class="text-sm">The Gemini API key is currently embedded in the client-side code for this demo. In a production environment, this is insecure and should be handled via a backend proxy. Replace `YOUR_GEMINI_API_KEY_HERE` with your key.</p>
        </div>

        <div>
          <label class="block text-gray-600 mb-1 text-sm">Upload Plant Image</label>
          <input type="file" @change="handlePlantImageUpload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
        </div>

        <div v-if="plantImageUrl" class="mt-4">
          <h4 class="text-md font-semibold text-gray-700 mb-2">Image Preview:</h4>
          <img :src="plantImageUrl" alt="Plant Preview" class="max-w-xs md:max-w-sm rounded-md border shadow mx-auto">
        </div>

        <button @click="analyzePlant" :disabled="!plantImageFile || analysisInProgress" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded text-sm flex items-center justify-center" :class="{'opacity-50 cursor-not-allowed': !plantImageFile || analysisInProgress}">
          <i :class="analysisInProgress ? 'fas fa-spinner fa-spin' : 'fas fa-search-plus'" class="mr-2"></i>
          {{ analysisInProgress ? 'Analyzing...' : 'Analyze Plant with Gemini AI' }}
        </button>

        <div v-if="analysisErrorText" class="mt-4 bg-red-100 border border-red-300 text-red-700 px-4 py-3 rounded text-sm">
          <p class="font-bold">Analysis Error:</p>
          <p>{{ analysisErrorText }}</p>
        </div>

        <div v-if="parsedAnalysis.plantName !== null && !analysisInProgress && !analysisErrorText" class="mt-6 border-t pt-6 space-y-4">
          <h3 class="text-xl font-semibold text-green-700">Analysis Results:</h3>
          <div>
            <p class="text-sm font-medium text-gray-500">Identified Plant:</p>
            <p class="text-lg text-gray-800">{{ parsedAnalysis.plantName || 'Could not identify plant.' }}</p>
          </div>
          <div>
            <p class="text-sm font-medium text-gray-500">Detected Disease:</p>
            <p class="text-lg text-gray-800 font-semibold" :class="{'text-red-600': parsedAnalysis.diseaseName && parsedAnalysis.diseaseName.toLowerCase() !== 'healthy' && parsedAnalysis.diseaseName.toLowerCase() !== 'not apparent' && parsedAnalysis.diseaseName.toLowerCase() !== 'unknown' && parsedAnalysis.diseaseName.toLowerCase() !== '-', 'text-green-600': parsedAnalysis.diseaseName && (parsedAnalysis.diseaseName.toLowerCase() === 'healthy' || parsedAnalysis.diseaseName.toLowerCase() === 'not apparent')}">
              {{ parsedAnalysis.diseaseName || 'Could not determine disease.' }}
            </p>
          </div>
          <div>
            <p class="text-sm font-medium text-gray-500">Recommended Treatment / Pesticides:</p>
            <p class="text-md text-gray-700 whitespace-pre-wrap">{{ parsedAnalysis.treatmentRecommended || 'No specific treatment recommended.' }}</p>
          </div>
           <div v-if="analysisResultText && (!parsedAnalysis.plantName || parsedAnalysis.plantName === 'Unknown' || parsedAnalysis.plantName === '-')" class="mt-4 bg-gray-50 p-3 rounded border text-xs">
                <p class="font-semibold mb-1">Raw Gemini Output (for debugging if parsing failed):</p>
                <pre class="whitespace-pre-wrap overflow-x-auto">{{ analysisResultText }}</pre>
            </div>
        </div>
      </div>
    </section>

    <!-- Modals (Purchase Video, Buy Listing, Investment Details, Farmer Profile) -->
     <!-- Purchase Video Modal -->
    <div v-if="selectedPurchase && showPurchaseVideo" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full modal-scrollable">
        <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white z-10"> <h3 class="font-bold text-lg text-green-700">{{ selectedPurchase.crop }} - Purchase Verification</h3> <button @click="showPurchaseVideo = false" class="text-gray-500 hover:text-gray-700"> <i class="fas fa-times"></i> </button> </div>
        <div class="p-4"> <video :src="ipfsUrl(selectedPurchase.cid)" controls playsinline webkit-playsinline class="w-full rounded bg-black mb-4"></video> <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm"> <div> <p class="text-gray-600">Location</p> <p class="font-medium">{{ selectedPurchase.location }}</p> </div> <div> <p class="text-gray-600">Pesticide Used</p> <p class="font-medium">{{ selectedPurchase.pesticide }}</p> </div> <div> <p class="text-gray-600">Pesticide Company</p> <p class="font-medium">{{ selectedPurchase.pesticideCompany || 'N/A' }}</p> </div> <div> <p class="text-gray-600">Purchase Price</p> <p class="font-medium font-mono">{{ selectedPurchase.price }} SOL</p> </div> <div> <p class="text-gray-600">Purchase Date</p> <p class="font-medium">{{ selectedPurchase.date }}</p> </div> <div> <p class="text-gray-600">Seller Identifier</p> <p class="font-medium font-mono text-xs">{{ selectedPurchase.farmerWallet }}</p> </div> </div> <div class="mt-4 bg-gray-100 p-3 rounded text-xs border"> <p class="font-bold mb-1">Platform Verification (Simulated):</p> <p class="font-mono break-all mb-1">IPFS CID: {{ selectedPurchase.cid }}</p> <p class="font-mono break-all">Simulated Tx: {{ selectedPurchase.txHash }} <a :href="solanaExplorerUrl(selectedPurchase.txHash)" target="_blank" class="text-blue-500 hover:text-blue-700"><i class="fas fa-external-link-alt text-xs"></i></a> </p> <p class="mt-1 text-gray-500">Video evidence on IPFS, linked on PestiVid platform (Simulated).</p> <a :href="ipfsUrl(selectedPurchase.cid)" target="_blank" class="text-blue-600 hover:underline mt-1 inline-block">View on IPFS Gateway <i class="fas fa-external-link-alt text-xs ml-1"></i></a> </div> </div>
        <div class="bg-gray-50 p-4 flex justify-end rounded-b-lg sticky bottom-0 border-t"> <button @click="showPurchaseVideo = false" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded text-sm"> Close </button> </div>
      </div>
    </div>
    <!-- Buy Listing Modal -->
    <div v-if="showBuyModal && selectedListing" class="fixed inset-0 z-50 bg-black bg-opacity-60 flex justify-center items-center p-4">
      <div class="bg-white rounded shadow-lg w-full max-w-sm p-6 relative mx-2 modal-scrollable">
        <button class="absolute top-2 right-2 text-gray-400 hover:text-red-500" @click="closeBuyModal"><i class="fas fa-times"></i></button>
        <h3 class="font-bold text-green-700 text-lg mb-3">Purchase Crop Batch</h3>
        <video :src="ipfsUrl(selectedListing.cid)" controls playsinline webkit-playsinline class="rounded w-full mb-3 bg-black"></video>
        <div class="mb-1 font-bold">{{ selectedListing.crop }}</div> <div class="text-xs text-gray-600 mb-1">Location: <span class="font-mono">{{ selectedListing.location }}</span></div> <div class="text-xs text-gray-500 mb-1">Pesticide: <span class="font-mono">{{ selectedListing.pesticide }}</span></div> <div class="text-xs text-gray-500 mb-2">Pesticide Co.: <span class="font-mono">{{ selectedListing.pesticideCompany || 'N/A' }}</span></div> <div class="text-sm my-2">Price Range: <br><span class="font-mono text-base font-semibold">{{ selectedListing.minPrice }}</span> - <span class="ml-1 font-mono font-semibold">{{ selectedListing.maxPrice }}</span> SOL </div>
        <form @submit.prevent="processPurchase"> <label class="text-sm block text-gray-600 mb-1">Your Offer (SOL)</label> <input type="number" v-model.number="purchaseAmount" :min="selectedListing.minPrice" :max="selectedListing.maxPrice" step="0.01" required :placeholder="`Enter amount (${selectedListing.minPrice}-${selectedListing.maxPrice})`" class="w-full px-3 py-2 border rounded mb-3 text-sm"> <button type="submit" class="bg-green-600 hover:bg-green-700 text-white w-full py-2 rounded text-sm" :disabled="!isUserAuthenticated"> <i class="fas fa-check mr-1"></i>Confirm Purchase (Simulated) </button> </form>
        <div v-if="purchaseStatus" class="text-green-700 font-semibold mt-3 text-sm bg-green-50 p-2 rounded border border-green-200">{{purchaseStatus}}</div> <div v-if="purchaseError" class="text-red-600 font-semibold mt-3 text-sm bg-red-50 p-2 rounded border border-red-200">{{purchaseError}}</div>
      </div>
    </div>
    <!-- Investment Details Modal -->
    <div v-if="showInvestmentDetailsModal && selectedInvestment" class="fixed inset-0 z-50 bg-black bg-opacity-70 flex justify-center items-center p-4">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl relative mx-2 modal-scrollable">
        <div class="p-4 bg-green-50 border-b flex justify-between items-center sticky top-0 z-10"> <h3 class="font-bold text-lg text-green-800">{{ selectedInvestment.projectTitle }}</h3> <button class="text-gray-400 hover:text-red-500" @click="showInvestmentDetailsModal=false"><i class="fas fa-times"></i></button> </div>
        <div class="p-6"> <div class="flex flex-col md:flex-row gap-6"> <div class="md:w-1/3"> <video :src="ipfsUrl(selectedInvestment.cid)" controls playsinline webkit-playsinline class="rounded w-full h-40 object-cover bg-black mb-3"></video> <div class="mt-3 space-y-2 text-sm"> <div> <div class="text-xs text-gray-500">Farmer Identifier</div> <div class="font-medium flex items-center font-mono text-xs"> <span>{{ selectedInvestment.farmerWallet }}</span> <button @click="showFarmerProfile(selectedInvestment.farmerWallet); showInvestmentDetailsModal=false;" class="ml-2 text-blue-500 hover:text-blue-700 text-xs focus:outline-none" title="View Farmer Info"> <i class="fas fa-info-circle"></i> </button> <button @click="startOrGoToConversation(selectedInvestment.farmerWallet); showInvestmentDetailsModal=false;" v-if="isUserAuthenticated && currentUserIdentifier !== selectedInvestment.farmerWallet" class="ml-2 text-green-600 hover:text-green-700 text-xs focus:outline-none" title="Message Farmer"> <i class="fas fa-envelope"></i> </button> </div> </div> <div> <div class="text-xs text-gray-500">Investment Date</div> <div class="font-medium">{{ selectedInvestment.investmentDate }}</div> </div> <div> <div class="text-xs text-gray-500">Amount Invested</div> <div class="font-medium text-green-700 font-mono">{{ selectedInvestment.amount }} SOL</div> </div> <div> <div class="text-xs text-gray-500">Status</div> <span :class="{'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true, 'bg-blue-100 text-blue-800': selectedInvestment.status === 'active', 'bg-green-100 text-green-800': selectedInvestment.status === 'harvested', 'bg-yellow-100 text-yellow-800': selectedInvestment.status === 'growing'}"> {{ selectedInvestment.status === 'active' ? 'Active' : selectedInvestment.status === 'harvested' ? 'Harvested' : (selectedInvestment.status === 'growing' ? 'Growing' : selectedInvestment.status) }} </span> </div> </div> </div> <div class="md:w-2/3"> <div class="mb-4"> <div class="text-sm font-medium mb-1">{{ selectedInvestment.crop }} ({{ selectedInvestment.method }})</div> <p class="text-sm text-gray-700 max-h-24 overflow-y-auto border p-2 rounded bg-gray-50">{{ selectedInvestment.description }}</p> </div> <div class="mb-4"> <div class="text-xs text-gray-500 mb-1">Project Progress</div> <div class="progress-bar"> <div class="progress-fill bg-green-500" :style="{width: selectedInvestment.progress + '%'}"></div> </div> <div class="flex justify-between text-xs mt-1"> <span>{{ selectedInvestment.progress }}% Complete</span> <span>Est. {{ selectedInvestment.timeline }} months total</span> </div> </div> <div class="grid grid-cols-2 gap-4 mb-4 text-sm"> <div> <div class="text-xs text-gray-500">Expected Return (Est.)</div> <div class="font-medium text-green-700 font-mono">{{ calculateExpectedReturn(selectedInvestment) }} SOL</div> </div> <div> <div class="text-xs text-gray-500">ROI (Est.)</div> <div class="font-medium text-green-700">{{ selectedInvestment.roi }}%</div> </div> <div> <div class="text-xs text-gray-500">Land Size</div> <div class="font-medium">{{ selectedInvestment.acres }} acres</div> </div> <div> <div class="text-xs text-gray-500">Your Share</div> <div class="font-medium">{{ selectedInvestment.investorShare }}%</div> </div> </div> <div v-if="selectedInvestmentProject && selectedInvestmentProject.updates && selectedInvestmentProject.updates.length > 0" class="mb-4"> <h4 class="text-sm font-semibold text-gray-700 mb-2">Farmer Updates</h4> <div class="project-updates-list text-xs"> <div v-for="update in selectedInvestmentProject.updates.slice().reverse()" :key="update.id" class="project-update-item"> <span class="font-medium text-gray-500">{{ update.date }}:</span> {{ update.text }} </div> </div> </div> <div v-else-if="selectedInvestmentProject" class="mb-4 text-xs text-gray-500"> No project updates posted by the farmer yet. </div> <div class="bg-gray-100 p-3 rounded mb-4 border"> <div class="text-sm font-medium mb-1">Platform Transaction (Simulated)</div> <div class="flex items-center text-xs"> <span class="font-mono bg-white px-2 py-1 rounded border mr-2 truncate" :title="selectedInvestment.txHash">{{ selectedInvestment.txHash }}</span> <a :href="solanaExplorerUrl(selectedInvestment.txHash)" target="_blank" class="text-blue-600 hover:underline whitespace-nowrap"> <i class="fas fa-external-link-alt"></i> View (Demo Link) </a> </div> </div> <div v-if="selectedInvestment.status === 'harvested'" class="bg-green-100 p-3 rounded border border-green-200"> <div class="flex items-center"> <i class="fas fa-check-circle text-green-600 mr-2 text-lg"></i> <div> <div class="font-medium">Harvest Completed & Payout Processed (Sim.)</div> <div class="text-sm">Your simulated return of {{ calculateExpectedReturn(selectedInvestment) }} SOL was processed.</div> </div> </div> </div> <div v-else-if="selectedInvestment.status === 'growing'" class="bg-yellow-50 p-3 rounded border border-yellow-200"> <div class="flex items-center"> <i class="fas fa-hourglass-half text-yellow-600 mr-2 text-lg"></i> <div> <div class="font-medium">Project Growing</div> <div class="text-sm">Harvest expected within {{ selectedInvestment.timeline }} months. Progress: {{selectedInvestment.progress}}%.</div> </div> </div> </div> </div> </div> </div>
        <div class="bg-gray-50 p-4 flex justify-end rounded-b-lg sticky bottom-0 border-t"> <button @click="showInvestmentDetailsModal=false" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded text-sm"> Close </button> </div>
      </div>
    </div>
    <!-- Farmer Profile Modal -->
    <div v-if="showFarmerProfileModal && selectedFarmerProfile" class="fixed inset-0 z-50 bg-black bg-opacity-70 flex justify-center items-center p-4">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-lg relative mx-2 modal-scrollable">
        <div class="p-4 bg-green-50 border-b flex justify-between items-center sticky top-0 z-10"> <h3 class="font-bold text-lg text-green-800 flex items-center"> <i class="fas fa-user-tie mr-2"></i> Farmer Profile </h3> <button class="text-gray-400 hover:text-red-500" @click="closeFarmerProfileModal"><i class="fas fa-times"></i></button> </div>
        <div class="p-6 space-y-5"> <div class="flex items-center space-x-4"> <div class="bg-green-100 rounded-full w-16 h-16 flex items-center justify-center text-green-600 text-2xl"> <i class="fas fa-tractor"></i> </div> <div> <p class="text-xs text-gray-500">Farmer Identifier</p> <p class="font-semibold text-lg text-green-700 font-mono">{{ getFarmerDisplayIdentifier(selectedFarmerProfile.walletAddress, 10) }}</p> <p class="text-sm text-gray-600">Farm Name (Sim.): {{ selectedFarmerProfile.farmName || 'N/A' }}</p> </div> </div> <div class="border-t pt-4"> <p class="text-xs text-gray-500">Short Bio (Simulated)</p> <p class="text-sm text-gray-700 italic">{{ selectedFarmerProfile.bio || 'This farmer has not provided a bio yet.' }}</p> </div> <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-4"> <div> <p class="text-xs text-gray-500">PestiVid Email</p> <p class="text-sm">{{ selectedFarmerProfile.email }}</p> </div> <div> <p class="text-xs text-gray-500">PestiVid Member Since</p> <p class="text-sm">{{ selectedFarmerProfile.memberSince }}</p> </div> </div> <div class="border-t pt-4"> <p class="text-sm font-medium text-gray-700 mb-2">Platform Activity:</p> <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm"> <div class="bg-gray-100 p-3 rounded-md"> <p class="font-semibold">{{ selectedFarmerProfile.fundingRequestCount }}</p> <p class="text-xs text-gray-500">Active Funding Request(s)</p> </div> <div class="bg-gray-100 p-3 rounded-md"> <p class="font-semibold">{{ selectedFarmerProfile.activeListingCount }}</p> <p class="text-xs text-gray-500">Active Marketplace Listing(s)</p> </div> </div> <p class="text-xs text-gray-400 mt-2">(Note: Activity based on currently visible items on the platform.)</p> </div> </div>
        <div class="bg-gray-50 p-4 flex justify-between items-center rounded-b-lg sticky bottom-0 border-t"> <button @click="messageFarmerFromProfile" v-if="isUserAuthenticated && selectedFarmerProfile && currentUserIdentifier !== selectedFarmerProfile.walletAddress" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm"> <i class="fas fa-paper-plane mr-1"></i> Send Message </button> <div v-else class="w-full"></div> <button @click="closeFarmerProfileModal" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded text-sm"> Close </button> </div>
      </div>
    </div>


    <!-- Notification Toast Container -->
    <div class="notification-toast-container">
        <div v-for="n in recentNotifications" :key="n.id" class="notification-toast" :class="{'show': n.show}" :data-notif-id="n.id"> <span :class="['icon', 'icon-' + n.type]"> <i :class="n.type === 'success' ? 'fas fa-check-circle' : (n.type === 'info' ? 'fas fa-info-circle' : (n.type === 'warning' ? 'fas fa-exclamation-triangle' : 'fas fa-bug'))"></i> </span> <span class="message">{{ n.message }}</span> <button @click="dismissNotification(n.id)" class="close-btn">&times;</button> </div>
    </div>
    <!-- Loading/Transaction Modal -->
    <div v-if="showLoadingModal" class="loading-modal"> <div class="loading-content"> <i class="fas fa-spinner fa-spin"></i> <p class="text-gray-700">{{ loadingMessage }}</p> </div> </div>
  </main>

  <footer class="bg-white border-t py-6 mt-auto text-center text-sm text-gray-500">
    <span>© {{ new Date().getFullYear() }} PestiVid • Blockchain Agricultural Platform (Web3 Demo)</span>
  </footer>
</div>
<script>  
const app = new Vue({
    el: "#app",
    data: {
      current: 'landing',
      showMobileMenu: false,

      // --- Authentication State ---
      loginMethod: null, // 'solana' or 'orangeId'
      currentUserIdentifier: null, // Solana wallet address or Orange ID user subject/ID
      isAuthProcessing: false, // General auth processing flag

      // --- Orange ID Specific State ---
      orangeIdUser: null, // Stores the user object from Orange ID SDK
      orangeIdBedrockSDK: null, // Will hold the Bedrock instance (initialized implicitly by BedrockPassportProvider)
      orangeIdReactRootLogin: null, // React root for LoginPanel
      orangeIdReactRootCallback: null, // React root for CallbackProcessor
      orangeIdReactRootSignOut: null, // React root for SignOutButton
      orangeIdReactRootSignOutMobile: null, // React root for SignOutButton mobile
      orangeIdWidgetMounted: false,
      orangeIdBedrockSDKError: false,
      isOrangeIdCallback: false, // True if current URL is an Orange ID callback
      bedrockConfig: {
        baseUrl: 'https://api.bedrockpassport.com',
        // IMPORTANT: Ensure this authCallbackUrl EXACTLY MATCHES what you've set in your Orange ID project dashboard.
        // This should be the base URL of your application where you open this HTML file.
        // Example: If you open the file at https://localhost:8080/pestivid.html, set the callback to https://localhost:8080/pestivid.html
        authCallbackUrl: window.location.origin + window.location.pathname, // Attempts to derive base URL dynamically
        // !!! REPLACE THESE WITH YOUR ACTUAL ORANGE ID PROJECT DETAILS !!!
        tenantId: 'YOUR_ORANGE_ID_TENANT_ID', // e.g., 'orange-xxxxxxxxxx'
        subscriptionKey: 'YOUR_ORANGE_ID_API_KEY' // e.g., 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'
        // !!! END OF ORANGE ID PLACEHOLDERS !!!
      },

      // Solana Wallet Specific State
      walletAddress: null,

      // Unified PestiVid User Profile Data
      role: '',
      userName: '',
      userEmail: '',
      userPhone: '',
      memberSince: '',
      farmerLocationCity: '',

      // Onboarding State
      selectedRoleOnboarding: '',
      userNameOnboarding: '',
      userEmailOnboarding: '',
      userPhoneOnboarding: '',
      farmerLocationCityOnboarding: '',

      // PestiVid Feature State
      recordForm: {crop:'', pesticide:'', location:'', pesticideCompany: '', purpose: 'agristream'},
      recordStream: null, recordMediaRecorder: null, recording: false, recordBlob: null, recordBlobUrl: '',
      showLive: false, uploadCid: '', uploading: false, uploadError: '', lastUploadedVideoPurpose: '',
      farmerVideos: [], farmerListings: [], listingForm: {cid:'', minPrice:'', maxPrice:'', notifyBuyers: true},
      createdListingId: null, listingNotificationSent: false,
      farmerFundingRequests: [],
      fundingForm: { title: '', crop: '', acres: null, amount: null, method: '', cid: '', description: '', timeline: null, roi: null, investorShare: null, notifyInvestors: true },
      createdFundingRequest: false,
      newUpdateText: {},
      buyerPurchases: [], selectedPurchase: null, showPurchaseVideo: false,
      allListings: [], buyerFilters: {crop:'', location:'', pesticideCompany: ''}, showBuyModal: false,
      selectedListing: null, purchaseAmount: null, purchaseStatus: '', purchaseError: '',
      investorInvestments: [], investorTransactions: [],
      investorFilters: {crop: '', method: '', minRoi: null, maxAmount: null},
      allFundingRequests: [], investmentAmounts: {}, investmentErrors: {},
      showInvestmentDetailsModal: false, selectedInvestment: null, selectedInvestmentProject: null,
      showFarmerProfileModal: false, selectedFarmerProfile: null,

      // !!! REPLACE 'YOUR_PINATA_JWT' with your actual Pinata JWT. Video uploads WILL FAIL without it. !!!
      pinataJwt: 'YOUR_PINATA_JWT',
      // !!! REPLACE 'YOUR_PINATA_GATEWAY_HOSTNAME' (e.g., 'your-gateway-name.mypinata.cloud' or 'gateway.pinata.cloud'). Video playback WILL FAIL without it. !!!
      pinataGateway: 'YOUR_PINATA_GATEWAY_HOSTNAME', // e.g., 'gateway.pinata.cloud' or your dedicated gateway hostname

      // !!! REPLACE 'YOUR_OPENWEATHERMAP_API_KEY'. Weather feature WILL NOT WORK without it. !!!
      weatherApiKey: 'YOUR_OPENWEATHERMAP_API_KEY',

      // !!! REPLACE 'YOUR_GEMINI_API_KEY_HERE'. Plant recommendation WILL FAIL without it. !!!
      // Client-side API keys are insecure for production. Use a backend proxy.
      geminiApiKey: 'YOUR_GEMINI_API_KEY_HERE',
      plantImageFile: null,
      plantImageUrl: null,
      plantImageMimeType: null,
      analysisInProgress: false,
      analysisResultText: '',
      parsedAnalysis: { plantName: null, diseaseName: null, treatmentRecommended: null },
      analysisErrorText: '',


      conversations: [], messages: [], activeConversationId: null, messageInputText: '',
      notifications: [], recentNotifications: [],
      showLoadingModal: false, loadingMessage: '',
      targetAgriStreamVideoCid: null, highlightedAgriStreamVideoCid: null,
    },
    computed: {
      isUserAuthenticated() {
          return !!this.currentUserIdentifier && !this.isAuthProcessing; // Remove isOrangeIdCallback check here
      },
      displayedUserIdentifier() {
          if (!this.currentUserIdentifier) return '';
          if (this.userName) return this.userName.split(' ')[0];

          if (this.loginMethod === 'orangeId' && this.orangeIdUser) {
              const nameOrEmail = (this.orangeIdUser.name || this.orangeIdUser.email || this.currentUserIdentifier);
              return nameOrEmail.split(' ')[0] || 'OrangeID User'; // Fallback name
          }
          if (this.loginMethod === 'solana' && this.walletAddress) {
              const id = this.walletAddress.toString();
              return `${id.substring(0, 6)}...${id.substring(id.length - 4)}`;
          }
          const shortId = String(this.currentUserIdentifier); // Ensure it's a string
          return shortId.substring(0,8) + '...'; // Generic fallback
      },
      uniqueCrops() { const crops = this.allListings.map(l=>l.crop).filter(Boolean); return [...new Set(crops)].sort(); },
      filteredListings() { const oneDayAgo = Date.now() - (24*60*60*1000); return this.allListings.map(l => ({...l, isNew: new Date(l.createdAt).getTime() > oneDayAgo })).filter(l => { const cropMatch = !this.buyerFilters.crop || (l.crop || '').toLowerCase() === this.buyerFilters.crop.toLowerCase(); const locMatch = !this.buyerFilters.location || (l.location || '').toLowerCase().includes(this.buyerFilters.location.toLowerCase()); const companyMatch = !this.buyerFilters.pesticideCompany || (l.pesticideCompany || '').toLowerCase().includes(this.buyerFilters.pesticideCompany.toLowerCase()); return cropMatch && locMatch && companyMatch; }); },
      availableVideosForListing() { if (!this.isUserAuthenticated) return []; const listedCids = new Set(this.farmerListings.map(l => l.cid)); return this.farmerVideos.filter(v => v.farmerWallet === this.currentUserIdentifier && (v.purpose === 'sell' || v.purpose === 'agristream') && !listedCids.has(v.cid)); },
      availableVideosForFunding() { if (!this.isUserAuthenticated) return []; const fundingCids = new Set(this.farmerFundingRequests.map(r => r.cid)); return this.farmerVideos.filter(v => v.farmerWallet === this.currentUserIdentifier && (v.purpose === 'funding' || v.purpose === 'agristream') && !fundingCids.has(v.cid)); },
      uniqueFundingCrops() { const crops = this.allFundingRequests.map(r=>r.crop).filter(Boolean); return [...new Set(crops)].sort(); },
      filteredFundingRequests() { const oneDayAgo = Date.now() - (24*60*60*1000); return this.allFundingRequests.map(r => ({ ...r, isNew: new Date(r.createdAt).getTime() > oneDayAgo })).filter(r => { const isRelevantStatus = r.status === 'pending' || r.status === 'partially_funded'; const cropMatch = !this.investorFilters.crop || (r.crop||'').toLowerCase() === this.investorFilters.crop.toLowerCase(); const methodMatch = !this.investorFilters.method || (r.method||'').toLowerCase() === this.investorFilters.method.toLowerCase(); const roiMatch = !this.investorFilters.minRoi || r.roi >= this.investorFilters.minRoi; const amountMatch = !this.investorFilters.maxAmount || r.amount <= this.investorFilters.maxAmount; return isRelevantStatus && cropMatch && methodMatch && roiMatch && amountMatch; }); },
      totalInvestedAmount() { if (!this.investorInvestments || this.investorInvestments.length === 0) return '0.00'; return this.investorInvestments.reduce((sum, inv) => sum + inv.amount, 0).toFixed(2); },
      investorActiveProjects() { if (!this.investorInvestments) return 0; return this.investorInvestments.filter(inv => inv.status === 'active' || inv.status === 'growing').length; },
      investorCompletedProjects() { if (!this.investorInvestments) return 0; return this.investorInvestments.filter(inv => inv.status === 'harvested').length; },
      investorAvgRoi() { if (!this.investorInvestments || this.investorInvestments.length === 0) return '0.0'; const totalWeightedRoi = this.investorInvestments.reduce((sum, inv) => sum + (inv.amount * (inv.roi / 100)), 0); const totalInvested = this.investorInvestments.reduce((sum, inv) => sum + inv.amount, 0); return totalInvested > 0 ? ((totalWeightedRoi / totalInvested) * 100).toFixed(1) : '0.0'; }, // Weighted average ROI
      userConversations() { if (!this.isUserAuthenticated) return []; return this.conversations.filter(conv => conv.participants.includes(this.currentUserIdentifier)).sort((a, b) => new Date(b.lastMessageTimestamp).getTime() - new Date(a.lastMessageTimestamp).getTime()); },
      currentMessages() { if (!this.activeConversationId || !this.isUserAuthenticated) return []; return this.messages.filter(msg => msg.conversationId === this.activeConversationId).sort((a, b) => new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime()); },
      activeConversationPartnerIdentifier() { if (!this.activeConversationId || !this.isUserAuthenticated) return null; const conv = this.conversations.find(c => c.id === this.activeConversationId); if (!conv) return null; return conv.participants.find(p => p !== this.currentUserIdentifier); },
      activeConversationPartnerDisplayAddress() { const partnerId = this.activeConversationPartnerIdentifier; if (!partnerId) return '?'; const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles')) || {}; const partnerProfile = userProfiles[partnerId]; if(partnerProfile && partnerProfile.name) return partnerProfile.name.split(" ")[0]; return `${String(partnerId).substring(0,6)}...${String(partnerId).substring(String(partnerId).length-4)}`; },
      activeConversationPartnerInitial() { const partnerDisplay = this.activeConversationPartnerDisplayAddress; if (!partnerDisplay || partnerDisplay === '?') return '?'; return partnerDisplay.charAt(0).toUpperCase(); },
      unreadMessageCount() { if (!this.isUserAuthenticated) return 0; return this.messages.filter(msg => msg.receiver === this.currentUserIdentifier && !msg.read).length; },
    },
    watch: {
      current(newPage, oldPage) {
          window.scrollTo(0,0);
          if (newPage === 'farmerAgriStream' && this.targetAgriStreamVideoCid) { this.scrollToAndHighlightAgriStreamVideo(); }
          else if (newPage !== 'farmerAgriStream') { this.highlightedAgriStreamVideoCid = null; } // Clear highlight when leaving the page

          // Ensure Orange ID login widget is mounted only on loginChoice page when not authenticated
           if (newPage === 'loginChoice' && !this.isUserAuthenticated && !this.isAuthProcessing && !this.isOrangeIdCallback) {
              this.$nextTick(() => this.renderOrangeIdLoginWidget());
          } else if (oldPage === 'loginChoice' && newPage !== 'loginChoice') {
              this.$nextTick(() => this.unmountOrangeIdLoginWidget());
          }

          // Clear Plant Recommend state if leaving the page
          if (oldPage === 'plantRecomendation' && newPage !== 'plantRecomendation') {
              this.plantImageFile = null; this.plantImageUrl = null; this.plantImageMimeType = null;
              this.analysisResultText = ''; this.parsedAnalysis = { plantName: null, diseaseName: null, treatmentRecommended: null };
              this.analysisErrorText = '';
          }

          // Ensure logged-in users are on a role-appropriate page or onboarding
          if (this.isUserAuthenticated && !this.isOrangeIdCallback && !this.isAuthProcessing) {
              const nonPortalPages = ['landing', 'loginChoice', 'roleSelection'];
              if (!this.role && newPage !== 'roleSelection') {
                 // If user is authenticated but has no role, force to role selection (unless on landing)
                  if (newPage !== 'landing') {
                     console.log(`[Watcher:current] User authenticated (No Role), on ${newPage}. Redirecting to roleSelection.`);
                     this.switchPage('roleSelection');
                  }
              } else if (this.role && nonPortalPages.includes(newPage)) {
                  // If user is authenticated and has a role, prevent staying on login/onboarding/landing
                   console.log(`[Watcher:current] User authenticated (Role: ${this.role}), on ${newPage}. Redirecting via getStarted().`);
                   this.getStarted();
              } else if (newPage === 'messaging' && this.activeConversationId) {
                   this.scrollToMessageBottom(); // Scroll to bottom if opening messaging with an active chat
                   this.markConversationAsRead(this.activeConversationId); // Mark as read when viewing
              } else if (newPage === 'investorPortfolio' && this.role === 'investor') {
                  this.updateInvestmentProgress(); // Update progress when viewing portfolio
              } else if (newPage === 'userProfile' && this.role === 'farmer' && this.farmerLocationCity && !this.currentWeather) {
                   this.fetchWeather(); // Fetch weather if on profile page as farmer and city is set
              }
          }
      },
       // Watch for authentication state changes
      isUserAuthenticated(isAuthenticated, wasAuthenticated) {
          console.log("[Watcher:isUserAuthenticated] State changed:", wasAuthenticated, "->", isAuthenticated);
          if (isAuthenticated) {
              // User just became authenticated or was already authenticated on mount
               this.filterDataForCurrentUser(); // Ensure data for *this* user is loaded
               this.$nextTick(() => {
                   if (this.loginMethod === 'orangeId') {
                       this.renderOrangeIdSignOutButton('orange-id-signout-button-container');
                       if (this.showMobileMenu) {
                           this.renderOrangeIdSignOutButton('orange-id-signout-button-container-mobile', true);
                       }
                   }
                   // The redirection to roleSelection or role-specific page is handled by handleAuthenticationSuccess -> loadOrSetupPestiVidProfile -> getStarted
                   // or by the 'current' watcher if the user lands on a wrong page after auth state is set.
               });
          } else if (wasAuthenticated) {
              // User just logged out
              console.log("[Watcher:isUserAuthenticated] User logged out. Clearing session data.");
              this.clearUserSession(true); // Clear PestiVid session data and notify
              // Redirection to landing is handled within clearUserSession
          }
      },
      // Watch for role changes (happens after onboarding completes)
      role(newRole, oldRole) {
            console.log("[Watcher:role] Role changed:", oldRole, "->", newRole);
            if (newRole && this.isUserAuthenticated && !this.isOrangeIdCallback && !this.isAuthProcessing) {
                // User just got a role (completed onboarding) or role was loaded
                console.log(`[Watcher:role] Role became ${newRole}. Authenticated. Navigating via getStarted().`);
                this.filterDataForCurrentUser(); // Load data specific to the new role
                 this.$nextTick(() => {
                     this.getStarted(); // Navigate to the correct start page for the new role
                 });
            }
        },
      showMobileMenu(isShown) {
          // Manage Orange ID sign-out button rendering for mobile menu
          if (isShown && this.isUserAuthenticated && this.loginMethod === 'orangeId') {
              this.$nextTick(() => { this.renderOrangeIdSignOutButton('orange-id-signout-button-container-mobile', true); });
          } else if (!isShown && this.loginMethod === 'orangeId') {
              // Add a small delay in case menu close animation is slow
              setTimeout(() => this.unmountOrangeIdSignOutButton('orange-id-signout-button-container-mobile'), 50);
          }
      },
      farmerVideos: {
          handler(newVideos) {
               // If we were targeting a video for highlight/scroll and it appears in the loaded list
               if (this.current === 'farmerAgriStream' && this.targetAgriStreamVideoCid) {
                   if (newVideos.some(v => v.cid === this.targetAgriStreamVideoCid)) {
                       this.scrollToAndHighlightAgriStreamVideo();
                   }
               }
          },
          deep: true
      },
      notifications: {
         handler() {
             // Auto-show notifications as they are added, up to a limit
             if (this.recentNotifications.length < 3 && this.notifications.length > 0) {
                 this.showNextToastNotification();
             }
         },
         deep: true
      },
      currentMessages: {
          handler() {
              // Scroll to bottom when messages update in active conversation
              if (this.current === 'messaging' && this.activeConversationId) {
                 this.scrollToMessageBottom();
              }
          },
          deep: true
      },
    },
    methods: {
      switchPage(page) {
        this.current = page;
        this.showMobileMenu = false; // Close mobile menu on navigation
      },
      navigateToPageWithParam(page, paramName, paramValue) {
        // Helper to navigate and pass a parameter (used for pre-selecting video in forms or highlighting)
        if (page === 'farmerSell' && paramName === 'cid') {
            this.listingForm.cid = paramValue;
        } else if (page === 'farmerFunding' && paramName === 'cid') {
            this.fundingForm.cid = paramValue;
        } else if (page === 'farmerAgriStream' && paramName === 'highlightCid') {
            this.targetAgriStreamVideoCid = paramValue;
        }
        this.switchPage(page);
      },
      getStarted() {
          console.log(`getStarted called. Auth: ${this.isUserAuthenticated}, Role: ${this.role}, Current: ${this.current}, isOrangeIdCallback: ${this.isOrangeIdCallback}`);
           if (this.isOrangeIdCallback || this.isAuthProcessing) {
              console.log("getStarted: Auth processing, delaying navigation.");
              // Wait for auth processing to complete
              return;
           }

          if (!this.isUserAuthenticated) {
              console.log("getStarted: Not authenticated, navigating to loginChoice.");
              this.switchPage('loginChoice');
          } else if (!this.role) {
              console.log("getStarted: Authenticated, no role, navigating to roleSelection.");
              this.switchPage('roleSelection');
          } else {
              console.log(`getStarted: Authenticated with role ${this.role}. Navigating to specific portal page.`);
              // Navigate to the appropriate starting page based on role
              if (this.role === 'farmer') {
                  this.switchPage('farmerPestiVid');
              } else if (this.role === 'buyer') {
                  this.switchPage('buyerAgriSell');
              } else if (this.role === 'investor') {
                  this.switchPage('investorProjects');
              } else {
                  console.warn(`getStarted: Unknown role "${this.role}". Defaulting to landing.`);
                  this.switchPage('landing'); // Fallback
              }
          }
      },
      handleAuthenticationSuccess(identifier, method, orangeUserDetails = null) {
          console.log("PestiVid Auth Success (Method Call):", method, "Identifier:", identifier, "Details:", orangeUserDetails);

          // Set authentication state
          this.currentUserIdentifier = identifier;
          this.loginMethod = method;
          this.isAuthProcessing = false;
          this.isOrangeIdCallback = false; // Ensure this is false after processing callback

          // Store user details based on method
          if (method === 'orangeId' && orangeUserDetails) {
              this.orangeIdUser = orangeUserDetails;
              this.walletAddress = null; // Ensure Solana wallet is cleared if logged in via Orange ID
          } else if (method === 'solana') {
              this.walletAddress = identifier;
              this.orangeIdUser = null; // Ensure Orange ID user is cleared if logged in via Solana
          }

          this.showLoadingModal = false; // Hide loading indicator

          this.addNotification(`${method === 'orangeId' ? 'Orange ID' : 'Solana Wallet'} authentication successful!`, 'success');

          // Proceed to load or set up the PestiVid profile
          this.loadOrSetupPestiVidProfile();

          // Ensure React SignOut button is rendered for Orange ID
           if (method === 'orangeId') {
               this.$nextTick(() => {
                    this.renderOrangeIdSignOutButton('orange-id-signout-button-container');
                    if (this.showMobileMenu) {
                        this.renderOrangeIdSignOutButton('orange-id-signout-button-container-mobile', true);
                    }
               });
           }
      },
      initializeOrangeIdSDK() {
         // Check if necessary libraries are loaded
        if (typeof window.React === 'undefined' || typeof window.ReactDOM === 'undefined' || typeof window.Bedrock === 'undefined') {
            console.error('Error: Orange ID - Required Libraries (React, ReactDOM, Bedrock) not loaded.');
            this.orangeIdBedrockSDKError = true;
             this.addNotification("Orange ID login service failed to load.", "error");
            return false;
        }

        // Check if configuration is set
        if (!this.bedrockConfig.tenantId || this.bedrockConfig.tenantId.toUpperCase().includes("YOUR_") ) {
            console.error("CONFIG ERROR: Orange ID Tenant ID not set or is placeholder. Orange ID login WILL FAIL.");
            this.orangeIdBedrockSDKError = true;
             this.addNotification("Orange ID Tenant ID config error. Login unavailable.", "error");
            return false;
        }
         if (!this.bedrockConfig.subscriptionKey || this.bedrockConfig.subscriptionKey.toUpperCase().includes("YOUR_") ) {
            console.error("CONFIG ERROR: Orange ID Subscription Key (API Key) not set or is placeholder. Orange ID login WILL FAIL.");
            this.orangeIdBedrockSDKError = true;
             this.addNotification("Orange ID API Key config error. Login unavailable.", "error");
            return false;
        }
        // If configs are set and libs loaded, SDK is ready to be used by components
        this.orangeIdBedrockSDKError = false;
        return true;
      },
      renderOrangeIdLoginWidget() {
        // Render the Orange ID LoginPanel React component
        if (!this.initializeOrangeIdSDK() || this.orangeIdWidgetMounted) return;
        const container = document.getElementById('orange-id-login-container');
        if (!container) {
            console.error("Orange ID login container not found.");
            return;
        }
        this.unmountOrangeIdLoginWidget(); // Ensure no previous widget is active

        this.orangeIdReactRootLogin = ReactDOM.createRoot(container);
        try {
            this.orangeIdReactRootLogin.render(
                React.createElement(
                    Bedrock.BedrockPassportProvider, // Wrap with BedrockPassportProvider
                    this.bedrockConfig,
                    React.createElement(Bedrock.LoginPanel, { // The actual LoginPanel component
                        title: "Sign in to PestiVid",
                         // Replace with your actual logo URL if you have one
                        logo: "https://raw.githubusercontent.com/sindukuriteja/PestiVid/main/media/pestivid-logo.png",
                        logoAlt: "PestiVid Logo",
                        showConnectWallet: false, // We handle Solana connection separately in Vue
                        separatorText: "OR",
                        features: {
                            enableWalletConnect: false, // Ensure WalletConnect is disabled in Bedrock if handling Solana directly
                            enableAppleLogin: true,
                            enableGoogleLogin: true,
                            enableEmailLogin: true,
                        },
                    })
                )
            );
            this.orangeIdWidgetMounted = true;
             console.log("Orange ID LoginPanel rendered.");
        } catch (e) {
            console.error("Error rendering Orange ID LoginPanel:", e);
            this.orangeIdBedrockSDKError = true;
            container.innerHTML = '<p class="text-red-500 p-4 text-sm"><i class="fas fa-exclamation-triangle mr-2"></i>Failed to render social login widget. Check API Keys in code and console for details.</p>';
             this.addNotification("Failed to load social login widget. Check console.", "error");
        }
      },
      unmountOrangeIdLoginWidget() {
        // Unmount the Orange ID LoginPanel React component
        if (this.orangeIdReactRootLogin) {
            try {
                 this.orangeIdReactRootLogin.unmount();
                 console.log("Orange ID LoginPanel unmounted.");
            } catch(e) { console.warn("Error unmounting Orange ID login widget:", e); }
            this.orangeIdReactRootLogin = null;
            this.orangeIdWidgetMounted = false;
             const container = document.getElementById('orange-id-login-container');
             if (container) container.innerHTML = ''; // Clear container content
        }
      },
      renderOrangeIdCallbackProcessor() {
        // Render the Orange ID CallbackProcessor React component
        if (!this.initializeOrangeIdSDK()) {
             // If SDK init fails, we can't process the callback. Redirect.
             console.error("SDK not initialized, cannot render CallbackProcessor.");
             this.addNotification("Authentication error: SDK not ready.", "error");
             this.isOrangeIdCallback = false;
             this.isAuthProcessing = false;
             this.switchPage('loginChoice'); // Redirect to login page
             return;
         }

        const container = document.getElementById('orange-id-callback-processor');
        if (!container) {
             console.error("Orange ID callback processor container not found.");
             this.addNotification("Login callback error: UI missing.", "error");
             this.isOrangeIdCallback = false; this.isAuthProcessing = false; this.switchPage('loginChoice');
             return;
        }
        this.unmountOrangeIdCallbackProcessor(); // Ensure no previous processor is active

        this.orangeIdReactRootCallback = ReactDOM.createRoot(container);
        const self = this; // Reference to the Vue instance

        function AuthCallbackProcessor() {
            // Hook to handle the login callback logic
            const { loginCallback, isLoading, error: bedrockError } = Bedrock.useBedrockPassport();
            const [message, setMessage] = React.useState('Processing authentication...');
            const [hasProcessed, setHasProcessed] = React.useState(false);

            React.useEffect(() => {
                // Only run once and only if not already processing or errored
                if (hasProcessed || isLoading || bedrockError) return;

                async function processLogin() {
                    setHasProcessed(true); // Mark as processing to prevent re-running
                    const urlParams = new URLSearchParams(window.location.search);
                    const token = urlParams.get('token');
                    const refreshToken = urlParams.get('refreshToken');

                    if (token && refreshToken) {
                        try {
                            setMessage('Verifying tokens with Orange ID...');
                            // Call the SDK's loginCallback function
                            const bedrockUser = await loginCallback(token, refreshToken);
                            if (bedrockUser && bedrockUser.sub) {
                                setMessage('Orange ID Login successful! Finalizing PestiVid profile...');
                                // Clear URL parameters after successful processing
                                window.history.replaceState({}, document.title, self.bedrockConfig.authCallbackUrl + window.location.hash);
                                // Hand off success to Vue instance
                                self.handleAuthenticationSuccess(bedrockUser.sub, 'orangeId', bedrockUser);
                            } else {
                                // Handle cases where SDK login doesn't return expected user data
                                console.error('Orange ID SDK loginCallback failed, no user object returned:', bedrockUser);
                                setMessage(`Orange ID Auth failed. User data not received. ${bedrockUser ? '' : '(No user obj)'}`);
                                self.addNotification("Orange ID authentication failed (no user details).", "error");
                                // Redirect back to login after a delay
                                setTimeout(() => { self.isOrangeIdCallback = false; self.isAuthProcessing = false; self.switchPage('loginChoice'); }, 3500);
                            }
                        } catch (error) {
                            // Handle errors during the callback process
                            console.error('Orange ID Login callback error:', error);
                             let userFacingError = "Authentication failed.";
                             if(error.message) {
                                 userFacingError += ` ${error.message}`;
                                 if (error.message.includes("Invalid token")) userFacingError = "Login failed: Invalid token.";
                                 else if (error.message.includes("Network error")) userFacingError = "Login failed: Network error.";
                             }
                            setMessage(`Error: ${userFacingError}`);
                            self.addNotification(`Orange ID login error: ${userFacingError}`, "error");
                            // Redirect back to login after a delay
                            setTimeout(() => { self.isOrangeIdCallback = false; self.isAuthProcessing = false; self.switchPage('loginChoice'); }, 4000);
                        }
                    } else {
                        // If no tokens are found in the URL (shouldn't happen if this page is the callback)
                        setMessage('Authentication tokens not found in URL. Redirecting...');
                        self.addNotification("Authentication tokens missing in callback.", "warning");
                         setTimeout(() => { self.isOrangeIdCallback = false; self.isAuthProcessing = false; self.switchPage('loginChoice'); }, 3000);
                    }
                }
                processLogin();
            }, [loginCallback, isLoading, hasProcessed, bedrockError]); // Dependencies for the effect

            // Render loading or error state from the hook
            if (isLoading) return React.createElement('p', {className: "text-gray-600"}, React.createElement('i', {className: "fas fa-spinner fa-spin mr-2"}), 'Initializing...');
            if (bedrockError) return React.createElement('p', {className: "text-red-500"}, `SDK Error: ${bedrockError.message}. Redirecting...`);

            // Render the current processing message
            return React.createElement('div', { style: { textAlign: 'center', padding: '1rem' } }, React.createElement('i', {className: "fas fa-spinner fa-spin mr-2"}), message);
        }

        // Render the React component into the container
        this.orangeIdReactRootCallback.render(
            React.createElement(
                Bedrock.BedrockPassportProvider, // Wrap with BedrockPassportProvider
                this.bedrockConfig,
                React.createElement(AuthCallbackProcessor) // The custom component handling the callback
            )
        );
        console.log("Orange ID CallbackProcessor rendered.");
      },
      unmountOrangeIdCallbackProcessor() {
        // Unmount the Orange ID CallbackProcessor React component
        if (this.orangeIdReactRootCallback) {
            try {
                this.orangeIdReactRootCallback.unmount();
                 console.log("Orange ID CallbackProcessor unmounted.");
            } catch(e) { console.warn("Error unmounting Orange ID callback processor:", e); }
            this.orangeIdReactRootCallback = null;
            const container = document.getElementById('orange-id-callback-processor');
            if (container) container.innerHTML = ''; // Clear container content
        }
      },
      renderOrangeIdSignOutButton(containerId, isMobile = false) {
        // Render the Orange ID SignOutButton React component
        if (!this.initializeOrangeIdSDK() || !this.isUserAuthenticated || this.loginMethod !== 'orangeId') {
             // Only render if SDK is ready, user is authenticated, and using Orange ID
            return;
        }

        const container = document.getElementById(containerId);
        if (!container) {
            console.warn(`Sign out button container ${containerId} not found.`);
            return;
        }

        // Determine which root ref to use (mobile or desktop)
        let rootRef = isMobile ? 'orangeIdReactRootSignOutMobile' : 'orangeIdReactRootSignOut';

        // Unmount any existing button in this container
        this.unmountOrangeIdSignOutButton(containerId, isMobile);

        // Create a new React root and render the component
        this[rootRef] = ReactDOM.createRoot(container);
        const self = this; // Reference to the Vue instance

        function PestiVidSignOutWrapper() {
            // Use the Bedrock hook within the provider context
            const { logout } = Bedrock.useBedrockPassport();

            // Handle sign out click
            const handleSignOut = async () => {
                self.showLoadingModal = true;
                self.loadingMessage = "Signing out...";
                try {
                     // Call the SDK's logout function
                    await logout();
                    console.log("Bedrock SDK logout successful.");
                } catch (e) {
                    console.error("Error during Bedrock logout:", e);
                     self.addNotification("Error signing out from Orange ID.", "error");
                     // Even if SDK logout fails, try to clear PestiVid session
                } finally {
                     // Clear PestiVid session data *after* the SDK logout attempt
                    self.logoutUser(true, false); // `triggerBedrockLogout: false` prevents infinite loop
                }
            };

            // Render the Bedrock SignOutButton
            return React.createElement(Bedrock.SignOutButton, {
                onSignOut: handleSignOut,
                buttonContent: React.createElement('i', { className: "fas fa-sign-out-alt text-lg" }), // Custom icon content
            });
        }

        try {
             // Render the wrapper component within the BedrockProvider
            this[rootRef].render(
                React.createElement(
                    Bedrock.BedrockPassportProvider,
                    this.bedrockConfig,
                    React.createElement(PestiVidSignOutWrapper)
                )
            );
             console.log(`Orange ID SignOutButton rendered in ${containerId}.`);
        } catch (e) {
            console.error(`Error rendering Orange ID SignOutButton in ${containerId}:`, e);
             // Optionally add a fallback UI element here
        }
      },
      unmountOrangeIdSignOutButton(containerId, isMobile = false) {
        // Unmount the Orange ID SignOutButton React component
        let rootRef = isMobile ? 'orangeIdReactRootSignOutMobile' : 'orangeIdReactRootSignOut';
        if (this[rootRef]) {
            try {
                 this[rootRef].unmount();
                 console.log(`Orange ID SignOutButton unmounted from ${containerId}.`);
            } catch(e) { console.warn("Error unmounting Orange ID signout button:", e); }
            this[rootRef] = null;
            const container = document.getElementById(containerId);
            if(container) container.innerHTML = ''; // Clear container content
        }
      },
      checkOrangeIdCallback() {
         // Checks if the current URL is an Orange ID callback URL
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token');
        const refreshToken = params.get('refreshToken');
        const isCallback = token && refreshToken; // Simple check for required params

        this.isOrangeIdCallback = isCallback;

        if (isCallback) {
            console.log("Orange ID callback detected.");
            this.isAuthProcessing = true; // Indicate auth is in progress
            // The 'current' watcher or mounted hook will see isOrangeIdCallback=true
            // and trigger renderOrangeIdCallbackProcessor
             return true;
        }
        return false;
      },
      async connectWallet() {
          // Handle Solana wallet connection
          if (typeof window.solana === 'undefined' || typeof window.solana.connect === 'undefined') {
              this.addNotification("Solana wallet extension (like Phantom) not found. Please install it.", "error");
              return;
          }

          // If already logged in, ask user if they want to switch
          if (this.isUserAuthenticated) {
               if (this.loginMethod === 'solana') {
                   this.addNotification("Solana Wallet is already connected.", "info"); return;
               }
               if(!confirm(`You are logged in with ${this.loginMethod === 'orangeId' ? 'Orange ID' : 'another method'}. Do you want to disconnect and connect with your Solana wallet instead?`)) {
                   return; // User cancelled
               }
               // Log out the current session first
               await this.logoutUser(false); // Logout PestiVid session without notification, don't trigger Bedrock logout from here
           }

          this.isAuthProcessing = true; // Indicate auth is in progress
          this.showLoadingModal = true; this.loadingMessage = "Connecting to Solana Wallet...";
          try {
               // Request connection from the wallet extension
              const resp = await window.solana.connect({ onlyIfTrusted: false }); // Use false to always prompt the user if not auto-approved
              if (resp && resp.publicKey) {
                  console.log("Solana Wallet connected:", resp.publicKey.toString());
                  // Hand off successful connection to the unified handler
                  this.handleAuthenticationSuccess(resp.publicKey.toString(), 'solana');
              } else {
                   // Handle unexpected response
                  console.error("Solana connect returned no public key:", resp);
                  this.addNotification("Solana connect failed: No public key received.", "error");
                  this.isAuthProcessing = false; // Stop processing indicator
              }
          } catch (err) {
              console.error("Solana Wallet connection error:", err);
              let errorMsg = "Solana connection failed.";
              if (err && err.message) {
                  errorMsg += ` ${err.message}`;
                  if (err.message.includes('User rejected')) errorMsg = "Solana connection rejected by user.";
              }
              this.addNotification(errorMsg, "error");
              this.loginMethod = null; // Clear login method state
              this.isAuthProcessing = false; // Stop processing indicator
          } finally {
              this.showLoadingModal = false; // Hide loading indicator
          }
      },
      async disconnectWallet() {
          // Handle Solana wallet disconnection via extension API
          if (window.solana && window.solana.isConnected) {
              try {
                  await window.solana.disconnect();
                   console.log("Solana Wallet disconnected.");
              } catch (err) {
                  console.error("Error disconnecting Solana wallet:", err);
                  this.addNotification("Error disconnecting wallet.", "error");
              }
          }
           // Clear the wallet address state in Vue
          this.walletAddress = null;
      },
      loadOrSetupPestiVidProfile() {
           // Load existing profile or prepare for onboarding
          console.log("loadOrSetupPestiVidProfile called for:", this.currentUserIdentifier);
          if (!this.currentUserIdentifier) {
              console.error("loadOrSetupPestiVidProfile called without current user identifier.");
              // This shouldn't happen if called after handleAuthenticationSuccess, but as a safeguard:
              this.logoutUser(false); // Clear session and redirect to landing
              return;
          }

          const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles')) || {};
          const pestividProfile = userProfiles[this.currentUserIdentifier];

          if (pestividProfile && pestividProfile.role) {
              console.log("Existing PestiVid profile found:", pestividProfile);
              // Load profile data into Vue state
              this.role = pestividProfile.role;
              this.userName = pestividProfile.name;
              this.userEmail = pestividProfile.email;
              this.userPhone = pestividProfile.phone || '';
              this.memberSince = pestividProfile.memberSince || new Date().toLocaleDateString(); // Use existing or set new if missing
              if (this.role === 'farmer') { this.farmerLocationCity = pestividProfile.farmerLocationCity || ''; }
              else { this.farmerLocationCity = ''; }

              // Load user-specific data (videos, listings, etc.) from local storage
              this.filterDataForCurrentUser();

              // Redirect to the appropriate starting page
              this.getStarted();

          } else {
              console.log("No complete PestiVid profile found for this identifier. Starting onboarding.");
              // Prepare onboarding form with available info
              this.userNameOnboarding = (this.loginMethod === 'orangeId' && this.orangeIdUser && this.orangeIdUser.name) ? this.orangeIdUser.name : '';
              this.userEmailOnboarding = (this.loginMethod === 'orangeId' && this.orangeIdUser && this.orangeIdUser.email) ? this.orangeIdUser.email : '';
              this.userPhoneOnboarding = '';
              this.farmerLocationCityOnboarding = '';
              this.selectedRoleOnboarding = ''; // Ensure role selection is required

              // Clear out any potential lingering data from a previous unauthenticated state
              this.filterDataForCurrentUser(); // This will clear user-specific arrays

              // Navigate to the role selection page
              this.switchPage('roleSelection');

              // Show info notification for new users
              this.addNotification(`Welcome! Please complete your PestiVid profile to get started.`, 'info');
          }
          this.showMobileMenu = false; // Ensure mobile menu is closed after navigation/setup
      },
      completeOnboarding() {
           // Save the new profile and redirect
          if (!this.selectedRoleOnboarding || !this.userNameOnboarding.trim() || !this.userEmailOnboarding.trim()) {
            this.addNotification("Please fill in Full Name, PestiVid Email, and select your Role.", "error");
            return;
          }
           // Simple email validation
          if (!/\S+@\S+\.\S+/.test(this.userEmailOnboarding)) {
            this.addNotification("Please enter a valid PestiVid email address.", "error");
            return;
          }

          console.log(`Onboarding complete. User: ${this.currentUserIdentifier}, Role: ${this.selectedRoleOnboarding}, Name: ${this.userNameOnboarding}`);

           // Update Vue state with onboarding data
          this.role = this.selectedRoleOnboarding;
          this.userName = this.userNameOnboarding.trim();
          this.userEmail = this.userEmailOnboarding.trim();
          this.userPhone = this.userPhoneOnboarding.trim() || '';
          this.memberSince = new Date().toLocaleDateString(); // Set member since date
          if (this.role === 'farmer') { this.farmerLocationCity = this.farmerLocationCityOnboarding.trim() || ''; }
          else { this.farmerLocationCity = ''; }


           // Update the user profile in localStorage
          const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles')) || {};
          userProfiles[this.currentUserIdentifier] = {
              role: this.role,
              name: this.userName,
              email: this.userEmail,
              phone: this.userPhone,
              memberSince: this.memberSince,
              // Save farmer-specific location if applicable
              farmerLocationCity: this.role === 'farmer' ? this.farmerLocationCity : undefined,
              authMethod: this.loginMethod,
              // Save Orange ID specific details if available
              orangeAuthEmail: (this.loginMethod === 'orangeId' && this.orangeIdUser) ? this.orangeIdUser.email : null,
              orangeEthAddress: (this.loginMethod === 'orangeId' && this.orangeIdUser) ? this.orangeIdUser.ethAddress : null,
          };
          localStorage.setItem('pestiVidUserProfiles', JSON.stringify(userProfiles));

           // Reload/filter user-specific data now that the role is set
          this.filterDataForCurrentUser();

           // Redirect to the appropriate starting page
          this.addNotification(`Profile for ${this.userName} setup complete! Welcome to PestiVid!`, 'success');
          this.getStarted();
      },
      async logoutUser(notify = true, triggerBedrockLogout = true) {
          // Handle PestiVid session logout
           console.log(`logoutUser called. notify: ${notify}, triggerBedrockLogout: ${triggerBedrockLogout}`);
          this.showLoadingModal = true;
          this.loadingMessage = "Signing out...";

          // Handle method-specific logout actions
          if (this.loginMethod === 'solana') {
             await this.disconnectWallet(); // Disconnect Solana wallet via extension API
          } else if (this.loginMethod === 'orangeId' && triggerBedrockLogout && this.orangeIdBedrockSDK) {
              // If Orange ID and we need to trigger the SDK logout
              // NOTE: The Bedrock SignOutButton calls this method with triggerBedrockLogout=false *after* its own logout call.
              // If we initiate logout via a different path (e.g., a manual button not from Bedrock SDK),
              // we would ideally call the SDK logout here first.
              console.log("Assuming Bedrock SDK logout is handled by its button or triggered elsewhere.");
          }

          // Clear PestiVid-specific session data
          this.clearUserSession(notify);

          this.showLoadingModal = false; // Hide loading indicator
      },
      clearUserSession(notify = true) {
          // Clear all reactive state related to the authenticated user
          console.log("Clearing PestiVid user session data.");
          const oldLoginMethod = this.loginMethod; // Store before clearing

          this.currentUserIdentifier = null;
          this.walletAddress = null;
          this.orangeIdUser = null;
          this.loginMethod = null; // Clear the login method state

          // Clear user profile data from Vue state
          this.role = '';
          this.userName = '';
          this.userEmail = '';
          this.userPhone = '';
          this.memberSince = '';
          this.farmerLocationCity = '';

          // Clear user-specific data arrays (important!)
          this.farmerVideos = [];
          this.farmerListings = [];
          this.farmerFundingRequests = [];
          this.buyerPurchases = [];
          this.investorInvestments = [];
          this.investorTransactions = [];

          // Clear active conversation state
          this.activeConversationId = null;

          // Unmount Orange ID sign-out buttons if they were rendered
          this.unmountOrangeIdSignOutButton('orange-id-signout-button-container');
          this.unmountOrangeIdSignOutButton('orange-id-signout-button-container-mobile');

          this.showMobileMenu = false; // Close mobile menu

          this.isAuthProcessing = false; // Ensure auth processing flag is off

          // Show sign out notification if requested
          if (notify) {
               this.addNotification("Signed out from PestiVid.", 'info');
          }

          // Redirect to landing page, but avoid redirecting during callback processing
          if (!this.isOrangeIdCallback && this.current !== 'landing' && this.current !== 'loginChoice') {
             console.log("[clearUserSession] Redirecting to landing page.");
             this.switchPage('landing');
          } else {
              console.log("[clearUserSession] Staying on current page or handling callback.");
              // If on loginChoice or landing, just stay there.
              // If on callback page, the callback processor will handle the final navigation.
          }
      },
      getFarmerDisplayIdentifier(wallet, length = 6) {
            // Get display name for a wallet address (for farmer/seller)
            if (!wallet) return 'N/A';
            const userProfiles = JSON.parse(localStorage.getItem('pestiVidUserProfiles')) || {};
            const profile = userProfiles[wallet];
            // Use the saved PestiVid name if available, otherwise truncate the address
            if (profile && profile.name) return profile.name.split(' ')[0];
            const addr = String(wallet);
            return `${addr.substring(0, length)}...${addr.substring(addr.length - (length > 4 ? 4 : length))}`;
      },
      getSellerDisplayIdentifier(wallet, length = 6) {
            // Same logic as farmer, used for seller in marketplace context
            return this.getFarmerDisplayIdentifier(wallet, length);
      },
       // --- Simulated Blockchain/Transaction Methods ---
      async simulateTransaction(description = "Processing action...") {
           // Simulate a blockchain transaction delay and return a fake transaction hash
           console.log("Simulating transaction:", description);
           this.showLoadingModal = true;
           this.loadingMessage = `${description} - Confirming (Simulated)...`;
           await new Promise(resolve => setTimeout(resolve, 1200 + Math.random() * 1000)); // Delay 1
           this.loadingMessage = `${description} - On PestiVid Ledger (Simulated)...`;
           await new Promise(resolve => setTimeout(resolve, 1800 + Math.random() * 1500)); // Delay 2
           const txHash = 'sim_tx_' + Date.now().toString(16) + Math.random().toString(16).substring(2, 14); // Generate fake hash
           console.log("Simulated transaction complete. Tx Hash:", txHash);
           this.showLoadingModal = false; // Hide loading indicator
           return txHash;
      },
      solanaExplorerUrl(txHash) {
           // Provide a link to a real Solana explorer for the simulated hash
           // This is just a placeholder; the txHash won't exist on chain
           return `https://explorer.solana.com/tx/${txHash}?cluster=devnet`;
      },
       // --- Farmer Methods ---
      async startVideo() {
          // Start recording video from camera
          if (!this.isUserAuthenticated || this.role !== 'farmer') {
              this.addNotification("You must be logged in as a Farmer to record videos.", "error");
              return;
          }
          if (this.recording || this.uploading) return; // Prevent starting while already recording or uploading

           // Warn about HTTPS if not used, as camera access can be restricted
          if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
              console.warn("HTTPS recommended for camera access.");
              this.addNotification("Camera access works best over HTTPS.", "warning");
          }

           // Reset previous recording state
          this.recordBlob = null;
          this.recordBlobUrl = '';
          this.uploadCid = '';
          this.uploadError = '';
          this.showLive = true; // Show the live video element

          try {
               // Request camera access
              const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
              this.recordStream = stream;
              this.$refs.liveVideo.srcObject = stream;
              this.$refs.liveVideo.play();

              let chunks = [];
              this.recording = true; // Set recording state

              // Attempt to find a supported MIME type for MediaRecorder
              const mimeTypes = ['video/webm;codecs=vp9,opus', 'video/webm;codecs=vp8,opus', 'video/webm', 'video/mp4'];
              let selectedMimeType = mimeTypes.find(type => MediaRecorder.isTypeSupported(type)) || undefined;
              console.log("Selected MIME type for recording:", selectedMimeType || "default");

               // Create MediaRecorder instance
              this.recordMediaRecorder = new MediaRecorder(stream, { mimeType: selectedMimeType });

               // Event handler for available data chunks
              this.recordMediaRecorder.ondataavailable = e => {
                  if (e.data.size > 0) chunks.push(e.data);
              };

               // Event handler for recording stop
              this.recordMediaRecorder.onstop = () => {
                  const blobType = this.recordMediaRecorder.mimeType || (selectedMimeType || 'video/webm');
                  this.recordBlob = new Blob(chunks, { type: blobType });
                  // Create a local URL for playback
                  if (this.recordBlobUrl) URL.revokeObjectURL(this.recordBlobUrl); // Clean up previous URL
                  this.recordBlobUrl = URL.createObjectURL(this.recordBlob);
                  this.showLive = false; // Hide live video
                  // Stop camera tracks
                  if(stream) stream.getTracks().forEach(t => t.stop());
                  this.recordStream = null;
                  this.recording = false; // Clear recording state
              };

               // Event handler for recorder errors
              this.recordMediaRecorder.onerror = (e) => {
                  console.error("MediaRecorder error:", e);
                  this.uploadError = "Recording error: " + (e.name || "Unknown");
                   // Attempt to stop everything gracefully on error
                  this.stopVideo();
              };

               // Start recording, gathering data every 1000ms (optional)
              this.recordMediaRecorder.start(1000);

          } catch (e) {
              // Handle errors from getUserMedia (camera access)
              console.error("getUserMedia error:", e);
              let alertMsg = "Camera access failed.";
              if (e.name === 'NotAllowedError') alertMsg = "Camera access denied. Please grant permission.";
              else if (e.name === 'NotFoundError') alertMsg = "No camera found on this device.";
              else if (e.name === 'NotReadableError' || e.name === 'TrackStartError') alertMsg = "Camera in use or unable to start.";
              else alertMsg = `Camera error: ${e.name || e.message}`;

              if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                   alertMsg += " Use HTTPS for reliable camera access.";
               }

              this.addNotification(alertMsg, "error");
              this.showLive = false;
              this.recording = false;
          }
      },
      stopVideo() {
           // Stop the MediaRecorder and camera stream
          if (this.recordMediaRecorder && this.recordMediaRecorder.state === "recording") {
              try {
                   this.recordMediaRecorder.stop();
              } catch(e) { console.warn("Error stopping MediaRecorder:", e); }
          }
          if (this.recordStream) {
              this.recordStream.getTracks().forEach(t => t.stop()); // Stop all media tracks
              this.recordStream = null;
          }
          this.recording = false; // Clear recording state
          // Note: showLive becomes false when the 'stop' event fires and sets recordBlobUrl
      },
      async uploadVideo() {
          // Upload the recorded video blob to Pinata IPFS
          if (!this.isUserAuthenticated || this.role !== 'farmer') {
              this.addNotification("You must be logged in as a Farmer to upload videos.", "error");
              return;
          }
          if (!this.recordBlob) {
              this.addNotification("No video has been recorded yet to upload.", "error");
              return;
          }
           // Validate form details are filled
          if (!this.recordForm.crop || !this.recordForm.pesticide || !this.recordForm.location || !this.recordForm.pesticideCompany || !this.recordForm.purpose) {
              this.addNotification("Please fill in all video details (Crop, Location, Pesticide, Company) and select the video purpose.", "error");
              return;
          }

           // Check Pinata configuration
           if (this.pinataJwt === 'YOUR_PINATA_JWT' || !this.pinataJwt || this.pinataGateway === 'YOUR_PINATA_GATEWAY_HOSTNAME' || !this.pinataGateway) {
               const configError = "Pinata configuration missing or incorrect (JWT or Gateway). Video upload unavailable.";
               this.uploadError = configError;
               console.error("Pinata Configuration Error:", configError);
               this.addNotification(configError, "error");
               return;
           }


          this.uploading = true; // Set uploading state
          this.uploadCid = ''; // Clear previous CID
          this.uploadError = ''; // Clear previous errors
          this.lastUploadedVideoPurpose = ''; // Clear previous purpose

          const formData = new FormData();
          const fileExtension = (this.recordBlob.type.split('/')[1] || 'webm').split(';')[0]; // Derive extension from MIME type
          const fileName = `pestivid_${this.currentUserIdentifier.substring(0,6)}_${Date.now()}.${fileExtension}`;
          formData.append('file', this.recordBlob, fileName);

           // Add metadata for Pinata (optional but useful)
          formData.append('pinataMetadata', JSON.stringify({
              name: fileName,
              keyvalues: {
                  uploaderId: this.currentUserIdentifier,
                  role: this.role,
                  crop: this.recordForm.crop.trim(),
                  pesticide: this.recordForm.pesticide.trim(),
                  location: this.recordForm.location.trim(),
                  pesticideCompany: this.recordForm.pesticideCompany.trim(),
                  purpose: this.recordForm.purpose,
                  uploadTimestamp: new Date().toISOString()
              }
          }));
           // Request CID version 1
          formData.append('pinataOptions', JSON.stringify({ cidVersion: 1 }));

          try {
               // Post the video file to Pinata's IPFS pinning endpoint
              const resp = await axios.post('https://api.pinata.cloud/pinning/pinFileToIPFS', formData, {
                  maxBodyLength: Infinity, // Allow large uploads
                  headers: {
                      Authorization: `Bearer ${this.pinataJwt}` // Use JWT for authentication
                  }
              });

              this.uploadCid = resp.data.IpfsHash; // Get the CID from the response
              this.lastUploadedVideoPurpose = this.recordForm.purpose; // Save purpose for post-upload message

              console.log("Video uploaded to IPFS. CID:", this.uploadCid);

               // Save video metadata to local storage (PestiVid app data)
              const newVideoData = {
                  cid: this.uploadCid,
                  farmerWallet: this.currentUserIdentifier,
                  crop: this.recordForm.crop.trim(),
                  pesticide: this.recordForm.pesticide.trim(),
                  location: this.recordForm.location.trim(),
                  pesticideCompany: this.recordForm.pesticideCompany.trim(),
                  purpose: this.recordForm.purpose,
                  uploadedAt: new Date().toISOString()
              };
              this.farmerVideos.unshift(newVideoData); // Add to user's video list
              this.saveDataToLocalStorage(); // Save all app data

               // Clear the recording form and blob
              this.recordForm = { crop: '', pesticide: '', location: '', pesticideCompany: '', purpose: 'agristream' };
              if (this.recordBlobUrl) URL.revokeObjectURL(this.recordBlobUrl); // Clean up local blob URL
              this.recordBlob = null;
              this.recordBlobUrl = '';

              // Show success notification
              this.addNotification(`Video for "${newVideoData.crop}" uploaded successfully!`, 'success');

              // If purpose was 'sell' or 'funding', navigate to the corresponding page
              if (newVideoData.purpose === 'sell') {
                  this.addNotification(`Video uploaded for selling! Please complete the listing details.`, 'info');
                  this.navigateToPageWithParam('farmerSell', 'cid', this.uploadCid);
              } else if (newVideoData.purpose === 'funding') {
                  this.addNotification(`Video uploaded for funding request! Please complete the request details.`, 'info');
                  this.navigateToPageWithParam('farmerFunding', 'cid', this.uploadCid);
              } else {
                  // For 'agristream' purpose, just show success
                  // No additional navigation needed, user can view it in AgriStream page
              }

          } catch (e) {
              console.error("Pinata Upload Error:", e);
              this.uploadError = "IPFS upload failed. ";
              if (e.response) {
                  this.uploadError += `Server: ${e.response.status}. ${e.response.data?.error?.details || e.response.data?.error || e.message || ''}`;
                  if (e.response.status === 401) this.uploadError += " Check your Pinata JWT.";
                  else if (e.response.status === 403) this.uploadError += " Check Pinning permissions for your JWT.";
                  else if (e.response.status >= 400) this.uploadError += " Client or server error.";
              } else if (e.request) {
                  this.uploadError += " Network error. Check internet connection and Pinata API status.";
              } else {
                  this.uploadError += e.message || "Unknown upload error.";
              }
              this.addNotification(this.uploadError, "error");
              this.uploadCid = ''; // Clear CID on error
          } finally {
              this.uploading = false; // Clear uploading state
          }
      },
      ipfsUrl(cid) {
           // Generate a URL to view the IPFS CID using a gateway
          if (!cid) return "";
           // Use the configured Pinata Gateway if available, otherwise fallback to a public gateway
          if (this.pinataGateway === 'YOUR_PINATA_GATEWAY_HOSTNAME' || !this.pinataGateway) {
              console.warn("Pinata Gateway not configured. Using public ipfs.io gateway.");
              // Fallback public gateway (may be slower or less reliable)
              return `https://ipfs.io/ipfs/${cid}`;
          }
           // Use the configured Pinata Dedicated or standard gateway
          return `https://${this.pinataGateway}/ipfs/${cid}`;
      },
       isListed(cid) {
           // Check if a video CID is already used in an active listing by the current farmer
           if (!this.isUserAuthenticated || this.role !== 'farmer') return false;
           return this.farmerListings.some(l => l.cid === cid && l.farmerWallet === this.currentUserIdentifier);
       },
       isUsedInFunding(cid) {
           // Check if a video CID is already used in a funding request by the current farmer
            if (!this.isUserAuthenticated || this.role !== 'farmer') return false;
           return this.farmerFundingRequests.some(req => req.cid === cid && req.farmerWallet === this.currentUserIdentifier);
       },
       goToListing(cid) {
           // Navigate to the farmer sell page and pre-select the video
           this.navigateToPageWithParam('farmerSell', 'cid', cid);
       },
       // --- Farmer Sell Methods ---
      async createListing() {
           // Create a new crop listing on the marketplace (simulated)
          if (!this.isUserAuthenticated || this.role !== 'farmer') {
              this.addNotification("You must be logged in as a Farmer to create listings.", "error");
              return;
          }
          this.createdListingId = null; // Clear previous success state
          this.listingNotificationSent = false; // Clear previous notification state

           // Validate form fields
          if (!this.listingForm.cid || !this.listingForm.minPrice || !this.listingForm.maxPrice) {
              this.addNotification("Please select a video and set the Min/Max prices.", "error");
              return;
          }
          const minP = parseFloat(this.listingForm.minPrice);
          const maxP = parseFloat(this.listingForm.maxPrice);
          if (isNaN(minP) || isNaN(maxP) || minP <= 0 || maxP <= 0 || minP > maxP) {
              this.addNotification("Please enter valid prices. Minimum must be less than or equal to Maximum, and both must be positive.", "error");
              return;
          }

           // Find the video associated with the selected CID
          let vid = this.farmerVideos.find(v => v.cid === this.listingForm.cid && v.farmerWallet === this.currentUserIdentifier);
          if (!vid) {
              this.addNotification("Selected video not found or doesn't belong to you.", "error");
              return;
          }
           // Prevent listing the same video multiple times
          if (this.isListed(vid.cid)) {
              this.addNotification("This video is already associated with an active listing.", "warning");
              return;
          }

           // Simulate blockchain transaction
          const txHash = await this.simulateTransaction(`Creating listing for ${vid.crop}`);
          if (!txHash) {
              this.addNotification("Listing creation failed (simulated blockchain error).", "error");
              return; // Stop if simulation failed
          }

           // Create the new listing object
          let newListing = {
              id: 'lst' + Date.now(), // Unique ID (simulated)
              farmerWallet: this.currentUserIdentifier,
              crop: vid.crop,
              location: vid.location,
              pesticide: vid.pesticide || '', // Use empty string if undefined
              pesticideCompany: vid.pesticideCompany || '', // Use empty string if undefined
              cid: vid.cid,
              minPrice: minP,
              maxPrice: maxP,
              status: 'active', // Listings are active upon creation
              createdAt: new Date().toISOString(),
              notificationSent: false, // Track if buyer notification was sent
              isNew: true, // Flag for visual highlight in marketplace
              txHash: txHash // Simulated transaction hash
          };

           // Add the new listing to the farmer's list and the global list
          this.farmerListings.unshift({ ...newListing });
          this.allListings.unshift({ ...newListing }); // Add to the global list for buyers

          this.addNotification(`Listing for "${newListing.crop}" created successfully!`, 'success');

           // Notify buyers if the checkbox was checked
          if (this.listingForm.notifyBuyers) {
              this.notifyBuyersAboutListing(newListing, true); // Pass true to mark notificationSent
              this.listingNotificationSent = true; // Update state for confirmation message
          }

          this.createdListingId = txHash; // Show the simulated tx hash on screen

           // Reset the form
          this.listingForm = { cid: '', minPrice: '', maxPrice: '', notifyBuyers: true };

          this.saveDataToLocalStorage(); // Save updated data

           // Clear success message after a few seconds
          setTimeout(() => {
              this.createdListingId = null;
              this.listingNotificationSent = false;
          }, 7000); // Show for 7 seconds
      },
       // --- Farmer Funding Methods ---
       fundingProgressPercent(req) {
            // Calculate the percentage of funding raised for a request
           if (!req || typeof req.amount !== 'number' || req.amount <= 0) return 0;
           const progress = ((req.fundedAmount || 0) / req.amount) * 100;
           return Math.min(100, Math.round(progress)); // Cap at 100%
       },
      async createFundingRequest_V1() {
           // Create a new funding request (simulated)
          if (!this.isUserAuthenticated || this.role !== 'farmer') {
              this.addNotification("You must be logged in as a Farmer to create funding requests.", "error");
              return;
          }
          this.createdFundingRequest = false; // Clear previous success state

          const form = this.fundingForm;
          const requiredFields = ['title', 'crop', 'acres', 'amount', 'method', 'cid', 'description', 'timeline', 'roi', 'investorShare'];

           // Validate form fields
           if (!form.cid) {
               this.addNotification("Please select a video for your funding request.", "error");
               return;
           }
          if (requiredFields.some(field => form[field] === null || form[field] === undefined || (typeof form[field] === 'string' && form[field].trim() === ''))) {
              this.addNotification("Please fill in all required funding request details.", "error");
              return;
          }
           // Validate numeric fields and ranges
           if (form.acres <= 0 || form.amount <= 0 || form.timeline <= 0 || form.roi <= 0 || form.roi > 100 || form.investorShare <= 0 || form.investorShare > 80) {
              this.addNotification("Please enter valid positive numbers for Acres, Amount, Timeline, and ROI (1-100%). Investor Share must be between 1% and 80%.", "error");
              return;
          }

           // Find the video associated with the selected CID
          const vid = this.farmerVideos.find(v => v.cid === form.cid && v.farmerWallet === this.currentUserIdentifier);
          if (!vid) {
              this.addNotification("Selected video not found or doesn't belong to you.", "error");
              return;
          }

           // Simulate blockchain transaction
          const txHash = await this.simulateTransaction(`Creating funding request "${form.title}"`);
           if(!txHash) {
               this.addNotification("Funding request creation failed (simulated blockchain error).", "error");
               return; // Stop if simulation failed
           }

           // Create the new funding request object
          const newRequest = {
              id: 'fr' + Date.now(), // Unique ID (simulated)
              farmerWallet: this.currentUserIdentifier,
              title: form.title.trim(),
              crop: form.crop.trim(),
              acres: form.acres,
              amount: form.amount,
              method: form.method,
              cid: form.cid,
              description: form.description.trim(),
              timeline: form.timeline,
              roi: form.roi,
              investorShare: form.investorShare,
              fundedAmount: 0, // Starts with 0 funded
              status: 'pending', // Initial status
              createdAt: new Date().toISOString(),
              investors: [], // List of investments in this project
              updates: [], // List of farmer updates for this project
              txHash: txHash, // Simulated transaction hash
              isNew: true, // Flag for visual highlight in projects list
          };

           // Add the new request to the farmer's list and the global list
          this.farmerFundingRequests.unshift({ ...newRequest });
          this.allFundingRequests.unshift({ ...newRequest }); // Add to the global list for investors

          this.createdFundingRequest = true; // Set success state for UI message

          this.addNotification(`Funding request "${newRequest.title}" created and is now visible to investors!`, 'success');

           // Optionally notify investors (if checkbox was there) - currently always notifies
           this.notifyInvestorsAboutFunding(newRequest, true);


           // Reset the form
          this.fundingForm = { title: '', crop: '', acres: null, amount: null, method: '', cid: '', description: '', timeline: null, roi: null, investorShare: null, notifyInvestors: true };

          this.saveDataToLocalStorage(); // Save updated data

           // Clear success message after a few seconds
          setTimeout(() => this.createdFundingRequest = false, 5000); // Show for 5 seconds
      },
      async cancelFundingRequest_V1(id) {
          // Simulate cancelling a funding request
          if (!this.isUserAuthenticated || this.role !== 'farmer') {
              this.addNotification("Please log in as a Farmer to cancel requests.", "error");
              return;
          }
          const reqIndex = this.farmerFundingRequests.findIndex(r => r.id === id && r.farmerWallet === this.currentUserIdentifier);
          if (reqIndex === -1) {
              this.addNotification("Funding request not found or doesn't belong to you.", "error");
              return;
          }
          const req = this.farmerFundingRequests[reqIndex];

           // Confirm cancellation, especially if already partially funded
          if (req.fundedAmount > 0) {
              if (!confirm(`This funding request ("${req.title}") has received ${req.fundedAmount} SOL in funding. Cancelling will simulate refunding investors. Are you sure you want to cancel?`)) {
                   return; // User cancelled the confirmation
               }
          } else {
              if (!confirm(`Are you sure you want to cancel the funding request "${req.title}"?`)) {
                   return; // User cancelled the confirmation
               }
          }

           // Simulate blockchain transaction for cancellation/refunds
          const txHash = await this.simulateTransaction(`Cancelling funding request "${req.title}"`);
           if(!txHash) {
               this.addNotification("Funding request cancellation failed (simulated).", "error");
               return; // Stop if simulation failed
           }

           // Remove the request from both farmer's list and the global list
          this.farmerFundingRequests.splice(reqIndex, 1);
          this.allFundingRequests = this.allFundingRequests.filter(r => r.id !== id);

           // Simulate refunding investors if any funds were raised
           if (req.fundedAmount > 0 && req.investors && req.investors.length > 0) {
               console.log(`Simulating refunds for ${req.investors.length} investors in request ${id}`);
               req.investors.forEach(inv => {
                   // Add simulated payout transactions for refunds
                   const refundTxHash = 'sim_refund_tx_' + Date.now().toString(16) + '_' + inv.investorId.substring(0, 6) + Math.random().toString(16).substring(2,6);
                   const refundAmount = inv.amount; // Refund the invested amount
                   this.investorTransactions.unshift({
                        id: 'txr' + Date.now() + '_' + inv.investorId.substring(0,4) + Math.random().toString(16).substring(2,4), // Unique ID
                        investorWallet: inv.investorId,
                        txHash: refundTxHash,
                        type: 'refund', // Use 'refund' type for clarity
                        amount: refundAmount,
                        date: new Date().toLocaleDateString(),
                        projectId: req.id,
                        projectTitle: req.title,
                        notes: "Refund from cancelled project"
                   });
                   // Notify the investor about the simulated refund
                   this.addNotification(`Refund processed: ${refundAmount} SOL returned for "${req.title}" (cancelled).`, 'info', inv.investorId);
               });
               this.investorTransactions.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()); // Re-sort transactions
           }

          this.addNotification(`Funding request "${req.title}" has been cancelled.`, 'info');
          this.saveDataToLocalStorage(); // Save updated data
      },
      // --- Buyer Methods ---
      resetBuyerFilters() {
          // Reset marketplace filters to show all listings
          this.buyerFilters = {crop:'', location:'', pesticideCompany: ''};
      },
      buyListing(listing) {
          // Open the modal to confirm a purchase
          if (!this.isUserAuthenticated || this.role !== 'buyer') {
              this.addNotification("You must be logged in as a Buyer to purchase crops.", "error");
              if (!this.isUserAuthenticated) {
                  this.switchPage('loginChoice'); // Redirect to login if not authenticated
              }
              return;
          }
          if(this.currentUserIdentifier === listing.farmerWallet) {
               this.addNotification("You cannot purchase your own listing.", "warning");
               return;
           }
           // Set the selected listing and initial purchase amount (min price)
          this.selectedListing = listing;
          this.purchaseAmount = listing.minPrice; // Default offer is min price

           // Reset purchase status/errors
          this.purchaseStatus = '';
          this.purchaseError = '';

          this.showBuyModal = true; // Show the modal
      },
      closeBuyModal() {
          // Close the purchase modal and reset related state
          this.showBuyModal = false;
          this.selectedListing = null;
          this.purchaseAmount = null;
          this.purchaseStatus = '';
          this.purchaseError = '';
      },
      async processPurchase() {
          // Simulate processing a crop purchase
          if (!this.isUserAuthenticated || !this.selectedListing || this.purchaseAmount === null) {
              this.purchaseError = "Cannot process purchase. Login status or listing invalid.";
              return;
          }
          this.purchaseStatus = ''; // Clear previous status/errors
          this.purchaseError = '';

          const amount = parseFloat(this.purchaseAmount);
          const minP = parseFloat(this.selectedListing.minPrice);
          const maxP = parseFloat(this.selectedListing.maxPrice);

           // Validate offer amount against price range
          if (isNaN(amount) || amount < minP || amount > maxP) {
              this.purchaseError = `Your offer must be between ${minP} and ${maxP} SOL.`;
              return;
          }

           // Simulate blockchain transaction for the purchase
          const txHash = await this.simulateTransaction(`Purchasing ${this.selectedListing.crop} for ${amount} SOL`);
          if (!txHash) {
              this.purchaseError = "Purchase failed (simulated blockchain error).";
              this.purchaseStatus = '';
              return; // Stop if simulation failed
          }

          this.purchaseStatus = `Processing purchase of ${amount} SOL... Simulated Tx: ${txHash.substring(0,10)}...`;

          try {
              // Create the new purchase record
              const newPurchase = {
                  id: 'pur' + Date.now(), // Unique ID (simulated)
                  buyerWallet: this.currentUserIdentifier,
                  farmerWallet: this.selectedListing.farmerWallet,
                  crop: this.selectedListing.crop,
                  location: this.selectedListing.location,
                  pesticide: this.selectedListing.pesticide,
                  pesticideCompany: this.selectedListing.pesticideCompany || '',
                  cid: this.selectedListing.cid,
                  price: amount, // The actual purchase price (the offer amount)
                  date: new Date().toLocaleDateString(),
                  txHash: txHash // Simulated transaction hash
              };

              this.buyerPurchases.unshift(newPurchase); // Add to buyer's purchase history

              // Remove the listing from the marketplace (it's now sold)
              this.allListings = this.allListings.filter(l => l.id !== this.selectedListing.id);
               // Also remove from the farmer's active listings if they are viewing their profile
               if (this.role === 'farmer' && this.selectedListing.farmerWallet === this.currentUserIdentifier) {
                   this.farmerListings = this.farmerListings.filter(l => l.id !== this.selectedListing.id);
               }


              // Show success notifications
              this.addNotification(`Successfully purchased "${newPurchase.crop}" for ${amount} SOL!`, 'success');
               // Notify the farmer/seller about the purchase
              this.addNotification(`Your listing "${newPurchase.crop}" was purchased by ${this.getFarmerDisplayIdentifier(newPurchase.buyerWallet)} for ${amount} SOL!`, 'success', newPurchase.farmerWallet);

              this.purchaseStatus = "Purchase successful!"; // Final status message
              this.saveDataToLocalStorage(); // Save updated data

               // Close modal after a short delay
              setTimeout(() => { this.closeBuyModal(); }, 2500); // Close after 2.5 seconds

          } catch(err) {
              console.error("Error processing simulated purchase:", err);
              this.purchaseError = "An error occurred during simulated purchase processing.";
              this.purchaseStatus = ''; // Clear status on error
          }
      },
       viewPurchaseVideo(purchase) {
           // Set selected purchase and show the video modal
           this.selectedPurchase = purchase;
           this.showPurchaseVideo = true;
       },
       // --- Investor Methods ---
       resetInvestorFilters() {
           // Reset investment project filters
           this.investorFilters = {crop: '', method: '', minRoi: null, maxAmount: null};
       },
       maxInvestmentAmount(project) {
           // Calculate the maximum amount an investor can still invest in a project
           if (!project || project.status === 'funded' || typeof project.amount !== 'number' || typeof project.fundedAmount !== 'number') return 0;
           const remaining = project.amount - project.fundedAmount;
           return remaining > 0 ? parseFloat(remaining.toFixed(2)) : 0; // Return remaining amount, rounded to 2 decimals
       },
       async investInProject(project) {
           // Simulate investing in a funding request
           if (!this.isUserAuthenticated || this.role !== 'investor') {
              this.addNotification("You must be logged in as an Investor to invest.", "error");
              if(!this.isUserAuthenticated) {
                   this.switchPage('loginChoice'); // Redirect to login if not authenticated
               }
              return;
           }

           const amount = parseFloat(this.investmentAmounts[project.id]);
           // Clear any previous error message for this project
           this.$set(this.investmentErrors, project.id, '');

           // Validate investment amount
           if (isNaN(amount) || amount <= 0) {
               this.$set(this.investmentErrors, project.id, 'Please enter a valid positive investment amount.');
               return;
           }

           const maxInvest = this.maxInvestmentAmount(project);
           // Use a small tolerance for floating point comparison
           const tolerance = 0.00001;
           if (amount > maxInvest + tolerance) {
               this.$set(this.investmentErrors, project.id, `Your investment exceeds the remaining amount. Max: ${maxInvest.toFixed(2)} SOL.`);
               return;
           }

           // Ensure amount is precise to 2 decimal places for simulation
           const preciseAmount = parseFloat(amount.toFixed(2));

           // Simulate blockchain transaction for the investment
           const txHash = await this.simulateTransaction(`Investing ${preciseAmount} SOL in "${project.title}"`);
           if (!txHash) {
               this.$set(this.investmentErrors, project.id, 'Investment failed (simulated blockchain error).');
               return; // Stop if simulation failed
           }

           try {
               // Find the project in the global list (to update fundedAmount and investors)
               const projectInAllIdx = this.allFundingRequests.findIndex(p => p.id === project.id);
               if (projectInAllIdx === -1) {
                   throw new Error("Project not found in global list."); // Should not happen
               }

               // Deep copy the project to avoid direct mutation issues before $set
               const updatedProject = JSON.parse(JSON.stringify(this.allFundingRequests[projectInAllIdx]));

               // Update funded amount (ensure precision)
               updatedProject.fundedAmount = parseFloat(((updatedProject.fundedAmount || 0) + preciseAmount).toFixed(2));

               // Add the new investor record to the project's investors list
               updatedProject.investors = [...(updatedProject.investors || []), {
                   investorId: this.currentUserIdentifier,
                   amount: preciseAmount,
                   txHash: txHash, // Link investment record to transaction
                   date: new Date().toLocaleDateString()
               }];

               // Update project status based on funding level
               if (updatedProject.fundedAmount >= updatedProject.amount - tolerance) {
                   updatedProject.status = 'funded'; // Mark as fully funded
                   updatedProject.fundedAmount = updatedProject.amount; // Cap at required amount
               } else {
                   updatedProject.status = 'partially_funded'; // Mark as partially funded
               }

               // Update the project in the global list using $set for reactivity
               this.$set(this.allFundingRequests, projectInAllIdx, updatedProject);

               // If the farmer is currently viewing their funding requests, update their list too
                const farmerProjectIndex = this.farmerFundingRequests.findIndex(p => p.id === project.id);
                if(farmerProjectIndex > -1) {
                    this.$set(this.farmerFundingRequests, farmerProjectIndex, updatedProject);
                }


               // Create a new investment record for the *current investor's* portfolio
               const newInvestment = {
                   id: 'inv' + Date.now(), // Unique ID for this investment record
                   investorWallet: this.currentUserIdentifier,
                   projectId: project.id, // Link back to the project
                   projectTitle: project.title,
                   farmerWallet: project.farmerWallet,
                   crop: project.crop,
                   method: project.method,
                   description: project.description, // Store relevant project details
                   acres: project.acres,
                   timeline: project.timeline,
                   roi: project.roi,
                   investorShare: project.investorShare,
                   amount: preciseAmount, // Amount invested by this user
                   cid: project.cid, // Video CID
                   status: 'active', // Initial status for investor's view (could be 'invested', 'growing', etc.)
                   progress: 0, // Initial progress for this investment tracking
                   investmentDate: new Date().toLocaleDateString(),
                   txHash: txHash // Link investment record to transaction
               };
               this.investorInvestments.unshift(newInvestment); // Add to investor's portfolio list

               // Create a transaction record for the investor's history
               const newTransaction = {
                   id: 'tx' + Date.now(), // Unique ID for this transaction
                   investorWallet: this.currentUserIdentifier,
                   txHash: txHash,
                   type: 'investment', // Transaction type
                   amount: preciseAmount,
                   date: new Date().toLocaleDateString(),
                   projectId: project.id, // Link back to project for context
                   projectTitle: project.title,
               };
               this.investorTransactions.unshift(newTransaction); // Add to investor's transaction list
               this.investorTransactions.sort((a, b) => new Date(b.date).getTime() - new
              </script>
              </body>
              </html>