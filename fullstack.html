<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PestiVid - Agricultural Blockchain Platform</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" rel="stylesheet">
  <!-- Google Fonts (Inter) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- Vue.js -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
  <!-- Axios -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- Buffer Polyfill for Solana -->
  <script src="https://cdn.jsdelivr.net/npm/buffer@6.0.3/index.min.js"></script>
  <script>
    window.Buffer = window.buffer.Buffer; // Ensure Buffer is available globally
  </script>
  <!-- Solana Web3 -->
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.73.0/lib/index.iife.min.js"></script>
  <!-- Chart.js (Keeping for potential future use, but not used in current code) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <style>
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: #f9fafb;
    }
    html {
      scroll-behavior: smooth;
      /* Avoid horizontal scroll for PDF export */
      overflow-x: hidden;
    }
     /* Minimal scrollbar styling, often hidden by overflow-x */
    ::-webkit-scrollbar {
      width: 5px; height: 5px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    ::-webkit-scrollbar-thumb {
      background: #ccc; border-radius: 5px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #aaa;
    }
    /* Hide scrollbars using standard/Firefox approach */
    * {
      scrollbar-width: thin; /* "auto" or "thin" */
      scrollbar-color: #ccc #f1f1f1; /* thumb track */
    }
    /* Hide scrollbars for MS Edge/IE */
     * {
      -ms-overflow-style: -ms-autohiding-scrollbar; /* Modern Edge uses Webkit */
    }

    /* Progress bar styling */
    .progress-bar {
      height: 8px;
      border-radius: 4px;
      background: #e5e7eb;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    /* Ensure modals are scrollable if content overflows */
    .modal-scrollable {
        max-height: 80vh; /* Adjust as needed */
        overflow-y: auto;
    }
  </style>
</head>
<body class="text-gray-900">
<div id="app" class="flex flex-col min-h-screen">
  <!-- Header/Navbar -->
  <header class="bg-white shadow sticky top-0 z-30">
    <div class="max-w-7xl mx-auto px-5 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <span class="text-2xl text-green-700 font-semibold"><i class="fas fa-seedling mr-1"></i>PestiVid</span>
      </div>
      <nav class="hidden md:flex space-x-5 items-center">
        <a href="#" @click.prevent="switchPage('landing')" :class="{'font-bold text-green-700': current==='landing'}" class="hover:text-green-600">Home</a>
        <a v-if="!loggedIn" href="#" @click.prevent="switchPage('login')" :class="{'font-bold text-green-700': current==='login'}" class="hover:text-green-600">Login</a>
        <a v-if="!loggedIn" href="#" @click.prevent="switchPage('signup')" :class="{'font-bold text-green-700': current==='signup'}" class="hover:text-green-600">Sign Up</a>
        <!-- Farmer Menu -->
        <template v-if="loggedIn && role==='farmer'">
          <a href="#" @click.prevent="switchPage('farmerPestiVid')" :class="{'font-bold text-green-700': current==='farmerPestiVid'}" class="hover:text-green-600">PestiVid</a>
          <a href="#" @click.prevent="switchPage('farmerAgriStream')" :class="{'font-bold text-green-700': current==='farmerAgriStream'}" class="hover:text-green-600">AgriStream</a>
          <a href="#" @click.prevent="switchPage('farmerSell')" :class="{'font-bold text-green-700': current==='farmerSell'}" class="hover:text-green-600">Sell</a>
          <a href="#" @click.prevent="switchPage('farmerFunding')" :class="{'font-bold text-green-700': current==='farmerFunding'}" class="hover:text-green-600">Get Funding</a>
        </template>
        <!-- Buyer Menu -->
        <template v-if="loggedIn && role==='buyer'">
          <a href="#" @click.prevent="switchPage('buyerAgriSell')" :class="{'font-bold text-green-700': current==='buyerAgriSell'}" class="hover:text-green-600">AgriSell</a>
        </template>
        <!-- Investor Menu -->
        <template v-if="loggedIn && role==='investor'">
          <a href="#" @click.prevent="switchPage('investorProjects')" :class="{'font-bold text-green-700': current==='investorProjects'}" class="hover:text-green-600">Projects</a>
          <a href="#" @click.prevent="switchPage('investorPortfolio')" :class="{'font-bold text-green-700': current==='investorPortfolio'}" class="hover:text-green-600">Portfolio</a>
        </template>
        <template v-if="loggedIn">
          <a href="#" @click.prevent="switchPage('userProfile')" :class="{'font-bold text-green-700': current==='userProfile'}" class="bg-green-600 text-white text-xs rounded-full px-3 py-1 select-none ml-2 hover:bg-green-700 flex items-center">
             <i class="fas fa-user mr-1"></i> {{ username }}
          </a>
          <a href="#" title="Logout" @click.prevent="logout" class="text-gray-400 hover:text-red-500 ml-2"><i class="fas fa-sign-out-alt"></i></a>
        </template>
      </nav>
      <button class="md:hidden text-gray-500 focus:outline-none" @click="showMobileMenu = !showMobileMenu">
        <i class="fas fa-bars text-2xl"></i>
      </button>
    </div>
    <!-- Mobile Dropdown -->
    <div v-show="showMobileMenu" class="md:hidden bg-white border-t z-40">
      <div class="py-2 flex flex-col space-y-1 px-4">
        <a href="#" @click.prevent="switchPage('landing');showMobileMenu=false" :class="{'font-bold text-green-700': current==='landing'}">Home</a>
        <a v-if="!loggedIn" href="#" @click.prevent="switchPage('login');showMobileMenu=false" :class="{'font-bold text-green-700': current==='login'}">Login</a>
        <a v-if="!loggedIn" href="#" @click.prevent="switchPage('signup');showMobileMenu=false" :class="{'font-bold text-green-700': current==='signup'}">Sign Up</a>
        <template v-if="loggedIn && role==='farmer'">
          <a href="#" @click.prevent="switchPage('farmerPestiVid');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerPestiVid'}">PestiVid</a>
          <a href="#" @click.prevent="switchPage('farmerAgriStream');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerAgriStream'}">AgriStream</a>
          <a href="#" @click.prevent="switchPage('farmerSell');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerSell'}">Sell</a>
          <a href="#" @click.prevent="switchPage('farmerFunding');showMobileMenu=false" :class="{'font-bold text-green-700': current==='farmerFunding'}">Get Funding</a>
        </template>
        <template v-if="loggedIn && role==='buyer'">
          <a href="#" @click.prevent="switchPage('buyerAgriSell');showMobileMenu=false" :class="{'font-bold text-green-700': current==='buyerAgriSell'}">AgriSell</a>
        </template>
        <template v-if="loggedIn && role==='investor'">
          <a href="#" @click.prevent="switchPage('investorProjects');showMobileMenu=false" :class="{'font-bold text-green-700': current==='investorProjects'}">Projects</a>
          <a href="#" @click.prevent="switchPage('investorPortfolio');showMobileMenu=false" :class="{'font-bold text-green-700': current==='investorPortfolio'}">Portfolio</a>
        </template>
        <template v-if="loggedIn">
           <div class="border-t mt-2 pt-2 flex justify-between items-center">
             <a href="#" @click.prevent="switchPage('userProfile');showMobileMenu=false" :class="{'font-bold text-green-700': current==='userProfile'}" class="inline-block bg-green-600 text-white text-xs rounded px-2 py-1 ml-1 flex items-center">
                <i class="fas fa-user mr-1"></i> {{ username }}
             </a>
             <a href="#" class="text-gray-400 hover:text-red-500" title="Logout" @click.prevent="logout"><i class="fas fa-sign-out-alt"></i></a>
           </div>
        </template>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-1 max-w-7xl mx-auto w-full px-4 pt-8 pb-8">
    <!-- Landing Section -->
    <section v-if="current==='landing'">
      <div class="flex flex-col md:flex-row items-center mb-12 pt-2">
        <div class="md:w-1/2 md:pr-8">
          <h1 class="text-4xl font-bold text-green-800 mb-4">PestiVid: Blockchain Transparency in Agriculture</h1>
          <p class="mb-5 text-gray-800 text-lg leading-relaxed">A secure, video-verified agricultural marketplace with investment opportunities. Farmers prove quality and safety via field recordings stored on blockchain and IPFS. Buyers purchase crops with complete confidence and traceability. Investors fund projects with transparent returns.</p>
          <ul class="text-gray-700 mb-7 space-y-1 text-base">
            <li><i class="fas fa-leaf text-green-500 mr-2"></i>Blockchain-secured video evidence</li>
            <li><i class="fas fa-cloud-upload-alt text-green-400 mr-2"></i>Decentralized video storage (IPFS/Pinata)</li>
            <li><i class="fas fa-search-dollar text-green-400 mr-2"></i>Full traceability for buyers</li>
            <li><i class="fas fa-handshake text-green-500 mr-2"></i>Direct, transparent marketplace transactions</li>
            <li><i class="fas fa-chart-line text-green-500 mr-2"></i>Investment opportunities for funders</li>
          </ul>
          <div class="mt-4 space-x-2">
            <button class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded transition" @click="getStarted">Get Started</button>
            <button class="bg-white border border-green-600 text-green-600 px-6 py-2 rounded transition" @click="switchPage(loggedIn && role==='buyer' ? 'buyerAgriSell' : loggedIn ? 'landing' : 'login')">Browse Marketplace</button>
          </div>
        </div>
        <div class="md:w-1/2 mt-10 md:mt-0 flex flex-col items-center">
          <video controls playsinline webkit-playsinline class="rounded-lg shadow-md border w-full max-w-md mx-auto">
            <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
            Demo video: your browser does not support video.
          </video>
        </div>
      </div>
      <div class="mt-10">
        <h2 class="text-2xl text-green-700 font-semibold mb-3">How It Works</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-5">
          <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
            <i class="fas fa-video text-2xl text-green-500 mb-3"></i>
            <span class="font-bold mb-1">1. Video Recording</span>
            <p class="text-sm text-gray-600 text-center">Farmers film direct evidence of their crop and practices.</p>
          </div>
          <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
            <i class="fas fa-cloud-upload-alt text-2xl text-green-500 mb-3"></i>
            <span class="font-bold mb-1">2. Upload to IPFS</span>
            <p class="text-sm text-gray-600 text-center">Videos & info are securely uploaded and stored decentrally.</p>
          </div>
          <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
            <i class="fas fa-search-dollar text-2xl text-green-500 mb-3"></i>
            <span class="font-bold mb-1">3. Verification</span>
            <p class="text-sm text-gray-600 text-center">Buyers view blockchain-verified video before any purchase.</p>
          </div>
          <div class="bg-white rounded-lg shadow p-5 flex flex-col items-center">
            <i class="fas fa-handshake text-2xl text-green-500 mb-3"></i>
            <span class="font-bold mb-1">4. Marketplace</span>
            <p class="text-sm text-gray-600 text-center">Directly connect to buy, sell, or invest, all backed by video trust.</p>
          </div>
        </div>
      </div>

      <!-- Investment Section on Landing Page -->
      <div class="mt-16 bg-green-50 rounded-lg p-8">
        <h2 class="text-2xl text-green-700 font-semibold mb-3">Agricultural Investment Platform</h2>
        <div class="flex flex-col md:flex-row items-center">
          <!-- Text content now takes full width in this container -->
          <div class="w-full">
            <p class="mb-4 text-gray-700">Invest in verified agricultural projects with full transparency. Track your investments through blockchain technology and share in the harvest profits.</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 my-6">
              <div class="bg-white rounded p-4 shadow-sm">
                <i class="fas fa-seedling text-green-600 text-2xl mb-2"></i>
                <h3 class="font-bold mb-1">Fund Crops</h3>
                <p class="text-sm">Invest in specific crops with transparent land use and practices.</p>
              </div>
              <div class="bg-white rounded p-4 shadow-sm">
                <i class="fas fa-coins text-green-600 text-2xl mb-2"></i>
                <h3 class="font-bold mb-1">Share Returns</h3>
                <p class="text-sm">Receive dividends based on harvest yields and market prices.</p>
              </div>
              <div class="bg-white rounded p-4 shadow-sm">
                <i class="fas fa-shield-alt text-green-600 text-2xl mb-2"></i>
                <h3 class="font-bold mb-1">Secure Blockchain</h3>
                <p class="text-sm">All investments and harvests recorded on immutable ledger.</p>
              </div>
            </div>
            <button class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded transition mt-2" @click="switchPage(loggedIn && role==='investor' ? 'investorProjects' : loggedIn ? 'landing' : 'signup')">Become an Investor</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Login Section -->
    <section v-if="current==='login'" class="max-w-lg mx-auto bg-white shadow rounded-lg p-8 mt-8">
      <h2 class="text-2xl font-bold text-green-700 mb-4">Sign In</h2>
      <form @submit.prevent="login">
        <div class="mb-4">
          <label class="block text-gray-600 mb-1">Email</label>
          <input v-model="loginForm.email" type="email" class="w-full px-3 py-2 border rounded" required placeholder="farmer@mail.com, buyer@mail.com, or investor@mail.com">
        </div>
        <div class="mb-6">
          <label class="block text-gray-600 mb-1">Password</label>
          <input v-model="loginForm.pass" type="password" class="w-full px-3 py-2 border rounded" required placeholder="any password">
        </div>
        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Login</button>
      </form>
      <div class="mt-4 text-sm text-gray-500">No account? <a href="#" class="text-green-700 underline" @click.prevent="switchPage('signup')">Sign up</a></div>
    </section>

    <!-- Signup Section -->
    <section v-if="current==='signup'" class="max-w-lg mx-auto bg-white shadow rounded-lg p-8 mt-8">
      <h2 class="text-2xl font-bold text-green-700 mb-4">Sign Up</h2>
      <form @submit.prevent="signup">
        <div class="mb-4">
          <label class="block text-gray-600 mb-1">Username</label>
          <input v-model="signupForm.username" type="text" class="w-full px-3 py-2 border rounded" required>
        </div>
        <div class="mb-4">
          <label class="block text-gray-600 mb-1">Email</label>
          <input v-model="signupForm.email" type="email" class="w-full px-3 py-2 border rounded" required>
        </div>
        <div class="mb-4">
          <label class="block text-gray-600 mb-1">Password</label>
          <input v-model="signupForm.pass" type="password" class="w-full px-3 py-2 border rounded" required>
        </div>
        <div class="mb-6">
          <label class="block text-gray-600 mb-1">Role</label>
          <select v-model="signupForm.role" class="w-full px-3 py-2 border rounded bg-white" required>
            <option value="" disabled>Select Role</option>
            <option value="farmer">Farmer</option>
            <option value="buyer">Buyer</option>
            <option value="investor">Investor</option>
          </select>
        </div>
        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Create Account</button>
      </form>
      <div class="mt-4 text-sm text-gray-500">Already registered? <a href="#" class="text-green-700 underline" @click.prevent="switchPage('login')">Sign in</a></div>
    </section>

    <!-- Farmer: PestiVid Recording Section -->
    <section v-if="current==='farmerPestiVid'" class="max-w-3xl mx-auto mt-6">
      <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-video mr-2"></i>PestiVid: Record Crop Video</h2>
      <div class="bg-white rounded shadow-md p-6 space-y-6">
        <form @submit.prevent>
          <!-- Updated Grid for 4 items -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div>
              <label class="block text-gray-600 mb-1 text-sm">Crop Type</label>
              <input v-model="recordForm.crop" class="w-full px-2 py-2 border rounded text-sm" required placeholder="e.g., Tomatoes">
            </div>
            <div>
              <label class="block text-gray-600 mb-1 text-sm">Field Location</label>
              <input v-model="recordForm.location" class="w-full px-2 py-2 border rounded text-sm" required placeholder="e.g., South Field">
            </div>
            <div>
              <label class="block text-gray-600 mb-1 text-sm">Pesticide Used</label>
              <input v-model="recordForm.pesticide" class="w-full px-2 py-2 border rounded text-sm" required placeholder="e.g., Neem Oil">
            </div>
             <!-- NEW FIELD: Pesticide Company -->
             <div>
              <label class="block text-gray-600 mb-1 text-sm">Pesticide Company</label>
              <input v-model="recordForm.pesticideCompany" class="w-full px-2 py-2 border rounded text-sm" required placeholder="e.g., AgriChem">
            </div>
          </div>
        </form>
        <div>
          <div class="aspect-w-16 aspect-h-9 bg-black rounded mb-3 relative" style="min-height:200px">
            <!-- Live Preview -->
            <video ref="liveVideo" v-show="showLive" class="w-full h-full rounded absolute inset-0 object-cover" autoplay muted playsinline webkit-playsinline style="background:#111"></video>
            <!-- Recorded Preview -->
            <video v-if="recordBlobUrl" :src="recordBlobUrl" controls playsinline webkit-playsinline class="w-full h-full rounded absolute inset-0 object-cover" style="background:#181818"></video>
            <div v-if="!showLive && !recordBlobUrl" class="absolute inset-0 flex justify-center items-center h-full text-gray-400"><i class="fas fa-video-slash fa-2x"></i></div>
          </div>
          <div class="flex flex-wrap gap-3 mb-2 items-center">
            <button type="button" :disabled="recording" @click="startVideo" :class="{'opacity-50 cursor-not-allowed': recording}" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">
              <i :class="recording ? 'fas fa-spinner fa-spin' : (recordBlobUrl ? 'fas fa-redo' : 'fas fa-record-vinyl')" class="mr-1"></i>
              {{ recordBlobUrl ? 'Re-Record' : (recording ? 'Starting...' : 'Start Recording') }}
            </button>
            <button v-if="recording" type="button" @click="stopVideo" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-sm">
              <i class="fas fa-stop mr-1"></i>Stop
            </button>
            <button v-if="recordBlobUrl && !uploading" type="button" @click="uploadVideo" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">
                <i class="fas fa-upload mr-1"></i>Upload to IPFS
            </button>
             <div v-if="uploading" class="flex items-center text-blue-600 text-sm ml-3">
                 <i class="fas fa-spinner fa-spin mr-2"></i> Uploading... Please wait.
             </div>
          </div>
          <p class="text-xs mt-2 text-gray-500">Allow camera access. Video file is stored locally until upload.</p>
          <div v-if="uploadCid" class="text-green-600 mt-3 bg-green-50 p-2 rounded border border-green-200 text-sm">
              <i class="fas fa-check-circle mr-1"></i> Uploaded! IPFS CID: <span class="font-mono bg-green-100 px-1 py-0.5 rounded break-all">{{ uploadCid }}</span>
          </div>
          <div v-if="uploadError" class="text-red-600 mt-3 bg-red-50 p-2 rounded border border-red-200 text-sm">
              <i class="fas fa-exclamation-triangle mr-1"></i> {{ uploadError }}
          </div>
        </div>
      </div>
    </section>

    <!-- Farmer: AgriStream (My Uploads) Section -->
    <section v-if="current==='farmerAgriStream'" class="max-w-4xl mx-auto mt-6">
      <h2 class="text-2xl font-bold text-green-700 mb-5"><i class="fas fa-stream mr-2"></i>AgriStream: My Crop Videos</h2>
      <div class="bg-white rounded shadow-md p-6">
        <div v-if="farmerVideos.length===0" class="text-gray-600 text-center p-6 bg-gray-50 rounded">
            <i class="fas fa-film text-4xl text-gray-400 mb-3"></i><br>
            No uploads yet. Go to <a href="#" class="text-green-700 underline" @click.prevent="switchPage('farmerPestiVid')">PestiVid</a> to upload.
        </div>
        <div v-else class="space-y-6">
          <div v-for="vid in farmerVideos" :key="vid.cid" class="flex flex-col md:flex-row items-start border-b last:border-b-0 pb-6 gap-6">
            <div class="w-full md:w-60 flex-shrink-0">
              <video :src="ipfsUrl(vid.cid)" controls playsinline webkit-playsinline class="rounded shadow w-full bg-black"></video>
            </div>
            <div class="flex-1">
              <div class="font-bold text-lg">{{ vid.crop }}</div>
              <div class="text-sm mb-1">Location: <span class="font-mono text-gray-700">{{ vid.location }}</span></div>
              <div class="text-sm mb-1">Pesticide: <span class="font-mono text-gray-700">{{ vid.pesticide }}</span></div>
              <!-- Display Pesticide Company -->
              <div class="text-sm mb-1">Pesticide Co.: <span class="font-mono text-gray-700">{{ vid.pesticideCompany || 'N/A' }}</span></div>
              <div class="text-xs text-gray-500 mb-2">CID: <span class="font-mono break-all">{{ vid.cid }}</span></div>
              <a :href="ipfsUrl(vid.cid)" target="_blank" class="text-blue-600 hover:underline text-xs mr-3"><i class="fas fa-external-link-alt mr-1"></i>View on Gateway</a>
              <button v-if="!isListed(vid.cid)" @click="goToListing(vid.cid)" class="text-green-600 hover:underline text-xs">
                 <i class="fas fa-tags mr-1"></i>Create Listing
              </button>
              <span v-else class="text-gray-500 text-xs"><i class="fas fa-check mr-1"></i>Already Listed</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Farmer: Sell (Create Listing) Section -->
    <section v-if="current==='farmerSell'" class="max-w-2xl mx-auto mt-6">
      <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-tags mr-2"></i>Sell Farm Crop on Marketplace</h2>
      <div class="bg-white rounded shadow-md p-6">
        <form @submit.prevent="createListing">
          <div class="mb-4">
            <label class="block text-gray-600 mb-1">Select Uploaded Video (Unlisted only)</label>
            <select v-model="listingForm.cid" class="w-full px-3 py-2 border rounded bg-white mb-2" required>
              <option value="" disabled>Select video...</option>
              <option v-for="vid in availableVideosForListing" :key="vid.cid" :value="vid.cid">
                {{ vid.crop }} ({{ vid.location }}) - Pest: {{ vid.pesticide }} by {{ vid.pesticideCompany || 'N/A' }}
              </option>
              <option v-if="availableVideosForListing.length === 0" disabled>No unlisted videos available</option>
            </select>
             <p v-if="farmerVideos.length === 0" class="text-xs text-red-500">You need to upload a video first via PestiVid.</p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">
              <div>
                  <label class="block text-gray-600 mb-1">Min Price (SOL)</label>
                  <input type="number" v-model="listingForm.minPrice" class="w-full px-3 py-2 border rounded" min="0.01" step="0.01" required placeholder="e.g., 0.5">
              </div>
              <div>
                  <label class="block text-gray-600 mb-1">Max Price (SOL)</label>
                  <input type="number" v-model="listingForm.maxPrice" class="w-full px-3 py-2 border rounded" :min="listingForm.minPrice || 0.01" step="0.01" required placeholder="e.g., 1.5">
              </div>
          </div>
          <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded w-full" :disabled="availableVideosForListing.length === 0">
            <i class="fas fa-plus-circle mr-1"></i>Create Listing
          </button>
        </form>
        <div v-if="createdListing" class="bg-green-100 text-green-700 px-4 py-2 mt-4 rounded font-medium text-sm">
            <i class="fas fa-check mr-1"></i> Listing created successfully and available for buyers!
        </div>
        <div class="mt-8">
          <h3 class="font-semibold mb-2 text-gray-700">Your Active Listings</h3>
          <div v-if="farmerListings.length===0" class="text-gray-600 text-sm bg-gray-50 p-4 rounded text-center">You have no active listings.</div>
          <ul v-else class="space-y-3">
            <li v-for="l in farmerListings" :key="l.id" class="py-3 px-4 border rounded flex flex-col sm:flex-row justify-between sm:items-center text-sm bg-white shadow-sm">
               <div>
                   <span class="font-medium">{{ l.crop }}</span>
                   <span class="text-xs text-gray-500 ml-1"> ({{l.location}})</span> <br>
                   <span class="text-xs text-gray-500"> CID: {{l.cid.substring(0, 8)}}...</span> |
                   <span class="text-xs text-gray-500"> Pest. Co: {{ l.pesticideCompany || 'N/A' }}</span>
               </div>
               <div class="mt-2 sm:mt-0 text-right">
                 <span>Min: <span class="font-mono font-semibold">{{ l.minPrice }}</span> SOL</span><br>
                 <span>Max: <span class="font-mono font-semibold">{{ l.maxPrice }}</span> SOL</span>
               </div>
               <!-- <span class="px-2 py-1 bg-green-200 text-green-900 text-xs rounded">Active</span> -->
            </li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Farmer Funding Request Section -->
    <section v-if="current==='farmerFunding'" class="max-w-3xl mx-auto mt-6">
      <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-money-bill-wave mr-2"></i>Request Funding for Your Farm</h2>
      <div class="bg-white rounded shadow-md p-6">
        <form @submit.prevent="createFundingRequest">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-gray-600 mb-1 text-sm">Project Title</label>
              <input v-model="fundingForm.title" class="w-full px-3 py-2 border rounded text-sm" required placeholder="e.g., Organic Tomato Expansion">
            </div>
            <div>
              <label class="block text-gray-600 mb-1 text-sm">Crop Type</label>
              <input v-model="fundingForm.crop" class="w-full px-3 py-2 border rounded text-sm" required placeholder="e.g., Roma Tomatoes">
            </div>
            <div>
              <label class="block text-gray-600 mb-1 text-sm">Land Size (Acres)</label>
              <input type="number" v-model.number="fundingForm.acres" class="w-full px-3 py-2 border rounded text-sm" min="0.1" step="0.1" required placeholder="e.g., 5.5">
            </div>
            <div>
              <label class="block text-gray-600 mb-1 text-sm">Funding Required (SOL)</label>
              <input type="number" v-model.number="fundingForm.amount" class="w-full px-3 py-2 border rounded text-sm" min="1" step="0.1" required placeholder="e.g., 50">
            </div>
            <div>
              <label class="block text-gray-600 mb-1 text-sm">Growing Method</label>
              <select v-model="fundingForm.method" class="w-full px-3 py-2 border rounded bg-white text-sm" required>
                <option value="">Select method...</option>
                <option value="organic">Organic</option>
                <option value="conventional">Conventional</option>
                <option value="hydroponic">Hydroponic</option>
                <option value="aquaponic">Aquaponic</option>
                 <option value="regenerative">Regenerative</option>
              </select>
            </div>
            <div>
              <label class="block text-gray-600 mb-1 text-sm">Expected ROI (%)</label>
              <input type="number" v-model.number="fundingForm.roi" class="w-full px-3 py-2 border rounded text-sm" min="1" max="100" required placeholder="e.g., 15">
            </div>
          </div>

          <div class="mb-4">
            <label class="block text-gray-600 mb-1 text-sm">Select Video Evidence</label>
            <select v-model="fundingForm.cid" class="w-full px-3 py-2 border rounded bg-white mb-2 text-sm" required>
              <option value="" disabled>Select video...</option>
              <option v-for="vid in farmerVideos" :key="vid.cid" :value="vid.cid">
                {{ vid.crop }} ({{ vid.location }}) - {{ vid.pesticideCompany || 'N/A' }}
              </option>
               <option v-if="farmerVideos.length === 0" disabled>No videos uploaded yet</option>
            </select>
            <p v-if="farmerVideos.length === 0" class="text-xs text-red-500">You need to upload a video first via PestiVid.</p>
          </div>

          <div class="mb-4">
            <label class="block text-gray-600 mb-1 text-sm">Project Description</label>
            <textarea v-model="fundingForm.description" class="w-full px-3 py-2 border rounded text-sm" rows="4" required placeholder="Describe your project, growing practices, and how funds will be used..."></textarea>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <div>
                  <label class="block text-gray-600 mb-1 text-sm">Timeline (Months)</label>
                  <input type="number" v-model.number="fundingForm.timeline" class="w-full px-3 py-2 border rounded text-sm" min="1" max="36" required placeholder="How many months until harvest?">
              </div>
              <div>
                  <label class="block text-gray-600 mb-1 text-sm">Investor Share (%)</label>
                  <input type="number" v-model.number="fundingForm.investorShare" class="w-full px-3 py-2 border rounded text-sm" min="1" max="80" required placeholder="Percentage of harvest profit for investors">
              </div>
          </div>

          <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded w-full" :disabled="farmerVideos.length === 0">
             <i class="fas fa-paper-plane mr-1"></i> Create Funding Request
          </button>
        </form>

        <div v-if="createdFundingRequest" class="bg-green-100 text-green-700 px-4 py-2 mt-4 rounded font-medium text-sm">
            <i class="fas fa-check mr-1"></i> Funding request created and is now visible to investors!
        </div>

        <div class="mt-8">
          <h3 class="font-semibold mb-2 text-gray-700">Your Active Funding Requests</h3>
          <div v-if="farmerFundingRequests.length===0" class="text-gray-600 text-sm bg-gray-50 p-4 rounded text-center">You have no active funding requests.</div>
          <div v-else class="space-y-4">
            <div v-for="req in farmerFundingRequests" :key="req.id" class="border rounded-lg overflow-hidden shadow-sm bg-white">
              <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 bg-gray-50 border-b">
                <h4 class="font-bold mb-2 sm:mb-0">{{ req.title }}</h4>
                <div class="flex items-center space-x-2">
                   <span :class="{'bg-yellow-100 text-yellow-800': req.status === 'pending', 'bg-green-100 text-green-800': req.status === 'funded', 'bg-blue-100 text-blue-800': req.status === 'partially_funded'}" class="px-2 py-1 rounded text-xs font-medium">
                       {{ req.status === 'pending' ? 'Pending' : req.status === 'funded' ? 'Fully Funded' : 'Partially Funded' }}
                   </span>
                </div>
              </div>
              <div class="p-4">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 text-sm">
                  <div>
                    <div class="text-xs text-gray-500">Crop</div>
                    <div>{{ req.crop }}</div>
                  </div>
                  <div>
                    <div class="text-xs text-gray-500">Land Size</div>
                    <div>{{ req.acres }} acres</div>
                  </div>
                  <div>
                    <div class="text-xs text-gray-500">Required</div>
                    <div>{{ req.amount }} SOL</div>
                  </div>
                  <div>
                    <div class="text-xs text-gray-500">Investor Share</div>
                    <div>{{ req.investorShare }}%</div>
                  </div>
                </div>

                <div class="mb-4">
                  <div class="text-xs text-gray-500 mb-1">Funding Progress</div>
                  <div class="progress-bar">
                    <div class="progress-fill bg-green-500" :style="{width: fundingProgressPercent(req) + '%'}"></div>
                  </div>
                  <div class="flex justify-between text-xs mt-1">
                    <span>{{ req.fundedAmount }} SOL raised</span>
                    <span>{{ fundingProgressPercent(req) }}% Complete</span>
                  </div>
                </div>

                <div v-if="req.fundedAmount > 0 && req.investors.length > 0" class="mb-4">
                  <div class="text-xs text-gray-500 mb-2">Investors ({{req.investors.length}})</div>
                  <div class="text-sm max-h-24 overflow-y-auto border rounded p-2 bg-gray-50 space-y-1">
                    <div v-for="investor in req.investors" :key="investor.id" class="flex justify-between items-center py-1 text-xs">
                      <span><i class="fas fa-user text-gray-400 mr-1"></i>{{ investor.username }}</span>
                      <span class="font-mono bg-blue-100 text-blue-800 px-1 rounded">{{ investor.amount }} SOL</span>
                    </div>
                  </div>
                </div>

                <div class="flex justify-end mt-4">
                  <button v-if="req.status !== 'funded'" class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200" @click="cancelFundingRequest(req.id)">
                    <i class="fas fa-times mr-1"></i>Cancel Request
                  </button>
                   <span v-if="req.status === 'funded'" class="text-xs text-green-600"><i class="fas fa-check-circle mr-1"></i>Fully Funded!</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Buyer: Marketplace (AgriSell) Section -->
    <section v-if="current==='buyerAgriSell'" class="max-w-6xl mx-auto mt-6">
      <h2 class="text-2xl font-bold text-green-700 mb-3"><i class="fas fa-shopping-basket mr-2"></i>AgriSell: Marketplace</h2>
      <div class="bg-white rounded shadow-md p-6 mb-7">
        <div class="flex flex-col md:flex-row md:items-end gap-5">
          <div class="w-full md:w-48">
            <label class="text-gray-600 text-sm">Crop Type</label>
            <select v-model="buyerFilters.crop" class="w-full px-2 py-1 border rounded bg-white text-sm">
              <option value="">All</option>
              <option v-for="c in uniqueCrops" :key="c">{{c}}</option>
            </select>
          </div>
          <div class="flex-1">
            <label class="text-gray-600 text-sm">Location</label>
            <input v-model="buyerFilters.location" class="w-full px-2 py-1 border rounded text-sm" placeholder="Search by location...">
          </div>
           <div class="flex-1">
            <label class="text-gray-600 text-sm">Pesticide Co.</label>
            <input v-model="buyerFilters.pesticideCompany" class="w-full px-2 py-1 border rounded text-sm" placeholder="Search by pesticide company...">
          </div>
          <button type="button" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-1 rounded text-sm mt-2 md:mt-0" @click="resetBuyerFilters">
            <i class="fas fa-undo mr-1"></i> Reset Filters
          </button>
        </div>
      </div>
      <div v-if="filteredListings.length === 0" class="text-gray-600 bg-gray-50 p-8 text-center rounded">
          <i class="fas fa-search text-4xl text-gray-400 mb-3"></i><br>
          No listings found matching your criteria. Try adjusting your filters.
      </div>
      <div v-else class="grid gap-8 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
        <div v-for="l in filteredListings" :key="l.id" class="bg-white rounded shadow p-4 flex flex-col">
          <div class="mb-3 flex justify-center">
            <video :src="ipfsUrl(l.cid)" controls playsinline webkit-playsinline class="rounded w-full max-h-52 bg-black object-cover"></video>
          </div>
          <div class="mb-1 font-bold text-lg">{{ l.crop }}</div>
          <div class="text-xs text-gray-500 mb-1">Location: <span class="font-mono">{{ l.location }}</span></div>
          <div class="text-xs text-gray-500 mb-1">Pesticide: <span class="font-mono">{{ l.pesticide }}</span></div>
          <!-- Display Pesticide Company -->
          <div class="text-xs text-gray-500 mb-2">Pesticide Co.: <span class="font-mono">{{ l.pesticideCompany || 'N/A' }}</span></div>
          <div class="text-sm my-2">Price Range: <br><span class="font-mono text-base font-semibold">{{ l.minPrice }}</span> - <span class="font-mono text-base font-semibold">{{ l.maxPrice }}</span> SOL</div>
          <button class="mt-auto bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded text-sm" @click="buyListing(l)" :disabled="!loggedIn || role !== 'buyer'">
              <i class="fas fa-shopping-cart mr-1"></i>
              {{ loggedIn && role === 'buyer' ? 'Initiate Purchase' : 'Login as Buyer to Purchase' }}
          </button>
        </div>
      </div>
    </section>

    <!-- Investor Projects Section -->
    <section v-if="current==='investorProjects'" class="max-w-6xl mx-auto mt-6">
      <h2 class="text-2xl font-bold text-green-700 mb-3"><i class="fas fa-project-diagram mr-2"></i>Investment Opportunities</h2>

      <div class="bg-white rounded shadow-md p-6 mb-7">
        <div class="flex flex-col md:flex-row md:items-end gap-5">
          <div class="w-full md:w-48">
            <label class="text-gray-600 text-sm">Crop Type</label>
            <select v-model="investorFilters.crop" class="w-full px-2 py-1 border rounded bg-white text-sm">
              <option value="">All Crops</option>
              <option v-for="c in uniqueFundingCrops" :key="c">{{c}}</option>
            </select>
          </div>
          <div class="w-full md:w-48">
            <label class="text-gray-600 text-sm">Growing Method</label>
            <select v-model="investorFilters.method" class="w-full px-2 py-1 border rounded bg-white text-sm">
              <option value="">All Methods</option>
              <option value="organic">Organic</option>
              <option value="conventional">Conventional</option>
              <option value="hydroponic">Hydroponic</option>
              <option value="aquaponic">Aquaponic</option>
              <option value="regenerative">Regenerative</option>
            </select>
          </div>
          <div class="w-full md:w-48">
            <label class="text-gray-600 text-sm">Min ROI (%)</label>
            <input type="number" v-model.number="investorFilters.minRoi" class="w-full px-2 py-1 border rounded text-sm" placeholder="e.g., 10">
          </div>
           <div class="w-full md:w-48">
            <label class="text-gray-600 text-sm">Max Funding Needed (SOL)</label>
            <input type="number" v-model.number="investorFilters.maxAmount" class="w-full px-2 py-1 border rounded text-sm" placeholder="e.g., 100">
          </div>
          <button type="button" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-1 rounded text-sm mt-2 md:mt-0" @click="resetInvestorFilters">
             <i class="fas fa-undo mr-1"></i> Reset Filters
          </button>
        </div>
      </div>

      <div class="grid gap-6 grid-cols-1 lg:grid-cols-2">
        <div v-for="project in filteredFundingRequests" :key="project.id" class="bg-white rounded-lg shadow overflow-hidden">
          <div class="p-5 bg-gray-50 border-b flex flex-col sm:flex-row justify-between sm:items-center">
            <h3 class="font-bold text-lg text-green-800 mb-2 sm:mb-0">{{ project.title }}</h3>
            <span :class="{'bg-yellow-100 text-yellow-800': project.status === 'pending', 'bg-green-100 text-green-800': project.status === 'funded', 'bg-blue-100 text-blue-800': project.status === 'partially_funded'}" class="px-2 py-1 rounded text-xs font-medium self-start sm:self-center">
              {{ project.status === 'pending' ? 'Seeking Funding' : project.status === 'funded' ? 'Fully Funded' : 'Partially Funded' }}
            </span>
          </div>

          <div class="p-5">
            <div class="flex flex-col md:flex-row gap-6">
              <div class="md:w-1/3">
                <video :src="ipfsUrl(project.cid)" controls playsinline webkit-playsinline class="rounded w-full h-40 object-cover bg-black mb-3"></video>

                 <!-- *** MODIFIED Farmer Info Section *** -->
                 <div class="grid grid-cols-2 gap-2 text-sm">
                  <div>
                    <div class="text-xs text-gray-500">Farmer</div>
                    <div class="font-medium truncate flex items-center">
                       <span>{{ project.farmerName }}</span>
                       <!-- *** ADDED Farmer Profile Button *** -->
                       <button @click="showFarmerProfile(project.farmerName)" class="ml-2 text-blue-500 hover:text-blue-700 text-xs focus:outline-none" title="View Farmer Info">
                           <i class="fas fa-info-circle"></i>
                       </button>
                    </div>
                  </div>
                  <div>
                    <div class="text-xs text-gray-500">Land Size</div>
                    <div class="font-medium">{{ project.acres }} acres</div>
                  </div>
                  <div>
                    <div class="text-xs text-gray-500">Timeline</div>
                    <div class="font-medium">{{ project.timeline }} months</div>
                  </div>
                  <div>
                    <div class="text-xs text-gray-500">Expected ROI</div>
                    <div class="font-medium text-green-700">{{ project.roi }}%</div>
                  </div>
                </div>
                <!-- *** END MODIFIED Farmer Info Section *** -->
              </div>

              <div class="md:w-2/3">
                <div class="mb-4">
                  <div class="text-sm font-medium mb-1">{{ project.crop }} ({{ project.method }})</div>
                  <p class="text-sm text-gray-700 max-h-20 overflow-y-auto">{{ project.description }}</p>
                </div>

                <div class="mb-4">
                  <div class="text-xs text-gray-500 mb-1">Funding Progress</div>
                  <div class="progress-bar">
                    <div class="progress-fill bg-green-500" :style="{width: fundingProgressPercent(project) + '%'}"></div>
                  </div>
                  <div class="flex justify-between text-xs mt-1">
                    <span>{{ project.fundedAmount }} / {{ project.amount }} SOL</span>
                    <span>{{ fundingProgressPercent(project) }}% Complete</span>
                  </div>
                </div>

                <div class="mb-4">
                  <div class="flex justify-between items-center mb-2">
                    <div class="text-sm font-medium">Investment Terms</div>
                    <div class="text-xs text-gray-500">Investor Share: {{ project.investorShare }}% of profit</div>
                  </div>
                  <div class="p-3 bg-yellow-50 rounded text-sm border border-yellow-200">
                    <p>Invest to receive {{ project.investorShare }}% of the profits, proportional to your investment. Expected return is {{ project.roi }}% over {{ project.timeline }} months.</p>
                  </div>
                </div>

                <div class="flex flex-col sm:flex-row justify-between items-center mt-4 pt-4 border-t">
                  <div class="mb-3 sm:mb-0">
                    <label :for="'investment-amount-'+project.id" class="text-xs text-gray-500 block mb-1">Your Investment (SOL)</label>
                    <input v-model.number="investmentAmounts[project.id]" type="number" :id="'investment-amount-'+project.id" class="px-3 py-1 border rounded w-full sm:w-32 text-sm" min="0.1" :max="project.amount - project.fundedAmount" step="0.1" :disabled="project.status === 'funded' || !loggedIn || role !== 'investor'" :placeholder="maxInvestmentAmount(project) > 0 ? `Max ${maxInvestmentAmount(project)}` : 'Funded'">
                  </div>
                  <button @click="investInProject(project)" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm w-full sm:w-auto" :disabled="project.status === 'funded' || !loggedIn || role !== 'investor' || !investmentAmounts[project.id] || investmentAmounts[project.id] <= 0 || investmentAmounts[project.id] > maxInvestmentAmount(project)">
                    <i class="fas fa-coins mr-1"></i>
                    {{ project.status === 'funded' ? 'Fully Funded' : (!loggedIn || role !== 'investor' ? 'Login as Investor' : 'Invest Now') }}
                  </button>
                </div>
                 <div v-if="investmentErrors[project.id]" class="text-red-500 text-xs mt-2">{{ investmentErrors[project.id] }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div v-if="filteredFundingRequests.length === 0" class="bg-gray-50 p-8 text-center rounded-lg mt-4">
        <i class="fas fa-seedling text-gray-300 text-4xl mb-3"></i>
        <h3 class="text-gray-600 text-lg mb-2">No Projects Found</h3>
        <p class="text-gray-500">Try adjusting your filters or check back later for new investment opportunities.</p>
      </div>
    </section>

    <!-- Investor Portfolio Section -->
    <section v-if="current==='investorPortfolio'" class="max-w-6xl mx-auto mt-6">
      <h2 class="text-2xl font-bold text-green-700 mb-4"><i class="fas fa-chart-pie mr-2"></i>Investment Portfolio</h2>

      <!-- Portfolio Overview - Now takes full width -->
      <div class="bg-white rounded-lg shadow p-6 mb-8">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Portfolio Overview</h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
             <div class="mb-4 md:mb-0">
                <div class="text-xs text-gray-500">Total Invested</div>
                <div class="text-2xl font-bold text-green-700">{{ totalInvestedAmount }} SOL</div>
            </div>
            <div>
                <div class="text-xs text-gray-500">Active Projects</div>
                <div class="text-xl font-bold">{{ investorActiveProjects }}</div>
            </div>
            <div>
                <div class="text-xs text-gray-500">Completed</div>
                <div class="text-xl font-bold">{{ investorCompletedProjects }}</div>
            </div>
            <div>
                <div class="text-xs text-gray-500">Avg. ROI</div>
                <div class="text-xl font-bold text-green-700">{{ investorAvgRoi }}%</div>
            </div>
          </div>
      </div>

      <div class="bg-white rounded-lg shadow overflow-hidden mb-8">
        <div class="px-6 py-4 bg-gray-50 border-b">
          <h3 class="text-lg font-semibold text-gray-800">Your Active Investments</h3>
        </div>

        <div v-if="investorInvestments.length === 0" class="p-8 text-center">
          <i class="fas fa-chart-line text-gray-300 text-4xl mb-3"></i>
          <h4 class="text-gray-600 text-lg mb-2">No Active Investments</h4>
          <p class="text-gray-500 mb-4">You haven't invested in any agricultural projects yet.</p>
          <button @click="switchPage('investorProjects')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">
            <i class="fas fa-search mr-1"></i>Browse Projects
          </button>
        </div>

        <div v-else class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Farmer</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invested (SOL)</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Expected Return (SOL)</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <tr v-for="investment in investorInvestments" :key="investment.id">
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm font-medium text-gray-900">{{ investment.projectTitle }}</div>
                  <div class="text-xs text-gray-500">{{ investment.crop }}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900">{{ investment.farmerName }}</div>
                   <!-- *** ADDED Farmer Profile Button Here Too (Optional) *** -->
                    <button @click="showFarmerProfile(investment.farmerName)" class="text-blue-500 hover:text-blue-700 text-xs focus:outline-none" title="View Farmer Info">
                           <i class="fas fa-info-circle mr-1"></i>View Info
                    </button>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900 font-mono">{{ investment.amount }}</div>
                  <div class="text-xs text-gray-500">{{ investment.investmentDate }}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="w-24 bg-gray-200 rounded-full h-2.5">
                    <div class="bg-green-600 h-2.5 rounded-full" :style="{width: investment.progress+'%'}"></div>
                  </div>
                  <div class="text-xs text-gray-500 mt-1">{{ investment.progress }}% Complete</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900 font-mono">{{ calculateExpectedReturn(investment) }}</div>
                  <div class="text-xs text-gray-500">{{ investment.roi }}% ROI</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span :class="{
                    'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true,
                    'bg-blue-100 text-blue-800': investment.status === 'active',
                    'bg-green-100 text-green-800': investment.status === 'harvested',
                    'bg-yellow-100 text-yellow-800': investment.status === 'growing'
                  }">
                    {{ investment.status.charAt(0).toUpperCase() + investment.status.slice(1) }}
                  </span>
                </td>
                 <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">
                     <a href="#" @click.prevent="viewInvestmentDetails(investment)" class="hover:underline">View</a>
                 </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Blockchain Transaction History -->
      <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="px-6 py-4 bg-gray-50 border-b flex justify-between items-center">
          <h3 class="text-lg font-semibold text-gray-800">Blockchain Transaction History</h3>
          <span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded-full flex items-center">
             <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 16 15"><path d="m7.81 0-1.78 3.69L1.88 4.2l2.92 2.52L4.04 10 7.8 7.97 11.55 10l-.77-3.28 2.92 2.52-4.15-.51L7.82 0h-.01Zm0 15-1.78-3.69-4.15-.51 2.92-2.52L4.04 5 7.8 7.03 11.55 5l-.77 3.28 2.92 2.52-4.15.51L7.82 15h-.01Z"></path></svg>
             Solana Network (Simulated)
          </span>
        </div>

        <div v-if="investorTransactions.length === 0" class="p-8 text-center">
          <i class="fas fa-cubes text-gray-300 text-4xl mb-3"></i>
          <h4 class="text-gray-600 text-lg mb-2">No Transactions Yet</h4>
          <p class="text-gray-500">Your investment and payout transactions on the blockchain will appear here.</p>
        </div>

        <div v-else class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Transaction Hash</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount (SOL)</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <tr v-for="tx in investorTransactions" :key="tx.id">
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <div class="text-sm font-mono text-gray-900 truncate max-w-[150px] sm:max-w-[250px]" :title="tx.txHash">{{ tx.txHash.substring(0,10) }}...{{ tx.txHash.substring(tx.txHash.length-10) }}</div>
                    <a :href="solanaExplorerUrl(tx.txHash)" target="_blank" class="ml-1 text-blue-500 hover:text-blue-700" title="View on Solana Explorer">
                      <i class="fas fa-external-link-alt text-xs"></i>
                    </a>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span :class="{
                    'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true,
                    'bg-green-100 text-green-800': tx.type === 'investment',
                    'bg-blue-100 text-blue-800': tx.type === 'payout'
                  }">
                    {{ tx.type === 'investment' ? 'Investment' : 'Harvest Payout' }}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm font-mono text-gray-900">{{ tx.amount }}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                    Confirmed
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm text-gray-900">{{ tx.date }}</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>


    <!-- User Profile Section -->
    <section v-if="current==='userProfile'" class="max-w-6xl mx-auto mt-6">
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <!-- Profile Header -->
            <div class="bg-gradient-to-r from-green-700 to-green-500 p-6 text-white">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center mb-4 md:mb-0">
                <div class="bg-white rounded-full w-16 h-16 flex items-center justify-center mr-4 text-green-600 shadow">
                    <i class="fas fa-user text-3xl"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold">{{ username }}</h2>
                    <p class="text-green-100 capitalize">
                        {{ role === 'farmer' ? 'Agricultural Producer' : role === 'buyer' ? 'Crop Buyer' : 'Agricultural Investor' }}
                    </p>
                </div>
                </div>
                <div class="bg-white bg-opacity-20 rounded-lg px-4 py-2 flex items-center text-sm">
                <i class="fas fa-certificate mr-2"></i>
                <span>{{ role === 'farmer' ? 'Verified Farmer' : role === 'buyer' ? 'Verified Buyer' : 'Verified Investor' }}</span>
                </div>
            </div>
            </div>

            <!-- Profile Content -->
            <div class="p-6">
            <!-- Account Information -->
            <div class="mb-8">
                <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center">
                <i class="fas fa-id-card mr-2"></i>Account Information
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                <div>
                    <div class="mb-4">
                    <p class="text-gray-600">Username</p>
                    <p class="font-medium">{{ username }}</p>
                    </div>
                    <div>
                    <p class="text-gray-600">Account Type</p>
                    <p class="font-medium capitalize">{{ role }}</p>
                    </div>
                </div>
                <div>
                    <div class="mb-4">
                    <p class="text-gray-600">Email</p>
                    <p class="font-medium">{{ userEmail || 'Not Provided' }}</p>
                    </div>
                    <div>
                    <p class="text-gray-600">Member Since</p>
                    <p class="font-medium">{{ memberSince || 'N/A' }}</p>
                    </div>
                </div>
                </div>
            </div>

            <!-- Farmer-specific content -->
            <div v-if="role === 'farmer'">
                <!-- Uploaded Videos -->
                <div class="mb-8">
                <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center">
                    <i class="fas fa-video mr-2"></i>Your Uploaded Videos ({{ farmerVideos.length }})
                </h3>
                <div v-if="farmerVideos.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center">
                    <i class="fas fa-film text-gray-400 text-2xl mb-2"></i>
                    <p>You haven't uploaded any videos yet.</p>
                    <button @click="switchPage('farmerPestiVid')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Upload your first video</button>
                </div>
                <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div v-for="vid in farmerVideos" :key="vid.cid" class="bg-gray-50 rounded-lg p-4 shadow-sm">
                    <video :src="ipfsUrl(vid.cid)" controls playsinline webkit-playsinline class="w-full h-40 object-cover bg-black rounded mb-3"></video>
                    <h4 class="font-bold">{{ vid.crop }}</h4>
                    <div class="text-sm mb-1">Location: {{ vid.location }}</div>
                    <div class="text-sm mb-1">Pesticide: {{ vid.pesticide }}</div>
                    <!-- Display Pesticide Company -->
                    <div class="text-sm mb-2">Pesticide Co.: {{ vid.pesticideCompany || 'N/A' }}</div>
                    <div class="flex justify-between items-center mt-2 text-xs text-gray-500">
                        <span class="font-mono truncate" :title="vid.cid">CID: {{ vid.cid.substring(0, 10) }}...</span>
                        <a :href="ipfsUrl(vid.cid)" target="_blank" class="text-blue-600 hover:underline">View</a>
                    </div>
                    </div>
                </div>
                </div>

                <!-- Active Listings -->
                <div class="mb-8">
                <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center">
                    <i class="fas fa-tags mr-2"></i>Your Active Listings ({{ farmerListings.length }})
                </h3>
                <div v-if="farmerListings.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center">
                    <i class="fas fa-store text-gray-400 text-2xl mb-2"></i>
                    <p>You don't have any active listings.</p>
                    <button @click="switchPage('farmerSell')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Create your first listing</button>
                </div>
                <div v-else>
                    <div class="overflow-x-auto">
                    <table class="min-w-full border divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Crop</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pesticide Co.</th> <!-- Added Col -->
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price Range (SOL)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                        <tr v-for="listing in farmerListings" :key="listing.id">
                            <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">{{ listing.crop }}</div>
                            <div class="text-xs text-gray-500" :title="listing.cid">CID: {{ listing.cid.substring(0, 8) }}...</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ listing.location }}
                            </td>
                            <!-- Added Cell -->
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ listing.pesticideCompany || 'N/A' }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900 font-mono">{{ listing.minPrice }} - {{ listing.maxPrice }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                Active
                            </span>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    </div>
                </div>
                </div>

                <!-- Funding Requests -->
                <div>
                <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center">
                    <i class="fas fa-hand-holding-usd mr-2"></i>Your Funding Requests ({{ farmerFundingRequests.length }})
                </h3>
                <div v-if="farmerFundingRequests.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center">
                    <i class="fas fa-money-bill-wave text-gray-400 text-2xl mb-2"></i>
                    <p>You haven't created any funding requests yet.</p>
                    <button @click="switchPage('farmerFunding')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Request funding for your farm</button>
                </div>
                <div v-else class="space-y-4">
                    <div v-for="req in farmerFundingRequests" :key="req.id" class="border rounded-lg overflow-hidden bg-white shadow-sm">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 bg-green-50 border-b">
                        <h4 class="font-bold mb-1 sm:mb-0">{{ req.title }}</h4>
                        <span :class="{'bg-yellow-100 text-yellow-800': req.status === 'pending', 'bg-green-100 text-green-800': req.status === 'funded', 'bg-blue-100 text-blue-800': req.status === 'partially_funded'}" class="px-2 py-1 rounded text-xs font-medium">
                        {{ req.status === 'pending' ? 'Pending' : req.status === 'funded' ? 'Fully Funded' : 'Partially Funded' }}
                        </span>
                    </div>

                    <div class="p-4 text-sm">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <div class="text-xs text-gray-500">Crop</div>
                            <div>{{ req.crop }}</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500">Land Size</div>
                            <div>{{ req.acres }} acres</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500">Required</div>
                            <div class="font-mono">{{ req.amount }} SOL</div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500">Raised</div>
                            <div class="font-mono">{{ req.fundedAmount }} SOL</div>
                        </div>
                        </div>

                        <div class="mb-4">
                        <div class="text-xs text-gray-500 mb-1">Funding Progress</div>
                        <div class="progress-bar">
                            <div class="progress-fill bg-green-500" :style="{width: fundingProgressPercent(req) + '%'}"></div>
                        </div>
                        <div class="text-xs mt-1">{{ fundingProgressPercent(req) }}% Complete</div>
                        </div>
                         <div class="flex justify-end mt-4">
                           <button v-if="req.status !== 'funded'" class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200" @click="cancelFundingRequest(req.id)">
                             <i class="fas fa-times mr-1"></i>Cancel Request
                           </button>
                            <span v-if="req.status === 'funded'" class="text-xs text-green-600"><i class="fas fa-check-circle mr-1"></i>Fully Funded!</span>
                         </div>
                    </div>
                    </div>
                </div>
                </div>
            </div>

            <!-- Buyer-specific content -->
            <div v-if="role === 'buyer'">
                <!-- Purchase History -->
                <div>
                <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center">
                    <i class="fas fa-shopping-basket mr-2"></i>Your Purchase History ({{ buyerPurchases.length }})
                </h3>
                <div v-if="buyerPurchases.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center">
                    <i class="fas fa-shopping-cart text-gray-400 text-2xl mb-2"></i>
                    <p>You haven't made any purchases yet.</p>
                    <button @click="switchPage('buyerAgriSell')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Browse marketplace</button>
                </div>
                <div v-else>
                    <div class="overflow-x-auto">
                    <table class="min-w-full border divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Crop</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pesticide Co.</th> <!-- Added Col -->
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price Paid (SOL)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Purchase Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Video</th>
                        </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                        <tr v-for="purchase in buyerPurchases" :key="purchase.id">
                            <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">{{ purchase.crop }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ purchase.location }}
                            </td>
                            <!-- Added Cell -->
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ purchase.pesticideCompany || 'N/A' }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-mono">
                            {{ purchase.price }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ purchase.date }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">
                            <a href="#" @click.prevent="viewPurchaseVideo(purchase)" class="hover:underline">View</a>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    </div>

                </div>
                </div>
            </div>

            <!-- Investor-specific content -->
            <div v-if="role === 'investor'">
                <!-- Investment Portfolio Summary -->
                <div class="mb-8">
                <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center">
                    <i class="fas fa-chart-pie mr-2"></i>Investment Portfolio Summary
                </h3>

                <div v-if="investorInvestments.length === 0" class="bg-gray-100 rounded p-4 text-gray-600 text-center">
                    <i class="fas fa-coins text-gray-400 text-2xl mb-2"></i>
                    <p>You haven't made any investments yet.</p>
                    <button @click="switchPage('investorProjects')" class="text-green-600 hover:text-green-700 underline mt-2 text-sm">Browse investment opportunities</button>
                </div>

                <div v-else>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-500">Total Invested</div>
                        <div class="text-xl font-bold text-green-700">{{ totalInvestedAmount }} SOL</div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-500">Projects</div>
                        <div class="text-xl font-bold">{{ investorInvestments.length }}</div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-500">Avg. ROI</div>
                        <div class="text-xl font-bold text-green-700">{{ investorAvgRoi }}%</div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="text-sm text-gray-500">Completed</div>
                         <div class="text-xl font-bold">{{ investorCompletedProjects }}</div>
                    </div>
                    </div>

                    <div class="overflow-x-auto mt-4">
                    <h4 class="text-lg font-semibold text-gray-800 mb-3">Your Investments</h4>
                    <table class="min-w-full border divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Farmer</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount (SOL)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                        </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                        <tr v-for="inv in investorInvestments" :key="inv.id">
                            <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">{{ inv.projectTitle }}</div>
                            <div class="text-xs text-gray-500">{{ inv.crop }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{ inv.farmerName }}
                                <!-- Farmer Profile Button Added Here Too (Optional) -->
                                <button @click="showFarmerProfile(inv.farmerName)" class="ml-1 text-blue-500 hover:text-blue-700 text-xs focus:outline-none" title="View Farmer Info">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-mono text-gray-900">{{ inv.amount }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ inv.investmentDate }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                            <span :class="{'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true, 'bg-blue-100 text-blue-800': inv.status === 'active', 'bg-green-100 text-green-800': inv.status === 'harvested', 'bg-yellow-100 text-yellow-800': inv.status === 'growing'}">
                                {{ inv.status.charAt(0).toUpperCase() + inv.status.slice(1) }}
                            </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600">
                            <a href="#" @click.prevent="viewInvestmentDetails(inv)" class="hover:underline">View</a>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    </div>
                     <div class="mt-4 text-right">
                         <button @click="switchPage('investorPortfolio')" class="text-green-700 text-sm hover:underline">Go to Full Portfolio <i class="fas fa-arrow-right ml-1"></i></button>
                     </div>
                </div>
                </div>

                <!-- Blockchain Verification -->
                <div>
                <h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2 flex items-center">
                    <i class="fas fa-link mr-2"></i>Blockchain Verification
                </h3>

                <div class="bg-gray-50 p-5 rounded-lg border">
                    <div class="flex items-center mb-4">
                    <i class="fas fa-shield-alt text-green-600 text-2xl mr-3"></i>
                    <div>
                        <h4 class="font-bold text-gray-800">Blockchain-Secured Investments</h4>
                        <p class="text-sm text-gray-600">All your investment transactions are recorded on the Solana blockchain (Simulated).</p>
                    </div>
                    </div>

                    <div v-if="investorTransactions.length > 0" class="mt-4">
                    <h5 class="font-medium text-sm mb-2">Recent Transactions</h5>
                    <div class="space-y-2">
                        <div v-for="tx in investorTransactions.slice(0, 3)" :key="tx.id" class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-2 bg-white rounded border text-sm">
                           <div class="flex items-center mb-1 sm:mb-0">
                               <span :class="{'px-2 py-0.5 text-xs rounded-full mr-2': true, 'bg-green-100 text-green-800': tx.type === 'investment', 'bg-blue-100 text-blue-800': tx.type === 'payout'}">
                                {{ tx.type === 'investment' ? 'Invest' : 'Payout' }}
                                </span>
                                <span class="font-mono text-xs text-gray-500 truncate" :title="tx.txHash">{{ tx.txHash.substring(0, 8) }}...{{ tx.txHash.substring(tx.txHash.length - 8) }}</span>
                                 <a :href="solanaExplorerUrl(tx.txHash)" target="_blank" class="ml-1 text-blue-500 hover:text-blue-700" title="View on Solana Explorer">
                                   <i class="fas fa-external-link-alt text-xs"></i>
                                 </a>
                           </div>
                           <div class="text-right w-full sm:w-auto">
                                <div class="font-mono text-sm">{{ tx.amount }} SOL</div>
                                <div class="text-xs text-gray-500">{{ tx.date }}</div>
                           </div>
                        </div>
                    </div>
                    <div class="mt-3 text-right">
                        <button @click="switchPage('investorPortfolio')" class="text-green-700 text-sm hover:underline">View all transactions <i class="fas fa-arrow-right ml-1"></i></button>
                    </div>
                    </div>

                    <div v-else class="bg-white p-4 rounded border text-center text-sm text-gray-600">
                    <p>No blockchain transactions recorded yet.</p>
                    </div>
                </div>
                </div>
            </div>
            </div>
        </div>
    </section>


     <!-- Purchase Video Modal -->
    <div v-if="selectedPurchase && showPurchaseVideo" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full modal-scrollable">
        <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white z-10">
          <h3 class="font-bold text-lg text-green-700">{{ selectedPurchase.crop }} - Purchase Verification</h3>
          <button @click="showPurchaseVideo = false" class="text-gray-500 hover:text-gray-700">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="p-4">
          <video :src="ipfsUrl(selectedPurchase.cid)" controls playsinline webkit-playsinline class="w-full rounded bg-black mb-4"></video>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            <div>
              <p class="text-gray-600">Location</p>
              <p class="font-medium">{{ selectedPurchase.location }}</p>
            </div>
            <div>
              <p class="text-gray-600">Pesticide Used</p>
              <p class="font-medium">{{ selectedPurchase.pesticide }}</p>
            </div>
            <!-- Display Pesticide Company in Modal -->
            <div>
              <p class="text-gray-600">Pesticide Company</p>
              <p class="font-medium">{{ selectedPurchase.pesticideCompany || 'N/A' }}</p>
            </div>
            <div>
              <p class="text-gray-600">Purchase Price</p>
              <p class="font-medium font-mono">{{ selectedPurchase.price }} SOL</p>
            </div>
            <div>
              <p class="text-gray-600">Purchase Date</p>
              <p class="font-medium">{{ selectedPurchase.date }}</p>
            </div>
          </div>
          <div class="mt-4 bg-gray-100 p-3 rounded text-xs border">
            <p class="font-bold mb-1">Blockchain Verification:</p>
            <p class="font-mono break-all">IPFS CID: {{ selectedPurchase.cid }}</p>
            <p class="mt-1 text-gray-500">This video evidence is permanently stored on IPFS and linked on the blockchain (Simulated).</p>
            <a :href="ipfsUrl(selectedPurchase.cid)" target="_blank" class="text-blue-600 hover:underline mt-1 inline-block">View on IPFS Gateway <i class="fas fa-external-link-alt text-xs ml-1"></i></a>
          </div>
        </div>
        <div class="bg-gray-50 p-4 flex justify-end rounded-b-lg sticky bottom-0 border-t">
          <button @click="showPurchaseVideo = false" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded text-sm">
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- Buyer: Purchase Modal -->
    <div v-if="showBuyModal && selectedListing" class="fixed inset-0 z-50 bg-black bg-opacity-60 flex justify-center items-center p-4">
      <div class="bg-white rounded shadow-lg w-full max-w-sm p-6 relative mx-2 modal-scrollable">
        <button class="absolute top-2 right-2 text-gray-400 hover:text-red-500" @click="closeBuyModal"><i class="fas fa-times"></i></button>
        <h3 class="font-bold text-green-700 text-lg mb-3">Purchase Crop Batch</h3>
        <video :src="ipfsUrl(selectedListing.cid)" controls playsinline webkit-playsinline class="rounded w-full mb-3 bg-black"></video>
        <div class="mb-1 font-bold">{{ selectedListing.crop }}</div>
        <div class="text-xs text-gray-600 mb-1">Location: <span class="font-mono">{{ selectedListing.location }}</span></div>
        <div class="text-xs text-gray-500 mb-1">Pesticide: <span class="font-mono">{{ selectedListing.pesticide }}</span></div>
        <!-- Display Pesticide Company -->
        <div class="text-xs text-gray-500 mb-2">Pesticide Co.: <span class="font-mono">{{ selectedListing.pesticideCompany || 'N/A' }}</span></div>
        <div class="text-sm mb-2">Price Range:
          <span class="mx-1 font-mono font-semibold">{{ selectedListing.minPrice }}</span> - <span class="ml-1 font-mono font-semibold">{{ selectedListing.maxPrice }}</span> SOL
        </div>
        <form @submit.prevent="processPurchase">
          <label class="text-sm block text-gray-600 mb-1">Your Offer (SOL)</label>
          <input type="number" v-model.number="purchaseAmount" :min="selectedListing.minPrice" :max="selectedListing.maxPrice" step="0.01" required
                 :placeholder="`Enter amount (${selectedListing.minPrice}-${selectedListing.maxPrice})`"
                 class="w-full px-3 py-2 border rounded mb-3 text-sm">
          <button type="submit" class="bg-green-600 hover:bg-green-700 text-white w-full py-2 rounded text-sm">
              <i class="fas fa-check mr-1"></i>Simulate Purchase
          </button>
        </form>
        <div v-if="purchaseStatus" class="text-green-700 font-semibold mt-3 text-sm bg-green-50 p-2 rounded border border-green-200">{{purchaseStatus}}</div>
        <div v-if="purchaseError" class="text-red-600 font-semibold mt-3 text-sm bg-red-50 p-2 rounded border border-red-200">{{purchaseError}}</div>
      </div>
    </div>

    <!-- Investment Details Modal -->
    <div v-if="showInvestmentDetailsModal && selectedInvestment" class="fixed inset-0 z-50 bg-black bg-opacity-70 flex justify-center items-center p-4">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl relative mx-2 modal-scrollable">
        <div class="p-4 bg-green-50 border-b flex justify-between items-center sticky top-0 z-10">
          <h3 class="font-bold text-lg text-green-800">{{ selectedInvestment.projectTitle }}</h3>
          <button class="text-gray-400 hover:text-red-500" @click="showInvestmentDetailsModal=false"><i class="fas fa-times"></i></button>
        </div>

        <div class="p-6">
          <div class="flex flex-col md:flex-row gap-6">
            <div class="md:w-1/3">
              <video :src="ipfsUrl(selectedInvestment.cid)" controls playsinline webkit-playsinline class="rounded w-full h-40 object-cover bg-black mb-3"></video>

              <div class="mt-3 space-y-2 text-sm">
                <div>
                  <div class="text-xs text-gray-500">Farmer</div>
                  <div class="font-medium flex items-center">
                      <span>{{ selectedInvestment.farmerName }}</span>
                      <!-- *** ADDED Farmer Profile Button *** -->
                      <button @click="showFarmerProfile(selectedInvestment.farmerName); showInvestmentDetailsModal=false;" class="ml-2 text-blue-500 hover:text-blue-700 text-xs focus:outline-none" title="View Farmer Info">
                           <i class="fas fa-info-circle"></i>
                      </button>
                  </div>
                </div>
                <div>
                  <div class="text-xs text-gray-500">Investment Date</div>
                  <div class="font-medium">{{ selectedInvestment.investmentDate }}</div>
                </div>
                <div>
                  <div class="text-xs text-gray-500">Amount Invested</div>
                  <div class="font-medium text-green-700 font-mono">{{ selectedInvestment.amount }} SOL</div>
                </div>
                 <div>
                  <div class="text-xs text-gray-500">Status</div>
                   <span :class="{'px-2 inline-flex text-xs leading-5 font-semibold rounded-full': true, 'bg-blue-100 text-blue-800': selectedInvestment.status === 'active', 'bg-green-100 text-green-800': selectedInvestment.status === 'harvested', 'bg-yellow-100 text-yellow-800': selectedInvestment.status === 'growing'}">
                       {{ selectedInvestment.status.charAt(0).toUpperCase() + selectedInvestment.status.slice(1) }}
                   </span>
                </div>
              </div>
            </div>

            <div class="md:w-2/3">
              <div class="mb-4">
                <div class="text-sm font-medium mb-1">{{ selectedInvestment.crop }} ({{ selectedInvestment.method }})</div>
                <p class="text-sm text-gray-700 max-h-24 overflow-y-auto border p-2 rounded bg-gray-50">{{ selectedInvestment.description }}</p>
              </div>

              <div class="mb-4">
                <div class="text-xs text-gray-500 mb-1">Project Progress</div>
                <div class="progress-bar">
                  <div class="progress-fill bg-green-500" :style="{width: selectedInvestment.progress + '%'}"></div>
                </div>
                <div class="flex justify-between text-xs mt-1">
                  <span>{{ selectedInvestment.progress }}% Complete</span>
                  <span>Est. {{ selectedInvestment.timeline }} months total</span>
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                <div>
                  <div class="text-xs text-gray-500">Expected Return</div>
                  <div class="font-medium text-green-700 font-mono">{{ calculateExpectedReturn(selectedInvestment) }} SOL</div>
                </div>
                <div>
                  <div class="text-xs text-gray-500">ROI</div>
                  <div class="font-medium text-green-700">{{ selectedInvestment.roi }}%</div>
                </div>
                <div>
                  <div class="text-xs text-gray-500">Land Size</div>
                  <div class="font-medium">{{ selectedInvestment.acres }} acres</div>
                </div>
                <div>
                  <div class="text-xs text-gray-500">Your Share</div>
                  <div class="font-medium">{{ selectedInvestment.investorShare }}%</div>
                </div>
              </div>

              <div class="bg-gray-100 p-3 rounded mb-4 border">
                <div class="text-sm font-medium mb-1">Blockchain Transaction (Simulated)</div>
                <div class="flex items-center text-xs">
                  <span class="font-mono bg-white px-2 py-1 rounded border mr-2 truncate" :title="selectedInvestment.txHash">{{ selectedInvestment.txHash }}</span>
                  <a :href="solanaExplorerUrl(selectedInvestment.txHash)" target="_blank" class="text-blue-600 hover:underline whitespace-nowrap">
                    <i class="fas fa-external-link-alt"></i> View on Explorer
                  </a>
                </div>
              </div>

              <div v-if="selectedInvestment.status === 'harvested'" class="bg-green-100 p-3 rounded border border-green-200">
                <div class="flex items-center">
                  <i class="fas fa-check-circle text-green-600 mr-2 text-lg"></i>
                  <div>
                    <div class="font-medium">Harvest Completed & Payout Processed</div>
                    <div class="text-sm">Your return of {{ calculateExpectedReturn(selectedInvestment) }} SOL has been simulated.</div>
                     <!-- Add link to payout transaction if available -->
                  </div>
                </div>
              </div>
               <div v-else-if="selectedInvestment.status === 'growing'" class="bg-yellow-50 p-3 rounded border border-yellow-200">
                  <div class="flex items-center">
                    <i class="fas fa-hourglass-half text-yellow-600 mr-2 text-lg"></i>
                    <div>
                      <div class="font-medium">Project Growing</div>
                      <div class="text-sm">Harvest expected within {{ selectedInvestment.timeline }} months. Progress: {{selectedInvestment.progress}}%.</div>
                    </div>
                  </div>
                </div>
            </div>
          </div>
        </div>

        <div class="bg-gray-50 p-4 flex justify-end rounded-b-lg sticky bottom-0 border-t">
          <button @click="showInvestmentDetailsModal=false" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded text-sm">
            Close
          </button>
        </div>
      </div>
    </div>

     <!-- *** NEW: Farmer Profile Modal *** -->
    <div v-if="showFarmerProfileModal && selectedFarmerProfile" class="fixed inset-0 z-50 bg-black bg-opacity-70 flex justify-center items-center p-4">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-md relative mx-2 modal-scrollable">
         <div class="p-4 bg-green-50 border-b flex justify-between items-center sticky top-0 z-10">
             <h3 class="font-bold text-lg text-green-800 flex items-center">
                 <i class="fas fa-user-circle mr-2"></i> Farmer Profile
             </h3>
          <button class="text-gray-400 hover:text-red-500" @click="closeFarmerProfileModal"><i class="fas fa-times"></i></button>
        </div>

        <div class="p-6 space-y-4">
            <div>
                <p class="text-xs text-gray-500">Username</p>
                <p class="font-semibold text-lg">{{ selectedFarmerProfile.username }}</p>
            </div>
            <div>
                <p class="text-xs text-gray-500">Email (Simulated)</p>
                <p class="text-sm">{{ selectedFarmerProfile.email }}</p>
            </div>
             <div>
                <p class="text-xs text-gray-500">Member Since (Simulated)</p>
                <p class="text-sm">{{ selectedFarmerProfile.memberSince }}</p>
            </div>
            <div class="border-t pt-4">
                <p class="text-xs text-gray-500">Platform Activity (Visible Requests)</p>
                <p class="text-sm">
                    <span class="font-semibold">{{ selectedFarmerProfile.fundingRequestCount }}</span> Funding Request(s) visible on the platform.
                </p>
                 <p class="text-xs text-gray-400 mt-1">(Note: Video and listing counts require full user data, not shown in this demo view).</p>
            </div>
        </div>

        <div class="bg-gray-50 p-4 flex justify-end rounded-b-lg sticky bottom-0 border-t">
          <button @click="closeFarmerProfileModal" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded text-sm">
            Close
          </button>
        </div>

      </div>
    </div>
    <!-- *** END: Farmer Profile Modal *** -->


  </main>

  <!-- Footer -->
  <footer class="bg-white border-t py-6 mt-auto text-center text-sm text-gray-500">
    <span> {{ new Date().getFullYear() }} PestiVid  Blockchain Agricultural Platform</span>
  </footer>
</div>

<script>
new Vue({
  el: "#app",
  data: {
    current: 'landing',
    showMobileMenu: false,
    loggedIn: false,
    username: '',
    role: '',
    userEmail: '',
    memberSince: '',
    loginForm: {email: '', pass: ''},
    signupForm: {username:'', email: '', pass:'', role:''},

    // Recording State
    recordForm: {crop:'', pesticide:'', location:'', pesticideCompany: ''}, // Added pesticideCompany
    recordStream: null,
    recordMediaRecorder: null,
    recording: false,
    recordBlob: null,
    recordBlobUrl: '',
    showLive: false,
    uploadCid: '',
    uploading: false,
    uploadError: '',

    // Farmer Data
    farmerVideos: [], // Will include pesticideCompany
    farmerListings: [], // Will include pesticideCompany
    listingForm: {cid:'', minPrice:'', maxPrice:''},
    createdListing: false,

    // Farmer Funding Requests
    farmerFundingRequests: [], // Requests created by this farmer
    fundingForm: {
      title: '', crop: '', acres: null, amount: null, method: '', cid: '',
      description: '', timeline: null, roi: null, investorShare: null
    },
    createdFundingRequest: false,

    // Buyer Data
    buyerPurchases: [], // Will include pesticideCompany
    selectedPurchase: null, // Will include pesticideCompany
    showPurchaseVideo: false,

    // Marketplace Data
    allListings: [], // Will include pesticideCompany // Global listing pool
    buyerFilters: {crop:'', location:'', pesticideCompany: ''}, // Added pesticideCompany filter
    showBuyModal: false,
    selectedListing: null, // Will include pesticideCompany
    purchaseAmount: null,
    purchaseStatus: '',
    purchaseError: '',

    // Investor Data
    investorInvestments: [], // Investments made by this investor
    investorTransactions: [], // Blockchain Txs for this investor
    investorFilters: {crop: '', method: '', minRoi: null, maxAmount: null},
    allFundingRequests: [], // Global funding request pool
    investmentAmounts: {}, // { projectId: amount } for inputs
    investmentErrors: {}, // { projectId: errorMsg } for inputs
    showInvestmentDetailsModal: false,
    selectedInvestment: null,

    // *** NEW: Farmer Profile Modal State ***
    showFarmerProfileModal: false,
    selectedFarmerProfile: null, // Will hold { username, email, memberSince, fundingRequestCount }

    // IPFS & Pinata - Replace with your actual details if needed
    pinataJwt: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiIwMGYyMjQxNy01ZDhjLTQ4YzgtODQwNi0zNTBlOTZkOGMwZTgiLCJlbWFpbCI6InNpbmR1a3VyaW1lZ2hhbmFAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsInBpbl9wb2xpY3kiOnsicmVnaW9ucyI6W3siZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiRlJBMSJ9LHsiZGVzaXJlZFJlcGxpY2F0aW9uQ291bnQiOjEsImlkIjoiTllDMSJ9XSwidmVyc2lvbiI6MX0sIm1mYV9lbmFibGVkIjpmYWxzZSwic3RhdHVzIjoiQUNUSVZFIn0sImF1dGhlbnRpY2F0aW9uVHlwZSI6InNjb3BlZEtleSIsInNjb3BlZEtleUtleSI6Ijc3Y2Q4YjVkNWQ2MTA2YTQ2NjQ0Iiwic2NvcGVkS2V5U2VjcmV0IjoiNWZmMjU0ODFjOTI5Yzk5YjNmM2M4OGI4MWRhNjcxZDNjZWJjMzAxMmU4Y2U1N2EyOTAyOGI1NTExZTc0MGM0NCIsImV4cCI6MTc3NzEwMzA1Nn0.J1xxbMyRmfT4aBxr5uJmPE0wjK3YS7n_kTCRSNel8F0', // Replace with your key
    pinataGateway: 'indigo-dear-baboon-356.mypinata.cloud' // Replace with your gateway if needed
  },
  computed: {
    // --- Marketplace Computeds ---
    uniqueCrops() {
      const crops = this.allListings.map(l=>l.crop).filter(Boolean);
      return [...new Set(crops)].sort();
    },
    filteredListings() {
      return this.allListings.filter(l => {
         const cropMatch = !this.buyerFilters.crop || (l.crop || '').toLowerCase() === this.buyerFilters.crop.toLowerCase();
         const locMatch = !this.buyerFilters.location || (l.location || '').toLowerCase().includes(this.buyerFilters.location.toLowerCase());
         const companyMatch = !this.buyerFilters.pesticideCompany || (l.pesticideCompany || '').toLowerCase().includes(this.buyerFilters.pesticideCompany.toLowerCase());
         return cropMatch && locMatch && companyMatch;
      });
    },
    availableVideosForListing() {
        const listedCids = new Set(this.farmerListings.map(l => l.cid));
        return this.farmerVideos.filter(v => !listedCids.has(v.cid));
    },

    // --- Investor Computeds ---
    uniqueFundingCrops() {
      const crops = this.allFundingRequests.map(r=>r.crop).filter(Boolean);
      return [...new Set(crops)].sort();
    },
    filteredFundingRequests() {
      // Filter only pending or partially funded requests for the main investment page
      return this.allFundingRequests.filter(r => {
        const isRelevantStatus = r.status === 'pending' || r.status === 'partially_funded';
        const cropMatch = !this.investorFilters.crop || (r.crop||'').toLowerCase() === this.investorFilters.crop.toLowerCase();
        const methodMatch = !this.investorFilters.method || (r.method||'').toLowerCase() === this.investorFilters.method.toLowerCase();
        const roiMatch = !this.investorFilters.minRoi || r.roi >= this.investorFilters.minRoi;
        const amountMatch = !this.investorFilters.maxAmount || r.amount <= this.investorFilters.maxAmount;
        return isRelevantStatus && cropMatch && methodMatch && roiMatch && amountMatch;
      });
    },

    // --- Portfolio Computeds ---
    totalInvestedAmount() {
        if (!this.investorInvestments || this.investorInvestments.length === 0) return '0.00';
        return this.investorInvestments.reduce((sum, inv) => sum + inv.amount, 0).toFixed(2);
    },
    investorActiveProjects() {
        if (!this.investorInvestments) return 0;
        return this.investorInvestments.filter(inv => inv.status === 'active' || inv.status === 'growing').length;
    },
    investorCompletedProjects() {
        if (!this.investorInvestments) return 0;
        return this.investorInvestments.filter(inv => inv.status === 'harvested').length;
    },
    investorAvgRoi() {
      if (!this.investorInvestments || this.investorInvestments.length === 0) return '0.0';
      const totalRoi = this.investorInvestments.reduce((sum, inv) => sum + inv.roi, 0);
      return (totalRoi / this.investorInvestments.length).toFixed(1);
    },
    investorTotalReturn() { // Renamed for clarity - this is projected based on ROI
        // This calculates the *projected* total return based on ROI
        if (!this.investorInvestments || this.investorInvestments.length === 0) return '0.00';
        return this.investorInvestments.reduce((sum, inv) => {
            const returnAmount = parseFloat(this.calculateExpectedReturn(inv)); // Calculates profit based on ROI
            return sum + inv.amount + returnAmount; // Principal + Projected Profit
      }, 0).toFixed(2);
    }
  },
  methods: {
    switchPage(page) {
      this.current = page;
      this.showMobileMenu = false; // Close mobile menu on navigation

      this.$nextTick(() => {
        if (page === 'investorPortfolio') {
          this.updateInvestmentProgress();
        }
      });
    },
    getStarted() {
      if (!this.loggedIn) {
        this.switchPage('signup');
      } else if (this.role === 'farmer') {
        this.switchPage('farmerPestiVid');
      } else if (this.role === 'buyer') {
        this.switchPage('buyerAgriSell');
      } else if (this.role === 'investor') {
        this.switchPage('investorProjects');
      } else {
         this.switchPage('landing'); // Fallback
      }
    },
    logout() {
      this.loggedIn = false;
      this.username = '';
      this.role = '';
      this.userEmail = '';
      this.memberSince = '';
      this.current = 'landing';
      this.showMobileMenu = false;
      this.loginForm = {email:'', pass:''};
      this.signupForm = {username:'', email:'', pass:'', role:''};
       console.log("Logged out");
    },
    login() {
        if (!this.loginForm.email || !this.loginForm.pass) {
            alert("Please enter both email and password."); return;
        }
        const emailLower = this.loginForm.email.toLowerCase();
        let foundRole = '';
        let demoUsername = '';

        if (emailLower.includes('farmer')) { foundRole = 'farmer'; demoUsername = 'DemoFarmer'; }
        else if (emailLower.includes('buyer')) { foundRole = 'buyer'; demoUsername = 'DemoBuyer'; }
        else if (emailLower.includes('investor')) { foundRole = 'investor'; demoUsername = 'DemoInvestor'; }
        else {
            alert("Login failed. For demo, use an email containing 'farmer', 'buyer', or 'investor'.");
            return;
        }

        this.loggedIn = true;
        this.role = foundRole;
        this.username = demoUsername;
        this.userEmail = this.loginForm.email;
        this.memberSince = this.simulateFarmerJoinDate(demoUsername); // Use helper
        this.loginForm = {email:'', pass:''}; // Reset form
        this.getStarted(); // Navigate to role-specific dashboard
        console.log(`Logged in as ${this.username} (${this.role})`);
        this.loadDemoDataIfNeeded();
    },
    signup() {
      if (!this.signupForm.username || !this.signupForm.email || !this.signupForm.pass || !this.signupForm.role) {
        alert("Please fill in all signup fields."); return;
      }
      this.loggedIn = true;
      this.username = this.signupForm.username;
      this.role = this.signupForm.role;
      this.userEmail = this.signupForm.email;
      this.memberSince = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
      this.signupForm = {username:'', email:'', pass:'', role:''}; // Reset form
      this.getStarted(); // Navigate to role-specific dashboard
       console.log(`Signed up and logged in as ${this.username} (${this.role})`);
        this.loadDemoDataIfNeeded();
    },

    // --- Video Recording & Upload ---
    async startVideo() {
        if (this.recording || this.uploading) return;
        this.recordBlob = null; this.recordBlobUrl = ''; this.uploadCid = ''; this.uploadError = '';
        this.showLive = true;
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false }); // Prefer back camera
            this.recordStream = stream;
            this.$refs.liveVideo.srcObject = stream;
            this.$refs.liveVideo.play(); // Ensure playback starts

            let chunks = [];
            this.recording = true;
            const mimeTypes = ['video/webm;codecs=vp9,opus', 'video/webm;codecs=vp8,opus', 'video/webm', 'video/mp4'];
            let selectedMimeType = mimeTypes.find(type => MediaRecorder.isTypeSupported(type));

             if (!selectedMimeType) {
                 console.warn("No preferred MIME type supported, using default.");
                 selectedMimeType = undefined; // Let the browser choose
             } else {
                console.log("Using MIME type:", selectedMimeType);
             }

            this.recordMediaRecorder = new MediaRecorder(stream, { mimeType: selectedMimeType });

            this.recordMediaRecorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); }
            this.recordMediaRecorder.onstop = () => {
                const blobType = this.recordMediaRecorder.mimeType || 'video/webm'; // Use actual mimeType if available
                this.recordBlob = new Blob(chunks, { type: blobType });
                if (this.recordBlobUrl) URL.revokeObjectURL(this.recordBlobUrl);
                this.recordBlobUrl = URL.createObjectURL(this.recordBlob);
                this.showLive = false;
                stream.getTracks().forEach(t => t.stop());
                this.recordStream = null;
                this.recording = false;
                console.log("Recording stopped, blob created:", this.recordBlobUrl, "Type:", blobType);
            }
            this.recordMediaRecorder.onerror = (e) => {
                console.error("MediaRecorder error:", e);
                this.uploadError = "Recording error occurred.";
                this.stopVideo(); // Attempt to clean up
            }
            this.recordMediaRecorder.start(1000); // Record in 1-second chunks (optional)
            console.log("Recording started...");
        } catch (e) {
            console.error("getUserMedia error:", e);
            alert("Could not access camera. Please check permissions in your browser settings.");
            this.showLive = false; this.recording = false;
        }
    },
    stopVideo() {
        if (this.recordMediaRecorder && this.recordMediaRecorder.state === "recording") {
            this.recordMediaRecorder.stop();
            console.log("Stopping recording...");
        }
        if (this.recordStream) {
            this.recordStream.getTracks().forEach(t => t.stop()); // Ensure tracks are stopped
            this.recordStream = null;
        }
        this.recording = false; // Force state update
        this.showLive = false; // Hide live view
    },
    async uploadVideo() {
        if (!this.recordBlob) { alert("No video recorded to upload."); return; }
        if (!this.recordForm.crop || !this.recordForm.pesticide || !this.recordForm.location || !this.recordForm.pesticideCompany) {
            alert("Please fill in all crop, location, pesticide, and pesticide company details before uploading."); return;
        }
        this.uploading = true; this.uploadCid = ''; this.uploadError = '';

        const formData = new FormData();
        const fileExtension = (this.recordBlob.type.split('/')[1] || 'webm').split(';')[0]; // Get extension like 'webm' or 'mp4'
        const fileName = `pestivid_${this.username}_${Date.now()}.${fileExtension}`;
        formData.append('file', this.recordBlob, fileName);
        formData.append('pinataMetadata', JSON.stringify({
            name: fileName,
            keyvalues: {
            farmer: this.username || 'unknown_farmer', // Add farmer username here
            role: this.role || 'unknown_role',
            crop: this.recordForm.crop.trim(),
            pesticide: this.recordForm.pesticide.trim(),
            location: this.recordForm.location.trim(),
            pesticideCompany: this.recordForm.pesticideCompany.trim(),
            uploadTimestamp: new Date().toISOString()
            }
        }));
        formData.append('pinataOptions', JSON.stringify({ cidVersion: 1 }));

        console.log("Uploading to Pinata...");
        try {
            const resp = await axios.post('https://api.pinata.cloud/pinning/pinFileToIPFS', formData, {
                maxBodyLength: Infinity,
                headers: { Authorization: `Bearer ${this.pinataJwt}`, 'Content-Type': 'multipart/form-data' }
            });
            this.uploadCid = resp.data.IpfsHash;
            console.log("Upload successful! CID:", this.uploadCid);

            // Save video metadata locally including farmer name
            let { crop, pesticide, location, pesticideCompany } = this.recordForm;
            this.farmerVideos.unshift({
                cid: this.uploadCid,
                farmer: this.username, // Store farmer name with video
                crop: crop.trim(),
                pesticide: pesticide.trim(),
                location: location.trim(),
                pesticideCompany: pesticideCompany.trim()
            });

            this.recordForm = { crop: '', pesticide: '', location: '', pesticideCompany: '' };
            this.recordBlob = null;
            if (this.recordBlobUrl) URL.revokeObjectURL(this.recordBlobUrl);
            this.recordBlobUrl = '';

        } catch (e) {
            this.uploadError = "Upload failed: " + (e.response?.data?.error || e.message || "Unknown error");
            console.error("Pinata Upload Error:", e.response || e);
        } finally {
            this.uploading = false;
        }
    },
    ipfsUrl(cid) {
      return cid ? `https://${this.pinataGateway}/ipfs/${cid}` : "";
    },

    // --- Farmer Listing ---
    isListed(cid) {
        return this.farmerListings.some(l => l.cid === cid);
    },
     goToListing(cid) {
        this.listingForm.cid = cid;
        this.switchPage('farmerSell');
    },
    createListing() {
        this.createdListing = false;
        if (!this.listingForm.cid || !this.listingForm.minPrice || !this.listingForm.maxPrice) {
            alert("Please select a video and enter the full price range."); return;
        }
        const minP = parseFloat(this.listingForm.minPrice);
        const maxP = parseFloat(this.listingForm.maxPrice);

        if (isNaN(minP) || isNaN(maxP) || minP <= 0 || maxP <= 0) {
            alert("Prices must be positive numbers."); return;
        }
        if (minP > maxP) {
            alert("Minimum Price cannot be greater than Maximum Price."); return;
        }

        let vid = this.farmerVideos.find(v => v.cid === this.listingForm.cid);
        if (!vid) { alert("Selected video data not found."); return; }
        if (this.isListed(vid.cid)) {
            alert("This video is already associated with an active listing."); return;
        }

        let newListing = {
            id: 'lst' + Date.now() + Math.random().toString(36).substring(2, 8),
            farmer: this.username,
            crop: vid.crop,
            location: vid.location,
            pesticide: vid.pesticide || '',
            pesticideCompany: vid.pesticideCompany || '',
            cid: vid.cid,
            minPrice: minP,
            maxPrice: maxP,
            status: 'active',
            createdAt: new Date().toISOString()
        };

        this.farmerListings.unshift({ ...newListing });
        this.allListings.unshift({ ...newListing });

        this.createdListing = true;
        this.listingForm = { cid: '', minPrice: '', maxPrice: '' };
        setTimeout(() => this.createdListing = false, 3000);
        console.log("Listing created:", newListing.id);
    },

    // --- Farmer Funding ---
    fundingProgressPercent(req) {
        if (!req || req.amount <= 0) return 0;
        return Math.round((req.fundedAmount / req.amount) * 100);
    },
    createFundingRequest() {
        this.createdFundingRequest = false; // Reset message
        const form = this.fundingForm;
        const required = ['title', 'crop', 'acres', 'amount', 'method', 'cid', 'description', 'timeline', 'roi', 'investorShare'];

        // *** ADDED CHECK: Ensure a CID is selected ***
        if (!form.cid) {
            alert("Please select the video evidence for this funding request.");
            return;
        }

        if (required.some(field => !form[field])) {
            alert("Please fill all funding request fields."); return;
        }
        if (form.acres <= 0 || form.amount <= 0 || form.timeline <= 0 || form.roi <= 0 || form.investorShare <= 0 || form.investorShare > 80) {
            alert("Please enter valid positive numbers. Investor share must be between 1-80%."); return;
        }

        // *** ADDED CHECK: Ensure the selected video actually exists in the farmer's list ***
        const vid = this.farmerVideos.find(v => v.cid === form.cid);
        if (!vid) {
            alert("Error: The selected video evidence could not be found in your uploads. Please re-select the video.");
            return;
        }

        const newRequest = {
            id: 'fr' + Date.now() + Math.random().toString(36).substring(2, 8),
            farmerName: this.username, // Critical field linking request to farmer
            title: form.title.trim(),
            crop: form.crop.trim(),
            acres: form.acres,
            amount: form.amount,
            method: form.method,
            cid: form.cid,
            description: form.description.trim(),
            timeline: form.timeline,
            roi: form.roi,
            investorShare: form.investorShare,
            fundedAmount: 0,
            status: 'pending',
            createdAt: new Date().toISOString(),
            investors: []
        };

        console.log("Creating funding request with CID:", newRequest.cid, " for farmer:", newRequest.farmerName);

        this.farmerFundingRequests.unshift({ ...newRequest });
        this.allFundingRequests.unshift({ ...newRequest });

        this.createdFundingRequest = true;
        this.fundingForm = { title: '', crop: '', acres: null, amount: null, method: '', cid: '', description: '', timeline: null, roi: null, investorShare: null };
        setTimeout(() => this.createdFundingRequest = false, 3000);
        console.log("Funding request created:", newRequest.id);
    },
    cancelFundingRequest(id) {
        const req = this.farmerFundingRequests.find(r => r.id === id);
        if (req && req.fundedAmount > 0) {
             if (!confirm("This request has received some funding. Cancelling will require refunding investors (simulated). Are you sure?")) return;
             console.log("Simulating refund for request:", id);
        } else if (!confirm("Are you sure you want to cancel this funding request?")) {
            return;
        }

        this.farmerFundingRequests = this.farmerFundingRequests.filter(r => r.id !== id);
        this.allFundingRequests = this.allFundingRequests.filter(r => r.id !== id);
        console.log("Funding request cancelled:", id);
    },

    // --- Buyer Marketplace & Purchase ---
    resetBuyerFilters() {
      this.buyerFilters = {crop:'', location:'', pesticideCompany: ''};
    },
    buyListing(listing) {
      if (!this.loggedIn || this.role !== 'buyer') {
         alert("Please log in as a Buyer to make purchases.");
         this.switchPage('login');
         return;
      }
      this.selectedListing = listing;
      this.purchaseAmount = listing.minPrice;
      this.purchaseStatus = '';
      this.purchaseError = '';
      this.showBuyModal = true;
    },
     closeBuyModal() {
        this.showBuyModal = false;
        this.selectedListing = null;
        this.purchaseAmount = null;
        this.purchaseStatus = '';
        this.purchaseError = '';
    },
    async processPurchase() {
        this.purchaseStatus = ''; this.purchaseError = '';
        if (!this.selectedListing || !this.purchaseAmount) return;

        const amount = parseFloat(this.purchaseAmount);
        const minP = this.selectedListing.minPrice;
        const maxP = this.selectedListing.maxPrice;

        if (isNaN(amount) || amount < minP || amount > maxP) {
            this.purchaseError = `Please enter a valid SOL amount between ${minP} and ${maxP}.`;
            return;
        }

        console.log(`Simulating purchase of listing ${this.selectedListing.id} for ${amount} SOL by ${this.username}`);
        this.purchaseStatus = `Processing purchase for ${amount} SOL...`;
        await new Promise(resolve => setTimeout(resolve, 1500));

        try {
             const txHash = 'pur_sol' + Date.now().toString(16) + Math.random().toString(16).substring(2, 10);
             console.log("Simulated Purchase TX Hash:", txHash);

             const newPurchase = {
                id: 'pur' + Date.now() + Math.random().toString(36).substring(2, 8),
                buyer: this.username,
                farmer: this.selectedListing.farmer,
                crop: this.selectedListing.crop,
                location: this.selectedListing.location,
                pesticide: this.selectedListing.pesticide,
                pesticideCompany: this.selectedListing.pesticideCompany || '',
                cid: this.selectedListing.cid,
                price: amount,
                date: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }),
                txHash: txHash
             };
             this.buyerPurchases.unshift(newPurchase);

             const listingIndex = this.allListings.findIndex(l => l.id === this.selectedListing.id);
             if (listingIndex > -1) {
                this.allListings.splice(listingIndex, 1);
             }
             const farmerListingIndex = this.farmerListings.findIndex(l => l.id === this.selectedListing.id);
              if (farmerListingIndex > -1) {
                 this.farmerListings.splice(farmerListingIndex, 1);
              }


             this.purchaseStatus = "Purchase successful! Transaction simulated.";
             setTimeout(() => { this.closeBuyModal(); }, 2500);

        } catch(err) {
             console.error("Simulated purchase error:", err);
             this.purchaseError = "Purchase simulation failed. Please try again.";
             this.purchaseStatus = '';
        }
    },
    viewPurchaseVideo(purchase) {
      this.selectedPurchase = purchase;
      this.showPurchaseVideo = true;
    },

    // --- Investor Actions ---
    resetInvestorFilters() {
      this.investorFilters = {crop: '', method: '', minRoi: null, maxAmount: null};
    },
     maxInvestmentAmount(project) {
        if (!project || project.status === 'funded') return 0;
        return (project.amount - project.fundedAmount).toFixed(2);
    },
    async investInProject(project) {
        if (!this.loggedIn || this.role !== 'investor') {
             alert("Please log in as an Investor to invest."); this.switchPage('login'); return;
        }
        const amount = this.investmentAmounts[project.id];
        this.$set(this.investmentErrors, project.id, '');

        if (!amount || isNaN(amount) || amount <= 0) {
            this.$set(this.investmentErrors, project.id, 'Invalid amount.'); return;
        }
        const maxInvest = parseFloat(this.maxInvestmentAmount(project));
        if (amount > maxInvest) {
             this.$set(this.investmentErrors, project.id, `Amount exceeds max allowed (${maxInvest} SOL).`); return;
        }

        console.log(`Simulating investment of ${amount} SOL in project ${project.id} by ${this.username}`);
        await new Promise(resolve => setTimeout(resolve, 1500));

        try {
             const txHash = 'inv_sol' + Date.now().toString(16) + Math.random().toString(16).substring(2, 10);
             console.log("Simulated Investment TX Hash:", txHash);

             const projectIndex = this.allFundingRequests.findIndex(p => p.id === project.id);
             if (projectIndex === -1) throw new Error("Project not found in global list");

             const updatedProject = this.allFundingRequests[projectIndex];
             updatedProject.fundedAmount += amount;
             updatedProject.investors.push({
                id: 'invtor' + Date.now(),
                username: this.username,
                amount: amount,
                txHash: txHash
             });

            if (updatedProject.fundedAmount >= updatedProject.amount) {
                updatedProject.status = 'funded';
                updatedProject.fundedAmount = updatedProject.amount;
            } else {
                updatedProject.status = 'partially_funded';
            }
             this.$set(this.allFundingRequests, projectIndex, updatedProject);

            const newInvestment = {
                id: 'inv' + Date.now() + Math.random().toString(36).substring(2, 8),
                projectId: project.id,
                projectTitle: project.title,
                farmerName: project.farmerName, // Include farmer name
                crop: project.crop,
                method: project.method,
                description: project.description,
                acres: project.acres,
                timeline: project.timeline,
                roi: project.roi,
                investorShare: project.investorShare,
                amount: amount,
                cid: project.cid,
                status: 'active',
                progress: 0,
                investmentDate: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }),
                txHash: txHash
            };
            this.investorInvestments.unshift(newInvestment);

            const newTransaction = {
                id: 'tx' + Date.now(),
                txHash: txHash,
                type: 'investment',
                amount: amount,
                date: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }),
                projectId: project.id,
                projectTitle: project.title
            };
            this.investorTransactions.unshift(newTransaction);

            this.$set(this.investmentAmounts, project.id, null);
            alert(`Successfully invested ${amount} SOL in "${project.title}"! (Simulated)`);

        } catch (err) {
             console.error("Simulated investment error:", err);
             this.$set(this.investmentErrors, project.id, 'Investment simulation failed.');
             alert("Investment simulation failed. Please try again.");
        }
    },
    updateInvestmentProgress() {
        this.investorInvestments.forEach(inv => {
            if (inv.status === 'active' || inv.status === 'growing') {
                 const dateInvested = new Date(inv.investmentDate);
                 const now = new Date();
                 const timeElapsedMonths = (now.getFullYear() - dateInvested.getFullYear()) * 12 + (now.getMonth() - dateInvested.getMonth());
                 let progress = Math.min(100, Math.max(0, Math.round((timeElapsedMonths / inv.timeline) * 100)));
                  progress = Math.min(100, Math.max(0, progress + Math.floor(Math.random() * 15) - 5));

                 inv.progress = progress;

                 if (progress >= 100 && inv.status !== 'harvested') {
                    inv.status = 'harvested';
                     console.log(`Project ${inv.projectTitle} marked as harvested (simulated).`);
                 } else if (progress > 0 && inv.status === 'active') {
                    inv.status = 'growing';
                 }
            }
        });
    },
    viewInvestmentDetails(investment) {
        const project = this.allFundingRequests.find(p => p.id === investment.projectId);
        this.selectedInvestment = {
            ...investment,
             description: project ? project.description : investment.description,
        };
        this.showInvestmentDetailsModal = true;
    },
    calculateExpectedReturn(investment) {
        if (!investment || !investment.amount || !investment.roi) return '0.00';
        const expectedProfit = investment.amount * (investment.roi / 100);
        return expectedProfit.toFixed(2);
    },
     solanaExplorerUrl(txHash) {
        return `https://explorer.solana.com/tx/${txHash}?cluster=devnet`;
    },
     openBlockExplorer(txHash) {
        window.open(this.solanaExplorerUrl(txHash), '_blank');
    },

    // *** NEW: Farmer Profile Modal Methods ***
    showFarmerProfile(farmerName) {
        if (!farmerName) return;
        this.selectedFarmerProfile = null; // Clear previous before loading

        // Simulate fetching/calculating data
        const profileData = {
            username: farmerName,
            email: this.simulateFarmerEmail(farmerName),
            memberSince: this.simulateFarmerJoinDate(farmerName),
            // Count requests from the *global* list for this farmer
            fundingRequestCount: this.allFundingRequests.filter(r => r.farmerName === farmerName).length,
             // In a real app, you'd fetch video/listing counts from backend if needed
        };

        this.selectedFarmerProfile = profileData;
        this.showFarmerProfileModal = true;
    },
    closeFarmerProfileModal() {
        this.showFarmerProfileModal = false;
        this.selectedFarmerProfile = null;
    },
    // Helper to create plausible demo emails
    simulateFarmerEmail(farmerName) {
        if (!farmerName) return 'farmer@example.com';
        const sanitizedName = farmerName.toLowerCase().replace(/[^a-z0-9]/g, '');
        return `${sanitizedName}@farmmail.com`; // Example domain
    },
    // Helper to create plausible demo join dates
    simulateFarmerJoinDate(farmerName) {
        // Use a simple hash function (not crypto secure) to get a consistent-ish offset
        let hash = 0;
        for (let i = 0; i < farmerName.length; i++) {
            hash = (hash << 5) - hash + farmerName.charCodeAt(i);
            hash |= 0; // Convert to 32bit integer
        }
        const daysAgo = Math.abs(hash % 365) + 30; // Join date between 1 month and ~1 year ago
        const joinDate = new Date();
        joinDate.setDate(joinDate.getDate() - daysAgo);
        return joinDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    },
    // *** END: Farmer Profile Modal Methods ***


    // --- Demo Data Loader ---
    loadDemoDataIfNeeded() {
      // Only load if the lists are empty - prevents overwriting on re-login
      if (this.allFundingRequests.length === 0) {
        console.log("Loading initial demo funding requests...");
        this.allFundingRequests = [
          { id: 'fr_demo1', farmerName: 'Alice Farms', title: 'Organic Strawberry Expansion', crop: 'Strawberries', acres: 2.5, amount: 25, method: 'organic', cid: 'QmYpUkLqrn4N1YgdNvT3zJbJnbZu4wcjGbDqrXKuL71L3V', description: 'Expanding our organic strawberry fields using sustainable practices. Looking for partners to help with upfront costs for planting and irrigation.', timeline: 6, roi: 18, investorShare: 20, fundedAmount: 10, status: 'partially_funded', createdAt: '2023-02-10T10:00:00Z', investors: [{id:'invtor_d1', username:'DemoInvestor', amount: 10, txHash:'inv_sol_demo1'}] },
          { id: 'fr_demo2', farmerName: 'Bob\'s Best Beets', title: 'Hydroponic Lettuce Setup', crop: 'Lettuce', acres: 0.5, amount: 40, method: 'hydroponic', cid: 'Qme6xrRfA1kqdqrRJgXqGsNebvX1hXeER4xwqUfz1m4vB1', description: 'Setting up a new state-of-the-art hydroponic system for year-round crisp lettuce production. High demand in local markets.', timeline: 4, roi: 25, investorShare: 30, fundedAmount: 0, status: 'pending', createdAt: '2023-03-01T11:30:00Z', investors: [] },
          { id: 'fr_demo3', farmerName: 'Corn Growers Inc.', title: 'Corn Harvest Equipment', crop: 'Corn', acres: 50, amount: 150, method: 'conventional', cid: 'QmNc2s3jVzJ9kDEmM9u8qXjKjHjNqZ3y5s8kX6w8fT4rD9', description: 'Funding needed for a new combine harvester to improve efficiency and reduce harvest time for our large corn fields.', timeline: 8, roi: 12, investorShare: 15, fundedAmount: 150, status: 'funded', createdAt: '2023-01-15T09:00:00Z', investors: [{id:'invtor_d2', username:'DemoInvestor', amount: 100, txHash:'inv_sol_demo2'}, {id:'invtor_d3', username:'AnotherInvestor', amount: 50, txHash:'inv_sol_demo3'}] },
           { id: 'fr_demo4', farmerName: 'Alice Farms', title: 'Tomato Trial Patch', crop: 'Tomatoes', acres: 1, amount: 15, method: 'organic', cid: 'QmWkPrGf8wXzVqK5nZqY8bXsGcD6fJkHgVtRpLmNqXy7sT', description: 'Small trial for three new heirloom tomato varieties known for exceptional flavor. Funds for seeds and soil amendments.', timeline: 5, roi: 22, investorShare: 25, fundedAmount: 5, status: 'partially_funded', createdAt: '2023-04-01T14:00:00Z', investors: [{id:'invtor_d4', username:'DemoInvestor', amount: 5, txHash:'inv_sol_demo4'}] },
        ];
        // Assign requests to the farmer if they are the demo farmer
         if (this.role === 'farmer' && this.username === 'DemoFarmer') {
             this.farmerFundingRequests = this.allFundingRequests.filter(r => r.farmerName === this.username); // Use logged-in farmer's name
         } else if (this.role === 'farmer' && this.username === 'Alice Farms'){ // Example for demo
             this.farmerFundingRequests = this.allFundingRequests.filter(r => r.farmerName === 'Alice Farms');
         }
      }
       if (this.allListings.length === 0) {
           console.log("Loading initial demo listings...");
           this.allListings = [
                { id: 'lst_demo1', farmer: 'DemoFarmer', crop: 'Tomatoes', location: 'West Field', pesticide: 'Copper Spray', pesticideCompany: 'AgriSource', cid: 'QmXyZDemoCIDListing1', minPrice: 0.8, maxPrice: 1.2, status: 'active', createdAt: '2023-05-01T10:00:00Z' },
                { id: 'lst_demo2', farmer: 'Alice Farms', crop: 'Peppers', location: 'Greenhouse 3', pesticide: 'Neem Oil', pesticideCompany: 'Organics Inc.', cid: 'Qme6xrRfA1kqdqrRJgXqGsNebvX1hXeER4xwqUfz1m4vB1', minPrice: 1.0, maxPrice: 1.5, status: 'active', createdAt: '2023-05-05T11:00:00Z' },
           ];
           // Assign listing to the farmer if they are the demo farmer
            if (this.role === 'farmer') {
                this.farmerListings = this.allListings.filter(l => l.farmer === this.username);
            }
       }
       if (this.investorInvestments.length === 0 && this.role === 'investor' && this.username === 'DemoInvestor') {
            console.log("Loading initial demo investments for DemoInvestor...");
             const proj1 = this.allFundingRequests.find(p => p.id === 'fr_demo1');
             const proj4 = this.allFundingRequests.find(p => p.id === 'fr_demo4');
             const proj3 = this.allFundingRequests.find(p => p.id === 'fr_demo3');

            this.investorInvestments = [
                ...(proj1 ? [{ id: 'inv_demo1', projectId: proj1.id, projectTitle: proj1.title, farmerName: proj1.farmerName, crop: proj1.crop, method: proj1.method, description: proj1.description, acres: proj1.acres, timeline: proj1.timeline, roi: proj1.roi, investorShare: proj1.investorShare, amount: 10, cid: proj1.cid, status: 'growing', progress: 30, investmentDate: 'February 15, 2023', txHash: 'inv_sol_demo1' }] : []),
                ...(proj4 ? [{ id: 'inv_demo2', projectId: proj4.id, projectTitle: proj4.title, farmerName: proj4.farmerName, crop: proj4.crop, method: proj4.method, description: proj4.description, acres: proj4.acres, timeline: proj4.timeline, roi: proj4.roi, investorShare: proj4.investorShare, amount: 5, cid: proj4.cid, status: 'active', progress: 5, investmentDate: 'April 5, 2023', txHash: 'inv_sol_demo4' }] : []),
                 ...(proj3 ? [{ id: 'inv_demo3', projectId: proj3.id, projectTitle: proj3.title, farmerName: proj3.farmerName, crop: proj3.crop, method: proj3.method, description: proj3.description, acres: proj3.acres, timeline: proj3.timeline, roi: proj3.roi, investorShare: proj3.investorShare, amount: 100, cid: proj3.cid, status: 'harvested', progress: 100, investmentDate: 'January 20, 2023', txHash: 'inv_sol_demo2' }] : []),
            ];
             this.investorTransactions = [
                 ...(proj3 ? [{ id: 'txp_demo1', txHash: 'payout_sol_demo1', type: 'payout', amount: parseFloat(this.calculateExpectedReturn(this.investorInvestments.find(i=>i.projectId===proj3.id))), date: 'September 1, 2023', projectId: proj3?.id, projectTitle: proj3?.title }] : []),
                { id: 'tx_demo1', txHash: 'inv_sol_demo1', type: 'investment', amount: 10, date: 'February 15, 2023', projectId: proj1?.id, projectTitle: proj1?.title },
                { id: 'tx_demo2', txHash: 'inv_sol_demo4', type: 'investment', amount: 5, date: 'April 5, 2023', projectId: proj4?.id, projectTitle: proj4?.title },
                 { id: 'tx_demo3', txHash: 'inv_sol_demo2', type: 'investment', amount: 100, date: 'January 20, 2023', projectId: proj3?.id, projectTitle: proj3?.title },
            ];
            this.investorTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
       }
        // Load demo videos for farmer
        if (this.farmerVideos.length === 0 && this.role === 'farmer') {
             console.log(`Loading initial demo videos for ${this.username}...`);
             // Basic demo videos, ensure farmer name matches logged in user for relevance
             let demoVideos = [
                { farmer: 'DemoFarmer', cid: 'QmXyZDemoCIDListing1', crop: 'Tomatoes', pesticide: 'Copper Spray', location: 'West Field', pesticideCompany: 'AgriSource' },
                { farmer: 'Alice Farms', cid: 'QmWkPrGf8wXzVqK5nZqY8bXsGcD6fJkHgVtRpLmNqXy7sT', crop: 'Tomatoes', pesticide: 'Organic Mix', location: 'Trial Patch', pesticideCompany: 'BioGrow' },
                { farmer: 'DemoFarmer', cid: 'QmAnotherDemoVideoCID', crop: 'Zucchini', pesticide: 'Soap Spray', location: 'North Patch', pesticideCompany: 'Organics Inc.' },
                { farmer: 'Alice Farms', cid: 'QmYpUkLqrn4N1YgdNvT3zJbJnbZu4wcjGbDqrXKuL71L3V', crop: 'Strawberries', pesticide: 'Ladybugs', location: 'South Plot', pesticideCompany: 'NatureFirst' },
                { farmer: 'Bob\'s Best Beets', cid: 'Qme6xrRfA1kqdqrRJgXqGsNebvX1hXeER4xwqUfz1m4vB1', crop: 'Lettuce', pesticide: 'Nutrient Solution', location: 'Hydro Unit 1', pesticideCompany: 'HydroGrow' },
                { farmer: 'Corn Growers Inc.', cid: 'QmNc2s3jVzJ9kDEmM9u8qXjKjHjNqZ3y5s8kX6w8fT4rD9', crop: 'Corn', pesticide: 'Standard Agro', location: 'Field 7B', pesticideCompany: 'BulkChem' }
             ];
             // Filter to only show videos 'belonging' to the currently logged-in farmer
             this.farmerVideos = demoVideos.filter(v => v.farmer === this.username);
        }
         // Load demo purchases for buyer
         if (this.buyerPurchases.length === 0 && this.role === 'buyer' && this.username === 'DemoBuyer') {
             console.log("Loading initial demo purchases for DemoBuyer...");
            this.buyerPurchases = [
                 { id: 'pur_demo1', buyer: 'DemoBuyer', farmer: 'DemoFarmer', crop: 'Old Tomatoes', location: 'South Field', pesticide: 'Old Spray', pesticideCompany: 'Old Company', cid: 'QmOldPurchaseCID', price: 0.9, date: 'March 10, 2023', txHash: 'pur_sol_old_demo1' },
            ];
         }
         this.$nextTick(() => { this.updateInvestmentProgress(); });
    }

  },
  mounted() {
      console.log("PestiVid App Mounted");
       try {
            if (window.solanaWeb3) {
                 console.log("Solana Web3 library loaded.");
            } else {
                console.warn("Solana Web3 library (@solana/web3.js) not found globally.");
            }
        } catch (e) {
            console.error("Error initializing Solana Web3:", e);
        }
         // Simulate investment progress update after a delay
         setTimeout(() => {
            this.updateInvestmentProgress();
          }, 2000);
        // Load demo data on initial mount if needed
        this.loadDemoDataIfNeeded();
  }
});
</script>

</body>
</html>